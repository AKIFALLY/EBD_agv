# 雙環境架構設計

## 🎯 架構設計理念

RosAGV 採用**雙環境分離架構**，將 AGV 控制功能分為兩個獨立的環境，實現關注點分離、高可用性和可擴展性的完美平衡。

## 🏗️ 雙環境概覽

### 設計原則
**分離關注點**：將即時控制與管理功能分離，提高系統穩定性和可維護性

<table>
<tr>
<th>🚗 AGV 車載環境</th>
<th>🖥️ AGVC 管理環境</th>
</tr>
<tr>
<td>

**部署位置**：AGV 車輛上的邊緣計算設備  
**網路模式**：Host 網路（直接硬體存取）  
**容器名稱**：`rosagv`

**核心職責**：
- ⚡ 即時控制和狀態管理
- 🔌 PLC 設備直接通訊  
- 📡 感測器資料處理
- 🕹️ 手動控制（搖桿）支援
- 🗺️ 路徑規劃和導航

</td>
<td>

**部署位置**：中央管理伺服器或雲端  
**網路模式**：Bridge 網路（192.168.100.0/24）  
**容器名稱**：`agvc_server`, `postgres`, `nginx`, `pgadmin`

**核心職責**：
- 🚛 車隊管理和任務調度
- 💾 資料庫管理和資料持久化
- 🌐 Web 管理介面
- 🔗 外部系統整合（KUKA Fleet）
- 📊 系統監控和日誌管理

</td>
</tr>
</table>

### 架構優勢

#### 1. 高可用性
- **車載系統獨立運行**：不依賴中央系統，即使網路中斷也能基本運作
- **故障隔離**：一個環境的故障不會直接影響另一個環境
- **本地決策能力**：AGV 可以進行本地安全決策和緊急處理

#### 2. 可擴展性
- **水平擴展**：管理系統可以管理多台 AGV
- **獨立升級**：各環境可以獨立更新和部署
- **資源彈性**：根據需求靈活配置資源

#### 3. 安全性
- **網路隔離**：車載系統與管理系統網路隔離
- **權限分離**：不同環境有不同的系統權限
- **資料保護**：敏感控制資料留在車載環境

## 🚗 AGV 車載環境詳解

### 技術特性
```yaml
容器配置: docker-compose.yml
網路模式: host
部署位置: AGV 車輛上的邊緣計算設備
主要特點: 直接硬體存取，即時控制
```

### 為什麼使用 Host 網路？

#### SICK 感測器存取需求
- **SICK SLAM 感測器**：需要直接存取 SICK 感測器硬體
- **感測器軟體獨立**：SICK 有自己的軟體系統，不透過 ROS 2 運行
- **硬體直接存取**：減少抽象層，確保即時性
- **低延遲要求**：直接硬體存取減少網路層級延遲

#### 即時控制需求
- **毫秒級響應**：安全控制和即時決策需要極低延遲
- **硬體整合**：PLC、感測器、執行器的直接控制
- **USB 設備**：搖桿、感測器等 USB 設備直接掛載

### 工作空間架構（10個）

```
AGV 車載工作空間 - 專注於即時控制和硬體整合
├── agv_ws/                    # 核心 AGV 控制
│   ├── agv_base              # 基礎狀態機架構
│   ├── cargo_mover_agv       # Cargo Mover 車型實作
│   ├── loader_agv            # Loader 車型實作
│   └── unloader_agv          # Unloader 車型實作
├── agv_cmd_service_ws/        # 手動指令服務
├── joystick_ws/               # 搖桿控制整合
├── sensorpart_ws/             # 感測器資料處理
├── uno_gpio_ws/               # GPIO 控制服務
├── launch_ws/                 # AGV 啟動編排
└── [共用基礎設施工作空間]
    ├── shared_constants_ws/   # 系統級常數定義
    ├── keyence_plc_ws/        # Keyence PLC 通訊
    ├── plc_proxy_ws/          # PLC 代理服務
    └── path_algorithm/        # 路徑規劃演算法
```

### 啟動流程
```bash
# AGV 車載系統啟動
docker compose -f docker-compose.yml up -d

# 容器內自動執行 startup.agv.bash
├── SSH 服務啟動
├── Zenoh Router 啟動 (0.0.0.0:7447)
├── 載入 AGV 工作空間
└── 啟動 AGV 核心服務
```

### 核心功能模組

#### 3層狀態機架構
```python
# 基礎狀態機層次
Base 層狀態機      # 生命週期管理
├── CONFIGURING   # 配置中
├── INACTIVE      # 非活動
├── ACTIVE        # 活動
└── FINALIZED     # 已結束

AGV 層狀態機       # AGV 專用狀態
├── IDLE          # 閒置等待
├── MOVING        # 移動中
├── LOADING       # 裝載中
├── UNLOADING     # 卸載中
└── ERROR         # 錯誤狀態

Robot 層狀態機     # 機械臂專用狀態
├── HOMING        # 歸零中
├── READY         # 準備就緒
├── WORKING       # 工作中
└── MAINTENANCE   # 維護模式
```

#### PLC 通訊系統
- **Keyence PLC 協議**：TCP/IP Socket 連接（Port 8501）
- **PGNO 程式控制**：機械臂動作程式編號系統
- **即時資料交換**：感測器狀態、執行器控制
- **安全監控**：設備狀態監控和異常檢測

## 🖥️ AGVC 管理環境詳解

### 技術特性
```yaml
容器配置: docker-compose.agvc.yml
網路模式: bridge (192.168.100.0/24)
部署位置: 中央管理伺服器或雲端
主要特點: 服務隔離，企業級部署
```

### 為什麼使用 Bridge 網路？

#### KUKA 系統整合需求
- **KUKA Fleet 整合**：KUKA 外部系統也是 Docker 部署在同台電腦
- **固定 IP 需求**：需要固定 IP 地址確保與 KUKA 系統穩定連接
- **企業級隔離**：Bridge 網路提供更好的隔離性
- **網路管理**：便於管理多個服務之間的網路通訊

#### 服務架構考量
- **微服務架構**：多個服務需要獨立的網路命名空間
- **安全隔離**：資料庫、Web 服務的安全隔離
- **負載均衡**：支援負載均衡和反向代理
- **監控管理**：便於網路流量監控和管理

### 工作空間架構（12個）

```
AGVC 管理工作空間 - 專注於車隊管理和系統整合
├── web_api_ws/                # Web API 和 Socket.IO
│   ├── web_api              # 核心 API 服務
│   ├── agvcui               # 管理員界面
│   └── opui                 # 操作員界面
├── db_proxy_ws/              # 資料庫代理服務
├── ecs_ws/                   # 設備控制系統
├── rcs_ws/                   # 機器人控制系統
├── flow_wcs_ws/              # Flow WCS 系統 (唯一 WCS 實作)
├── kuka_fleet_ws/            # KUKA Fleet 整合
├── launch_ws/                # 啟動編排服務
└── [共用基礎設施工作空間]
    ├── shared_constants_ws/   # 系統級常數定義
    ├── agv_ws/                # AGV 介面定義 (監控需要)
    ├── keyence_plc_ws/        # PLC 通訊 (共用)
    ├── plc_proxy_ws/          # PLC 代理 (共用)
    └── path_algorithm/        # 路徑規劃 (共用)
```

### 服務架構詳解

#### Web 服務層
```
Port 8000: 核心 API 服務 (FastAPI + Socket.IO)
├── RESTful API 接口
├── WebSocket 即時通訊
├── 任務管理和狀態監控
└── 系統配置和控制

Port 8001: AGVCUI 管理員界面
├── 完整系統管理功能
├── AGV 狀態監控
├── 任務調度管理
└── 系統配置界面

Port 8002: OPUI 操作員界面
├── 簡化的操作界面
├── 叫車和派車功能
├── 狀態監控
└── 異常報告
```

#### 資料服務層
```
Port 5432: PostgreSQL 資料庫
├── 任務歷史記錄
├── AGV 狀態數據
├── 系統配置數據
└── 用戶管理數據

Port 5050: pgAdmin4 管理工具
├── 資料庫管理界面 (IP: 192.168.100.101)
├── 查詢分析工具
├── 備份恢復功能
└── 效能監控
```

#### 反向代理層
```
Port 80: Nginx 反向代理
├── 靜態檔案服務 (IP: 192.168.100.252)
├── API 請求轉發
├── 負載均衡
└── SSL 終止
```

## 🌐 跨環境通訊機制

### Zenoh RMW 通訊架構

```
AGV 車載系統 (Host 網路)
├── Zenoh Router: 0.0.0.0:7447
├── ROS 2 節點自動發現
└── 直接硬體存取模式

        ↕️ 高效能跨網路通訊 ↕️
        
AGVC 管理系統 (Bridge 網路: 192.168.100.0/24)
├── Zenoh Router: 192.168.100.100:7447
├── ROS 2 節點自動發現
└── 企業級隔離模式
```

### 通訊特性

#### 效能指標
- **本地通訊**：< 100μs 延遲
- **跨容器通訊**：< 1ms 延遲
- **跨網路通訊**：< 10ms 延遲（區域網路）
- **吞吐量**：> 1GB/s（區域網路）

#### 可靠性機制
- **自動重連**：網路中斷時自動重新建立連接
- **QoS 保證**：支援不同等級的服務品質
- **故障轉移**：主要路徑失敗時的備用路徑
- **資料完整性**：確保關鍵資料的完整傳輸

### 跨環境服務發現

```python
# ROS 2 跨環境服務範例
# AGV 環境中的服務提供者
class PLCService(Node):
    def __init__(self):
        super().__init__('plc_service')
        self.service = self.create_service(
            PLCRead, 'plc_read', self.plc_read_callback)

# AGVC 環境中的服務消費者
class TaskManager(Node):
    def __init__(self):
        super().__init__('task_manager')
        self.plc_client = self.create_client(PLCRead, 'plc_read')
        
    async def read_plc_data(self):
        # 跨環境服務呼叫
        request = PLCRead.Request()
        response = await self.plc_client.call_async(request)
        return response
```

## 🚀 部署策略

### 開發環境部署
```bash
# 單機開發：在同一台機器上運行兩個環境
cd /home/ct/RosAGV

# 啟動 AGVC 管理系統
docker compose -f docker-compose.agvc.yml up -d

# 啟動 AGV 車載系統（可選）
docker compose -f docker-compose.yml up -d
```

### 生產環境部署

#### AGV 車載部署
- **部署位置**：每台 AGV 的邊緣計算設備
- **硬體需求**：工業級計算機，支援 Docker
- **網路需求**：工業 WiFi 或 5G 連接
- **存儲需求**：SSD 存儲，支援快速 I/O

#### AGVC 管理部署
- **部署位置**：中央管理伺服器或雲端平台
- **硬體需求**：高效能伺服器，16GB+ 記憶體
- **網路需求**：穩定的網路連接和固定 IP
- **資料庫**：PostgreSQL 叢集，支援高可用

### 擴展策略

#### 水平擴展
- **多 AGV 部署**：每台 AGV 獨立的車載系統
- **AGVC 叢集**：多個 AGVC 實例的負載均衡
- **資料庫分片**：大規模部署的資料庫分片策略
- **地理分散**：多個數據中心的地理分散部署

#### 垂直擴展
- **硬體升級**：更強大的計算和存儲資源
- **網路頻寬**：更高頻寬的網路連接
- **資料庫效能**：更高效能的資料庫配置
- **快取機制**：Redis 等快取系統的整合

## 🛡️ 安全性設計

### 網路安全
- **網路隔離**：不同環境的網路隔離
- **防火牆配置**：基於角色的網路存取控制
- **VPN 支援**：遠端存取的 VPN 安全通道
- **入侵檢測**：網路入侵檢測和防護

### 資料安全
- **資料加密**：敏感資料的加密存儲和傳輸
- **存取控制**：基於角色的資料存取控制
- **審計日誌**：完整的操作審計日誌
- **資料備份**：定期資料備份和災難恢復

### 系統安全
- **容器安全**：Docker 容器的安全配置
- **權限最小化**：最小權限原則的實施
- **安全更新**：定期安全補丁和更新
- **漏洞掃描**：定期系統漏洞掃描

## 📊 監控和維護

### 系統監控
```bash
# 統一監控工具
r agvc-check              # AGVC 系統健康檢查
r agv-check               # AGV 系統健康檢查
r containers-status       # 容器狀態檢查
r network-check           # 網路連接檢查
```

### 效能監控
- **資源使用**：CPU、記憶體、磁碟、網路使用監控
- **應用效能**：ROS 2 節點效能和回應時間監控
- **資料庫效能**：查詢效能和資料庫健康監控
- **網路效能**：跨環境通訊延遲和吞吐量監控

### 日誌管理
- **分散式日誌**：兩個環境日誌的集中收集
- **日誌分析**：自動日誌分析和異常檢測
- **日誌輪轉**：日誌檔案的自動輪轉和壓縮
- **日誌查詢**：強大的日誌搜索和分析工具

## 🔗 相關技術資源

- [技術棧詳細說明](technology-stack.md) - 完整的技術選型和架構
- [部署指導](../operations/deployment.md) - 詳細的部署操作指導
- [系統監控](../operations/maintenance.md) - 監控和維護最佳實踐
- [故障排除](../operations/troubleshooting.md) - 常見問題和解決方案

---

💡 **總結**：雙環境架構是 RosAGV 系統的核心設計理念，通過合理分離關注點，實現了高可用性、可擴展性和可維護性的完美平衡，為工業級 AGV 系統提供了堅實的技術基礎。