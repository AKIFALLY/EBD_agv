# 眼鏡生產業務流程

## 🎯 完整業務流程概覽

RosAGV 在眼鏡生產工廠中提供端到端的自動化搬運解決方案，從射出機生產到最終包裝的完整流程自動化。

## 🏭 生產環境配置

### 工廠設備概覽
```
眼鏡生產工廠配置
├── 4台射出機 → 每台最多同時射出4種產品
├── 8個作業員 → 每台射出機2人操作
├── 4台平板 → OPUI操作介面 (2人共用1台)
├── 2台KUKA AGV → 負責長距離搬運和Rack轉向
└── 3台CT AGV → Cargo、Loader、Unloader各1台
```

### 目前部署狀況
- **實驗階段**：概念驗證和技術可行性驗證
- **單房間配置**：僅房間2啟用，單一車型配置
- **5個房間規劃**：Room1, Room2啟用，Room3-5預留擴展

## 🔄 完整業務流程

### 階段1：射出機生產區
```
射出機作業流程
1. 射出機生產 → 4台射出機並行生產不同產品
2. 人工搬運 → 作業員手動將空rack搬到作業區
3. 加入料架 → 在OPUI平板選擇對應的rack編號
4. 人工作業 → 作業員將射出的眼鏡掛載到carrier框架
5. Rack裝載 → 將carrier安裝到對應產品的rack上
6. OPUI設定 → 在平板上設定產品類型、數量、目標房間
7. 派車請求 → rack裝滿後請求WCS調度搬運
```

#### OPUI操作介面功能
**核心操作**：
- **加入料架**：選擇並記錄手動搬運來的空rack編號
- **派車功能**：滿載rack請求WCS派車搬運

**設定功能**：
- **產品選擇**：設定rack裝載的產品類型 (S/L尺寸)
- **數量設定**：告知系統rack中的產品數量
- **房間選擇**：設定產品最終要送到的房間
- **機台設定**：選擇對應的射出機台

### 階段2：KUKA AGV 長距離搬運
```
KUKA AGV 配送流程
1. 滿rack搬運 → 將裝滿的rack從射出機區搬運到房間門口
2. Rack轉向 → 180度轉向確保A/B雙面都能處理
3. 空rack回收 → 將空rack送到指定位置供人工搬運
```

**KUKA AGV 技術特色**：
- **車型**：KUKA robot 400i (2輪差動車)
- **導航**：KUKA自有地圖系統
- **控制整合**：透過kuka_fleet_ws模組與RosAGV通訊
- **交通管制**：透過Web API管理交管區使用權
- **門控整合**：自動控制電動門開關

### 階段3：房間入口製程匹配驗證 (Cargo AGV)
```
Cargo AGV 製程匹配流程
1. 3D視覺定位 → SensorPart相機對Rack上的2D Mark進行3D定位
   └── 定位資訊傳送到Robot進行base座標更新
2. 逐一Carrier處理（卸載作業）：
   ├── 從Rack取出Carrier
   ├── OCR識別 → 讀取產品編號和類型
   ├── 製程匹配檢查 → 確認產品屬於此房間負責的製程
   ├── 製程相符 → 放入入口傳送箱
   └── OCR失敗/製程不符 → 立即發出Alarm停止處理
3. A面處理完成 → 等待Rack轉向
4. B面處理 → 重複相同流程
5. 空Rack處理（由KUKA AGV執行）：
   ├── 判斷房間出口是否有Rack停靠
   ├── 無Rack → 將空Rack搬到房間出口位置
   └── 有Rack → 將空Rack搬到系統空料車停車區
```

**製程防錯機制**：
- **製程適配性檢查**：確保只有此房間負責的產品才能進入
- **OCR驗證**：防止錯誤產品進入不適合的製程
- **即時異常處理**：
  - OCR NG時立即發出PLC Alarm到HMI
  - 人員現場處理問題（非事後集中處理）
  - OCR失敗：處理後Alarm Reset重試
  - 錯誤產品：移除產品→AGVCUI清除資料→Alarm Reset

### 階段4：房間內製程 (Loader AGV)
```
Loader AGV 精密製程流程
製程1 (泡藥1次)：
1. TAKE_TRANSFER → 從入口傳送箱取料
2. PUT_CLEANER → 放入清潔機清潔
3. TAKE_CLEANER → 從清潔機取出
4. PUT_SOAKER → 放入浸潤機泡藥
5. TAKE_SOAKER → 從浸潤機取出
6. PUT_PRE_DRYER → 放入預乾燥機

製程2 (泡藥2次)：
1-3. 同製程1的清潔流程
4. PUT_SOAKER → 第1次泡藥
5. TAKE_SOAKER → 第1次取出
6. PUT_SOAKER → 第2次泡藥
7. TAKE_SOAKER → 第2次取出
8. PUT_PRE_DRYER → 放入預乾燥機
```

**Loader AGV 設備配置**：
- **清潔機**：2台工位
- **浸潤機**：6台工位 (主要製程設備)
- **預乾燥機**：8台工位
- **車載料架**：4層垂直排列，一次1格精密操作

### 階段5：後段製程 (Unloader AGV)
```
Unloader AGV 批量處理流程
1. TAKE_PRE_DRYER → 從預乾燥機取出 (一次2格)
2. PUT_OVEN → 放入烘箱上排進行烘乾 (一次2格)
3. [烘乾製程：上排 → 下排]
4. TAKE_OVEN → 從烘箱下排取出 (一次2格)
5. PUT_BOXOUT_TRANSFER → 送到出口傳送箱 (一次2格)
```

**Unloader AGV 特色**：
- **批量處理**：所有操作都採用一次2格的高效方式
- **烘箱管理**：上排進料、下排出料的雙向操作
- **車載料架**：上2格+下2格設計，最佳化批量效率

### 階段6：出口收集 (Cargo AGV)
```
Cargo AGV 出口收集流程（裝載作業）
前提：房間出口已有空Rack停靠（從入口直接搬來或從系統空料車停車區調度）
1. 從出口傳送箱取出處理完成的Carrier
2. 透過8bit通訊協調門控
3. 將Carrier放回房間出口Rack的對應位置
4. 處理A面所有位置
5. Rack轉向180度
6. 處理B面所有位置
7. 完成A/B雙面收集後，滿載Rack由KUKA AGV搬運到人工收料區
```

### 階段7：最終處理
```
WCS調度系統
正常Rack處理：
├── 送到人工收料區 (51-55)
├── 人工取出製程完成的產品
├── 清空的Rack進入回收流程
└── 重新循環使用

注：所有OCR NG問題都在房間入口當下處理完畢，
    不會有NG Rack送到其他區域事後處理
```

## 🤖 三種AGV分工協作

### 🚛 Cargo AGV (貨物搬運車)
- **工作區域**：房間門口（入口和出口）
- **核心職責**：
  - 房間入口：從Rack卸載Carrier到入口傳送箱 + 製程匹配驗證
  - 房間出口：從出口傳送箱裝載Carrier到Rack
- **技術特色**：
  - SensorPart 3D視覺 + OCR識別（確認產品類型）
  - 製程適配性檢查（確保產品屬於此房間製程）
  - 機械臂精密抓取單一Carrier
  - Hokuyo 8bit光通訊協調門控

### 🏗️ Loader AGV (裝載車)
- **工作區域**：房間內前段製程
- **核心職責**：入口傳送箱 → 各製程設備精密轉移
- **技術特色**：
  - 4層垂直料架，一次1格精密操作
  - 7種業務流程路由
  - PGNO程式控制機械臂動作
  - 支援S/L產品的彈性配置

### 🏭 Unloader AGV (卸載車)
- **工作區域**：房間內後段製程
- **核心職責**：製程設備 → 出口傳送箱批量轉移
- **技術特色**：
  - 上下2排料架，一次2格批量操作
  - 烘箱雙向管理(上排進料、下排出料)
  - 預乾燥機批量取料配合
  - 高效率的後段製程處理

## 📊 業務數據和效益

### 生產效能提升
- **搬運效率提升60%**：24/7自動化替代人工推車
- **製程防錯**：OCR識別 + 製程匹配，確保產品進入正確製程
- **異常處理**：完整的NG檢測和即時處理流程
- **資源利用最大化**：A/B雙面處理，提高Rack使用效率

### 系統可靠性
- **即時異常處理**：OCR NG立即Alarm通知，人員現場處理
- **人機協作平衡**：關鍵決策點保留人工介入
- **系統資料同步**：AGVCUI提供資料清除功能確保一致性
- **分層責任制**：KUKA(長距離) → Cargo(品檢) → Loader/Unloader(精密操作)

### 製程彈性
- **多製程支援**：製程1(泡藥1次) + 製程2(泡藥2次)
- **產品適配**：S/L尺寸產品的不同料架配置策略
- **房間擴展**：支援5個房間的靈活配置
- **設備整合**：完整的PLC、門控、交管系統整合

## 🎯 WCS調度系統

### 五級優先度任務系統 (配置驅動)

1. **AGV旋轉檢查** (Priority: 100) - Rack 180度轉向（雙旋轉點）
   - **房間入口旋轉** (A面空B面工作) ✅ 已啟用
     - 流程: `rack_rotation_room_inlet_aempty_bwork.yaml`
     - 測試: test_rack_rotation.py (場景1)
   - **房間出口旋轉** (A面滿B面空) ✅ 已啟用
     - 流程: `rack_rotation_room_outlet_afull_bempty.yaml`
     - 測試: test_rack_rotation.py (場景2)
2. **滿料架到人工收料區** (Priority: 80) - 製程完成處理 ✅ 已實作
   - 流程: `full_rack_outlet_to_manual_collection.yaml`
   - 功能: 滿載或尾批判斷，自動搬運到收料區（51-55）
   - 測試: test_full_rack_to_collection.py (2個場景)
3. **系統準備區到房間** (Priority: 60) - 投料調度 ✅ 已實作
   - 流程: `room_dispatch_simple.yaml`
   - 功能: 依房間優先級將準備區料架調度到對應房間入口
   - 測試: test_room_dispatch.py (2個場景)
4. **射出機停車格到系統準備區** (Priority: 50) - 料架準備 ✅ 已實作
   - 流程: `machine_to_prepare.yaml`
   - 功能: 將已派車料架從停車格調度到準備區
   - 測試: test_machine_to_prepare.py (2個場景)
5. **空料架搬運** (Priority: 40) - Rack 空置後搬運（三路徑流程）✅ 已實作
   - **流程A：空料架入口→出口** (優先) ✅ 已實作
     - 流程: `empty_rack_inlet_to_outlet.yaml`
     - 測試: test_parking_flows.py (場景1)
   - **流程B：空料架入口→停車區** (備選) ✅ 已實作
     - 流程: `empty_rack_inlet_to_parking.yaml`
     - 測試: test_parking_flows.py (場景2)
   - **流程C：停車區→出口** (需求調度) ✅ 已實作
     - 流程: `parking_to_outlet.yaml`
     - 功能: 當房間有已完成carrier等待時，從停車區調配rack到出口
     - 測試: test_parking_flows.py (場景3)

~~**人工收料區搬運**~~ - 🛑 **已確認移除**：人工收料區後續全由人工處理，不需要 AGV 搬運

~~**人工回收空料架**~~ - 🛑 **已棄用**：改為人工手動管理（OPUI-HMI 移出系統 + OPUI 加入料架）

### 資源管理區域
- **系統準備區** (11-18)：等待送到房間的滿Rack暫存
- **系統空車停放區** (31-34)：專門存放空料架的緩衝區，當房間出口已有Rack時使用
- **人工收料區** (51-55)：製程完成後的產品收集，之後由人工處理
- **空料架回收流程**：透過 OPUI-HMI「移出系統」(location_id = null) → 人工搬運到系統外倉儲 → 需要時人工搬運到射出機 → OPUI「加入料架」重新進入系統

## 🔧 技術整合亮點

### 通訊協調
- **Zenoh RMW**：跨環境高效能通訊
- **8bit光通訊**：PLC設備協調和門控安全
- **Socket.IO**：Web介面即時狀態更新
- **KUKA Fleet API**：外部AGV系統無縫整合

### 視覺系統
- **3D掃描定位**：整個Rack的精確定位
- **OCR產品識別**：確認產品類型，防止錯誤產品進入不適合的製程
- **機械臂視覺引導**：精確的Carrier抓取

### 安全機制
- **傳送箱雙門互鎖**：房間內外操作安全隔離
- **交通管制系統**：多AGV協調避免衝突
- **異常處理機制**：完整的NG檢測和恢復流程
- **人工介入點**：關鍵決策保留人工確認

## 🚀 擴展能力

### 當前配置
- **實驗階段**：Room2單房間，每種AGV各1台
- **概念驗證**：完整流程的技術可行性確認

### 未來擴展
- **多房間支援**：系統架構支援5房間同時運行
- **多車配置**：每種車型可擴展到多台備援
- **產能提升**：根據生產需求靈活擴展AGV數量
- **製程多樣化**：支援更多種類的眼鏡產品製程

## 💡 核心價值

### 對企業的價值
- **自動化升級**：從人工搬運升級到AGV系統
- **製程防錯**：OCR 識別和製程匹配確保產品進入正確製程
- **效率提升**：24/7不間斷運行，大幅提升生產效率
- **成本控制**：減少人力成本，提高設備利用率

### 對工業4.0的貢獻
- **自動化製造**：配置驅動的調度系統和任務管理
- **數據記錄**：完整的生產數據收集和追蹤
- **系統整合**：多品牌AGV和設備的統一管理
- **人機協作**：平衡的人工介入和自動化配合

---

💡 **總結**：眼鏡生產流程展現了RosAGV系統的完整能力，從射出機到最終包裝的端到端自動化，結合了視覺檢測、任務調度、OCR 製程適配檢查和異常處理的完整解決方案。

## 🔗 相關資源

- [AGV車型詳細介紹](../agv-vehicles/vehicle-types.md) - 了解三種AGV的技術特色
- [系統架構設計](../system-architecture/dual-environment.md) - 雙環境架構詳解
- [KUKA Fleet整合](../technical-details/kuka-integration.md) - 外部系統整合方案