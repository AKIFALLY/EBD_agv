# Keyence PLC 通訊協議

## 🎯 適用場景
- 理解 Keyence PLC 通訊協議規範和指令格式
- 為 PLC 相關開發提供協議參考
- 解決 PLC 通訊問題和錯誤碼分析

## 📋 協議概述

### 協議特性
- **通訊方式**: TCP/IP Socket 連接
- **預設端口**: 8501
- **編碼格式**: UTF-8
- **指令終止符**: `\r\n` (CRLF)
- **超時設定**: 5秒 (可調整)

### 協議格式
```
指令格式: [指令碼] [參數] \r\n
回應格式: [狀態/資料] \r\n
錯誤格式: [錯誤碼] \r\n
```

## 🔧 核心指令集

### 系統查詢指令
```
?K\r\n          # 查詢 PLC 機型
?M\r\n          # 查詢運行模式
```

### 資料讀寫指令
```
RD [設備][地址]\r\n                    # 讀取單一資料
WR [設備][地址] [數值]\r\n             # 寫入單一資料
RDS [設備][地址] [長度]\r\n            # 連續讀取資料
WRS [設備][地址] [長度] [數值...]\r\n   # 連續寫入資料
```

### 強制控制指令
```
ST [設備][地址]\r\n     # 強制 ON (ForceOn)
RS [設備][地址]\r\n     # 強制 OFF (ForceOff)
```

## 📋 設備類型

### 常用設備代碼
| 設備類型 | 代碼 | 說明 | 範例 |
|---------|------|------|------|
| 資料記憶體 | DM | Data Memory | DM2990 |
| 內部繼電器 | MR | Memory Relay | MR3708 |
| 輸入繼電器 | R | Input Relay | R100 |
| 輸出繼電器 | Y | Output Relay | Y200 |
| 連結繼電器 | B | Link Relay | B300 |
| 特殊繼電器 | SM | Special Memory | SM400 |

### 地址格式
- **十進制**: 直接使用數字 (如: DM2990)
- **十六進制**: 使用 H 前綴 (如: DMH1234)
- **地址範圍**: 依 PLC 型號而定

## ⚠️ 錯誤處理

### 標準錯誤碼
```python
ERROR_MESSAGES = {
    "E0": "E0:元件編號異常",    # 設備地址錯誤
    "E1": "E1:指令異常",       # 指令格式錯誤
    "E4": "E4:禁止寫入",       # 寫入權限錯誤
}
```

### 錯誤處理策略
1. **檢查回應**: 每次指令執行後檢查錯誤碼
2. **重試機制**: 連接失敗時自動重試
3. **日誌記錄**: 記錄所有錯誤和異常情況
4. **優雅降級**: 通訊失敗時的備用處理

## 🌐 連接管理

### 連接參數
```python
# 基本連接配置
PLC_IP = "192.168.2.101"    # PLC IP 地址
PLC_PORT = 8501             # PLC 端口
CONNECT_TIMEOUT = 5         # 連接超時 (秒)
```

### 連接池配置
```python
# 連接池參數
MIN_POOL_SIZE = 1           # 最小連接數
MAX_POOL_SIZE = 5           # 最大連接數
RECONNECT_INTERVAL = 5      # 重連間隔 (秒)
```

### 網路考量
- **工業網路延遲**: 考慮工業環境的網路延遲
- **防火牆設定**: 確保端口 8501 開放
- **網段配置**: PLC 和系統需在同一網段或正確路由

## 📊 效能特性

### 通訊效能
- **單次指令延遲**: 通常 < 10ms
- **批量操作**: 使用 RDS/WRS 提高效率
- **並發連接**: 支援多連接並行操作
- **資料吞吐量**: 取決於網路和 PLC 型號

### 最佳化建議
1. **批量操作**: 使用連續讀寫指令減少往返次數
2. **連接池**: 使用連接池管理提高並發性能
3. **快取策略**: 對頻繁讀取的資料實施快取
4. **錯誤處理**: 實施完善的錯誤處理和重試機制

## 🔍 診斷和測試

### 連接測試
```bash
# 網路連通性測試
ping 192.168.2.101
telnet 192.168.2.101 8501

# 基本指令測試
echo -e "?K\r\n" | nc 192.168.2.101 8501
```

### 協議驗證
```python
# 指令格式驗證
def validate_command(command):
    if not command.endswith("\r\n"):
        return False
    if len(command.strip()) == 0:
        return False
    return True

# 回應格式檢查
def check_response(response):
    if response[:2] in ["E0", "E1", "E4"]:
        return "ERROR", response
    return "OK", response
```

## 💡 實施建議

### 開發最佳實踐
1. **協議封裝**: 使用統一的協議處理類別
2. **錯誤處理**: 實施完整的錯誤檢查和處理機制
3. **連接管理**: 使用連接池提高效能和穩定性
4. **日誌記錄**: 記錄所有 PLC 通訊活動便於調試

### 安全考量
1. **權限控制**: 限制寫入操作的權限
2. **輸入驗證**: 驗證所有輸入參數的合法性
3. **異常處理**: 防止異常導致系統崩潰
4. **監控告警**: 實施 PLC 通訊狀態監控

## 🔗 交叉引用
- PLC 通訊實作: `app/keyence_plc_ws/CLAUDE.md`
- PLC 代理服務: `app/plc_proxy_ws/CLAUDE.md`
- 網路診斷: @docs-ai/operations/maintenance/system-diagnostics.md
- ROS 2 整合: @docs-ai/knowledge/protocols/ros2-interfaces.md