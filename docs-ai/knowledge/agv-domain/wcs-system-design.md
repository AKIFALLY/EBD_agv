# WCS ç³»çµ±è¨­è¨ˆæ¶æ§‹

## ğŸ¯ é©ç”¨å ´æ™¯
- ç†è§£ RosAGV ä¸­ WCS (Warehouse Control System) çš„æ•´é«”è¨­è¨ˆç†å¿µ
- æŒæ¡ä¸ƒå¤§æ¥­å‹™æµç¨‹çš„èª¿åº¦é‚è¼¯
- ç‚º AI WCS é–‹ç™¼æä¾›å®Œæ•´çš„è¨­è¨ˆåƒè€ƒ

## ğŸ“‹ ç³»çµ±æ¦‚è¿°

WCS (Warehouse Control System) æ˜¯ RosAGV ç³»çµ±çš„æ ¸å¿ƒæ±ºç­–å¼•æ“ï¼Œè² è²¬ç®¡ç† Rack è»Šçš„æ¬ç§»éœ€æ±‚æ±ºç­–å’Œä»»å‹™èª¿åº¦ã€‚

### åŸºæœ¬ç’°å¢ƒé…ç½®
- **æˆ¿é–“æ•¸é‡**: æ”¯æ´ 1-10 å€‹æˆ¿é–“å‹•æ…‹æ“´å±•
- **æ¯å€‹æˆ¿é–“é…ç½®**: 1å€‹å…¥å£ + 1å€‹å‡ºå£ (å‡å¯åœé  Rack è»Š)
- **Rack ä½ç½®ç®¡ç†**: ç”± WCS æŒæ§ä¸¦å„²å­˜åœ¨è³‡æ–™åº«ä¸­
- **å¯¦é«”æ¬é‹**: ç”± KUKA AGV é€é KUKA API åŸ·è¡Œ

## ğŸ—ï¸ ç³»çµ±æ¶æ§‹åˆ†å·¥

### ğŸ¯ WCS (çµ±ä¸€æ±ºç­–å¼•æ“)
**è·è²¬ç¯„åœ**:
- æ±ºç­– Rack æ˜¯å¦éœ€è¦æ¬ç§»
- ç”¢ç”Ÿæ¬é‹ä»»å‹™ (Task) åˆ°è³‡æ–™åº«
- ç›£æ§ Rack ä½ç½®ç‹€æ…‹
- åŸ·è¡Œä¸ƒå¤§æ¥­å‹™æµç¨‹çµ±ä¸€èª¿åº¦

### ğŸ¤– RCS (Robot Control System)
**è·è²¬ç¯„åœ**:
- è®€å– WCS ç”¢ç”Ÿçš„ä»»å‹™
- é€é KUKA API å‘ KUKA Fleet ä¸‹é”æ¬é‹æŒ‡ä»¤
- ç®¡ç† AGV èª¿åº¦

### ğŸŒ Web API
**è·è²¬ç¯„åœ**:
- æŒæ§ä»»å‹™é‹è¡Œç‹€æ…‹
- æ›´æ–°ä»»å‹™ç‹€æ…‹åˆ°è³‡æ–™åº«
- èˆ‡ KUKA Fleet ä»‹é¢æ•´åˆ

## ğŸ”„ å®Œæ•´çš„ Rack ç”Ÿå‘½é€±æœŸæµç¨‹

### éšæ®µ1ï¼šä¸Šæ–™éšæ®µ
1. **ä½œæ¥­å€ä¸Šè²¨** â†’ ä½œæ¥­å“¡åœ¨ä½œæ¥­å€(4å€‹ä½œæ¥­å€ï¼Œæ¯å€‹æœ‰2å€‹åœè»Šæ ¼)å°‡è²¨ç‰©æ”¾ä¸Šç©ºRack
   - åœè»Šæ ¼ä½ç½®è¨˜éŒ„åœ¨ `machine.parking_space_1/2` æ¬„ä½
2. **OPUIæ“ä½œ** â†’ ä½œæ¥­å“¡é€éOPUIå¾Œç«¯ç›´é€£è³‡æ–™åº«ï¼Œç”¢ç”Ÿ`status=0`çš„task
   - ç›®æ¨™æˆ¿é–“è³‡è¨Šå¯«å…¥ `task.parameters`
   - ä»»å‹™é¡å‹ï¼š**å«è»Š**(éœ€è¦ç©ºRack) æˆ– **æ´¾è»Š**(å°‡æ»¿è»Šç§»èµ°)
3. **WCSç›£æ§èˆ‡åŸ·è¡Œ**ï¼š
   - **æ´¾è»Š**ï¼šWCSå°‡æ»¿è¼‰Racké€åˆ°"ç³»çµ±æº–å‚™æ´¾è»Šå€"ç­‰å¾…
   - **å«è»Š**ï¼šWCSæŒ‘é¸ç©ºRackï¼Œç”¢ç”Ÿä»»å‹™è®“AGVæ¬é‹åˆ°å«è»Šçš„ä½œæ¥­å€

### éšæ®µ2ï¼šç”Ÿç”¢éšæ®µ
4. **é€²å…¥æˆ¿é–“å…¥å£** â†’ WCSä¾å„ªå…ˆåº¦å°‡Rackå¾æº–å‚™å€é€åˆ°æˆ¿é–“å…¥å£
5. **æ©Ÿå™¨æ‰‹è‡‚å–æ–™** â†’ æˆ¿é–“å…¥å£æ©Ÿå™¨æ‰‹è‡‚å°‡Rackä¸Šè²¨ç‰©é€å…¥æˆ¿é–“è™•ç†
6. **Aé¢æ¸…ç©ºèˆ‡ç¿»é¢** â†’ Rackæœ‰2é¢ï¼ŒAé¢carrierå…¨éƒ¨æ¬å®Œæ™‚ï¼š
   - WCSç”¢ç”Ÿ**æ—‹è½‰ä»»å‹™**ï¼Œè®“AGVåŸ·è¡ŒRackç¿»é¢å‹•ä½œ
   - æ©Ÿå™¨æ‰‹è‡‚ç¹¼çºŒä½œæ¥­Bé¢
7. **NGæª¢æŸ¥èˆ‡è™•ç†** â†’ æ©Ÿå™¨æ‰‹è‡‚OCRæª¢æŸ¥ï¼Œå¦‚æœNGï¼š
   - è¨˜éŒ„NGä½†ä¸å–å‡ºcarrier
   - **æœ‰NG carrierçš„Rack â†’ é€åˆ°NGå€äººå“¡è™•ç†**
   - **æ­£å¸¸ç©ºRack â†’ é€åˆ°æˆ¿é–“å‡ºå£(æœ‰ç©ºä½)æˆ–ç©ºRackæš«å­˜å€**

### éšæ®µ3ï¼šæ”¶æ–™éšæ®µ
8. **æ©Ÿå™¨æ‰‹è‡‚æ”¾æ–™** â†’ æˆ¿é–“å‡ºå£æ©Ÿå™¨æ‰‹è‡‚å°‡è™•ç†å®Œè²¨ç‰©æ”¾åˆ°ç©ºRackä¸Š
9. **Aé¢æ”¾æ»¿èˆ‡ç¿»é¢** â†’ Rack Aé¢æ”¾æ»¿ä½†Bé¢æœªæ”¾æ™‚ï¼š
   - WCSç”¢ç”Ÿ**æ—‹è½‰ä»»å‹™**(ç¯€é»è·¯å¾‘èˆ‡å…¥å£æ—‹è½‰ä¸åŒ)
   - æ©Ÿå™¨æ‰‹è‡‚ç¹¼çºŒä½œæ¥­Bé¢
10. **é€åˆ°æ”¶æ–™å€** â†’ Rackæ»¿è¼‰æˆ–æˆ¿é–“å°¾æ‰¹å®Œæˆæ™‚é€åˆ°"äººå·¥æ”¶æ–™å€"

### éšæ®µ4ï¼šå›æ”¶éšæ®µ
11. **äººå·¥æ”¶æ–™** â†’ ä½œæ¥­å“¡å¾äººå·¥æ”¶æ–™å€å–èµ°å®Œæˆå“
    - ä½œæ¥­å“¡åœ¨ç³»çµ±è¼¸å…¥Rackå·²ç©º
    - ä½œæ¥­å“¡å°‡Rackæ¬åˆ°ç©ºè»Šå›æ”¶ä½ç½®(2æ ¼Node)
12. **ç©ºè»Šå›æ”¶** â†’ WCSæª¢æŸ¥åˆ°Rackåœ¨ç©ºè»Šå›æ”¶ä½ç½®ï¼Œæ´¾ä»»å‹™é€å›"ç³»çµ±ç©ºæ–™è»Šåœè»Šå€"

## ğŸš€ WCS çµ±ä¸€æ±ºç­–å¼•æ“è¨­è¨ˆ

### ä¸ƒå¤§æ¥­å‹™æµç¨‹å„ªå…ˆåº¦æ¶æ§‹

åŸºæ–¼å®Œæ•´æ¢ä»¶é‚è¼¯åˆ†æï¼ŒWCSç³»çµ±åŒ…å«7å€‹æ ¸å¿ƒæ¥­å‹™æµç¨‹ï¼ŒæŒ‰å„ªå…ˆåº¦æ’åºï¼š

#### ğŸ”´ ç¬¬1ç´šï¼šAGVæ—‹è½‰æª¢æŸ¥ (Priority: 100)
**æ¥­å‹™æµç¨‹**ï¼šæª¢æŸ¥ç­‰å¾…æ—‹è½‰ç‹€æ…‹çš„AGVï¼Œä½¿ç”¨3å€‹ç¯€é»ç§»å‹•æ–¹å¼åŸ·è¡Œæ—‹è½‰

**è§¸ç™¼æ¢ä»¶**ï¼š
- AGVè™•æ–¼ 'wait_rotation_state' ç‹€æ…‹
- å°æ‡‰ä»»å‹™ç„¡å­ä»»å‹™å­˜åœ¨
- ç„¡é‡è¤‡åŸ·è¡Œä»»å‹™ (work_id='220001')

#### ğŸŸ  ç¬¬2ç´šï¼šNGæ–™æ¶å›æ”¶ (Priority: 90)
**æ¥­å‹™æµç¨‹**ï¼šå°‡NGæ–™æ¶å¾æˆ¿é–“å…¥å£å‚³é€ç®±æ¬é‹åˆ°NGå›æ”¶å€

**è§¸ç™¼æ¢ä»¶**ï¼š
- NGå›æ”¶å€æœ‰ç©ºä½ (ä½ç½®71-72, status=2)
- æˆ¿é–“å…¥å£å‚³é€ç®±æœ‰NGæ–™æ¶ (location_id=X0001, status=7)
- ç„¡é‡è¤‡åŸ·è¡Œä»»å‹™ (work_id='220001', node_id=location_id)

#### ğŸŸ¡ ç¬¬3ç´šï¼šæ»¿æ–™æ¶åˆ°äººå·¥æ”¶æ–™å€ (Priority: 80)
**æ¥­å‹™æµç¨‹**ï¼šæ»¿æ–™æ¶å¾å„æˆ¿é–“æ¬é‹åˆ°äººå·¥æ”¶æ–™å€

**è§¸ç™¼æ¢ä»¶**ï¼š
- ç³»çµ±ç©ºæ¶å€æœ‰ç©ºæ–™æ¶ (ä½ç½®31-34, status=3)
- æˆ¿é–“å…§æœ‰carrieréœ€è¦æ¬é‹
- ç„¡é‡è¤‡åŸ·è¡Œä»»å‹™ (work_id='220001')

#### ğŸŸ¡ ç¬¬4ç´šï¼šäººå·¥æ”¶æ–™å€æ¬é‹ (Priority: 80)
**æ¥­å‹™æµç¨‹**ï¼šäººå·¥æ”¶æ–™å€æ»¿æ–™æ¶æ¬é‹åˆ°æˆ¿é–“å…¥å£å‚³é€ç®±

**è§¸ç™¼æ¢ä»¶**ï¼š
- äººå·¥æ”¶æ–™å€æœ‰ç©ºä½ (ä½ç½®51-55, status=2)
- æˆ¿é–“å‡ºå£å‚³é€ç®±æœ‰æ»¿æ–™æ¶ (status=[2,3,6]) æˆ– cargoä»»å‹™å·²å®Œæˆ
- ç„¡é‡è¤‡åŸ·è¡Œä»»å‹™ (work_id='220001')

#### ğŸŸ¢ ç¬¬5ç´šï¼šç³»çµ±æº–å‚™å€åˆ°æˆ¿é–“ (Priority: 60)
**æ¥­å‹™æµç¨‹**ï¼šç³»çµ±æº–å‚™å€æ–™æ¶é€å¾€æˆ¿é–“å…¥å£å‚³é€ç®±

**è§¸ç™¼æ¢ä»¶**ï¼š
- ç³»çµ±æº–å‚™å€æœ‰æ–™æ¶ (ä½ç½®11-18, status=3)
- æˆ¿é–“å…¥å£å‚³é€ç®±ç„¡æ–™æ¶ä½”ç”¨
- ç„¡é‡è¤‡åŸ·è¡Œä»»å‹™ (work_id='220001')

#### ğŸ”µ ç¬¬6ç´šï¼šç©ºæ–™æ¶æ¬é‹ (Priority: 40)
**æ¥­å‹™æµç¨‹**ï¼šå…¥å£å‚³é€ç®±ç©ºæ–™æ¶æ¬é‹åˆ°å‡ºå£å‚³é€ç®±

**è§¸ç™¼æ¢ä»¶**ï¼š
- æˆ¿é–“å…¥å£å‚³é€ç®±æœ‰ç©ºæ–™æ¶ (status=1)
- æˆ¿é–“å‡ºå£å‚³é€ç®±ç„¡æ–™æ¶ä½”ç”¨
- ç„¡é‡è¤‡åŸ·è¡Œä»»å‹™ (work_id='220001')

#### ğŸ”µ ç¬¬7ç´šï¼šäººå·¥å›æ”¶ç©ºæ–™æ¶ (Priority: 40)
**æ¥­å‹™æµç¨‹**ï¼šäººå·¥å›æ”¶ç©ºæ–™æ¶å€æ¬é‹åˆ°ç³»çµ±ç©ºæ–™æ¶å€

**è§¸ç™¼æ¢ä»¶**ï¼š
- äººå·¥å›æ”¶ç©ºæ–™æ¶å€æœ‰æ–™æ¶ (ä½ç½®91-92, status=3)
- ç©ºæ–™æ¶å›æ”¶å€æœ‰ç©ºä½ (ä½ç½®51-54, status=2)
- ç„¡é‡è¤‡åŸ·è¡Œä»»å‹™ (work_id='230001', status IN (0,1,2)) â­ç‰¹æ®Šwork_idä½¿ç”¨æµç¨‹è§¸ç™¼

### çµ±ä¸€æ±ºç­–å¼•æ“æ¶æ§‹

```python
class UnifiedWCSDecisionEngine:
    """çµ±ä¸€çš„WCSæ±ºç­–å¼•æ“ - æ•´åˆæ‰€æœ‰æ¥­å‹™æµç¨‹"""
    
    def __init__(self):
        self.priority_levels = {
            'AGV_ROTATION': 100,        # AGVæ—‹è½‰æª¢æŸ¥
            'NG_RECYCLING': 90,         # NGæ–™æ¶å›æ”¶
            'MANUAL_TRANSPORT': 80,     # äººå·¥æ”¶æ–™å€ç›¸é—œ
            'SYSTEM_TO_ROOM': 60,       # ç³»çµ±æº–å‚™å€åˆ°æˆ¿é–“
            'EMPTY_OPERATIONS': 40      # ç©ºæ–™æ¶å’Œäººå·¥å›æ”¶
        }
    
    def run_unified_decision_cycle(self) -> List[TaskDecision]:
        """åŸ·è¡Œçµ±ä¸€æ±ºç­–é€±æœŸ - æ¶µè“‹7å¤§æ¥­å‹™æµç¨‹"""
        all_decisions = []
        
        # ğŸ”´ Priority 100: AGVæ—‹è½‰æª¢æŸ¥
        decisions = self.check_agv_rotation_flow()
        all_decisions.extend(decisions)
        
        # ğŸŸ  Priority 90: NGæ–™æ¶å›æ”¶
        decisions = self.check_ng_rack_recycling_flow()
        all_decisions.extend(decisions)
        
        # ğŸŸ¡ Priority 80: äººå·¥æ”¶æ–™å€ç›¸é—œæµç¨‹
        decisions = self.check_full_rack_to_manual_flow()
        all_decisions.extend(decisions)
        
        decisions = self.check_manual_area_transport_flow()
        all_decisions.extend(decisions)
        
        # ğŸŸ¢ Priority 60: ç³»çµ±æº–å‚™å€åˆ°æˆ¿é–“
        decisions = self.check_system_to_room_flow()
        all_decisions.extend(decisions)
        
        # ğŸ”µ Priority 40: ç©ºæ–™æ¶ç›¸é—œæµç¨‹
        decisions = self.check_empty_rack_transfer_flow()
        all_decisions.extend(decisions)
        
        decisions = self.check_manual_empty_recycling_flow()
        all_decisions.extend(decisions)
        
        # ä¾å„ªå…ˆåº¦æ’åºä¸¦èª¿åº¦
        return self._prioritize_and_schedule(all_decisions)
```

## ğŸ¯ æ ¸å¿ƒæŠ€è¡“ç‰¹é»

### çµ±ä¸€çš„æ¥­å‹™è¦å‰‡å¼•æ“
- **å–®ä¸€æ±ºç­–é»**: çµ±åˆæ‰€æœ‰æ¥­å‹™é‚è¼¯åˆ°ä¸€å€‹å¼•æ“
- **PythonåŸç”Ÿ**: å®Œå…¨ä½¿ç”¨Pythonå¯¦ç¾ï¼Œå‘Šåˆ¥è¤‡é›œSQLæ¢ä»¶éˆ
- **æ‰¹æ¬¡æœ€ä½³åŒ–**: æ¸›å°‘70%è³‡æ–™åº«æŸ¥è©¢æ¬¡æ•¸

### ä¸ƒç´šå„ªå…ˆåº¦èª¿åº¦
- **Priority 100**: AGVæ—‹è½‰ (å®‰å…¨å„ªå…ˆ)
- **Priority 90**: NGå›æ”¶ (å“è³ªå„ªå…ˆ)
- **Priority 80**: äººå·¥æ”¶æ–™å€ (æ•ˆç‡å„ªå…ˆ)
- **Priority 60**: ç³»çµ±æº–å‚™å€ (æµç¨‹å„ªå…ˆ)
- **Priority 40**: ç©ºæ–™æ¶æ“ä½œ (ç¶­è­·å„ªå…ˆ)

### æ™ºèƒ½è¡çªè§£æ±º
- **ä½ç½®è¡çª**: è‡ªå‹•æª¢æ¸¬ç›®æ¨™ä½ç½®ä½”ç”¨
- **ä»»å‹™å»é‡**: work_id + location_idé›™é‡æª¢æŸ¥
- **è³‡æºèª¿åº¦**: AGVè³‡æºæ™ºèƒ½åˆ†é…

## ğŸ”— äº¤å‰å¼•ç”¨
- AI WCS å¯¦ä½œ: @app/ai_wcs_ws/CLAUDE.md
- è³‡æ–™åº«è¨­è¨ˆ: @docs-ai/knowledge/agv-domain/wcs-database-design.md
- Work ID ç³»çµ±: @docs-ai/knowledge/agv-domain/wcs-workid-system.md
- æ¥­å‹™æµç¨‹è©³ç´°: @docs-ai/knowledge/agv-domain/wcs-business-flows.md