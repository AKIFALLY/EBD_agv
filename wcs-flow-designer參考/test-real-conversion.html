<!DOCTYPE html>
<html>
<head>
    <title>å¯¦éš›JSONè½‰æ›æ¸¬è©¦</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .json-input, .json-output { 
            background: #2d2d2d; 
            color: #f8f9fa; 
            padding: 15px; 
            border-radius: 5px; 
            font-family: monospace; 
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            margin: 10px 0;
        }
        .json-input { border: 2px solid #dc3545; }
        .json-output { border: 2px solid #28a745; }
        button { 
            padding: 10px 20px; 
            margin: 10px 5px; 
            background: #007bff; 
            color: white; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
        }
        button:hover { background: #0056b3; }
        .section { margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 5px; }
        h2 { color: #495057; border-bottom: 2px solid #dee2e6; padding-bottom: 10px; }
    </style>
</head>
<body>
    <h1>ğŸ”„ å¯¦éš›JSONè½‰æ›æ¸¬è©¦</h1>
    
    <div class="section">
        <h2>ğŸ“ è¼¸å…¥æ ¼å¼ï¼ˆç¾æœ‰ä¿å­˜æ ¼å¼ï¼‰</h2>
        <div class="json-input" id="inputJson">
{
  "id": "wcs-flow@0.1.0",
  "nodes": [
    {
      "id": "room-has-carrier_1",
      "label": "æˆ¿é–“å…§æ˜¯å¦æœ‰Carrier",
      "data": {
        "name": "æˆ¿é–“å…§æ˜¯å¦æœ‰Carrier",
        "type": "room-has-carrier",
        "category": "condition",
        "description": "",
        "roomNumber": "01"
      },
      "position": [0, 0]
    },
    {
      "id": "create-task_2",
      "label": "å‰µå»ºä»»å‹™",
      "data": {
        "name": "å‰µå»ºä»»å‹™",
        "type": "create-task",
        "category": "action",
        "description": "",
        "capacity": 1000,
        "processingTime": 10,
        "efficiency": 95,
        "equipmentId": "WCS_CREATE-TASK_2",
        "plcAddress": "192.168.1.100",
        "zone": "",
        "priority": "normal",
        "missionType": "RACK_MOVE"
      },
      "position": [0, 0]
    }
  ],
  "connections": [
    {
      "id": "c0ca26d1a8b64cdd",
      "source": "room-has-carrier_1",
      "target": "create-task_2",
      "sourceOutput": "result",
      "targetInput": "trigger"
    }
  ]
}
        </div>
    </div>
    
    <button onclick="convertToPythonFormat()">ğŸ”„ è½‰æ›ç‚ºPythonå¯åŸ·è¡Œæ ¼å¼</button>
    <button onclick="convertWithRoomLoop()">ğŸ”„ è½‰æ›ç‚ºæˆ¿é–“è¿´åœˆæ ¼å¼</button>
    <button onclick="showAnalysis()">ğŸ” é¡¯ç¤ºåˆ†æéç¨‹</button>
    
    <div class="section">
        <h2>ğŸ è¼¸å‡ºæ ¼å¼ï¼ˆPythonå¯åŸ·è¡Œï¼‰</h2>
        <div class="json-output" id="outputJson">é»æ“Šä¸Šæ–¹æŒ‰éˆ•é–‹å§‹è½‰æ›...</div>
    </div>
    
    <div class="section" id="analysisSection" style="display: none;">
        <h2>ğŸ” è½‰æ›åˆ†æéç¨‹</h2>
        <div id="analysisOutput"></div>
    </div>

    <script>
        function log(message) {
            console.log(message);
            const analysis = document.getElementById('analysisOutput');
            if (analysis) {
                analysis.innerHTML += '<div>' + message + '</div>';
            }
        }

        function showAnalysis() {
            document.getElementById('analysisSection').style.display = 'block';
            document.getElementById('analysisOutput').innerHTML = '';
            
            const inputData = JSON.parse(document.getElementById('inputJson').textContent);
            
            log('=== é–‹å§‹åˆ†æè¼¸å…¥JSON ===');
            log('ç¯€é»æ•¸é‡: ' + inputData.nodes.length);
            log('é€£æ¥æ•¸é‡: ' + inputData.connections.length);
            
            // åˆ†æç¯€é»
            log('\\n=== ç¯€é»åˆ†æ ===');
            inputData.nodes.forEach(node => {
                log(`ç¯€é» ${node.id}:`);
                log(`  é¡å‹: ${node.data.category} (${node.data.type})`);
                log(`  åç¨±: ${node.data.name}`);
                if (node.data.roomNumber) log(`  æˆ¿é–“ç·¨è™Ÿ: ${node.data.roomNumber}`);
                if (node.data.missionType) log(`  ä»»å‹™é¡å‹: ${node.data.missionType}`);
            });
            
            // åˆ†æé€£æ¥
            log('\\n=== é€£æ¥åˆ†æ ===');
            inputData.connections.forEach(conn => {
                log(`é€£æ¥ ${conn.id}: ${conn.source} â†’ ${conn.target}`);
            });
            
            // åˆ†æåŸ·è¡Œæµç¨‹
            log('\\n=== åŸ·è¡Œæµç¨‹åˆ†æ ===');
            const conditionNodes = inputData.nodes.filter(n => n.data.category === 'condition');
            const actionNodes = inputData.nodes.filter(n => n.data.category === 'action');
            
            log(`æ¢ä»¶ç¯€é»: ${conditionNodes.length} å€‹`);
            log(`å‹•ä½œç¯€é»: ${actionNodes.length} å€‹`);
            
            // æª¢æŸ¥æˆ¿é–“è¿´åœˆéœ€æ±‚
            const hasRoomLoop = conditionNodes.some(n => n.data.roomNumber === 'FOR_LOOP');
            log(`\\næˆ¿é–“è¿´åœˆéœ€æ±‚: ${hasRoomLoop ? 'æ˜¯' : 'å¦'}`);
            
            log('\\n=== åˆ†æå®Œæˆ ===');
        }

        function convertToPythonFormat() {
            try {
                const inputData = JSON.parse(document.getElementById('inputJson').textContent);
                
                // æ¨¡æ“¬æ–°çš„è½‰æ›é‚è¼¯
                const workflow = {
                    workflow: {
                        name: "WCS Flow Export",
                        description: "Generated executable workflow from WCS Flow Designer", 
                        version: "1.0",
                        execution_mode: "single", // å› ç‚ºæˆ¿é–“ç·¨è™Ÿæ˜¯å…·é«”çš„ "01"
                        variables: {
                            // ä¸éœ€è¦æˆ¿é–“è®Šæ•¸ï¼Œå› ç‚ºæ˜¯ç‰¹å®šæˆ¿é–“
                        },
                        steps: []
                    }
                };
                
                // è½‰æ›æ¢ä»¶ç¯€é»
                const conditionNode = inputData.nodes.find(n => n.data.category === 'condition');
                if (conditionNode) {
                    workflow.workflow.steps.push({
                        type: "condition",
                        id: conditionNode.id,
                        function: "room_has_carrier",
                        description: conditionNode.data.name,
                        parameters: {
                            room_id: conditionNode.data.roomNumber, // "01"
                            check_exists: true
                        },
                        on_true: "create-task_2",
                        on_false: "end_step"
                    });
                }
                
                // è½‰æ›å‹•ä½œç¯€é»
                const actionNode = inputData.nodes.find(n => n.data.category === 'action');
                if (actionNode) {
                    workflow.workflow.steps.push({
                        type: "create_task",
                        id: actionNode.id,
                        description: actionNode.data.name,
                        api: "submit_mission",
                        parameters: {
                            task_type: "rack_transport",
                            model: "KUKA400i",
                            mission_type: actionNode.data.missionType || "RACK_MOVE",
                            path: {
                                type: "transport",
                                source: "room_01_exit", // åŸºæ–¼æˆ¿é–“ç·¨è™Ÿç”Ÿæˆ
                                destination: "manual_collection_area"
                            }
                        }
                    });
                }
                
                document.getElementById('outputJson').textContent = JSON.stringify(workflow, null, 2);
                
            } catch (error) {
                document.getElementById('outputJson').textContent = 'è½‰æ›éŒ¯èª¤: ' + error.message;
            }
        }
        
        function convertWithRoomLoop() {
            try {
                const inputData = JSON.parse(document.getElementById('inputJson').textContent);
                
                // æ¨¡æ“¬æˆ¿é–“è¿´åœˆè½‰æ›
                const workflow = {
                    workflow: {
                        name: "WCS Flow Export (Room Loop)",
                        description: "Generated executable workflow with room iteration",
                        version: "1.0", 
                        execution_mode: "foreach_room",
                        variables: {
                            rooms: ["01", "02", "03", "04", "05"],
                            current_room: null
                        },
                        steps: [
                            {
                                type: "foreach",
                                id: "room_iteration",
                                iterator: "rooms",
                                variable: "current_room",
                                steps: [
                                    {
                                        type: "condition",
                                        id: "room-has-carrier_check",
                                        function: "room_has_carrier",
                                        description: "æˆ¿é–“å…§æ˜¯å¦æœ‰Carrier",
                                        parameters: {
                                            room_id: "${current_room}", // å‹•æ…‹è®Šæ•¸
                                            check_exists: true
                                        },
                                        on_true: "create_transport_task",
                                        on_false: "end_room_iteration"
                                    },
                                    {
                                        type: "create_task", 
                                        id: "create_transport_task",
                                        description: "å‰µå»ºæ¬é‹ä»»å‹™",
                                        api: "submit_mission",
                                        parameters: {
                                            task_type: "rack_transport",
                                            model: "KUKA400i", 
                                            mission_type: "RACK_MOVE",
                                            path: {
                                                type: "transport", 
                                                source: "room_${current_room}_exit", // å‹•æ…‹è·¯å¾‘
                                                destination: "manual_collection_area"
                                            }
                                        }
                                    }
                                ]
                            }
                        ]
                    }
                };
                
                document.getElementById('outputJson').textContent = JSON.stringify(workflow, null, 2);
                
            } catch (error) {
                document.getElementById('outputJson').textContent = 'è½‰æ›éŒ¯èª¤: ' + error.message;
            }
        }
    </script>
</body>
</html>