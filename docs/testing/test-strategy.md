# RosAGV æ¸¬è©¦ç­–ç•¥æ–‡æª”

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æª”å®šç¾© RosAGV å°ˆæ¡ˆçš„å®Œæ•´æ¸¬è©¦ç­–ç•¥ï¼ŒåŸºæ–¼ç¾æœ‰ç¨‹å¼ç¢¼å¯¦ä½œå’Œæ¸¬è©¦æª”æ¡ˆåˆ†æï¼Œç¢ºä¿ç³»çµ±å“è³ªå’Œå¯é æ€§ã€‚

## ğŸ¯ æ¸¬è©¦ç›®æ¨™

### ä¸»è¦ç›®æ¨™
- **åŠŸèƒ½æ­£ç¢ºæ€§**: ç¢ºä¿æ‰€æœ‰åŠŸèƒ½æŒ‰ç…§éœ€æ±‚è¦æ ¼æ­£ç¢ºé‹ä½œ
- **ç³»çµ±ç©©å®šæ€§**: é©—è­‰ç³»çµ±åœ¨å„ç¨®æ¢ä»¶ä¸‹çš„ç©©å®šæ€§
- **æ•ˆèƒ½è¦æ±‚**: ç¢ºä¿ç³»çµ±æ»¿è¶³æ•ˆèƒ½å’Œå›æ‡‰æ™‚é–“è¦æ±‚
- **æ•´åˆå®Œæ•´æ€§**: é©—è­‰å„æ¨¡çµ„é–“çš„æ•´åˆå’Œè³‡æ–™æµ
- **å›æ­¸é˜²è­·**: é˜²æ­¢æ–°è®Šæ›´ç ´å£ç¾æœ‰åŠŸèƒ½

### å“è³ªæ¨™æº–
- **æ¸¬è©¦è¦†è“‹ç‡**: å–®å…ƒæ¸¬è©¦è¦†è“‹ç‡ â‰¥ 80%
- **API æ¸¬è©¦è¦†è“‹**: æ‰€æœ‰ API ç«¯é» 100% è¦†è“‹
- **é—œéµè·¯å¾‘æ¸¬è©¦**: æ¥­å‹™é—œéµæµç¨‹ 100% è¦†è“‹
- **éŒ¯èª¤è™•ç†æ¸¬è©¦**: ç•°å¸¸æƒ…æ³å’Œé‚Šç•Œæ¢ä»¶å®Œæ•´è¦†è“‹

## ğŸ—ï¸ æ¸¬è©¦æ¶æ§‹

### æ¸¬è©¦å±¤ç´šåˆ†é¡

#### 1. å–®å…ƒæ¸¬è©¦ (Unit Tests)
- **ç¯„åœ**: å€‹åˆ¥å‡½æ•¸ã€é¡åˆ¥ã€æ¨¡çµ„
- **å·¥å…·**: Python unittest, pytest
- **åŸ·è¡Œé »ç‡**: æ¯æ¬¡ç¨‹å¼ç¢¼è®Šæ›´
- **è¦†è“‹ç¯„åœ**: æ¥­å‹™é‚è¼¯ã€è³‡æ–™è™•ç†ã€ç‹€æ…‹æ©Ÿ

#### 2. æ•´åˆæ¸¬è©¦ (Integration Tests)
- **ç¯„åœ**: æ¨¡çµ„é–“äº’å‹•ã€API æ•´åˆã€è³‡æ–™åº«æ“ä½œ
- **å·¥å…·**: pytest, FastAPI TestClient
- **åŸ·è¡Œé »ç‡**: æ¯æ—¥æ§‹å»º
- **è¦†è“‹ç¯„åœ**: å·¥ä½œç©ºé–“æ•´åˆã€æœå‹™é€šè¨Š

#### 3. ç³»çµ±æ¸¬è©¦ (System Tests)
- **ç¯„åœ**: å®Œæ•´ç³»çµ±åŠŸèƒ½ã€ç«¯åˆ°ç«¯æµç¨‹
- **å·¥å…·**: è‡ªå‹•åŒ–æ¸¬è©¦è…³æœ¬ã€Socket.IO æ¸¬è©¦
- **åŸ·è¡Œé »ç‡**: æ¯é€±ç™¼å¸ƒå‰
- **è¦†è“‹ç¯„åœ**: å®Œæ•´æ¥­å‹™æµç¨‹ã€ä½¿ç”¨è€…å ´æ™¯

#### 4. æ•ˆèƒ½æ¸¬è©¦ (Performance Tests)
- **ç¯„åœ**: å›æ‡‰æ™‚é–“ã€ååé‡ã€è³‡æºä½¿ç”¨
- **å·¥å…·**: è‡ªè¨‚æ•ˆèƒ½æ¸¬è©¦å·¥å…·
- **åŸ·è¡Œé »ç‡**: æ¯æœˆæˆ–é‡å¤§è®Šæ›´å‰
- **è¦†è“‹ç¯„åœ**: API æ•ˆèƒ½ã€Socket.IO æ•ˆèƒ½ã€è³‡æ–™åº«æ•ˆèƒ½

## ğŸ“ æ¸¬è©¦çµ„ç¹”çµæ§‹

### ç¾æœ‰æ¸¬è©¦æª”æ¡ˆåˆ†ä½ˆ

#### AGV å·¥ä½œç©ºé–“æ¸¬è©¦ (agv_ws)
```
agv_ws/src/
â”œâ”€â”€ loader_agv/test/                    # Loader AGV å®Œæ•´æ¸¬è©¦å¥—ä»¶
â”‚   â”œâ”€â”€ README.md                       # æ¸¬è©¦èªªæ˜æ–‡æª”
â”‚   â”œâ”€â”€ TEST_REPORT.md                  # è©³ç´°æ¸¬è©¦å ±å‘Š
â”‚   â”œâ”€â”€ test_demo.py                    # å¯é‹è¡Œçš„ Demo æ¸¬è©¦
â”‚   â”œâ”€â”€ test_agv_port_check_empty_state.py
â”‚   â”œâ”€â”€ test_transfer_check_have_state.py
â”‚   â”œâ”€â”€ test_take_transfer_state.py
â”‚   â”œâ”€â”€ test_put_agv_state.py
â”‚   â”œâ”€â”€ test_transfer_vision_position_state.py
â”‚   â”œâ”€â”€ test_take_transfer_integration.py
â”‚   â”œâ”€â”€ run_tests.py                    # æ¸¬è©¦é‹è¡Œå™¨ (å«è¦†è“‹ç‡)
â”‚   â””â”€â”€ simple_test_runner.py           # ç°¡åŒ–æ¸¬è©¦é‹è¡Œå™¨
â”œâ”€â”€ cargo_mover_agv/test/               # Cargo Mover AGV æ¸¬è©¦å¥—ä»¶
â”‚   â”œâ”€â”€ README.md                       # æ¸¬è©¦èªªæ˜æ–‡æª”
â”‚   â”œâ”€â”€ FINAL_TEST_REPORT.md            # æœ€çµ‚æ¸¬è©¦å ±å‘Š
â”‚   â”œâ”€â”€ test_idle_state_hokuyo.py
â”‚   â”œâ”€â”€ test_complete_state_hokuyo.py
â”‚   â”œâ”€â”€ test_hokuyo_busy_states.py
â”‚   â”œâ”€â”€ test_wait_rotation_async_update_task.py
â”‚   â””â”€â”€ test_fixed_wait_rotation_async_update_task.py
â””â”€â”€ unloader_agv/test/                  # Unloader AGV æ¸¬è©¦å¥—ä»¶
    â”œâ”€â”€ README.md                       # æ¸¬è©¦èªªæ˜æ–‡æª”
    â”œâ”€â”€ test_pre_dryer_calculation.py
    â””â”€â”€ test_take_quantity.py
```

#### Web API æ¸¬è©¦ (web_api_ws)
```
web_api_ws/src/
â”œâ”€â”€ web_api/tests/                      # æ ¸å¿ƒ Web API æ¸¬è©¦
â”‚   â”œâ”€â”€ README.md                       # æ¸¬è©¦èªªæ˜æ–‡æª”
â”‚   â”œâ”€â”€ test_kuka_api.py                # KUKA API åŠŸèƒ½æ¸¬è©¦
â”‚   â”œâ”€â”€ create_test_task.py             # æ¸¬è©¦ä»»å‹™å»ºç«‹å·¥å…·
â”‚   â””â”€â”€ quick_test.py                   # å¿«é€Ÿæ¸¬è©¦è…³æœ¬
â”œâ”€â”€ opui/tests/                         # OPUI å®Œæ•´æ¸¬è©¦å¥—ä»¶
â”‚   â”œâ”€â”€ refactor/                       # é‡æ§‹æ¸¬è©¦
â”‚   â”‚   â”œâ”€â”€ test_syntax.py              # èªæ³•é©—è­‰æ¸¬è©¦
â”‚   â”‚   â””â”€â”€ test_refactor.py            # æ¶æ§‹é‡æ§‹æ¸¬è©¦
â”‚   â”œâ”€â”€ validation/                     # åŠŸèƒ½é©—è­‰æ¸¬è©¦
â”‚   â”‚   â”œâ”€â”€ test_dispatch_fix.py        # æ´¾è»ŠåŠŸèƒ½ä¿®å¾©æ¸¬è©¦
â”‚   â”‚   â”œâ”€â”€ test_socket_functions.py    # Socket.IO åŠŸèƒ½æ¸¬è©¦
â”‚   â”‚   â””â”€â”€ test_final_validation.py    # æœ€çµ‚é©—è­‰æ¸¬è©¦
â”‚   â”œâ”€â”€ integration/                    # æ•´åˆæ¸¬è©¦
â”‚   â”‚   â””â”€â”€ test_integration.py         # ç³»çµ±æ•´åˆæ¸¬è©¦
â”‚   â”œâ”€â”€ run_refactor_tests.py           # é‡æ§‹æ¸¬è©¦é‹è¡Œå™¨
â”‚   â”œâ”€â”€ run_all_tests.py                # å…¨éƒ¨æ¸¬è©¦é‹è¡Œå™¨
â”‚   â”œâ”€â”€ test_current_architecture.py    # ç•¶å‰æ¶æ§‹é©—è­‰æ¸¬è©¦
â”‚   â”œâ”€â”€ test_db.py                      # è³‡æ–™åº«æ¸¬è©¦
â”‚   â”œâ”€â”€ test_op_ui_server.py            # ä¼ºæœå™¨æ¸¬è©¦
â”‚   â”œâ”€â”€ test_op_ui_socket.py            # Socket äº‹ä»¶æ¸¬è©¦
â”‚   â””â”€â”€ test_performance.py             # æ•ˆèƒ½æ¸¬è©¦
â””â”€â”€ agvcui/agvcui/testing/              # AGVCUI æ¸¬è©¦å¥—ä»¶
    â”œâ”€â”€ test_works_page.py              # Work é é¢åŠŸèƒ½æ¸¬è©¦
    â”œâ”€â”€ test_work_detached_fix.py       # Work DetachedInstanceError ä¿®å¾©æ¸¬è©¦
    â”œâ”€â”€ test_signals_readonly.py        # ä¿¡è™Ÿåªè®€åŠŸèƒ½æ¸¬è©¦
    â”œâ”€â”€ test_task_crud_fix.py           # Task CRUD ä¿®å¾©æ¸¬è©¦
    â””â”€â”€ verify_works_implementation.py  # Work å¯¦ä½œé©—è­‰
```

#### è³‡æ–™åº«ä»£ç†æ¸¬è©¦ (db_proxy_ws)
```
db_proxy_ws/src/db_proxy/
â”œâ”€â”€ test/                               # åŸºç¤æ¸¬è©¦
â”‚   â”œâ”€â”€ test_base_crud.py               # åŸºç¤ CRUD æ¸¬è©¦
â”‚   â”œâ”€â”€ test_connection_pool_manager.py # é€£ç·šæ± ç®¡ç†æ¸¬è©¦
â”‚   â””â”€â”€ test_license.py                 # License æ¨¡å‹æ¸¬è©¦
â””â”€â”€ docs/testing/                       # é€²éšæ¸¬è©¦å¥—ä»¶
    â”œâ”€â”€ run_all_tests.py                # å®Œæ•´æ¸¬è©¦é‹è¡Œå™¨
    â”œâ”€â”€ test_kuka_map_import.py          # KUKA åœ°åœ–åŒ¯å…¥æ¸¬è©¦
    â”œâ”€â”€ test_ct_map_import.py            # CT åœ°åœ–åŒ¯å…¥æ¸¬è©¦
    â”œâ”€â”€ test_both_maps.py                # åœ°åœ–æ•´åˆæ¸¬è©¦
    â””â”€â”€ test_smart_clear.py              # æ™ºèƒ½æ¸…é™¤æ¸¬è©¦
```

#### ROS 2 å·¥ä½œç©ºé–“æ¸¬è©¦
```
keyence_plc_ws/src/keyence_plc/test/    # ROS 2 æ¨™æº–æ¸¬è©¦
â”œâ”€â”€ test_copyright.py                   # ç‰ˆæ¬Šæª¢æŸ¥
â”œâ”€â”€ test_flake8.py                      # ç¨‹å¼ç¢¼é¢¨æ ¼æª¢æŸ¥
â””â”€â”€ test_pep257.py                      # æ–‡æª”å­—ä¸²æª¢æŸ¥

plc_proxy_ws/src/plc_proxy/test/        # ROS 2 æ¨™æº–æ¸¬è©¦
â”œâ”€â”€ test_copyright.py                   # ç‰ˆæ¬Šæª¢æŸ¥
â”œâ”€â”€ test_flake8.py                      # ç¨‹å¼ç¢¼é¢¨æ ¼æª¢æŸ¥
â””â”€â”€ test_pep257.py                      # æ–‡æª”å­—ä¸²æª¢æŸ¥
```

## ğŸ§ª æ¸¬è©¦æ¡†æ¶å’Œå·¥å…·

### ä¸»è¦æ¸¬è©¦æ¡†æ¶

#### Python æ¸¬è©¦æ¡†æ¶
- **unittest**: Python æ¨™æº–æ¸¬è©¦æ¡†æ¶
  - ä½¿ç”¨å ´æ™¯: åŸºç¤å–®å…ƒæ¸¬è©¦ã€ç‹€æ…‹æ©Ÿæ¸¬è©¦
  - å„ªå‹¢: å…§å»ºæ”¯æ´ã€ç„¡é¡å¤–ä¾è³´
  - ç¯„ä¾‹: loader_agv, cargo_mover_agv, unloader_agv

- **pytest**: é€²éšæ¸¬è©¦æ¡†æ¶
  - ä½¿ç”¨å ´æ™¯: è¤‡é›œæ¸¬è©¦ã€åƒæ•¸åŒ–æ¸¬è©¦ã€fixture ç®¡ç†
  - å„ªå‹¢: è±å¯Œçš„æ’ä»¶ç”Ÿæ…‹ã€éˆæ´»çš„é…ç½®
  - ç¯„ä¾‹: db_proxy_ws, opui éƒ¨åˆ†æ¸¬è©¦

#### ROS 2 æ¸¬è©¦æ¡†æ¶
- **ament_copyright**: ç‰ˆæ¬Šæª¢æŸ¥
- **ament_flake8**: ç¨‹å¼ç¢¼é¢¨æ ¼æª¢æŸ¥
- **ament_pep257**: æ–‡æª”å­—ä¸²æª¢æŸ¥

#### Web API æ¸¬è©¦å·¥å…·
- **FastAPI TestClient**: API ç«¯é»æ¸¬è©¦
- **requests**: HTTP API æ¸¬è©¦
- **Socket.IO Client**: Socket.IO åŠŸèƒ½æ¸¬è©¦

### Mock ç­–ç•¥

#### å®Œæ•´ Mock æ¶æ§‹ (loader_agv ç¯„ä¾‹)
```python
# ROS 2 ä¾è³´ Mock
sys.modules['rclpy'] = Mock()
sys.modules['std_msgs'] = Mock()
sys.modules['std_msgs.msg'] = Mock()

# ç¡¬é«”ä¾è³´ Mock
sys.modules['plc_proxy'] = Mock()
sys.modules['agv_base'] = Mock()

# è³‡æ–™åº«ä¾è³´ Mock
sys.modules['db_proxy'] = Mock()
```

#### é¸æ“‡æ€§ Mock (å…¶ä»–æ¸¬è©¦)
- æ¨¡æ“¬å¤–éƒ¨æœå‹™å›æ‡‰
- æ¨¡æ“¬ç¡¬é«”è¨­å‚™ç‹€æ…‹
- æ¨¡æ“¬è³‡æ–™åº«æ“ä½œçµæœ

## ğŸ“Š æ¸¬è©¦è¦†è“‹ç¯„åœ

### å·²å¯¦ä½œçš„æ¸¬è©¦è¦†è“‹

#### AGV ç‹€æ…‹æ©Ÿæ¸¬è©¦ âœ…
- **Loader AGV**: å®Œæ•´çš„ take_transfer æµç¨‹æ¸¬è©¦
  - AGV Port æª¢æŸ¥é‚è¼¯ (15 ç¨®ç‹€æ…‹çµ„åˆ)
  - Transfer Continuation Logic (æ ¸å¿ƒæ±ºç­–é‚è¼¯)
  - æ©Ÿå™¨äººå‹•ä½œæ§åˆ¶ (TakeTransferState, PutAgvState)
  - è³‡æ–™åº«æ“ä½œå’Œç‹€æ…‹åŒæ­¥
  - æ•´åˆæµç¨‹æ¸¬è©¦

- **Cargo Mover AGV**: Hokuyo è¨­å‚™å’ŒéåŒæ­¥ä»»å‹™æ¸¬è©¦
  - Idle State Hokuyo åŠŸèƒ½æ¸¬è©¦
  - Complete State å»¶é²é‡ç½®æ¸¬è©¦
  - Hokuyo å¿™ç¢Œç‹€æ…‹è™•ç†
  - éåŒæ­¥ä»»å‹™æ›´æ–°æ¸¬è©¦

- **Unloader AGV**: è¨ˆç®—é‚è¼¯æ¸¬è©¦
  - Pre Dryer Port è¨ˆç®—é‚è¼¯
  - Take Quantity åŠŸèƒ½é‚è¼¯

#### Web API æ¸¬è©¦ âœ…
- **æ ¸å¿ƒ API**: KUKA API åŠŸèƒ½æ¸¬è©¦
- **OPUI**: å®Œæ•´çš„å‰å¾Œç«¯æ¸¬è©¦å¥—ä»¶
  - é‡æ§‹æ¸¬è©¦ (èªæ³•é©—è­‰ã€æ¶æ§‹åˆ†é›¢)
  - åŠŸèƒ½æ¸¬è©¦ (Socket.IO åŠŸèƒ½ã€æ´¾è»Šä¿®å¾©)
  - æ•´åˆæ¸¬è©¦ (ç³»çµ±æ•´åˆã€åˆå§‹åŒ–)
  - æ•ˆèƒ½æ¸¬è©¦ (è¼‰å…¥é€Ÿåº¦ã€å›æ‡‰æ€§èƒ½)
- **AGVCUI**: ç®¡ç†åŠŸèƒ½æ¸¬è©¦
  - Work é é¢ CRUD æ“ä½œæ¸¬è©¦
  - Task CRUD ä¿®å¾©æ¸¬è©¦
  - ä¿¡è™Ÿåªè®€åŠŸèƒ½æ¸¬è©¦

#### è³‡æ–™åº«æ¸¬è©¦ âœ…
- **åŸºç¤åŠŸèƒ½**: CRUD æ“ä½œã€é€£ç·šæ± ç®¡ç†
- **åœ°åœ–åŠŸèƒ½**: KUKA/CT åœ°åœ–åŒ¯å…¥å’Œæ•´åˆ
- **è³‡æ–™å®Œæ•´æ€§**: æ™ºèƒ½æ¸…é™¤ã€å¤–éµç´„æŸæª¢æŸ¥
- **License åŠŸèƒ½**: å®Œæ•´çš„æˆæ¬Šç®¡ç†æ¸¬è©¦

#### ROS 2 å“è³ªæª¢æŸ¥ âœ…
- **ç¨‹å¼ç¢¼å“è³ª**: flake8 é¢¨æ ¼æª¢æŸ¥
- **æ–‡æª”å“è³ª**: pep257 æ–‡æª”å­—ä¸²æª¢æŸ¥
- **ç‰ˆæ¬Šåˆè¦**: copyright æª¢æŸ¥

## ğŸš€ æ¸¬è©¦åŸ·è¡Œç­–ç•¥

### æ¸¬è©¦é‹è¡Œæ–¹å¼

#### 1. å¿«é€Ÿæ¸¬è©¦ (é–‹ç™¼éšæ®µ)
```bash
# å–®ä¸€æ¨¡çµ„æ¸¬è©¦
cd agv_ws/src/loader_agv/test
python3 test_demo.py

# ç‰¹å®šåŠŸèƒ½æ¸¬è©¦
python3 -m unittest test_demo.TestTakeTransferDemo.test_transfer_continuation_logic -v
```

#### 2. å®Œæ•´æ¸¬è©¦ (æ•´åˆéšæ®µ)
```bash
# AGV å·¥ä½œç©ºé–“å®Œæ•´æ¸¬è©¦
cd agv_ws/src/loader_agv/test
python3 run_tests.py  # å«è¦†è“‹ç‡å ±å‘Š

# OPUI å®Œæ•´æ¸¬è©¦
cd web_api_ws/src/opui/tests
python3 run_all_tests.py

# è³‡æ–™åº«å®Œæ•´æ¸¬è©¦
cd db_proxy_ws/src/db_proxy/docs/testing
python3 run_all_tests.py
```

#### 3. ç³»çµ±æ¸¬è©¦ (ç™¼å¸ƒå‰)
```bash
# ä½¿ç”¨ pytest é‹è¡Œæ‰€æœ‰æ¸¬è©¦
pytest -v

# è·³éå·²çŸ¥å¤±æ•—çš„æ¸¬è©¦
pytest -k "not (test_handle_execution_order_hokuyo_completed)" -v

# ä¸¦è¡Œæ¸¬è©¦åŸ·è¡Œ
pytest -n auto -v

# æ¸¬è©¦è¦†è“‹ç‡å ±å‘Š
pytest --cov=cargo_mover_agv --cov-report=html -v
```

### æŒçºŒæ•´åˆç­–ç•¥

#### è‡ªå‹•åŒ–æ¸¬è©¦è§¸ç™¼
- **ç¨‹å¼ç¢¼æäº¤**: è§¸ç™¼å–®å…ƒæ¸¬è©¦å’Œå¿«é€Ÿæ•´åˆæ¸¬è©¦
- **Pull Request**: è§¸ç™¼å®Œæ•´æ¸¬è©¦å¥—ä»¶
- **æ¯æ—¥æ§‹å»º**: åŸ·è¡Œæ‰€æœ‰æ¸¬è©¦åŒ…å«æ•ˆèƒ½æ¸¬è©¦
- **ç™¼å¸ƒå‰**: åŸ·è¡Œå®Œæ•´ç³»çµ±æ¸¬è©¦å’Œå›æ­¸æ¸¬è©¦

#### æ¸¬è©¦çµæœè™•ç†
- **æ¸¬è©¦é€šé**: è‡ªå‹•åˆä½µæˆ–éƒ¨ç½²
- **æ¸¬è©¦å¤±æ•—**: é˜»æ­¢åˆä½µï¼Œé€šçŸ¥é–‹ç™¼è€…
- **è¦†è“‹ç‡ä¸‹é™**: è­¦å‘Šä¸¦è¦æ±‚è£œå……æ¸¬è©¦
- **æ•ˆèƒ½å›æ­¸**: æ¨™è¨˜ä¸¦è¦æ±‚å„ªåŒ–

---

**æœ€å¾Œæ›´æ–°**: 2025-01-23  
**ç¶­è­·è²¬ä»»**: æ¸¬è©¦å·¥ç¨‹å¸«ã€å“è³ªä¿è­‰åœ˜éšŠ  
**ç‰ˆæœ¬**: v1.0.0 (åŸºæ–¼å¯¦éš›æ¸¬è©¦æª”æ¡ˆåˆ†æ)
