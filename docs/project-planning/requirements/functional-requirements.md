# RosAGV 功能需求規格

## 📋 概述

本文檔詳細描述 RosAGV 系統的功能需求，按工作空間分類組織，基於實際程式碼現況和業務需求。

## 🚗 AGV 車載系統功能需求

### 1. AGV 核心控制 (agv_ws)

#### 1.1 狀態機管理 ✅
- **需求**: 實現雙層狀態管理架構（AGV 層狀態 + 通用狀態）
- **實作狀態**: 完整實作 Loader AGV，部分實作 Cargo Mover 和 Unloader AGV
- **功能範圍**:
  - 50ms 主迴圈控制週期
  - 1.5 秒狀態發布週期
  - 記憶體管理 (65536 words = 131072 bytes)
  - PLC 通訊整合
  - 路徑規劃整合

#### 1.2 任務執行管理 ✅
- **需求**: 支援多種 AGV 任務類型的執行和監控
- **實作狀態**: Loader AGV 完整支援
- **功能範圍**:
  - 任務狀態追蹤
  - 路徑執行監控
  - 異常處理和恢復
  - 任務完成回報

#### 1.3 多車型支援 🚧
- **需求**: 支援 Loader、Cargo Mover、Unloader 三種車型
- **實作狀態**: Loader AGV (✅ 完成)，其他車型 (🚧 部分實作)
- **功能範圍**:
  - 車型特定的控制邏輯
  - 不同的感測器配置
  - 專用的任務處理流程

### 2. 手動控制服務 (agv_cmd_service_ws)

#### 2.1 手動控制介面 ✅
- **需求**: 提供 AGV 手動控制和一般命令服務
- **實作狀態**: 基礎架構完成，功能待擴展
- **功能範圍**:
  - 手動移動控制
  - 緊急停止功能
  - 狀態查詢服務
  - 診斷命令支援

### 3. 搖桿控制 (joystick_ws)

#### 3.1 USB 搖桿支援 ✅
- **需求**: 支援 USB 搖桿和遊戲手把控制
- **實作狀態**: 完整實作，透過 loader_agv launch 自動啟動
- **功能範圍**:
  - joy_linux_node 整合
  - 即時控制回應
  - 多種搖桿型號支援
  - 安全控制機制

### 4. 感測器處理 (sensorpart_ws)

#### 4.1 感測器資料處理 ✅
- **需求**: 處理各種感測器資料並提供統一介面
- **實作狀態**: 完整實作
- **功能範圍**:
  - 多感測器資料融合
  - 即時資料處理
  - 感測器狀態監控
  - 資料品質檢查

### 5. GPIO 控制 (uno_gpio_ws)

#### 5.1 硬體 I/O 控制 ✅
- **需求**: 研華 UNO-137 工業電腦的 GPIO 控制
- **實作狀態**: 完整實作（非 ROS 2 專案）
- **功能範圍**:
  - 8 個數位輸入 (DI0-DI7)
  - 8 個數位輸出 (DO0-DO7)
  - C 語言和 Python 雙實作
  - libgpiod 介面支援

## 🖥️ AGVC 管理系統功能需求

### 1. 設備控制系統 (ecs_ws)

#### 1.1 設備監控和控制 ✅
- **需求**: 統一的設備控制和狀態監控
- **實作狀態**: 完整實作
- **功能範圍**:
  - 設備狀態即時監控
  - 控制命令下發
  - 異常檢測和處理
  - 設備生命週期管理

### 2. 車隊控制系統 (rcs_ws)

#### 2.1 智能任務派發 ✅
- **需求**: 基於房間和車型的智能任務分派機制
- **實作狀態**: 完整實作
- **功能範圍**:
  - CT 車隊管理 (Cargo, Loader, Unloader)
  - KUKA 車隊整合
  - 任務優先級管理
  - 車輛狀態監控

#### 2.2 任務狀態模擬 ✅
- **需求**: 任務狀態轉換模擬和測試
- **實作狀態**: 完整實作
- **功能範圍**:
  - 狀態轉換邏輯
  - 模擬測試工具
  - 異常情況處理

#### 2.3 任務狀態資料一致性 🔧
- **需求**: 確保前後端任務狀態資料的完全一致性
- **實作狀態**: 需要改善
- **功能範圍**:
  - **前後端狀態映射一致性**:
    - 狀態 ID 與狀態名稱的映射關係必須在前後端統一維護
    - 狀態常數名稱必須在前後端保持一致 (如 `READY` vs `READY_TO_EXECUTE`)
    - 狀態描述和顏色定義必須同步
  - **即時狀態同步驗證**:
    - Socket.IO 傳輸的狀態資料必須經過格式驗證
    - 前端接收狀態資料時必須進行有效性檢查
    - 當檢測到狀態不一致時，系統應記錄錯誤並採用資料庫狀態為準
  - **狀態變更追蹤機制**:
    - 實作狀態變更日誌記錄
    - 提供狀態同步檢查工具
    - 支援狀態不一致的自動修復機制
- **驗收標準**:
  - 前端顯示的任務狀態必須與資料庫 `task_status` 表中的狀態保持 100% 一致
  - 任何狀態變更必須同時更新前後端的狀態定義
  - 系統能夠自動檢測和修復狀態不一致問題

### 3. 倉庫控制系統 (wcs_ws)

#### 3.1 倉庫管理和決策 ✅
- **需求**: 智能倉庫控制和任務決策系統
- **實作狀態**: 完整實作
- **功能範圍**:
  - 任務決策引擎
  - KUKA 車隊適配
  - 倉庫運營最佳化
  - 資源分配管理

### 4. Web API 服務 (web_api_ws)

#### 4.1 核心 API 服務 (port 8000) ✅
- **需求**: 提供完整的 Web API 服務
- **實作狀態**: 完整實作，使用虛擬環境套件
- **功能範圍**:
  - PLC 控制 API (`/plc/`) - 讀寫 PLC 資料
  - 門控制 API (`/door/`) - 門開關控制和狀態查詢
  - 交通管制 API (`/traffic/`) - 交管區使用權管理
  - KUKA Fleet API (`/interfaces/api/amr/`) - KUKA 系統整合
  - 地圖匯入 API (`/map_importer/`) - 地圖檔案上傳和處理

#### 4.1.1 HTTP API 端點詳細需求 ✅
- **需求**: 提供完整的 RESTful API 端點支援
- **實作狀態**: 完整實作，基於 FastAPI 框架
- **功能範圍**:
  - **PLC 控制 API**: 支援 Keyence PLC 的讀寫操作
  - **門控制 API**: 自動門開關控制和狀態查詢
  - **交通管制 API**: 交管區域的使用權管理和衝突檢測
  - **KUKA Fleet API**: 雙向通訊（主動請求 + 被動回調）
  - **地圖匯入 API**: 支援 KUKA 地圖檔案的上傳和處理
- **驗收標準**:
  - 所有 API 端點提供 OpenAPI 文檔
  - 支援標準的 HTTP 狀態碼和錯誤處理
  - 實現適當的認證和授權機制
  - 提供完整的 API 測試覆蓋

#### 4.2 AGVCUI 服務 (port 8001) ✅
- **需求**: AGV 車隊管理 Web 介面服務
- **實作狀態**: 完整實作，包含 Socket.IO 即時通訊和認證機制
- **目標用戶**: 系統管理員、調度員、車隊監控人員
- **功能範圍**:
  - **認證系統**: 簡化版 JWT Token 認證（永不過期）
  - **管理頁面路由**: 首頁、地圖管理、任務管理、AGV 管理、料架管理、使用者管理
  - **HTTP API 路由器**: 12 個完整的管理功能路由器
  - **Socket.IO 即時通訊**: 車隊狀態監控和變更追蹤機制
- **驗收標準**:
  - 支援使用者登入/登出功能
  - 提供完整的車隊管理介面
  - 實現 100ms 間隔的即時資料同步
  - 支援基於 modify_log 的變更追蹤

##### 4.2.1 AGVCUI HTTP API 詳細需求 ✅
- **需求**: 車隊管理系統的完整 HTTP API 支援
- **實作狀態**: 完整實作，包含 12 個功能路由器
- **功能範圍**:
  - **認證 API**: 登入頁面、登入處理、登出功能
  - **管理頁面**: 地圖、任務、工作、日誌、客戶端、料架、產品、載具、AGV、設備、信號、使用者管理
  - **認證中介軟體**: 基於 Cookie 的 JWT Token 驗證
  - **CORS 配置**: 支援跨域請求和認證
- **驗收標準**:
  - 支援完整的使用者認證流程
  - 提供所有車隊管理功能的 Web 介面
  - 實現適當的權限控制和存取管理
  - 支援多使用者同時存取

#### 4.3 OPUI 服務 (port 8002) ✅
- **需求**: 操作介面 Web 服務
- **實作狀態**: 完整實作，專注於機台操作和 AGV 控制
- **目標用戶**: 現場操作員、機台操作人員
- **功能範圍**:
  - **設備授權機制**: 基於 deviceId 的設備授權檢查
  - **操作頁面路由**: 首頁 (`/home`)、設定頁面 (`/setting`)、料架頁面 (`/rack`)
  - **HTTP API 路由器**: 產品管理、授權管理、AGV 和任務、製程設定 API
  - **Socket.IO 即時通訊**: AGV 操作指令和任務狀態同步
- **驗收標準**:
  - 支援設備授權驗證功能
  - 提供直觀的機台操作介面
  - 實現即時的 AGV 操作回應
  - 支援料架管理和任務派發功能

##### 4.3.1 OPUI HTTP API 詳細需求 ✅
- **需求**: 機台操作介面的完整 HTTP API 支援
- **實作狀態**: 完整實作，包含頁面路由和 API 路由器
- **功能範圍**:
  - **頁面路由**: 首頁、設定頁面、料架頁面（均需 deviceId 授權）
  - **產品管理 API**: 產品列表、詳情、建立功能
  - **授權管理 API**: 授權列表、詳情、建立、授權檢查功能
  - **AGV 和任務 API**: AGV 管理、任務狀態查詢（prefix: `/api`）
  - **製程設定 API**: 製程設定的完整 CRUD 操作
- **驗收標準**:
  - 支援設備授權驗證機制
  - 提供完整的機台操作 API
  - 實現產品和製程的配置管理
  - 支援 AGV 任務的狀態查詢和控制

#### 4.4 Socket.IO 即時通訊系統 ✅

##### 4.4.1 AGVCUI Socket.IO 車隊管理通訊 ✅
- **需求**: 車隊管理系統的即時資料同步和狀態監控
- **實作狀態**: 完整實作，基於變更追蹤機制
- **功能範圍**:
  - **連線管理**: 使用者登入/登出、連線狀態追蹤
  - **系統資料廣播**: 地圖資訊、AGV 列表、任務列表、料架列表等 9 種資料類型
  - **變更追蹤機制**: 基於 modify_log 表的 100ms 間隔自動同步
  - **通知系統**: 系統通知和錯誤訊息推送
- **驗收標準**:
  - 支援多客戶端同時連線
  - 實現 0.2 秒內的資料變更檢測
  - 提供完整的車隊狀態即時監控
  - 支援自動重連和錯誤恢復

##### 4.4.2 OPUI Socket.IO 機台操作通訊 ✅
- **需求**: 機台操作介面的即時 AGV 控制和狀態同步
- **實作狀態**: 完整實作，基於事件驅動機制
- **功能範圍**:
  - **客戶端管理**: 設備登入、狀態恢復、clientId 映射管理
  - **AGV 操作事件**: 叫空車、派車、取消任務、確認送達
  - **料架管理事件**: 新增料架、刪除料架、料架分配
  - **任務狀態同步**: 活躍任務監控、狀態變更通知
  - **資料廣播**: 產品列表、機台列表、停車格列表同步
- **驗收標準**:
  - 支援即時的 AGV 操作指令下發
  - 實現任務狀態的即時追蹤和回報
  - 提供扁平化的操作資料結構 (op 欄位)
  - 支援向後相容性的資料遷移

##### 4.4.3 Socket.IO 系統差異化設計 ✅
- **需求**: 兩個 Socket.IO 系統的功能定位和技術特色區分
- **實作狀態**: 完整實作，明確的功能分工
- **功能差異**:
  - **AGVCUI**: 全系統監控、變更追蹤、使用者認證、週期性同步
  - **OPUI**: 機台操作、事件驅動、設備認證、即時回應
- **資料範圍差異**:
  - **AGVCUI**: 所有 AGV、任務、料架的完整資料
  - **OPUI**: 特定機台相關的操作資料
- **更新機制差異**:
  - **AGVCUI**: modify_log 變更追蹤 + 100ms 週期性同步
  - **OPUI**: 事件驅動 + 即時操作回應
- **驗收標準**:
  - 兩個系統功能互補，無重疊衝突
  - 各自滿足不同用戶群體的需求
  - 技術架構適合各自的業務場景

#### 4.5 Web API 服務差異化設計 ✅
- **需求**: 明確區分 AGVCUI 和 OPUI 兩個系統的功能定位和技術特色
- **實作狀態**: 完整實作，功能互補無重疊
- **設計原則**:
  - **用戶群體分離**: AGVCUI 面向管理員，OPUI 面向操作員
  - **功能範圍分離**: AGVCUI 全系統監控，OPUI 機台操作
  - **技術架構分離**: 不同的認證機制、資料結構、更新策略
  - **部署環境分離**: 不同的端口、容器、配置

##### 4.5.1 系統功能定位差異 ✅
- **AGVCUI (車隊管理系統)**:
  - **目標用戶**: 系統管理員、調度員、車隊監控人員
  - **主要功能**: AGV 車隊監控、任務管理、系統配置
  - **資料範圍**: 全系統資料（所有 AGV、任務、料架）
  - **認證方式**: 使用者登入（username/password）
- **OPUI (操作介面系統)**:
  - **目標用戶**: 現場操作員、機台操作人員
  - **主要功能**: 機台操作、叫車派車、料架管理
  - **資料範圍**: 機台相關資料（特定機台的停車格）
  - **認證方式**: 設備登入（deviceId/machineId）

##### 4.5.2 技術架構差異 ✅
- **Socket.IO 事件差異**:
  - **AGVCUI**: user_login/logout, map_info, agv_list, task_list, 自動資料同步
  - **OPUI**: login/client_update, call_empty/dispatch_full, add_rack/del_rack, 手動操作回應
- **資料結構差異**:
  - **AGVCUI**: 完整的資料庫模型映射，包含所有關聯資料
  - **OPUI**: 扁平化的操作資料（op 欄位），專注於操作相關資料
- **更新機制差異**:
  - **AGVCUI**: 變更追蹤（modify_log）+ 週期性同步（100ms）
  - **OPUI**: 事件驅動 + 即時回應

##### 4.5.3 部署和配置差異 ✅
- **端口配置**: AGVCUI (8001), OPUI (8002)
- **容器部署**: 不同的 Docker 容器和配置
- **中介軟體**: 不同的認證中介軟體和 CORS 配置
- **靜態資源**: 不同的前端介面和使用者體驗設計

### 5. 資料庫代理 (db_proxy_ws)

#### 5.1 資料庫連線管理 ✅
- **需求**: PostgreSQL 資料庫代理服務和 ORM 管理
- **實作狀態**: 完整實作，使用虛擬環境套件
- **功能範圍**:
  - SQLModel + SQLAlchemy ORM
  - 連線池管理
  - 資料模型定義
  - 資料庫遷移支援

### 6. KUKA 車隊整合 (kuka_fleet_ws)

#### 6.1 KUKA Fleet API 整合 ✅
- **需求**: KUKA 車隊系統整合和 API 橋接
- **實作狀態**: 完整實作，純系統套件
- **功能範圍**:
  - KUKA Fleet Adapter (ROS 2 節點架構)
  - KUKA API Client (完整 HTTP API 通訊)
  - 任務類型支援 (MOVE, RACK_MOVE, WORKFLOW)
  - 即時狀態監控 (機器人、容器、任務狀態)
  - 認證管理 (自動登入和 Token 管理)
  - 錯誤處理和重試機制

#### 6.2 KUKA API 客戶端功能 ✅
- **需求**: 完整的 KUKA Fleet API 客戶端實作
- **實作狀態**: 完整實作，支援所有 API 端點
- **功能範圍**:
  - 任務管理 API (submitMission, missionCancel, pauseMission, recoverMission)
  - 機器人管理 API (robotQuery, chargeRobot, insertRobot, removeRobot)
  - 容器管理 API (containerIn, containerOut, containerQuery, containerQueryAll)
  - 地圖管理 API (areaQuery, queryFunctionNode, queryAllForbiddenAreas)
  - 認證 API (login, token 管理)

#### 6.3 KUKA Fleet Adapter 核心功能 ✅
- **需求**: ROS 2 整合的 KUKA 車隊適配器
- **實作狀態**: 完整實作，支援三種任務類型
- **功能範圍**:
  - move() 方法 - 根據節點列表移動 AGV
  - rack_move() 方法 - 搬運任務執行
  - workflow() 方法 - 執行指定工作流程
  - 狀態監控 - 定時查詢機器人和容器狀態
  - 參數配置 - ROS 2 參數管理 (base_url, username, password, timer_period)

#### 6.4 KUKA 系統配置 ✅
- **需求**: KUKA Fleet 系統連線和配置管理
- **實作狀態**: 完整實作，支援靈活配置
- **配置參數**:
  - 基礎 URL: http://192.168.11.206:10870 (可配置)
  - 認證資訊: admin/Admin (可配置)
  - 地圖配置: MAP_LAYOUT_DISTRICT = "test-test1"
  - 機器人型號: "KMP 400i diffDrive"
  - 機器人類型: "LIFT"
  - 組織 ID: "Ching-Tech"

## 🔧 共用基礎功能需求

### 1. PLC 通訊 (keyence_plc_ws)

#### 1.1 Keyence PLC 專用通訊 ✅
- **需求**: 高效能的 Keyence PLC 通訊和記憶體管理
- **實作狀態**: 完整實作，純系統套件
- **功能範圍**:
  - TCP/IP 通訊 (port 8501, 5秒超時, UTF-8編碼)
  - 連線池管理 (1-5連線, 5秒重連間隔, 背景重連執行緒)
  - 記憶體映射 (65536 words = 131072 bytes, 小端序)
  - 指令封裝 (RD/WR/RDS/WRS/ST/RS/?K/?M) 和錯誤處理
  - 位元組級資料處理 (PlcBytes類別, 多型別轉換)

### 2. PLC 代理服務 (plc_proxy_ws)

#### 2.1 ROS 2 PLC 服務介面 ✅
- **需求**: PLC 通訊的 ROS 2 服務代理
- **實作狀態**: 完整實作，純系統套件
- **功能範圍**:
  - 8 種 ROS 2 服務類型 (ReadData, WriteData, ReadContinuousData等)
  - 自動讀取功能 (100ms週期, DM7600-7799範圍)
  - 同步和非同步操作 (ReentrantCallbackGroup)
  - 記憶體快取機制 (PlcMemory類別, 執行緒安全)

### 3. 路徑規劃 (path_algorithm)

#### 3.1 A* 路徑規劃演算法 ✅
- **需求**: 高效的 A* 路徑規劃和地圖處理
- **實作狀態**: 完整實作，使用虛擬環境套件
- **功能範圍**:
  - NetworkX 圖論庫整合
  - 歐式距離啟發函數
  - 座標轉換系統
  - 站點管理功能

### 4. 啟動管理 (launch_ws)

#### 4.1 系統啟動和配置管理 ✅
- **需求**: 統一的系統啟動和配置管理
- **實作狀態**: 完整實作
- **功能範圍**:
  - ECS Launch 檔案
  - Web API Launch 檔案
  - 參數配置管理
  - 命名空間統一

## 🎯 功能優先級矩陣

### 高優先級 (核心功能) ✅
- AGV 核心控制 (agv_ws)
- PLC 通訊 (keyence_plc_ws, plc_proxy_ws)
- 路徑規劃 (path_algorithm)
- 資料庫管理 (db_proxy_ws)

### 中優先級 (管理功能) ✅
- 車隊控制 (rcs_ws)
- 倉庫控制 (wcs_ws)
- Web API 服務 (web_api_ws)
  - 核心 API 服務 (port 8000)
  - AGVCUI 車隊管理服務 (port 8001)
  - OPUI 機台操作服務 (port 8002)
  - Socket.IO 即時通訊系統
- KUKA 整合 (kuka_fleet_ws)

### 低優先級 (輔助功能) 🚧
- 手動控制 (agv_cmd_service_ws)
- 多車型支援 (agv_ws 擴展)
- GPIO 控制 (uno_gpio_ws)

## 📝 相關文檔

- [業務流程規範](./business-processes.md)
- [非功能性需求](./non-functional-requirements.md)
- [使用者介面需求](./user-interface-requirements.md)
- [整合需求規範](./integration-requirements.md)

---

**最後更新**: 2025-01-23
**維護責任**: 產品經理
**版本**: v1.1.0 (新增 Web API 和 Socket.IO 詳細功能需求)
