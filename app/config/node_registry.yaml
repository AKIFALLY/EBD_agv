# RosAGV 統一節點管理註冊表
# 此檔案定義所有受管理的 ROS 2 節點和服務
# 用於統一節點管理系統 (manage_all_nodes)
# 注意: launch 類型的節點名稱必須與 setup.bash 中的 manage_* 函數名稱匹配

nodes:
  # ===== Web 服務群組 =====
  web_api_launch:
    type: launch
    description: "Web API 服務群組 (3個節點)"
    package: web_api_launch
    launch_file: launch.py
    nodes:
      - agvc_ui_server    # Port 8001 - AGVCUI
      - op_ui_server      # Port 8002 - OPUI
      - web_api_server    # Port 8000 - API Gateway
    port_check: [8000, 8001, 8002]
    log_file: /tmp/web_api_launch.log
    status_check: "ros2 node list | grep -E '(agvc_ui_server|op_ui_server|web_api_server)'"
    
  # ===== TAFL WCS 系統 (新一代) =====
  tafl_wcs:
    type: launch
    description: "TAFL WCS 倉儲控制系統 (新一代)"
    package: tafl_wcs
    launch_file: tafl_wcs_launch.py
    log_file: /tmp/tafl_wcs.log
    status_check: "ros2 node list | grep tafl_wcs_node"

  # ===== AGVC Database Node =====
  agvc_database_node:
    type: node
    description: "AGVC PostgreSQL 資料庫代理節點"
    package: db_proxy
    executable: agvc_database_node
    workspace: db_proxy_ws
    namespace: agvc
    log_file: /tmp/agvc_database_node.log
    pid_file: /tmp/agvc_database_node.pid
    status_check: "ros2 node list | grep agvc_database_node"
    services:
      - sql_query
      - carrier_query
      - rack_query
      - agv_query
      - task_query
      - location_query
      - room_query
      - alarm_query
      - path_query
      - system_config_query
      - traffic_zone_query
    dependencies:
      - zenoh
      - postgresql

  # ===== Room Task Build Node =====
  room_task_build:
    type: node
    description: "WCS 房間任務自動建立節點"
    package: alan_room_task_build
    executable: room_task_build_node
    workspace: wcs_ws
    namespace: agvc
    log_file: /tmp/room_task_build_node.log
    pid_file: /tmp/room_task_build_node.pid
    status_check: "ros2 node list | grep /agvc/room_task_build_node"
    dependencies:
      - zenoh
      - agvc_database_node
      - plc_service_agvc

  # ===== ECS 設備控制系統 =====
  # 注意: 在 setup.bash 中對應的函數是 manage_ecs_core
  ecs_core:
    type: node
    description: "ECS 設備控制核心"
    package: ecs
    executable: ecs_core
    namespace: agvc
    params_file: /app/config/ecs_config.yaml
    log_file: /tmp/ecs_core.log
    status_check: "ros2 node list | grep /agvc/ecs_core"
    
  # ===== RCS 機器人控制系統 =====
  rcs_core:
    type: launch
    description: "RCS 機器人控制系統"
    package: rcs
    launch_file: rcs_launch.py
    log_file: /tmp/rcs_launch.log
    status_check: "ros2 node list | grep rcs_core"

  # ===== PLC 代理服務 (AGVC) =====
  # 注意: 在 setup.bash 中對應的函數是 manage_plc_service_agvc
  plc_service_agvc:
    type: node
    description: "PLC 服務 (AGVC)"
    package: plc_proxy
    executable: plc_service
    namespace: agvc
    params_file: /app/config/ecs_config.yaml
    log_file: /tmp/plc_service_agvc.log
    status_check: "ros2 node list | grep /agvc/plc_service"
    
  # ===== AGV UI 服務 =====
  # 注意: 在 setup.bash 中對應的函數是 manage_agvui
  agvui:
    type: launch
    description: "AGV UI 服務"
    port_check: 8003
    log_file: /tmp/agvui.log
    status_check: "ros2 node list | grep agv_ui_server"
    
  # ===== SSH 服務 =====
  # 注意: 在 setup.bash 中對應的函數是 manage_ssh  
  ssh:
    type: launch
    description: "SSH 服務"
    port_check: 2200
    log_file: /tmp/ssh.log
    status_check: "pgrep -f '/usr/sbin/sshd -D -p 2200'"
    
  # ===== Zenoh Router =====
  # 注意: 在 setup.bash 中對應的函數是 manage_zenoh
  zenoh:
    type: launch
    description: "Zenoh Router"
    port_check: 7447
    log_file: /tmp/zenoh_router.log
    status_check: "pgrep -f 'rmw_zenohd'"

# ===== AGV 車載節點群組 =====
# 這些在 AGV 容器中運行，透過 SSH 管理
agv_nodes:
  cargo_agv:
    type: launch
    description: "Cargo Mover AGV 節點群組"
    package: cargo_mover_agv
    launch_file: launch.py
    nodes:
      - plc_service
      - joy_linux_node
      - agv_core_node
    namespace: "{agv_id}"  # 動態替換
    log_file: /tmp/agv_{agv_id}.log
    
  loader_agv:
    type: launch
    description: "Loader AGV 節點群組"
    package: loader_agv
    launch_file: launch.py
    nodes:
      - plc_service
      - joy_linux_node
      - agv_core_node
    namespace: "{agv_id}"  # 動態替換
    log_file: /tmp/agv_{agv_id}.log
    
  unloader_agv:
    type: launch
    description: "Unloader AGV 節點群組"
    package: unloader_agv
    launch_file: launch.py
    nodes:
      - plc_service
      - joy_linux_node
      - agv_core_node
    namespace: "{agv_id}"  # 動態替換
    log_file: /tmp/agv_{agv_id}.log

# ===== 系統基礎服務 =====
system_services:
  zenoh_router:
    type: system
    description: "Zenoh RMW Router"
    command: "ros2 run rmw_zenoh_cpp rmw_zenohd"
    log_file: /tmp/zenoh_router.log
    pid_file: /tmp/zenoh_router.pid
    port_check: 7447
    
  ssh_service:
    type: system
    description: "SSH 服務"
    command: "/usr/sbin/sshd -D -p 2200"
    pid_file: /tmp/ssh.pid
    port_check: 2200

# ===== 節點群組定義 =====
node_groups:
  all:
    description: "所有節點"
    nodes:
      - zenoh
      - ssh
      - agvc_database_node
      - web_api_launch
      - plc_service_agvc
      - ecs_core
      - rcs_core
      - tafl_wcs
      - room_task_build
      - agvui
      
  web_services:
    description: "Web 服務群組"
    nodes:
      - web_api_launch
      - agvui
      
  core_services:
    description: "核心服務"
    nodes:
      - zenoh
      - ecs_core
      - rcs_core

# ===== 遠端 AGV 配置 =====
remote_agvs:
  cargo02:
    ip: "192.168.10.11"
    port: 2222
    user: "ct"
    password: "36274806"
    type: "cargo_agv"
    
  loader02:
    ip: "192.168.10.12"
    port: 2222
    user: "ct"
    password: "36274806"
    type: "loader_agv"
    
  unloader02:
    ip: "192.168.10.13"
    port: 2222
    user: "ct"
    password: "36274806"
    type: "unloader_agv"