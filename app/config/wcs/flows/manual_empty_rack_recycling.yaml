meta:
  system: linear_flow_v2
  version: "2.0.0"
  author: "Flow WCS System"
  created_at: "2025-08-19"
  description: "äººå·¥å›æ”¶ç©ºæ–™æ¶æµç¨‹ - äººå·¥æ”¶æ–™å€è™•ç†å®Œæˆå¾Œçš„ç©ºæ–™æ¶æ¬é‹åˆ°ç©ºæ–™æ¶å€"

flow:
  id: "manual_empty_rack_recycling"
  name: "äººå·¥å›æ”¶ç©ºæ–™æ¶"
  work_id: "220008"  # äººå·¥å›æ”¶ç©ºæ–™æ¶å°ˆç”¨ work_id
  enabled: true
  priority: 40  # ä½å„ªå…ˆç´š

workflow:
  - section: "æŸ¥è©¢äººå·¥æ”¶æ–™å€ç©ºæ–™æ¶"
    description: "æŸ¥è©¢äººå·¥æ”¶æ–™å€ (51-55) è™•ç†å®Œæˆå¾Œçš„ç©ºæ–™æ¶"
    steps:
      - id: "query_manual_area_locations"
        exec: "query.locations"
        params:
          type: "manual_receive_area"
          rooms: [51, 52, 53, 54, 55]  # äººå·¥æ”¶æ–™å€ä½ç½®
          has_rack: true  # æŸ¥è©¢æœ‰æ¶å°çš„ä½ç½®
        store: "manual_locations_with_rack"
        description: "æŸ¥è©¢äººå·¥æ”¶æ–™å€æœ‰æ¶å°çš„ä½ç½®"

      - id: "check_has_manual_racks"
        exec: "check.empty"
        params:
          data: "${manual_locations_with_rack}"
        store: "no_manual_racks"
        description: "æª¢æŸ¥æ˜¯å¦æœ‰æ¶å°åœ¨äººå·¥æ”¶æ–™å€"

      - id: "stop_if_no_manual_racks"
        exec: "control.stop_flow"
        params:
          reason: "äººå·¥æ”¶æ–™å€æ²’æœ‰æ¶å°"
        skip_if: "!${no_manual_racks}"
        description: "å¦‚æœæ²’æœ‰æ¶å°å‰‡åœæ­¢æµç¨‹"

      - id: "log_manual_area_check"
        exec: "action.log_message"
        params:
          message: "ğŸ” æª¢æŸ¥äººå·¥æ”¶æ–™å€ ${manual_locations_with_rack.length} å€‹ä½ç½®çš„æ¶å°ç‹€æ…‹"
          level: "info"
          tags: ["manual_area", "empty_rack_check"]
        skip_if: "${no_manual_racks}"
        description: "è¨˜éŒ„æª¢æŸ¥ç‹€æ…‹"

  - section: "æŸ¥è©¢ç©ºæ–™æ¶å€å¯ç”¨ç©ºä½"
    description: "æŸ¥è©¢ç©ºæ–™æ¶å€æ˜¯å¦æœ‰ç©ºä½æ¥æ”¶ç©ºæ–™æ¶"
    steps:
      - id: "query_empty_rack_area"
        exec: "query.locations"
        params:
          type: "empty_rack_area"
          rooms: [41, 42, 43, 44, 45]  # ç©ºæ–™æ¶å€ä½ç½®
          has_rack: false  # æŸ¥è©¢æ²’æœ‰æ¶å°çš„ä½ç½®ï¼ˆç©ºä½ï¼‰
        store: "available_empty_area_locations"
        skip_if: "${no_manual_racks}"
        description: "æŸ¥è©¢ç©ºæ–™æ¶å€ç©ºä½"

      - id: "check_has_empty_area_space"
        exec: "check.empty"
        params:
          data: "${available_empty_area_locations}"
        store: "no_empty_area_space"
        skip_if: "${no_manual_racks}"
        description: "æª¢æŸ¥æ˜¯å¦æœ‰ç©ºä½"

      - id: "log_empty_area_status"
        exec: "action.log_message"
        params:
          message: "${no_empty_area_space ? 'âš ï¸ ç©ºæ–™æ¶å€å·²æ»¿' : 'âœ… ç©ºæ–™æ¶å€æœ‰ ' + available_empty_area_locations.length + ' å€‹ç©ºä½'}"
          level: "${no_empty_area_space ? 'warning' : 'info'}"
          tags: ["empty_rack_area", "capacity"]
        skip_if: "${no_manual_racks}"
        description: "è¨˜éŒ„ç©ºæ–™æ¶å€ç‹€æ…‹"

  - section: "æª¢æŸ¥æ¯å€‹äººå·¥æ”¶æ–™å€çš„ç©ºæ–™æ¶"
    description: "éæ­·äººå·¥æ”¶æ–™å€ï¼Œæ‰¾å‡ºéœ€è¦å›æ”¶çš„ç©ºæ–™æ¶"
    steps:
      - id: "foreach_manual_locations"
        exec: "foreach"
        params:
          items: "${manual_locations_with_rack}"
          var: "location"
          steps:
            - id: "query_racks_at_manual"
              exec: "query.racks"
              params:
                location_id: "${location.id}"
                status: "available"
              store: "racks_at_location"
              description: "æŸ¥è©¢è©²ä½ç½®çš„æ¶å°"

            - id: "check_has_racks"
              exec: "check.empty"
              params:
                data: "${racks_at_location}"
              store: "no_racks"
              description: "æª¢æŸ¥æ˜¯å¦æœ‰æ¶å°"

            - id: "check_rack_empty_and_processed"
              exec: "check.rack_status"
              params:
                rack_id: "${racks_at_location[0].id}"
                side: "both"  # æª¢æŸ¥å…©é¢
                check_type: "empty"  # æª¢æŸ¥æ˜¯å¦ç‚ºç©º
              store: "rack_is_empty"
              skip_if: "${no_racks}"
              description: "æª¢æŸ¥æ¶å°æ˜¯å¦ç‚ºç©ºï¼ˆè™•ç†å®Œæˆï¼‰"

            - id: "log_empty_rack_found"
              exec: "action.log_message"
              params:
                message: "ğŸ“¤ ç™¼ç¾äººå·¥è™•ç†å®Œæˆçš„ç©ºæ–™æ¶ - ä½ç½®: ${location.name}, æ¶å°: ${racks_at_location[0].rack_id}"
                level: "info"
                tags: ["empty_rack_found", "manual_area"]
              skip_if: "${no_racks} || !${rack_is_empty}"
              description: "è¨˜éŒ„ç™¼ç¾ç©ºæ–™æ¶"

            # æ±ºå®šç©ºæ–™æ¶å»å‘
            - id: "determine_destination"
              exec: "control.switch"
              params:
                value: "${no_empty_area_space}"
                cases:
                  "true": "boxout"  # ç©ºæ–™æ¶å€æ»¿äº†ï¼Œé€åˆ°å‡ºå£
                  "false": "empty_area"  # é€åˆ°ç©ºæ–™æ¶å€
                default: "empty_area"
              store: "destination_type"
              skip_if: "${no_racks} || !${rack_is_empty}"
              description: "æ±ºå®šç©ºæ–™æ¶å»å‘"

            - id: "query_destination"
              exec: "query.locations"
              params:
                type: "${destination_type == 'boxout' ? 'boxout_transfer' : 'empty_rack_area'}"
                available: true
                limit: 1
              store: "destination_locations"
              skip_if: "${no_racks} || !${rack_is_empty}"
              description: "æŸ¥è©¢ç›®æ¨™ä½ç½®"

            - id: "check_destination_available"
              exec: "check.empty"
              params:
                data: "${destination_locations}"
              store: "no_destination"
              skip_if: "${no_racks} || !${rack_is_empty}"
              description: "æª¢æŸ¥ç›®æ¨™ä½ç½®æ˜¯å¦å¯ç”¨"

            - id: "log_no_destination"
              exec: "action.log_message"
              params:
                message: "âŒ æ²’æœ‰å¯ç”¨çš„ç›®æ¨™ä½ç½® (${destination_type})ï¼Œæš«æ™‚ä¿ç•™ç©ºæ–™æ¶åœ¨äººå·¥æ”¶æ–™å€"
                level: "warning"
                tags: ["no_destination", "manual_recycling"]
              skip_if: "${no_racks} || !${rack_is_empty} || !${no_destination}"
              description: "è¨˜éŒ„æ²’æœ‰ç›®æ¨™ä½ç½®"

            - id: "check_existing_recycling_task"
              exec: "check.task_exists"
              params:
                type: "MANUAL_EMPTY_RACK_RECYCLING"
                rack_id: "${racks_at_location[0].id}"
                status: ["pending", "in_progress"]
              store: "recycling_task_exists"
              skip_if: "${no_racks} || !${rack_is_empty} || ${no_destination}"
              description: "æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨å›æ”¶ä»»å‹™"

            - id: "create_recycling_task"
              exec: "task.create_task"
              params:
                type: "MANUAL_EMPTY_RACK_RECYCLING"
                work_id: "220008"  # äººå·¥å›æ”¶ç©ºæ–™æ¶ work_id
                source_location_id: "${location.id}"
                target_location_id: "${destination_locations[0].id}"
                rack_id: "${racks_at_location[0].id}"
                room_id: "${destination_locations[0].room_id || 0}"
                priority: "low"  # ä½å„ªå…ˆç´š
                metadata:
                  rack_name: "${racks_at_location[0].rack_id}"
                  source_location: "${location.name}"
                  target_location: "${destination_locations[0].name}"
                  destination_type: "${destination_type}"
                  transport_reason: "äººå·¥è™•ç†å®Œæˆç©ºæ–™æ¶å›æ”¶"
                  model: "Cargo"  # Cargo AGV è² è²¬æ¬é‹
                  # è·¯å¾‘è¦åŠƒï¼šå¾äººå·¥æ”¶æ–™å€åˆ°ç›®æ¨™ä½ç½®
                  nodes: ["${location.node_id}", "${destination_locations[0].node_id}"]
              store: "recycling_task_id"
              skip_if: "${no_racks} || !${rack_is_empty} || ${no_destination} || ${recycling_task_exists}"
              description: "å‰µå»ºç©ºæ–™æ¶å›æ”¶ä»»å‹™"

            - id: "log_task_created"
              exec: "action.log_message"
              params:
                message: "âœ… å‰µå»ºç©ºæ–™æ¶å›æ”¶ä»»å‹™ - æ¶å°: ${racks_at_location[0].rack_id}, å¾ ${location.name} åˆ° ${destination_locations[0].name}, ä»»å‹™ID: ${recycling_task_id}"
                level: "info"
                tags: ["task_created", "manual_recycling", "${destination_type}"]
              skip_if: "${no_racks} || !${rack_is_empty} || ${no_destination} || ${recycling_task_exists}"
              description: "è¨˜éŒ„ä»»å‹™å‰µå»º"

            - id: "update_destination_availability"
              exec: "control.update_variable"
              params:
                variable: "${destination_type == 'empty_area' ? 'available_empty_area_locations' : 'destination_locations'}"
                operation: "remove_first"
                value: 1
              skip_if: "${no_racks} || !${rack_is_empty} || ${no_destination} || ${recycling_task_exists}"
              description: "æ›´æ–°ç›®æ¨™ä½ç½®å¯ç”¨æ€§"

        skip_if: "${no_manual_racks}"
        description: "éæ­·äººå·¥æ”¶æ–™å€æª¢æŸ¥ç©ºæ–™æ¶"

  - section: "ç›£æ§å›æ”¶æ•ˆç‡"
    description: "ç›£æ§äººå·¥æ”¶æ–™å€ç©ºæ–™æ¶å›æ”¶æ•ˆç‡"
    steps:
      - id: "query_all_manual_empty_racks"
        exec: "query.racks"
        params:
          location_id: [51, 52, 53, 54, 55]  # äººå·¥æ”¶æ–™å€
          status: "available"
        store: "all_manual_racks"
        description: "æŸ¥è©¢æ‰€æœ‰äººå·¥æ”¶æ–™å€æ¶å°"

      - id: "count_total_racks"
        exec: "control.count_items"
        params:
          variable: "${all_manual_racks}"
        store: "total_manual_racks"
        description: "è¨ˆç®—ç¸½æ¶å°æ•¸"

      - id: "query_empty_manual_racks"
        exec: "foreach"
        params:
          items: "${all_manual_racks}"
          var: "rack"
          steps:
            - id: "check_if_empty"
              exec: "check.rack_status"
              params:
                rack_id: "${rack.id}"
                side: "both"
                check_type: "empty"
              store: "is_empty_${rack.id}"
              description: "æª¢æŸ¥æ˜¯å¦ç‚ºç©º"
        store: "empty_check_results"
        description: "æª¢æŸ¥å“ªäº›æ˜¯ç©ºæ–™æ¶"

      # ç°¡åŒ–çš„ç©ºæ–™æ¶è¨ˆæ•¸ï¼ˆå‡è¨­ç´„30%ç‚ºç©ºï¼‰
      - id: "estimate_empty_count"
        exec: "control.update_variable"
        params:
          variable: "empty_rack_count"
          operation: "set"
          value: "${Math.floor(total_manual_racks * 0.3)}"  # ä¼°ç®—30%ç‚ºç©º
        store: "empty_rack_count"
        description: "ä¼°ç®—ç©ºæ–™æ¶æ•¸é‡"

      - id: "calculate_recycling_efficiency"
        exec: "control.update_variable"
        params:
          variable: "recycling_efficiency"
          operation: "set"
          value: "${total_manual_racks > 0 ? (100 - empty_rack_count * 100 / total_manual_racks) : 100}"
        store: "recycling_efficiency"
        description: "è¨ˆç®—å›æ”¶æ•ˆç‡"

      - id: "log_recycling_stats"
        exec: "action.log_message"
        params:
          message: "ğŸ“Š äººå·¥æ”¶æ–™å€å›æ”¶çµ±è¨ˆ - ç¸½æ¶å°: ${total_manual_racks}, ä¼°è¨ˆç©ºæ–™æ¶: ${empty_rack_count}, å›æ”¶æ•ˆç‡: ${recycling_efficiency}%"
          level: "info"
          tags: ["recycling_stats", "manual_area"]
        description: "è¨˜éŒ„å›æ”¶çµ±è¨ˆ"

      - id: "check_low_efficiency"
        exec: "control.switch"
        params:
          value: "${recycling_efficiency < 70}"
          cases:
            "true": true
          default: false
        store: "low_efficiency"
        description: "æª¢æŸ¥å›æ”¶æ•ˆç‡æ˜¯å¦éä½"

      - id: "send_efficiency_alert"
        exec: "action.send_notification"
        params:
          message: "âš ï¸ äººå·¥æ”¶æ–™å€ç©ºæ–™æ¶å †ç©ï¼Œå›æ”¶æ•ˆç‡: ${recycling_efficiency}%ï¼Œè«‹åŠ å¿«å›æ”¶é€Ÿåº¦"
          level: "warning"
          priority: "low"
        skip_if: "!${low_efficiency}"
        description: "ç™¼é€æ•ˆç‡è­¦å‘Š"

  - section: "ç¸½çµ"
    description: "æµç¨‹åŸ·è¡Œç¸½çµ"
    steps:
      - id: "count_processed_locations"
        exec: "control.count_items"
        params:
          variable: "${manual_locations_with_rack}"
        store: "total_locations"
        description: "è¨ˆç®—è™•ç†çš„ä½ç½®æ•¸é‡"

      - id: "log_completion"
        exec: "action.log_message"
        params:
          message: "ğŸ äººå·¥å›æ”¶ç©ºæ–™æ¶æµç¨‹å®Œæˆ - æª¢æŸ¥äº† ${total_locations} å€‹ä½ç½®ï¼Œå›æ”¶æ•ˆç‡: ${recycling_efficiency}%"
          level: "info"
          tags: ["completion", "manual_recycling", "summary"]
        description: "è¨˜éŒ„å®Œæˆè¨Šæ¯"

settings:
  log_level: "INFO"
  enable_checkpoint: true
  parallel_execution: false
  timeout: 360  # 6åˆ†é˜è¶…æ™‚
  retry_on_failure: true
  max_retries: 3
  # åŸ·è¡Œé »ç‡æ§åˆ¶ - æ¯8åˆ†é˜åŸ·è¡Œä¸€æ¬¡
  execution_interval: 480  # seconds
  last_execution: null
  # äººå·¥å›æ”¶ç‰¹å®šè¨­å®š
  manual_recycling_settings:
    max_concurrent_tasks: 2  # æœ€å¤šåŒæ™‚2å€‹å›æ”¶ä»»å‹™
    priority_level: 40  # å„ªå…ˆç´šæ°´å¹³
    efficiency_threshold: 70  # æ•ˆç‡è­¦å‘Šé–¾å€¼
    overflow_to_boxout: true  # ç©ºæ–™æ¶å€æ»¿æ™‚é€åˆ°å‡ºå£