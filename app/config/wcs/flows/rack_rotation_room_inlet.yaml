# Rack 旋轉流程 - 房間入口
# 檢查所有房間入口位置的 Rack 狀態

name: 房間入口 Rack 旋轉檢查
description: 檢查所有房間入口位置的 Rack，A 面完成且 B 面有 carrier 時生成旋轉任務
version: "1.0"
author: Flow Designer
enabled: true
priority: 100
work_id: "220001"

# 業務邏輯節點
nodes:
  # 1. 取得所有房間入口位置
  - id: get_room_inlet_locations
    type: condition
    name: 取得房間入口位置
    function: get_locations_by_type
    parameters:
      location_type: "room_inlet"
      rooms: [1, 2, 3, 4, 5]
      filter_has_rack: true
    outputs:
      locations: { type: "array", description: "房間入口位置列表" }
      no_locations: { type: "boolean", description: "無符合位置" }

  # 2. 檢查是否有進行中的旋轉任務
  - id: check_pending_tasks
    type: condition
    name: 檢查進行中任務
    function: check_pending_rotation_tasks
    parameters:
      task_type: "RACK_ROTATION"
      location_type: "room_inlet"
    inputs:
      location: { type: "object", description: "位置資訊" }
    outputs:
      has_pending: { type: "boolean", description: "有進行中任務" }
      no_pending: { type: "boolean", description: "無進行中任務" }
      location_data: { type: "object", description: "位置資料" }

  # 3. 檢查 Rack A 面是否完成
  - id: check_a_side_done
    type: condition
    name: 檢查 A 面完成狀態
    function: check_rack_side_status
    parameters:
      side: "A"
      check_type: "completion"
    inputs:
      location_data: { type: "object", description: "位置資料" }
    outputs:
      a_side_done: { type: "boolean", description: "A 面已完成" }
      a_side_not_done: { type: "boolean", description: "A 面未完成" }
      rack_info: { type: "object", description: "Rack 資訊" }

  # 4. 檢查 Rack B 面是否有 carrier
  - id: check_b_side_carrier
    type: condition
    name: 檢查 B 面 Carrier
    function: check_rack_side_carrier
    parameters:
      side: "B"
    inputs:
      rack_info: { type: "object", description: "Rack 資訊" }
    outputs:
      has_carrier: { type: "boolean", description: "B 面有 carrier" }
      no_carrier: { type: "boolean", description: "B 面無 carrier" }
      final_rack_info: { type: "object", description: "完整 Rack 資訊" }

  # 5. 生成旋轉任務
  - id: create_rotation_task
    type: action
    name: 生成入口旋轉任務
    function: create_rack_rotation_task
    parameters:
      task_type: "RACK_ROTATION"
      location_type: "room_inlet"
      rotation_angle: 180
      priority: "high"
      work_id: "220001"
    inputs:
      rack_info: { type: "object", description: "Rack 資訊" }
      location_data: { type: "object", description: "位置資料" }
    outputs:
      task_id: { type: "string", description: "任務 ID" }
      success: { type: "boolean", description: "創建成功" }

  # 6. 記錄結果
  - id: log_task_created
    type: logic
    name: 記錄任務創建
    function: log_task_creation
    parameters:
      log_type: "RACK_ROTATION_INLET"
    inputs:
      task_id: { type: "string", description: "任務 ID" }
      location_data: { type: "object", description: "位置資料" }

  # 7. 記錄跳過
  - id: log_skip
    type: logic
    name: 記錄跳過原因
    function: log_skip_reason
    parameters:
      log_type: "RACK_ROTATION_INLET_SKIP"
    inputs:
      reason: { type: "string", description: "跳過原因" }
      location_data: { type: "object", description: "位置資料" }

# 連線關係
connections:
  # 取得位置後檢查每個位置
  - from: get_room_inlet_locations.locations
    to: check_pending_tasks.location
    
  # 無進行中任務時檢查 A 面
  - from: check_pending_tasks.no_pending
    to: check_a_side_done.location_data
    
  # 傳遞位置資料
  - from: check_pending_tasks.location_data
    to: check_a_side_done.location_data
    
  # A 面完成時檢查 B 面
  - from: check_a_side_done.a_side_done
    to: check_b_side_carrier.rack_info
    
  # 傳遞 Rack 資訊
  - from: check_a_side_done.rack_info
    to: check_b_side_carrier.rack_info
    
  # B 面有 carrier 時創建任務
  - from: check_b_side_carrier.has_carrier
    to: create_rotation_task.rack_info
    
  # 傳遞完整資訊到任務創建
  - from: check_b_side_carrier.final_rack_info
    to: create_rotation_task.rack_info
    
  - from: check_pending_tasks.location_data
    to: create_rotation_task.location_data
    
  # 任務創建成功後記錄
  - from: create_rotation_task.task_id
    to: log_task_created.task_id
    
  - from: check_pending_tasks.location_data
    to: log_task_created.location_data
    
  # 各種跳過情況的記錄
  - from: check_pending_tasks.has_pending
    to: log_skip.reason
    
  - from: check_a_side_done.a_side_not_done
    to: log_skip.reason
    
  - from: check_b_side_carrier.no_carrier
    to: log_skip.reason

# Flow Designer 視覺化資料
flow_designer_data:
  nodes:
    - id: get_room_inlet_locations
      position: { x: 100, y: 200 }
      data:
        name: 取得房間入口位置
        type: condition
        function: get_locations_by_type
        parameters:
          location_type: "room_inlet"
          rooms: [1, 2, 3, 4, 5]
          filter_has_rack: true
      inputs: []
      outputs:
        - key: locations
        - key: no_locations
        
    - id: check_pending_tasks
      position: { x: 300, y: 200 }
      data:
        name: 檢查進行中任務
        type: condition
        function: check_pending_rotation_tasks
        parameters:
          task_type: "RACK_ROTATION"
          location_type: "room_inlet"
      inputs:
        - key: location
      outputs:
        - key: has_pending
        - key: no_pending
        - key: location_data
        
    - id: check_a_side_done
      position: { x: 500, y: 200 }
      data:
        name: 檢查 A 面完成狀態
        type: condition
        function: check_rack_side_status
        parameters:
          side: "A"
          check_type: "completion"
      inputs:
        - key: location_data
      outputs:
        - key: a_side_done
        - key: a_side_not_done
        - key: rack_info
        
    - id: check_b_side_carrier
      position: { x: 700, y: 200 }
      data:
        name: 檢查 B 面 Carrier
        type: condition
        function: check_rack_side_carrier
        parameters:
          side: "B"
      inputs:
        - key: rack_info
      outputs:
        - key: has_carrier
        - key: no_carrier
        - key: final_rack_info
        
    - id: create_rotation_task
      position: { x: 900, y: 200 }
      data:
        name: 生成入口旋轉任務
        type: action
        function: create_rack_rotation_task
        parameters:
          task_type: "RACK_ROTATION"
          location_type: "room_inlet"
          rotation_angle: 180
          priority: "high"
          work_id: "220001"
      inputs:
        - key: rack_info
        - key: location_data
      outputs:
        - key: task_id
        - key: success
        
    - id: log_task_created
      position: { x: 1100, y: 200 }
      data:
        name: 記錄任務創建
        type: logic
        function: log_task_creation
        parameters:
          log_type: "RACK_ROTATION_INLET"
      inputs:
        - key: task_id
        - key: location_data
      outputs: []
      
    - id: log_skip
      position: { x: 700, y: 400 }
      data:
        name: 記錄跳過原因
        type: logic
        function: log_skip_reason
        parameters:
          log_type: "RACK_ROTATION_INLET_SKIP"
      inputs:
        - key: reason
        - key: location_data
      outputs: []
      
  connections:
    - id: conn_1
      source: get_room_inlet_locations
      sourceOutput: locations
      target: check_pending_tasks
      targetInput: location
      
    - id: conn_2
      source: check_pending_tasks
      sourceOutput: no_pending
      target: check_a_side_done
      targetInput: location_data
      
    - id: conn_3
      source: check_pending_tasks
      sourceOutput: location_data
      target: check_a_side_done
      targetInput: location_data
      
    - id: conn_4
      source: check_a_side_done
      sourceOutput: a_side_done
      target: check_b_side_carrier
      targetInput: rack_info
      
    - id: conn_5
      source: check_a_side_done
      sourceOutput: rack_info
      target: check_b_side_carrier
      targetInput: rack_info
      
    - id: conn_6
      source: check_b_side_carrier
      sourceOutput: has_carrier
      target: create_rotation_task
      targetInput: rack_info
      
    - id: conn_7
      source: check_b_side_carrier
      sourceOutput: final_rack_info
      target: create_rotation_task
      targetInput: rack_info
      
    - id: conn_8
      source: check_pending_tasks
      sourceOutput: location_data
      target: create_rotation_task
      targetInput: location_data
      
    - id: conn_9
      source: create_rotation_task
      sourceOutput: task_id
      target: log_task_created
      targetInput: task_id
      
    - id: conn_10
      source: check_pending_tasks
      sourceOutput: location_data
      target: log_task_created
      targetInput: location_data
      
    - id: conn_11
      source: check_pending_tasks
      sourceOutput: has_pending
      target: log_skip
      targetInput: reason
      
    - id: conn_12
      source: check_a_side_done
      sourceOutput: a_side_not_done
      target: log_skip
      targetInput: reason
      
    - id: conn_13
      source: check_b_side_carrier
      sourceOutput: no_carrier
      target: log_skip
      targetInput: reason