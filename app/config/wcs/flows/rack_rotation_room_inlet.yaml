meta:
  system: linear_flow_v2
  version: "2.0.0"
  author: "Flow WCS System"
  created_at: "2025-08-14"
  description: "æˆ¿é–“å…¥å£æ¶å°ç¿»è½‰æµç¨‹ - Aé¢ç‚ºç©ºï¼ˆè¼‰å…·å·²å–èµ°ï¼‰ã€Bé¢å¾…ä½œæ¥­æ™‚ç¿»è½‰æ¶å°"

flow:
  id: "rack_rotation_room_inlet"
  name: "æˆ¿é–“å…¥å£æ¶å°ç¿»è½‰"
  work_id: "220001"  # å…¥å£ç¿»è½‰å°ˆç”¨ work_id
  enabled: true
  priority: 100

workflow:
  - section: "æŸ¥è©¢å…¥å£æ¶å°ç‹€æ…‹"
    description: "æŸ¥è©¢æ‰€æœ‰æˆ¿é–“å…¥å£ä½ç½®çš„æ¶å°ï¼Œæ‰¾å‡ºéœ€è¦ç¿»è½‰çš„æ¶å°"
    steps:
      - id: "query_inlet_locations"
        exec: "query.locations"
        params:
          type: "room_inlet"
          rooms: [1, 2, 3, 4, 5]
        store: "inlet_locations"
        description: "æŸ¥è©¢æ‰€æœ‰æˆ¿é–“å…¥å£ä½ç½®"

      - id: "check_has_locations"
        exec: "check.empty"
        params:
          data: "${inlet_locations}"
        store: "no_locations"
        description: "æª¢æŸ¥æ˜¯å¦æœ‰å…¥å£ä½ç½®"

      - id: "stop_if_no_locations"
        exec: "control.stop_flow"
        params:
          reason: "æ²’æœ‰æ‰¾åˆ°æˆ¿é–“å…¥å£ä½ç½®"
        skip_if: "!${no_locations}"
        description: "å¦‚æœæ²’æœ‰å…¥å£ä½ç½®å‰‡åœæ­¢æµç¨‹"

  - section: "æª¢æŸ¥æ¯å€‹å…¥å£çš„æ¶å°"
    description: "éæ­·æ¯å€‹å…¥å£ä½ç½®ï¼Œæª¢æŸ¥æ˜¯å¦æœ‰éœ€è¦ç¿»è½‰çš„æ¶å°"
    steps:
      - id: "foreach_inlet_locations"
        exec: "foreach"
        params:
          items: "${inlet_locations}"
          var: "location"
          steps:
            - id: "query_racks_at_location"
              exec: "query.racks"
              params:
                location_id: "${location.id}"
                status: "available"
              store: "racks_at_location"
              description: "æŸ¥è©¢è©²ä½ç½®çš„æ¶å°"

            - id: "check_has_racks"
              exec: "check.empty"
              params:
                data: "${racks_at_location}"
              store: "no_racks"
              description: "æª¢æŸ¥æ˜¯å¦æœ‰æ¶å°"

            - id: "log_location_status"
              exec: "action.log_message"
              params:
                message: "ä½ç½® ${location.name} (ID: ${location.id}) - æ¶å°æ•¸é‡: ${racks_at_location.length}"
                level: "info"
                tags: ["location_check", "inlet"]
              skip_if: "${no_racks}"
              description: "è¨˜éŒ„ä½ç½®ç‹€æ…‹"

            - id: "check_rack_needs_rotation"
              exec: "check.rack_status"
              params:
                rack_id: "${racks_at_location[0].id}"
                side: "b"
                check_type: "has_work"
              store: "b_side_has_work"
              skip_if: "${no_racks}"
              description: "æª¢æŸ¥Bé¢æ˜¯å¦æœ‰å¾…ä½œæ¥­è¼‰å…·"

            - id: "check_a_side_empty"
              exec: "check.rack_status"
              params:
                rack_id: "${racks_at_location[0].id}"
                side: "a"
                check_type: "empty"
              store: "a_side_empty"
              skip_if: "${no_racks} || !${b_side_has_work}"
              description: "æª¢æŸ¥Aé¢æ˜¯å¦ç‚ºç©ºï¼ˆè¼‰å…·éƒ½è¢«å–èµ°ï¼‰"

            - id: "check_existing_task"
              exec: "check.task_exists"
              params:
                type: "RACK_ROTATION"
                location_id: "${location.id}"
                rack_id: "${racks_at_location[0].id}"
              store: "task_exists"
              skip_if: "${no_racks} || !${b_side_has_work} || !${a_side_empty}"
              description: "æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨æœªå®Œæˆçš„ç¿»è½‰ä»»å‹™"

            - id: "create_rotation_task"
              exec: "task.create_task"
              params:
                type: "RACK_ROTATION"
                work_id: "220001"
                location_id: "${location.id}"
                rack_id: "${racks_at_location[0].id}"
                room_id: "${location.room_id}"  # æ·»åŠ æˆ¿é–“ID - æ¨™è­˜ä»»å‹™å±¬æ–¼å“ªå€‹æˆ¿é–“
                priority: "high"
                metadata:
                  rack_name: "${racks_at_location[0].rack_id}"
                  location_name: "${location.name}"
                  room_id: "${location.room_id}"  # ä¹Ÿåœ¨ metadata ä¸­åŒ…å« room_id
                  rotation_angle: 180
                  reason: "Aé¢ç‚ºç©ºï¼ˆè¼‰å…·å·²å–èµ°ï¼‰ï¼ŒBé¢å¾…ä½œæ¥­"
                  model: "KUKA400i"
                  # nodes: [èµ·é», è½‰å‘é», çµ‚é»] - èµ·é»å’Œçµ‚é»ç›¸åŒï¼ˆå…¥å£ä½ç½®ï¼‰ï¼Œè½‰å‘é»æ˜¯ node_id + 1
                  nodes: ["${location.node_id}", "${location.node_id + 1}", "${location.node_id}"]
              store: "task_id"
              skip_if: "${no_racks} || !${b_side_has_work} || !${a_side_empty} || ${task_exists}"
              description: "å‰µå»ºæ¶å°ç¿»è½‰ä»»å‹™"

            - id: "log_task_created"
              exec: "action.log_message"
              params:
                message: "âœ… å‰µå»ºç¿»è½‰ä»»å‹™ - æ¶å°: ${racks_at_location[0].name}, ä»»å‹™ID: ${task_id}"
                level: "info"
                tags: ["task_created", "rotation"]
              skip_if: "${no_racks} || !${b_side_has_work} || !${a_side_empty} || ${task_exists}"
              description: "è¨˜éŒ„ä»»å‹™å‰µå»º"

  - section: "ç¸½çµ"
    description: "æµç¨‹åŸ·è¡Œç¸½çµ"
    steps:
      - id: "count_processed_locations"
        exec: "control.count_items"
        params:
          variable: "${inlet_locations}"
        store: "total_locations"
        description: "è¨ˆç®—è™•ç†çš„ä½ç½®æ•¸é‡"

      - id: "log_completion"
        exec: "action.log_message"
        params:
          message: "ğŸ æˆ¿é–“å…¥å£æ¶å°ç¿»è½‰æµç¨‹å®Œæˆ - æª¢æŸ¥äº† ${total_locations} å€‹å…¥å£ä½ç½®"
          level: "info"
          tags: ["completion", "summary", "rack_rotation"]
        description: "è¨˜éŒ„å®Œæˆè¨Šæ¯"

settings:
  log_level: "INFO"
  enable_checkpoint: true
  parallel_execution: false
  timeout: 120
  retry_on_failure: true
  max_retries: 3
  # åŸ·è¡Œé »ç‡æ§åˆ¶ - æ¯5åˆ†é˜åŸ·è¡Œä¸€æ¬¡
  execution_interval: 300  # seconds
  last_execution: null