meta:
  system: linear_flow_v2
  version: "2.0.0"
  author: "Flow WCS System"
  created_at: "2025-08-19"
  description: "ç³»çµ±æº–å‚™å€åˆ°æˆ¿é–“æµç¨‹ - å°‡ç³»çµ±æº–å‚™å€çš„æ¶å°æ¬é‹åˆ°éœ€è¦çš„æˆ¿é–“å…¥å£"

flow:
  id: "system_to_room_transfer"
  name: "ç³»çµ±æº–å‚™å€åˆ°æˆ¿é–“"
  work_id: "220006"  # ç³»çµ±æº–å‚™å€æ¬é‹å°ˆç”¨ work_id
  enabled: true
  priority: 60  # ä¸­ç­‰å„ªå…ˆç´š

workflow:
  - section: "æŸ¥è©¢ç³»çµ±æº–å‚™å€æ¶å°"
    description: "æŸ¥è©¢ç³»çµ±æº–å‚™å€ (61-65) çš„å¯ç”¨æ¶å°"
    steps:
      - id: "query_system_prepare_locations"
        exec: "query.locations"
        params:
          type: "system_prepare_area"
          rooms: [61, 62, 63, 64, 65]  # ç³»çµ±æº–å‚™å€ä½ç½®
          has_rack: true  # æŸ¥è©¢æœ‰æ¶å°çš„ä½ç½®
        store: "system_locations_with_rack"
        description: "æŸ¥è©¢ç³»çµ±æº–å‚™å€æœ‰æ¶å°çš„ä½ç½®"

      - id: "check_has_system_racks"
        exec: "check.empty"
        params:
          data: "${system_locations_with_rack}"
        store: "no_system_racks"
        description: "æª¢æŸ¥æ˜¯å¦æœ‰æ¶å°åœ¨ç³»çµ±æº–å‚™å€"

      - id: "stop_if_no_system_racks"
        exec: "control.stop_flow"
        params:
          reason: "ç³»çµ±æº–å‚™å€æ²’æœ‰æ¶å°å¯æ¬é‹"
        skip_if: "!${no_system_racks}"
        description: "å¦‚æœæ²’æœ‰æ¶å°å‰‡åœæ­¢æµç¨‹"

      - id: "log_system_area_status"
        exec: "action.log_message"
        params:
          message: "ğŸ“¦ ç³»çµ±æº–å‚™å€æœ‰ ${system_locations_with_rack.length} å€‹æ¶å°å¾…åˆ†é…"
          level: "info"
          tags: ["system_prepare_area", "rack_count"]
        skip_if: "${no_system_racks}"
        description: "è¨˜éŒ„ç³»çµ±æº–å‚™å€æ¶å°æ•¸é‡"

  - section: "æŸ¥è©¢æˆ¿é–“å…¥å£éœ€æ±‚"
    description: "æŸ¥è©¢å„æˆ¿é–“å…¥å£æ˜¯å¦éœ€è¦æ¶å°"
    steps:
      - id: "query_room_inlet_locations"
        exec: "query.locations"
        params:
          type: "room_inlet"
          rooms: [1, 2, 3, 4, 5]  # æ‰€æœ‰æˆ¿é–“
          has_rack: false  # æŸ¥è©¢æ²’æœ‰æ¶å°çš„ä½ç½®ï¼ˆç©ºä½ï¼‰
        store: "empty_inlet_locations"
        skip_if: "${no_system_racks}"
        description: "æŸ¥è©¢æˆ¿é–“å…¥å£ç©ºä½"

      - id: "check_has_empty_inlets"
        exec: "check.empty"
        params:
          data: "${empty_inlet_locations}"
        store: "no_empty_inlets"
        skip_if: "${no_system_racks}"
        description: "æª¢æŸ¥æ˜¯å¦æœ‰ç©ºçš„å…¥å£ä½ç½®"

      - id: "stop_if_no_empty_inlets"
        exec: "control.stop_flow"
        params:
          reason: "æ‰€æœ‰æˆ¿é–“å…¥å£éƒ½å·²æœ‰æ¶å°ï¼Œä¸éœ€è¦è£œå……"
        skip_if: "!${no_empty_inlets} || ${no_system_racks}"
        description: "å¦‚æœæ²’æœ‰ç©ºä½å‰‡åœæ­¢æµç¨‹"

      - id: "log_inlet_demand"
        exec: "action.log_message"
        params:
          message: "ğŸšª ç™¼ç¾ ${empty_inlet_locations.length} å€‹æˆ¿é–“å…¥å£éœ€è¦æ¶å°"
          level: "info"
          tags: ["room_inlet", "demand"]
        skip_if: "${no_empty_inlets} || ${no_system_racks}"
        description: "è¨˜éŒ„å…¥å£éœ€æ±‚"

  - section: "åŒ¹é…æ¶å°èˆ‡æˆ¿é–“éœ€æ±‚"
    description: "æ ¹æ“šå„ªå…ˆç´šå°‡ç³»çµ±æº–å‚™å€çš„æ¶å°åˆ†é…åˆ°éœ€è¦çš„æˆ¿é–“"
    steps:
      - id: "foreach_empty_inlets"
        exec: "foreach"
        params:
          items: "${empty_inlet_locations}"
          var: "inlet"
          steps:
            - id: "check_room_priority"
              exec: "query.rooms"
              params:
                room_id: "${inlet.room_id}"
              store: "room_info"
              description: "æŸ¥è©¢æˆ¿é–“è³‡è¨Š"

            - id: "check_room_active"
              exec: "check.empty"
              params:
                data: "${room_info}"
              store: "no_room_info"
              description: "æª¢æŸ¥æˆ¿é–“è³‡è¨Šæ˜¯å¦å­˜åœ¨"

            - id: "calculate_room_urgency"
              exec: "control.switch"
              params:
                value: "${room_info[0].production_status || 'normal'}"
                cases:
                  "urgent": 100     # ç·Šæ€¥ç”Ÿç”¢
                  "high": 80        # é«˜å„ªå…ˆç´š
                  "normal": 50      # æ­£å¸¸
                  "low": 30         # ä½å„ªå…ˆç´š
                default: 50
              store: "room_urgency"
              skip_if: "${no_room_info}"
              description: "è¨ˆç®—æˆ¿é–“ç·Šæ€¥ç¨‹åº¦"

            - id: "check_available_system_racks"
              exec: "check.empty"
              params:
                data: "${system_locations_with_rack}"
              store: "no_more_racks"
              skip_if: "${no_room_info}"
              description: "æª¢æŸ¥æ˜¯å¦é‚„æœ‰å¯ç”¨æ¶å°"

            - id: "stop_if_no_racks"
              exec: "control.stop_flow"
              params:
                reason: "ç³»çµ±æº–å‚™å€æ¶å°å·²å…¨éƒ¨åˆ†é…å®Œç•¢"
              skip_if: "!${no_more_racks} || ${no_room_info}"
              description: "å¦‚æœæ²’æœ‰æ¶å°å‰‡åœæ­¢"

            - id: "get_system_rack"
              exec: "query.racks"
              params:
                location_id: "${system_locations_with_rack[0].id}"
                status: "available"
              store: "available_rack"
              skip_if: "${no_more_racks} || ${no_room_info}"
              description: "ç²å–ç³»çµ±æº–å‚™å€çš„æ¶å°"

            - id: "check_rack_exists"
              exec: "check.empty"
              params:
                data: "${available_rack}"
              store: "no_rack"
              skip_if: "${no_more_racks} || ${no_room_info}"
              description: "æª¢æŸ¥æ¶å°æ˜¯å¦å­˜åœ¨"

            - id: "log_allocation"
              exec: "action.log_message"
              params:
                message: "ğŸ¯ åˆ†é…æ¶å° ${available_rack[0].rack_id} å¾ç³»çµ±æº–å‚™å€åˆ°æˆ¿é–“ ${inlet.room_id} å…¥å£"
                level: "info"
                tags: ["rack_allocation", "room_${inlet.room_id}"]
              skip_if: "${no_more_racks} || ${no_room_info} || ${no_rack}"
              description: "è¨˜éŒ„æ¶å°åˆ†é…"

            - id: "check_existing_transfer_task"
              exec: "check.task_exists"
              params:
                type: "SYSTEM_TO_ROOM_TRANSFER"
                rack_id: "${available_rack[0].id}"
                status: ["pending", "in_progress"]
              store: "transfer_task_exists"
              skip_if: "${no_more_racks} || ${no_room_info} || ${no_rack}"
              description: "æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨æ¬é‹ä»»å‹™"

            - id: "create_transfer_task"
              exec: "task.create_task"
              params:
                type: "SYSTEM_TO_ROOM_TRANSFER"
                work_id: "220006"  # ç³»çµ±æº–å‚™å€æ¬é‹ work_id
                source_location_id: "${system_locations_with_rack[0].id}"
                target_location_id: "${inlet.id}"
                rack_id: "${available_rack[0].id}"
                room_id: "${inlet.room_id}"
                priority: "${room_urgency}"  # æ ¹æ“šæˆ¿é–“ç·Šæ€¥ç¨‹åº¦è¨­å®šå„ªå…ˆç´š
                metadata:
                  rack_name: "${available_rack[0].rack_id}"
                  source_location: "${system_locations_with_rack[0].name}"
                  target_location: "${inlet.name}"
                  room_id: "${inlet.room_id}"
                  room_status: "${room_info[0].production_status || 'normal'}"
                  transport_reason: "è£œå……æˆ¿é–“å…¥å£æ¶å°"
                  model: "Cargo"  # Cargo AGV è² è²¬æ¬é‹
                  # è·¯å¾‘è¦åŠƒï¼šå¾ç³»çµ±æº–å‚™å€åˆ°æˆ¿é–“å…¥å£
                  nodes: ["${system_locations_with_rack[0].node_id}", "${inlet.node_id}"]
              store: "transfer_task_id"
              skip_if: "${no_more_racks} || ${no_room_info} || ${no_rack} || ${transfer_task_exists}"
              description: "å‰µå»ºæ¬é‹ä»»å‹™"

            - id: "log_task_created"
              exec: "action.log_message"
              params:
                message: "âœ… å‰µå»ºæ¬é‹ä»»å‹™ - æ¶å°: ${available_rack[0].rack_id}, åˆ°æˆ¿é–“ ${inlet.room_id} å…¥å£, ä»»å‹™ID: ${transfer_task_id}"
                level: "info"
                tags: ["task_created", "system_transfer", "room_${inlet.room_id}"]
              skip_if: "${no_more_racks} || ${no_room_info} || ${no_rack} || ${transfer_task_exists}"
              description: "è¨˜éŒ„ä»»å‹™å‰µå»º"

            - id: "update_available_racks"
              exec: "control.update_variable"
              params:
                variable: "system_locations_with_rack"
                operation: "remove_first"  # ç§»é™¤å·²åˆ†é…çš„æ¶å°ä½ç½®
                value: 1
              skip_if: "${no_more_racks} || ${no_room_info} || ${no_rack} || ${transfer_task_exists}"
              description: "æ›´æ–°å¯ç”¨æ¶å°åˆ—è¡¨"

        skip_if: "${no_empty_inlets} || ${no_system_racks}"
        description: "éæ­·æ‰€æœ‰éœ€è¦æ¶å°çš„å…¥å£"

  - section: "ç›£æ§ç³»çµ±æº–å‚™å€ç‹€æ…‹"
    description: "ç›£æ§ç³»çµ±æº–å‚™å€çš„ä½¿ç”¨æƒ…æ³"
    steps:
      - id: "query_all_system_racks"
        exec: "query.racks"
        params:
          location_id: [61, 62, 63, 64, 65]  # æ‰€æœ‰ç³»çµ±æº–å‚™å€
          status: "available"
        store: "all_system_racks"
        description: "æŸ¥è©¢æ‰€æœ‰ç³»çµ±æº–å‚™å€æ¶å°"

      - id: "count_system_racks"
        exec: "control.count_items"
        params:
          variable: "${all_system_racks}"
        store: "system_rack_count"
        description: "è¨ˆç®—ç³»çµ±æº–å‚™å€æ¶å°ç¸½æ•¸"

      - id: "calculate_utilization"
        exec: "control.update_variable"
        params:
          variable: "utilization_rate"
          operation: "set"
          value: "${system_rack_count * 100 / 5}"  # è¨ˆç®—ä½¿ç”¨ç‡
        store: "utilization_rate"
        description: "è¨ˆç®—ä½¿ç”¨ç‡"

      - id: "log_system_status"
        exec: "action.log_message"
        params:
          message: "ğŸ“Š ç³»çµ±æº–å‚™å€ç‹€æ…‹ - æ¶å°æ•¸: ${system_rack_count}/5 (${utilization_rate}%)"
          level: "info"
          tags: ["system_area_status", "monitoring"]
        description: "è¨˜éŒ„ç³»çµ±æº–å‚™å€ç‹€æ…‹"

      - id: "check_low_inventory"
        exec: "control.switch"
        params:
          value: "${system_rack_count}"
          cases:
            "0": true
            "1": true
          default: false
        store: "low_inventory"
        description: "æª¢æŸ¥åº«å­˜æ˜¯å¦éä½"

      - id: "send_low_inventory_alert"
        exec: "action.send_notification"
        params:
          message: "âš ï¸ ç³»çµ±æº–å‚™å€æ¶å°åº«å­˜ä½: ${system_rack_count}/5ï¼Œè«‹åŠæ™‚è£œå……"
          level: "warning"
          priority: "medium"
        skip_if: "!${low_inventory}"
        description: "ç™¼é€ä½åº«å­˜è­¦å‘Š"

  - section: "ç¸½çµ"
    description: "æµç¨‹åŸ·è¡Œç¸½çµ"
    steps:
      - id: "count_processed_inlets"
        exec: "control.count_items"
        params:
          variable: "${empty_inlet_locations}"
        store: "total_inlets"
        description: "è¨ˆç®—è™•ç†çš„å…¥å£æ•¸é‡"

      - id: "log_completion"
        exec: "action.log_message"
        params:
          message: "ğŸ ç³»çµ±æº–å‚™å€åˆ°æˆ¿é–“æµç¨‹å®Œæˆ - æª¢æŸ¥äº† ${total_inlets} å€‹å…¥å£éœ€æ±‚ï¼Œç³»çµ±æº–å‚™å€å‰©é¤˜: ${system_rack_count} å€‹æ¶å°"
          level: "info"
          tags: ["completion", "system_transfer", "summary"]
        description: "è¨˜éŒ„å®Œæˆè¨Šæ¯"

settings:
  log_level: "INFO"
  enable_checkpoint: true
  parallel_execution: false
  timeout: 300  # 5åˆ†é˜è¶…æ™‚
  retry_on_failure: true
  max_retries: 3
  # åŸ·è¡Œé »ç‡æ§åˆ¶ - æ¯5åˆ†é˜åŸ·è¡Œä¸€æ¬¡
  execution_interval: 300  # seconds
  last_execution: null
  # ç³»çµ±æº–å‚™å€ç‰¹å®šè¨­å®š
  system_area_settings:
    max_concurrent_tasks: 3  # æœ€å¤šåŒæ™‚3å€‹æ¬é‹ä»»å‹™
    priority_base: 60  # åŸºç¤å„ªå…ˆç´š
    system_area_capacity: 5  # ç³»çµ±æº–å‚™å€å®¹é‡
    low_inventory_threshold: 2  # ä½åº«å­˜è­¦å‘Šé–¾å€¼