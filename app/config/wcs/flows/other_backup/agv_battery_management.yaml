# AGV é›»æ± ç®¡ç†æµç¨‹
name: "AGVé›»æ± ç®¡ç†æµç¨‹"
description: "ç›£æ§ AGV é›»æ± ç‹€æ…‹ä¸¦è‡ªå‹•å®‰æ’å……é›»ä»»å‹™"
version: "1.0"
priority: 95
work_id: "300001"
enabled: true

# è®Šæ•¸å®šç¾©
variables:
  battery_low_threshold: 20      # ä½é›»é‡é–¾å€¼ (%)
  battery_critical_threshold: 10 # å±æ€¥é›»é‡é–¾å€¼ (%)
  charging_station_id: 1001      # å……é›»ç«™ä½ç½®ID
  max_charging_slots: 4          # å……é›»ç«™æœ€å¤§å®¹é‡

# æ•¸æ“šæµè…³æœ¬
script:
  # æ­¥é©Ÿ1: ç²å–æ‰€æœ‰ AGV ç‹€æ…‹
  - step: "get_all_agv_status"
    type: "condition_call"
    node_type: "condition"
    function: "check_all_agv_status"
    parameters:
      include_battery: true
      include_location: true
      include_task: true
    store_result: "all_agv_status"
    description: "ç²å–æ‰€æœ‰ AGV çš„å®Œæ•´ç‹€æ…‹è³‡è¨Š"

  # æ­¥é©Ÿ2: ç¯©é¸ä½é›»é‡ AGV
  - step: "filter_low_battery_agv"
    type: "logic_call"
    node_type: "logic"
    function: "filter_by_battery_level"
    parameters:
      agv_list: ${all_agv_status}
      threshold: ${battery_low_threshold}
      comparison: "less_than"
    store_result: "low_battery_agvs"
    condition: "${all_agv_status.length} > 0"
    description: "ç¯©é¸å‡ºé›»é‡ä½æ–¼é–¾å€¼çš„ AGV"

  # æ­¥é©Ÿ3: æª¢æŸ¥å……é›»ç«™å¯ç”¨æ€§
  - step: "check_charging_station"
    type: "condition_call"
    node_type: "condition"
    function: "check_location_capacity"
    parameters:
      location_id: ${charging_station_id}
      max_capacity: ${max_charging_slots}
    store_result: "charging_station_status"
    condition: "${low_battery_agvs.length} > 0"
    description: "æª¢æŸ¥å……é›»ç«™çš„å¯ç”¨å……é›»ä½"

  # æ­¥é©Ÿ4: è¨ˆç®—å……é›»å„ªå…ˆç´š
  - step: "calculate_charging_priority"
    type: "logic_call"
    node_type: "logic"
    function: "sort_by_multiple_criteria"
    parameters:
      items: ${low_battery_agvs}
      criteria:
        - field: "battery_level"
          order: "ascending"
          weight: 0.7
        - field: "distance_to_charging"
          order: "ascending"
          weight: 0.3
    store_result: "prioritized_agvs"
    condition: "${charging_station_status.available_slots} > 0"
    description: "æ ¹æ“šé›»é‡å’Œè·é›¢è¨ˆç®—å……é›»å„ªå…ˆç´š"

  # æ­¥é©Ÿ5: é¸æ“‡è¦å……é›»çš„ AGV
  - step: "select_agv_for_charging"
    type: "logic_call"
    node_type: "logic"
    function: "select_top_items"
    parameters:
      items: ${prioritized_agvs}
      count: ${charging_station_status.available_slots}
      min_count: 1
    store_result: "selected_agvs"
    condition: "${prioritized_agvs.length} > 0"
    description: "é¸æ“‡å„ªå…ˆç´šæœ€é«˜çš„ AGV é€²è¡Œå……é›»"

  # æ­¥é©Ÿ6: ç”Ÿæˆå……é›»è·¯å¾‘
  - step: "generate_charging_path"
    type: "logic_call"
    node_type: "logic"
    function: "calculate_optimal_path"
    parameters:
      from_location: ${selected_agvs[0].current_location}
      to_location: ${charging_station_id}
      agv_type: ${selected_agvs[0].type}
      avoid_congestion: true
    store_result: "charging_path"
    condition: "${selected_agvs.length} > 0"
    description: "è¨ˆç®—åˆ°å……é›»ç«™çš„æœ€å„ªè·¯å¾‘"

  # æ­¥é©Ÿ7: æª¢æŸ¥æ˜¯å¦éœ€è¦ä¸­æ–·ç•¶å‰ä»»å‹™
  - step: "check_task_interruption"
    type: "logic_call"
    node_type: "logic"
    function: "evaluate_task_interruption"
    parameters:
      agv_id: ${selected_agvs[0].id}
      current_task: ${selected_agvs[0].current_task}
      battery_level: ${selected_agvs[0].battery_level}
      critical_threshold: ${battery_critical_threshold}
    store_result: "interruption_decision"
    condition: "${selected_agvs[0].current_task} != null"
    description: "è©•ä¼°æ˜¯å¦éœ€è¦ä¸­æ–·ç•¶å‰ä»»å‹™"

  # æ­¥é©Ÿ8: å‰µå»ºå……é›»ä»»å‹™
  - step: "create_charging_task"
    type: "action_call"
    node_type: "action"
    function: "create_charging_task"
    parameters:
      agv_id: ${selected_agvs[0].id}
      charging_station_id: ${charging_station_id}
      path: ${charging_path}
      priority: ${interruption_decision.priority || 90}
      interrupt_current: ${interruption_decision.should_interrupt}
      estimated_charging_time: ${selected_agvs[0].estimated_charging_time}
    store_result: "charging_task"
    condition: "${charging_path} != null"
    description: "å‰µå»º AGV å……é›»ä»»å‹™"

  # æ­¥é©Ÿ9: æ›´æ–°å……é›»ç«™é ç´„
  - step: "update_charging_reservation"
    type: "action_call"
    node_type: "action"
    function: "reserve_charging_slot"
    parameters:
      charging_station_id: ${charging_station_id}
      agv_id: ${selected_agvs[0].id}
      task_id: ${charging_task.task_id}
      estimated_arrival: ${charging_task.estimated_arrival_time}
      estimated_duration: ${selected_agvs[0].estimated_charging_time}
    store_result: "reservation_result"
    condition: "${charging_task.success} == true"
    description: "é ç´„å……é›»ç«™ä½ç½®"

  # æ­¥é©Ÿ10: ç™¼é€é€šçŸ¥
  - step: "send_battery_notification"
    type: "action_call"
    node_type: "action"
    function: "send_system_notification"
    parameters:
      type: "battery_management"
      severity: ${selected_agvs[0].battery_level < battery_critical_threshold ? "critical" : "warning"}
      message: "AGV ${selected_agvs[0].id} é›»é‡ ${selected_agvs[0].battery_level}%ï¼Œå·²å®‰æ’å……é›»"
      task_id: ${charging_task.task_id}
      metadata:
        agv_id: ${selected_agvs[0].id}
        battery_level: ${selected_agvs[0].battery_level}
        charging_station: ${charging_station_id}
    condition: "${reservation_result.success} == true"
    description: "ç™¼é€é›»æ± ç®¡ç†é€šçŸ¥"

# é©ç”¨ç¯„åœ
scope:
  applicable_rooms: []  # é©ç”¨æ–¼æ‰€æœ‰æˆ¿é–“
  applicable_locations: []  # é©ç”¨æ–¼æ‰€æœ‰ä½ç½®

# èª¿è©¦é…ç½®
debug:
  enabled: true
  log_conditions: true
  log_variables: true
  dry_run: false

# Flow Designer è¦–è¦ºåŒ–æ•¸æ“š
flow_designer_data:
  version: "1.0"
  nodes:
    - id: "get_all_agv_status"
      type: "condition"
      data:
        name: "ç²å–AGVç‹€æ…‹"
        function: "check_all_agv_status"
        icon: "ğŸ¤–"
        category: "monitoring"
        outputs:
          - name: "all_agv_status"
            type: "array"
            schema: "AGVStatus[]"
      position: {x: 100, y: 100}

    - id: "filter_low_battery_agv"
      type: "logic"
      data:
        name: "ç¯©é¸ä½é›»é‡"
        function: "filter_by_battery_level"
        icon: "ğŸ”‹"
        category: "filtering"
        inputs:
          - name: "agv_list"
            type: "array"
            required: true
          - name: "threshold"
            type: "number"
            required: true
        outputs:
          - name: "low_battery_agvs"
            type: "array"
      position: {x: 300, y: 100}

    - id: "calculate_charging_priority"
      type: "logic"
      data:
        name: "è¨ˆç®—å„ªå…ˆç´š"
        function: "sort_by_multiple_criteria"
        icon: "ğŸ“Š"
        category: "sorting"
        inputs:
          - name: "items"
            type: "array"
          - name: "criteria"
            type: "object"
        outputs:
          - name: "prioritized_agvs"
            type: "array"
      position: {x: 500, y: 200}

    - id: "create_charging_task"
      type: "action"
      data:
        name: "å‰µå»ºå……é›»ä»»å‹™"
        function: "create_charging_task"
        icon: "âš¡"
        category: "task_creation"
        inputs:
          - name: "agv_id"
            type: "string"
          - name: "charging_station_id"
            type: "number"
          - name: "path"
            type: "object"
        outputs:
          - name: "charging_task"
            type: "object"
            schema: "Task"
      position: {x: 700, y: 300}

  connections:
    - from: "get_all_agv_status"
      from_output: "all_agv_status"
      to: "filter_low_battery_agv"
      to_input: "agv_list"
      
    - from: "filter_low_battery_agv"
      from_output: "low_battery_agvs"
      to: "calculate_charging_priority"
      to_input: "items"
      
    - from: "calculate_charging_priority"
      from_output: "prioritized_agvs"
      to: "create_charging_task"
      to_input: "agv_data"