# æ™ºèƒ½ä»»å‹™åˆ†é…æµç¨‹
name: "æ™ºèƒ½ä»»å‹™åˆ†é…æµç¨‹"
description: "æ ¹æ“šå¤šç¶­åº¦è©•åˆ†æ™ºèƒ½åˆ†é…ä»»å‹™çµ¦æœ€é©åˆçš„ AGV"
version: "1.0"
priority: 85
work_id: "400001"
enabled: true

# è®Šæ•¸å®šç¾©
variables:
  task_queue_limit: 10           # ä»»å‹™éšŠåˆ—ä¸Šé™
  agv_utilization_target: 0.8    # AGV ä½¿ç”¨ç‡ç›®æ¨™
  distance_weight: 0.3           # è·é›¢æ¬Šé‡
  battery_weight: 0.2            # é›»é‡æ¬Šé‡
  load_weight: 0.3               # è² è¼‰æ¬Šé‡
  skill_weight: 0.2             # æŠ€èƒ½åŒ¹é…æ¬Šé‡

# æ•¸æ“šæµè…³æœ¬
script:
  # æ­¥é©Ÿ1: ç²å–å¾…åˆ†é…ä»»å‹™
  - step: "get_pending_tasks"
    type: "condition_call"
    node_type: "condition"
    function: "check_pending_tasks"
    parameters:
      status: "pending"
      limit: ${task_queue_limit}
      order_by: "priority"
    store_result: "pending_tasks"
    description: "ç²å–å¾…åˆ†é…çš„ä»»å‹™åˆ—è¡¨"

  # æ­¥é©Ÿ2: ç²å–å¯ç”¨ AGV åˆ—è¡¨
  - step: "get_available_agvs"
    type: "condition_call"
    node_type: "condition"
    function: "check_agv_availability"
    parameters:
      status: ["idle", "working"]
      min_battery: 15
      exclude_maintenance: true
    store_result: "available_agvs"
    condition: "${pending_tasks.length} > 0"
    description: "ç²å–å¯ç”¨çš„ AGV åˆ—è¡¨"

  # æ­¥é©Ÿ3: åˆ†æä»»å‹™éœ€æ±‚
  - step: "analyze_task_requirements"
    type: "logic_call"
    node_type: "logic"
    function: "extract_task_requirements"
    parameters:
      task: ${pending_tasks[0]}
      analyze_path: true
      analyze_load: true
      analyze_skills: true
    store_result: "task_requirements"
    condition: "${available_agvs.length} > 0"
    description: "åˆ†æä»»å‹™çš„å…·é«”éœ€æ±‚"

  # æ­¥é©Ÿ4: è¨ˆç®— AGV è©•åˆ†çŸ©é™£
  - step: "calculate_agv_scores"
    type: "logic_call"
    node_type: "logic"
    function: "calculate_multi_factor_scores"
    parameters:
      agvs: ${available_agvs}
      task_requirements: ${task_requirements}
      scoring_factors:
        - factor: "distance"
          weight: ${distance_weight}
          calculation: "inverse_linear"
        - factor: "battery"
          weight: ${battery_weight}
          calculation: "linear"
        - factor: "current_load"
          weight: ${load_weight}
          calculation: "inverse_exponential"
        - factor: "skill_match"
          weight: ${skill_weight}
          calculation: "binary"
    store_result: "agv_scores"
    condition: "${task_requirements} != null"
    description: "è¨ˆç®—æ¯å€‹ AGV çš„ç¶œåˆè©•åˆ†"

  # æ­¥é©Ÿ5: é¸æ“‡æœ€ä½³ AGV
  - step: "select_best_agv"
    type: "logic_call"
    node_type: "logic"
    function: "select_by_highest_score"
    parameters:
      scored_items: ${agv_scores}
      min_score: 0.6
      tie_breaker: "lowest_utilization"
    store_result: "selected_agv"
    condition: "${agv_scores.length} > 0"
    description: "é¸æ“‡è©•åˆ†æœ€é«˜çš„ AGV"

  # æ­¥é©Ÿ6: é©—è­‰ AGV èƒ½åŠ›
  - step: "validate_agv_capability"
    type: "condition_call"
    node_type: "condition"
    function: "check_agv_task_compatibility"
    parameters:
      agv_id: ${selected_agv.id}
      task_type: ${task_requirements.type}
      required_payload: ${task_requirements.payload}
      required_range: ${task_requirements.estimated_distance}
    store_result: "capability_check"
    condition: "${selected_agv} != null"
    description: "é©—è­‰ AGV æ˜¯å¦çœŸçš„èƒ½åŸ·è¡Œæ­¤ä»»å‹™"

  # æ­¥é©Ÿ7: ç”Ÿæˆä»»å‹™åŸ·è¡Œè¨ˆåŠƒ
  - step: "generate_execution_plan"
    type: "logic_call"
    node_type: "logic"
    function: "create_task_execution_plan"
    parameters:
      agv: ${selected_agv}
      task: ${pending_tasks[0]}
      requirements: ${task_requirements}
      optimization_mode: "balanced"
    store_result: "execution_plan"
    condition: "${capability_check.compatible} == true"
    description: "ç”Ÿæˆè©³ç´°çš„ä»»å‹™åŸ·è¡Œè¨ˆåŠƒ"

  # æ­¥é©Ÿ8: é æ¸¬ä»»å‹™å®Œæˆæ™‚é–“
  - step: "predict_completion_time"
    type: "logic_call"
    node_type: "logic"
    function: "estimate_task_duration"
    parameters:
      execution_plan: ${execution_plan}
      agv_speed: ${selected_agv.average_speed}
      include_loading_time: true
      include_traffic_factor: true
      traffic_congestion_level: ${execution_plan.route_congestion}
    store_result: "time_estimation"
    condition: "${execution_plan} != null"
    description: "é æ¸¬ä»»å‹™å®Œæˆæ™‚é–“"

  # æ­¥é©Ÿ9: åˆ†é…ä»»å‹™çµ¦ AGV
  - step: "assign_task_to_agv"
    type: "action_call"
    node_type: "action"
    function: "assign_task"
    parameters:
      task_id: ${pending_tasks[0].id}
      agv_id: ${selected_agv.id}
      execution_plan: ${execution_plan}
      estimated_duration: ${time_estimation.total_minutes}
      assignment_reason: ${agv_scores[0].score_breakdown}
    store_result: "assignment_result"
    condition: "${time_estimation} != null"
    description: "æ­£å¼åˆ†é…ä»»å‹™çµ¦é¸å®šçš„ AGV"

  # æ­¥é©Ÿ10: æ›´æ–° AGV ç‹€æ…‹å’Œçµ±è¨ˆ
  - step: "update_agv_statistics"
    type: "action_call"
    node_type: "action"
    function: "update_agv_utilization"
    parameters:
      agv_id: ${selected_agv.id}
      new_task_id: ${assignment_result.task_id}
      estimated_duration: ${time_estimation.total_minutes}
      update_fields:
        - "utilization_rate"
        - "total_tasks_today"
        - "estimated_next_available"
    store_result: "statistics_update"
    condition: "${assignment_result.success} == true"
    description: "æ›´æ–° AGV ä½¿ç”¨çµ±è¨ˆè³‡æ–™"

  # æ­¥é©Ÿ11: å„ªåŒ–å‰©é¤˜ä»»å‹™éšŠåˆ—
  - step: "optimize_task_queue"
    type: "logic_call"
    node_type: "logic"
    function: "reorder_task_queue"
    parameters:
      remaining_tasks: ${pending_tasks.slice(1)}
      optimization_criteria:
        - "urgency"
        - "resource_availability"
        - "path_efficiency"
    store_result: "optimized_queue"
    condition: "${pending_tasks.length} > 1"
    description: "é‡æ–°å„ªåŒ–å‰©é¤˜ä»»å‹™çš„é †åº"

  # æ­¥é©Ÿ12: ç™¼å¸ƒä»»å‹™åˆ†é…äº‹ä»¶
  - step: "publish_assignment_event"
    type: "action_call"
    node_type: "action"
    function: "publish_event"
    parameters:
      event_type: "task_assigned"
      event_data:
        task_id: ${pending_tasks[0].id}
        agv_id: ${selected_agv.id}
        score: ${agv_scores[0].total_score}
        estimated_completion: ${time_estimation.estimated_completion_time}
        assignment_timestamp: ${Date.now()}
      publish_to:
        - "monitoring_system"
        - "agv_fleet_manager"
        - "task_scheduler"
    condition: "${assignment_result.success} == true"
    description: "ç™¼å¸ƒä»»å‹™åˆ†é…äº‹ä»¶é€šçŸ¥"

# é©ç”¨ç¯„åœ
scope:
  applicable_rooms: []  # é©ç”¨æ–¼æ‰€æœ‰æˆ¿é–“
  applicable_locations: []  # é©ç”¨æ–¼æ‰€æœ‰ä½ç½®

# èª¿è©¦é…ç½®
debug:
  enabled: true
  log_conditions: true
  log_variables: true
  dry_run: false

# Flow Designer è¦–è¦ºåŒ–æ•¸æ“š
flow_designer_data:
  version: "1.0"
  nodes:
    - id: "get_pending_tasks"
      type: "condition"
      data:
        name: "ç²å–å¾…åˆ†é…ä»»å‹™"
        function: "check_pending_tasks"
        icon: "ğŸ“‹"
        category: "data_source"
        outputs:
          - name: "pending_tasks"
            type: "array"
            schema: "Task[]"
      position: {x: 100, y: 100}

    - id: "calculate_agv_scores"
      type: "logic"
      data:
        name: "è¨ˆç®—AGVè©•åˆ†"
        function: "calculate_multi_factor_scores"
        icon: "ğŸ§®"
        category: "calculation"
        inputs:
          - name: "agvs"
            type: "array"
          - name: "task_requirements"
            type: "object"
          - name: "scoring_factors"
            type: "array"
        outputs:
          - name: "agv_scores"
            type: "array"
            schema: "ScoredAGV[]"
      position: {x: 400, y: 200}

    - id: "assign_task_to_agv"
      type: "action"
      data:
        name: "åˆ†é…ä»»å‹™"
        function: "assign_task"
        icon: "âœ…"
        category: "task_management"
        inputs:
          - name: "task_id"
            type: "string"
          - name: "agv_id"
            type: "string"
          - name: "execution_plan"
            type: "object"
        outputs:
          - name: "assignment_result"
            type: "object"
      position: {x: 700, y: 300}