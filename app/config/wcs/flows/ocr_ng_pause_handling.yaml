meta:
  system: linear_flow_v2
  version: "2.0.0"
  author: "Flow WCS System"
  created_at: "2025-08-19"
  description: "OCR NG æš«åœè™•ç†æµç¨‹ - è™•ç† OCR æª¢æ¸¬å¤±æ•—å°è‡´çš„ AGV æš«åœç‹€æ…‹"

flow:
  id: "ocr_ng_pause_handling"
  name: "OCR NG æš«åœè™•ç†"
  work_id: "220005"  # OCR NG è™•ç†å°ˆç”¨ work_id
  enabled: true
  priority: 95  # æ¥µé«˜å„ªå…ˆç´šï¼ˆOCR NG éœ€è¦ç«‹å³è™•ç†ï¼‰

workflow:
  - section: "æª¢æŸ¥æš«åœçš„ AGV"
    description: "æŸ¥è©¢å›  OCR NG è€Œæš«åœçš„ AGV"
    steps:
      - id: "query_paused_agvs"
        exec: "query.agvs"
        params:
          status: "paused"  # æš«åœç‹€æ…‹
          pause_reason: "ocr_ng"  # OCR NG åŸå› 
        store: "paused_agvs"
        description: "æŸ¥è©¢å›  OCR NG æš«åœçš„ AGV"

      - id: "check_has_paused_agvs"
        exec: "check.empty"
        params:
          data: "${paused_agvs}"
        store: "no_paused_agvs"
        description: "æª¢æŸ¥æ˜¯å¦æœ‰æš«åœçš„ AGV"

      - id: "stop_if_no_paused_agvs"
        exec: "control.stop_flow"
        params:
          reason: "æ²’æœ‰å›  OCR NG æš«åœçš„ AGV"
        skip_if: "!${no_paused_agvs}"
        description: "å¦‚æœæ²’æœ‰æš«åœçš„ AGV å‰‡åœæ­¢æµç¨‹"

      - id: "log_paused_agvs"
        exec: "action.log_message"
        params:
          message: "âš ï¸ ç™¼ç¾ ${paused_agvs.length} å° AGV å›  OCR NG æš«åœ"
          level: "warning"
          tags: ["ocr_ng", "agv_paused", "critical"]
        skip_if: "${no_paused_agvs}"
        description: "è¨˜éŒ„æš«åœçš„ AGV æ•¸é‡"

  - section: "è™•ç†æ¯å°æš«åœçš„ AGV"
    description: "éæ­·æ¯å°æš«åœçš„ AGVï¼Œé€²è¡Œç›¸æ‡‰è™•ç†"
    steps:
      - id: "foreach_paused_agvs"
        exec: "foreach"
        params:
          items: "${paused_agvs}"
          var: "agv"
          steps:
            - id: "get_agv_location"
              exec: "query.locations"
              params:
                agv_id: "${agv.id}"
                current: true  # ç•¶å‰ä½ç½®
              store: "agv_location"
              description: "ç²å– AGV ç•¶å‰ä½ç½®"

            - id: "check_location_exists"
              exec: "check.empty"
              params:
                data: "${agv_location}"
              store: "no_location"
              description: "æª¢æŸ¥ä½ç½®æ˜¯å¦å­˜åœ¨"

            - id: "query_rack_at_agv"
              exec: "query.racks"
              params:
                location_id: "${agv_location[0].id}"
                status: "ng"  # NG ç‹€æ…‹çš„æ¶å°
              store: "ng_rack"
              skip_if: "${no_location}"
              description: "æŸ¥è©¢ AGV ä½ç½®çš„ NG æ¶å°"

            - id: "check_has_ng_rack"
              exec: "check.empty"
              params:
                data: "${ng_rack}"
              store: "no_ng_rack"
              skip_if: "${no_location}"
              description: "æª¢æŸ¥æ˜¯å¦æœ‰ NG æ¶å°"

            - id: "log_ocr_ng_details"
              exec: "action.log_message"
              params:
                message: "ğŸ” OCR NG è©³æƒ… - AGV: ${agv.name}, ä½ç½®: ${agv_location[0].name}, æ¶å°: ${ng_rack[0].rack_id || 'N/A'}"
                level: "info"
                tags: ["ocr_ng_details", "agv_${agv.id}"]
              skip_if: "${no_location}"
              description: "è¨˜éŒ„ OCR NG è©³ç´°è³‡è¨Š"

            - id: "send_critical_notification"
              exec: "action.send_alarm"
              params:
                message: "ğŸš¨ OCR NG ç·Šæ€¥é€šçŸ¥ - AGV ${agv.name} åœ¨ ${agv_location[0].name} æš«åœï¼Œéœ€è¦äººå·¥ä»‹å…¥"
                severity: "critical"
              skip_if: "${no_location}"
              description: "ç™¼é€ç·Šæ€¥é€šçŸ¥"

            - id: "check_manual_override"
              exec: "check.task_exists"
              params:
                type: "MANUAL_OVERRIDE"
                agv_id: "${agv.id}"
                status: ["pending", "in_progress"]
              store: "manual_override_exists"
              skip_if: "${no_location}"
              description: "æª¢æŸ¥æ˜¯å¦å·²æœ‰äººå·¥ä»‹å…¥ä»»å‹™"

            - id: "create_manual_intervention_task"
              exec: "task.create_task"
              params:
                type: "MANUAL_INTERVENTION"
                work_id: "220005"  # OCR NG è™•ç† work_id
                agv_id: "${agv.id}"
                location_id: "${agv_location[0].id}"
                rack_id: "${ng_rack[0].id || null}"
                priority: "critical"  # æœ€é«˜å„ªå…ˆç´š
                metadata:
                  agv_name: "${agv.name}"
                  location_name: "${agv_location[0].name}"
                  rack_id: "${ng_rack[0].rack_id || 'N/A'}"
                  pause_time: "${agv.pause_time}"
                  ocr_failure_reason: "${agv.ocr_failure_reason || 'OCR æª¢æ¸¬å¤±æ•—'}"
                  required_action: "manual_ocr_verification"
                  estimated_time: 300  # é ä¼°è™•ç†æ™‚é–“ 5 åˆ†é˜
              store: "intervention_task_id"
              skip_if: "${no_location} || ${manual_override_exists}"
              description: "å‰µå»ºäººå·¥ä»‹å…¥ä»»å‹™"

            - id: "log_task_created"
              exec: "action.log_message"
              params:
                message: "ğŸ“‹ å‰µå»ºäººå·¥ä»‹å…¥ä»»å‹™ - AGV: ${agv.name}, ä»»å‹™ID: ${intervention_task_id}"
                level: "info"
                tags: ["task_created", "manual_intervention", "ocr_ng"]
              skip_if: "${no_location} || ${manual_override_exists}"
              description: "è¨˜éŒ„ä»»å‹™å‰µå»º"

            - id: "update_agv_status"
              exec: "action.trigger_event"
              params:
                event_type: "agv_manual_intervention_requested"
                agv_id: "${agv.id}"
                data:
                  task_id: "${intervention_task_id}"
                  location: "${agv_location[0].name}"
                  reason: "ocr_ng"
              skip_if: "${no_location} || ${manual_override_exists}"
              description: "è§¸ç™¼äººå·¥ä»‹å…¥äº‹ä»¶"

        skip_if: "${no_paused_agvs}"
        description: "éæ­·æ‰€æœ‰æš«åœçš„ AGV"

  - section: "ç›£æ§ OCR NG çµ±è¨ˆ"
    description: "çµ±è¨ˆå’Œç›£æ§ OCR NG ç™¼ç”Ÿé »ç‡"
    steps:
      - id: "query_recent_ocr_ng_tasks"
        exec: "query.tasks"
        params:
          type: "MANUAL_INTERVENTION"
          metadata_filter:
            required_action: "manual_ocr_verification"
          created_after: "-1h"  # éå»ä¸€å°æ™‚
        store: "recent_ocr_ng_tasks"
        description: "æŸ¥è©¢æœ€è¿‘ä¸€å°æ™‚çš„ OCR NG ä»»å‹™"

      - id: "count_recent_ocr_ng"
        exec: "control.count_items"
        params:
          variable: "${recent_ocr_ng_tasks}"
        store: "recent_ocr_ng_count"
        description: "è¨ˆç®—æœ€è¿‘ OCR NG æ•¸é‡"

      - id: "log_ocr_ng_stats"
        exec: "action.log_message"
        params:
          message: "ğŸ“Š OCR NG çµ±è¨ˆ - éå»ä¸€å°æ™‚: ${recent_ocr_ng_count} æ¬¡ï¼Œç•¶å‰æš«åœ: ${paused_agvs.length} å°"
          level: "info"
          tags: ["ocr_ng_stats", "monitoring"]
        description: "è¨˜éŒ„ OCR NG çµ±è¨ˆ"

      - id: "check_high_frequency"
        exec: "control.switch"
        params:
          value: "${recent_ocr_ng_count}"
          cases:
            "5": true   # 5æ¬¡ä»¥ä¸Š
            "6": true
            "7": true
            "8": true
            "9": true
            "10": true
          default: "${recent_ocr_ng_count > 10}"
        store: "high_ocr_ng_frequency"
        description: "æª¢æŸ¥ OCR NG é »ç‡æ˜¯å¦éé«˜"

      - id: "send_frequency_alert"
        exec: "action.send_notification"
        params:
          message: "âš ï¸ OCR NG é »ç‡ç•°å¸¸é«˜ - éå»ä¸€å°æ™‚ç™¼ç”Ÿ ${recent_ocr_ng_count} æ¬¡ï¼Œè«‹æª¢æŸ¥ OCR ç³»çµ±"
          level: "critical"
          priority: "high"
          recipients: ["system_admin", "quality_control"]
        skip_if: "!${high_ocr_ng_frequency}"
        description: "ç™¼é€é«˜é »ç‡è­¦å ±"

  - section: "è‡ªå‹•æ¢å¾©å˜—è©¦"
    description: "å˜—è©¦è‡ªå‹•æ¢å¾©éƒ¨åˆ†å¯æ¢å¾©çš„ OCR NG æƒ…æ³"
    steps:
      - id: "query_recoverable_agvs"
        exec: "query.agvs"
        params:
          status: "paused"
          pause_reason: "ocr_ng"
          pause_duration: ">300"  # æš«åœè¶…é 5 åˆ†é˜
        store: "recoverable_agvs"
        description: "æŸ¥è©¢å¯èƒ½å¯ä»¥æ¢å¾©çš„ AGV"

      - id: "check_has_recoverable"
        exec: "check.empty"
        params:
          data: "${recoverable_agvs}"
        store: "no_recoverable"
        description: "æª¢æŸ¥æ˜¯å¦æœ‰å¯æ¢å¾©çš„ AGV"

      - id: "foreach_recoverable_agvs"
        exec: "foreach"
        params:
          items: "${recoverable_agvs}"
          var: "agv"
          steps:
            - id: "check_manual_resolved"
              exec: "check.task_exists"
              params:
                type: "MANUAL_INTERVENTION"
                agv_id: "${agv.id}"
                status: "completed"
              store: "manual_resolved"
              description: "æª¢æŸ¥äººå·¥ä»‹å…¥æ˜¯å¦å·²å®Œæˆ"

            - id: "attempt_auto_recovery"
              exec: "action.trigger_event"
              params:
                event_type: "agv_recovery_attempt"
                agv_id: "${agv.id}"
                data:
                  recovery_type: "ocr_ng_timeout"
                  action: "resume_with_bypass"
              skip_if: "!${manual_resolved}"
              description: "å˜—è©¦è‡ªå‹•æ¢å¾©"

            - id: "log_recovery_attempt"
              exec: "action.log_message"
              params:
                message: "ğŸ”„ å˜—è©¦æ¢å¾© AGV ${agv.name} - äººå·¥ä»‹å…¥å·²å®Œæˆ"
                level: "info"
                tags: ["recovery_attempt", "ocr_ng", "agv_${agv.id}"]
              skip_if: "!${manual_resolved}"
              description: "è¨˜éŒ„æ¢å¾©å˜—è©¦"

        skip_if: "${no_recoverable}"
        description: "å˜—è©¦æ¢å¾©å¯æ¢å¾©çš„ AGV"

  - section: "ç¸½çµ"
    description: "æµç¨‹åŸ·è¡Œç¸½çµ"
    steps:
      - id: "count_total_processed"
        exec: "control.count_items"
        params:
          variable: "${paused_agvs}"
        store: "total_processed"
        description: "è¨ˆç®—è™•ç†çš„ AGV ç¸½æ•¸"

      - id: "log_completion"
        exec: "action.log_message"
        params:
          message: "ğŸ OCR NG æš«åœè™•ç†æµç¨‹å®Œæˆ - è™•ç†äº† ${total_processed} å°æš«åœçš„ AGVï¼ŒOCR NG é »ç‡: ${recent_ocr_ng_count}/å°æ™‚"
          level: "info"
          tags: ["completion", "ocr_ng_handling", "summary"]
        description: "è¨˜éŒ„å®Œæˆè¨Šæ¯"

settings:
  log_level: "INFO"
  enable_checkpoint: true
  parallel_execution: false
  timeout: 120  # 2åˆ†é˜è¶…æ™‚ï¼ˆç·Šæ€¥è™•ç†ï¼‰
  retry_on_failure: true
  max_retries: 3
  # åŸ·è¡Œé »ç‡æ§åˆ¶ - æ¯åˆ†é˜åŸ·è¡Œä¸€æ¬¡ï¼ˆé«˜é »æª¢æŸ¥ï¼‰
  execution_interval: 60  # seconds
  last_execution: null
  # OCR NG ç‰¹å®šè¨­å®š
  ocr_ng_settings:
    auto_recovery_timeout: 300  # 5åˆ†é˜å¾Œå˜—è©¦è‡ªå‹•æ¢å¾©
    high_frequency_threshold: 5  # æ¯å°æ™‚è¶…é5æ¬¡è¦–ç‚ºé«˜é »
    notification_cooldown: 600  # é€šçŸ¥å†·å»æ™‚é–“10åˆ†é˜
    critical_response_time: 60  # ç·Šæ€¥éŸ¿æ‡‰æ™‚é–“1åˆ†é˜