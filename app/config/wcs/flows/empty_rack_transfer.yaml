meta:
  system: linear_flow_v2
  version: "2.0.0"
  author: "Flow WCS System"
  created_at: "2025-08-19"
  description: "ç©ºæ–™æ¶æ¬é‹æµç¨‹ - å°‡æˆ¿é–“å‡ºå£çš„ç©ºæ–™æ¶æ¬é‹åˆ°ç©ºæ–™æ¶å€"

flow:
  id: "empty_rack_transfer"
  name: "ç©ºæ–™æ¶æ¬é‹"
  work_id: "220007"  # ç©ºæ–™æ¶æ¬é‹å°ˆç”¨ work_id
  enabled: true
  priority: 40  # ä½å„ªå…ˆç´š

workflow:
  - section: "æŸ¥è©¢æˆ¿é–“å‡ºå£ç©ºæ–™æ¶"
    description: "æŸ¥è©¢æ‰€æœ‰æˆ¿é–“å‡ºå£ä½ç½®çš„ç©ºæ–™æ¶"
    steps:
      - id: "query_outlet_locations"
        exec: "query.locations"
        params:
          type: "room_outlet"
          rooms: [1, 2, 3, 4, 5]  # æ‰€æœ‰æˆ¿é–“
          has_rack: true  # æœ‰æ¶å°çš„ä½ç½®
        store: "outlet_locations_with_rack"
        description: "æŸ¥è©¢æˆ¿é–“å‡ºå£æœ‰æ¶å°çš„ä½ç½®"

      - id: "check_has_outlet_racks"
        exec: "check.empty"
        params:
          data: "${outlet_locations_with_rack}"
        store: "no_outlet_racks"
        description: "æª¢æŸ¥æ˜¯å¦æœ‰å‡ºå£æ¶å°"

      - id: "stop_if_no_outlet_racks"
        exec: "control.stop_flow"
        params:
          reason: "æˆ¿é–“å‡ºå£æ²’æœ‰æ¶å°"
        skip_if: "!${no_outlet_racks}"
        description: "å¦‚æœæ²’æœ‰æ¶å°å‰‡åœæ­¢æµç¨‹"

      - id: "log_outlet_status"
        exec: "action.log_message"
        params:
          message: "ğŸ“¦ æª¢æŸ¥ ${outlet_locations_with_rack.length} å€‹æˆ¿é–“å‡ºå£ä½ç½®çš„æ¶å°ç‹€æ…‹"
          level: "info"
          tags: ["empty_rack", "outlet_check"]
        skip_if: "${no_outlet_racks}"
        description: "è¨˜éŒ„å‡ºå£ç‹€æ…‹"

  - section: "æŸ¥è©¢ç©ºæ–™æ¶å€ç©ºä½"
    description: "æŸ¥è©¢ç©ºæ–™æ¶å€ (41-45) çš„å¯ç”¨ç©ºä½"
    steps:
      - id: "query_empty_rack_area"
        exec: "query.locations"
        params:
          type: "empty_rack_area"
          rooms: [41, 42, 43, 44, 45]  # ç©ºæ–™æ¶å€ä½ç½®
          has_rack: false  # æŸ¥è©¢æ²’æœ‰æ¶å°çš„ä½ç½®ï¼ˆç©ºä½ï¼‰
        store: "available_empty_area_locations"
        skip_if: "${no_outlet_racks}"
        description: "æŸ¥è©¢ç©ºæ–™æ¶å€ç©ºä½"

      - id: "check_has_empty_area_space"
        exec: "check.empty"
        params:
          data: "${available_empty_area_locations}"
        store: "no_empty_area_space"
        skip_if: "${no_outlet_racks}"
        description: "æª¢æŸ¥æ˜¯å¦æœ‰ç©ºä½"

      - id: "stop_if_no_space"
        exec: "control.stop_flow"
        params:
          reason: "ç©ºæ–™æ¶å€å·²æ»¿ï¼Œæ²’æœ‰ç©ºä½"
        skip_if: "!${no_empty_area_space} || ${no_outlet_racks}"
        description: "å¦‚æœæ²’æœ‰ç©ºä½å‰‡åœæ­¢æµç¨‹"

      - id: "log_empty_area_availability"
        exec: "action.log_message"
        params:
          message: "ğŸ­ ç©ºæ–™æ¶å€æœ‰ ${available_empty_area_locations.length} å€‹ç©ºä½å¯ç”¨"
          level: "info"
          tags: ["empty_rack_area", "space_available"]
        skip_if: "${no_empty_area_space} || ${no_outlet_racks}"
        description: "è¨˜éŒ„ç©ºæ–™æ¶å€ç©ºä½"

  - section: "æª¢æŸ¥æ¯å€‹å‡ºå£çš„ç©ºæ–™æ¶"
    description: "éæ­·æ¯å€‹å‡ºå£ä½ç½®ï¼Œæª¢æŸ¥æ˜¯å¦æœ‰ç©ºæ–™æ¶éœ€è¦æ¬é‹"
    steps:
      - id: "foreach_outlet_locations"
        exec: "foreach"
        params:
          items: "${outlet_locations_with_rack}"
          var: "location"
          steps:
            - id: "query_racks_at_outlet"
              exec: "query.racks"
              params:
                location_id: "${location.id}"
                status: "available"
              store: "racks_at_location"
              description: "æŸ¥è©¢è©²ä½ç½®çš„æ¶å°"

            - id: "check_has_racks"
              exec: "check.empty"
              params:
                data: "${racks_at_location}"
              store: "no_racks"
              description: "æª¢æŸ¥æ˜¯å¦æœ‰æ¶å°"

            - id: "check_rack_empty"
              exec: "check.rack_status"
              params:
                rack_id: "${racks_at_location[0].id}"
                side: "both"  # æª¢æŸ¥å…©é¢
                check_type: "empty"  # æª¢æŸ¥æ˜¯å¦ç‚ºç©º
              store: "rack_is_empty"
              skip_if: "${no_racks}"
              description: "æª¢æŸ¥æ¶å°æ˜¯å¦ç‚ºç©º"

            - id: "log_empty_rack_found"
              exec: "action.log_message"
              params:
                message: "ğŸ“¤ ç™¼ç¾ç©ºæ–™æ¶ - ä½ç½®: ${location.name} (æˆ¿é–“ ${location.room_id}), æ¶å°: ${racks_at_location[0].rack_id}"
                level: "info"
                tags: ["empty_rack_found", "room_${location.room_id}"]
              skip_if: "${no_racks} || !${rack_is_empty}"
              description: "è¨˜éŒ„ç™¼ç¾ç©ºæ–™æ¶"

            - id: "check_remaining_space"
              exec: "check.empty"
              params:
                data: "${available_empty_area_locations}"
              store: "no_more_space"
              skip_if: "${no_racks} || !${rack_is_empty}"
              description: "æª¢æŸ¥æ˜¯å¦é‚„æœ‰ç©ºä½"

            - id: "log_no_space"
              exec: "action.log_message"
              params:
                message: "âš ï¸ ç©ºæ–™æ¶å€å·²æ»¿ï¼Œç„¡æ³•æ¬é‹æ›´å¤šç©ºæ–™æ¶"
                level: "warning"
                tags: ["empty_area_full", "space_limit"]
              skip_if: "${no_racks} || !${rack_is_empty} || !${no_more_space}"
              description: "è¨˜éŒ„ç©ºä½ä¸è¶³"

            - id: "get_target_location"
              exec: "control.update_variable"
              params:
                variable: "target_location_id"
                operation: "set"
                value: "${available_empty_area_locations[0].id}"
              skip_if: "${no_racks} || !${rack_is_empty} || ${no_more_space}"
              description: "ç²å–ç›®æ¨™ç©ºæ–™æ¶å€ä½ç½®"

            - id: "check_existing_empty_task"
              exec: "check.task_exists"
              params:
                type: "EMPTY_RACK_TRANSFER"
                rack_id: "${racks_at_location[0].id}"
                status: ["pending", "in_progress"]
              store: "empty_task_exists"
              skip_if: "${no_racks} || !${rack_is_empty} || ${no_more_space}"
              description: "æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨æ¬é‹ä»»å‹™"

            - id: "create_empty_rack_task"
              exec: "task.create_task"
              params:
                type: "EMPTY_RACK_TRANSFER"
                work_id: "220007"  # ç©ºæ–™æ¶æ¬é‹ work_id
                source_location_id: "${location.id}"
                target_location_id: "${target_location_id}"
                rack_id: "${racks_at_location[0].id}"
                room_id: "${location.room_id}"
                priority: "low"  # ä½å„ªå…ˆç´š
                metadata:
                  rack_name: "${racks_at_location[0].rack_id}"
                  source_location: "${location.name}"
                  target_location: "${available_empty_area_locations[0].name}"
                  room_id: "${location.room_id}"
                  transport_reason: "ç©ºæ–™æ¶å›æ”¶"
                  model: "Cargo"  # Cargo AGV è² è²¬æ¬é‹
                  # è·¯å¾‘è¦åŠƒï¼šå¾å‡ºå£åˆ°ç©ºæ–™æ¶å€
                  nodes: ["${location.node_id}", "${available_empty_area_locations[0].node_id}"]
              store: "empty_task_id"
              skip_if: "${no_racks} || !${rack_is_empty} || ${no_more_space} || ${empty_task_exists}"
              description: "å‰µå»ºç©ºæ–™æ¶æ¬é‹ä»»å‹™"

            - id: "log_task_created"
              exec: "action.log_message"
              params:
                message: "âœ… å‰µå»ºç©ºæ–™æ¶æ¬é‹ä»»å‹™ - æ¶å°: ${racks_at_location[0].rack_id}, å¾ ${location.name} åˆ° ${available_empty_area_locations[0].name}, ä»»å‹™ID: ${empty_task_id}"
                level: "info"
                tags: ["task_created", "empty_rack_transfer"]
              skip_if: "${no_racks} || !${rack_is_empty} || ${no_more_space} || ${empty_task_exists}"
              description: "è¨˜éŒ„ä»»å‹™å‰µå»º"

            - id: "update_available_locations"
              exec: "control.update_variable"
              params:
                variable: "available_empty_area_locations"
                operation: "remove_first"  # ç§»é™¤å·²ä½¿ç”¨çš„ä½ç½®
                value: 1
              skip_if: "${no_racks} || !${rack_is_empty} || ${no_more_space} || ${empty_task_exists}"
              description: "æ›´æ–°å¯ç”¨ä½ç½®åˆ—è¡¨"

        skip_if: "${no_outlet_racks} || ${no_empty_area_space}"
        description: "éæ­·æ‰€æœ‰å‡ºå£ä½ç½®æª¢æŸ¥ç©ºæ–™æ¶"

  - section: "ç›£æ§ç©ºæ–™æ¶å€ç‹€æ…‹"
    description: "ç›£æ§ç©ºæ–™æ¶å€çš„ä½¿ç”¨æƒ…æ³ä¸¦è§¸ç™¼æ¸…ç†"
    steps:
      - id: "query_empty_area_racks"
        exec: "query.racks"
        params:
          location_id: [41, 42, 43, 44, 45]  # ç©ºæ–™æ¶å€æ‰€æœ‰ä½ç½®
          status: "available"
        store: "empty_area_racks"
        description: "æŸ¥è©¢ç©ºæ–™æ¶å€çš„æ¶å°æ•¸é‡"

      - id: "count_empty_area_racks"
        exec: "control.count_items"
        params:
          variable: "${empty_area_racks}"
        store: "empty_area_rack_count"
        description: "è¨ˆç®—ç©ºæ–™æ¶å€æ¶å°æ•¸é‡"

      - id: "calculate_empty_area_usage"
        exec: "control.update_variable"
        params:
          variable: "empty_area_usage_rate"
          operation: "set"
          value: "${empty_area_rack_count * 100 / 5}"  # è¨ˆç®—ä½¿ç”¨ç‡ç™¾åˆ†æ¯”
        store: "empty_area_usage_rate"
        description: "è¨ˆç®—ä½¿ç”¨ç‡"

      - id: "log_empty_area_status"
        exec: "action.log_message"
        params:
          message: "ğŸ“Š ç©ºæ–™æ¶å€ç‹€æ…‹ - ä½¿ç”¨ç‡: ${empty_area_usage_rate}% (${empty_area_rack_count}/5)"
          level: "info"
          tags: ["empty_area_status", "monitoring"]
        description: "è¨˜éŒ„ç©ºæ–™æ¶å€ç‹€æ…‹"

      - id: "check_high_usage"
        exec: "control.switch"
        params:
          value: "${empty_area_rack_count}"
          cases:
            "4": true
            "5": true
          default: false
        store: "high_usage"
        description: "æª¢æŸ¥æ˜¯å¦é«˜ä½¿ç”¨ç‡"

      - id: "trigger_cleanup_notification"
        exec: "action.send_notification"
        params:
          message: "âš ï¸ ç©ºæ–™æ¶å€æ¥è¿‘æ»¿è¼‰: ${empty_area_usage_rate}% (${empty_area_rack_count}/5)ï¼Œè«‹å®‰æ’æ¸…ç†æˆ–ç§»å‡ºéƒ¨åˆ†ç©ºæ–™æ¶"
          level: "warning"
          priority: "medium"
        skip_if: "!${high_usage}"
        description: "è§¸ç™¼æ¸…ç†é€šçŸ¥"

  - section: "ç¸½çµ"
    description: "æµç¨‹åŸ·è¡Œç¸½çµ"
    steps:
      - id: "count_processed_outlets"
        exec: "control.count_items"
        params:
          variable: "${outlet_locations_with_rack}"
        store: "total_outlets"
        description: "è¨ˆç®—è™•ç†çš„å‡ºå£æ•¸é‡"

      - id: "log_completion"
        exec: "action.log_message"
        params:
          message: "ğŸ ç©ºæ–™æ¶æ¬é‹æµç¨‹å®Œæˆ - æª¢æŸ¥äº† ${total_outlets} å€‹å‡ºå£ä½ç½®ï¼Œç©ºæ–™æ¶å€ä½¿ç”¨ç‡: ${empty_area_usage_rate}%"
          level: "info"
          tags: ["completion", "empty_rack_transfer", "summary"]
        description: "è¨˜éŒ„å®Œæˆè¨Šæ¯"

settings:
  log_level: "INFO"
  enable_checkpoint: true
  parallel_execution: false
  timeout: 360  # 6åˆ†é˜è¶…æ™‚
  retry_on_failure: true
  max_retries: 3
  # åŸ·è¡Œé »ç‡æ§åˆ¶ - æ¯10åˆ†é˜åŸ·è¡Œä¸€æ¬¡ï¼ˆä½å„ªå…ˆç´šä»»å‹™ï¼‰
  execution_interval: 600  # seconds
  last_execution: null
  # ç©ºæ–™æ¶æ¬é‹ç‰¹å®šè¨­å®š
  empty_rack_settings:
    max_concurrent_tasks: 2  # æœ€å¤šåŒæ™‚2å€‹æ¬é‹ä»»å‹™
    priority_level: 40  # å„ªå…ˆç´šæ°´å¹³
    empty_area_capacity: 5  # ç©ºæ–™æ¶å€å®¹é‡
    high_usage_threshold: 4  # é«˜ä½¿ç”¨ç‡è­¦å‘Šé–¾å€¼