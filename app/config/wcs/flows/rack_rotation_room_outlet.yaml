meta:
  system: linear_flow_v2
  version: "2.0.0"
  author: "Flow WCS System"
  created_at: "2025-08-18"
  description: "æˆ¿é–“å‡ºå£æ¶å°ç¿»è½‰æµç¨‹ - Aé¢å·²æ»¿è¼‰ã€Bé¢é‚„æœ‰ç©ºä½å¯æ”¾ç½®è¼‰å…·æ™‚ç¿»è½‰æ¶å°"

flow:
  id: "rack_rotation_room_outlet"
  name: "æˆ¿é–“å‡ºå£æ¶å°ç¿»è½‰"
  work_id: "220001"  # çµ±ä¸€ä½¿ç”¨ 220001 (æ‰€æœ‰ KUKA ä»»å‹™å…±ç”¨)
  enabled: true
  priority: 100

workflow:
  - section: "æŸ¥è©¢å‡ºå£æ¶å°ç‹€æ…‹"
    description: "æŸ¥è©¢æ‰€æœ‰æˆ¿é–“å‡ºå£ä½ç½®çš„æ¶å°ï¼Œæ‰¾å‡ºéœ€è¦ç¿»è½‰çš„æ¶å°"
    steps:
      - id: "query_outlet_locations"
        exec: "query.locations"
        params:
          type: "room_outlet"
          rooms: [1, 2, 3, 4, 5]
        store: "outlet_locations"
        description: "æŸ¥è©¢æ‰€æœ‰æˆ¿é–“å‡ºå£ä½ç½®"

      - id: "check_has_locations"
        exec: "check.empty"
        params:
          data: "${outlet_locations}"
        store: "no_locations"
        description: "æª¢æŸ¥æ˜¯å¦æœ‰å‡ºå£ä½ç½®"

      - id: "stop_if_no_locations"
        exec: "control.stop_flow"
        params:
          reason: "æ²’æœ‰æ‰¾åˆ°æˆ¿é–“å‡ºå£ä½ç½®"
        skip_if: "!${no_locations}"
        description: "å¦‚æœæ²’æœ‰å‡ºå£ä½ç½®å‰‡åœæ­¢æµç¨‹"

  - section: "æª¢æŸ¥æ¯å€‹å‡ºå£çš„æ¶å°"
    description: "éæ­·æ¯å€‹å‡ºå£ä½ç½®ï¼Œæª¢æŸ¥æ˜¯å¦æœ‰éœ€è¦ç¿»è½‰çš„æ¶å°"
    steps:
      - id: "foreach_outlet_locations"
        exec: "foreach"
        params:
          items: "${outlet_locations}"
          var: "location"
          steps:
            - id: "query_racks_at_location"
              exec: "query.racks"
              params:
                location_id: "${location.id}"
                status: "available"
              store: "racks_at_location"
              description: "æŸ¥è©¢è©²ä½ç½®çš„æ¶å°"

            - id: "check_has_racks"
              exec: "check.empty"
              params:
                data: "${racks_at_location}"
              store: "no_racks"
              description: "æª¢æŸ¥æ˜¯å¦æœ‰æ¶å°"

            - id: "log_location_status"
              exec: "action.log_message"
              params:
                message: "ä½ç½® ${location.name} (ID: ${location.id}) - æ¶å°æ•¸é‡: ${racks_at_location.length}"
                level: "info"
                tags: ["location_check", "outlet"]
              skip_if: "${no_racks}"
              description: "è¨˜éŒ„ä½ç½®ç‹€æ…‹"

            - id: "check_a_side_full"
              exec: "check.rack_status"
              params:
                rack_id: "${racks_at_location[0].id}"
                side: "a"
                check_type: "full"
              store: "a_side_full"
              skip_if: "${no_racks}"
              description: "æª¢æŸ¥Aé¢æ˜¯å¦å·²æ»¿è¼‰"

            - id: "check_b_side_has_space"
              exec: "check.rack_status"
              params:
                rack_id: "${racks_at_location[0].id}"
                side: "b"
                check_type: "has_space"
              store: "b_side_has_space"
              skip_if: "${no_racks} || !${a_side_full}"
              description: "æª¢æŸ¥Bé¢æ˜¯å¦é‚„æœ‰ç©ºä½å¯æ”¾ç½®è¼‰å…·"

            - id: "check_existing_task"
              exec: "check.task_exists"
              params:
                type: "RACK_ROTATION"
                location_id: "${location.id}"
                rack_id: "${racks_at_location[0].id}"
              store: "task_exists"
              skip_if: "${no_racks} || !${a_side_full} || !${b_side_has_space}"
              description: "æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨æœªå®Œæˆçš„ç¿»è½‰ä»»å‹™"

            - id: "create_rotation_task"
              exec: "task.create_task"
              params:
                type: "RACK_ROTATION"
                work_id: "220001"  # ä½¿ç”¨çµ±ä¸€çš„ KUKA work_id
                location_id: "${location.id}"
                rack_id: "${racks_at_location[0].id}"
                room_id: "${location.room_id}"  # æ·»åŠ æˆ¿é–“ID - æ¨™è­˜ä»»å‹™å±¬æ–¼å“ªå€‹æˆ¿é–“
                priority: "high"
                metadata:
                  rack_name: "${racks_at_location[0].rack_id}"
                  location_name: "${location.name}"
                  room_id: "${location.room_id}"  # ä¹Ÿåœ¨ metadata ä¸­åŒ…å« room_id
                  rotation_angle: 180
                  reason: "Aé¢å·²æ»¿è¼‰ï¼ŒBé¢é‚„æœ‰ç©ºä½å¯æ”¾ç½®è¼‰å…·"
                  model: "KUKA400i"
                  # nodes: [èµ·é», è½‰å‘é», çµ‚é»] - èµ·é»å’Œçµ‚é»ç›¸åŒï¼ˆå‡ºå£ä½ç½®ï¼‰ï¼Œè½‰å‘é»æ˜¯ node_id + 1
                  nodes: ["${location.node_id}", "${location.node_id + 1}", "${location.node_id}"]
              store: "task_id"
              skip_if: "${no_racks} || !${a_side_full} || !${b_side_has_space} || ${task_exists}"
              description: "å‰µå»ºæ¶å°ç¿»è½‰ä»»å‹™"

            - id: "log_task_created"
              exec: "action.log_message"
              params:
                message: "âœ… å‰µå»ºç¿»è½‰ä»»å‹™ - æ¶å°: ${racks_at_location[0].name}, ä»»å‹™ID: ${task_id}"
                level: "info"
                tags: ["task_created", "rotation", "outlet"]
              skip_if: "${no_racks} || !${a_side_full} || !${b_side_has_space} || ${task_exists}"
              description: "è¨˜éŒ„ä»»å‹™å‰µå»º"

  - section: "ç¸½çµ"
    description: "æµç¨‹åŸ·è¡Œç¸½çµ"
    steps:
      - id: "count_processed_locations"
        exec: "control.count_items"
        params:
          variable: "${outlet_locations}"
        store: "total_locations"
        description: "è¨ˆç®—è™•ç†çš„ä½ç½®æ•¸é‡"

      - id: "log_completion"
        exec: "action.log_message"
        params:
          message: "ğŸ æˆ¿é–“å‡ºå£æ¶å°ç¿»è½‰æµç¨‹å®Œæˆ - æª¢æŸ¥äº† ${total_locations} å€‹å‡ºå£ä½ç½®"
          level: "info"
          tags: ["completion", "summary", "rack_rotation", "outlet"]
        description: "è¨˜éŒ„å®Œæˆè¨Šæ¯"

settings:
  log_level: "INFO"
  enable_checkpoint: true
  parallel_execution: false
  timeout: 120
  retry_on_failure: true
  max_retries: 3
  # åŸ·è¡Œé »ç‡æ§åˆ¶ - æ¯5åˆ†é˜åŸ·è¡Œä¸€æ¬¡
  execution_interval: 300  # seconds
  last_execution: null