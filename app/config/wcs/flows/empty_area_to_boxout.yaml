meta:
  system: linear_flow_v2
  version: "2.0.0"
  author: "Flow WCS System"
  created_at: "2025-08-19"
  description: "ç©ºæ–™æ¶å€åˆ°å‡ºå£æµç¨‹ - å°‡ç©ºæ–™æ¶å€çš„æ¶å°æ¬é‹åˆ°å‡ºå£å‚³é€ç®±"

flow:
  id: "empty_area_to_boxout"
  name: "ç©ºæ–™æ¶å€åˆ°å‡ºå£"
  work_id: "220009"  # ç©ºæ–™æ¶å€åˆ°å‡ºå£å°ˆç”¨ work_id
  enabled: true
  priority: 30  # æœ€ä½å„ªå…ˆç´š

workflow:
  - section: "æŸ¥è©¢å‡ºå£å‚³é€ç®±éœ€æ±‚"
    description: "æŸ¥è©¢å‡ºå£å‚³é€ç®±æ˜¯å¦éœ€è¦ç©ºæ–™æ¶"
    steps:
      - id: "query_boxout_locations"
        exec: "query.locations"
        params:
          type: "boxout_transfer"
          rooms: [81, 82]  # å‡ºå£å‚³é€ç®±ä½ç½®
          has_rack: false  # æŸ¥è©¢æ²’æœ‰æ¶å°çš„ä½ç½®ï¼ˆç©ºä½ï¼‰
        store: "empty_boxout_locations"
        description: "æŸ¥è©¢å‡ºå£å‚³é€ç®±ç©ºä½"

      - id: "check_has_boxout_demand"
        exec: "check.empty"
        params:
          data: "${empty_boxout_locations}"
        store: "no_boxout_demand"
        description: "æª¢æŸ¥æ˜¯å¦æœ‰å‡ºå£éœ€æ±‚"

      - id: "stop_if_no_demand"
        exec: "control.stop_flow"
        params:
          reason: "å‡ºå£å‚³é€ç®±éƒ½å·²æœ‰æ¶å°ï¼Œä¸éœ€è¦è£œå……"
        skip_if: "!${no_boxout_demand}"
        description: "å¦‚æœæ²’æœ‰éœ€æ±‚å‰‡åœæ­¢æµç¨‹"

      - id: "log_boxout_demand"
        exec: "action.log_message"
        params:
          message: "ğŸ“¦ å‡ºå£å‚³é€ç®±æœ‰ ${empty_boxout_locations.length} å€‹ä½ç½®éœ€è¦æ¶å°"
          level: "info"
          tags: ["boxout_demand", "empty_rack"]
        skip_if: "${no_boxout_demand}"
        description: "è¨˜éŒ„å‡ºå£éœ€æ±‚"

  - section: "æŸ¥è©¢ç©ºæ–™æ¶å€å¯ç”¨æ¶å°"
    description: "æŸ¥è©¢ç©ºæ–™æ¶å€ (41-45) çš„å¯ç”¨æ¶å°"
    steps:
      - id: "query_empty_rack_area"
        exec: "query.locations"
        params:
          type: "empty_rack_area"
          rooms: [41, 42, 43, 44, 45]  # ç©ºæ–™æ¶å€ä½ç½®
          has_rack: true  # æŸ¥è©¢æœ‰æ¶å°çš„ä½ç½®
        store: "empty_area_with_racks"
        skip_if: "${no_boxout_demand}"
        description: "æŸ¥è©¢ç©ºæ–™æ¶å€æœ‰æ¶å°çš„ä½ç½®"

      - id: "check_has_empty_racks"
        exec: "check.empty"
        params:
          data: "${empty_area_with_racks}"
        store: "no_empty_racks"
        skip_if: "${no_boxout_demand}"
        description: "æª¢æŸ¥æ˜¯å¦æœ‰ç©ºæ–™æ¶"

      - id: "stop_if_no_empty_racks"
        exec: "control.stop_flow"
        params:
          reason: "ç©ºæ–™æ¶å€æ²’æœ‰æ¶å°å¯ä¾›æ‡‰"
        skip_if: "!${no_empty_racks} || ${no_boxout_demand}"
        description: "å¦‚æœæ²’æœ‰ç©ºæ–™æ¶å‰‡åœæ­¢æµç¨‹"

      - id: "log_empty_rack_availability"
        exec: "action.log_message"
        params:
          message: "ğŸ­ ç©ºæ–™æ¶å€æœ‰ ${empty_area_with_racks.length} å€‹æ¶å°å¯ä¾›æ‡‰"
          level: "info"
          tags: ["empty_rack_area", "available_racks"]
        skip_if: "${no_empty_racks} || ${no_boxout_demand}"
        description: "è¨˜éŒ„ç©ºæ–™æ¶å¯ç”¨æ€§"

  - section: "åŒ¹é…ç©ºæ–™æ¶èˆ‡å‡ºå£éœ€æ±‚"
    description: "å°‡ç©ºæ–™æ¶å€çš„æ¶å°åˆ†é…åˆ°éœ€è¦çš„å‡ºå£"
    steps:
      - id: "foreach_boxout_locations"
        exec: "foreach"
        params:
          items: "${empty_boxout_locations}"
          var: "boxout"
          steps:
            - id: "check_priority_level"
              exec: "control.switch"
              params:
                value: "${boxout.priority || 'normal'}"
                cases:
                  "urgent": 50    # ç·Šæ€¥éœ€æ±‚
                  "high": 40      # é«˜å„ªå…ˆç´š
                  "normal": 30    # æ­£å¸¸
                  "low": 20       # ä½å„ªå…ˆç´š
                default: 30
              store: "boxout_priority"
              description: "ç¢ºå®šå‡ºå£å„ªå…ˆç´š"

            - id: "check_available_empty_racks"
              exec: "check.empty"
              params:
                data: "${empty_area_with_racks}"
              store: "no_more_empty_racks"
              description: "æª¢æŸ¥æ˜¯å¦é‚„æœ‰å¯ç”¨ç©ºæ–™æ¶"

            - id: "stop_if_no_more_racks"
              exec: "control.stop_flow"
              params:
                reason: "ç©ºæ–™æ¶å€æ¶å°å·²å…¨éƒ¨åˆ†é…å®Œç•¢"
              skip_if: "!${no_more_empty_racks}"
              description: "å¦‚æœæ²’æœ‰æ¶å°å‰‡åœæ­¢"

            - id: "get_empty_rack"
              exec: "query.racks"
              params:
                location_id: "${empty_area_with_racks[0].id}"
                status: "available"
              store: "available_empty_rack"
              skip_if: "${no_more_empty_racks}"
              description: "ç²å–ç©ºæ–™æ¶å€çš„æ¶å°"

            - id: "check_rack_exists"
              exec: "check.empty"
              params:
                data: "${available_empty_rack}"
              store: "no_rack"
              skip_if: "${no_more_empty_racks}"
              description: "æª¢æŸ¥æ¶å°æ˜¯å¦å­˜åœ¨"

            - id: "verify_rack_empty"
              exec: "check.rack_status"
              params:
                rack_id: "${available_empty_rack[0].id}"
                side: "both"
                check_type: "empty"
              store: "rack_verified_empty"
              skip_if: "${no_more_empty_racks} || ${no_rack}"
              description: "é©—è­‰æ¶å°ç¢ºå¯¦ç‚ºç©º"

            - id: "log_allocation"
              exec: "action.log_message"
              params:
                message: "ğŸ¯ åˆ†é…ç©ºæ–™æ¶ ${available_empty_rack[0].rack_id} å¾ç©ºæ–™æ¶å€åˆ°å‡ºå£ ${boxout.name}"
                level: "info"
                tags: ["rack_allocation", "boxout_${boxout.id}"]
              skip_if: "${no_more_empty_racks} || ${no_rack} || !${rack_verified_empty}"
              description: "è¨˜éŒ„æ¶å°åˆ†é…"

            - id: "check_existing_boxout_task"
              exec: "check.task_exists"
              params:
                type: "EMPTY_TO_BOXOUT_TRANSFER"
                rack_id: "${available_empty_rack[0].id}"
                status: ["pending", "in_progress"]
              store: "boxout_task_exists"
              skip_if: "${no_more_empty_racks} || ${no_rack} || !${rack_verified_empty}"
              description: "æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨æ¬é‹ä»»å‹™"

            - id: "create_boxout_task"
              exec: "task.create_task"
              params:
                type: "EMPTY_TO_BOXOUT_TRANSFER"
                work_id: "220009"  # ç©ºæ–™æ¶å€åˆ°å‡ºå£ work_id
                source_location_id: "${empty_area_with_racks[0].id}"
                target_location_id: "${boxout.id}"
                rack_id: "${available_empty_rack[0].id}"
                room_id: "${boxout.room_id || 0}"
                priority: "${boxout_priority}"  # æ ¹æ“šå‡ºå£å„ªå…ˆç´šè¨­å®š
                metadata:
                  rack_name: "${available_empty_rack[0].rack_id}"
                  source_location: "${empty_area_with_racks[0].name}"
                  target_location: "${boxout.name}"
                  boxout_priority: "${boxout.priority || 'normal'}"
                  transport_reason: "ä¾›æ‡‰å‡ºå£å‚³é€ç®±"
                  model: "Cargo"  # Cargo AGV è² è²¬æ¬é‹
                  # è·¯å¾‘è¦åŠƒï¼šå¾ç©ºæ–™æ¶å€åˆ°å‡ºå£
                  nodes: ["${empty_area_with_racks[0].node_id}", "${boxout.node_id}"]
              store: "boxout_task_id"
              skip_if: "${no_more_empty_racks} || ${no_rack} || !${rack_verified_empty} || ${boxout_task_exists}"
              description: "å‰µå»ºå‡ºå£æ¬é‹ä»»å‹™"

            - id: "log_task_created"
              exec: "action.log_message"
              params:
                message: "âœ… å‰µå»ºå‡ºå£æ¬é‹ä»»å‹™ - æ¶å°: ${available_empty_rack[0].rack_id}, åˆ°å‡ºå£ ${boxout.name}, ä»»å‹™ID: ${boxout_task_id}"
                level: "info"
                tags: ["task_created", "boxout_transfer"]
              skip_if: "${no_more_empty_racks} || ${no_rack} || !${rack_verified_empty} || ${boxout_task_exists}"
              description: "è¨˜éŒ„ä»»å‹™å‰µå»º"

            - id: "update_available_racks"
              exec: "control.update_variable"
              params:
                variable: "empty_area_with_racks"
                operation: "remove_first"
                value: 1
              skip_if: "${no_more_empty_racks} || ${no_rack} || !${rack_verified_empty} || ${boxout_task_exists}"
              description: "æ›´æ–°å¯ç”¨æ¶å°åˆ—è¡¨"

        skip_if: "${no_boxout_demand} || ${no_empty_racks}"
        description: "éæ­·æ‰€æœ‰éœ€è¦æ¶å°çš„å‡ºå£"

  - section: "ç›£æ§ç³»çµ±å¹³è¡¡"
    description: "ç›£æ§ç©ºæ–™æ¶å€èˆ‡å‡ºå£çš„ä¾›éœ€å¹³è¡¡"
    steps:
      - id: "query_empty_area_inventory"
        exec: "query.racks"
        params:
          location_id: [41, 42, 43, 44, 45]  # ç©ºæ–™æ¶å€
          status: "available"
        store: "empty_area_inventory"
        description: "æŸ¥è©¢ç©ºæ–™æ¶å€åº«å­˜"

      - id: "count_inventory"
        exec: "control.count_items"
        params:
          variable: "${empty_area_inventory}"
        store: "inventory_count"
        description: "è¨ˆç®—åº«å­˜æ•¸é‡"

      - id: "query_boxout_racks"
        exec: "query.racks"
        params:
          location_id: [81, 82]  # å‡ºå£å‚³é€ç®±
          status: "available"
        store: "boxout_racks"
        description: "æŸ¥è©¢å‡ºå£æ¶å°æ•¸é‡"

      - id: "count_boxout_racks"
        exec: "control.count_items"
        params:
          variable: "${boxout_racks}"
        store: "boxout_rack_count"
        description: "è¨ˆç®—å‡ºå£æ¶å°æ•¸é‡"

      - id: "calculate_supply_rate"
        exec: "control.update_variable"
        params:
          variable: "supply_rate"
          operation: "set"
          value: "${boxout_rack_count * 100 / 2}"  # å‡ºå£ä¾›æ‡‰ç‡
        store: "supply_rate"
        description: "è¨ˆç®—ä¾›æ‡‰ç‡"

      - id: "log_system_balance"
        exec: "action.log_message"
        params:
          message: "ğŸ“Š ç³»çµ±å¹³è¡¡ - ç©ºæ–™æ¶å€åº«å­˜: ${inventory_count}/5, å‡ºå£ä¾›æ‡‰ç‡: ${supply_rate}%"
          level: "info"
          tags: ["system_balance", "monitoring"]
        description: "è¨˜éŒ„ç³»çµ±å¹³è¡¡ç‹€æ…‹"

      - id: "check_imbalance"
        exec: "control.switch"
        params:
          value: "${inventory_count}"
          cases:
            "0": true  # åº«å­˜è€—ç›¡
          default: false
        store: "inventory_depleted"
        description: "æª¢æŸ¥åº«å­˜æ˜¯å¦è€—ç›¡"

      - id: "send_depletion_alert"
        exec: "action.send_notification"
        params:
          message: "âš ï¸ ç©ºæ–™æ¶å€åº«å­˜è€—ç›¡ï¼Œç„¡æ³•ç¹¼çºŒä¾›æ‡‰å‡ºå£"
          level: "warning"
          priority: "low"
        skip_if: "!${inventory_depleted}"
        description: "ç™¼é€åº«å­˜è€—ç›¡è­¦å‘Š"

  - section: "ç¸½çµ"
    description: "æµç¨‹åŸ·è¡Œç¸½çµ"
    steps:
      - id: "count_processed_boxouts"
        exec: "control.count_items"
        params:
          variable: "${empty_boxout_locations}"
        store: "total_boxouts"
        description: "è¨ˆç®—è™•ç†çš„å‡ºå£æ•¸é‡"

      - id: "log_completion"
        exec: "action.log_message"
        params:
          message: "ğŸ ç©ºæ–™æ¶å€åˆ°å‡ºå£æµç¨‹å®Œæˆ - è™•ç†äº† ${total_boxouts} å€‹å‡ºå£éœ€æ±‚ï¼Œç©ºæ–™æ¶å€å‰©é¤˜: ${inventory_count}/5"
          level: "info"
          tags: ["completion", "boxout_transfer", "summary"]
        description: "è¨˜éŒ„å®Œæˆè¨Šæ¯"

settings:
  log_level: "INFO"
  enable_checkpoint: true
  parallel_execution: false
  timeout: 420  # 7åˆ†é˜è¶…æ™‚
  retry_on_failure: true
  max_retries: 3
  # åŸ·è¡Œé »ç‡æ§åˆ¶ - æ¯15åˆ†é˜åŸ·è¡Œä¸€æ¬¡ï¼ˆæœ€ä½å„ªå…ˆç´šï¼‰
  execution_interval: 900  # seconds
  last_execution: null
  # å‡ºå£ä¾›æ‡‰ç‰¹å®šè¨­å®š
  boxout_supply_settings:
    max_concurrent_tasks: 2  # æœ€å¤šåŒæ™‚2å€‹æ¬é‹ä»»å‹™
    priority_level: 30  # æœ€ä½å„ªå…ˆç´š
    empty_area_capacity: 5  # ç©ºæ–™æ¶å€å®¹é‡
    boxout_capacity: 2  # å‡ºå£å‚³é€ç®±å®¹é‡
    depletion_alert: true  # å•Ÿç”¨åº«å­˜è€—ç›¡è­¦å‘Š