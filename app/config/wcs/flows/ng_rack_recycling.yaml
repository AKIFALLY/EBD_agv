meta:
  system: linear_flow_v2
  version: "2.0.0"
  author: "Flow WCS System"
  created_at: "2025-08-19"
  description: "NG æ–™æ¶å›æ”¶æµç¨‹ - å°‡ NG æ¶å°å¾æˆ¿é–“å…¥å£æ¬é‹åˆ° NG è™•ç†å€"

flow:
  id: "ng_rack_recycling"
  name: "NG æ–™æ¶å›æ”¶æµç¨‹"
  work_id: "220003"  # NG è™•ç†å°ˆç”¨ work_id
  enabled: true
  priority: 90  # é«˜å„ªå…ˆç´š

workflow:
  - section: "æŸ¥è©¢æˆ¿é–“å…¥å£ NG æ¶å°"
    description: "æŸ¥è©¢æ‰€æœ‰æˆ¿é–“å…¥å£ä½ç½®çš„ NG æ¶å°"
    steps:
      - id: "query_inlet_locations"
        exec: "query.locations"
        params:
          type: "room_inlet"
          rooms: [1, 2, 3, 4, 5]
        store: "inlet_locations"
        description: "æŸ¥è©¢æ‰€æœ‰æˆ¿é–“å…¥å£ä½ç½®"

      - id: "check_has_locations"
        exec: "check.empty"
        params:
          data: "${inlet_locations}"
        store: "no_locations"
        description: "æª¢æŸ¥æ˜¯å¦æœ‰å…¥å£ä½ç½®"

      - id: "stop_if_no_locations"
        exec: "control.stop_flow"
        params:
          reason: "æ²’æœ‰æ‰¾åˆ°æˆ¿é–“å…¥å£ä½ç½®"
        skip_if: "!${no_locations}"
        description: "å¦‚æœæ²’æœ‰å…¥å£ä½ç½®å‰‡åœæ­¢æµç¨‹"

  - section: "æª¢æŸ¥æ¯å€‹å…¥å£çš„ NG æ¶å°"
    description: "éæ­·æ¯å€‹å…¥å£ä½ç½®ï¼Œæª¢æŸ¥æ˜¯å¦æœ‰ NG ç‹€æ…‹çš„æ¶å°"
    steps:
      - id: "foreach_inlet_locations"
        exec: "foreach"
        params:
          items: "${inlet_locations}"
          var: "location"
          steps:
            - id: "query_ng_racks_at_location"
              exec: "query.racks"
              params:
                location_id: "${location.id}"
                status: "ng"  # æŸ¥è©¢ NG ç‹€æ…‹çš„æ¶å°
              store: "ng_racks_at_location"
              description: "æŸ¥è©¢è©²ä½ç½®çš„ NG æ¶å°"

            - id: "check_has_ng_racks"
              exec: "check.empty"
              params:
                data: "${ng_racks_at_location}"
              store: "no_ng_racks"
              description: "æª¢æŸ¥æ˜¯å¦æœ‰ NG æ¶å°"

            - id: "log_ng_rack_found"
              exec: "action.log_message"
              params:
                message: "âš ï¸ ç™¼ç¾ NG æ¶å° - ä½ç½®: ${location.name} (ID: ${location.id}), æ¶å°: ${ng_racks_at_location[0].rack_id}"
                level: "warning"
                tags: ["ng_rack", "inlet", "room_${location.room_id}"]
              skip_if: "${no_ng_racks}"
              description: "è¨˜éŒ„ç™¼ç¾ NG æ¶å°"

            - id: "query_ng_area_availability"
              exec: "query.locations"
              params:
                type: "ng_area"
                ids: [71, 72]  # NG è™•ç†å€ä½ç½® ID
                available: true  # æŸ¥è©¢ç©ºé–’ä½ç½®
              store: "available_ng_areas"
              skip_if: "${no_ng_racks}"
              description: "æŸ¥è©¢ NG è™•ç†å€å¯ç”¨ä½ç½®"

            - id: "check_ng_area_available"
              exec: "check.empty"
              params:
                data: "${available_ng_areas}"
              store: "no_ng_area_available"
              skip_if: "${no_ng_racks}"
              description: "æª¢æŸ¥ NG è™•ç†å€æ˜¯å¦æœ‰ç©ºä½"

            - id: "log_no_ng_area"
              exec: "action.log_message"
              params:
                message: "âŒ NG è™•ç†å€å·²æ»¿ï¼Œç„¡æ³•æ¬é‹ NG æ¶å°"
                level: "error"
                tags: ["ng_area_full", "ng_rack"]
              skip_if: "${no_ng_racks} || !${no_ng_area_available}"
              description: "è¨˜éŒ„ NG è™•ç†å€å·²æ»¿"

            - id: "check_existing_ng_task"
              exec: "check.task_exists"
              params:
                type: "NG_RACK_RECYCLING"
                rack_id: "${ng_racks_at_location[0].id}"
                status: ["pending", "in_progress"]
              store: "ng_task_exists"
              skip_if: "${no_ng_racks} || ${no_ng_area_available}"
              description: "æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨æœªå®Œæˆçš„ NG å›æ”¶ä»»å‹™"

            - id: "create_ng_recycling_task"
              exec: "task.create_task"
              params:
                type: "NG_RACK_RECYCLING"
                work_id: "220003"  # NG è™•ç†å°ˆç”¨ work_id
                source_location_id: "${location.id}"
                target_location_id: "${available_ng_areas[0].id}"
                rack_id: "${ng_racks_at_location[0].id}"
                room_id: "${location.room_id}"
                priority: "critical"  # æœ€é«˜å„ªå…ˆç´š
                metadata:
                  rack_name: "${ng_racks_at_location[0].rack_id}"
                  source_location: "${location.name}"
                  target_location: "${available_ng_areas[0].name}"
                  room_id: "${location.room_id}"
                  ng_reason: "${ng_racks_at_location[0].ng_reason || 'OCR NG æª¢æ¸¬å¤±æ•—'}"
                  model: "Cargo"  # Cargo AGV è² è²¬æ¬é‹
                  # è·¯å¾‘è¦åŠƒï¼šå¾å…¥å£åˆ° NG è™•ç†å€
                  nodes: ["${location.node_id}", "${available_ng_areas[0].node_id}"]
              store: "ng_task_id"
              skip_if: "${no_ng_racks} || ${no_ng_area_available} || ${ng_task_exists}"
              description: "å‰µå»º NG æ¶å°å›æ”¶ä»»å‹™"

            # è¨»è§£ï¼šæ›´æ–°æ¶å°ç‹€æ…‹åŠŸèƒ½éœ€è¦å¯¦ä½œ action.update_rack å‡½æ•¸
            # - id: "update_rack_status"
            #   exec: "action.update_rack"
            #   params:
            #     rack_id: "${ng_racks_at_location[0].id}"
            #     status: "recycling"  # æ›´æ–°ç‚ºå›æ”¶ä¸­ç‹€æ…‹
            #   skip_if: "${no_ng_racks} || ${no_ng_area_available} || ${ng_task_exists}"
            #   description: "æ›´æ–°æ¶å°ç‹€æ…‹ç‚ºå›æ”¶ä¸­"

            - id: "log_ng_task_created"
              exec: "action.log_message"
              params:
                message: "ğŸ”„ å‰µå»º NG å›æ”¶ä»»å‹™ - æ¶å°: ${ng_racks_at_location[0].rack_id}, å¾ ${location.name} åˆ° ${available_ng_areas[0].name}, ä»»å‹™ID: ${ng_task_id}"
                level: "info"
                tags: ["task_created", "ng_recycling", "critical"]
              skip_if: "${no_ng_racks} || ${no_ng_area_available} || ${ng_task_exists}"
              description: "è¨˜éŒ„ NG ä»»å‹™å‰µå»º"

            - id: "send_ng_notification"
              exec: "action.send_notification"
              params:
                type: "ng_rack_detected"
                title: "NG æ¶å°éœ€è¦è™•ç†"
                message: "æ¶å° ${ng_racks_at_location[0].rack_id} åœ¨ ${location.name} æª¢æ¸¬ç‚º NGï¼Œå·²å‰µå»ºå›æ”¶ä»»å‹™"
                severity: "high"
                recipients: ["wcs_operator", "quality_control"]
              skip_if: "${no_ng_racks} || ${no_ng_area_available} || ${ng_task_exists}"
              description: "ç™¼é€ NG é€šçŸ¥çµ¦ç›¸é—œäººå“¡"

  - section: "æª¢æŸ¥ NG è™•ç†å€ç‹€æ…‹"
    description: "æª¢æŸ¥ NG è™•ç†å€çš„è™•ç†é€²åº¦"
    steps:
      - id: "query_ng_area_racks"
        exec: "query.racks"
        params:
          location_id: [71, 72]  # NG è™•ç†å€
          status: "ng"
        store: "ng_area_racks"
        description: "æŸ¥è©¢ NG è™•ç†å€çš„æ¶å°æ•¸é‡"

      - id: "count_ng_racks"
        exec: "control.count_items"
        params:
          variable: "${ng_area_racks}"
        store: "ng_rack_count"
        description: "è¨ˆç®— NG æ¶å°æ•¸é‡"

      - id: "log_ng_area_status"
        exec: "action.log_message"
        params:
          message: "ğŸ“Š NG è™•ç†å€ç‹€æ…‹ - ç•¶å‰ NG æ¶å°æ•¸é‡: ${ng_rack_count}/2 (å®¹é‡: 2)"
          level: "info"
          tags: ["ng_area_status", "monitoring"]
        description: "è¨˜éŒ„ NG è™•ç†å€ç‹€æ…‹"

      # ä½¿ç”¨ control.switch ä¾†æª¢æŸ¥æ˜¯å¦é”åˆ°ä¸Šé™
      - id: "check_ng_area_critical"
        exec: "control.switch"
        params:
          value: "${ng_rack_count}"
          cases:
            "2": true
          default: false
        store: "ng_area_critical"
        description: "æª¢æŸ¥ NG è™•ç†å€æ˜¯å¦é”åˆ°å®¹é‡ä¸Šé™"

      - id: "send_critical_alert"
        exec: "action.send_alarm"
        params:
          message: "âš ï¸ NG è™•ç†å€å·²æ»¿: å·²é”å®¹é‡ä¸Šé™ (${ng_rack_count}/2)ï¼Œè«‹ç›¡å¿«è™•ç† NG æ¶å°"
          severity: "critical"
        skip_if: "!${ng_area_critical}"
        description: "ç™¼é€ NG è™•ç†å€å·²æ»¿è­¦å ±"

  - section: "ç¸½çµ"
    description: "æµç¨‹åŸ·è¡Œç¸½çµ"
    steps:
      - id: "count_processed_locations"
        exec: "control.count_items"
        params:
          variable: "${inlet_locations}"
        store: "total_locations"
        description: "è¨ˆç®—è™•ç†çš„ä½ç½®æ•¸é‡"

      - id: "log_completion"
        exec: "action.log_message"
        params:
          message: "âœ… NG æ–™æ¶å›æ”¶æµç¨‹å®Œæˆ - æª¢æŸ¥äº† ${total_locations} å€‹å…¥å£ä½ç½®ï¼ŒNG è™•ç†å€ä½¿ç”¨ç‡: ${ng_rack_count}/2"
          level: "info"
          tags: ["completion", "ng_recycling", "summary"]
        description: "è¨˜éŒ„å®Œæˆè¨Šæ¯"

settings:
  log_level: "INFO"
  enable_checkpoint: true
  parallel_execution: false
  timeout: 180  # 3åˆ†é˜è¶…æ™‚
  retry_on_failure: true
  max_retries: 3
  # åŸ·è¡Œé »ç‡æ§åˆ¶ - æ¯2åˆ†é˜åŸ·è¡Œä¸€æ¬¡ï¼ˆNG è™•ç†å„ªå…ˆç´šé«˜ï¼‰
  execution_interval: 120  # seconds
  last_execution: null
  # NG ç‰¹å®šè¨­å®š
  ng_handling:
    auto_pause_agv: true  # æª¢æ¸¬åˆ° NG æ™‚è‡ªå‹•æš«åœ AGV
    notification_enabled: true  # å•Ÿç”¨é€šçŸ¥
    critical_threshold: 2  # NG è™•ç†å€å®¹é‡ä¸Šé™