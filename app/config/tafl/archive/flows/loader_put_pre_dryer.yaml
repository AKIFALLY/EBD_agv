metadata:
  id: "loader_put_pre_dryer"
  name: "Loader AGV æ”¾æ–™åˆ°é çƒ˜æ©Ÿ"
  enabled: false
  version: "1.0.0"
  description: "æª¢æŸ¥ Loader AGV è»Šä¸Šè¼‰å…·å’Œé çƒ˜æ©Ÿç©ºä½ï¼Œå‰µå»ºæ”¾æ–™ä»»å‹™ï¼ˆéŠœæ¥ Unloader AGVï¼‰"
  author: "TAFL System"
  created_at: "2025-10-16"
  tags: ["loader", "pre_dryer", "put", "automation", "handover"]

settings:
  execution_interval: 12  # Execute every 12 seconds

variables:
  priority: 4  # ä¿®æ­£ï¼špriority å¿…é ˆåœ¨ 1-10 ç¯„åœå…§
  model: "Loader"
  pre_dryer_equipment_id: 205
  # 4å€‹ Station é…ç½®ï¼ˆæ¨™æº–è¨­å‚™ï¼ŒLoader ä½¿ç”¨ï¼‰
  stations:
    - station: 1
      work_id: 2050102
      ports: [2051, 2052]
      batch_size: 1  # Loader: 1æ ¼æ“ä½œ
      name: "é çƒ˜æ©Ÿ01"
    - station: 3
      work_id: 2050302
      ports: [2053, 2054]
      batch_size: 1
      name: "é çƒ˜æ©Ÿ03"
    - station: 5
      work_id: 2050502
      ports: [2055, 2056]
      batch_size: 1
      name: "é çƒ˜æ©Ÿ05"
    - station: 7
      work_id: 2050702
      ports: [2057, 2058]
      batch_size: 1
      name: "é çƒ˜æ©Ÿ07"

flow:
  # èª¿è©¦ï¼šæµç¨‹é–‹å§‹
  - notify:
      message: "ğŸ” é–‹å§‹åŸ·è¡Œ loader_put_pre_dryer æµç¨‹"

  # æŸ¥è©¢æ‰€æœ‰æˆ¿é–“
  - query:
      target: rooms
      where:
        enable: 1
      as: active_rooms
      description: "æŸ¥è©¢æ‰€æœ‰å•Ÿç”¨çš„æˆ¿é–“"

  # èª¿è©¦ï¼šæˆ¿é–“æ•¸é‡
  - notify:
      message: "æ‰¾åˆ° ${active_rooms.length} å€‹å•Ÿç”¨çš„æˆ¿é–“"

  # éæ­·æ¯å€‹æˆ¿é–“
  - for:
      in: "${active_rooms}"
      as: room
      do:
        # èª¿è©¦ï¼šé€²å…¥æˆ¿é–“è¿´åœˆ
        - notify:
            message: "ğŸ“ è™•ç†æˆ¿é–“ ${room.id} (${room.name})"
        # æŸ¥è©¢ Loader AGV (AGVè¡¨ç„¡room_idæ¬„ä½ï¼Œä½¿ç”¨modeléæ¿¾)
        - query:
            target: agvs
            where:
              model: "Loader"
              enable: 1
            as: loader_agvs
            description: "æŸ¥è©¢æ‰€æœ‰ Loader AGV"

        # éæ­·æ¯å€‹ Loader AGV
        - for:
            in: "${loader_agvs}"
            as: agv
            do:
              # æŸ¥è©¢ AGV Port 2ã€4 çš„é çƒ˜ä¸­è¼‰å…·ï¼ˆå¾Œæ®µæµç¨‹ç«¯å£ï¼‰
              - query:
                  target: carriers
                  where:
                    port_in: [2102, 2104]  # Port 2ã€4ï¼ˆCarrier æ²’æœ‰ agv_idï¼Œç”¨ port_id æŸ¥è©¢ï¼‰
                    status_id: 501  # é çƒ˜ä¸­
                    room_id: "${room.id}"  # éæ¿¾ç•¶å‰æˆ¿é–“çš„è¼‰å…·
                  as: port24_pre_dryer_carriers
                  description: "æŸ¥è©¢ AGV Port 2ã€4 çš„é çƒ˜ä¸­è¼‰å…·ï¼ˆç•¶å‰æˆ¿é–“ï¼‰"

              # æª¢æŸ¥é çƒ˜ä¸­è¼‰å…·æ•¸é‡
              - set:
                  pre_dryer_carrier_count: "${port24_pre_dryer_carriers.length}"
                  required_count: 1  # Loader: 1æ ¼æ“ä½œ
                  has_enough_carriers: "${pre_dryer_carrier_count >= required_count}"

              # èª¿è©¦ï¼šè¨˜éŒ„è¼‰å…·æƒ…æ³
              - notify:
                  message: "Room ${room.id}: AGV ${agv.name} port24_pre_dryer_carriers=${pre_dryer_carrier_count}, required=${required_count}, has_carriers=${has_enough_carriers}"

              # å¦‚æœ AGV æœ‰è¼‰å…·ï¼Œéæ­·4å€‹ Station
              - if:
                  condition: "${has_enough_carriers}"
                  then:
                    # éæ­·4å€‹ Stationï¼ˆé çƒ˜æ©Ÿ 01, 03, 05, 07ï¼‰
                    - for:
                        in: "${stations}"
                        as: station
                        do:
                          # æŸ¥è©¢è©² Station çš„ç©ºä½ï¼ˆ2å€‹ Portï¼‰
                          - query:
                              target: eqp_ports
                              where:
                                equipment_id: "${pre_dryer_equipment_id}"
                                port_in: "${station.ports}"
                                status: "empty"
                              as: empty_ports
                              description: "æŸ¥è©¢é çƒ˜æ©Ÿ Station ${station.station} ç©ºä½"

                          # æª¢æŸ¥ç©ºä½æ•¸é‡ï¼ˆéœ€è¦è‡³å°‘1æ ¼ï¼‰
                          - set:
                              empty_count: "${empty_ports.length}"
                              required_space: "${station.batch_size}"
                              has_enough_space: "${empty_count >= required_space}"

                          # å¦‚æœæœ‰ç©ºä½ï¼Œæª¢æŸ¥é‡è¤‡ä»»å‹™
                          - if:
                              condition: "${has_enough_space}"
                              then:
                                # æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨æœªå®Œæˆçš„æ”¾æ–™ä»»å‹™
                                - query:
                                    target: tasks
                                    where:
                                      work_id: "${station.work_id}"
                                      room_id: "${room.id}"
                                      status_id_in: [0, 1, 2, 3]  # æœªå®Œæˆçš„ç‹€æ…‹
                                    as: existing_tasks
                                    description: "æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨æ”¾æ–™ä»»å‹™"

                                # å¦‚æœæ²’æœ‰é‡è¤‡ä»»å‹™ï¼Œå‰µå»ºæ–°ä»»å‹™
                                - if:
                                    condition: "${existing_tasks.length == 0}"
                                    then:
                                      # å‰µå»º Loader AGV æ”¾æ–™ä»»å‹™
                                      - create:
                                          target: task
                                          with:
                                            type: "loader_put"
                                            name: "æˆ¿é–“${room.id}é çƒ˜æ©Ÿ Station${station.station} æ”¾æ–™"
                                            description: "AGV Port 2ã€4 æœ‰${pre_dryer_carrier_count}å€‹é çƒ˜ä¸­è¼‰å…·ï¼Œé çƒ˜æ©Ÿ ${station.name} æœ‰${empty_count}æ ¼ç©ºä½ï¼ˆLoader 1æ ¼æ“ä½œï¼ŒéŠœæ¥ Unloaderï¼‰"
                                            work_id: "${station.work_id}"
                                            room_id: "${room.id}"
                                            priority: "${priority}"
                                            status_id: 1  # PENDING
                                            parameters:
                                              station: "${station.station}"
                                              work_id: "${station.work_id}"
                                              room_id: "${room.id}"
                                              equipment_id: "${pre_dryer_equipment_id}"
                                              ports: "${station.ports}"
                                              batch_size: "${station.batch_size}"
                                              model: "${model}"
                                              source_agv_ports: [2102, 2104]  # å¾ Port 2ã€4 å–å‡º
                                              carrier_count: "${pre_dryer_carrier_count}"
                                              carrier_status: 501  # é çƒ˜ä¸­
                                              empty_space_count: "${empty_count}"
                                              reason: "AGV Port 2ã€4 æœ‰é çƒ˜ä¸­è¼‰å…·ï¼Œé çƒ˜æ©Ÿæœ‰ç©ºä½ï¼ˆéŠœæ¥ Unloader AGVï¼‰"
                                          description: "å‰µå»º Loader AGV æ”¾æ–™ä»»å‹™ï¼ˆéŠœæ¥ Unloaderï¼‰"
