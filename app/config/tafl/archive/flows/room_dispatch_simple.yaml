metadata:
  id: room_dispatch_simple
  name: 房間投料調度（簡化版）
  enabled: false
  version: 1.0.0
  description: 依房間優先級將系統準備區料架調度到對應房間入口
  author: TAFL System
  created_at: '2025-09-25'
  tags:
  - dispatch
  - room
  - automation
  updated_at: '2025-09-26T10:52:07.638646'
settings:
  execution_interval: 30
preload:
  prepare_racks:
    query:
      target: racks
      where:
        location_id_in:
        - 9
        - 8
        - 7
        - 6
        - 5
        - 4
        - 3
        - 2
      description: 查詢所有在系統準備區的料架
  enabled_rooms:
    query:
      target: rooms
      where:
        enable: 1
      description: 查詢所有啟用的房間
  all_products:
    query:
      target: products
      description: 查詢所有產品資訊
rules: {}
variables:
  dispatched_count: 0
  work_id: 220001  # KUKA 移動貨架 work ID (RACK_MOVE)
flow:
- for:
    in: ${prepare_racks}
    as: rack
    do:
    - if:
        condition: ${rack.room_id != null}
        then:
        - set:
            target_room: null
        - for:
            in: ${enabled_rooms}
            as: room
            do:
            - if:
                condition: ${room.id == rack.room_id}
                then:
                - set:
                    target_room: ${room}
        - if:
            condition: ${target_room != null}
            then:
            - query:
                target: locations
                where:
                  type: room_inlet
                  room_id: ${target_room.id}
                  location_status_id: 2
                limit: 1
                as: available_inlets
                description: 查詢房間${target_room.id}的空閒入口
            - set:
                target_inlet: null
            - if:
                condition: ${available_inlets.length > 0}
                then:
                - set:
                    target_inlet: ${available_inlets[0]}
            - if:
                condition: ${target_inlet != null}
                then:
                - set:
                    product_process_id: null
                - for:
                    in: ${all_products}
                    as: product
                    do:
                    - if:
                        condition: ${product.id == rack.product_id}
                        then:
                        - set:
                            product_process_id: ${product.process_settings_id}
                # 查詢起始位置資訊
                - query:
                    target: locations
                    where:
                      id: ${rack.location_id}
                    as: source_locations
                    description: 查詢準備區位置資訊

                - set:
                    source_location: ${source_locations[0]}

                - if:
                    condition: ${product_process_id == target_room.process_settings_id}
                    then:
                    - create:
                        target: task
                        with:
                          work_id: ${work_id}
                          room_id: ${target_room.id}
                          source_location_id: ${rack.location_id}
                          target_location_id: ${target_inlet.id}
                          rack_id: ${rack.id}
                          priority: 5
                          status_id: 1
                          parameters:
                            rack_name: ${rack.name}
                            rack_id: ${rack.id}
                            from_location_name: SystemPrepareArea
                            from_location_id: ${rack.location_id}
                            to_location_name: ${target_inlet.name}
                            to_location_id: ${target_inlet.id}
                            room_name: ${target_room.name}
                            room_id: ${target_room.id}
                            product_id: ${rack.product_id}
                            process_settings_id: ${product_process_id}
                            # nodes: [起點, 途經點, 終點] - 經過房間入口途經點 (waypoint_node_id)
                            nodes: ["${source_location.node_id}", "${target_inlet.waypoint_node_id}", "${target_inlet.node_id}"]
                            model: "KUKA400i"
                        as: created_task
                        description: 創建搬運任務：料架${rack.id}到房間${target_room.id}入口
                    - set:
                        update_result: update_location_status(${target_inlet.id}, '佔用', '派送料架${rack.id}')
                    - if:
                        condition: ${update_result[0] == true}
                        then:
                        - notify:
                            level: debug
                            message: 成功更新位置 ${target_inlet.id} 狀態為佔用
                        else:
                        - notify:
                            level: warning
                            message: '更新位置狀態失敗: ${update_result[1]}'
                    - set:
                        dispatched_count: ${dispatched_count + 1}
                    - notify:
                        level: info
                        message: 已調度料架 ${rack.id} 到房間 ${target_room.name} 入口
- if:
    condition: ${dispatched_count > 0}
    then:
    - notify:
        level: info
        message: 本次執行共調度 ${dispatched_count} 個料架
    else:
    - notify:
        level: debug
        message: 本次執行未找到需要調度的料架
