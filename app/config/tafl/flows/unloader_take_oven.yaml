metadata:
  id: "unloader_take_oven"
  name: "Unloader AGV å¾çƒ¤ç®±ä¸Šæ’å–æ–™"
  enabled: false
  version: "1.0.0"
  description: "æª¢æŸ¥çƒ¤ç®±ä¸Šæ’çƒ˜å¹²å®Œæˆè¼‰å…·ï¼Œå‰µå»º Unloader AGV å–æ–™ä»»å‹™ï¼ˆæ‰¹é‡4æ ¼ï¼Œå›ºå®šæ–¹å‘ï¼‰"
  author: "TAFL System"
  created_at: "2025-10-16"
  tags: ["unloader", "oven", "take", "automation"]

settings:
  execution_interval: 12  # Execute every 12 seconds

variables:
  priority: 4  # ä¿®æ­£ï¼špriority å¿…é ˆåœ¨ 1-10 ç¯„åœå…§
  model: "Unloader"
  oven_equipment_id: 206
  unloader_eqp_id: 211  # UnloaderAGV è¨­å‚™ ID
  unloader_ports: [2111, 2112, 2113, 2114]  # UnloaderAGV çš„ 4 å€‹ Port
  # 2å€‹ Station é…ç½®ï¼ˆä¸Šæ’å’Œä¸‹æ’ï¼‰
  stations:
    - station: 1
      work_id: 2060101
      ports: [2061, 2062, 2063, 2064]  # ä¸Šæ’4å€‹ Port
      batch_size: 4
      row: "upper"
      name: "çƒ¤ç®±ä¸Šæ’(Port01-04)"
    - station: 3
      work_id: 2060301
      ports: [2065, 2066, 2067, 2068]  # ä¸‹æ’4å€‹ Port
      batch_size: 4
      row: "lower"
      name: "çƒ¤ç®±ä¸‹æ’(Port05-08)"

flow:
  # èª¿è©¦ï¼šæµç¨‹é–‹å§‹
  - notify:
      message: "ğŸ” é–‹å§‹åŸ·è¡Œ unloader_take_oven æµç¨‹"

  # æŸ¥è©¢æ‰€æœ‰æˆ¿é–“
  - query:
      target: rooms
      where:
        enable: 1
      as: active_rooms
      description: "æŸ¥è©¢æ‰€æœ‰å•Ÿç”¨çš„æˆ¿é–“"

  # èª¿è©¦ï¼šæˆ¿é–“æ•¸é‡
  - notify:
      message: "æ‰¾åˆ° ${active_rooms.length} å€‹å•Ÿç”¨çš„æˆ¿é–“"

  # éæ­·æ¯å€‹æˆ¿é–“
  - for:
      in: "${active_rooms}"
      as: room
      do:
        # èª¿è©¦ï¼šé€²å…¥æˆ¿é–“è¿´åœˆ
        - notify:
            message: "ğŸ“ è™•ç†æˆ¿é–“ ${room.id} (${room.name})"
        # æŸ¥è©¢ Unloader AGV (AGVè¡¨ç„¡room_idæ¬„ä½ï¼Œä½¿ç”¨modeléæ¿¾)
        - query:
            target: agvs
            where:
              model: "Unloader"
              enable: 1
            as: unloader_agvs
            description: "æŸ¥è©¢æ‰€æœ‰ Unloader AGV"

        # éæ­·æ¯å€‹ Unloader AGV
        - for:
            in: "${unloader_agvs}"
            as: agv
            do:
              # æŸ¥è©¢ UnloaderAGV çš„ Port ä¸Šçš„è¼‰å…·
              - query:
                  target: carriers
                  where:
                    port_in: "${unloader_ports}"
                  as: agv_carriers
                  description: "æŸ¥è©¢ UnloaderAGV Port ä¸Šçš„è¼‰å…·"

              # è¨ˆç®— AGV ç©ºä½
              - set:
                  agv_carrier_count: "${agv_carriers.length}"
              - set:
                  max_capacity: 4
                  required_space: 4  # æ‰¹é‡4æ ¼
              - set:
                  available_space: "${max_capacity - agv_carrier_count}"
              - set:
                  agv_has_space: "${available_space >= required_space}"

              # èª¿è©¦ï¼šè¨˜éŒ„ç©ºä½æƒ…æ³
              - notify:
                  message: "Room ${room.id}: AGV ${agv.name} carriers=${agv_carrier_count}, available=${available_space}, has_space=${agv_has_space}"

              # å¦‚æœ AGV æœ‰è¶³å¤ ç©ºä½ï¼Œæª¢æŸ¥çƒ¤ç®±
              - if:
                  condition: "${agv_has_space}"
                  then:
                    # éæ­·2å€‹ Stationï¼ˆä¸Šæ’å’Œä¸‹æ’ï¼‰
                    - for:
                        in: "${stations}"
                        as: station
                        do:
                          # æŸ¥è©¢è©² Station çš„çƒ˜å¹²å®Œæˆè¼‰å…·ï¼ˆ4å€‹ Portï¼Œé€éportéæ¿¾ï¼‰
                          - query:
                              target: carriers
                              where:
                                room_id: "${room.id}"
                                port_in: "${station.ports}"
                                status_id: 603  # çƒ˜å¹²å®Œæˆ
                              as: ready_carriers
                              description: "æŸ¥è©¢çƒ¤ç®± Station ${station.station} çƒ˜å¹²å®Œæˆè¼‰å…·"

                          # æª¢æŸ¥è¼‰å…·æ•¸é‡æ˜¯å¦è¶³å¤ ï¼ˆéœ€è¦4å€‹ï¼‰
                          - set:
                              carrier_count: "${ready_carriers.length}"
                              required_count: "${station.batch_size}"
                              has_enough_carriers: "${carrier_count >= required_count}"

                          # å¦‚æœè¼‰å…·æ•¸é‡è¶³å¤ ï¼Œæª¢æŸ¥å¯¦éš›æ„Ÿæ¸¬å™¨åœ¨å¸­ä¿¡è™Ÿ
                          - if:
                              condition: "${has_enough_carriers}"
                              then:
                                # æŸ¥è©¢é€™äº› Port çš„ Presence ä¿¡è™Ÿ
                                - query:
                                    target: eqp_signals
                                    where:
                                      eqp_port_id_in: "${station.ports}"
                                      name_like: "%Presence"
                                      value: "1"  # 1 = æœ‰è¼‰å…·åœ¨å¸­
                                    as: occupied_presence_signals
                                    description: "ç¢ºèªæ„Ÿæ¸¬å™¨æœ‰è¼‰å…·åœ¨å¸­"

                                # æª¢æŸ¥æ˜¯å¦æ‰€æœ‰ Port çš„ Presence éƒ½æ˜¯ 1
                                - set:
                                    presence_check_count: "${occupied_presence_signals.length}"
                                    presence_all_occupied: "${presence_check_count >= required_count}"

                                # å¦‚æœè»Ÿé«”ç‹€æ…‹å’Œç¡¬é«”æ„Ÿæ¸¬å™¨éƒ½ç¢ºèªæœ‰è¼‰å…·ï¼Œæª¢æŸ¥é‡è¤‡ä»»å‹™
                                - if:
                                    condition: "${has_enough_carriers && presence_all_occupied}"
                                    then:
                                      # æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨æœªå®Œæˆçš„å–æ–™ä»»å‹™
                                      - query:
                                          target: tasks
                                          where:
                                            work_id: "${station.work_id}"
                                            room_id: "${room.id}"
                                            status_id_in: [0, 1, 2, 3]  # æœªå®Œæˆçš„ç‹€æ…‹
                                          as: existing_tasks
                                          description: "æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨å–æ–™ä»»å‹™"

                                      # å¦‚æœæ²’æœ‰é‡è¤‡ä»»å‹™ï¼Œå‰µå»ºæ–°ä»»å‹™
                                      - if:
                                          condition: "${existing_tasks.length == 0}"
                                          then:
                                            # å‰µå»º Unloader AGV å–æ–™ä»»å‹™
                                            - create:
                                                target: task
                                                with:
                                                  type: "unloader_take"
                                                  name: "æˆ¿é–“${room.id}çƒ¤ç®± Station${station.station} å–æ–™"
                                                  description: "çƒ¤ç®± ${station.name} æœ‰${carrier_count}å€‹çƒ˜å¹²å®Œæˆè¼‰å…·ï¼Œæ„Ÿæ¸¬å™¨ç¢ºèªæœ‰è¼‰å…·ï¼ˆæ‰¹é‡4æ ¼ï¼‰"
                                                  work_id: "${station.work_id}"
                                                  room_id: "${room.id}"
                                                  priority: "${priority}"
                                                  status_id: 1  # PENDING
                                                  parameters:
                                                    station: "${station.station}"
                                                    work_id: "${station.work_id}"
                                                    room_id: "${room.id}"
                                                    equipment_id: "${oven_equipment_id}"
                                                    ports: "${station.ports}"
                                                    batch_size: "${station.batch_size}"
                                                    row: "${station.row}"
                                                    model: "${model}"
                                                    carrier_count: "${carrier_count}"
                                                    presence_verified: true
                                                    reason: "çƒ¤ç®±æœ‰çƒ˜å¹²å®Œæˆè¼‰å…·ï¼ŒAGV æœ‰ç©ºä½ï¼Œæ„Ÿæ¸¬å™¨ç¢ºèªæœ‰è¼‰å…·ï¼ˆé›™é‡é©—è­‰ï¼‰"
                                                description: "å‰µå»º Unloader AGV å–æ–™ä»»å‹™ï¼ˆæ‰¹é‡4æ ¼ï¼Œå«æ„Ÿæ¸¬å™¨é©—è­‰ï¼‰"
