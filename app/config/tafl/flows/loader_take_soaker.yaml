metadata:
  id: "loader_take_soaker"
  name: "Loader AGV å¾æ³¡è—¥æ©Ÿå–æ–™"
  enabled: true
  version: "1.0.0"
  description: "æª¢æŸ¥æ³¡è—¥æ©Ÿæ³¡è—¥å®Œæˆè¼‰å…·ï¼Œå‰µå»º Loader AGV å–æ–™ä»»å‹™ï¼ˆç‰¹æ®Šè¨­å‚™ï¼š1æ ¼è™•ç†ï¼‰"
  author: "TAFL System"
  created_at: "2025-10-16"
  tags: ["loader", "soaker", "take", "automation", "special-equipment"]

settings:
  execution_interval: 12  # Execute every 12 seconds

variables:
  priority: 4  # ä¿®æ­£ï¼špriority å¿…é ˆåœ¨ 1-10 ç¯„åœå…§
  model: "Loader"
  soaker_equipment_id: 204
  # 6å€‹ Station é…ç½®ï¼ˆç‰¹æ®Šè¨­å‚™ï¼Œå…¨éƒ¨1æ ¼è™•ç†ï¼‰
  stations:
    - station: 1
      work_id: 2040101
      ports: [2041]
      batch_size: 1
      name: "æ³¡è—¥æ©ŸA"
    - station: 2
      work_id: 2040201
      ports: [2042]
      batch_size: 1
      name: "æ³¡è—¥æ©ŸB"
    - station: 3
      work_id: 2040301
      ports: [2043]
      batch_size: 1
      name: "æ³¡è—¥æ©ŸC"
    - station: 4
      work_id: 2040401
      ports: [2044]
      batch_size: 1
      name: "æ³¡è—¥æ©ŸD"
    - station: 5
      work_id: 2040501
      ports: [2045]
      batch_size: 1
      name: "æ³¡è—¥æ©ŸE"
    - station: 6
      work_id: 2040601
      ports: [2046]
      batch_size: 1
      name: "æ³¡è—¥æ©ŸF"

flow:
  # èª¿è©¦ï¼šæµç¨‹é–‹å§‹
  - notify:
      message: "ğŸ” é–‹å§‹åŸ·è¡Œ loader_take_soaker æµç¨‹"

  # æŸ¥è©¢æ‰€æœ‰æˆ¿é–“
  - query:
      target: rooms
      where:
        enable: 1
      as: active_rooms
      description: "æŸ¥è©¢æ‰€æœ‰å•Ÿç”¨çš„æˆ¿é–“"

  # èª¿è©¦ï¼šæˆ¿é–“æ•¸é‡
  - notify:
      message: "æ‰¾åˆ° ${active_rooms.length} å€‹å•Ÿç”¨çš„æˆ¿é–“"

  # éæ­·æ¯å€‹æˆ¿é–“
  - for:
      in: "${active_rooms}"
      as: room
      do:
        # èª¿è©¦ï¼šé€²å…¥æˆ¿é–“è¿´åœˆ
        - notify:
            message: "ğŸ“ è™•ç†æˆ¿é–“ ${room.id} (${room.name})"
        # æŸ¥è©¢ Loader AGV (AGVè¡¨ç„¡room_idæ¬„ä½ï¼Œä½¿ç”¨modeléæ¿¾)
        - query:
            target: agvs
            where:
              model: "Loader"
              enable: 1
            as: loader_agvs
            description: "æŸ¥è©¢æ‰€æœ‰ Loader AGV"

        # éæ­·æ¯å€‹ Loader AGV
        - for:
            in: "${loader_agvs}"
            as: agv
            do:
              # æŸ¥è©¢ AGV Port 1ã€3 çš„ Presence ä¿¡è™Ÿï¼ˆç¢ºèªä½ç½®ç‚ºç©ºï¼‰
              - query:
                  target: eqp_signals
                  where:
                    eqp_port_id_in: [2101, 2103]  # AGV Port 1ã€3
                    name_like: "%Presence"
                    value: "0"  # 0 = ç„¡è¼‰å…·åœ¨å¸­ï¼ˆç©ºä½ï¼‰
                  as: agv_port13_empty_signals
                  description: "ç¢ºèª AGV Port 1ã€3 æ„Ÿæ¸¬å™¨ç„¡è¼‰å…·åœ¨å¸­"

              # æª¢æŸ¥ AGV Port 1ã€3 æ˜¯å¦éƒ½æ˜¯ç©ºä½ï¼ˆPresence = 0ï¼‰
              - set:
                  agv_port13_empty_count: "${agv_port13_empty_signals.length}"
                  required_port13_empty: 2  # Port 1 å’Œ Port 3 éƒ½è¦ç©º
                  agv_port13_verified: "${agv_port13_empty_count >= required_port13_empty}"

              # æŸ¥è©¢ AGV Port 2ã€4 çš„ Presence ä¿¡è™Ÿï¼ˆè‡³å°‘ä¸€å€‹ç‚ºç©ºï¼‰
              - query:
                  target: eqp_signals
                  where:
                    eqp_port_id_in: [2102, 2104]  # AGV Port 2ã€4
                    name_like: "%Presence"
                    value: "0"  # 0 = ç„¡è¼‰å…·åœ¨å¸­ï¼ˆç©ºä½ï¼‰
                  as: agv_port24_empty_signals
                  description: "ç¢ºèª AGV Port 2ã€4 è‡³å°‘ä¸€å€‹æ„Ÿæ¸¬å™¨ç„¡è¼‰å…·åœ¨å¸­"

              # æª¢æŸ¥ AGV Port 2ã€4 æ˜¯å¦è‡³å°‘ä¸€å€‹ç‚ºç©ºï¼ˆPresence = 0ï¼‰
              - set:
                  agv_port24_empty_count: "${agv_port24_empty_signals.length}"
                  required_port24_empty: 1  # Port 2 æˆ– Port 4 è‡³å°‘ä¸€å€‹è¦ç©º
                  agv_port24_verified: "${agv_port24_empty_count >= required_port24_empty}"

              # èª¿è©¦ï¼šè¨˜éŒ„ AGV Presence æª¢æŸ¥çµæœ
              - notify:
                  message: "Room ${room.id}: AGV ${agv.name} port13_empty=${agv_port13_empty_count}, port24_empty=${agv_port24_empty_count}, verified=${agv_port13_verified && agv_port24_verified}"

              # å¦‚æœ AGV Port 1ã€3 éƒ½ç‚ºç©ºä¸” Port 2ã€4 è‡³å°‘ä¸€å€‹ç‚ºç©ºï¼Œéæ­·6å€‹æ³¡è—¥æ©Ÿ Station
              - if:
                  condition: "${agv_port13_verified && agv_port24_verified}"
                  then:
                    # éæ­·6å€‹ Stationï¼ˆæ³¡è—¥æ©Ÿ A-Fï¼‰
                    - for:
                        in: "${stations}"
                        as: station
                        do:
                          # æŸ¥è©¢è©² Station çš„æ³¡è—¥å®Œæˆè¼‰å…·ï¼ˆ1å€‹ Portï¼Œé€éportéæ¿¾ï¼‰
                          - query:
                              target: carriers
                              where:
                                room_id: "${room.id}"
                                port_in: "${station.ports}"
                                status_id: 403  # æ³¡è—¥å®Œæˆ
                              as: ready_carriers
                              description: "æŸ¥è©¢æ³¡è—¥æ©Ÿ Station ${station.station} æ³¡è—¥å®Œæˆè¼‰å…·"

                          # æª¢æŸ¥æ˜¯å¦æœ‰å®Œæˆè¼‰å…·ï¼ˆç‰¹æ®Šè¨­å‚™ï¼š1æ ¼è™•ç†ï¼‰
                          - set:
                              carrier_count: "${ready_carriers.length}"
                              required_count: 1
                              has_enough_carriers: "${carrier_count >= required_count}"

                          # å¦‚æœè¼‰å…·æ•¸é‡è¶³å¤ ï¼Œæª¢æŸ¥å¯¦éš›æ„Ÿæ¸¬å™¨åœ¨å¸­ä¿¡è™Ÿ
                          - if:
                              condition: "${has_enough_carriers}"
                              then:
                                # æŸ¥è©¢æ³¡è—¥æ©Ÿ Port çš„ Presence ä¿¡è™Ÿï¼ˆåœ¨å¸­ï¼‰
                                - query:
                                    target: eqp_signals
                                    where:
                                      eqp_port_id_in: "${station.ports}"
                                      name_like: "%Presence"
                                      value: "1"  # 1 = æœ‰è¼‰å…·åœ¨å¸­
                                    as: soaker_presence_signals
                                    description: "ç¢ºèªæ³¡è—¥æ©Ÿ ${station.name} æ„Ÿæ¸¬å™¨æœ‰è¼‰å…·åœ¨å¸­"

                                # æª¢æŸ¥æ³¡è—¥æ©Ÿ Presence æ˜¯å¦ç‚º 1
                                - set:
                                    soaker_presence_count: "${soaker_presence_signals.length}"
                                    soaker_presence_verified: "${soaker_presence_count >= required_count}"

                                # æŸ¥è©¢æ³¡è—¥æ©Ÿ Port çš„å…è¨±/å‡ºæ–™ä¿¡è™Ÿ
                                - query:
                                    target: eqp_signals
                                    where:
                                      eqp_port_id_in: "${station.ports}"
                                      name_like: "%Allow%"
                                      value: "1"  # 1 = å…è¨±å‡ºæ–™
                                    as: soaker_allow_signals
                                    description: "ç¢ºèªæ³¡è—¥æ©Ÿ ${station.name} å…è¨±å‡ºæ–™ä¿¡è™Ÿ"

                                # æª¢æŸ¥å…è¨±/å‡ºæ–™ä¿¡è™Ÿæ˜¯å¦ç‚º 1
                                - set:
                                    soaker_allow_count: "${soaker_allow_signals.length}"
                                    soaker_allow_verified: "${soaker_allow_count >= required_count}"

                                # èª¿è©¦ï¼šè¨˜éŒ„æ³¡è—¥æ©Ÿä¿¡è™Ÿæª¢æŸ¥çµæœ
                                - notify:
                                    message: "Room ${room.id}: ${station.name} presence=${soaker_presence_count}, allow=${soaker_allow_count}, verified=${soaker_presence_verified && soaker_allow_verified}"

                                # å¦‚æœæ‰€æœ‰æ¢ä»¶éƒ½æ»¿è¶³ï¼Œæª¢æŸ¥é‡è¤‡ä»»å‹™
                                - if:
                                    condition: "${has_enough_carriers && soaker_presence_verified && soaker_allow_verified}"
                                    then:
                                      # æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨æœªå®Œæˆçš„å–æ–™ä»»å‹™
                                      - query:
                                          target: tasks
                                          where:
                                            work_id: "${station.work_id}"
                                            room_id: "${room.id}"
                                            status_id_in: [0, 1, 2, 3]  # æœªå®Œæˆçš„ç‹€æ…‹
                                          as: existing_tasks
                                          description: "æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨å–æ–™ä»»å‹™"

                                      # å¦‚æœæ²’æœ‰é‡è¤‡ä»»å‹™ï¼Œå‰µå»ºæ–°ä»»å‹™
                                      - if:
                                          condition: "${existing_tasks.length == 0}"
                                          then:
                                            # å‰µå»º Loader AGV å–æ–™ä»»å‹™
                                            - create:
                                                target: task
                                                with:
                                                  type: "loader_take"
                                                  name: "æˆ¿é–“${room.id}æ³¡è—¥æ©Ÿ Station${station.station} å–æ–™"
                                                  description: "${station.name}æ³¡è—¥å®Œæˆï¼ŒAGV Port 1ã€3 éƒ½ç‚ºç©ºï¼ŒPort 2ã€4 è‡³å°‘ä¸€å€‹ç‚ºç©ºï¼Œæ³¡è—¥æ©Ÿ Presence å’Œå…è¨±å‡ºæ–™ä¿¡è™Ÿéƒ½ç‚º 1ï¼ˆå…­é‡é©—è­‰ï¼‰"
                                                  work_id: "${station.work_id}"
                                                  room_id: "${room.id}"
                                                  priority: "${priority}"
                                                  status_id: 1  # PENDING
                                                  parameters:
                                                    station: "${station.station}"
                                                    work_id: "${station.work_id}"
                                                    room_id: "${room.id}"
                                                    equipment_id: "${soaker_equipment_id}"
                                                    ports: "${station.ports}"
                                                    batch_size: "${station.batch_size}"
                                                    model: "${model}"
                                                    target_agv_ports: [2101, 2103]  # Port 1ã€3ï¼ˆå‰æ®µæµç¨‹ç«¯å£ï¼‰
                                                    carrier_count: 1
                                                    carrier_status: 403  # æ³¡è—¥å®Œæˆ
                                                    agv_port13_verified: true  # AGV Port 1ã€3 éƒ½ç‚ºç©ºä½
                                                    agv_port24_verified: true  # AGV Port 2ã€4 è‡³å°‘ä¸€å€‹ç‚ºç©ºä½
                                                    soaker_presence_verified: true  # æ³¡è—¥æ©Ÿ Presence = 1
                                                    soaker_allow_verified: true  # æ³¡è—¥æ©Ÿå…è¨±å‡ºæ–™ = 1
                                                    reason: "æ³¡è—¥æ©Ÿæœ‰æ³¡è—¥å®Œæˆè¼‰å…·ä¸”å…è¨±å‡ºæ–™ï¼ŒAGV Port 1ã€3 éƒ½ç‚ºç©ºä½ï¼ŒPort 2ã€4 è‡³å°‘ä¸€å€‹ç‚ºç©ºä½ï¼ˆå…­é‡é©—è­‰ï¼šè»Ÿé«” + AGV Port1 + AGV Port3 + AGV Port2æˆ–4 + æ³¡è—¥æ©Ÿ Presence + æ³¡è—¥æ©Ÿå…è¨±å‡ºæ–™ï¼‰"
                                                description: "å‰µå»º Loader AGV å–æ–™ä»»å‹™ï¼ˆç‰¹æ®Šè¨­å‚™ï¼Œå«å…­é‡é©—è­‰ï¼‰"
