metadata:
  id: rack_rotation_001
  name: AGV Rack Rotation Flow
  version: 1.1
  description: TAFL v1.1 implementation of rack rotation workflow with preload and rules
  author: TAFL Team
  tags: [rack_rotation, agv, kuka, v1.1]

settings:
  timeout: 1800  # 30 minutes for rotation tasks
  retry_count: 3
  log_level: debug
  parallel_execution: false

preload:
  # Preload target room inlet locations
  - query:
      target: locations
      where:
        type: "room_inlet"
        room_id: [1, 2, 3, 4, 5]
        status: "active"
      store_as: inlet_locations
      comment: "Load all active inlet locations for target rooms"
  
  # Preload racks that need rotation
  - query:
      target: racks
      where:
        side_a_completed: true
        side_b_completed: false
        status: ["ready", "available"]
      store_as: rotation_candidates
      comment: "Load racks that have completed side A and need rotation"
  
  # Preload available AGVs
  - query:
      target: agvs
      where:
        status: "available"
        type: "KUKA400i"
      store_as: available_agvs
      comment: "Load available KUKA AGVs for rotation tasks"

rules:
  # Business logic rules
  rack_needs_rotation:
    condition: "${rack.side_a_completed} and not ${rack.side_b_completed} and ${rack.status} == 'ready'"
    description: "Rack has completed side A work and needs rotation for side B"
  
  location_has_agv:
    condition: "${location.agv_id} != null and ${location.agv_status} == 'available'"
    description: "Location has an available AGV assigned"
  
  agv_is_compatible:
    condition: "${agv.model} == 'KUKA400i' and ${agv.battery_level} >= 30"
    description: "AGV is KUKA400i model with sufficient battery"
  
  # Configuration constants
  target_rooms: [1, 2, 3, 4, 5]
  rotation_angle: 180
  min_battery_level: 30
  max_tasks_per_agv: 5
  
  # Task template with KUKA-specific parameters
  rotation_task_template:
    work_id: 220001
    model: "KUKA400i"
    priority: 7
    type: "rack_rotation"
    metadata:
      rotation_angle: 180
      task_type: "automated_rotation"
      created_by: "tafl_v1.1"
      agv_type: "KUKA400i"

variables:
  created_tasks: 0
  processed_locations: 0
  skipped_racks: 0
  total_racks_found: 0

flow:
  # Initialize counters
  - set: total_racks_found = "${rotation_candidates.length}"
  
  - notify:
      channel: system
      message: "Starting rack rotation process: ${total_racks_found} racks need rotation across ${inlet_locations.length} locations"
      level: info
  
  # Main processing loop - iterate through locations
  - for:
      each: location
      in: ${inlet_locations}
      filter: ${rules.location_has_agv}
      do:
        # Find racks at this location that need rotation
        - for:
            each: rack
            in: ${rotation_candidates}
            filter: ${rules.rack_needs_rotation}
            do:
              # Check if rack is at current location
              - if:
                  condition: "${rack.location_id} == ${location.id}"
                  then:
                    # Find compatible AGV for this location
                    - for:
                        each: agv
                        in: ${available_agvs}
                        filter: ${rules.agv_is_compatible}
                        do:
                          # Check if AGV is at the right location
                          - if:
                              condition: "${agv.id} == ${location.agv_id} and ${agv.current_tasks} < ${rules.max_tasks_per_agv}"
                              then:
                                # Create rotation task
                                - create:
                                    target: task
                                    params:
                                      work_id: ${rules.rotation_task_template.work_id}
                                      agv_id: "${agv.id}"
                                      location_id: "${location.id}"
                                      rack_id: "${rack.id}"
                                      model: ${rules.rotation_task_template.model}
                                      priority: ${rules.rotation_task_template.priority}
                                      metadata:
                                        rotation_angle: ${rules.rotation_angle}
                                        model: ${rules.rotation_task_template.model}
                                        nodes:
                                          - "${location.node_id}"        # Start point
                                          - "${location.node_id + 1}"    # Turning point  
                                          - "${location.node_id}"        # End point
                                        template: ${rules.rotation_task_template}
                                    store_as: rotation_task
                                
                                - set: created_tasks = "${created_tasks} + 1"
                                
                                - notify:
                                    channel: system
                                    message: "Created rotation task ${rotation_task.id} for rack ${rack.id} at location ${location.id} using AGV ${agv.id}"
                                    level: info
                                
                                # Break out of AGV loop after finding one
                                - stop: "Task created, moving to next rack"
                  else:
                    - set: skipped_racks = "${skipped_racks} + 1"
                    - notify:
                        channel: system
                        message: "Skipped rack ${rack.id} - not at location ${location.id}"
                        level: debug
        
        - set: processed_locations = "${processed_locations} + 1"
  
  # Final summary
  - set:
      summary: "Rack rotation completed: ${created_tasks} tasks created, ${processed_locations} locations processed, ${skipped_racks} racks skipped out of ${total_racks_found} total"
  
  - notify:
      channel: system
      message: "${summary}"
      level: info
  
  # Check if any tasks were created
  - if:
      condition: "${created_tasks} == 0"
      then:
        - notify:
            channel: operators
            message: "Warning: No rack rotation tasks were created. Please check system status."
            level: warning
      else:
        - notify:
            channel: operators
            message: "Rack rotation process successful: ${created_tasks} rotation tasks created"
            level: info