metadata:
  id: "rack_rotation_room_inlet_aempty_bwork"
  name: "房間入口架台翻轉（A面空B面待作業）"
  enabled: false
  version: "1.0.0"
  description: "檢查所有房間入口架台，當A面為空（載具已取走）、B面有待作業載具時創建180度翻轉任務"
  author: "TAFL System"
  created_at: "2025-09-16"
  tags: ["rack_rotation", "room_inlet", "automation"]

settings:
  execution_interval: 10  # Execute every 10 seconds

variables:
  work_id: 220001  # KUKA rack rotation work ID for inlet
  rotation_angle: 180
  priority: 5
  model: "KUKA400i"

flow:
  # 查詢所有房間入口位置
  - query:
      target: locations
      where:
        type: "room_inlet"
      as: inlet_locations
      description: "查詢所有房間入口位置"

  # 遍歷每個入口位置
  - for:
      in: "${inlet_locations}"
      as: location
      do:
        # 查詢該位置的架台
        - query:
            target: racks
            where:
              location_id: "${location.id}"
            as: racks_at_location
            description: "查詢位置 ${location.id} 的架台"

        # 如果該位置有架台
        - if:
            condition: "${racks_at_location}"
            then:
              # 取得第一個架台
              - set:
                  rack: "${racks_at_location[0]}"

              # 查詢架台上的載具（A面：1-16，B面：17-32）
              - query:
                  target: carriers
                  where:
                    rack_id: "${rack.id}"
                    rack_index_min: 1
                    rack_index_max: 16
                  as: a_side_carriers
                  description: "查詢架台 ${rack.id} A面載具"

              - query:
                  target: carriers
                  where:
                    rack_id: "${rack.id}"
                    rack_index_min: 17
                    rack_index_max: 32
                  as: b_side_carriers
                  description: "查詢架台 ${rack.id} B面載具"

              # 查詢B面待作業載具（直接在數據庫層面過濾 status_id != 8）
              - query:
                  target: carriers
                  where:
                    rack_id: "${rack.id}"
                    rack_index_min: 17
                    rack_index_max: 32
                    status_id_not: 8  # 排除已完成的載具
                  as: b_side_work_carriers
                  description: "查詢架台 ${rack.id} B面待作業載具"

              # 計算側面狀態（簡化邏輯，參考房間出口模式）
              - set:
                  a_side_count: "${a_side_carriers.length}"
                  b_side_count: "${b_side_carriers.length}"
                  a_side_empty: "${a_side_count == 0}"
                  b_side_work_count: "${b_side_work_carriers.length}"
                  b_side_has_work: "${b_side_work_count > 0}"

              # 檢查是否滿足翻轉條件（A面空、B面有待作業載具）
              - if:
                  condition: "${a_side_empty} && ${b_side_has_work}"
                  then:
                    # 檢查是否已存在未完成的翻轉任務
                    - query:
                        target: tasks
                        where:
                          work_id: "${work_id}"
                          rack_id: "${rack.id}"
                          status_id_in: [0, 1, 2, 3]  # 未完成的狀態
                        as: existing_tasks
                        description: "檢查是否已存在翻轉任務"

                    # 如果沒有重複任務，創建新任務
                    - if:
                        condition: "${existing_tasks.length == 0}"
                        then:
                          # 創建架台翻轉任務（直接使用 location.rotation_node_id 作為旋轉點）
                          - create:
                              target: task
                              with:
                                type: "rack_rotation"
                                name: "房間${location.room_id}入口架台翻轉"
                                description: "A面為空（載具已取走），B面有${b_side_work_count}個載具待作業"
                                work_id: "${work_id}"
                                rack_id: "${rack.id}"
                                room_id: "${location.room_id}"
                                priority: "${priority}"
                                status_id: 1  # PENDING
                                parameters:
                                  rack_name: "${rack.name}"
                                  rack_id: "${rack.id}"
                                  location_name: "${location.name}"
                                  location_id: "${location.id}"
                                  room_id: "${location.room_id}"
                                  rotation_angle: "${rotation_angle}"
                                  reason: "A面為空（載具已取走），B面有待作業載具"
                                  model: "${model}"
                                  # nodes: [起點, 轉向點, 終點] - 使用 location 配置的旋轉點
                                  nodes: ["${location.node_id}", "${location.rotation_node_id}", "${location.node_id}"]
                                  a_side_count: "${a_side_count}"
                                  b_side_count: "${b_side_count}"
                                  b_side_work_count: "${b_side_work_count}"
                              description: "創建架台翻轉任務"

  # 流程完成