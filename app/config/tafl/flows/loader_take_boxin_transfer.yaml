metadata:
  id: "loader_take_boxin_transfer"
  name: "Loader AGV å¾å…¥å£å‚³é€ç®±å–æ–™"
  enabled: true
  version: "1.0.0"
  description: "æª¢æŸ¥å…¥å£å‚³é€ç®±å¾…è™•ç†è¼‰å…·ï¼Œå‰µå»º Loader AGV å–æ–™ä»»å‹™ï¼ˆæ¨™æº–è¨­å‚™ï¼‰"
  author: "TAFL System"
  created_at: "2025-10-16"
  tags: ["loader", "transfer", "take", "automation"]

settings:
  execution_interval: 12  # Execute every 12 seconds

variables:
  priority: 5  # ä¿®æ­£ï¼špriority å¿…é ˆåœ¨ 1-10 ç¯„åœå…§
  model: "Loader"
  entrance_equipment_id: 201
  # 2å€‹ Station é…ç½®ï¼ˆæ¨™æº–è¨­å‚™ï¼ŒLoader ä¸€æ¬¡æ“ä½œ1æ ¼ï¼‰
  stations:
    - station: 1
      work_id: 2010101
      ports: [2011, 2012]
      batch_size: 1  # Loader: 1æ ¼æ“ä½œ
      name: "å…¥å£ç®±01"
    - station: 3
      work_id: 2010301
      ports: [2013, 2014]
      batch_size: 1  # Loader: 1æ ¼æ“ä½œ
      name: "å…¥å£ç®±03"

flow:
  # èª¿è©¦ï¼šæµç¨‹é–‹å§‹
  - notify:
      message: "ğŸ” é–‹å§‹åŸ·è¡Œ loader_take_boxin_transfer æµç¨‹"

  # æŸ¥è©¢æ‰€æœ‰æˆ¿é–“
  - query:
      target: rooms
      where:
        enable: 1
      as: active_rooms
      description: "æŸ¥è©¢æ‰€æœ‰å•Ÿç”¨çš„æˆ¿é–“"

  # èª¿è©¦ï¼šæˆ¿é–“æ•¸é‡
  - notify:
      message: "æ‰¾åˆ° ${active_rooms.length} å€‹å•Ÿç”¨çš„æˆ¿é–“"

  # éæ­·æ¯å€‹æˆ¿é–“
  - for:
      in: "${active_rooms}"
      as: room
      do:
        # èª¿è©¦ï¼šé€²å…¥æˆ¿é–“è¿´åœˆ
        - notify:
            message: "ğŸ“ è™•ç†æˆ¿é–“ ${room.id} (${room.name})"
        # æŸ¥è©¢ Loader AGV (AGVè¡¨ç„¡room_idæ¬„ä½ï¼Œä½¿ç”¨modeléæ¿¾)
        - query:
            target: agvs
            where:
              model: "Loader"
              enable: 1
            as: loader_agvs
            description: "æŸ¥è©¢æ‰€æœ‰ Loader AGV"

        # éæ­·æ¯å€‹ Loader AGV
        - for:
            in: "${loader_agvs}"
            as: agv
            do:
              # æŸ¥è©¢ AGV Port 1ã€3 çš„è¼‰å…·æ•¸é‡ï¼ˆå‰æ®µæµç¨‹ç«¯å£ï¼‰
              - query:
                  target: carriers
                  where:
                    port_in: [2101, 2103]  # Port 1ã€3ï¼ˆCarrier æ²’æœ‰ agv_idï¼Œç”¨ port_id æŸ¥è©¢ï¼‰
                    room_id: "${room.id}"  # éæ¿¾ç•¶å‰æˆ¿é–“çš„è¼‰å…·
                  as: port13_carriers
                  description: "æŸ¥è©¢ AGV Port 1ã€3 è¼‰å…·ï¼ˆç•¶å‰æˆ¿é–“ï¼‰"

              # è¨ˆç®— Port 1ã€3 ç©ºä½
              - set:
                  port13_carrier_count: "${port13_carriers.length}"
                  port13_capacity: 2  # Port 1ã€3 ç¸½å®¹é‡
                  required_space: 1  # Loader: 1æ ¼æ“ä½œ
                  required_agv_empty_ports: 2  # Port 1 å’Œ Port 3 éƒ½è¦ç©º
              - set:
                  available_space_port13: "${port13_capacity - port13_carrier_count}"
              - set:
                  agv_has_space: "${available_space_port13 >= required_space}"

              # èª¿è©¦ï¼šè¨˜éŒ„ç©ºä½æƒ…æ³
              - notify:
                  message: "Room ${room.id}: AGV ${agv.name} port13_carriers=${port13_carrier_count}, available=${available_space_port13}, has_space=${agv_has_space}"

              # å¦‚æœ AGV è»Ÿé«”ç‹€æ…‹æœ‰ç©ºä½ï¼Œæª¢æŸ¥ç¡¬é«” Presence ä¿¡è™Ÿ
              - if:
                  condition: "${agv_has_space}"
                  then:
                    # æŸ¥è©¢ AGV Port 1ã€3 çš„ Presence ä¿¡è™Ÿï¼ˆç¢ºèªä½ç½®ç‚ºç©ºï¼‰
                    - query:
                        target: eqp_signals
                        where:
                          eqp_port_id_in: [2101, 2103]  # AGV Port 1ã€3
                          name_like: "%Presence"
                          value: "0"  # 0 = ç„¡è¼‰å…·åœ¨å¸­ï¼ˆç©ºä½ï¼‰
                        as: agv_empty_presence_signals
                        description: "ç¢ºèª AGV Port 1ã€3 æ„Ÿæ¸¬å™¨ç„¡è¼‰å…·åœ¨å¸­"

                    # æª¢æŸ¥ AGV Port 1ã€3 æ˜¯å¦éƒ½æ˜¯ç©ºä½ï¼ˆPresence = 0ï¼‰
                    - set:
                        agv_presence_empty_count: "${agv_empty_presence_signals.length}"
                        agv_presence_verified: "${agv_presence_empty_count >= required_agv_empty_ports}"  # å¿…é ˆå…©å€‹éƒ½ç©º

                    # èª¿è©¦ï¼šè¨˜éŒ„ AGV Presence æª¢æŸ¥çµæœ
                    - notify:
                        message: "Room ${room.id}: AGV ${agv.name} presence_empty_count=${agv_presence_empty_count}, presence_verified=${agv_presence_verified}"

                    # å¦‚æœ AGV Port 1ã€3 ç¡¬é«”ç¢ºèªæœ‰ç©ºä½ï¼Œæ‰æª¢æŸ¥å…¥å£å‚³é€ç®±
                    - if:
                        condition: "${agv_presence_verified}"
                        then:
                          # éæ­·2å€‹ Station
                          - for:
                              in: "${stations}"
                              as: station
                              do:
                                # æŸ¥è©¢è©² Station çš„å¾…è™•ç†è¼‰å…·ï¼ˆ2å€‹ Portï¼Œé€éport_inéæ¿¾ï¼‰
                                - query:
                                    target: carriers
                                    where:
                                      room_id: "${room.id}"
                                      port_in: "${station.ports}"
                                      status_id: 102  # é€²å…¥å…¥å£å‚³é€ç®±å®Œæˆ
                                    as: ready_carriers
                                    description: "æŸ¥è©¢å…¥å£ç®± Station ${station.station} å¾…è™•ç†è¼‰å…·"

                                # æª¢æŸ¥è¼‰å…·æ•¸é‡æ˜¯å¦è¶³å¤ ï¼ˆéœ€è¦è‡³å°‘1å€‹ï¼‰
                                - set:
                                    carrier_count: "${ready_carriers.length}"
                                    required_count: "${station.batch_size}"
                                    required_boxin_ports: 2  # æ¯å€‹ Station çš„å…©å€‹ Port éƒ½è¦æœ‰è¼‰å…·
                                    has_enough_carriers: "${carrier_count >= required_count}"

                                # å¦‚æœè¼‰å…·æ•¸é‡è¶³å¤ ï¼Œæª¢æŸ¥å¯¦éš›æ„Ÿæ¸¬å™¨åœ¨å¸­ä¿¡è™Ÿ
                                - if:
                                    condition: "${has_enough_carriers}"
                                    then:
                                      # æŸ¥è©¢é€™äº› Port çš„ Presence ä¿¡è™Ÿï¼ˆå…©å€‹ Port éƒ½è¦æœ‰è¼‰å…·ï¼‰
                                      - query:
                                          target: eqp_signals
                                          where:
                                            eqp_port_id_in: "${station.ports}"
                                            name_like: "%Presence"
                                            value: "1"  # 1 = æœ‰è¼‰å…·åœ¨å¸­
                                          as: occupied_presence_signals
                                          description: "ç¢ºèªå…¥å£ç®±æ„Ÿæ¸¬å™¨æœ‰è¼‰å…·åœ¨å¸­"

                                      # æª¢æŸ¥å…©å€‹ Port çš„ Presence æ˜¯å¦éƒ½æ˜¯ 1
                                      - set:
                                          presence_check_count: "${occupied_presence_signals.length}"
                                          presence_all_occupied: "${presence_check_count >= required_boxin_ports}"  # å¿…é ˆå…©å€‹éƒ½æœ‰è¼‰å…·

                                      # å¦‚æœå…¥å£ç®±è»Ÿé«”ç‹€æ…‹å’Œç¡¬é«”æ„Ÿæ¸¬å™¨éƒ½ç¢ºèªæœ‰è¼‰å…·ï¼Œæª¢æŸ¥é‡è¤‡ä»»å‹™
                                      - if:
                                          condition: "${has_enough_carriers && presence_all_occupied}"
                                          then:
                                            # æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨æœªå®Œæˆçš„å–æ–™ä»»å‹™
                                            - query:
                                                target: tasks
                                                where:
                                                  work_id: "${station.work_id}"
                                                  room_id: "${room.id}"
                                                  status_id_in: [0, 1, 2, 3]  # æœªå®Œæˆçš„ç‹€æ…‹
                                                as: existing_tasks
                                                description: "æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨å–æ–™ä»»å‹™"

                                            # å¦‚æœæ²’æœ‰é‡è¤‡ä»»å‹™ï¼Œå‰µå»ºæ–°ä»»å‹™
                                            - if:
                                                condition: "${existing_tasks.length == 0}"
                                                then:
                                                  # å‰µå»º Loader AGV å–æ–™ä»»å‹™
                                                  - create:
                                                      target: task
                                                      with:
                                                        type: "loader_take"
                                                        name: "æˆ¿é–“${room.id}å…¥å£ç®± Station${station.station} å–æ–™"
                                                        description: "å…¥å£ç®± ${station.name} å…©å€‹ Port éƒ½æœ‰è¼‰å…·ï¼ˆ${carrier_count}å€‹ï¼‰ï¼ŒAGV Port 1ã€3 éƒ½ç‚ºç©ºä½ï¼Œé›™é‡æ„Ÿæ¸¬å™¨ç¢ºèªï¼ˆå…¥å£ç®±å…©å€‹ Port + AGV å…©å€‹ Portï¼‰"
                                                        work_id: "${station.work_id}"
                                                        room_id: "${room.id}"
                                                        priority: "${priority}"
                                                        status_id: 1  # PENDING
                                                        parameters:
                                                          station: "${station.station}"
                                                          work_id: "${station.work_id}"
                                                          room_id: "${room.id}"
                                                          equipment_id: "${entrance_equipment_id}"
                                                          ports: "${station.ports}"
                                                          batch_size: "${station.batch_size}"
                                                          model: "${model}"
                                                          carrier_count: "${carrier_count}"
                                                          target_agv_ports: [2101, 2103]  # Port 1ã€3ï¼ˆå‰æ®µæµç¨‹ç«¯å£ï¼‰
                                                          port13_available: "${available_space_port13}"
                                                          agv_presence_verified: true  # AGV Port 1ã€3 Presence ç¢ºèªéƒ½ç‚ºç©ºä½
                                                          boxin_presence_verified: true  # å…¥å£ç®±å…©å€‹ Port Presence ç¢ºèªéƒ½æœ‰è¼‰å…·
                                                          reason: "å…¥å£ç®±å…©å€‹ Port éƒ½æœ‰å¾…è™•ç†è¼‰å…·ï¼ŒAGV Port 1ã€3 éƒ½ç‚ºç©ºä½ï¼Œå››é‡æ„Ÿæ¸¬å™¨ç¢ºèªï¼ˆè»Ÿé«” + AGV Port1 Presence + AGV Port3 Presence + å…¥å£ç®±å…©å€‹ Port Presenceï¼‰"
                                                      description: "å‰µå»º Loader AGV å–æ–™ä»»å‹™ï¼ˆæ¨™æº–è¨­å‚™ï¼Œå«é›™é‡æ„Ÿæ¸¬å™¨é©—è­‰ï¼‰"
