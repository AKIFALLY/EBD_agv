metadata:
  id: example_001
  name: TAFL Integration Test v1.1
  version: 1.1
  description: Test flow demonstrating TAFL v1.1 features with preload and rules
  author: TAFL Team
  tags: [example, test, v1.1, preload, rules]

settings:
  timeout: 300
  retry_count: 2
  log_level: info

preload:
  # Preload all available locations for the target room
  - query:
      target: locations
      where:
        room_id: 1
        status: available
      store_as: available_locations
      comment: "Load available locations for processing"
  
  # Preload racks that need attention
  - query:
      target: racks
      where:
        status: ["needs_rotation", "ready_for_pickup"]
      store_as: target_racks
      comment: "Load racks requiring processing"

rules:
  # Business condition rules
  location_has_capacity:
    condition: "${location.current_tasks} < ${location.max_capacity}"
    description: "Check if location can accept more tasks"
  
  high_priority_rack:
    condition: "${rack.priority} >= 5"
    description: "Identify high priority racks"
  
  # Configuration values
  max_tasks_per_run: 10
  default_priority: 5
  notification_channels: ["system", "operators"]
  
  # Task template
  task_template:
    priority: 5
    type: "automated"
    created_by: "tafl_executor_v1.1"
    metadata:
      version: "1.1"
      auto_generated: true

variables:
  task_count: 0
  processed_locations: 0
  message: ""

flow:
  # Simplified flow using preloaded data and rules
  - if:
      condition: "${available_locations.length} > 0"
      then:
        - for:
            each: location
            in: ${available_locations}
            filter: ${rules.location_has_capacity}
            do:
              - for:
                  each: rack
                  in: ${target_racks}
                  filter: ${rules.high_priority_rack}
                  do:
                    - if:
                        condition: "${rack.location_id} == ${location.id}"
                        then:
                          - create:
                              target: task
                              params:
                                location_id: "${location.id}"
                                rack_id: "${rack.id}"
                                name: "Process rack ${rack.id} at location ${location.id}"
                                template: ${rules.task_template}
                              store_as: created_task
                          
                          - set: task_count = "${task_count} + 1"
                          
                          - notify:
                              channel: system
                              message: "Created task ${created_task.id} for rack ${rack.id}"
                              level: info
              
              - set: processed_locations = "${processed_locations} + 1"
        
        - set: 
            message: "Processing completed: ${task_count} tasks created for ${processed_locations} locations"
      else:
        - set: message = "No available locations found for processing"
        - notify:
            channel: system
            message: "${message}"
            level: warning
  
  - notify:
      channel: system
      message: "${message}"
      level: info