metadata:
  id: "unloader_put_boxout_transfer"
  name: "Unloader AGV 放料到出口傳送箱"
  enabled: true
  version: "1.0.0"
  description: "檢查 Unloader AGV 車上載具和出口傳送箱空位，創建放料任務（批量4格）"
  author: "TAFL System"
  created_at: "2025-10-16"
  tags: ["unloader", "transfer", "put", "automation"]

settings:
  execution_interval: 12  # Execute every 12 seconds

variables:
  priority: 4  # 修正：priority 必須在 1-10 範圍內
  model: "Unloader"
  target_room_id: 2  # 出口傳送箱 202 所屬房間
  boxout_equipment_id: 202
  unloader_eqp_id: 211  # UnloaderAGV 設備 ID
  unloader_ports: [2111, 2112, 2113, 2114]  # UnloaderAGV 的 4 個 Port
  # 固定 Station 配置（只有 Station 01）
  station: 1
  work_id: 2020102
  ports: [2021, 2022, 2023, 2024]  # 4個 Port (完整 Port ID: 設備202 + Port號1-4)
  batch_size: 4

flow:
  # 只查詢目標房間（出口傳送箱所在房間）
  - query:
      target: rooms
      where:
        id: "${target_room_id}"
        enable: 1
      as: target_rooms
      description: "查詢出口傳送箱所在房間"

  # 遍歷目標房間（實際上只會有一個）
  - for:
      in: "${target_rooms}"
      as: room
      do:
        # 查詢 Unloader AGV (AGV表無room_id欄位，使用model過濾)
        - query:
            target: agvs
            where:
              model: "Unloader"
              enable: 1
            as: unloader_agvs
            description: "查詢所有 Unloader AGV"

        # 遍歷每個 Unloader AGV
        - for:
            in: "${unloader_agvs}"
            as: agv
            do:
              # 查詢 UnloaderAGV Port 上的載具（需要至少4個，且為入口傳送箱完成狀態）
              - query:
                  target: carriers
                  where:
                    port_in: "${unloader_ports}"
                    status_id: 201  # 入口傳送箱完成
                  as: agv_carriers
                  description: "查詢 UnloaderAGV Port 上入口傳送箱完成的載具"

              # 檢查載具數量
              - set:
                  agv_carrier_count: "${agv_carriers.length}"
                  required_count: "${batch_size}"
                  has_enough_carriers: "${agv_carrier_count >= required_count}"

              # 如果 AGV 有足夠載具，檢查出口傳送箱空位
              - if:
                  condition: "${has_enough_carriers}"
                  then:
                    # 查詢出口傳送箱 Station 01 空位（4個 Port）
                    - query:
                        target: eqp_ports
                        where:
                          equipment_id: "${boxout_equipment_id}"
                          port_in: "${ports}"
                          status: "empty"
                        as: empty_ports
                        description: "查詢出口傳送箱 Station 01 空位"

                    # 檢查空位數量（需要4格全空）
                    - set:
                        empty_count: "${empty_ports.length}"
                        required_space: "${batch_size}"
                        has_enough_space: "${empty_count >= required_space}"

                    # 檢查實際感測器在席信號（確保硬體也確認無載具）
                    - if:
                        condition: "${has_enough_space}"
                        then:
                          # 查詢這些 Port 的 Presence 信號
                          - query:
                              target: eqp_signals
                              where:
                                eqp_port_id_in: "${ports}"
                                name_like: "%Presence"
                                value: "0"  # 0 = 無載具在席
                              as: empty_presence_signals
                              description: "確認感測器無載具在席"

                          # 檢查是否所有 Port 的 Presence 都是 0
                          - set:
                              presence_check_count: "${empty_presence_signals.length}"
                              presence_all_clear: "${presence_check_count >= required_space}"

                          # 如果軟體狀態和硬體感測器都確認空位，檢查重複任務
                          - if:
                              condition: "${has_enough_space && presence_all_clear}"
                              then:
                                # 檢查是否已存在未完成的放料任務
                                - query:
                                    target: tasks
                                    where:
                                      work_id: "${work_id}"
                                      room_id: "${room.id}"
                                      status_id_in: [0, 1, 2, 3]  # 未完成的狀態
                                    as: existing_tasks
                                    description: "檢查是否已存在放料任務"

                                # 如果沒有重複任務，創建新任務
                                - if:
                                    condition: "${existing_tasks.length == 0}"
                                    then:
                                      # 創建 Unloader AGV 放料任務
                                      - create:
                                          target: task
                                          with:
                                            type: "unloader_put"
                                            name: "房間${room.id}出口傳送箱 Station${station} 放料"
                                            description: "AGV 有${agv_carrier_count}個載具，出口傳送箱有${empty_count}格空位，感測器確認無載具（批量4格）"
                                            work_id: "${work_id}"
                                            room_id: "${room.id}"
                                            priority: "${priority}"
                                            status_id: 1  # PENDING
                                            parameters:
                                              station: "${station}"
                                              work_id: "${work_id}"
                                              room_id: "${room.id}"
                                              equipment_id: "${boxout_equipment_id}"
                                              ports: "${ports}"
                                              batch_size: "${batch_size}"
                                              model: "${model}"
                                              carrier_count: "${agv_carrier_count}"
                                              presence_verified: true
                                              reason: "AGV 有載具，出口傳送箱有空位，感測器確認無載具（雙重驗證）"
                                          description: "創建 Unloader AGV 放料任務（批量4格，含感測器驗證）"
