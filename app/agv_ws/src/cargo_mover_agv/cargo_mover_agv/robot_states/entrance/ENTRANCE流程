ENTRANCE æµç¨‹ (å…¥å£æµç¨‹) - Cargo Mover AGV
===========================================

## ğŸ“‹ æµç¨‹æ¦‚è¿°
ENTRANCE æµç¨‹è² è²¬å°‡ Rack ä¸Šçš„è²¨ç‰©å–å‡ºä¸¦æ”¾å…¥å‚³é€ç®±ç³»çµ±ï¼Œæ˜¯ AGV çš„å…¥å£ä½œæ¥­æµç¨‹ã€‚

## ğŸ”„ å®Œæ•´æµç¨‹åœ–

1. TransferVisionPositionState (å‚³é€ç®±è¦–è¦ºå®šä½)
   â†“
2. TransferCheckEmptyState (æª¢æŸ¥å‚³é€ç®±ç©ºä½ + é¸æ“‡å¯ç”¨ Port)
   â†“
3. SelectRackPortState (é¸æ“‡ Rack Port)
   â†“
4. CheckRackSideState (æª¢æŸ¥ Rack æ–¹å‘)
   â†“
5. WaitRotationState (ç­‰å¾… Rack æ—‹è½‰) [å¦‚éœ€è¦]
   â†“
6. RackVisionPositionState (Rack è¦–è¦ºå®šä½)
   â†“
7. TakeRackPortState (å¾ Rack å–è²¨ç‰©)
   â†“
8. PutTransferState (æ”¾å…¥å‚³é€ç®±)
   â†“
9. UPDATE_DATABASE (æ›´æ–°è³‡æ–™åº«)
   â†“
10. CheckRackSideState (æª¢æŸ¥æ˜¯å¦é‚„æœ‰å…¶ä»–è²¨ç‰©éœ€è¦è™•ç†)
    â†“
11. å¾ªç’°æˆ– CompleteState (å®Œæˆ)

## ğŸ“ å„ç‹€æ…‹è©³ç´°èªªæ˜

### 1. TransferVisionPositionState
- **åŠŸèƒ½**: å‚³é€ç®±è¦–è¦ºå®šä½
- **ç›®æ¨™**: ç¢ºä¿æ©Ÿå™¨äººèƒ½æ­£ç¢ºè­˜åˆ¥å‚³é€ç®±ä½ç½®
- **ä¸‹ä¸€æ­¥**: TransferCheckEmptyState

### 2. TransferCheckEmptyState
- **åŠŸèƒ½**: æª¢æŸ¥å‚³é€ç®±ç©ºä½ç‹€æ…‹
- **ä¸»è¦é‚è¼¯**:
  - æŸ¥è©¢ EQP ä¿¡è™Ÿ (eqp_id: room_id*100+1, port_address: room_id*1000+10)
  - æª¢æŸ¥ Port 1-4 çš„ç©ºä½ç‹€æ…‹
  - é¸æ“‡å¯ç”¨çš„ç©ºä½ (å„ªå…ˆé †åº: Port 1 â†’ 2 â†’ 3 â†’ 4)
  - æ›´æ–° context.boxin_number
- **8-bit é€šè¨Šæ­¥é©Ÿ**:
  1. WRITE_VAILD â†’ WRITE_PORT_NUMBER â†’ WAIT_LOAD_REQ â†’ WRITE_TR_REQ â†’ WAIT_READY
- **ä¸‹ä¸€æ­¥**: SelectRackPortState

### 3. SelectRackPortState
- **åŠŸèƒ½**: é¸æ“‡è¦è™•ç†çš„ Rack Port
- **é‚è¼¯**: æŸ¥è©¢ Rack ID 123 ä¸Šçš„ Carrierï¼Œé¸æ“‡æœ€å°çš„ rack_index
- **ä¸‹ä¸€æ­¥**: RackVisionPositionState æˆ– CompleteState (ç„¡ Carrier)

### 4. CheckRackSideState
- **åŠŸèƒ½**: æª¢æŸ¥ Rack æ–¹å‘æ˜¯å¦æ­£ç¢º
- **é‚è¼¯**:
  - Port 1-16: éœ€è¦ A é¢ (direction = 0)
  - Port 17-32: éœ€è¦ B é¢ (direction = 180)
- **ä¸‹ä¸€æ­¥**: 
  - æ–¹å‘æ­£ç¢º â†’ TransferCheckEmptyState
  - éœ€è¦æ—‹è½‰ â†’ WaitRotationState

### 5. WaitRotationState (æ¢ä»¶æ€§)
- **åŠŸèƒ½**: ç­‰å¾… Rack æ—‹è½‰åˆ°æ­£ç¢ºæ–¹å‘
- **è§¸ç™¼æ¢ä»¶**: Rack æ–¹å‘èˆ‡ç›®æ¨™ Port ä¸åŒ¹é…
- **ä¸‹ä¸€æ­¥**: TransferCheckEmptyState

### 6. RackVisionPositionState
- **åŠŸèƒ½**: Rack è¦–è¦ºå®šä½
- **é‚è¼¯**:
  - Port 1-8, 17-24: ä¸Šå±¤æ‹ç…§ (PHOTO_RACK_UP)
  - Port 9-16, 25-32: ä¸‹å±¤æ‹ç…§ (PHOTO_RACK_DOWN)
- **ä¸‹ä¸€æ­¥**: TakeRackPortState

### 7. TakeRackPortState
- **åŠŸèƒ½**: å¾ Rack å–å‡ºè²¨ç‰©
- **PGNO**: ACTION_FROM + RACK_IN_POSITION + NONE_POSITION
- **æ­¥é©Ÿ**: IDLE â†’ CHECK_IDLE â†’ WRITE_CHG_PARAMTER â†’ WRITE_CHG_PARA â†’ CHECK_CHG_PARA â†’ WRITE_PGNO â†’ CHECK_PGNO â†’ ACTING â†’ FINISH
- **ä¸‹ä¸€æ­¥**: PutTransferState

### 8. PutTransferState
- **åŠŸèƒ½**: å°‡è²¨ç‰©æ”¾å…¥å‚³é€ç®±
- **PGNO**: ACTION_TO + NONE_POSITION + BOXIN_POSITION
- **æ­¥é©Ÿ**: åŒ TakeRackPortState çš„æ©Ÿå™¨äººæ“ä½œæ­¥é©Ÿ
- **å®Œæˆå¾Œ**: è¨­å®š context.boxin_buffer = context.get_boxin_port
- **ä¸‹ä¸€æ­¥**: UPDATE_DATABASE

### 9. UPDATE_DATABASE
- **åŠŸèƒ½**: æ›´æ–° Carrier è³‡æ–™åº«
- **æ›´æ–°å…§å®¹**:
  - carrier.room_id = context.get_room_id
  - carrier.rack_id = 0 (å¾ Rack ç§»é™¤)
  - carrier.port_id = port_id_address + context.get_boxin_port
  - carrier.rack_index = 0
  - carrier.status_id = 1
- **ä¸‹ä¸€æ­¥**: CheckRackSideState

### 10. å¾ªç’°æª¢æŸ¥
- **é‚è¼¯**: æª¢æŸ¥æ˜¯å¦é‚„æœ‰å…¶ä»– Carrier éœ€è¦è™•ç†
- **ç¹¼çºŒæ¢ä»¶**: é‚„æœ‰ Carrier åœ¨ Rack ä¸Š
- **çµæŸæ¢ä»¶**: ç„¡æ›´å¤š Carrier â†’ CompleteState

## ğŸ”§ é—œéµåƒæ•¸

### Port é…ç½®
- **å‚³é€ç®± Port**: room_id*1000+11 åˆ° room_id*1000+14 (port_address + 1-4)
- **EQP ID**: room_id*100+1 (å‚³é€ç®±è¨­å‚™)
- **Rack ID**: 123

### ç‹€æ…‹è®Šæ•¸
- **context.boxin_number**: é¸å®šçš„å‚³é€ç®± Port ç·¨è™Ÿ (1-4)
- **context.get_boxin_port**: åŒ boxin_number
- **context.get_rack_port**: é¸å®šçš„ Rack Port ç·¨è™Ÿ
- **context.carrier_id**: ç•¶å‰è™•ç†çš„ Carrier ID
- **context.boxin_buffer**: å‚³é€ç®±ç·©è¡å€ç‹€æ…‹

### ç©ºä½æª¢æŸ¥é‚è¼¯
```
Port 1 ç©º â†’ é¸æ“‡ Port 1
Port 1 æ»¿, Port 2 ç©º â†’ é¸æ“‡ Port 2  
Port 1-2 æ»¿, Port 3 ç©º â†’ é¸æ“‡ Port 3
Port 1-3 æ»¿, Port 4 ç©º â†’ é¸æ“‡ Port 4
å…¨æ»¿ â†’ ç„¡æ³•åŸ·è¡Œï¼Œé‡ç½®ç‹€æ…‹
```

## âš ï¸ æ³¨æ„äº‹é …

1. **è¦–è¦ºå®šä½**: æ¯æ¬¡æ“ä½œå‰éƒ½éœ€è¦é€²è¡Œè¦–è¦ºå®šä½ç¢ºä¿ç²¾åº¦
2. **8-bit é€šè¨Š**: å¿…é ˆæŒ‰é †åºå®Œæˆæ‰€æœ‰ 8-bit æ­¥é©Ÿ
3. **éŒ¯èª¤è™•ç†**: æ¯å€‹æ­¥é©Ÿéƒ½æœ‰æˆåŠŸ/å¤±æ•—çš„è™•ç†æ©Ÿåˆ¶
4. **è³‡æ–™åº«åŒæ­¥**: æ“ä½œå®Œæˆå¾Œå¿…é ˆæ›´æ–°è³‡æ–™åº«ç‹€æ…‹
5. **Rack æ–¹å‘**: ç¢ºä¿ Rack æ–¹å‘èˆ‡ç›®æ¨™ Port åŒ¹é…
6. **Hokuyo Input æŒçºŒæ›´æ–°**: æ‰€æœ‰ç‹€æ…‹éƒ½æœƒæŒçºŒæ›´æ–° Hokuyo Inputï¼Œç¢ºä¿è¨­å‚™ç‹€æ…‹å³æ™‚åæ˜ 

## ğŸ”„ èˆ‡ EXIT æµç¨‹çš„å·®ç•°

| é …ç›® | ENTRANCE | EXIT |
|------|----------|------|
| æ–¹å‘ | Rack â†’ å‚³é€ç®± | å‚³é€ç®± â†’ Rack |
| æª¢æŸ¥å°è±¡ | å‚³é€ç®±ç©ºä½ | å‚³é€ç®±æœ‰è²¨ |
| Port åœ°å€ | room_id*1000+10 (å‚³é€ç®±) | room_id*1000+20 (å‚³é€ç®±) |
| EQP ID | room_id*100+1 | room_id*100+2 |
| æ©Ÿå™¨äººå‹•ä½œ | FROM Rack TO å‚³é€ç®± | FROM å‚³é€ç®± TO Rack |
| å¾ªç’°é‚è¼¯ | è™•ç†æ‰€æœ‰ Rack è²¨ç‰© | æ ¹æ“š take_transfer_continue |

## ğŸ”§ æœ€æ–°ä¿®å¾© (2025-07-01)

### âœ… Hokuyo Input æŒçºŒæ›´æ–°ä¿®å¾©
**å•é¡Œ**: ENTRANCEæµç¨‹ä¸­çš„ç‹€æ…‹ä½¿ç”¨ `hokuyo_input_updated` æ¨™èªŒé™åˆ¶æ›´æ–°ï¼Œå°è‡´è¨­å‚™ç‹€æ…‹ç„¡æ³•å³æ™‚åæ˜ 

**ä¿®å¾©çš„ç‹€æ…‹**:
1. **TransferCheckEmptyState** - ç§»é™¤ `hokuyo_input_updated` æ¨™èªŒï¼Œæ”¹ç‚ºæŒçºŒæ›´æ–°
2. **TakeRackPortState** - ç§»é™¤ `hokuyo_input_updated` æ¨™èªŒï¼Œæ”¹ç‚ºæŒçºŒæ›´æ–°
3. **PutTransferState** - ç§»é™¤ `hokuyo_input_updated` æ¨™èªŒï¼Œæ”¹ç‚ºæŒçºŒæ›´æ–°

**ä¿®å¾©æ•ˆæœ**:
- ç¢ºä¿ Hokuyo è¨­å‚™ç‹€æ…‹èƒ½å³æ™‚ç›£æ§
- æé«˜ç³»çµ±ç©©å®šæ€§å’ŒéŸ¿æ‡‰æ€§
- èˆ‡ EXIT æµç¨‹ä¿æŒä¸€è‡´çš„æ›´æ–°é‚è¼¯

**ä¿®å¾©å‰**:
```python
if not self.hokuyo_input_updated:
    self.hokuyo_dms_8bit_1.update_hokuyo_input()
    self.hokuyo_input_updated = True  # é™åˆ¶æ›´æ–°
```

**ä¿®å¾©å¾Œ**:
```python
# æ›´æ–° Hokuyo Input - éœ€æŒçºŒæ›´æ–°
self.hokuyo_dms_8bit_1.update_hokuyo_input()  # æŒçºŒæ›´æ–°
```

### ğŸ“ ä¿®å¾©çš„æ–‡ä»¶
- `agv_ws/src/cargo_mover_agv/cargo_mover_agv/robot_states/entrance/transfer_check_empty_state.py`
- `agv_ws/src/cargo_mover_agv/cargo_mover_agv/robot_states/entrance/take_rack_port_state.py`
- `agv_ws/src/cargo_mover_agv/cargo_mover_agv/robot_states/entrance/put_tranfer_state.py`
- `agv_ws/src/cargo_mover_agv/cargo_mover_agv/robot_states/entrance/ENTRANCEæµç¨‹` (æœ¬æ–‡ä»¶)

### ğŸ¯ æ•´é«”ä¸€è‡´æ€§
ç¾åœ¨ ENTRANCE å’Œ EXIT æµç¨‹éƒ½ä½¿ç”¨ç›¸åŒçš„ Hokuyo Input æŒçºŒæ›´æ–°é‚è¼¯ï¼Œç¢ºä¿æ•´å€‹ cargo_mover_agv ç³»çµ±çš„ä¸€è‡´æ€§å’Œç©©å®šæ€§ã€‚
