EXIT æµç¨‹ (å‡ºå£æµç¨‹) - Cargo Mover AGV
===========================================

## ğŸ“‹ æµç¨‹æ¦‚è¿°
EXIT æµç¨‹è² è²¬å°‡å‚³é€ç®±ä¸­çš„è²¨ç‰©å–å‡ºä¸¦æ”¾å…¥ Rack ç³»çµ±ï¼Œæ˜¯ AGV çš„å‡ºå£ä½œæ¥­æµç¨‹ã€‚
æ­¤æµç¨‹å¯¦ç¾é›™é‡å¾ªç’°é‚è¼¯ï¼šå…§å±¤è™•ç†å‚³é€ç®±è²¨ç‰©ï¼Œå¤–å±¤è™•ç† Rack Port é¸æ“‡ã€‚

## ğŸ”„ å®Œæ•´æµç¨‹åœ– (é‡å¤§æµç¨‹é‡æ§‹)

### æµç¨‹è§¸ç™¼
0. IdleState (mission="exit") â†’ TransferVisionPositionState
   â†“

### ä¸»æµç¨‹
1. TransferVisionPositionState (å‚³é€ç®±è¦–è¦ºå®šä½)
   â†“
2. TransferCheckHaveState (æª¢æŸ¥å‚³é€ç®±æœ‰è²¨ + è¨­å®š take_transfer_continue)
   â†“
3. SelectRackPortState (é¸æ“‡ Rack Port)
   â†“
4. RackVisionPositionState (Rack è¦–è¦ºå®šä½)
   â†“
5. TakeTransferState (å–å‚³é€ç®±)
   â†“
6. PutRackPortState (æ”¾åˆ° Rack + æ›´æ–°è³‡æ–™åº«)
   â†“
7. æ ¹æ“š take_transfer_continue åˆ¤æ–·ï¼š
    - True  â†’ å›åˆ°æ­¥é©Ÿ 2 (TransferCheckHaveState) ç¹¼çºŒè™•ç†å‚³é€ç®±
    - False â†’ é€²å…¥ CheckRackSideState è™•ç†ä¸‹ä¸€å€‹ rack port

### å¤–å±¤å¾ªç’° (CheckRackSideState åˆ†æ”¯)
8. CheckRackSideState (æª¢æŸ¥ Rack æ–¹å‘ + é¸æ“‡ä¸‹ä¸€å€‹ Port)
   â†“
9. æ ¹æ“š Rack æ–¹å‘åˆ¤æ–·ï¼š
    - æ–¹å‘æ­£ç¢º â†’ å›åˆ°æ­¥é©Ÿ 2 (TransferCheckHaveState) â­ **æ–°çš„å¾ªç’°è·¯å¾‘**
    - éœ€è¦æ—‹è½‰ â†’ WaitRotationState â†’ RackVisionPositionState â†’ å›åˆ°æ­¥é©Ÿ 5
    â†“
10. å¾ªç’°æˆ– CompleteState (å®Œæˆ)

## âš ï¸ é‡å¤§æµç¨‹è®Šæ›´èªªæ˜
- **CheckRackSideState ç¾åœ¨ç›´æ¥å›åˆ° TransferCheckHaveState**
- **å‰µå»ºäº†æ–°çš„å¤–å±¤å¾ªç’°ï¼šCheckRackSideState â†’ TransferCheckHaveState**
- **å®Œæ•´æ¢å¾©äº† Rack æ–¹å‘æª¢æŸ¥å’Œæ—‹è½‰ç­‰å¾…åŠŸèƒ½**

## ğŸ“ å„ç‹€æ…‹è©³ç´°èªªæ˜

### 1. TransferVisionPositionState
- **åŠŸèƒ½**: å‚³é€ç®±è¦–è¦ºå®šä½
- **å¯¦ç¾**: ç¹¼æ‰¿è‡ª BaseVisionPositionStateï¼Œä½¿ç”¨ PHOTO_BOX_OUT é€²è¡Œè¦–è¦ºå®šä½
- **ç›®æ¨™**: ç¢ºä¿æ©Ÿå™¨äººèƒ½æ­£ç¢ºè­˜åˆ¥å‚³é€ç®±ä½ç½®
- **ç‰¹æ®Šè™•ç†**: é‡ç½® context.rack_photo_up_or_down_buffer = None
- **ä¸‹ä¸€æ­¥**: TransferCheckHaveState

### 2. TransferCheckHaveState
- **åŠŸèƒ½**: æª¢æŸ¥å‚³é€ç®±æœ‰è²¨ç‹€æ…‹ä¸¦è¨­å®šç¹¼çºŒè™•ç†æ¨™èªŒ
- **ä¸»è¦é‚è¼¯**:
  - æŸ¥è©¢ EQP ä¿¡è™Ÿ (eqp_id: room_id*100+2, port_address: room_id*1000+20)
  - æª¢æŸ¥ Port 1-4 çš„æœ‰è²¨ç‹€æ…‹ (port_carriers é™£åˆ—)
  - é¸æ“‡æœ€æ—©çš„ Carrier (æŒ‰ updated_at æ’åº)
  - è¨­å®š take_transfer_continue æ¨™èªŒ (é—œéµé‚è¼¯)
  - æ›´æ–° context.boxout_numberã€get_boxout_portã€carrier_id
- **8-bit é€šè¨Šæ­¥é©Ÿ**:
  1. IDLE â†’ WRITE_VAILD â†’ WRITE_PORT_NUMBER â†’ WAIT_UNLOAD_REQ â†’ WRITE_TR_REQ â†’ WAIT_READY
- **ç‹€æ…‹é‡ç½®**: æ¯æ¬¡é€²å…¥éƒ½æœƒé‡ç½®æ‰€æœ‰æŸ¥è©¢ç‹€æ…‹å’Œè®Šæ•¸
- **ä¸‹ä¸€æ­¥**: SelectRackPortState

### 3. SelectRackPortState â­ **æœ€æ–°æ›´æ–°**
- **åŠŸèƒ½**: é¸æ“‡è¦æ”¾ç½®çš„ Rack Port
- **é‚è¼¯**:
  - æŸ¥è©¢ Rack ID 123 ä¸Šçš„ Carrier
  - å¯¦ç¾éæ¸›é‚è¼¯ï¼šé¸æ“‡ min_rack_index - 1
  - å¦‚æœ min_rack_index == 1ï¼Œé€²å…¥ CompleteState
  - å¦‚æœ RACK ä¸Šæ²’æœ‰ Carrierï¼Œä¹Ÿé€²å…¥ CompleteState
- **æœ€æ–°è®Šæ›´**: ç¾åœ¨é€²å…¥ RackVisionPositionStateï¼Œæ¢å¾©è¦–è¦ºå®šä½æ­¥é©Ÿ
- **ä¸‹ä¸€æ­¥**: RackVisionPositionState æˆ– CompleteState

### 4. RackVisionPositionState â­ **æ¢å¾©è¦–è¦ºå®šä½**
- **åŠŸèƒ½**: Rack è¦–è¦ºå®šä½
- **æ‹ç…§é‚è¼¯**:
  - Port 1-8, 17-24: ä¸Šå±¤æ‹ç…§ (PHOTO_RACK_UP)
  - Port 9-16, 25-32: ä¸‹å±¤æ‹ç…§ (PHOTO_RACK_DOWN)
- **å„ªåŒ–æ©Ÿåˆ¶**:
  - æª¢æŸ¥ context.rack_photo_up_or_down_buffer é¿å…é‡è¤‡æ‹ç…§
  - å¦‚æœæ‹ç…§ä½ç½®ç›¸åŒå‰‡ç›´æ¥è·³åˆ° FINISH
- **æ©Ÿå™¨äººæ­¥é©Ÿ**: IDLE â†’ CHECK_IDLE â†’ WRITE_CHG_PARA â†’ CHECK_CHG_PARA â†’ WRITE_PGNO â†’ CHECK_PGNO â†’ ACTING â†’ FINISH
- **ä¸‹ä¸€æ­¥**: TakeTransferState

### 5. TakeTransferState
- **åŠŸèƒ½**: å¾å‚³é€ç®±å–å‡ºè²¨ç‰©
- **PGNO**: ACTION_FROM + BOX_OUT_POSITION + NONE_POSITION
- **æ©Ÿå™¨äººæ­¥é©Ÿ**: IDLE â†’ CHECK_IDLE â†’ WRITE_CHG_PARAMTER â†’ WRITE_CHG_PARA â†’ CHECK_CHG_PARA â†’ WRITE_PGNO â†’ CHECK_PGNO â†’ ACTING â†’ FINISH
- **ç‹€æ…‹è¿½è¹¤**: ä½¿ç”¨ hokuyo_input_updated æ¨™èªŒé¿å…é‡è¤‡æ›´æ–°
- **ä¸‹ä¸€æ­¥**: PutRackPortState

### 6. PutRackPortState
- **åŠŸèƒ½**: å°‡è²¨ç‰©æ”¾å…¥ Rack ä¸¦æ›´æ–°è³‡æ–™åº«
- **PGNO**: ACTION_TO + NONE_POSITION + RACK_OUT_POSITION
- **æ©Ÿå™¨äººæ­¥é©Ÿ**: IDLE â†’ CHECK_IDLE â†’ WRITE_CHG_PARAMTER â†’ WRITE_CHG_PARA â†’ CHECK_CHG_PARA â†’ WRITE_PGNO â†’ CHECK_PGNO â†’ ACTING â†’ FINISH â†’ UPDATE_DATABASE
- **è³‡æ–™åº«æ›´æ–°**: åœ¨ UPDATE_DATABASE æ­¥é©Ÿä¸­æ›´æ–° Carrier è³‡æ–™åº«
- **æµç¨‹æ§åˆ¶**: åœ¨ UPDATE_DATABASE å®Œæˆå¾Œæ ¹æ“š take_transfer_continue æ±ºå®šä¸‹ä¸€æ­¥
- **ä¸‹ä¸€æ­¥**: TransferCheckHaveState æˆ– CheckRackSideState

### 7. CheckRackSideState â­ **é‡å¤§åŠŸèƒ½æ“´å±•**
- **åŠŸèƒ½**: æª¢æŸ¥ Rack æ–¹å‘ä¸¦é¸æ“‡ä¸‹ä¸€å€‹ Port
- **é›™é‡è·è²¬**:
  1. **Rack æ–¹å‘æª¢æŸ¥**: ç¢ºèªç•¶å‰ Port çš„ Rack æ–¹å‘æ˜¯å¦æ­£ç¢º
  2. **Port é¸æ“‡**: å¯¦ç¾éæ¸›é‚è¼¯é¸æ“‡ä¸‹ä¸€å€‹ Rack Port
- **æŸ¥è©¢é‚è¼¯**:
  - åŒæ™‚æŸ¥è©¢ Carrier å’Œ Rack è³‡è¨Š
  - ä½¿ç”¨ rack_id = 123 é€²è¡ŒæŸ¥è©¢
- **æ–¹å‘åˆ¤æ–·**:
  - Port 1-16: éœ€è¦ A é¢ (direction = 0)
  - Port 17-32: éœ€è¦ B é¢ (direction = 180)
- **Port é¸æ“‡é‚è¼¯**:
  - å¦‚æœ min_rack_index == 1ï¼Œé€²å…¥ CompleteState
  - å¦‚æœæ²’æœ‰ Carrierï¼Œè¨­å®š context.get_rack_port = 32
  - å¦å‰‡è¨­å®š context.get_rack_port = min_rack_index - 1
- **ä¸‹ä¸€æ­¥**:
  - æ–¹å‘æ­£ç¢º â†’ TransferCheckHaveState â­ **æ–°çš„å¾ªç’°è·¯å¾‘**
  - éœ€è¦æ—‹è½‰ â†’ WaitRotationState

### 8. WaitRotationState (æ¢ä»¶æ€§)
- **åŠŸèƒ½**: ç­‰å¾… Rack æ—‹è½‰åˆ°æ­£ç¢ºæ–¹å‘
- **è§¸ç™¼æ¢ä»¶**: Rack æ–¹å‘èˆ‡ç›®æ¨™ Port ä¸åŒ¹é…
- **æ—‹è½‰é‚è¼¯**: æŒçºŒæŸ¥è©¢ Rack ç‹€æ…‹ç›´åˆ°æ–¹å‘æ­£ç¢º
- **ä¸‹ä¸€æ­¥**: RackVisionPositionState

### 9. è³‡æ–™åº«æ›´æ–°èˆ‡æµç¨‹æ§åˆ¶ (åœ¨ PutRackPortState ä¸­)
- **åŠŸèƒ½**: æ›´æ–° Carrier è³‡æ–™åº«ä¸¦æ±ºå®šä¸‹ä¸€æ­¥
- **æ›´æ–°å…§å®¹**:
  - carrier.room_id = context.get_room_id
  - carrier.rack_id = 123
  - carrier.port_id = 0 (å¾å‚³é€ç®±ç§»é™¤)
  - carrier.rack_index = context.get_rack_port
  - carrier.status_id = 2
- **æµç¨‹æ§åˆ¶é‚è¼¯**:
  - take_transfer_continue = True â†’ å›åˆ° TransferCheckHaveState (ç¹¼çºŒè™•ç†å‚³é€ç®±)
  - take_transfer_continue = False â†’ å›åˆ° CheckRackSideState (è™•ç†ä¸‹ä¸€å€‹ Rack Port)

### 10. å¾ªç’°é‚è¼¯èˆ‡çµæŸæ¢ä»¶ â­ **é‡å¤§æµç¨‹é‡æ§‹**
- **å…§å±¤å¾ªç’°**: take_transfer_continue = True æ™‚ï¼Œç¹¼çºŒè™•ç†åŒä¸€å‚³é€ç®±çš„å…¶ä»–è²¨ç‰©
- **å¤–å±¤å¾ªç’°**: take_transfer_continue = False æ™‚ï¼Œé€²å…¥ CheckRackSideState è™•ç†ä¸‹ä¸€å€‹ Rack Port
- **æ–°çš„å¾ªç’°è·¯å¾‘**: CheckRackSideState â†’ TransferCheckHaveState (ç•¶ Rack æ–¹å‘æ­£ç¢ºæ™‚)
- **å®Œæ•´åŠŸèƒ½æ¢å¾©**: æ¢å¾©äº†æ‰€æœ‰ Rack æ–¹å‘æª¢æŸ¥å’Œæ—‹è½‰ç­‰å¾…åŠŸèƒ½
- **é›™é‡ Port é¸æ“‡é‚è¼¯**:
  - SelectRackPortState: åˆå§‹ Port é¸æ“‡
  - CheckRackSideState: å¾ŒçºŒ Port é¸æ“‡ (å¤–å±¤å¾ªç’°)
- **çµæŸæ¢ä»¶**:
  - SelectRackPortState ä¸­ min_rack_index == 1 â†’ CompleteState
  - SelectRackPortState ä¸­ RACK ä¸Šæ²’æœ‰ Carrier â†’ CompleteState
  - CheckRackSideState ä¸­ min_rack_index == 1 â†’ CompleteState

## ğŸ”§ é—œéµåƒæ•¸

### Port é…ç½®
- **å‚³é€ç®± Port**: room_id*1000+21 åˆ° room_id*1000+24 (port_address + 1-4)
- **EQP ID**: room_id*100+2 (å‚³é€ç®±è¨­å‚™)
- **Rack ID**: 123

### ç‹€æ…‹è®Šæ•¸
- **context.boxout_number**: é¸å®šçš„å‚³é€ç®± Port ç·¨è™Ÿ (1-4)
- **context.get_boxout_port**: åŒ boxout_number
- **context.get_rack_port**: é¸å®šçš„ Rack Port ç·¨è™Ÿ
- **context.carrier_id**: ç•¶å‰è™•ç†çš„ Carrier ID
- **context.take_transfer_continue**: æ˜¯å¦ç¹¼çºŒè™•ç†å‚³é€ç®±

### take_transfer_continue é‚è¼¯ (é—œéµæ±ºç­–æ©Ÿåˆ¶)
```python
# åœ¨ TransferCheckHaveState._check_take_transfer_continue() ä¸­å¯¦ç¾
def _check_take_transfer_continue(self, context):
    # æª¢æŸ¥ç›¸é„° Port æ˜¯å¦æœ‰è²¨
    if self.select_boxout_port == 1 and self.port_carriers[1]:  # Port 2 æœ‰è²¨
        context.take_transfer_continue = True
    elif self.select_boxout_port == 3 and self.port_carriers[3]:  # Port 4 æœ‰è²¨
        context.take_transfer_continue = True
    else:
        context.take_transfer_continue = False
```
**é‚è¼¯èªªæ˜**:
- é¸æ“‡ Port 1 ä¸” Port 2 æœ‰è²¨ â†’ ç¹¼çºŒè™•ç†å‚³é€ç®±
- é¸æ“‡ Port 3 ä¸” Port 4 æœ‰è²¨ â†’ ç¹¼çºŒè™•ç†å‚³é€ç®±
- å…¶ä»–æƒ…æ³ â†’ è™•ç†ä¸‹ä¸€å€‹ Rack Port

## âš ï¸ æ³¨æ„äº‹é …

1. **ç‹€æ…‹é‡ç½®**: æ¯å€‹ç‹€æ…‹çš„ enter() å’Œ leave() éƒ½æœƒé‡ç½®ç›¸é—œè®Šæ•¸
2. **è¦–è¦ºå®šä½å„ªåŒ–**: RackVisionPositionState ä½¿ç”¨ buffer æ©Ÿåˆ¶é¿å…é‡è¤‡æ‹ç…§
3. **8-bit é€šè¨Š**: å¿…é ˆæŒ‰é †åºå®Œæˆæ‰€æœ‰ 8-bit æ­¥é©Ÿï¼Œæ¯æ­¥éƒ½æœ‰æˆåŠŸ/å¤±æ•—è™•ç†
4. **éŒ¯èª¤è™•ç†**: æ¯å€‹æ­¥é©Ÿéƒ½æœ‰å®Œæ•´çš„éŒ¯èª¤è™•ç†å’Œé‡è©¦æ©Ÿåˆ¶
5. **è³‡æ–™åº«åŒæ­¥**: åœ¨ PutRackPortState çš„ FINISH æ­¥é©Ÿä¸­æ›´æ–°è³‡æ–™åº«
6. **å¾ªç’°æ§åˆ¶**: é€šé take_transfer_continue ç²¾ç¢ºæ§åˆ¶æµç¨‹åˆ†æ”¯
7. **æŸ¥è©¢æ©Ÿåˆ¶**: ä½¿ç”¨ callback æ©Ÿåˆ¶è™•ç†ç•°æ­¥è³‡æ–™åº«æŸ¥è©¢

## ğŸ”„ æµç¨‹ç‰¹é»

- **è§¸ç™¼æ©Ÿåˆ¶**: å¾ IdleState æ ¹æ“š mission="exit" è‡ªå‹•è§¸ç™¼ EXIT æµç¨‹
- **é›™é‡å¾ªç’°**: å…§å±¤è™•ç†å‚³é€ç®±è²¨ç‰©ï¼Œå¤–å±¤è™•ç† Rack Port é¸æ“‡
- **æ™ºèƒ½åˆ¤æ–·**: æ ¹æ“šç›¸é„° Port ç‹€æ…‹æ±ºå®šæ˜¯å¦ç¹¼çºŒè™•ç†å‚³é€ç®±
- **éæ¸›é‚è¼¯**: Rack Port æŒ‰éæ¸›é †åºè™•ç† (min_rack_index - 1)
- **ç‹€æ…‹è¿½è¹¤**: å®Œæ•´çš„ç‹€æ…‹è®Šæ•¸ç®¡ç†å’Œé‡ç½®æ©Ÿåˆ¶
- **å„ªåŒ–æ©Ÿåˆ¶**: è¦–è¦ºå®šä½ bufferã€Hokuyo æ›´æ–°æ¨™èªŒç­‰é¿å…é‡è¤‡æ“ä½œ
- **ç•°æ­¥è™•ç†**: ä½¿ç”¨ callback æ©Ÿåˆ¶è™•ç†è³‡æ–™åº«æŸ¥è©¢å’Œè¨­å‚™é€šè¨Š

## ğŸ”§ ç¨‹å¼ç¢¼æ¶æ§‹æ”¹é€²

- **ç¹¼æ‰¿çµæ§‹**: TransferVisionPositionState ç¹¼æ‰¿è‡ª BaseVisionPositionState
- **æ¨¡çµ„åŒ–è¨­è¨ˆ**: æ¯å€‹ç‹€æ…‹éƒ½æœ‰æ¸…æ™°çš„è·è²¬åˆ†å·¥
- **éŒ¯èª¤æ¢å¾©**: æŸ¥è©¢å¤±æ•—æ™‚æœƒé‡ç½®ç‹€æ…‹ä¸¦é‡æ–°å˜—è©¦
- **æ—¥èªŒè¨˜éŒ„**: æ¯å€‹é—œéµæ­¥é©Ÿéƒ½æœ‰è©³ç´°çš„æ—¥èªŒè¼¸å‡º

## ğŸ“Š ç‹€æ…‹å¯¦ç¾ç´°ç¯€

### TransferCheckHaveState é—œéµå¯¦ç¾
```python
class TransferCheckHaveState(State):
    # 8-bit é€šè¨Šæ­¥é©Ÿå¸¸æ•¸
    IDLE = 0
    WRITE_VAILD = 1
    WRITE_PORT_NUMBER = 2
    WAIT_UNLOAD_REQ = 3
    WRITE_TR_REQ = 4
    WAIT_READY = 5

    # è¨­å‚™åƒæ•¸ (å·²å‹•æ…‹åŒ–)
    # self.port_address = self.node.task.room_id * 1000 + 20
    # self.eqp_id = self.node.task.room_id * 100 + 2

    def _reset_state(self):
        """é‡ç½®æ‰€æœ‰ç‹€æ…‹è®Šæ•¸"""
        self.check_ok = False
        self.sent = False
        self.queries_completed = {'carrier': False, 'eqp_signal': False, 'hokuyo_input': False}
        self.port_carriers = [False, False, False, False]  # Port 1-4 ç‹€æ…‹

    def _check_take_transfer_continue(self, context):
        """æª¢æŸ¥æ˜¯å¦ç¹¼çºŒè™•ç†å‚³é€ç®±çš„æ ¸å¿ƒé‚è¼¯"""
        if self.select_boxout_port == 1 and self.port_carriers[1]:
            context.take_transfer_continue = True
        elif self.select_boxout_port == 3 and self.port_carriers[3]:
            context.take_transfer_continue = True
        else:
            context.take_transfer_continue = False
```

### SelectRackPortState éæ¸›é‚è¼¯ â­ **æœ€æ–°æ›´æ–°**
```python
# å¯¦ç¾éæ¸›é‚è¼¯é¸æ“‡ Rack Port
if self.min_rack_index == 1:
    # å·²åˆ°é”æœ€å°å€¼ï¼Œæµç¨‹å®Œæˆ
    context.set_state(CompleteState(self.node))
else:
    # é¸æ“‡ä¸‹ä¸€å€‹ Port (éæ¸›)
    context.get_rack_port = self.min_rack_index - 1
    # æœ€æ–°è®Šæ›´ï¼šé€²å…¥ RackVisionPositionStateï¼Œæ¢å¾©è¦–è¦ºå®šä½
    context.set_state(RackVisionPositionState(self.node))
```

**æœ€æ–°è®Šæ›´èªªæ˜**:
- é€²å…¥ `RackVisionPositionState` é€²è¡Œè¦–è¦ºå®šä½
- ä¿ç•™è¦–è¦ºå®šä½ç²¾åº¦

### CheckRackSideState æµç¨‹æ§åˆ¶ â­ **é‡å¤§åŠŸèƒ½æ“´å±•**
```python
# CheckRackSideState çš„æ–°æµç¨‹é‚è¼¯
case 2:
    if self.no_carrier and self.carrier_response_ok:
        # æ²’æœ‰ Carrierï¼Œè¨­å®šæœ€å¤§ Port
        context.get_rack_port = 32
        self.step = 3
    elif self.min_rack_index == 1 and self.carrier_response_ok:
        # å·²åˆ°é”æœ€å°å€¼ï¼Œæµç¨‹å®Œæˆ
        context.set_state(CompleteState(self.node))
    elif 1 < self.min_rack_index <= 32 and self.carrier_response_ok:
        # é¸æ“‡ä¸‹ä¸€å€‹ Port (éæ¸›)
        context.get_rack_port = self.min_rack_index - 1
        self.step = 3

case 3:
    if self.rack_direction == 0 and 1 <= context.get_rack_port <= 16:
        # A é¢æ–¹å‘æ­£ç¢ºï¼Œç›´æ¥é€²å…¥ TransferCheckHaveState
        context.set_state(TransferCheckHaveState(self.node))
    elif self.rack_direction == 180 and 17 <= context.get_rack_port <= 32:
        # B é¢æ–¹å‘æ­£ç¢ºï¼Œç›´æ¥é€²å…¥ TransferCheckHaveState
        context.set_state(TransferCheckHaveState(self.node))
    else:
        # éœ€è¦æ—‹è½‰ï¼Œé€²å…¥ WaitRotationState
        context.set_state(WaitRotationState(self.node))
```

**é‡å¤§è®Šæ›´èªªæ˜**:
- CheckRackSideState ç¾åœ¨å…·æœ‰é›™é‡è·è²¬ï¼šæ–¹å‘æª¢æŸ¥ + Port é¸æ“‡
- ç•¶æ–¹å‘æ­£ç¢ºæ™‚ï¼Œç›´æ¥é€²å…¥ `TransferCheckHaveState` å‰µå»ºæ–°çš„å¾ªç’°è·¯å¾‘
- ç•¶éœ€è¦æ—‹è½‰æ™‚ï¼Œé€²å…¥ `WaitRotationState` ä¿æŒå®Œæ•´çš„æ—‹è½‰åŠŸèƒ½

### PutRackPortState æµç¨‹æ§åˆ¶ (é‡è¦æ›´æ–°)
```python
# åœ¨ UPDATE_DATABASE æ­¥é©Ÿä¸­æ ¹æ“š take_transfer_continue æ±ºå®šä¸‹ä¸€æ­¥
case RobotContext.UPDATE_DATABASE:
    if not self.sent:
        self.update_carrier_database(context)
        self.sent = True
    elif self.sent and self.update_carrier_success:
        self.step = RobotContext.IDLE

        # é—œéµæµç¨‹æ§åˆ¶é‚è¼¯
        if getattr(context, 'take_transfer_continue', False):
            # ç¹¼çºŒè™•ç†å‚³é€ç®±
            context.set_state(TransferCheckHaveState(self.node))
        else:
            # ç›´æ¥é€²å…¥ CheckRackSideStateï¼Œè·³é SelectRackPortState
            context.set_state(CheckRackSideState(self.node))
```

**é‡è¦è®Šæ›´èªªæ˜**:
- ç•¶ `take_transfer_continue = False` æ™‚ï¼Œç¾åœ¨ç›´æ¥é€²å…¥ `CheckRackSideState`
- é€™æ¨£å¯ä»¥é¿å…é‡è¤‡åŸ·è¡Œ `SelectRackPortState` çš„ Rack Port é¸æ“‡é‚è¼¯
- æµç¨‹æ›´åŠ é«˜æ•ˆï¼Œç›´æ¥ä½¿ç”¨å·²é¸å®šçš„ Rack Port é€²è¡Œå¾ŒçºŒè™•ç†

## ğŸš€ é‡å¤§æµç¨‹é‡æ§‹èªªæ˜

### â­ æ–°çš„å®Œæ•´æµç¨‹é‚è¼¯
```
æµç¨‹è§¸ç™¼:
IdleState (mission="exit")
    â†“
TransferVisionPositionState (å‚³é€ç®±è¦–è¦ºå®šä½)
    â†“
TransferCheckHaveState (æª¢æŸ¥å‚³é€ç®±æœ‰è²¨ + è¨­å®š take_transfer_continue)
    â†“

ä¸»æµç¨‹:
SelectRackPortState (é¸æ“‡ Rack Port)
    â†“
RackVisionPositionState (Rack è¦–è¦ºå®šä½)
    â†“
TakeTransferState (å–å‚³é€ç®±)
    â†“
PutRackPortState (æ”¾åˆ° Rack + æ›´æ–°è³‡æ–™åº«)
    â†“
take_transfer_continue åˆ¤æ–·
    â”œâ”€ True  â†’ TransferCheckHaveState (ç¹¼çºŒè™•ç†å‚³é€ç®±)
    â””â”€ False â†’ CheckRackSideState (å¤–å±¤å¾ªç’°)

å¤–å±¤å¾ªç’°:
CheckRackSideState (æª¢æŸ¥ Rack æ–¹å‘ + é¸æ“‡ä¸‹ä¸€å€‹ Port)
    â†“
Rack æ–¹å‘åˆ¤æ–·
    â”œâ”€ æ–¹å‘æ­£ç¢º â†’ TransferCheckHaveState â­ **æ–°çš„å¾ªç’°è·¯å¾‘**
    â””â”€ éœ€è¦æ—‹è½‰ â†’ WaitRotationState â†’ RackVisionPositionState â†’ TakeTransferState
```

### âœ… å®Œæ•´åŠŸèƒ½æ¢å¾©
- **CheckRackSideState**: å®Œæ•´çš„ Rack æ–¹å‘æª¢æŸ¥å’Œ Port é¸æ“‡åŠŸèƒ½
- **WaitRotationState**: æ—‹è½‰ç­‰å¾…åŠŸèƒ½
- **RackVisionPositionState**: è¦–è¦ºå®šä½ç²¾åº¦

### ğŸ“ˆ é‡æ§‹æ•ˆæœ
1. **å®Œæ•´åŠŸèƒ½**: æ¢å¾©æ‰€æœ‰ Rack æª¢æŸ¥å’Œæ—‹è½‰åŠŸèƒ½
2. **é›™é‡å¾ªç’°**: å…§å±¤è™•ç†å‚³é€ç®±ï¼Œå¤–å±¤è™•ç† Rack Port
3. **æ™ºèƒ½è·¯ç”±**: CheckRackSideState ç›´æ¥å›åˆ° TransferCheckHaveState
4. **é«˜æ•ˆå¾ªç’°**: æ¸›å°‘ä¸å¿…è¦çš„ç‹€æ…‹é‡è¤‡

## ğŸ”§ æœ€æ–°ä¿®å¾© (2025-07-01)

### âœ… ä¿®å¾©çš„å•é¡Œ
1. **EXITæµç¨‹è§¸ç™¼æ©Ÿåˆ¶**: ä¿®å¾© `IdleState` ä¸­ EXIT æµç¨‹çš„è§¸ç™¼é‚è¼¯
   - **å•é¡Œ**: `idle_state.py` ä¸­ `mission="exit"` æ™‚åªæœ‰ `pass`ï¼Œæ²’æœ‰å¯¦éš›è§¸ç™¼ EXIT æµç¨‹
   - **ä¿®å¾©**: åŠ å…¥ `TransferVisionPositionState` çš„è§¸ç™¼é‚è¼¯

2. **è¨»è§£éŒ¯èª¤ä¿®æ­£**: ä¿®æ­£ `PutRackPortState` ä¸­çš„èª¤å°æ€§è¨»è§£
   - **å•é¡Œ**: è¨»è§£èªª"é€²å…¥ SelectRackPortState"ï¼Œä½†å¯¦éš›æ˜¯é€²å…¥ `CheckRackSideState`
   - **ä¿®å¾©**: æ›´æ­£è¨»è§£ç‚º"è™•ç†ä¸‹ä¸€å€‹ Rack Port: é€²å…¥ CheckRackSideState"

3. **Hokuyo Input æŒçºŒæ›´æ–°**: ä¿®å¾©æ‰€æœ‰æµç¨‹ç‹€æ…‹ä¸­çš„ Hokuyo Input æ›´æ–°é‚è¼¯
   - **å•é¡Œ**: Hokuyo Input åªæ›´æ–°ä¸€æ¬¡å¾Œå°±åœæ­¢ï¼Œç„¡æ³•æŒçºŒç›£æ§è¨­å‚™ç‹€æ…‹
   - **ä¿®å¾©**: åœ¨æ‰€æœ‰æµç¨‹ç‹€æ…‹ä¸­ç§»é™¤ `hokuyo_input_updated` æ¨™èªŒï¼Œè®“ Hokuyo Input æŒçºŒæ›´æ–°
   - **EXITæµç¨‹å½±éŸ¿ç‹€æ…‹**: `TransferCheckHaveState`ã€`TakeTransferState`ã€`SelectRackPortState`ã€`PutRackPortState`
   - **ENTRANCEæµç¨‹å½±éŸ¿ç‹€æ…‹**: `TransferCheckEmptyState`ã€`TakeRackPortState`ã€`PutTransferState`
   - **åŸºç¤é¡åˆ¥**: `BaseRobotState._handle_hokuyo_input()` æ–¹æ³•ä¹Ÿå·²æ›´æ–°
   - **å½±éŸ¿**: ç¢ºä¿è¨­å‚™ç‹€æ…‹èƒ½å³æ™‚åæ˜ ï¼Œæé«˜ç³»çµ±ç©©å®šæ€§å’ŒéŸ¿æ‡‰æ€§

### ğŸ“ ä¿®å¾©çš„æ–‡ä»¶
**EXITæµç¨‹**:
- `agv_ws/src/cargo_mover_agv/cargo_mover_agv/robot_states/idle_state.py`
- `agv_ws/src/cargo_mover_agv/cargo_mover_agv/robot_states/exit/transfer_check_have_state.py`
- `agv_ws/src/cargo_mover_agv/cargo_mover_agv/robot_states/exit/take_transfer_state.py`
- `agv_ws/src/cargo_mover_agv/cargo_mover_agv/robot_states/exit/select_rack_port_state.py`
- `agv_ws/src/cargo_mover_agv/cargo_mover_agv/robot_states/exit/put_rack_port_state.py`
- `agv_ws/src/cargo_mover_agv/cargo_mover_agv/robot_states/exit/EXITæµç¨‹` (æœ¬æ–‡ä»¶)

**ENTRANCEæµç¨‹**:
- `agv_ws/src/cargo_mover_agv/cargo_mover_agv/robot_states/entrance/transfer_check_empty_state.py`
- `agv_ws/src/cargo_mover_agv/cargo_mover_agv/robot_states/entrance/take_rack_port_state.py`
- `agv_ws/src/cargo_mover_agv/cargo_mover_agv/robot_states/entrance/put_tranfer_state.py`
- `agv_ws/src/cargo_mover_agv/cargo_mover_agv/robot_states/entrance/ENTRANCEæµç¨‹`

**åŸºç¤é¡åˆ¥**:
- `agv_ws/src/cargo_mover_agv/cargo_mover_agv/robot_states/base_robot_state.py`

### ğŸ¯ ä¿®å¾©å¾Œçš„å®Œæ•´æµç¨‹
ç¾åœ¨ EXIT å’Œ ENTRANCE æµç¨‹éƒ½å·²ç¶“å®Œå…¨ä¸€è‡´ï¼š
- å¾ `IdleState` é–‹å§‹åˆ° `CompleteState` çµæŸçš„å®Œæ•´æµç¨‹éƒ½å·²å¯¦ä½œä¸¦æ­£ç¢ºé‹ä½œ
- æ‰€æœ‰ç‹€æ…‹éƒ½ä½¿ç”¨æŒçºŒæ›´æ–°çš„ Hokuyo Input é‚è¼¯
- ç¢ºä¿æ•´å€‹ cargo_mover_agv ç³»çµ±çš„ä¸€è‡´æ€§å’Œç©©å®šæ€§