# ä»»å‹™æ’åºå„ªåŒ–èªªæ˜

## ğŸ“‹ ä¿®æ”¹æ¦‚è¿°

æœ¬æ¬¡ä¿®æ”¹å„ªåŒ–äº† `idle_state.py` æª”æ¡ˆä¸­çš„ `_load_task_from_database()` æ–¹æ³•ï¼Œå¯¦ç¾äº†æŒ‰ `created_at` æ™‚é–“æˆ³æ’åºçš„ä»»å‹™é¸æ“‡é‚è¼¯ã€‚

## ğŸ¯ ä¿®æ”¹ç›®æ¨™

- **ä¿ç•™ç¾æœ‰çš„ agv_id æŸ¥è©¢æ¢ä»¶**ï¼šç¹¼çºŒç¯©é¸ `agv_id == 1` çš„ä»»å‹™
- **æ–°å¢ created_at æ’åºæ¢ä»¶**ï¼šåœ¨ç¬¦åˆ agv_id æ¢ä»¶çš„ä»»å‹™ä¸­ï¼Œé¸æ“‡ `created_at` æ™‚é–“æœ€æ—©çš„ä»»å‹™
- **ç¢ºä¿ FIFO ä»»å‹™è™•ç†é †åº**ï¼šå„ªå…ˆè™•ç†æœ€æ—©å»ºç«‹çš„ä»»å‹™ï¼Œé¿å…ä»»å‹™é¤“æ­»å•é¡Œ

## ğŸ”§ å…·é«”ä¿®æ”¹å…§å®¹

### 1. æ–°å¢æ™‚é–“è™•ç†é‚è¼¯

```python
def get_created_at_time(task):
    """å–å¾—ä»»å‹™çš„ created_at æ™‚é–“ï¼Œè™•ç† None å€¼å’Œæ™‚å€å•é¡Œ"""
    from datetime import timezone
    
    if hasattr(task, 'created_at') and task.created_at:
        # è™•ç†å­—ä¸²æ ¼å¼çš„æ™‚é–“æˆ³
        if isinstance(task.created_at, str):
            try:
                from dateutil.parser import isoparse
                parsed_time = isoparse(task.created_at)
                # ç¢ºä¿æ™‚é–“æœ‰æ™‚å€è³‡è¨Š
                if parsed_time.tzinfo is None:
                    parsed_time = parsed_time.replace(tzinfo=timezone.utc)
                return parsed_time
            except (ImportError, ValueError):
                return datetime.now(timezone.utc)
        # è™•ç† datetime ç‰©ä»¶
        elif isinstance(task.created_at, datetime):
            if task.created_at.tzinfo is None:
                return task.created_at.replace(tzinfo=timezone.utc)
            return task.created_at
    # None å€¼è™•ç†ï¼šæ’åˆ°æœ€å¾Œ
    return datetime.max.replace(tzinfo=timezone.utc)
```

### 2. ä¿®æ”¹ä»»å‹™é¸æ“‡é‚è¼¯

**ä¿®æ”¹å‰ï¼š**
```python
if matching_tasks:
    selected_task = matching_tasks[0]  # éš¨æ©Ÿé¸æ“‡ç¬¬ä¸€å€‹
```

**ä¿®æ”¹å¾Œï¼š**
```python
if matching_tasks:
    # æŒ‰ created_at å‡åºæ’åºï¼ˆæœ€æ—©çš„åœ¨å‰é¢ï¼‰
    sorted_tasks = sorted(matching_tasks, key=get_created_at_time)
    selected_task = sorted_tasks[0]
```

### 3. æ–°å¢èª¿è©¦æ—¥èªŒ

- é¡¯ç¤ºæ‰¾åˆ°çš„ç¬¦åˆæ¢ä»¶ä»»å‹™æ•¸é‡
- ç•¶æœ‰å¤šå€‹ä»»å‹™æ™‚ï¼Œé¡¯ç¤ºæ’åºçµæœ
- åœ¨æˆåŠŸè¼‰å…¥æ—¥èªŒä¸­åŒ…å« `created_at` è³‡è¨Š

## ğŸ§ª æ¸¬è©¦é©—è­‰

å»ºç«‹äº† `test_task_sorting.py` æ¸¬è©¦è…³æœ¬ï¼Œé©—è­‰ä»¥ä¸‹æƒ…æ³ï¼š

1. **æ­£å¸¸æ’åº**ï¼šå¤šå€‹ä»»å‹™æŒ‰ `created_at` æ­£ç¢ºæ’åº
2. **None å€¼è™•ç†**ï¼š`created_at` ç‚º None çš„ä»»å‹™æ’åˆ°æœ€å¾Œ
3. **æ··åˆæ ¼å¼**ï¼šå­—ä¸²å’Œ datetime ç‰©ä»¶æ··åˆçš„æƒ…æ³
4. **æ™‚å€è™•ç†**ï¼šç¢ºä¿ä¸åŒæ™‚å€æ ¼å¼çš„æ­£ç¢ºæ¯”è¼ƒ

### æ¸¬è©¦çµæœ

```
âœ… é¸ä¸­çš„ä»»å‹™ï¼šID=2, name=ä»»å‹™2, created_at=2024-01-15T09:15:00Z
ğŸ‰ æ¸¬è©¦é€šéï¼æ­£ç¢ºé¸æ“‡äº†æœ€æ—©å»ºç«‹çš„ä»»å‹™ã€‚
```

## ğŸ“Š æ•ˆèƒ½å½±éŸ¿

### æ­£é¢å½±éŸ¿
- **FIFO é †åºä¿è­‰**ï¼šç¢ºä¿ä»»å‹™æŒ‰å»ºç«‹æ™‚é–“é †åºè™•ç†
- **é¿å…ä»»å‹™é¤“æ­»**ï¼šèˆŠä»»å‹™ä¸æœƒè¢«æ–°ä»»å‹™ç„¡é™æœŸå»¶é²
- **æ™‚å€ç›¸å®¹æ€§**ï¼šæ­£ç¢ºè™•ç†ä¸åŒæ™‚å€æ ¼å¼çš„æ™‚é–“æˆ³

### æ•ˆèƒ½è€ƒé‡
- **æ’åºé–‹éŠ·**ï¼šå°ç¬¦åˆæ¢ä»¶çš„ä»»å‹™é€²è¡Œæ’åºï¼ˆé€šå¸¸æ•¸é‡ä¸å¤šï¼‰
- **æ™‚é–“è¤‡é›œåº¦**ï¼šO(n log n)ï¼Œå…¶ä¸­ n æ˜¯ç¬¦åˆ agv_id æ¢ä»¶çš„ä»»å‹™æ•¸é‡
- **è¨˜æ†¶é«”ä½¿ç”¨**ï¼šå»ºç«‹æ’åºå¾Œçš„ä»»å‹™åˆ—è¡¨å‰¯æœ¬

## ğŸ” ç›¸å®¹æ€§

- **å‘å¾Œç›¸å®¹**ï¼šä¿æŒæ‰€æœ‰ç¾æœ‰åŠŸèƒ½å’Œä»‹é¢ä¸è®Š
- **éŒ¯èª¤è™•ç†**ï¼šå¢å¼·äº†å°ç„¡æ•ˆæ™‚é–“æ ¼å¼çš„è™•ç†
- **æ—¥èªŒæ ¼å¼**ï¼šæ“´å±•äº†æ—¥èªŒè³‡è¨Šï¼Œä½†ä¸å½±éŸ¿ç¾æœ‰è§£æé‚è¼¯

## ğŸš€ ä½¿ç”¨å»ºè­°

1. **ç›£æ§æ—¥èªŒ**ï¼šè§€å¯Ÿæ’åºçµæœæ—¥èªŒï¼Œç¢ºèªä»»å‹™é¸æ“‡ç¬¦åˆé æœŸ
2. **æ•ˆèƒ½ç›£æ§**ï¼šåœ¨é«˜è² è¼‰æƒ…æ³ä¸‹ç›£æ§æ’åºæ“ä½œçš„æ•ˆèƒ½å½±éŸ¿
3. **è³‡æ–™å“è³ª**ï¼šç¢ºä¿è³‡æ–™åº«ä¸­çš„ `created_at` æ¬„ä½æœ‰æ­£ç¢ºçš„æ™‚é–“æˆ³

## ğŸ“ å¾ŒçºŒå„ªåŒ–å»ºè­°

1. **è³‡æ–™åº«ç´¢å¼•**ï¼šç‚º `created_at` æ¬„ä½å»ºç«‹ç´¢å¼•ä»¥æå‡æŸ¥è©¢æ•ˆèƒ½
2. **å¿«å–æ©Ÿåˆ¶**ï¼šè€ƒæ…®å¿«å–æ’åºçµæœä»¥æ¸›å°‘é‡è¤‡è¨ˆç®—
3. **æ‰¹æ¬¡è™•ç†**ï¼šå°æ–¼å¤§é‡ä»»å‹™çš„æƒ…æ³ï¼Œè€ƒæ…®åˆ†æ‰¹è™•ç†é‚è¼¯
