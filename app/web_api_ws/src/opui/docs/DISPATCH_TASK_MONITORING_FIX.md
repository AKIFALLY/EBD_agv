# OPUI æ´¾è»Šä»»å‹™ç›£æ§é‚è¼¯ä¿®å¾©

## ğŸ› å•é¡Œæè¿°

### åŸå§‹å•é¡Œ
æ´¾è»Šä»»å‹™å®Œæˆçš„æª¢æ¸¬æ¢ä»¶ä¸æ­£ç¢ºï¼Œå°è‡´å‰ç«¯æŒ‰éˆ•ç‹€æ…‹ç„¡æ³•æ­£ç¢ºæ›´æ–°ã€‚ç•¶æ´¾è»Šä»»å‹™å®Œæˆæ™‚ï¼ˆå³æŒ‡å®šçš„æ–™æ¶å·²å¾è©²åœè»Šæ ¼ç§»èµ°ï¼‰ï¼Œå‰ç«¯çš„æ´¾è»ŠæŒ‰éˆ•æ‡‰è©²å¾ã€Œå–æ¶ˆã€ç‹€æ…‹è‡ªå‹•æ¢å¾©ç‚ºã€Œæ´¾è»Šã€ç‹€æ…‹ã€‚

### æ ¹æœ¬åŸå› åˆ†æ

#### 1. **éŒ¯èª¤çš„å®Œæˆæª¢æ¸¬é‚è¼¯**
```python
# âŒ ä¿®å¾©å‰ï¼šæª¢æŸ¥åœè»Šæ ¼æ˜¯å¦æœ‰ä»»ä½• rack
has_rack = self._check_rack_at_location(session, node_id)
if not has_rack:  # åœè»Šæ ¼å®Œå…¨æ²’æœ‰ rack æ‰ç®—å®Œæˆ
    # è§¸ç™¼å®Œæˆå›èª¿
```

**å•é¡Œ**ï¼šé€™å€‹é‚è¼¯æª¢æŸ¥çš„æ˜¯åœè»Šæ ¼æ˜¯å¦**å®Œå…¨æ²’æœ‰ä»»ä½• rack**ï¼Œä½†å¯¦éš›éœ€æ±‚æ˜¯æª¢æŸ¥**æŒ‡å®šçš„ rack** æ˜¯å¦å·²é›¢é–‹è©²ä½ç½®ã€‚

#### 2. **æ¥­å‹™é‚è¼¯ä¸ç¬¦**
- **éŒ¯èª¤é‚è¼¯**ï¼šåœè»Šæ ¼å¿…é ˆå®Œå…¨ç©ºæ‰ç®—æ´¾è»Šå®Œæˆ
- **æ­£ç¢ºé‚è¼¯**ï¼šåªè¦å‰ç«¯æŒ‡å®šçš„ rack é›¢é–‹è©²åœè»Šæ ¼å°±ç®—å®Œæˆ

#### 3. **å¯¦éš›å ´æ™¯å•é¡Œ**
åœ¨å¯¦éš›ä½¿ç”¨ä¸­ï¼Œä¸€å€‹åœè»Šæ ¼å¯èƒ½æœ‰å¤šå€‹ rackï¼Œæ´¾è»Šä»»å‹™åªæ˜¯è¦æ¬èµ°å…¶ä¸­ä¸€å€‹æŒ‡å®šçš„ rackï¼Œè€Œä¸æ˜¯æ¸…ç©ºæ•´å€‹åœè»Šæ ¼ã€‚

## âœ… ä¿®å¾©æ–¹æ¡ˆ

### ä¿®å¾©åŸå‰‡
**åªè¦å‰ç«¯å‚³ä¾†çš„æŒ‡å®š rack ä¸åœ¨è©² node_id ä¸Šï¼Œå°±ç®—æ´¾è»Šä»»å‹™å®Œæˆï¼Œä¸éœ€è¦ç­‰å¾…ä»»å‹™ç‹€æ…‹è®Šç‚ºå®Œæˆã€‚**

### ä¿®å¾©å¯¦æ–½

#### 1. **æ–°å¢æŒ‡å®š rack æª¢æŸ¥æ–¹æ³•**

```python
def _check_specific_rack_at_location(self, session, node_id: int, rack_id: int) -> bool:
    """æª¢æŸ¥æŒ‡å®šçš„ rack æ˜¯å¦é‚„åœ¨æŒ‡å®šåœè»Šæ ¼ä½ç½®"""
    try:
        from sqlmodel import select
        from db_proxy.models import Rack

        # æŸ¥è©¢æŒ‡å®šçš„ rack
        statement = select(Rack).where(Rack.id == rack_id)
        rack = session.exec(statement).first()

        if not rack:
            return False

        is_at_location = rack.location_id == node_id
        print(f"ğŸ” Rack {rack_id} ç•¶å‰ä½ç½®: {rack.location_id}, ç›®æ¨™ä½ç½®: {node_id}, æ˜¯å¦åœ¨ä½ç½®: {is_at_location}")

        return is_at_location

    except Exception as e:
        print(f"âŒ æª¢æŸ¥æŒ‡å®šrackä½ç½®å¤±æ•—: {e}")
        return True  # ç™¼ç”ŸéŒ¯èª¤æ™‚ä¿å®ˆè™•ç†
```

#### 2. **æ–°å¢ rack_id æå–æ–¹æ³•**

```python
def _extract_rack_id_from_task(self, task) -> int:
    """å¾ä»»å‹™ä¸­æå– rack_id"""
    try:
        import json
        
        # å˜—è©¦å¾ parameters æ¬„ä½è§£æ rack_id
        if hasattr(task, 'parameters') and task.parameters:
            if isinstance(task.parameters, str):
                params = json.loads(task.parameters)
            elif isinstance(task.parameters, dict):
                params = task.parameters
            else:
                return None

            rack_id = params.get('rack_id')
            if rack_id:
                return int(rack_id)

        return None

    except Exception as e:
        print(f"âŒ æå–ä»»å‹™ rack_id å¤±æ•—: {e}")
        return None
```

#### 3. **ä¿®å¾©æ´¾è»Šä»»å‹™æª¢æŸ¥é‚è¼¯**

**ä¿®å¾©å‰**ï¼š
```python
async def _check_dispatch_full_task(self, task_id: int, current_task, task_info: dict, session):
    # æª¢æŸ¥åœè»Šæ ¼ä¸Šæ˜¯å¦é‚„æœ‰ä»»ä½•rack
    has_rack = self._check_rack_at_location(session, node_id)
    
    # âŒ éŒ¯èª¤ï¼šåœè»Šæ ¼æ²’æœ‰ä»»ä½• rack æ‰ç®—å®Œæˆ
    if not has_rack:
        # è§¸ç™¼å®Œæˆå›èª¿
```

**ä¿®å¾©å¾Œ**ï¼š
```python
async def _check_dispatch_full_task(self, task_id: int, current_task, task_info: dict, session):
    # ç²å–ä»»å‹™ä¸­æŒ‡å®šçš„ rack_id
    target_rack_id = self._extract_rack_id_from_task(current_task)
    
    if not target_rack_id:
        # å¦‚æœç„¡æ³•ç²å– rack_idï¼Œå›é€€åˆ°èˆŠé‚è¼¯
        has_any_rack = self._check_rack_at_location(session, node_id)
        if not has_any_rack:
            # è§¸ç™¼å®Œæˆå›èª¿
        return

    # âœ… æ­£ç¢ºï¼šæª¢æŸ¥æŒ‡å®šçš„ rack æ˜¯å¦é‚„åœ¨è©²åœè»Šæ ¼ä½ç½®
    target_rack_still_at_location = self._check_specific_rack_at_location(session, node_id, target_rack_id)
    
    # æ´¾è»Šå®Œæˆæ¢ä»¶ï¼šæŒ‡å®šçš„ rack ä¸å†ä½æ–¼è©²åœè»Šæ ¼
    if not target_rack_still_at_location:
        # è§¸ç™¼å®Œæˆå›èª¿
```

#### 4. **æ›´æ–°ä»»å‹™åˆå§‹åŒ–é‚è¼¯**

```python
# å¦‚æœæ˜¯æ´¾è»Šä»»å‹™ï¼Œåˆå§‹åŒ–rackç‹€æ…‹å’Œç›®æ¨™rack_id
if task_type == 'dispatch_full':
    try:
        with connection_pool.get_session() as session:
            # ç²å–ä»»å‹™è©³ç´°è³‡è¨Šä»¥æå– rack_id
            task_detail = task_crud.get_by_id(session, task_id)
            if task_detail:
                target_rack_id = self._extract_rack_id_from_task(task_detail)
                if target_rack_id:
                    task_info['target_rack_id'] = target_rack_id
                    print(f"ğŸ” æ´¾è»Šä»»å‹™ {task_id} ç›®æ¨™ rack_id: {target_rack_id}")
```

## ğŸ“Š ä¿®å¾©æ•ˆæœ

### 1. **é‚è¼¯æ­£ç¢ºæ€§**
- âœ… **ç²¾ç¢ºæª¢æ¸¬**ï¼šåªæª¢æŸ¥æŒ‡å®šçš„ rack æ˜¯å¦é›¢é–‹ï¼Œè€Œä¸æ˜¯æ•´å€‹åœè»Šæ ¼æ˜¯å¦ç‚ºç©º
- âœ… **æ¥­å‹™ç¬¦åˆ**ï¼šç¬¦åˆå¯¦éš›æ´¾è»Šæ¥­å‹™é‚è¼¯
- âœ… **å¤š rack æ”¯æ´**ï¼šæ”¯æ´åœè»Šæ ¼æœ‰å¤šå€‹ rack çš„å ´æ™¯

### 2. **å‰ç«¯æŒ‰éˆ•ç‹€æ…‹**
- âœ… **å³æ™‚æ›´æ–°**ï¼šæŒ‡å®š rack é›¢é–‹å¾Œç«‹å³è§¸ç™¼æŒ‰éˆ•ç‹€æ…‹æ›´æ–°
- âœ… **ç‹€æ…‹æ­£ç¢º**ï¼šæŒ‰éˆ•å¾ã€Œå–æ¶ˆã€æ­£ç¢ºæ¢å¾©ç‚ºã€Œæ´¾è»Šã€
- âœ… **ç”¨æˆ¶é«”é©—**ï¼šæ“ä½œåé¥‹æ›´åŠæ™‚æº–ç¢º

### 3. **ç³»çµ±ç©©å®šæ€§**
- âœ… **å‘å¾Œç›¸å®¹**ï¼šä¿ç•™èˆŠé‚è¼¯ä½œç‚ºå‚™ç”¨æ©Ÿåˆ¶
- âœ… **éŒ¯èª¤è™•ç†**ï¼šå®Œå–„çš„ç•°å¸¸è™•ç†å’Œæ—¥èªŒè¨˜éŒ„
- âœ… **å®¹éŒ¯æ©Ÿåˆ¶**ï¼šç„¡æ³•ç²å– rack_id æ™‚å›é€€åˆ°èˆŠé‚è¼¯

## ğŸ” æ¸¬è©¦é©—è­‰æ–¹æ³•

### 1. **åŸºæœ¬åŠŸèƒ½æ¸¬è©¦**
```bash
# 1. å•Ÿå‹• OPUI æœå‹™
cd /app/web_api_ws
colcon build --symlink-install
all_source
ros2 run opui opui_server

# 2. æ¸¬è©¦æ´¾è»Šæµç¨‹
# - é¸æ“‡ç”¢å“å’Œ rack
# - é»æ“Šæ´¾è»ŠæŒ‰éˆ•ï¼ˆç‹€æ…‹è®Šç‚ºã€Œå–æ¶ˆã€ï¼‰
# - æ¨¡æ“¬ AGV æ¬èµ°æŒ‡å®š rack
# - è§€å¯ŸæŒ‰éˆ•æ˜¯å¦è‡ªå‹•æ¢å¾©ç‚ºã€Œæ´¾è»Šã€
```

### 2. **å¤š rack å ´æ™¯æ¸¬è©¦**
- [ ] **åœè»Šæ ¼æœ‰å¤šå€‹ rack**ï¼š
  - æ´¾è»ŠæŒ‡å®šå…¶ä¸­ä¸€å€‹ rack
  - è©² rack è¢«æ¬èµ°å¾Œï¼ŒæŒ‰éˆ•æ‡‰è©²æ¢å¾©
  - å…¶ä»– rack ä»åœ¨åœè»Šæ ¼ä¸å½±éŸ¿åˆ¤æ–·

- [ ] **æŒ‡å®š rack ç§»å‹•æ¸¬è©¦**ï¼š
  - æŒ‡å®š rack ç§»å‹•åˆ°å…¶ä»–ä½ç½®
  - æŒ‰éˆ•æ‡‰è©²ç«‹å³æ¢å¾©ç‚ºã€Œæ´¾è»Šã€ç‹€æ…‹

### 3. **é‚Šç•Œæƒ…æ³æ¸¬è©¦**
- [ ] **rack_id ç„¡æ•ˆ**ï¼šç³»çµ±æ‡‰å›é€€åˆ°èˆŠé‚è¼¯
- [ ] **ä»»å‹™åƒæ•¸ç¼ºå¤±**ï¼šç³»çµ±æ‡‰æ­£å¸¸è™•ç†
- [ ] **è³‡æ–™åº«ç•°å¸¸**ï¼šç³»çµ±æ‡‰æœ‰é©ç•¶çš„éŒ¯èª¤è™•ç†

### 4. **æ—¥èªŒæª¢æŸ¥**
```bash
# æª¢æŸ¥ä»»å‹™ç›£æ§æ—¥èªŒ
tail -f /path/to/opui.log | grep "æ´¾è»Šä»»å‹™"

# æ‡‰è©²çœ‹åˆ°é¡ä¼¼çš„æ—¥èªŒï¼š
# ğŸš› æª¢æŸ¥æ´¾è»Šä»»å‹™ 123: node_id=456, status=1
# ğŸ” å¾ä»»å‹™ 123 æå–åˆ° rack_id: 789
# ğŸ” Rack 789 ç•¶å‰ä½ç½®: 999, ç›®æ¨™ä½ç½®: 456, æ˜¯å¦åœ¨ä½ç½®: False
# âœ… æ´¾è»Šä»»å‹™ 123 æª¢æ¸¬åˆ°æŒ‡å®š rack 789 å·²é›¢é–‹åœè»Šæ ¼ 456ï¼Œè§¸ç™¼å®Œæˆå›èª¿
```

## ğŸ“ å¾ŒçºŒå»ºè­°

### 1. **ç›£æ§å’Œæ—¥èªŒ**
- å¢åŠ æ›´è©³ç´°çš„ rack ç§»å‹•æ—¥èªŒ
- ç›£æ§æ´¾è»Šä»»å‹™å®Œæˆçš„æº–ç¢ºæ€§
- å»ºç«‹ä»»å‹™å®Œæˆæ™‚é–“çš„çµ±è¨ˆ

### 2. **æ€§èƒ½å„ªåŒ–**
- è€ƒæ…®å¿«å– rack ä½ç½®è³‡è¨Š
- å„ªåŒ–è³‡æ–™åº«æŸ¥è©¢é »ç‡
- æ¸›å°‘ä¸å¿…è¦çš„ç‹€æ…‹æª¢æŸ¥

### 3. **åŠŸèƒ½æ“´å±•**
- æ”¯æ´æ‰¹é‡æ´¾è»Šä»»å‹™
- å¢åŠ ä»»å‹™å„ªå…ˆç´šè™•ç†
- å»ºç«‹ä»»å‹™å®Œæˆé€šçŸ¥æ©Ÿåˆ¶

## ğŸ‰ çµè«–

é€šéé€™æ¬¡ä¿®å¾©ï¼ŒOPUI çš„æ´¾è»Šä»»å‹™ç›£æ§é‚è¼¯å·²ç¶“å®Œå…¨ç¬¦åˆæ¥­å‹™éœ€æ±‚ï¼š

1. **ç²¾ç¢ºæª¢æ¸¬**ï¼šåªæª¢æŸ¥æŒ‡å®š rack æ˜¯å¦é›¢é–‹ï¼Œä¸å†è¦æ±‚åœè»Šæ ¼å®Œå…¨ç‚ºç©º
2. **å³æ™‚éŸ¿æ‡‰**ï¼šrack é›¢é–‹å¾Œç«‹å³è§¸ç™¼å‰ç«¯æŒ‰éˆ•ç‹€æ…‹æ›´æ–°
3. **æ¥­å‹™æ­£ç¢º**ï¼šç¬¦åˆå¯¦éš›æ´¾è»Šæ“ä½œçš„æ¥­å‹™é‚è¼¯
4. **ç³»çµ±ç©©å®š**ï¼šä¿æŒå‘å¾Œç›¸å®¹æ€§å’Œå®Œå–„çš„éŒ¯èª¤è™•ç†

ç¾åœ¨æ´¾è»ŠæŒ‰éˆ•èƒ½æ­£ç¢ºåæ˜ ä»»å‹™ç‹€æ…‹ï¼Œæä¾›æ›´å¥½çš„ç”¨æˆ¶é«”é©—å’Œæ“ä½œåé¥‹ã€‚
