# OPUI 料架選擇狀態同步除錯指南

## 🔍 問題診斷

### 問題描述
料架被 AGV 搬離停車格後，前端的料架選擇狀態沒有即時更新。

### 可能的原因
1. **任務監控邏輯問題**：派車任務完成檢測條件不正確
2. **Socket 事件未觸發**：後端沒有發送 parking_list 更新事件
3. **前端事件處理問題**：前端沒有正確接收或處理事件
4. **料架 ID 提取失敗**：無法從任務參數中提取 rack_id

## 🔧 除錯步驟

### 1. **檢查後端任務監控日誌**

```bash
# 啟動 OPUI 服務並查看日誌
cd /app/web_api_ws
colcon build --symlink-install
all_source
ros2 run opui opui_server

# 在另一個終端查看日誌
tail -f /path/to/opui.log | grep -E "(派車任務|rack_id|任務完成)"
```

**預期看到的日誌**：
```
🚛 檢查派車任務 123: node_id=456, status=1
🔍 嘗試從任務 123 提取 rack_id
🔍 任務參數類型: <class 'dict'>
🔍 任務參數內容: {'rack_id': 789, 'product_name': 'TEST', ...}
✅ 從任務 123 提取到 rack_id: 789
🔍 停車格 456 是否還有指定的 rack 789: False
✅ 派車任務 123 檢測到指定 rack 789 已離開停車格 456，觸發完成回調
```

### 2. **檢查前端 Socket 事件接收**

在瀏覽器開發者工具的 Console 中：

```javascript
// 檢查是否收到 parking_list 事件
// 應該看到類似的日誌：
// 🅿️ 收到停車格資料: {left: [...], right: [...]}
// 🅿️ 當前時間: 14:30:25
// 🔍 檢查料架選擇狀態同步...
```

### 3. **手動觸發料架狀態檢查**

在瀏覽器 Console 中執行：

```javascript
// 手動檢查當前狀態
const currentState = window.appStore.getState();
console.log('當前停車格資料:', currentState.data.parking);
console.log('當前操作狀態:', currentState.operation);

// 手動觸發料架驗證
if (window.socketAPI) {
    const newParkingData = currentState.data.parking;
    window.socketAPI._validateAndCleanRackSelections(newParkingData);
}
```

### 4. **檢查任務參數格式**

在後端日誌中查看任務參數的實際格式：

```python
# 在 task_monitor.py 的 _extract_rack_id_from_task 方法中
# 已添加詳細的除錯日誌，查看：
# 🔍 任務參數類型: <class 'dict'>
# 🔍 任務參數內容: {...}
```

## 🐛 常見問題和解決方案

### 問題 1：任務參數中沒有 rack_id

**症狀**：
```
⚠️ 任務 123 參數中沒有 rack_id 欄位
🔍 可用欄位: ['node_id', 'product_name', 'count', ...]
```

**解決方案**：
檢查派車任務創建時是否正確設定了 rack_id 參數。

### 問題 2：前端沒有收到 parking_list 事件

**症狀**：
- 後端日誌顯示任務完成
- 但前端沒有 "🅿️ 收到停車格資料" 日誌

**解決方案**：
1. 檢查 Socket 連線狀態
2. 確認後端是否正確發送事件
3. 檢查前端事件監聽器是否正確綁定

### 問題 3：料架驗證邏輯錯誤

**症狀**：
```
✅ 所有料架選擇都有效，無需清除
```
但實際上料架已經被搬離。

**解決方案**：
檢查 parking_list 資料格式和料架 ID 比較邏輯。

### 問題 4：狀態更新不同步

**症狀**：
- 料架選擇被清除
- 但 UI 沒有更新

**解決方案**：
確認 `updateRackSelection` 方法是否被正確調用。

## 🔧 修復驗證

### 測試步驟

1. **準備測試環境**：
   ```bash
   # 確保服務正常運行
   ros2 run opui opui_server
   ```

2. **執行派車操作**：
   - 選擇一個料架（記錄 rack_id）
   - 點擊派車按鈕
   - 確認任務創建成功

3. **模擬料架搬離**：
   - 在資料庫中更新料架位置
   - 或等待實際 AGV 搬離料架

4. **檢查前端更新**：
   - 觀察前端是否自動清除料架選擇
   - 檢查是否顯示通知訊息
   - 確認 UI 狀態正確更新

### 預期結果

1. **後端日誌**：
   ```
   ✅ 派車任務 123 檢測到指定 rack 789 已離開停車格 456，觸發完成回調
   ✅ 派車任務完成處理完畢: task_id=123, node_id=456, machine_id=1
   ```

2. **前端日誌**：
   ```
   🅿️ 收到停車格資料: {left: [...], right: [...]}
   ⚠️ 檢測到無效料架選擇: left 產品 0 的料架 789 已不存在於停車格
   🔄 已清除無效的料架選擇，準備同步到後端
   ✅ 料架選擇狀態同步完成
   ```

3. **用戶界面**：
   - 料架選擇區域不再顯示被搬離的料架
   - 產品設定中的料架選擇被清除
   - 顯示通知訊息："料架 789 已搬離，已自動清除選擇"

## 📝 故障排除清單

### 後端檢查
- [ ] 任務監控服務是否正常運行
- [ ] 派車任務是否正確創建（包含 rack_id 參數）
- [ ] 任務完成檢測邏輯是否正確觸發
- [ ] Socket 事件是否正確發送

### 前端檢查
- [ ] Socket 連線是否正常
- [ ] parking_list 事件監聽器是否正確綁定
- [ ] 料架驗證邏輯是否正確執行
- [ ] UI 更新方法是否被調用

### 資料檢查
- [ ] 任務參數格式是否正確
- [ ] parking_list 資料結構是否正確
- [ ] 料架 ID 比較邏輯是否正確

## 🎯 成功指標

修復成功後，應該能看到：

1. **即時響應**：料架搬離後 5-10 秒內前端自動更新
2. **狀態一致**：UI 狀態與實際停車格狀態保持同步
3. **用戶通知**：清楚的狀態變更通知
4. **日誌完整**：完整的除錯日誌記錄整個過程

## 📞 進一步支援

如果問題仍然存在，請提供：

1. **完整的後端日誌**（包含任務創建到完成的整個過程）
2. **前端 Console 日誌**（包含 Socket 事件和狀態更新）
3. **具體的測試步驟**和預期 vs 實際結果
4. **資料庫中的任務記錄**（Task 表中的相關記錄）

這將幫助進一步診斷和解決問題。
