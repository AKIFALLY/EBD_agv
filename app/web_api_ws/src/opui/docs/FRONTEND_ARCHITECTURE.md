# OPUI 前端架構說明

## 🏗️ 模組化架構

OPUI 採用按頁面功能分離的模組化前端架構，提供更好的維護性和擴展性：

### ✨ 架構特色
- ✅ **頁面功能分離**：每個頁面都有專用的 JavaScript 檔案處理其特定功能
- ✅ **統一狀態管理**：使用 miniStore 提供輕量級狀態管理
- ✅ **模組化設計**：清晰的職責分離，易於維護和擴展
- ✅ **直接資料庫連接**：使用 `db_proxy` 的 `connection_pool_manager`
- ✅ **統一通訊層**：`SocketAPI` 類別統一處理前後端通訊

### 📁 檔案結構
```
static/
├── index.js    # 共用功能 (全域初始化、Store狀態管理、Socket連線處理)
└── js/
    ├── api.js      # Socket.IO 通訊層
    ├── store.js    # 統一狀態管理 (appStore)
    ├── notify.js   # 通知系統
    ├── pages/      # 頁面專用功能模組
    │   ├── homePage.js     # Home 頁面專用功能
    │   ├── settingPage.js  # Settings 頁面專用功能
    │   └── rackPage.js     # Rack 頁面專用功能
    └── lib/        # 第三方庫
        ├── miniStore.js    # 輕量級狀態管理庫
        └── socket.io.js    # Socket.IO 客戶端庫
```

3. **重新建置**：
   ```bash
   cd /app/web_api_ws
   colcon build --packages-select opui --symlink-install
   ```

4. **重新啟動服務**：
   ```bash
   source install/setup.bash
   ros2 run opui op_ui_server
   ```

5. **清除瀏覽器快取**：
   - 按 `Ctrl+F5` 強制重新載入
   - 或開啟開發者工具，右鍵重新整理按鈕選擇「清空快取並強制重新載入」

## ✅ 架構穩定性

### 當前架構狀態
- ✅ **完全穩定**：所有功能已經過完整測試和驗證
- ✅ **產品選擇功能**：正常運作
- ✅ **數量設定功能**：正常運作
- ✅ **房號選擇功能**：正常運作
- ✅ **料架選擇功能**：正常運作
- ✅ **叫車功能**：正常運作
- ✅ **派車功能**：正常運作
- ✅ **狀態同步**：已優化，防止無限循環
- ✅ **日誌輸出**：已清理，保持控制台整潔
- ✅ **程式碼維護**：模組化設計，易於維護

## 🎯 架構優勢

### 開發優勢
- **模組化設計**：每個頁面功能獨立，修改不會相互影響
- **清晰職責分離**：共用功能與頁面專用功能明確分離
- **易於擴展**：新增頁面功能只需新增對應的 JavaScript 檔案
- **維護簡單**：問題定位精確，修復效率高

### 運行優勢
- **載入效能**：按需載入頁面專用功能
- **記憶體效率**：避免載入不必要的功能模組
- **除錯友善**：模組化結構便於問題追蹤

## 🔍 除錯指南

### 檢查架構載入狀態
打開瀏覽器開發者工具的 Console，查看初始化訊息：
- 正常載入：`📱 OPUI 初始化完成`
- 頁面功能：各頁面會顯示對應的初始化訊息

### 常見問題

1. **按鈕點擊沒有反應**
   - 檢查瀏覽器 Console 是否有 JavaScript 錯誤
   - 確認是否清除了瀏覽器快取
   - 檢查對應頁面的 JavaScript 檔案是否正確載入

2. **狀態不同步**
   - 檢查 Socket.IO 連線狀態
   - 檢查 miniStore 狀態管理
   - 確認 appStore 是否正確初始化

3. **頁面載入錯誤**
   - 檢查服務器日誌
   - 確認靜態檔案路徑正確
   - 重新建置專案

## 🚀 開發指南

### 新增頁面功能
1. **創建頁面專用檔案**：在 `js/pages/` 目錄下創建新的 JavaScript 檔案
2. **實作頁面邏輯**：在檔案中實作該頁面的專用功能
3. **更新共用功能**：如需要，在 `index.js` 中新增共用邏輯
4. **測試功能**：確保新功能與現有功能不衝突

### 修改現有功能
1. **定位功能模組**：確定功能屬於哪個頁面或共用模組
2. **修改對應檔案**：在正確的檔案中進行修改
3. **測試影響範圍**：確保修改不會影響其他功能
4. **更新文檔**：如有必要，更新相關文檔

## 📞 技術支援

如果在使用過程中遇到問題：

1. **檢查日誌**：查看瀏覽器 Console 和服務器日誌
2. **確認檔案載入**：檢查所有 JavaScript 檔案是否正確載入
3. **重新建置**：執行完整的建置流程
4. **聯繫開發團隊**：提供詳細的錯誤資訊

當前架構已經穩定可靠，可以放心使用於生產環境！
