# OPUI - æ“ä½œå“¡ä»‹é¢ç³»çµ±

OPUI (Operator User Interface) æ˜¯ä¸€å€‹åŸºæ–¼ ROS2ã€FastAPI + Socket.IO çš„å³æ™‚ Web æ‡‰ç”¨ç¨‹å¼ï¼Œå°ˆç‚º AGV èª¿åº¦ç³»çµ±çš„æ“ä½œå“¡ä»‹é¢è¨­è¨ˆã€‚

## ğŸ¯ ç³»çµ±æ¦‚è¿°

OPUI è² è²¬æä¾›æ“ä½œå“¡å‹å–„çš„ Web ä»‹é¢ï¼Œç”¨æ–¼ç®¡ç† AGV ä»»å‹™èª¿åº¦ã€ç›£æ§ç³»çµ±ç‹€æ…‹ï¼Œä¸¦èˆ‡å¾Œç«¯ RCS ç³»çµ±å”ä½œå®Œæˆè‡ªå‹•åŒ–å€‰å„²ä½œæ¥­ã€‚

### æ ¸å¿ƒåŠŸèƒ½
- ğŸš› **AGV ä»»å‹™ç®¡ç†**ï¼šåŠ å…¥æ–™æ¶ï¼ˆadd rackï¼‰å’Œæ´¾è»Šï¼ˆdispatch carï¼‰æ“ä½œ
- ğŸ“Š **å³æ™‚ç›£æ§**ï¼šä»»å‹™ç‹€æ…‹ã€æ–™æ¶ä½ç½®ã€æ©Ÿå°ç‹€æ…‹å³æ™‚æ›´æ–°
- ğŸ­ **å¤šæ©Ÿå°æ”¯æ´**ï¼šæ”¯æ´å¤šå€‹ç”Ÿç”¢æ©Ÿå°çš„ä¸¦è¡Œæ“ä½œ
- ğŸ“¦ **æ–™æ¶ç®¡ç†**ï¼šæ–™æ¶åˆ†é…ã€ç§»å‹•è¿½è¹¤ã€ç‹€æ…‹åŒæ­¥
- ğŸ—ï¸ **å·¥ä½œå€é…ç½®**ï¼šæ”¯æ´å·¥ä½œå€èˆ‡åœè»Šæ ¼åˆ†é›¢æ¶æ§‹ï¼Œè‡ªå‹•åˆ†é…æ–™æ¶ä½ç½®
- ğŸ”„ **è³‡æ–™åŒæ­¥**ï¼šèˆ‡è³‡æ–™åº«å’Œå…¶ä»–ç³»çµ±çš„å³æ™‚è³‡æ–™åŒæ­¥

### ç³»çµ±ç‰¹è‰²
- âœ… **å·¥ä½œå€ç®¡ç†**ï¼šå·¥ä½œå€èˆ‡åœè»Šæ ¼åˆ†é›¢è¨­è¨ˆï¼Œæä¾›å½ˆæ€§çš„æ–™æ¶å®¹é‡ç®¡ç†
  - æ¯å€‹ä½œæ¥­å“¡æ“æœ‰ç¨ç«‹å·¥ä½œå€ï¼ˆå¯é…ç½®å¤šå€‹ä½ç½®ï¼‰
  - è‡ªå‹•åˆ†é…å¯ç”¨å·¥ä½œå€ä½ç½®
  - å®Œå–„çš„æ»¿è¼‰ä¿è­·æ©Ÿåˆ¶
- âœ… **æ¨¡çµ„åŒ–å‰ç«¯æ¶æ§‹**ï¼šæŒ‰é é¢åŠŸèƒ½åˆ†é›¢çš„ JavaScript æ¶æ§‹
  - `index.js`: å…±ç”¨åŠŸèƒ½ï¼ˆå…¨åŸŸåˆå§‹åŒ–ã€Store ç‹€æ…‹ç®¡ç†ã€Socket é€£ç·šè™•ç†ï¼‰
  - `pages/homePage.js`: Home é é¢å°ˆç”¨åŠŸèƒ½ï¼ˆç”¢å“é¸æ“‡ã€æ•¸é‡è¨­å®šã€æˆ¿è™Ÿé¸æ“‡ï¼‰
  - `pages/settingPage.js`: Settings é é¢å°ˆç”¨åŠŸèƒ½ï¼ˆç”¢å“ç®¡ç†ã€ç³»çµ±è¨­å®šï¼‰
  - `pages/rackPage.js`: Rack é é¢å°ˆç”¨åŠŸèƒ½ï¼ˆæ–™æ¶ç®¡ç†ï¼‰
- âœ… **åˆ†é›¢å¼å¾Œç«¯æ¶æ§‹**ï¼šæŒ‰åŠŸèƒ½è·è²¬åˆ†é›¢çš„ Python æ¶æ§‹
  - `op_ui_server.py`: FastAPI ä¼ºæœå™¨å’Œ HTTP è·¯ç”±è™•ç†
  - `op_ui_socket.py`: Socket.IO äº‹ä»¶è™•ç†å’Œå³æ™‚é€šè¨ŠåŠŸèƒ½
- âœ… **çµ±ä¸€ç‹€æ…‹ç®¡ç†**ï¼šåŸºæ–¼ miniStore çš„è¼•é‡ç´šç‹€æ…‹ç®¡ç†
  - `userStore`: ç”¨æˆ¶ç‹€æ…‹ç®¡ç†ï¼ˆclientIdã€machineIdã€é€£ç·šç‹€æ…‹ï¼‰
  - `operationStore`: æ“ä½œç‹€æ…‹ç®¡ç†ï¼ˆå·¦å³å´æ“ä½œç‹€æ…‹ï¼‰
  - `dataStore`: è³‡æ–™ç‹€æ…‹ç®¡ç†ï¼ˆproductsã€machinesã€roomsã€parkingï¼‰
  - `tasksStore`: ä»»å‹™ç‹€æ…‹ç®¡ç†ï¼ˆæ´»èºä»»å‹™è¿½è¹¤ï¼‰
  - `uiStore`: UI ç‹€æ…‹ç®¡ç†ï¼ˆè¼‰å…¥ç‹€æ…‹ã€é€šçŸ¥è¨Šæ¯ï¼‰
- âœ… **ç›´æ¥è³‡æ–™åº«é€£æ¥**ï¼šä½¿ç”¨ db_proxy çš„ connection_pool_manager
- âœ… **å³æ™‚é€šè¨Š**ï¼šåŸºæ–¼ Socket.IO çš„é›™å‘å³æ™‚é€šè¨Š
- âœ… **æ–°æ‰‹å‹å–„**ï¼šé©åˆåˆå­¸è€…åœ˜éšŠçš„ç°¡åŒ–æ¶æ§‹è¨­è¨ˆ

## ğŸ“š æ–‡ä»¶å°è¦½

- **[æ¸¬è©¦æ–‡ä»¶](tests/README.md)** - æ¸¬è©¦æ¡†æ¶å’Œæ¸¬è©¦æŒ‡å—
- **[CLAUDE.md](CLAUDE.md)** - AI é–‹ç™¼åŠ©æ‰‹æŒ‡å°æ–‡æª”

## ğŸš€ å¿«é€Ÿé–‹å§‹

```bash
# 1. å»ºç½®å°ˆæ¡ˆ
cd /app/web_api_ws
colcon build --packages-select opui --symlink-install

# 2. è¨­å®šç’°å¢ƒ
all_source  # æˆ– source install/setup.bash

# 3. å•Ÿå‹•æœå‹™
ros2 run opui op_ui_server

# 4. è¨ªå•ä»‹é¢
# ä¸»é é¢: http://localhost:8002/
# è¨­å®šé é¢: http://localhost:8002/setting
# æ–™æ¶ç®¡ç†é é¢: http://localhost:8002/rack
```

## ğŸ—ï¸ ç³»çµ±æ¶æ§‹

### æ•´é«”æ¶æ§‹åœ–

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   Socket.IO   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   db_proxy   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    å‰ç«¯ (Web)       â”‚ â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚    å¾Œç«¯ (Python)    â”‚ â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚   è³‡æ–™åº« (PostgreSQL) â”‚
â”‚                     â”‚               â”‚                     â”‚              â”‚                     â”‚
â”‚ æ¨¡çµ„åŒ–æ¶æ§‹:         â”‚               â”‚ åˆ†é›¢å¼æ¶æ§‹:         â”‚              â”‚ â€¢ Client            â”‚
â”‚ â€¢ index.js (å…±ç”¨)   â”‚               â”‚ â€¢ op_ui_server.py   â”‚              â”‚ â€¢ Product           â”‚
â”‚ â€¢ pages/            â”‚               â”‚   (APIå’Œè·¯ç”±è™•ç†)   â”‚              â”‚ â€¢ Machine           â”‚
â”‚   â”œâ”€homePage.js     â”‚               â”‚ â€¢ op_ui_socket.py   â”‚              â”‚ â€¢ Room              â”‚
â”‚   â”œâ”€settingPage.js  â”‚               â”‚   (Socket.IOåŠŸèƒ½)   â”‚              â”‚ â€¢ Rack              â”‚
â”‚   â””â”€rackPage.js     â”‚               â”‚ â€¢ task_monitor.py   â”‚              â”‚ â€¢ Task              â”‚
â”‚                     â”‚               â”‚ â€¢ database/ops.py   â”‚              â”‚                     â”‚
â”‚ ç‹€æ…‹ç®¡ç† (miniStore):â”‚               â”‚ â€¢ api/ routers      â”‚              â”‚                     â”‚
â”‚ â€¢ userStore         â”‚               â”‚ â€¢ constants/        â”‚              â”‚                     â”‚
â”‚ â€¢ operationStore    â”‚               â”‚                     â”‚              â”‚                     â”‚
â”‚ â€¢ dataStore         â”‚               â”‚                     â”‚              â”‚                     â”‚
â”‚ â€¢ tasksStore        â”‚               â”‚                     â”‚              â”‚                     â”‚
â”‚ â€¢ uiStore           â”‚               â”‚                     â”‚              â”‚                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### èˆ‡å…¶ä»–ç³»çµ±çš„æ•´åˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    ä»»å‹™å‰µå»º    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    AGVèª¿åº¦    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    OPUI     â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚     RCS     â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚ KUKA Fleet  â”‚
â”‚  æ“ä½œå“¡ä»‹é¢  â”‚               â”‚   èª¿åº¦æ ¸å¿ƒ   â”‚               â”‚   Adapter   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                             â”‚                             â”‚
       â”‚ è³‡æ–™åº«æŸ¥è©¢                   â”‚ ä»»å‹™ç›£æ§                     â”‚ AGVæ§åˆ¶
       â†“                             â†“                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  db_proxy   â”‚               â”‚     WCS     â”‚               â”‚    KUKA     â”‚
â”‚  è³‡æ–™åº«ä»£ç†  â”‚               â”‚   å€‰å„²æ§åˆ¶   â”‚               â”‚   AGVè»ŠéšŠ    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“ å°ˆæ¡ˆçµæ§‹

```
opui/
â”œâ”€â”€ opui/                        # ä¸»è¦ç¨‹å¼ç¢¼ç›®éŒ„
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ core/                    # æ ¸å¿ƒæœå‹™å±¤
â”‚   â”‚   â”œâ”€â”€ op_ui_server.py     # FastAPI ä¼ºæœå™¨ä¸»ç¨‹å¼ (APIå’Œè·¯ç”±è™•ç†)
â”‚   â”‚   â”œâ”€â”€ op_ui_socket.py     # Socket.IO äº‹ä»¶è™•ç† (å³æ™‚é€šè¨ŠåŠŸèƒ½)
â”‚   â”‚   â”œâ”€â”€ task_service.py     # ä»»å‹™æ¥­å‹™é‚è¼¯æœå‹™
â”‚   â”‚   â””â”€â”€ device_auth.py      # è¨­å‚™æˆæ¬Šé©—è­‰
â”‚   â”œâ”€â”€ database/               # è³‡æ–™åº«å±¤
â”‚   â”‚   â””â”€â”€ operations.py       # è³‡æ–™åº«æ“ä½œ (ä½¿ç”¨ db_proxy)
â”‚   â”œâ”€â”€ api/                    # REST API è·¯ç”±
â”‚   â”‚   â”œâ”€â”€ _client.py          # å®¢æˆ¶ç«¯ç›¸é—œ API
â”‚   â”‚   â”œâ”€â”€ agv.py              # AGV ç›¸é—œ API
â”‚   â”‚   â”œâ”€â”€ license.py          # æˆæ¬Šç›¸é—œ API
â”‚   â”‚   â”œâ”€â”€ node.py             # ç¯€é»ç›¸é—œ API
â”‚   â”‚   â”œâ”€â”€ process_settings.py # è£½ç¨‹è¨­å®š API
â”‚   â”‚   â””â”€â”€ product.py          # ç”¢å“ç›¸é—œ API
â”‚   â”œâ”€â”€ constants/              # å¸¸æ•¸å®šç¾©
â”‚   â”‚   â”œâ”€â”€ parking_status.py   # åœè»Šä½ç‹€æ…‹å¸¸æ•¸
â”‚   â”‚   â””â”€â”€ task_status.py      # ä»»å‹™ç‹€æ…‹å¸¸æ•¸
â”‚   â”œâ”€â”€ monitoring/             # ç›£æ§æ¨¡çµ„
â”‚   â”‚   â””â”€â”€ task_monitor.py     # ä»»å‹™ç‹€æ…‹ç›£æ§
â”‚   â””â”€â”€ frontend/               # å‰ç«¯è³‡æº
â”‚       â”œâ”€â”€ static/
â”‚       â”‚   â”œâ”€â”€ index.js        # å…±ç”¨åŠŸèƒ½ (å…¨åŸŸåˆå§‹åŒ–ã€Storeç‹€æ…‹ç®¡ç†ã€Socketé€£ç·š)
â”‚       â”‚   â”œâ”€â”€ js/
â”‚       â”‚   â”‚   â”œâ”€â”€ api.js      # Socket.IO é€šè¨Šå±¤
â”‚       â”‚   â”‚   â”œâ”€â”€ store.js    # çµ±ä¸€ç‹€æ…‹ç®¡ç† (appStore)
â”‚       â”‚   â”‚   â”œâ”€â”€ notify.js   # é€šçŸ¥ç³»çµ±
â”‚       â”‚   â”‚   â”œâ”€â”€ pages/      # é é¢å°ˆç”¨åŠŸèƒ½æ¨¡çµ„
â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ homePage.js    # Home é é¢å°ˆç”¨åŠŸèƒ½
â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ settingPage.js # Settings é é¢å°ˆç”¨åŠŸèƒ½
â”‚       â”‚   â”‚   â”‚   â””â”€â”€ rackPage.js    # Rack é é¢å°ˆç”¨åŠŸèƒ½
â”‚       â”‚   â”‚   â”œâ”€â”€ lib/
â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ miniStore.js   # è¼•é‡ç´šç‹€æ…‹ç®¡ç†åº«
â”‚       â”‚   â”‚   â”‚   â””â”€â”€ socket.io.js   # Socket.IO å®¢æˆ¶ç«¯åº«
â”‚       â”‚   â”‚   â””â”€â”€ performance-test.js # æ•ˆèƒ½æ¸¬è©¦å·¥å…·
â”‚       â”‚   â”œâ”€â”€ css/            # æ¨£å¼æª”æ¡ˆ
â”‚       â”‚   â”‚   â”œâ”€â”€ bulma_1_0_4.min.css        # Bulma CSS æ¡†æ¶
â”‚       â”‚   â”‚   â”œâ”€â”€ materialdesignicons.min.css # Material Design åœ–ç¤º
â”‚       â”‚   â”‚   â””â”€â”€ opui-bulma-extend.css      # OPUI è‡ªå®šç¾©æ¨£å¼æ“´å±•
â”‚       â”‚   â”œâ”€â”€ fonts/          # å­—å‹æª”æ¡ˆ
â”‚       â”‚   â”‚   â””â”€â”€ materialdesignicons-webfont.* # Material Design åœ–ç¤ºå­—å‹
â”‚       â”‚   â””â”€â”€ favicon.png     # ç¶²ç«™åœ–ç¤º
â”‚       â””â”€â”€ templates/          # HTML æ¨¡æ¿
â”‚           â”œâ”€â”€ base.html       # åŸºç¤æ¨¡æ¿
â”‚           â”œâ”€â”€ navbar.html     # å°èˆªåˆ—æ¨¡æ¿
â”‚           â”œâ”€â”€ home.html       # æ“ä½œä¸»é 
â”‚           â”œâ”€â”€ setting.html    # è¨­å®šé é¢
â”‚           â”œâ”€â”€ rack.html       # æ–™æ¶ç®¡ç†é é¢
â”‚           â””â”€â”€ unauthorized.html # æœªæˆæ¬Šé é¢
â”œâ”€â”€ tests/                      # æ¸¬è©¦ç›®éŒ„
â”‚   â”œâ”€â”€ refactor/              # é‡æ§‹æ¸¬è©¦
â”‚   â”‚   â”œâ”€â”€ test_syntax.py     # èªæ³•é©—è­‰æ¸¬è©¦
â”‚   â”‚   â””â”€â”€ test_refactor.py   # æ¶æ§‹é‡æ§‹æ¸¬è©¦
â”‚   â”œâ”€â”€ validation/            # åŠŸèƒ½é©—è­‰æ¸¬è©¦
â”‚   â”‚   â”œâ”€â”€ test_dispatch_fix.py # æ´¾è»ŠåŠŸèƒ½ä¿®å¾©æ¸¬è©¦
â”‚   â”‚   â”œâ”€â”€ test_socket_functions.py # Socket.IO åŠŸèƒ½æ¸¬è©¦
â”‚   â”‚   â””â”€â”€ test_final_validation.py # æœ€çµ‚é©—è­‰æ¸¬è©¦
â”‚   â”œâ”€â”€ integration/           # æ•´åˆæ¸¬è©¦
â”‚   â”‚   â””â”€â”€ test_integration.py # ç³»çµ±æ•´åˆæ¸¬è©¦
â”‚   â”œâ”€â”€ run_refactor_tests.py  # é‡æ§‹æ¸¬è©¦é‹è¡Œå™¨
â”‚   â”œâ”€â”€ run_all_tests.py       # å…¨éƒ¨æ¸¬è©¦é‹è¡Œå™¨
â”‚   â”œâ”€â”€ test_current_architecture.py # ç•¶å‰æ¶æ§‹é©—è­‰æ¸¬è©¦
â”‚   â”œâ”€â”€ test_db.py             # è³‡æ–™åº«æ¸¬è©¦
â”‚   â”œâ”€â”€ test_op_ui_server.py   # ä¼ºæœå™¨æ¸¬è©¦
â”‚   â”œâ”€â”€ test_op_ui_socket.py   # Socket äº‹ä»¶æ¸¬è©¦
â”‚   â”œâ”€â”€ test_performance.py    # æ•ˆèƒ½æ¸¬è©¦
â”‚   â”œâ”€â”€ test_socket_api_format_consistency.py # Socket API æ ¼å¼ä¸€è‡´æ€§æ¸¬è©¦
â”‚   â””â”€â”€ requirements-test.txt  # æ¸¬è©¦ä¾è³´å¥—ä»¶
â”œâ”€â”€ config/                     # é…ç½®æª”æ¡ˆ
â”‚   â””â”€â”€ settings.py            # ç³»çµ±è¨­å®š
â”œâ”€â”€ package.xml                 # ROS2 å¥—ä»¶é…ç½®
â”œâ”€â”€ setup.py                    # Python å¥—ä»¶é…ç½®
â”œâ”€â”€ setup.cfg                   # Python å¥—ä»¶è¨­å®š
â””â”€â”€ README.md                   # æœ¬æ–‡ä»¶
```

## ğŸ”§ æŠ€è¡“æ£§

### å‰ç«¯æŠ€è¡“
- **JavaScript**: ES6+ æ¨¡çµ„ç³»çµ±ï¼Œç„¡æ¡†æ¶ vanilla JS
- **ç‹€æ…‹ç®¡ç†**: è‡ªç ” miniStore è¼•é‡ç´šç‹€æ…‹ç®¡ç†åº«
- **UI æ¡†æ¶**: Bulma CSS æ¡†æ¶
- **åœ–ç¤º**: Material Design Icons
- **å³æ™‚é€šè¨Š**: Socket.IO å®¢æˆ¶ç«¯

### å¾Œç«¯æŠ€è¡“
- **Python**: 3.8+
- **Web æ¡†æ¶**: FastAPI (éåŒæ­¥ Web æ¡†æ¶)
- **å³æ™‚é€šè¨Š**: Socket.IO ä¼ºæœå™¨
- **è³‡æ–™åº«**: PostgreSQL
- **è³‡æ–™åº«æ“ä½œ**: db_proxy connection_pool_manager
- **ROS2**: æ©Ÿå™¨äººä½œæ¥­ç³»çµ±ç¬¬äºŒç‰ˆ

### åŸºç¤è¨­æ–½
- **å®¹å™¨åŒ–**: Docker (ROS2 ç’°å¢ƒ)
- **è³‡æ–™åº«ä»£ç†**: db_proxy çµ±ä¸€è³‡æ–™åº«é€£ç·šç®¡ç†
- **æ¸¬è©¦æ¡†æ¶**: pytest

## ğŸ”§ æ ¸å¿ƒçµ„ä»¶

### 1. å¾Œç«¯æ ¸å¿ƒæœå‹™ (é‡æ§‹å¾Œæ–°æ¶æ§‹)

#### op_ui_server.py - FastAPI ä¼ºæœå™¨ä¸»ç¨‹å¼
å°ˆè²¬ Web ä¼ºæœå™¨å’Œ HTTP è·¯ç”±ç®¡ç†ï¼š

**ä¸»è¦è·è²¬**ï¼š
- **FastAPI æ‡‰ç”¨åˆå§‹åŒ–**: é…ç½® CORSã€ä¸­é–“ä»¶ã€éœæ…‹æª”æ¡ˆ
- **HTTP è·¯ç”±ç®¡ç†**: `/home`, `/setting` é é¢è·¯ç”±
- **API è·¯ç”±æ•´åˆ**: æ•´åˆ process_settings, product, license API
- **Socket.IO æ•´åˆ**: å°‡ Socket.IO æ•´åˆåˆ° ASGI æ‡‰ç”¨ä¸­
- **è¨­å‚™æˆæ¬Šæª¢æŸ¥**: é©—è­‰è¨­å‚™ ID å’Œæˆæ¬Šç‹€æ…‹

#### op_ui_socket.py - Socket.IO äº‹ä»¶è™•ç†
å°ˆè²¬ Socket.IO äº‹ä»¶å’Œå³æ™‚é€šè¨Šç®¡ç†ï¼š

**ä¸»è¦äº‹ä»¶è™•ç†**ï¼š
- **é€£ç·šç®¡ç†**: `connect`, `disconnect`, `login`, `restore_client_by_id`
- **è³‡æ–™åŒæ­¥**: `client_update`, `notify_products/machines/rooms/parking_list`
- **AGV æ“ä½œ**: `add_rack` (åŠ å…¥æ–™æ¶), `dispatch_full` (æ´¾è»Š)
- **æ–™æ¶ç®¡ç†**: `add_rack`, `del_rack`
- **ä»»å‹™æ§åˆ¶**: `cancel_task`, `confirm_delivery`
- **å…±ç”¨é‚è¼¯**: çµ±ä¸€çš„å®¢æˆ¶ç«¯é€šçŸ¥ã€è³‡æ–™æ ¼å¼åŒ–ã€æœƒè©±è™•ç†

#### task_monitor.py - ä»»å‹™ç›£æ§
ç¨ç«‹çš„ä»»å‹™ç‹€æ…‹ç›£æ§æ¨¡çµ„ï¼š
- ç›£æ§é€²è¡Œä¸­çš„ä»»å‹™ç‹€æ…‹è®ŠåŒ–
- æª¢æ¸¬ä»»å‹™å®Œæˆæ¢ä»¶
- è§¸ç™¼ç‹€æ…‹åŒæ­¥å’Œ UI æ›´æ–°

#### database/operations.py - è³‡æ–™åº«æ“ä½œ
ä½¿ç”¨ db_proxy çš„ connection_pool_manager é€²è¡Œè³‡æ–™åº«æ“ä½œï¼š
- çµ±ä¸€çš„ CRUD æ“ä½œä»‹é¢
- é€£ç·šæ± ç®¡ç†ï¼Œæé«˜æ•ˆèƒ½
- æ”¯æ´äº‹å‹™è™•ç†

### 2. å‰ç«¯æ¶æ§‹

#### çµ±ä¸€ç‹€æ…‹ç®¡ç† (appStore)
ä½¿ç”¨å–®ä¸€ Store ç®¡ç†æ‰€æœ‰å‰ç«¯ç‹€æ…‹ï¼š

```javascript
const appStore = createStore('opuiAppState', {
    user: { clientId, machineId, isConnected },      // ä½¿ç”¨è€…ç‹€æ…‹
    operation: { left: {...}, right: {...} },        // æ“ä½œç‹€æ…‹
    data: { products, machines, rooms, parking },     // åŸºç¤è³‡æ–™
    tasks: { active: {...} },                        // ä»»å‹™ç‹€æ…‹
    ui: { loading, notifications }                    // UI ç‹€æ…‹
});
```

#### æ¨¡çµ„åŒ–ç®¡ç†å™¨
- **EventManager**: äº‹ä»¶è™•ç†ç®¡ç†
- **UIManager**: UI æ›´æ–°ç®¡ç†
- **PageManager**: é é¢é‚è¼¯ç®¡ç†
- **StateManager**: ç‹€æ…‹åŒæ­¥ç®¡ç†

#### é€šè¨Šå±¤ (SocketAPI)
çµ±ä¸€çš„å‰å¾Œç«¯é€šè¨Šä»‹é¢ï¼Œå°è£æ‰€æœ‰ Socket.IO æ“ä½œ

## ğŸ”„ è³‡æ–™æµç¨‹èˆ‡æ¥­å‹™é‚è¼¯

### 1. ç³»çµ±åˆå§‹åŒ–æµç¨‹
```
ä½¿ç”¨è€…é–‹å•Ÿç¶²é  â†’ Socket è‡ªå‹•é€£ç·š â†’ è§¸ç™¼ login äº‹ä»¶ â†’
å¾Œç«¯é©—è­‰ä¸¦å»ºç«‹æœƒè©± â†’ æ¨é€åŸºç¤è³‡æ–™ â†’ å‰ç«¯æ›´æ–° appStore â†’ UI æ¸²æŸ“
```

### 2. AGV ä»»å‹™æ“ä½œæµç¨‹

#### åŠ å…¥æ–™æ¶ (Add Rack) æµç¨‹
```
ä½œæ¥­å“¡æ‰‹å‹•æ¬é‹ç©ºrackåˆ°ä½œæ¥­å€ â†’ é»æ“Šã€ŒåŠ å…¥æ–™æ¶ã€æŒ‰éˆ• â†’
å¾ä¸‹æ‹‰é¸å–®é¸æ“‡Rackç·¨è™Ÿ â†’ Socket ç™¼é€ add_rack äº‹ä»¶ â†’
å¾Œç«¯è¨˜éŒ„rackåˆ°åœè»Šæ ¼ â†’ å›æ‡‰å‰ç«¯ â†’ æ›´æ–° UI ç‹€æ…‹
```

#### æ´¾è»Š (Dispatch Car) æµç¨‹
```
æ“ä½œå“¡é¸æ“‡ç”¢å“å’Œæ–™æ¶ â†’ é»æ“Šæ´¾è»Š â†’ Socket ç™¼é€ dispatch_full äº‹ä»¶ â†’
å¾Œç«¯å‰µå»º Task è¨˜éŒ„ â†’ å•Ÿå‹•ä»»å‹™ç›£æ§ â†’ å›æ‡‰å‰ç«¯ â†’ æ›´æ–°æ©Ÿå°ç‹€æ…‹
```

### 3. ä»»å‹™ç›£æ§èˆ‡å®Œæˆæª¢æ¸¬
```
ä»»å‹™å‰µå»º â†’ task_monitor é–‹å§‹ç›£æ§ â†’ å®šæœŸæª¢æŸ¥ä»»å‹™ç‹€æ…‹ â†’
æª¢æ¸¬å®Œæˆæ¢ä»¶ â†’ è§¸ç™¼å®Œæˆå›èª¿ â†’ æ›´æ–°è³‡æ–™åº« â†’ å»£æ’­ç‹€æ…‹è®Šæ›´
```

### 4. å³æ™‚è³‡æ–™åŒæ­¥
```
è³‡æ–™è®Šæ›´ (æ–™æ¶ç§»å‹•/ä»»å‹™ç‹€æ…‹) â†’ å¾Œç«¯æª¢æ¸¬ â†’ Socket å»£æ’­äº‹ä»¶ â†’
æ‰€æœ‰é€£ç·šå®¢æˆ¶ç«¯æ¥æ”¶ â†’ æ›´æ–° appStore â†’ UI è‡ªå‹•é‡æ–°æ¸²æŸ“
```

## ğŸš› AGV ä»»å‹™ç®¡ç†åŠŸèƒ½

### åŠ å…¥æ–™æ¶ (Add Rack) åŠŸèƒ½
**æ¥­å‹™å«ç¾©**: è¨˜éŒ„ä½œæ¥­å“¡æ‰‹å‹•æ¬é‹çš„ç©ºrackåˆ°å·¥ä½œå€

**æ“ä½œæµç¨‹**:
1. **å‰ç½®æ¢ä»¶**: å·¥ä½œå€æœ‰å¯ç”¨ç©ºé–“ï¼Œä½œæ¥­å“¡å·²æ‰‹å‹•æ¬é‹ç©ºrackåˆ°ä½œæ¥­å€
2. **æ“ä½œæ­¥é©Ÿ**:
   - æ“ä½œå“¡é»æ“Šã€ŒåŠ å…¥æ–™æ¶ã€æŒ‰éˆ•
   - å¾å½ˆå‡ºçš„Modalä¸­é¸æ“‡å°æ‡‰çš„rackç·¨è™Ÿ
   - é»æ“Šã€Œç¢ºèªåŠ å…¥ã€
3. **ç³»çµ±è™•ç†**:
   - ç³»çµ±è¼‰å…¥å¯ç”¨rackåˆ—è¡¨ï¼ˆlocation_idç‚º NULL çš„rackï¼‰
   - è‡ªå‹•åˆ†é…åˆ°ç¬¬ä¸€å€‹å¯ç”¨çš„å·¥ä½œå€ä½ç½®
   - æ›´æ–°è³‡æ–™åº«ä¸­rackä½ç½®
   - å»£æ’­å·¥ä½œå€ç‹€æ…‹è®Šæ›´

**å·¥ä½œå€é‚è¼¯**:
- **å„ªå…ˆä½¿ç”¨å·¥ä½œå€**: ç³»çµ±å„ªå…ˆå°‡æ–™æ¶åˆ†é…åˆ°å·¥ä½œå€ä½ç½®
- **çµ•ä¸ä½¿ç”¨åœè»Šæ ¼**: add_rack æ“ä½œçµ•ä¸ä½¿ç”¨åœè»Šæ ¼ä½ç½®
- **æ»¿è¼‰ä¿è­·**: ç•¶æ‰€æœ‰å·¥ä½œå€ä½ç½®éƒ½è¢«ä½”ç”¨æ™‚ï¼Œè¿”å›ã€Œå·¥ä½œå€å·²æ»¿ã€éŒ¯èª¤

**äº‹ä»¶åƒæ•¸**:
```python
{
    "side": "left",  # æˆ– "right"
    "rack": "R001",  # rackç·¨è™Ÿ
    "machine_id": 1,
    "client_id": "client_123"
}
```

### æ´¾è»Š (Dispatch Car) åŠŸèƒ½
**æ¥­å‹™å«ç¾©**: å‘¼å« AGV å°‡å·¥ä½œå€çš„æ–™æ¶é‹åˆ°åœè»Šæ ¼ï¼Œç„¶å¾Œé‹èµ°

**æ“ä½œæµç¨‹**:
1. **å‰ç½®æ¢ä»¶**: å·¥ä½œå€æœ‰æ–™æ¶ï¼Œå·²é¸æ“‡ç”¢å“å’Œæ•¸é‡
2. **æ“ä½œæ­¥é©Ÿ**: æ“ä½œå“¡é¸æ“‡ç”¢å“ã€æ•¸é‡å¾Œé»æ“Šæ´¾è»Š
3. **ç³»çµ±è™•ç†**:
   - æ”¶é›†ç”¢å“è³‡è¨Šã€æ–™æ¶ IDã€æ•¸é‡ç­‰
   - å°‡æ–™æ¶å¾å·¥ä½œå€ç§»å‹•åˆ°åœè»Šæ ¼
   - å‰µå»º dispatch_full é¡å‹ä»»å‹™
   - å•Ÿå‹•ä»»å‹™ç›£æ§
   - æ›´æ–°åœè»Šä½ç‹€æ…‹ç‚ºã€Œæ´¾é€ä¸­ã€

**ç§»å‹•è·¯å¾‘**: å·¥ä½œå€ â†’ åœè»Šæ ¼ â†’ ç›®æ¨™åœ°

**ä»»å‹™åƒæ•¸**:
```python
{
    "task_type": "dispatch_full",
    "product_name": "ç”¢å“A",
    "count": 32,
    "rack_id": 123,
    "room": 2,
    "side": "left"
}
```

### ä»»å‹™ç‹€æ…‹ç®¡ç†

**ç‹€æ…‹å®šç¾©** (èˆ‡è³‡æ–™åº« 13_works_tasks.py ä¿æŒåŒæ­¥):
- **status_id = 0**: è«‹æ±‚ä¸­ (UI-è«‹æ±‚åŸ·è¡Œä»»å‹™)
- **status_id = 1**: å¾…è™•ç† (WCS-ä»»å‹™å·²æ¥å—ï¼Œå¾…è™•ç†)
- **status_id = 2**: å¾…åŸ·è¡Œ (RCS-ä»»å‹™å·²æ´¾ç™¼ï¼Œå¾…åŸ·è¡Œ)
- **status_id = 3**: åŸ·è¡Œä¸­ (AGV-ä»»å‹™æ­£åœ¨åŸ·è¡Œ)
- **status_id = 4**: å·²å®Œæˆ (AGV-ä»»å‹™å·²å®Œæˆ)
- **status_id = 5**: å–æ¶ˆä¸­ (ä»»å‹™å–æ¶ˆ)
- **status_id = 51**: WCS-å–æ¶ˆä¸­ (WCS-ä»»å‹™å–æ¶ˆä¸­ï¼Œå¾…è™•ç†)
- **status_id = 52**: RCS-å–æ¶ˆä¸­ (RCS-ä»»å‹™å–æ¶ˆä¸­ï¼Œå–æ¶ˆä¸­)
- **status_id = 53**: AGV-å–æ¶ˆä¸­ (AGV-å–æ¶ˆå®Œæˆ)
- **status_id = 54**: å·²å–æ¶ˆ (ä»»å‹™å·²å–æ¶ˆ)
- **status_id = 6**: éŒ¯èª¤ (éŒ¯èª¤)

**ç‹€æ…‹å¸¸æ•¸ä½¿ç”¨**:
ç‚ºäº†é¿å…ç¡¬ç·¨ç¢¼ï¼Œå°ˆæ¡ˆä¸­æä¾›äº†çµ±ä¸€çš„ç‹€æ…‹å¸¸æ•¸å®šç¾©ï¼š

```python
# Python å¾Œç«¯
from opui.constants.task_status import TaskStatus

# ä½¿ç”¨å¸¸æ•¸è€Œéç¡¬ç·¨ç¢¼æ•¸å­—
if task.status_id == TaskStatus.EXECUTING:
    # è™•ç†åŸ·è¡Œä¸­çš„ä»»å‹™
    pass
```

```javascript
// JavaScript å‰ç«¯
import { TASK_STATUS_ID } from '../constants/taskStatus.js';

// ä½¿ç”¨å¸¸æ•¸è€Œéç¡¬ç·¨ç¢¼æ•¸å­—
if (status === TASK_STATUS_ID.EXECUTING) {
    // è™•ç†åŸ·è¡Œä¸­çš„ä»»å‹™
}
```

**å®Œæˆæª¢æ¸¬é‚è¼¯**:
- **æ´¾è»Šä»»å‹™**: æª¢æ¸¬åˆ°æŒ‡å®šæ–™æ¶é›¢é–‹åœè»Šä½æ™‚å®Œæˆ


## ğŸ—„ï¸ è³‡æ–™åº«æ•´åˆ

### è³‡æ–™åº«æ¶æ§‹
ä½¿ç”¨ `db_proxy` çš„ `ConnectionPoolManager` é€²è¡Œçµ±ä¸€è³‡æ–™åº«ç®¡ç†ï¼š

```python
# è³‡æ–™åº«é€£ç·šæ± 
db_url_agvc = 'postgresql+psycopg2://agvc:password@192.168.100.254/agvc'
connection_pool = ConnectionPoolManager(db_url_agvc)

# çµ±ä¸€ CRUD æ“ä½œä»‹é¢
client_crud = BaseCRUD(Client, id_column="id")
product_crud = BaseCRUD(Product, id_column="id")
machine_crud = BaseCRUD(Machine, id_column="id")
room_crud = BaseCRUD(Room, id_column="id")
rack_crud = BaseCRUD(Rack, id_column="id")
task_crud = BaseCRUD(Task, id_column="id")
```

### ä¸»è¦è³‡æ–™è¡¨çµæ§‹

| è³‡æ–™è¡¨ | ç”¨é€” | ä¸»è¦æ¬„ä½ |
|--------|------|----------|
| **Client** | å®¢æˆ¶ç«¯/æ“ä½œå“¡è³‡è¨Š | id, clientId, machineId, userAgent |
| **Product** | ç”¢å“è³‡æ–™ | id, name, size, room |
| **Machine** | æ©Ÿå°è³‡è¨Š | id, name, enable, workspace_1, workspace_2, parking_space_1, parking_space_2 |
| **Room** | æˆ¿é–“/å€åŸŸè³‡æ–™ | id, name, description |
| **Rack** | æ–™æ¶è³‡è¨Š | id, name, location_id, status |
| **Task** | ä»»å‹™è¨˜éŒ„ | id, name, work_id, status_id, parameters |
| **Work** | å·¥ä½œé¡å‹ | id, name, description |
| **TaskStatus** | ä»»å‹™ç‹€æ…‹ | id, name, description |

#### Machine è¡¨æ–°å¢æ¬„ä½ï¼ˆ2025-09 æ›´æ–°ï¼‰
- **workspace_1**: INTEGER[] - ä½œæ¥­å“¡1ï¼ˆå·¦å´ï¼‰çš„å·¥ä½œå€ location ID é™£åˆ—
- **workspace_2**: INTEGER[] - ä½œæ¥­å“¡2ï¼ˆå³å´ï¼‰çš„å·¥ä½œå€ location ID é™£åˆ—
- **parking_space_1**: INTEGER - ä½œæ¥­å“¡1ï¼ˆå·¦å´ï¼‰çš„åœè»Šæ ¼ location ID
- **parking_space_2**: INTEGER - ä½œæ¥­å“¡2ï¼ˆå³å´ï¼‰çš„åœè»Šæ ¼ location ID

### è³‡æ–™é—œè¯
- **Client** â†” **Machine**: æ“ä½œå“¡èˆ‡æ©Ÿå°çš„é—œè¯
- **Rack** â†” **Location**: æ–™æ¶èˆ‡åœè»Šä½çš„é—œè¯
- **Task** â†” **Work**: ä»»å‹™èˆ‡å·¥ä½œé¡å‹çš„é—œè¯
- **Task** â†” **TaskStatus**: ä»»å‹™èˆ‡ç‹€æ…‹çš„é—œè¯
- **Product** â†” **Room**: ç”¢å“èˆ‡æˆ¿é–“çš„é—œè¯

## ğŸš€ å®‰è£èˆ‡éƒ¨ç½²

### ç’°å¢ƒéœ€æ±‚
- **Python**: 3.8+
- **PostgreSQL**: è³‡æ–™åº«ä¼ºæœå™¨
- **ROS2**: æ©Ÿå™¨äººä½œæ¥­ç³»çµ± (Docker å®¹å™¨ç’°å¢ƒ)
- **Node.js**: (å¯é¸ï¼Œç”¨æ–¼å‰ç«¯é–‹ç™¼å·¥å…·)

### å®‰è£æ­¥é©Ÿ

#### 1. å»ºç½® ROS2 å¥—ä»¶
```bash
cd /app/web_api_ws
colcon build --packages-select opui --symlink-install
```

#### 2. è¨­å®šç’°å¢ƒè®Šæ•¸
```bash
# æ–¹æ³•ä¸€ï¼šä½¿ç”¨ all_source è…³æœ¬ (æ¨è–¦)
all_source

# æ–¹æ³•äºŒï¼šæ‰‹å‹•è¨­å®š
source install/setup.bash
```

#### 3. å•Ÿå‹•æœå‹™
```bash
ros2 run opui op_ui_server
```

#### 4. è¨ªå•ä»‹é¢
- **ä¸»é é¢**: http://localhost:8002/
- **è¨­å®šé é¢**: http://localhost:8002/setting
- **æ–™æ¶ç®¡ç†é é¢**: http://localhost:8002/rack

### é…ç½®é¸é …

#### ç’°å¢ƒè®Šæ•¸
```bash
# CORS è¨­å®š
export CORS_ALLOWED_ORIGINS="*"  # æˆ–æŒ‡å®šç‰¹å®šåŸŸå

# è³‡æ–™åº«é€£ç·š (åœ¨ database/operations.py ä¸­è¨­å®š)
DB_URL="postgresql+psycopg2://agvc:password@192.168.100.254/agvc"
```

#### æœå‹™åŸ è™Ÿ
- **Web æœå‹™**: 8002 (é è¨­)
- **Socket.IO**: èˆ‡ Web æœå‹™å…±ç”¨åŸ è™Ÿ

## ğŸ“¡ API æ–‡æª”

### Socket.IO äº‹ä»¶

#### å®¢æˆ¶ç«¯ â†’ ä¼ºæœå™¨äº‹ä»¶

| äº‹ä»¶åç¨± | åƒæ•¸ | èªªæ˜ |
|----------|------|------|
| `login` | `{clientId, machineId, userAgent}` | ä½¿ç”¨è€…ç™»å…¥é©—è­‰ |
| `client_update` | `{machineId, ...}` | æ›´æ–°å®¢æˆ¶ç«¯è¨­å®š |
| `add_rack` | `{side, rack}` | åŠ å…¥æ–™æ¶æ“ä½œ |
| `dispatch_full` | `{name, count, rackId, room, side}` | æ´¾è»Šæ“ä½œ |
| `cancel_task` | `{taskId}` | å–æ¶ˆä»»å‹™ |
| `add_rack` | `{rackName, locationId}` | æ–°å¢æ–™æ¶åˆ°åœè»Šä½ |
| `del_rack` | `{rackId}` | å¾åœè»Šä½ç§»é™¤æ–™æ¶ |

#### ä¼ºæœå™¨ â†’ å®¢æˆ¶ç«¯äº‹ä»¶

| äº‹ä»¶åç¨± | è³‡æ–™æ ¼å¼ | èªªæ˜ |
|----------|----------|------|
| `product_list` | `{products: [...]}` | ç”¢å“åˆ—è¡¨æ›´æ–° |
| `machine_list` | `{machines: [...]}` | æ©Ÿå°åˆ—è¡¨æ›´æ–° |
| `room_list` | `{rooms: [...]}` | æˆ¿é–“åˆ—è¡¨æ›´æ–° |
| `parking_list` | `{parking: {...}}` | åœè»Šä½åˆ—è¡¨æ›´æ–° |
| `notify_message` | `{message: "..."}` | æˆåŠŸé€šçŸ¥è¨Šæ¯ |
| `error_message` | `{message: "..."}` | éŒ¯èª¤è¨Šæ¯ |

### HTTP API ç«¯é»

| æ–¹æ³• | è·¯å¾‘ | èªªæ˜ |
|------|------|------|
| `GET` | `/` | ä¸»é é¢ |
| `GET` | `/setting` | è¨­å®šé é¢ |
| `GET` | `/rack` | æ–™æ¶ç®¡ç†é é¢ |
| `POST` | `/api/products` | ç”¢å“ç›¸é—œ API |
| `POST` | `/api/process-settings` | è£½ç¨‹è¨­å®š API |

### è³‡æ–™æ ¼å¼ç¯„ä¾‹

#### ä»»å‹™å‰µå»ºå›æ‡‰
```json
{
    "success": true,
    "message": "ä»»å‹™å‰µå»ºæˆåŠŸ",
    "task_id": 123
}
```

#### åœè»Šä½è³‡æ–™æ ¼å¼
```json
{
    "parking": {
        "1": {  // machine_id
            "left": {"node_id": 101, "rack": {...}},
            "right": {"node_id": 102, "rack": {...}}
        }
    }
}
```

## ğŸ› ï¸ é–‹ç™¼æŒ‡å—

### é–‹ç™¼ç’°å¢ƒè¨­å®š

#### 1. é–‹ç™¼å·¥ä½œæµç¨‹
```bash
# é–‹ç™¼æ™‚çš„æ¨™æº–æµç¨‹
cd /app/web_api_ws

# ä¿®æ”¹ç¨‹å¼ç¢¼å¾Œé‡æ–°å»ºç½®
colcon build --symlink-install

# è¨­å®šç’°å¢ƒè®Šæ•¸
all_source

# å•Ÿå‹•é–‹ç™¼ä¼ºæœå™¨
ros2 run opui op_ui_server
```

#### 2. å‰ç«¯é–‹ç™¼è¦ç¯„
- **æ¨¡çµ„ç³»çµ±**: ä½¿ç”¨ ES6 import/export
- **ç‹€æ…‹ç®¡ç†**: çµ±ä¸€ä½¿ç”¨ appStoreï¼Œé¿å…ç›´æ¥æ“ä½œ DOM
- **ç¨‹å¼ç¢¼çµ„ç¹”**: æŒ‰åŠŸèƒ½æ¨¡çµ„åŒ–ï¼Œä½¿ç”¨ç®¡ç†å™¨æ¨¡å¼
- **æ¨£å¼**: ä½¿ç”¨ Bulma CSS æ¡†æ¶ï¼Œé¿å…å…§è¯æ¨£å¼
- **é™¤éŒ¯**: é–‹ç™¼æ™‚å¯å–æ¶ˆè¨»è§£ console.logï¼Œæ­£å¼ç‰ˆæœ¬éœ€è¨»è§£

#### 3. å¾Œç«¯é–‹ç™¼è¦ç¯„
- **éåŒæ­¥è™•ç†**: ä½¿ç”¨ async/await è™•ç†æ‰€æœ‰ I/O æ“ä½œ
- **è³‡æ–™åº«æ“ä½œ**: çµ±ä¸€é€é db_proxy çš„ connection_pool_manager
- **éŒ¯èª¤è™•ç†**: ä½¿ç”¨ try-catch åŒ…è£æ‰€æœ‰è³‡æ–™åº«æ“ä½œ
- **Socket äº‹ä»¶**: ä¿æŒäº‹ä»¶è™•ç†å‡½æ•¸ç°¡æ½”ï¼Œè¤‡é›œé‚è¼¯ç§»è‡³æœå‹™å±¤
- **æ—¥èªŒè¨˜éŒ„**: é‡è¦æ“ä½œéœ€è¨˜éŒ„æ—¥èªŒï¼Œä¾¿æ–¼é™¤éŒ¯

### æ¸¬è©¦æ¡†æ¶

#### é‹è¡Œæ¸¬è©¦
```bash
# åœ¨ OPUI å°ˆæ¡ˆç›®éŒ„ä¸‹é‹è¡Œæ‰€æœ‰æ¸¬è©¦
cd /app/web_api_ws/src/opui
python -m pytest tests/ -v

# é‹è¡Œç‰¹å®šæ¸¬è©¦æª”æ¡ˆ
python -m pytest tests/test_db.py -v

# é‹è¡Œç‰¹å®šæ¸¬è©¦é¡åˆ¥
python -m pytest tests/test_op_ui_socket.py::TestSocketEvents -v

# ä½¿ç”¨ ROS2 æ¸¬è©¦æ¡†æ¶
colcon test --packages-select opui
```

#### æ¸¬è©¦è¦†è“‹ç¯„åœ
- **å–®å…ƒæ¸¬è©¦**: è³‡æ–™åº«æ“ä½œã€Socket äº‹ä»¶è™•ç†
- **æ•´åˆæ¸¬è©¦**: å‰å¾Œç«¯æ•´åˆã€å¤šä½¿ç”¨è€…ä¸¦ç™¼
- **æ•ˆèƒ½æ¸¬è©¦**: Socket é€£ç·šæ•ˆèƒ½ã€API å›æ‡‰æ™‚é–“

## ğŸ”— èˆ‡å…¶ä»–ç³»çµ±çš„æ•´åˆ

### RCS (Robot Control System) æ•´åˆ
- **é—œä¿‚**: OPUI å‰µå»ºä»»å‹™ï¼ŒRCS è² è²¬å¯¦éš›çš„ AGV èª¿åº¦
- **é€šè¨Šæ–¹å¼**: é€éå…±äº«è³‡æ–™åº« (Task è¡¨) é€²è¡Œä»»å‹™å‚³é
- **è³‡æ–™æµ**: OPUI å¯«å…¥ Task â†’ RCS è®€å–ä¸¦åŸ·è¡Œ â†’ æ›´æ–°ä»»å‹™ç‹€æ…‹

### WCS (Warehouse Control System) æ•´åˆ
- **åŠŸèƒ½**: ä»»å‹™å®Œæˆç›£æ§å’Œè»Šè¼›æ´¾é£æ¢ä»¶è©•ä¼°
- **å¿…è¦æ€§**: WCS çµ„ä»¶æ˜¯å¿…éœ€çš„ï¼Œè² è²¬ç›£æ§ä»»å‹™å®Œæˆç‹€æ…‹
- **ç›£æ§é‚è¼¯**: æª¢æ¸¬æ–™æ¶ä½ç½®è®ŠåŒ–ï¼Œåˆ¤æ–·ä»»å‹™æ˜¯å¦å®Œæˆ

### KUKA Fleet Adapter æ•´åˆ
- **è§’è‰²**: å¯¦éš›çš„ AGV è»ŠéšŠæ§åˆ¶ä»‹é¢
- **èª¿åº¦æµç¨‹**: RCS â†’ KUKA Fleet Adapter â†’ KUKA AGV è»ŠéšŠ
- **è³‡æ–™åŒæ­¥**: è»Šè¼›ç‹€æ…‹å’Œä½ç½®è³‡è¨Šå›å‚³è‡³ç³»çµ±

### db_proxy æ•´åˆ
- **ç”¨é€”**: çµ±ä¸€çš„è³‡æ–™åº«é€£ç·šå’Œæ“ä½œç®¡ç†
- **å„ªå‹¢**: é€£ç·šæ± ç®¡ç†ã€äº‹å‹™è™•ç†ã€æ•ˆèƒ½æœ€ä½³åŒ–
- **ä½¿ç”¨æ–¹å¼**: æ‰€æœ‰è³‡æ–™åº«æ“ä½œéƒ½é€é db_proxy é€²è¡Œ

## ğŸ—ï¸ æ¶æ§‹é‡æ§‹ (2024å¹´é‡å¤§æ›´æ–°)

### é‡æ§‹æ¦‚è¿°

ç‚ºäº†æé«˜ç¨‹å¼ç¢¼çš„å¯ç¶­è­·æ€§å’Œæ¨¡çµ„åŒ–ç¨‹åº¦ï¼Œæˆ‘å€‘å°å¾Œç«¯æ¶æ§‹é€²è¡Œäº†é‡å¤§é‡æ§‹ï¼š

**é‡æ§‹å‰**ï¼š
- `server.py` - åŒ…å«æ‰€æœ‰ä¼ºæœå™¨é‚è¼¯
- `socket_handler.py` - åŒ…å«æ‰€æœ‰ Socket.IO äº‹ä»¶è™•ç† (845è¡Œ)

**é‡æ§‹å¾Œ**ï¼š
- `op_ui_server.py` - å°ˆè²¬ FastAPI ä¼ºæœå™¨å’Œè·¯ç”± (ç´„150è¡Œ)
- `op_ui_socket.py` - å°ˆè²¬ Socket.IO äº‹ä»¶è™•ç† (ç´„800è¡Œ)

### é‡æ§‹æˆæœ

#### 1. æ¶æ§‹åˆ†é›¢å„ªåŒ–
- **è·è²¬åˆ†é›¢**: ä¼ºæœå™¨é‚è¼¯èˆ‡ Socket.IO é‚è¼¯å®Œå…¨åˆ†é›¢
- **æ¨¡çµ„åŒ–**: æ¯å€‹æª”æ¡ˆéƒ½æœ‰æ˜ç¢ºçš„å–®ä¸€è·è²¬
- **å¯ç¶­è­·æ€§**: ä¿®æ”¹ API è·¯ç”±ä¸æœƒå½±éŸ¿ Socket.IO åŠŸèƒ½ï¼Œåä¹‹äº¦ç„¶

#### 2. ç¨‹å¼ç¢¼é‡è¤‡æ¸›å°‘
- **çµ±ä¸€é€šçŸ¥æ–¹æ³•**: `_send_client_notifications()`
- **çµ±ä¸€è³‡æ–™æ ¼å¼åŒ–**: `_format_client_data()`
- **çµ±ä¸€æœƒè©±è™•ç†**: `_handle_client_session()`
- **é‡è¤‡é‚è¼¯æ¶ˆé™¤**: `login` å’Œ `restore_client_by_id` å…±ç”¨é‚è¼¯

#### 3. æ´¾è»ŠåŠŸèƒ½ä¿®å¾©
- **å•é¡Œ**: å‰ç«¯åªå‚³é€éƒ¨åˆ†è³‡æ–™ `{ side, rackId }`
- **ä¿®å¾©**: å‚³é€å®Œæ•´è³‡æ–™ `{ side, productName, count, rackId, room }`
- **å‘å¾Œç›¸å®¹**: æ”¯æ´ `productName` (æ–°) å’Œ `name` (èˆŠ) å…©ç¨®åƒæ•¸æ ¼å¼

#### 4. æ¸¬è©¦å®Œæ•´æ€§
- **é‡æ§‹æ¸¬è©¦**: èªæ³•é©—è­‰ã€æ¶æ§‹åˆ†é›¢æ¸¬è©¦
- **åŠŸèƒ½æ¸¬è©¦**: Socket.IO åŠŸèƒ½å®Œæ•´æ€§æ¸¬è©¦
- **ä¿®å¾©æ¸¬è©¦**: æ´¾è»ŠåŠŸèƒ½ä¿®å¾©é©—è­‰
- **æ•´åˆæ¸¬è©¦**: ç³»çµ±æ•´åˆå’Œåˆå§‹åŒ–æ¸¬è©¦

### é‡æ§‹æ¸¬è©¦

```bash
# é‹è¡Œæ‰€æœ‰é‡æ§‹æ¸¬è©¦
cd /app/web_api_ws/src/opui/tests
python run_refactor_tests.py

# é‹è¡Œç‰¹å®šæ¸¬è©¦é¡å‹
python refactor/test_syntax.py           # èªæ³•é©—è­‰
python validation/test_dispatch_fix.py   # æ´¾è»Šä¿®å¾©
python validation/test_final_validation.py # æœ€çµ‚é©—è­‰
```

### å‘å¾Œç›¸å®¹æ€§

- **ROS2 å•Ÿå‹•é»**: å·²æ›´æ–°ç‚º `op_ui_server:main`
- **API ç«¯é»**: å®Œå…¨ç›¸å®¹ï¼Œç„¡éœ€ä¿®æ”¹å‰ç«¯
- **Socket.IO äº‹ä»¶**: å®Œå…¨ç›¸å®¹ï¼Œæ‰€æœ‰äº‹ä»¶åç¨±ä¿æŒä¸è®Š
- **è³‡æ–™æ ¼å¼**: æ”¯æ´æ–°èˆŠå…©ç¨®åƒæ•¸æ ¼å¼

### å°ˆæ¡ˆæ¸…ç† (2024å¹´å®Œæˆ)

- **Legacy æª”æ¡ˆç§»é™¤**: `server_legacy.py` å’Œ `socket_handler_legacy.py` å·²ç§»é™¤
- **æ¸¬è©¦æª”æ¡ˆæ•´ç†**: æ¸¬è©¦æª”æ¡ˆå·²ç§»å‹•åˆ° `tests/` ç›®éŒ„çš„é©ç•¶å­ç›®éŒ„
- **æ¶æ§‹é©—è­‰**: æ–°å¢ `test_current_architecture.py` å¿«é€Ÿé©—è­‰ç•¶å‰æ¶æ§‹
- **æ–‡æª”åŒæ­¥**: æ‰€æœ‰æ–‡æª”å·²æ›´æ–°ä»¥åæ˜ ç•¶å‰å°ˆæ¡ˆç‹€æ…‹

## ğŸ”§ æ•…éšœæ’é™¤

### å¸¸è¦‹å•é¡Œèˆ‡è§£æ±ºæ–¹æ¡ˆ

#### 1. Socket é€£ç·šå•é¡Œ
```bash
# æª¢æŸ¥æœå‹™æ˜¯å¦é‹è¡Œ
ps aux | grep op_ui_server

# æª¢æŸ¥åŸ è™Ÿæ˜¯å¦è¢«ä½”ç”¨
netstat -tulpn | grep 8002

# é‡æ–°å•Ÿå‹•æœå‹™
ros2 run opui op_ui_server
```

#### 2. è³‡æ–™åº«é€£ç·šéŒ¯èª¤
```bash
# æª¢æŸ¥è³‡æ–™åº«æœå‹™ç‹€æ…‹
systemctl status postgresql

# æ¸¬è©¦è³‡æ–™åº«é€£ç·š
psql -h 192.168.100.254 -U agvc -d agvc

# æª¢æŸ¥é€£ç·šæ± ç‹€æ…‹ (æŸ¥çœ‹æ—¥èªŒ)
```

#### 3. ROS2 ç’°å¢ƒå•é¡Œ
```bash
# é‡æ–°å»ºç½®å¥—ä»¶
colcon build --packages-select opui --symlink-install

# ç¢ºä¿ç’°å¢ƒè®Šæ•¸æ­£ç¢ºè¨­å®š
all_source

# æª¢æŸ¥å¥—ä»¶æ˜¯å¦æ­£ç¢ºå®‰è£
ros2 pkg list | grep opui
```

#### 4. å‰ç«¯è¼‰å…¥å•é¡Œ
- æ¸…é™¤ç€è¦½å™¨å¿«å– (Ctrl+F5)
- æª¢æŸ¥é–‹ç™¼è€…å·¥å…·çš„ Console éŒ¯èª¤è¨Šæ¯
- ç¢ºèªéœæ…‹æª”æ¡ˆè·¯å¾‘æ­£ç¢º

## ğŸ“š ç›¸é—œå°ˆæ¡ˆ

| å°ˆæ¡ˆåç¨± | åŠŸèƒ½èªªæ˜ | é—œä¿‚ |
|----------|----------|------|
| **rcs_core** | AGV èª¿åº¦æ ¸å¿ƒç³»çµ± | ä»»å‹™åŸ·è¡Œè€… |
| **db_proxy** | è³‡æ–™åº«ä»£ç†å±¤ | è³‡æ–™å­˜å–å±¤ |
| **wcs_ws** | å€‰å„²æ§åˆ¶ç³»çµ± | ä»»å‹™ç›£æ§çµ„ä»¶ |
| **agvcui** | AGV æ§åˆ¶ä»‹é¢ | è»Šè¼›æ§åˆ¶ |
| **agvui** | AGV ç›£æ§ä»‹é¢ | ç‹€æ…‹ç›£æ§ |

## ğŸ“„ æˆæ¬Š

æœ¬å°ˆæ¡ˆç‚ºå…§éƒ¨é–‹ç™¼ä½¿ç”¨ï¼Œé©ç”¨æ–¼ AGV è‡ªå‹•åŒ–å€‰å„²ç³»çµ±ã€‚

## ğŸ“ ç‰ˆæœ¬æ›´æ–°è¨˜éŒ„

### 2025-09 å·¥ä½œå€é…ç½®åŠŸèƒ½
- âœ… **å·¥ä½œå€èˆ‡åœè»Šæ ¼åˆ†é›¢æ¶æ§‹**: å¯¦ç¾æ–™æ¶å­˜æ”¾å€åŸŸçš„è·è²¬åˆ†é›¢
- âœ… **è‡ªå‹•åˆ†é…é‚è¼¯**: add_rack è‡ªå‹•åˆ†é…åˆ°å¯ç”¨å·¥ä½œå€ä½ç½®
- âœ… **æ»¿è¼‰ä¿è­·æ©Ÿåˆ¶**: å·¥ä½œå€æ»¿æ™‚æä¾›æ˜ç¢ºéŒ¯èª¤æç¤º
- âœ… **è³‡æ–™åº«æ”¯æ´**: PostgreSQL INTEGER[] é™£åˆ—æ”¯æ´å¤šå€‹å·¥ä½œå€ä½ç½®

### 2025-07 æ¶æ§‹é‡æ§‹
- âœ… **å¾Œç«¯æ¶æ§‹åˆ†é›¢**: op_ui_server.py èˆ‡ op_ui_socket.py è·è²¬åˆ†é›¢
- âœ… **ç¨‹å¼ç¢¼é‡è¤‡æ¸›å°‘**: çµ±ä¸€é€šçŸ¥æ–¹æ³•å’Œè³‡æ–™æ ¼å¼åŒ–
- âœ… **æ´¾è»ŠåŠŸèƒ½ä¿®å¾©**: å®Œæ•´å‚³é€è³‡æ–™ä¸¦ä¿æŒå‘å¾Œç›¸å®¹

---

*æœ€å¾Œæ›´æ–°: 2025-09-23*
*ç‰ˆæœ¬: 2025.09 - å·¥ä½œå€é…ç½®åŠŸèƒ½æ›´æ–°*
