<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HMI çµ‚ç«¯ - {{ device_description }}</title>
    <link rel="icon" type="image/png" href="/static/favicon.png">
    <link rel="stylesheet" href="/static/css/bulma_1_0_4.min.css" />
    <link rel="stylesheet" href="/static/css/materialdesignicons.min.css" />
    <link rel="stylesheet" href="/static/css/opui-bulma-extend.css" />
    <link rel="stylesheet" href="/static/css/hmi.css?v=2.1">
    <!-- Socket.IO for real-time connection -->
    <script src="/static/js/lib/socket.io.min.js?v=1.0"></script>
</head>
<body>
    <div class="main-container">
        <!-- å°èˆªæ¬„ -->
        <nav class="navbar is-black" role="navigation">
            <div class="navbar-brand">
                <a class="navbar-item" href="/?deviceId={{ device_id }}">
                    <img src="/static/favicon.png" alt="OPUI" style="width: 24px; height: 24px; margin-right: 8px;">
                </a>
                <div class="navbar-item">
                    <span class="has-text-grey">{{ device_id }}</span>
                </div>
            </div>
            
            <div class="navbar-center">
                <div class="navbar-item">
                    <span class="has-text-white has-text-weight-bold is-size-5">{{ device_description }}</span>
                </div>
            </div>
            
            <div class="navbar-end">
                <div class="navbar-item">
                    <span class="has-text-grey" id="current-time"></span>
                </div>
                <div class="navbar-item">
                    <span class="mdi mdi-wifi is-connected" id="connection-status"></span>
                </div>
            </div>
        </nav>
        
        <!-- å…§å®¹å€åŸŸ -->
        <div class="content-area">
            <div class="locations-grid layout-{{ layout }}">
                {% for location_data in locations %}
                <div class="location-box no-select {% if not location_data.rack %}no-rack{% endif %}">
                    <div class="location-content">
                        <h2 class="location-title has-text-centered">
                            {{ location_data.location.name }}
                        </h2>
                        
                        {% if location_data.rack %}
                        <!-- Info Grid Container - 2x2 ä½ˆå±€ -->
                        <div class="info-rows-container">
                            <!-- å·¦ä¸Š: Rack -->
                            <div class="info-item">
                                <span class="info-label">Rack</span>
                                <span class="info-value value-rack">{{ location_data.rack.name }}</span>
                            </div>
                            
                            <!-- å³ä¸Š: Carrier -->
                            <div class="info-item">
                                <span class="info-label">Carrier</span>
                                <span class="info-value value-carrier">{{ location_data.carrier_count }}</span>
                            </div>
                            
                            {% if location_data.product %}
                            <!-- å·¦ä¸‹: Product -->
                            <div class="info-item">
                                <span class="info-label">Product</span>
                                <span class="info-value value-product">{{ location_data.product.name }}</span>
                            </div>
                            
                            <!-- å³ä¸‹: Size -->
                            <div class="info-item">
                                <span class="info-label">Size</span>
                                <span class="info-value value-size">{{ location_data.product.size }}</span>
                            </div>
                            {% else %}
                            <!-- å¦‚æœæ²’æœ‰ç”¢å“ï¼Œé¡¯ç¤ºç©ºæ¬„ä½ -->
                            <div class="info-item"></div>
                            <div class="info-item"></div>
                            {% endif %}
                        </div>

                        <!-- ã€ä¿®æ”¹ã€‘æ ¹æ“šæ¬Šé™é¡¯ç¤ºæŒ‰éˆ•ï¼Œæ·»åŠ å®¹å™¨å¯¦ç¾ä¸¦æ’ -->
                        <div class="button-group-horizontal">
                            {% if permissions.get('can_edit_rack') %}
                            <button class="button-medium button-edit"
                                    onclick="openEditRackModal({{ location_data.location.id }}, '{{ location_data.location.name }}', {{ location_data.rack.id }}, '{{ location_data.rack.name }}')">
                                <i class="mdi mdi-pencil mdi-36px"></i>
                                <span style="font-size: 1.5rem;">Edit</span>
                            </button>
                            {% endif %}

                            {% if permissions.get('can_remove_rack') %}
                            <button class="button-medium button-remove"
                                    onclick="confirmRemoveRack({{ location_data.location.id }}, '{{ location_data.location.name }}', '{{ location_data.rack.name }}')">
                                <i class="mdi mdi-export mdi-36px"></i>
                                <span style="font-size: 1.5rem;">Remove</span>
                            </button>
                            {% endif %}
                        </div>

                        {% if not permissions.get('can_edit_rack') and not permissions.get('can_remove_rack') %}
                        <button class="button-disabled" disabled>
                            <span style="font-size: 1.5rem;">No Permission</span>
                        </button>
                        {% endif %}
                        {% else %}
                        <div class="empty-location">
                            <p>No Rack</p>
                        </div>

                        <!-- ã€ä¿®æ”¹ã€‘æ ¹æ“šæ¬Šé™é¡¯ç¤ºæŒ‰éˆ• -->
                        {% if permissions.get('can_add_rack') %}
                        <button class="button-large button-add"
                                onclick="openAddRackModal({{ location_data.location.id }}, '{{ location_data.location.name }}')">
                            <i class="mdi mdi-plus-circle mdi-48px"></i>
                            <span style="font-size: 1.8rem;">Add Rack</span>
                        </button>
                        {% else %}
                        <button class="button-disabled" disabled>
                            <span style="font-size: 1.8rem;">Empty</span>
                        </button>
                        {% endif %}
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    
    <!-- Dark Theme Modal ç¢ºèªå°è©±æ¡† -->
    <div id="confirmModal" class="modal">
        <div class="modal-background" onclick="closeModal()"></div>
        <div class="modal-card">
            <div class="dark-modal-content">
                <header class="dark-modal-header">
                    <h2 class="dark-modal-title">ç¢ºèªç§»å‡º Rack</h2>
                    <button class="dark-modal-close" onclick="closeModal()">
                        <i class="mdi mdi-close mdi-24px"></i>
                    </button>
                </header>
                <section class="dark-modal-body">
                    <p class="dark-modal-text">
                        ç¢ºå®šè¦å¾ <span class="highlight-text" id="locationName"></span> ç§»å‡º
                        <span class="highlight-text" id="rackName"></span> å—ï¼Ÿ
                    </p>
                </section>
                <footer class="dark-modal-footer">
                    <button class="modal-button-confirm" onclick="executeRemoveRack()">
                        <i class="mdi mdi-check mdi-24px"></i>
                        <span>ç¢ºèª</span>
                    </button>
                    <button class="modal-button-cancel" onclick="closeModal()">
                        <i class="mdi mdi-close mdi-24px"></i>
                        <span>å–æ¶ˆ</span>
                    </button>
                </footer>
            </div>
        </div>
    </div>

    <!-- Add Rack Modal -->
    <div id="addRackModal" class="modal">
        <div class="modal-background" onclick="closeAddRackModal()"></div>
        <div class="modal-card">
            <div class="dark-modal-content">
                <header class="dark-modal-header">
                    <h2 class="dark-modal-title">åŠ å…¥ Rack</h2>
                    <button class="dark-modal-close" onclick="closeAddRackModal()">
                        <i class="mdi mdi-close mdi-24px"></i>
                    </button>
                </header>
                <section class="dark-modal-body">
                    <p class="dark-modal-text">
                        åŠ å…¥ Rack åˆ° <span class="highlight-text" id="addLocationName"></span>
                    </p>

                    <div class="field" style="margin-top: 20px;">
                        <label class="label has-text-white">é¸æ“‡ Rack</label>
                        <div class="control">
                            <div class="select is-fullwidth is-large">
                                <select id="addRackSelect">
                                    <option value="">-- è¼‰å…¥ä¸­ --</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="field" style="margin-top: 15px;">
                        <label class="label has-text-white">æˆ–è¼¸å…¥ Rack åç¨±</label>
                        <div class="control">
                            <input class="input is-large" type="text" id="addRackManualInput"
                                   placeholder="æ‰‹å‹•è¼¸å…¥ Rack åç¨±">
                        </div>
                    </div>
                </section>
                <footer class="dark-modal-footer">
                    <button class="modal-button-confirm" onclick="executeAddRack()">
                        <i class="mdi mdi-check mdi-24px"></i>
                        <span>ç¢ºèª</span>
                    </button>
                    <button class="modal-button-cancel" onclick="closeAddRackModal()">
                        <i class="mdi mdi-close mdi-24px"></i>
                        <span>å–æ¶ˆ</span>
                    </button>
                </footer>
            </div>
        </div>
    </div>

    <!-- Edit Rack Modal -->
    <div id="editRackModal" class="modal">
        <div class="modal-background" onclick="closeEditRackModal()"></div>
        <div class="modal-card" style="width: 95%; max-width: 1200px;">
            <div class="dark-modal-content">
                <header class="dark-modal-header">
                    <h2 class="dark-modal-title">ç·¨è¼¯ Rack - <span id="editRackTitle"></span></h2>
                    <button class="dark-modal-close" onclick="closeEditRackModal()">
                        <i class="mdi mdi-close mdi-24px"></i>
                    </button>
                </header>
                <section class="dark-modal-body">
                    <!-- Tab Navigation -->
                    <div class="tabs is-boxed is-large">
                        <ul>
                            <li class="is-active" id="tab-basic">
                                <a onclick="switchEditTab('basic')">
                                    <span class="icon"><i class="mdi mdi-information"></i></span>
                                    <span>åŸºæœ¬è³‡æ–™</span>
                                </a>
                            </li>
                            <li id="tab-bitmap">
                                <a onclick="switchEditTab('bitmap')">
                                    <span class="icon"><i class="mdi mdi-grid"></i></span>
                                    <span>æ ¼ä½ç®¡ç†</span>
                                </a>
                            </li>
                        </ul>
                    </div>

                    <!-- Tab Content: Basic Info -->
                    <div id="edit-content-basic" class="tab-content">
                        <div class="columns">
                            <div class="column">
                                <div class="field">
                                    <label class="label has-text-white">ç”¢å“</label>
                                    <div class="control">
                                        <div class="select is-fullwidth is-large">
                                            <select id="editProductSelect">
                                                <option value="">-- è¼‰å…¥ä¸­ --</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="column">
                                <div class="field">
                                    <label class="label has-text-white">æ–¹å‘</label>
                                    <div class="control">
                                        <div class="select is-fullwidth is-large">
                                            <select id="editDirectionSelect">
                                                <option value="0">0 - 0Â°</option>
                                                <option value="1">1 - 90Â°</option>
                                                <option value="2">2 - 180Â°</option>
                                                <option value="3">3 - 270Â°</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="column">
                                <div class="field">
                                    <label class="label has-text-white">ç‹€æ…‹</label>
                                    <div class="control">
                                        <div class="select is-fullwidth is-large">
                                            <select id="editStatusSelect">
                                                <option value="1">å¯ç”¨</option>
                                                <option value="2">ç¶­ä¿®ä¸­</option>
                                                <option value="3">å ±å»¢</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tab Content: Bitmap -->
                    <div id="edit-content-bitmap" class="tab-content" style="display: none;">
                        <!-- Statistics -->
                        <div class="box has-background-dark has-text-white" style="margin-bottom: 20px;">
                            <div class="columns has-text-centered">
                                <div class="column">
                                    <p class="heading has-text-grey-light">æœ‰è²¨</p>
                                    <p class="title has-text-success" id="bitmapOccupiedCount">0</p>
                                </div>
                                <div class="column">
                                    <p class="heading has-text-grey-light">å¯ç”¨</p>
                                    <p class="title has-text-info" id="bitmapEnabledCount">0</p>
                                </div>
                                <div class="column">
                                    <p class="heading has-text-grey-light">ç©ºä½</p>
                                    <p class="title has-text-light" id="bitmapEmptyCount">0</p>
                                </div>
                                <div class="column">
                                    <p class="heading has-text-grey-light">ç¸½æ•¸</p>
                                    <p class="title has-text-white" id="bitmapTotalSlots">32</p>
                                </div>
                            </div>
                        </div>

                        <!-- Batch Operations -->
                        <div class="buttons are-large" style="margin-bottom: 20px;">
                            <button class="button is-danger" onclick="bitmapClearAll()">
                                <i class="mdi mdi-delete-sweep"></i>
                                <span>å…¨éƒ¨æ¸…ç©º</span>
                            </button>
                            <button class="button is-success" onclick="bitmapEnableAll()">
                                <i class="mdi mdi-check-all"></i>
                                <span>å…¨éƒ¨å•Ÿç”¨</span>
                            </button>
                            <button class="button is-warning" onclick="bitmapDisableAll()">
                                <i class="mdi mdi-close-circle"></i>
                                <span>å…¨éƒ¨ç¦ç”¨</span>
                            </button>
                        </div>

                        <!-- Bitmap Grids -->
                        <div class="columns">
                            <div class="column">
                                <h3 class="title is-4 has-text-white has-text-centered">A é¢ (1-16)</h3>
                                <div id="bitmapGridA" class="bitmap-grid"></div>
                            </div>
                            <div class="column">
                                <h3 class="title is-4 has-text-white has-text-centered">B é¢ (17-32)</h3>
                                <div id="bitmapGridB" class="bitmap-grid"></div>
                            </div>
                        </div>

                        <p class="help has-text-grey-light" style="margin-top: 15px;">
                            <i class="mdi mdi-information"></i>
                            é»æ“Šæ ¼ä½åˆ‡æ›æœ‰è²¨/ç©ºï¼Œé•·æŒ‰åˆ‡æ›å•Ÿç”¨/ç¦ç”¨
                        </p>
                    </div>
                </section>
                <footer class="dark-modal-footer">
                    <button class="modal-button-confirm" onclick="executeSaveRack()">
                        <i class="mdi mdi-content-save mdi-24px"></i>
                        <span>å„²å­˜</span>
                    </button>
                    <button class="modal-button-cancel" onclick="closeEditRackModal()">
                        <i class="mdi mdi-close mdi-24px"></i>
                        <span>å–æ¶ˆ</span>
                    </button>
                </footer>
            </div>
        </div>
    </div>

    <script>
        // å…¨åŸŸè®Šæ•¸
        let currentLocationId = null;
        let currentLocationName = '';
        let currentRackName = '';
        let socket = null;
        let isConnected = false;

        // Add Rackç›¸é—œè®Šæ•¸
        let addRackLocationId = null;
        let addRackLocationName = '';

        // Edit Rackç›¸é—œè®Šæ•¸
        let editRackId = null;
        let editRackLocationId = null;
        let editRackName = '';
        let editRackData = null;
        let pressTimer = null; // é•·æŒ‰è¨ˆæ™‚å™¨

        // æ¬Šé™ç‹€æ…‹
        let hmiPermissions = {
            can_add_rack: false,
            can_edit_rack: false,
            can_remove_rack: false
        };
        
        // ç²å–æ­£ç¢ºçš„ Socket.IO é€£ç·š URL
        function getSocketUrl() {
            const hostname = window.location.hostname;
            const protocol = window.location.protocol === 'https:' ? 'https' : 'http';
            const currentPort = window.location.port;
            
            console.log(`ğŸ” ç•¶å‰ä½ç½®: ${protocol}://${hostname}:${currentPort}`);
            
            // å¦‚æœç•¶å‰é é¢çš„ hostname æ˜¯ op.uiï¼Œå‰‡é€£æ¥åˆ°å°æ‡‰çš„å¾Œç«¯
            if (hostname === 'op.ui') {
                const socketUrl = `${protocol}://op.ui:8002`;
                console.log(`ğŸ¯ op.ui ç’°å¢ƒï¼ŒSocket URL: ${socketUrl}`);
                return socketUrl;
            }
            
            // å¦‚æœæ˜¯ localhost æˆ–å…¶ä»–æƒ…æ³ï¼Œä½¿ç”¨ç•¶å‰åŸŸå
            if (hostname === 'localhost' || hostname === '127.0.0.1') {
                const socketUrl = `${protocol}://${hostname}:8002`;
                console.log(`ğŸ  æœ¬åœ°ç’°å¢ƒï¼ŒSocket URL: ${socketUrl}`);
                return socketUrl;
            }
            
            // å¦‚æœç•¶å‰é é¢å·²ç¶“åœ¨ 8002 åŸ ï¼Œä½¿ç”¨ç›¸åŒçš„ host å’Œ port
            if (currentPort === '8002') {
                const socketUrl = `${protocol}://${hostname}:8002`;
                console.log(`âœ… å·²åœ¨ 8002 åŸ ï¼ŒSocket URL: ${socketUrl}`);
                return socketUrl;
            }
            
            // é è¨­æƒ…æ³ï¼šå˜—è©¦é€£æ¥åˆ° 8002 åŸ 
            const defaultUrl = `${protocol}://${hostname}:8002`;
            console.log(`ğŸ”§ é è¨­æƒ…æ³ï¼ŒSocket URL: ${defaultUrl}`);
            return defaultUrl;
        }
        
        // åˆå§‹åŒ– Socket.IO é€£ç·š
        function initSocketConnection() {
            const socketUrl = getSocketUrl();
            console.log('Connecting to Socket.IO at:', socketUrl);
            
            socket = io(socketUrl, {
                transports: ['websocket', 'polling'],  // å„ªå…ˆä½¿ç”¨ websocket
                upgrade: true,
                rememberUpgrade: true,
                timeout: 10000,
                forceNew: false,
                autoConnect: true,
                reconnection: true,
                reconnectionAttempts: 5,
                reconnectionDelay: 1000,
                reconnectionDelayMax: 5000
            });
            
            // é€£ç·šäº‹ä»¶
            socket.on('connect', function() {
                console.log('Socket.IO connected');
                isConnected = true;
                updateConnectionStatus(true);
                // è«‹æ±‚æœ€æ–°è³‡æ–™
                requestLatestData();
            });
            
            socket.on('disconnect', function() {
                console.log('Socket.IO disconnected');
                isConnected = false;
                updateConnectionStatus(false);
            });
            
            socket.on('error', function(error) {
                console.error('Socket.IO error:', error);
                isConnected = false;
                updateConnectionStatus(false);
            });
            
            // æ¥æ”¶è³‡æ–™æ›´æ–°
            socket.on('hmi_data_update', function(data) {
                const timestamp = new Date().toISOString();
                console.log('[HMI_DATA_UPDATE]', 'Socket.IO æ”¶åˆ°è³‡æ–™æ›´æ–°', {
                    timestamp: timestamp,
                    success: data.success,
                    device_id: data.device_id,
                    locations_count: data.locations ? data.locations.length : 0,
                    racks: data.locations ? data.locations.map(loc => ({
                        location_name: loc.location.name,
                        rack_name: loc.rack ? loc.rack.name : null
                    })) : [],
                    data: data
                });
                updateHMIDisplay(data);
            });
            
            // æ¥æ”¶ä½ç½®ç‹€æ…‹æ›´æ–°
            socket.on('location_update', function(data) {
                console.log('Received location update:', data);
                updateLocationDisplay(data);
            });

            // æ¥æ”¶ HMI ä½ç½®è®Šæ›´äº‹ä»¶ï¼ˆæ–°å¢ï¼šå¤šçµ‚ç«¯å¯¦æ™‚åŒæ­¥ï¼‰
            socket.on('hmi_location_changed', function(data) {
                const timestamp = new Date().toISOString();
                console.log('[HMI_LOCATION_CHANGED]', 'Rack ä½ç½®è®Šæ›´é€šçŸ¥', {
                    timestamp: timestamp,
                    event_type: data.type,
                    rack_id: data.rack_id,
                    rack_name: data.rack_name,
                    location_id: data.location_id,
                    data: data
                });

                // ç«‹å³è«‹æ±‚æœ€æ–°è³‡æ–™ä»¥æ›´æ–°é¡¯ç¤º
                requestLatestData();

                // å¯é¸ï¼šé¡¯ç¤ºé€šçŸ¥è¨Šæ¯çµ¦ç”¨æˆ¶
                const eventMessages = {
                    'rack_added': `æ–™æ¶ ${data.rack_name || data.rack_id} å·²åŠ å…¥å·¥ä½œå€`,
                    'rack_dispatched': `æ–™æ¶ ${data.rack_name || data.rack_id} å·²æ´¾é€åˆ°åœè»Šæ ¼`,
                    'rack_removed': `æ–™æ¶ ${data.rack_name || data.rack_id} å·²ç§»é™¤`,
                    'location_changed': `ä½ç½®å·²æ›´æ–°`
                };
                const message = eventMessages[data.type] || 'ä½ç½®å·²æ›´æ–°';
                console.log('[HMI_LOCATION_CHANGED]', message);
            });
        }
        
        // è«‹æ±‚æœ€æ–°è³‡æ–™
        function requestLatestData() {
            if (socket && isConnected) {
                const timestamp = new Date().toISOString();
                const urlParams = new URLSearchParams(window.location.search);
                const deviceId = urlParams.get('deviceId');
                console.log('[HMI_REQUEST_DATA]', 'è«‹æ±‚æœ€æ–°è³‡æ–™', { timestamp: timestamp, device_id: deviceId });
                socket.emit('request_hmi_data', { device_id: deviceId });
            }
        }
        
        // æ›´æ–° HMI é¡¯ç¤ºï¼ˆå±€éƒ¨æ›´æ–°ï¼Œä¸é‡è¼‰é é¢ï¼‰
        function updateHMIDisplay(data) {
            if (!data || !data.locations) return;

            // ã€æ–°å¢ã€‘ä¿å­˜æ¬Šé™è³‡è¨Š
            if (data.permissions) {
                hmiPermissions = data.permissions;
                console.log('Permissions updated:', hmiPermissions);
            }

            // æ›´æ–°æ¯å€‹ä½ç½®çš„é¡¯ç¤º
            data.locations.forEach(function(locationData, index) {
                updateSingleLocation(index, locationData);
            });
        }
        
        // æ›´æ–°å–®å€‹ä½ç½®é¡¯ç¤º - åªæ›´æ–°å€¼ï¼Œä¸é‡å»ºæ•´å€‹çµæ§‹
        function updateSingleLocation(index, locationData) {
            const locationBoxes = document.querySelectorAll('.location-box');
            if (index >= locationBoxes.length) return;
            
            const box = locationBoxes[index];
            
            // æ›´æ–°ä½ç½®æ¨™é¡Œ
            const locationTitle = box.querySelector('.location-title');
            if (locationTitle) {
                locationTitle.textContent = locationData.location.name;
            }
            
            // æª¢æŸ¥æ˜¯å¦éœ€è¦é‡å»ºçµæ§‹ï¼ˆæœ‰ç„¡ Rack ç‹€æ…‹æ”¹è®Šï¼‰
            const hasRackNow = !!locationData.rack;
            const hadRackBefore = !!box.querySelector('.info-rows-container');
            
            if (hasRackNow !== hadRackBefore) {
                // ç‹€æ…‹æ”¹è®Šï¼Œéœ€è¦é‡å»ºçµæ§‹
                const content = box.querySelector('.location-content');
                if (!content) return;
                
                // Update box class based on rack status
                if (hasRackNow) {
                    box.classList.remove('no-rack');
                } else {
                    box.classList.add('no-rack');
                }
                
                let newHTML = `<h2 class="location-title has-text-centered">${locationData.location.name}</h2>`;
                
                if (locationData.rack) {
                    newHTML += `<div class="info-rows-container">
                        <div class="info-item">
                            <span class="info-label">Rack</span>
                            <span class="info-value value-rack">${locationData.rack.name}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Carrier</span>
                            <span class="info-value value-carrier">${locationData.carrier_count}</span>
                        </div>`;
                    
                    if (locationData.product) {
                        newHTML += `
                            <div class="info-item">
                                <span class="info-label">Product</span>
                                <span class="info-value value-product">${locationData.product.name}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Size</span>
                                <span class="info-value value-size">${locationData.product.size}</span>
                            </div>`;
                    } else {
                        newHTML += `
                            <div class="info-item"></div>
                            <div class="info-item"></div>`;
                    }
                    
                    newHTML += `</div>`;

                    // ã€ä¿®æ”¹ã€‘ä½¿ç”¨ generateLocationButtons ç”Ÿæˆæ¬Šé™æ§åˆ¶çš„æŒ‰éˆ•
                    newHTML += generateLocationButtons(locationData);
                } else {
                    // ç„¡ Rack
                    newHTML += `
                        <div class="empty-location">
                            <p>No Rack</p>
                        </div>`;

                    // ã€ä¿®æ”¹ã€‘ä½¿ç”¨ generateLocationButtons ç”Ÿæˆæ¬Šé™æ§åˆ¶çš„æŒ‰éˆ•
                    newHTML += generateLocationButtons(locationData);
                }
                
                content.innerHTML = newHTML;
            } else if (hasRackNow) {
                // åªæ›´æ–°å€¼ï¼Œä¸é‡å»ºçµæ§‹
                const rackValue = box.querySelector('.value-rack');
                if (rackValue && locationData.rack) {
                    rackValue.textContent = locationData.rack.name;
                }
                
                const carrierValue = box.querySelector('.value-carrier');
                if (carrierValue) {
                    carrierValue.textContent = locationData.carrier_count;
                }
                
                if (locationData.product) {
                    const productValue = box.querySelector('.value-product');
                    if (productValue) {
                        productValue.textContent = locationData.product.name;
                    }
                    
                    const sizeValue = box.querySelector('.value-size');
                    if (sizeValue) {
                        sizeValue.textContent = locationData.product.size;
                    }
                }
                
                // æ›´æ–°æŒ‰éˆ•çš„ onclick äº‹ä»¶ï¼ˆå¦‚æœ rack åç¨±æ”¹è®Šï¼‰
                const button = box.querySelector('.button-large');
                if (button && locationData.rack) {
                    button.setAttribute('onclick', 
                        `confirmRemoveRack(${locationData.location.id}, '${locationData.location.name}', '${locationData.rack.name}')`);
                }
            }
        }
        
        // æ›´æ–°å–®å€‹ä½ç½®ç‹€æ…‹
        function updateLocationDisplay(data) {
            if (!data || !data.location_id) return;
            
            // æ‰¾åˆ°å°æ‡‰çš„ä½ç½®ä¸¦æ›´æ–°
            requestLatestData(); // ç°¡å–®èµ·è¦‹ï¼Œè«‹æ±‚å…¨éƒ¨è³‡æ–™æ›´æ–°
        }
        
        // è™•ç† location-box é»æ“Šå‹•ç•«
        document.addEventListener('DOMContentLoaded', function() {
            // åˆå§‹åŒ– Socket.IO é€£ç·š
            initSocketConnection();
            const locationBoxes = document.querySelectorAll('.location-box');
            
            locationBoxes.forEach(box => {
                // è§¸æ§æˆ–é»æ“Šé–‹å§‹
                box.addEventListener('touchstart', handleTouch);
                box.addEventListener('mousedown', handleTouch);
                
                function handleTouch(e) {
                    // é˜²æ­¢é‡è¤‡è§¸ç™¼
                    if (box.classList.contains('touched')) return;
                    
                    // æ·»åŠ å‹•ç•« class
                    box.classList.add('touched');
                    
                    // å‹•ç•«æ’­æ”¾å®Œå¾Œç§»é™¤ class
                    setTimeout(() => {
                        box.classList.remove('touched');
                    }, 600); // èˆ‡å‹•ç•«æ™‚é–“ä¸€è‡´
                }
            });
        });
        
        // æ›´æ–°æ™‚é–“é¡¯ç¤º
        function updateTime() {
            const now = new Date();
            const timeString = now.toLocaleString('zh-TW');
            document.getElementById('current-time').textContent = timeString;
        }
        
        // æ›´æ–°é€£ç·šç‹€æ…‹é¡¯ç¤º
        function updateConnectionStatus(isConnected) {
            const statusIcon = document.getElementById('connection-status');
            if (statusIcon) {
                if (isConnected) {
                    statusIcon.classList.remove('is-disconnected');
                    statusIcon.classList.add('is-connected');
                } else {
                    statusIcon.classList.remove('is-connected');
                    statusIcon.classList.add('is-disconnected');
                }
            }
        }
        
        // æª¢æŸ¥ Socket.IO é€£ç·šç‹€æ…‹
        function checkConnection() {
            updateConnectionStatus(isConnected);
        }
        
        // åˆå§‹åŒ–æ™‚é–“é¡¯ç¤º
        updateTime();
        setInterval(updateTime, 1000);
        
        // åˆå§‹åŒ–é€£ç·šç‹€æ…‹
        checkConnection();
        
        // å®šæœŸæª¢æŸ¥é€£ç·šç‹€æ…‹ï¼ˆæ¯5ç§’ï¼‰
        setInterval(function() {
            checkConnection();
            // å¦‚æœå·²é€£ç·šï¼Œè«‹æ±‚æœ€æ–°è³‡æ–™
            if (isConnected) {
                const timestamp = new Date().toISOString();
                console.log('[HMI_AUTO_REFRESH]', 'è‡ªå‹•åˆ·æ–°è§¸ç™¼', { timestamp: timestamp, interval: '5ç§’' });
                requestLatestData();
            }
        }, 5000);
        
        // é¡¯ç¤ºç¢ºèªå°è©±æ¡†
        function confirmRemoveRack(locationId, locationName, rackName) {
            currentLocationId = locationId;
            currentLocationName = locationName;
            currentRackName = rackName;
            
            document.getElementById('locationName').textContent = locationName;
            document.getElementById('rackName').textContent = rackName;
            document.getElementById('confirmModal').classList.add('is-active');
        }
        
        // é—œé–‰å°è©±æ¡†
        function closeModal() {
            document.getElementById('confirmModal').classList.remove('is-active');
            currentLocationId = null;
            currentLocationName = '';
            currentRackName = '';
        }
        
        // åŸ·è¡Œç§»å‡º Rack
        async function executeRemoveRack() {
            if (!currentLocationId) return;
            
            // å–å¾— deviceId
            const urlParams = new URLSearchParams(window.location.search);
            const deviceId = urlParams.get('deviceId');
            
            try {
                const response = await fetch('/api/hmi/remove_rack', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        location_id: currentLocationId,
                        device_id: deviceId,
                        operator_note: `ç”± HMI çµ‚ç«¯ ${deviceId} æ“ä½œ`
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // ä¸è¦é‡æ–°è¼‰å…¥é é¢ï¼Œæ”¹ç”¨ Socket.IO è«‹æ±‚æ›´æ–°è³‡æ–™
                    console.log('Rack removed successfully, requesting data update via Socket.IO');
                    
                    // ç«‹å³æ›´æ–°è©²ä½ç½®çš„é¡¯ç¤ºç‚ºç„¡ Rack ç‹€æ…‹
                    updateLocationToEmpty(currentLocationId, currentLocationName);
                    
                    // é€é Socket.IO è«‹æ±‚æœ€æ–°è³‡æ–™
                    if (socket && isConnected) {
                        socket.emit('request_hmi_data', { device_id: deviceId });
                    }
                } else {
                    // åªåœ¨å¤±æ•—æ™‚é¡¯ç¤ºæç¤º
                    alert(`æ“ä½œå¤±æ•—ï¼š${result.message}`);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('æ“ä½œå¤±æ•—ï¼šç¶²è·¯éŒ¯èª¤');
            } finally {
                closeModal();
            }
        }
        
        // ç«‹å³æ›´æ–°ä½ç½®ç‚ºç©ºç‹€æ…‹ï¼ˆä¸ç­‰å¾… Socket.IOï¼‰
        function updateLocationToEmpty(locationId, locationName) {
            const locationBoxes = document.querySelectorAll('.location-box');
            
            // æ‰¾åˆ°å°æ‡‰çš„ location box
            for (let box of locationBoxes) {
                const button = box.querySelector('.button-large');
                if (button && button.getAttribute('onclick').includes(`${locationId}`)) {
                    // Add no-rack class to the box
                    box.classList.add('no-rack');
                    
                    const content = box.querySelector('.location-content');
                    if (content) {
                        // ä¿ç•™æ¨™é¡Œ
                        const title = content.querySelector('.location-title');
                        const titleText = title ? title.textContent : locationName;
                        
                        // é‡å»ºç‚ºç„¡ Rack ç‹€æ…‹
                        content.innerHTML = `
                            <h2 class="location-title has-text-centered">${titleText}</h2>
                            <div class="empty-location">
                                <p>No Rack</p>
                            </div>
                            <button class="button-disabled" disabled>
                                <span style="font-size: 1.8rem;">Empty</span>
                            </button>`;
                    }
                    break;
                }
            }
        }
        
        // é»æ“Š modal å¤–éƒ¨é—œé–‰
        window.onclick = function(event) {
            const modal = document.getElementById('confirmModal');
            if (event.target == modal) {
                closeModal();
            }
        }

        // ===========================================================================
        // Permission Control & Button Generation
        // ===========================================================================

        function generateLocationButtons(locationData) {
            let buttonsHTML = '';

            if (locationData.rack) {
                // æœ‰ Rackï¼šé¡¯ç¤º Edit å’Œ Remove æŒ‰éˆ•
                const hasEditPerm = hmiPermissions.can_edit_rack;
                const hasRemovePerm = hmiPermissions.can_remove_rack;

                if (hasEditPerm || hasRemovePerm) {
                    // ã€ä¿®æ”¹ã€‘æ·»åŠ å®¹å™¨åŒ…è£¹æŒ‰éˆ•å¯¦ç¾æ°´å¹³æ’åˆ—
                    buttonsHTML += '<div class="button-group-horizontal">';

                    if (hasEditPerm) {
                        buttonsHTML += `
                            <button class="button-medium button-edit"
                                    onclick="openEditRackModal(${locationData.location.id}, '${locationData.location.name}', ${locationData.rack.id}, '${locationData.rack.name}')">
                                <i class="mdi mdi-pencil mdi-36px"></i>
                                <span style="font-size: 1.5rem;">Edit</span>
                            </button>`;
                    }

                    if (hasRemovePerm) {
                        buttonsHTML += `
                            <button class="button-medium button-remove"
                                    onclick="confirmRemoveRack(${locationData.location.id}, '${locationData.location.name}', '${locationData.rack.name}')">
                                <i class="mdi mdi-export mdi-36px"></i>
                                <span style="font-size: 1.5rem;">Remove</span>
                            </button>`;
                    }

                    buttonsHTML += '</div>';
                } else {
                    // ç„¡ä»»ä½•æ¬Šé™ï¼Œé¡¯ç¤ºè³‡è¨ŠæŒ‰éˆ•
                    buttonsHTML += `
                        <button class="button-disabled" disabled>
                            <span style="font-size: 1.5rem;">No Permission</span>
                        </button>`;
                }
            } else {
                // ç„¡ Rackï¼šæ ¹æ“š can_add_rack é¡¯ç¤ºæŒ‰éˆ•
                if (hmiPermissions.can_add_rack) {
                    buttonsHTML += `
                        <button class="button-large button-add"
                                onclick="openAddRackModal(${locationData.location.id}, '${locationData.location.name}')">
                            <i class="mdi mdi-plus-circle mdi-48px"></i>
                            <span style="font-size: 1.8rem;">Add Rack</span>
                        </button>`;
                } else {
                    buttonsHTML += `
                        <button class="button-disabled" disabled>
                            <span style="font-size: 1.8rem;">Empty</span>
                        </button>`;
                }
            }

            return buttonsHTML;
        }

        // ===========================================================================
        // Add Rack Modal Functions
        // ===========================================================================

        async function openAddRackModal(locationId, locationName) {
            addRackLocationId = locationId;
            addRackLocationName = locationName;

            document.getElementById('addLocationName').textContent = locationName;
            document.getElementById('addRackManualInput').value = '';

            // è¼‰å…¥å¯ç”¨çš„ rack åˆ—è¡¨
            await loadAvailableRacks();

            document.getElementById('addRackModal').classList.add('is-active');
        }

        function closeAddRackModal() {
            document.getElementById('addRackModal').classList.remove('is-active');
            addRackLocationId = null;
            addRackLocationName = '';
        }

        async function loadAvailableRacks() {
            const select = document.getElementById('addRackSelect');
            const urlParams = new URLSearchParams(window.location.search);
            const deviceId = urlParams.get('deviceId');

            try {
                const response = await fetch(`/api/hmi/available_racks?device_id=${deviceId}`);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();

                if (result.success && Array.isArray(result.racks)) {
                    if (result.racks.length === 0) {
                        select.innerHTML = '<option value="">-- ç„¡å¯ç”¨ Rack --</option>';
                        return;
                    }

                    select.innerHTML = '<option value="">-- é¸æ“‡ Rack --</option>';
                    result.racks.forEach(rack => {
                        if (!rack.name) return;
                        const option = document.createElement('option');
                        option.value = rack.name;
                        option.textContent = `${rack.name} (${rack.product_name || 'ç„¡ç”¢å“'})`;
                        select.appendChild(option);
                    });
                } else {
                    console.error('API éŸ¿æ‡‰æ ¼å¼éŒ¯èª¤:', result);
                    select.innerHTML = '<option value="">è¼‰å…¥å¤±æ•—ï¼šæ ¼å¼éŒ¯èª¤</option>';
                }
            } catch (error) {
                console.error('åŠ è¼‰ Rack åˆ—è¡¨å¤±æ•—:', error);
                select.innerHTML = `<option value="">è¼‰å…¥å¤±æ•—ï¼š${error.message}</option>`;
            }
        }

        async function executeAddRack() {
            if (!addRackLocationId) return;

            const selectValue = document.getElementById('addRackSelect').value;
            const manualInput = document.getElementById('addRackManualInput').value.trim();

            const rackName = manualInput || selectValue;

            if (!rackName) {
                alert('è«‹é¸æ“‡æˆ–è¼¸å…¥ Rack åç¨±');
                return;
            }

            const urlParams = new URLSearchParams(window.location.search);
            const deviceId = urlParams.get('deviceId');

            const timestamp = new Date().toISOString();
            console.log('[HMI_ADD_RACK]', 'API è«‹æ±‚é–‹å§‹', {
                timestamp: timestamp,
                location_id: addRackLocationId,
                rack_name: rackName,
                device_id: deviceId
            });

            try {
                const response = await fetch('/api/hmi/add_rack', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        location_id: addRackLocationId,
                        rack_name: rackName,
                        device_id: deviceId
                    })
                });

                const result = await response.json();
                const responseTime = new Date().toISOString();

                console.log('[HMI_ADD_RACK]', 'API å›æ‡‰', {
                    timestamp: responseTime,
                    success: result.success,
                    message: result.message,
                    rack_id: result.rack_id,
                    rack_name: result.rack_name,
                    location_name: result.location_name,
                    full_response: result
                });

                if (result.success) {
                    console.log('[HMI_ADD_RACK]', 'æˆåŠŸï¼Œè«‹æ±‚è³‡æ–™æ›´æ–°', { timestamp: new Date().toISOString() });
                    if (socket && isConnected) {
                        socket.emit('request_hmi_data', { device_id: deviceId });
                    }
                } else {
                    console.error('[HMI_ADD_RACK]', 'å¤±æ•—', { message: result.message });
                    alert(`æ“ä½œå¤±æ•—ï¼š${result.message || 'æœªçŸ¥éŒ¯èª¤'}`);
                }
            } catch (error) {
                console.error('[HMI_ADD_RACK]', 'ç¶²è·¯éŒ¯èª¤', { error: error });
                alert('æ“ä½œå¤±æ•—ï¼šç¶²è·¯éŒ¯èª¤');
            } finally {
                closeAddRackModal();
            }
        }

        // ===========================================================================
        // Edit Rack Modal Functions
        // ===========================================================================

        async function openEditRackModal(locationId, locationName, rackId, rackName) {
            editRackId = rackId;
            editRackLocationId = locationId;
            editRackName = rackName;

            document.getElementById('editRackTitle').textContent = rackName;

            // åˆ‡æ›åˆ°åŸºæœ¬è³‡æ–™é ç±¤
            switchEditTab('basic');

            // è¼‰å…¥ç”¢å“åˆ—è¡¨ã€ç‹€æ…‹åˆ—è¡¨å’Œ Rack è³‡æ–™
            await Promise.all([
                loadProducts(),
                loadRackStatuses(),
                loadRackData(rackId)
            ]);

            document.getElementById('editRackModal').classList.add('is-active');
        }

        function closeEditRackModal() {
            document.getElementById('editRackModal').classList.remove('is-active');
            editRackId = null;
            editRackLocationId = null;
            editRackName = '';
            editRackData = null;
        }

        function switchEditTab(tab) {
            // åˆ‡æ›é ç±¤æ¨£å¼
            document.getElementById('tab-basic').classList.toggle('is-active', tab === 'basic');
            document.getElementById('tab-bitmap').classList.toggle('is-active', tab === 'bitmap');

            // åˆ‡æ›å…§å®¹é¡¯ç¤º
            document.getElementById('edit-content-basic').style.display = tab === 'basic' ? 'block' : 'none';
            document.getElementById('edit-content-bitmap').style.display = tab === 'bitmap' ? 'block' : 'none';

            // å¦‚æœåˆ‡æ›åˆ° bitmap é ç±¤ï¼Œè¼‰å…¥ bitmap è³‡æ–™
            if (tab === 'bitmap' && editRackId) {
                loadBitmapData(editRackId);
            }
        }

        async function loadProducts() {
            const select = document.getElementById('editProductSelect');
            const urlParams = new URLSearchParams(window.location.search);
            const deviceId = urlParams.get('deviceId');

            try {
                const response = await fetch(`/api/hmi/products?device_id=${deviceId}`);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();

                if (result.success && Array.isArray(result.products)) {
                    if (result.products.length === 0) {
                        select.innerHTML = '<option value="">-- ç„¡ç”¢å“ --</option>';
                        return;
                    }

                    select.innerHTML = '<option value="">-- é¸æ“‡ç”¢å“ --</option>';
                    result.products.forEach(product => {
                        const option = document.createElement('option');
                        option.value = product.id;
                        option.textContent = `${product.name} (${product.size || 'N/A'})`;
                        select.appendChild(option);
                    });
                } else {
                    console.error('API éŸ¿æ‡‰æ ¼å¼éŒ¯èª¤:', result);
                    select.innerHTML = '<option value="">è¼‰å…¥å¤±æ•—ï¼šæ ¼å¼éŒ¯èª¤</option>';
                }
            } catch (error) {
                console.error('åŠ è¼‰ç”¢å“åˆ—è¡¨å¤±æ•—:', error);
                select.innerHTML = `<option value="">è¼‰å…¥å¤±æ•—ï¼š${error.message}</option>`;
            }
        }

        async function loadRackStatuses() {
            const select = document.getElementById('editStatusSelect');
            const urlParams = new URLSearchParams(window.location.search);
            const deviceId = urlParams.get('deviceId');

            try {
                const response = await fetch(`/api/hmi/rack_statuses?device_id=${deviceId}`);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();

                if (result.success && Array.isArray(result.statuses)) {
                    if (result.statuses.length === 0) {
                        select.innerHTML = '<option value="">-- ç„¡ç‹€æ…‹ --</option>';
                        return;
                    }

                    select.innerHTML = '<option value="">-- é¸æ“‡ç‹€æ…‹ --</option>';
                    result.statuses.forEach(status => {
                        const option = document.createElement('option');
                        option.value = status.id;
                        option.textContent = `${status.name} (${status.description})`;
                        select.appendChild(option);
                    });
                } else {
                    console.error('API éŸ¿æ‡‰æ ¼å¼éŒ¯èª¤:', result);
                    select.innerHTML = '<option value="">è¼‰å…¥å¤±æ•—ï¼šæ ¼å¼éŒ¯èª¤</option>';
                }
            } catch (error) {
                console.error('åŠ è¼‰ç‹€æ…‹åˆ—è¡¨å¤±æ•—:', error);
                select.innerHTML = `<option value="">è¼‰å…¥å¤±æ•—ï¼š${error.message}</option>`;
            }
        }

        async function loadRackData(rackId) {
            const urlParams = new URLSearchParams(window.location.search);
            const deviceId = urlParams.get('deviceId');

            try {
                const response = await fetch(`/api/hmi/racks/${rackId}/bitmap-status?device_id=${deviceId}`);
                const result = await response.json();

                if (result.success && result.data) {
                    editRackData = result.data;

                    // è¨­å®šåŸºæœ¬è³‡æ–™çš„ç•¶å‰å€¼
                    if (result.data.product_id) {
                        document.getElementById('editProductSelect').value = result.data.product_id;
                    }
                    // direction å’Œ status éœ€è¦å¾å…¶ä»–åœ°æ–¹ç²å–æˆ–é è¨­
                } else {
                    alert('è¼‰å…¥ Rack è³‡æ–™å¤±æ•—');
                }
            } catch (error) {
                console.error('Failed to load rack data:', error);
                alert('è¼‰å…¥ Rack è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤');
            }
        }

        async function executeSaveRack() {
            if (!editRackId || !editRackLocationId) return;

            const urlParams = new URLSearchParams(window.location.search);
            const deviceId = urlParams.get('deviceId');

            const productId = document.getElementById('editProductSelect').value;
            const direction = parseInt(document.getElementById('editDirectionSelect').value);
            const statusId = parseInt(document.getElementById('editStatusSelect').value);

            try {
                const response = await fetch('/api/hmi/edit_rack', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        rack_id: editRackId,
                        location_id: editRackLocationId,
                        device_id: deviceId,
                        product_id: productId ? parseInt(productId) : null,
                        direction: direction,
                        status_id: statusId
                    })
                });

                const result = await response.json();

                if (result.success) {
                    console.log('Rack updated successfully');
                    if (socket && isConnected) {
                        socket.emit('request_hmi_data', { device_id: deviceId });
                    }
                } else {
                    alert(`æ“ä½œå¤±æ•—ï¼š${result.message || 'æœªçŸ¥éŒ¯èª¤'}`);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('æ“ä½œå¤±æ•—ï¼šç¶²è·¯éŒ¯èª¤');
            } finally {
                closeEditRackModal();
            }
        }

        // ===========================================================================
        // Bitmap Management Functions
        // ===========================================================================

        async function loadBitmapData(rackId) {
            const urlParams = new URLSearchParams(window.location.search);
            const deviceId = urlParams.get('deviceId');

            try {
                const response = await fetch(`/api/hmi/racks/${rackId}/bitmap-status?device_id=${deviceId}`);
                const result = await response.json();

                if (result.success && result.data) {
                    editRackData = result.data;
                    updateBitmapStats(result.data);
                    renderBitmapGrids(result.data);
                } else {
                    alert('è¼‰å…¥æ ¼ä½è³‡æ–™å¤±æ•—');
                }
            } catch (error) {
                console.error('Failed to load bitmap data:', error);
                alert('è¼‰å…¥æ ¼ä½è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤');
            }
        }

        function updateBitmapStats(data) {
            document.getElementById('bitmapOccupiedCount').textContent = data.stats.occupied_count;
            document.getElementById('bitmapEnabledCount').textContent = data.stats.enabled_count;
            document.getElementById('bitmapEmptyCount').textContent = data.stats.empty_enabled_count;
            document.getElementById('bitmapTotalSlots').textContent = data.max_slots;
        }

        function renderBitmapGrids(data) {
            const gridA = document.getElementById('bitmapGridA');
            const gridB = document.getElementById('bitmapGridB');

            gridA.innerHTML = '';
            gridB.innerHTML = '';

            // A é¢ï¼šæ ¼ä½ 1-16
            for (let i = 1; i <= 16; i++) {
                const status = data.bitmap_status[String(i)];
                const slot = createSlotButton(i, status);
                gridA.appendChild(slot);
            }

            // B é¢ï¼šæ ¼ä½ 17-32
            for (let i = 17; i <= 32; i++) {
                const status = data.bitmap_status[String(i)];
                const slot = createSlotButton(i, status);
                gridB.appendChild(slot);
            }
        }

        function createSlotButton(slotIndex, status) {
            const button = document.createElement('button');
            button.className = 'button is-large is-fullwidth bitmap-slot';
            button.dataset.slotIndex = slotIndex;

            // è¨­å®šæ¨£å¼é¡åˆ¥
            if (!status.enabled) {
                button.classList.add('slot-disabled');
            }
            if (status.occupied) {
                button.classList.add('slot-occupied');
            } else {
                button.classList.add('slot-empty');
            }

            // é¡¯ç¤ºå…§å®¹
            const statusIcon = status.occupied ? 'âœ“' : 'â—‹';
            const enabledBadge = !status.enabled ? '<span class="tag is-warning">ç¦ç”¨</span>' : '';

            button.innerHTML = `
                <div style="text-align: center;">
                    <div style="font-size: 1.5rem; font-weight: bold;">${slotIndex}</div>
                    <div style="font-size: 2rem;">${statusIcon}</div>
                    ${enabledBadge}
                </div>
            `;

            // ç¶å®šè§¸æ§äº‹ä»¶ï¼ˆå–®æ“Šåˆ‡æ›å ç”¨ï¼Œé•·æŒ‰åˆ‡æ›å•Ÿç”¨ï¼‰
            button.addEventListener('touchstart', (e) => handleSlotTouchStart(e, slotIndex, status));
            button.addEventListener('touchend', (e) => handleSlotTouchEnd(e, slotIndex, status));
            button.addEventListener('touchcancel', () => clearPressTimer());

            // ä¹Ÿæ”¯æ´æ»‘é¼ äº‹ä»¶ï¼ˆé–‹ç™¼æ¸¬è©¦ç”¨ï¼‰
            button.addEventListener('mousedown', (e) => handleSlotTouchStart(e, slotIndex, status));
            button.addEventListener('mouseup', (e) => handleSlotTouchEnd(e, slotIndex, status));
            button.addEventListener('mouseleave', () => clearPressTimer());

            return button;
        }

        function handleSlotTouchStart(e, slotIndex, status) {
            e.preventDefault();
            pressTimer = setTimeout(() => {
                // é•·æŒ‰ï¼šåˆ‡æ›å•Ÿç”¨/ç¦ç”¨
                handleSlotToggleEnable(slotIndex, status);
                pressTimer = null;
            }, 800); // 800ms åˆ¤å®šç‚ºé•·æŒ‰
        }

        function handleSlotTouchEnd(e, slotIndex, status) {
            e.preventDefault();
            if (pressTimer) {
                // çŸ­æŒ‰ï¼šåˆ‡æ›å ç”¨/ç©º
                clearTimeout(pressTimer);
                handleSlotToggleOccupy(slotIndex, status);
            }
            pressTimer = null;
        }

        function clearPressTimer() {
            if (pressTimer) {
                clearTimeout(pressTimer);
                pressTimer = null;
            }
        }

        async function handleSlotToggleOccupy(slotIndex, status) {
            if (!status.enabled) {
                alert('æ­¤æ ¼ä½å·²ç¦ç”¨ï¼Œè«‹é•·æŒ‰å•Ÿç”¨');
                return;
            }

            const urlParams = new URLSearchParams(window.location.search);
            const deviceId = urlParams.get('deviceId');
            const action = status.occupied ? 'empty' : 'occupy';

            try {
                const response = await fetch(`/api/hmi/racks/${editRackId}/slot/${slotIndex}/${action}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ device_id: deviceId })
                });

                const result = await response.json();

                if (result.success) {
                    await loadBitmapData(editRackId);
                } else {
                    alert('æ“ä½œå¤±æ•—ï¼š' + (result.message || 'æœªçŸ¥éŒ¯èª¤'));
                }
            } catch (error) {
                console.error('Slot operation failed:', error);
                alert('æ“ä½œæ™‚ç™¼ç”ŸéŒ¯èª¤');
            }
        }

        async function handleSlotToggleEnable(slotIndex, status) {
            const action = status.enabled ? 'ç¦ç”¨' : 'å•Ÿç”¨';
            if (!confirm(`ç¢ºå®šè¦${action}æ ¼ä½ ${slotIndex} å—ï¼Ÿ`)) return;

            const urlParams = new URLSearchParams(window.location.search);
            const deviceId = urlParams.get('deviceId');

            try {
                const response = await fetch(`/api/hmi/racks/${editRackId}/slot/${slotIndex}/toggle-enable`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ device_id: deviceId })
                });

                const result = await response.json();

                if (result.success) {
                    await loadBitmapData(editRackId);
                } else {
                    alert('æ“ä½œå¤±æ•—ï¼š' + (result.message || 'æœªçŸ¥éŒ¯èª¤'));
                }
            } catch (error) {
                console.error('Slot toggle failed:', error);
                alert('æ“ä½œæ™‚ç™¼ç”ŸéŒ¯èª¤');
            }
        }

        async function bitmapClearAll() {
            if (!confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰æ ¼ä½å—ï¼Ÿ')) return;

            const urlParams = new URLSearchParams(window.location.search);
            const deviceId = urlParams.get('deviceId');

            try {
                const response = await fetch(`/api/hmi/racks/${editRackId}/slots/clear-all`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ device_id: deviceId })
                });

                const result = await response.json();

                if (result.success) {
                    await loadBitmapData(editRackId);
                } else {
                    alert('æ“ä½œå¤±æ•—ï¼š' + (result.message || 'æœªçŸ¥éŒ¯èª¤'));
                }
            } catch (error) {
                console.error('Clear all failed:', error);
                alert('æ“ä½œæ™‚ç™¼ç”ŸéŒ¯èª¤');
            }
        }

        async function bitmapEnableAll() {
            const urlParams = new URLSearchParams(window.location.search);
            const deviceId = urlParams.get('deviceId');

            try {
                const response = await fetch(`/api/hmi/racks/${editRackId}/slots/enable-all`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ device_id: deviceId })
                });

                const result = await response.json();

                if (result.success) {
                    await loadBitmapData(editRackId);
                } else {
                    alert('æ“ä½œå¤±æ•—ï¼š' + (result.message || 'æœªçŸ¥éŒ¯èª¤'));
                }
            } catch (error) {
                console.error('Enable all failed:', error);
                alert('æ“ä½œæ™‚ç™¼ç”ŸéŒ¯èª¤');
            }
        }

        async function bitmapDisableAll() {
            if (!confirm('ç¢ºå®šè¦ç¦ç”¨æ‰€æœ‰æ ¼ä½å—ï¼Ÿ')) return;

            const urlParams = new URLSearchParams(window.location.search);
            const deviceId = urlParams.get('deviceId');

            try {
                const response = await fetch(`/api/hmi/racks/${editRackId}/slots/disable-all`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ device_id: deviceId })
                });

                const result = await response.json();

                if (result.success) {
                    await loadBitmapData(editRackId);
                } else {
                    alert('æ“ä½œå¤±æ•—ï¼š' + (result.message || 'æœªçŸ¥éŒ¯èª¤'));
                }
            } catch (error) {
                console.error('Disable all failed:', error);
                alert('æ“ä½œæ™‚ç™¼ç”ŸéŒ¯èª¤');
            }
        }

        // ç§»é™¤å®šæœŸåˆ·æ–°é é¢ï¼Œæ”¹ç”¨ Socket.IO å³æ™‚æ›´æ–°
    </script>
</body>
</html>