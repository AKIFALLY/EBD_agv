<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HMI çµ‚ç«¯ - {{ device_description }}</title>
    <link rel="icon" type="image/png" href="/static/favicon.png">
    <link rel="stylesheet" href="/static/css/bulma_1_0_4.min.css" />
    <link rel="stylesheet" href="/static/css/materialdesignicons.min.css" />
    <link rel="stylesheet" href="/static/css/opui-bulma-extend.css" />
    <link rel="stylesheet" href="/static/css/hmi.css?v=2.1">
    <!-- Socket.IO for real-time connection -->
    <script src="/static/js/lib/socket.io.min.js?v=1.0"></script>
</head>
<body>
    <div class="main-container">
        <!-- å°èˆªæ¬„ -->
        <nav class="navbar is-black" role="navigation">
            <div class="navbar-brand">
                <a class="navbar-item" href="/?deviceId={{ device_id }}">
                    <img src="/static/favicon.png" alt="OPUI" style="width: 24px; height: 24px; margin-right: 8px;">
                </a>
                <div class="navbar-item">
                    <span class="has-text-grey">{{ device_id }}</span>
                </div>
            </div>
            
            <div class="navbar-center">
                <div class="navbar-item">
                    <span class="has-text-white has-text-weight-bold is-size-5">{{ device_description }}</span>
                </div>
            </div>
            
            <div class="navbar-end">
                <div class="navbar-item">
                    <span class="has-text-grey" id="current-time"></span>
                </div>
                <div class="navbar-item">
                    <span class="mdi mdi-wifi is-connected" id="connection-status"></span>
                </div>
            </div>
        </nav>
        
        <!-- å…§å®¹å€åŸŸ -->
        <div class="content-area">
            <div class="locations-grid layout-{{ layout }}">
                {% for location_data in locations %}
                <div class="location-box no-select {% if not location_data.rack %}no-rack{% endif %}">
                    <div class="location-content">
                        <h2 class="location-title has-text-centered">
                            {{ location_data.location.name }}
                        </h2>
                        
                        {% if location_data.rack %}
                        <!-- Info Grid Container - 2x2 ä½ˆå±€ -->
                        <div class="info-rows-container">
                            <!-- å·¦ä¸Š: Rack -->
                            <div class="info-item">
                                <span class="info-label">Rack</span>
                                <span class="info-value value-rack">{{ location_data.rack.name }}</span>
                            </div>
                            
                            <!-- å³ä¸Š: Carrier -->
                            <div class="info-item">
                                <span class="info-label">Carrier</span>
                                <span class="info-value value-carrier">{{ location_data.carriers|length }}</span>
                            </div>
                            
                            {% if location_data.product %}
                            <!-- å·¦ä¸‹: Product -->
                            <div class="info-item">
                                <span class="info-label">Product</span>
                                <span class="info-value value-product">{{ location_data.product.name }}</span>
                            </div>
                            
                            <!-- å³ä¸‹: Size -->
                            <div class="info-item">
                                <span class="info-label">Size</span>
                                <span class="info-value value-size">{{ location_data.product.size }}</span>
                            </div>
                            {% else %}
                            <!-- å¦‚æœæ²’æœ‰ç”¢å“ï¼Œé¡¯ç¤ºç©ºæ¬„ä½ -->
                            <div class="info-item"></div>
                            <div class="info-item"></div>
                            {% endif %}
                        </div>
                        
                        <button class="button-large" 
                                onclick="confirmRemoveRack({{ location_data.location.id }}, '{{ location_data.location.name }}', '{{ location_data.rack.name }}')">
                            <i class="mdi mdi-export mdi-48px" style="position: relative; z-index: 1;"></i>
                            <span style="margin-left: 10px; font-size: 1.8rem; position: relative; z-index: 1;">Remove</span>
                        </button>
                        {% else %}
                        <div class="empty-location">
                            <p>No Rack</p>
                        </div>
                        <button class="button-disabled" disabled>
                            <span style="font-size: 1.8rem;">Empty</span>
                        </button>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    
    <!-- Dark Theme Modal ç¢ºèªå°è©±æ¡† -->
    <div id="confirmModal" class="modal">
        <div class="modal-background" onclick="closeModal()"></div>
        <div class="modal-card">
            <div class="dark-modal-content">
                <header class="dark-modal-header">
                    <h2 class="dark-modal-title">ç¢ºèªç§»å‡º Rack</h2>
                    <button class="dark-modal-close" onclick="closeModal()">
                        <i class="mdi mdi-close mdi-24px"></i>
                    </button>
                </header>
                <section class="dark-modal-body">
                    <p class="dark-modal-text">
                        ç¢ºå®šè¦å¾ <span class="highlight-text" id="locationName"></span> ç§»å‡º 
                        <span class="highlight-text" id="rackName"></span> å—ï¼Ÿ
                    </p>
                </section>
                <footer class="dark-modal-footer">
                    <button class="modal-button-confirm" onclick="executeRemoveRack()">
                        <i class="mdi mdi-check mdi-24px"></i>
                        <span>ç¢ºèª</span>
                    </button>
                    <button class="modal-button-cancel" onclick="closeModal()">
                        <i class="mdi mdi-close mdi-24px"></i>
                        <span>å–æ¶ˆ</span>
                    </button>
                </footer>
            </div>
        </div>
    </div>
    
    <script>
        // å…¨åŸŸè®Šæ•¸
        let currentLocationId = null;
        let currentLocationName = '';
        let currentRackName = '';
        let socket = null;
        let isConnected = false;
        
        // ç²å–æ­£ç¢ºçš„ Socket.IO é€£ç·š URL
        function getSocketUrl() {
            const hostname = window.location.hostname;
            const protocol = window.location.protocol === 'https:' ? 'https' : 'http';
            const currentPort = window.location.port;
            
            console.log(`ğŸ” ç•¶å‰ä½ç½®: ${protocol}://${hostname}:${currentPort}`);
            
            // å¦‚æœç•¶å‰é é¢çš„ hostname æ˜¯ op.uiï¼Œå‰‡é€£æ¥åˆ°å°æ‡‰çš„å¾Œç«¯
            if (hostname === 'op.ui') {
                const socketUrl = `${protocol}://op.ui:8002`;
                console.log(`ğŸ¯ op.ui ç’°å¢ƒï¼ŒSocket URL: ${socketUrl}`);
                return socketUrl;
            }
            
            // å¦‚æœæ˜¯ localhost æˆ–å…¶ä»–æƒ…æ³ï¼Œä½¿ç”¨ç•¶å‰åŸŸå
            if (hostname === 'localhost' || hostname === '127.0.0.1') {
                const socketUrl = `${protocol}://${hostname}:8002`;
                console.log(`ğŸ  æœ¬åœ°ç’°å¢ƒï¼ŒSocket URL: ${socketUrl}`);
                return socketUrl;
            }
            
            // å¦‚æœç•¶å‰é é¢å·²ç¶“åœ¨ 8002 åŸ ï¼Œä½¿ç”¨ç›¸åŒçš„ host å’Œ port
            if (currentPort === '8002') {
                const socketUrl = `${protocol}://${hostname}:8002`;
                console.log(`âœ… å·²åœ¨ 8002 åŸ ï¼ŒSocket URL: ${socketUrl}`);
                return socketUrl;
            }
            
            // é è¨­æƒ…æ³ï¼šå˜—è©¦é€£æ¥åˆ° 8002 åŸ 
            const defaultUrl = `${protocol}://${hostname}:8002`;
            console.log(`ğŸ”§ é è¨­æƒ…æ³ï¼ŒSocket URL: ${defaultUrl}`);
            return defaultUrl;
        }
        
        // åˆå§‹åŒ– Socket.IO é€£ç·š
        function initSocketConnection() {
            const socketUrl = getSocketUrl();
            console.log('Connecting to Socket.IO at:', socketUrl);
            
            socket = io(socketUrl, {
                transports: ['websocket', 'polling'],  // å„ªå…ˆä½¿ç”¨ websocket
                upgrade: true,
                rememberUpgrade: true,
                timeout: 10000,
                forceNew: false,
                autoConnect: true,
                reconnection: true,
                reconnectionAttempts: 5,
                reconnectionDelay: 1000,
                reconnectionDelayMax: 5000
            });
            
            // é€£ç·šäº‹ä»¶
            socket.on('connect', function() {
                console.log('Socket.IO connected');
                isConnected = true;
                updateConnectionStatus(true);
                // è«‹æ±‚æœ€æ–°è³‡æ–™
                requestLatestData();
            });
            
            socket.on('disconnect', function() {
                console.log('Socket.IO disconnected');
                isConnected = false;
                updateConnectionStatus(false);
            });
            
            socket.on('error', function(error) {
                console.error('Socket.IO error:', error);
                isConnected = false;
                updateConnectionStatus(false);
            });
            
            // æ¥æ”¶è³‡æ–™æ›´æ–°
            socket.on('hmi_data_update', function(data) {
                console.log('Received HMI data update:', data);
                updateHMIDisplay(data);
            });
            
            // æ¥æ”¶ä½ç½®ç‹€æ…‹æ›´æ–°
            socket.on('location_update', function(data) {
                console.log('Received location update:', data);
                updateLocationDisplay(data);
            });
        }
        
        // è«‹æ±‚æœ€æ–°è³‡æ–™
        function requestLatestData() {
            if (socket && isConnected) {
                const urlParams = new URLSearchParams(window.location.search);
                const deviceId = urlParams.get('deviceId');
                socket.emit('request_hmi_data', { device_id: deviceId });
            }
        }
        
        // æ›´æ–° HMI é¡¯ç¤ºï¼ˆå±€éƒ¨æ›´æ–°ï¼Œä¸é‡è¼‰é é¢ï¼‰
        function updateHMIDisplay(data) {
            if (!data || !data.locations) return;
            
            // æ›´æ–°æ¯å€‹ä½ç½®çš„é¡¯ç¤º
            data.locations.forEach(function(locationData, index) {
                updateSingleLocation(index, locationData);
            });
        }
        
        // æ›´æ–°å–®å€‹ä½ç½®é¡¯ç¤º - åªæ›´æ–°å€¼ï¼Œä¸é‡å»ºæ•´å€‹çµæ§‹
        function updateSingleLocation(index, locationData) {
            const locationBoxes = document.querySelectorAll('.location-box');
            if (index >= locationBoxes.length) return;
            
            const box = locationBoxes[index];
            
            // æ›´æ–°ä½ç½®æ¨™é¡Œ
            const locationTitle = box.querySelector('.location-title');
            if (locationTitle) {
                locationTitle.textContent = locationData.location.name;
            }
            
            // æª¢æŸ¥æ˜¯å¦éœ€è¦é‡å»ºçµæ§‹ï¼ˆæœ‰ç„¡ Rack ç‹€æ…‹æ”¹è®Šï¼‰
            const hasRackNow = !!locationData.rack;
            const hadRackBefore = !!box.querySelector('.info-rows-container');
            
            if (hasRackNow !== hadRackBefore) {
                // ç‹€æ…‹æ”¹è®Šï¼Œéœ€è¦é‡å»ºçµæ§‹
                const content = box.querySelector('.location-content');
                if (!content) return;
                
                // Update box class based on rack status
                if (hasRackNow) {
                    box.classList.remove('no-rack');
                } else {
                    box.classList.add('no-rack');
                }
                
                let newHTML = `<h2 class="location-title has-text-centered">${locationData.location.name}</h2>`;
                
                if (locationData.rack) {
                    newHTML += `<div class="info-rows-container">
                        <div class="info-item">
                            <span class="info-label">Rack</span>
                            <span class="info-value value-rack">${locationData.rack.name}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Carrier</span>
                            <span class="info-value value-carrier">${locationData.carriers.length}</span>
                        </div>`;
                    
                    if (locationData.product) {
                        newHTML += `
                            <div class="info-item">
                                <span class="info-label">Product</span>
                                <span class="info-value value-product">${locationData.product.name}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Size</span>
                                <span class="info-value value-size">${locationData.product.size}</span>
                            </div>`;
                    } else {
                        newHTML += `
                            <div class="info-item"></div>
                            <div class="info-item"></div>`;
                    }
                    
                    newHTML += `</div>
                    <button class="button-large" onclick="confirmRemoveRack(${locationData.location.id}, '${locationData.location.name}', '${locationData.rack.name}')">
                        <i class="mdi mdi-export mdi-48px" style="position: relative; z-index: 1;"></i>
                        <span style="margin-left: 10px; font-size: 1.8rem; position: relative; z-index: 1;">Remove</span>
                    </button>`;
                } else {
                    newHTML += `
                        <div class="empty-location">
                            <p>No Rack</p>
                        </div>
                        <button class="button-disabled" disabled>
                            <span style="font-size: 1.8rem;">Empty</span>
                        </button>`;
                }
                
                content.innerHTML = newHTML;
            } else if (hasRackNow) {
                // åªæ›´æ–°å€¼ï¼Œä¸é‡å»ºçµæ§‹
                const rackValue = box.querySelector('.value-rack');
                if (rackValue && locationData.rack) {
                    rackValue.textContent = locationData.rack.name;
                }
                
                const carrierValue = box.querySelector('.value-carrier');
                if (carrierValue) {
                    carrierValue.textContent = locationData.carriers.length;
                }
                
                if (locationData.product) {
                    const productValue = box.querySelector('.value-product');
                    if (productValue) {
                        productValue.textContent = locationData.product.name;
                    }
                    
                    const sizeValue = box.querySelector('.value-size');
                    if (sizeValue) {
                        sizeValue.textContent = locationData.product.size;
                    }
                }
                
                // æ›´æ–°æŒ‰éˆ•çš„ onclick äº‹ä»¶ï¼ˆå¦‚æœ rack åç¨±æ”¹è®Šï¼‰
                const button = box.querySelector('.button-large');
                if (button && locationData.rack) {
                    button.setAttribute('onclick', 
                        `confirmRemoveRack(${locationData.location.id}, '${locationData.location.name}', '${locationData.rack.name}')`);
                }
            }
        }
        
        // æ›´æ–°å–®å€‹ä½ç½®ç‹€æ…‹
        function updateLocationDisplay(data) {
            if (!data || !data.location_id) return;
            
            // æ‰¾åˆ°å°æ‡‰çš„ä½ç½®ä¸¦æ›´æ–°
            requestLatestData(); // ç°¡å–®èµ·è¦‹ï¼Œè«‹æ±‚å…¨éƒ¨è³‡æ–™æ›´æ–°
        }
        
        // è™•ç† location-box é»æ“Šå‹•ç•«
        document.addEventListener('DOMContentLoaded', function() {
            // åˆå§‹åŒ– Socket.IO é€£ç·š
            initSocketConnection();
            const locationBoxes = document.querySelectorAll('.location-box');
            
            locationBoxes.forEach(box => {
                // è§¸æ§æˆ–é»æ“Šé–‹å§‹
                box.addEventListener('touchstart', handleTouch);
                box.addEventListener('mousedown', handleTouch);
                
                function handleTouch(e) {
                    // é˜²æ­¢é‡è¤‡è§¸ç™¼
                    if (box.classList.contains('touched')) return;
                    
                    // æ·»åŠ å‹•ç•« class
                    box.classList.add('touched');
                    
                    // å‹•ç•«æ’­æ”¾å®Œå¾Œç§»é™¤ class
                    setTimeout(() => {
                        box.classList.remove('touched');
                    }, 600); // èˆ‡å‹•ç•«æ™‚é–“ä¸€è‡´
                }
            });
        });
        
        // æ›´æ–°æ™‚é–“é¡¯ç¤º
        function updateTime() {
            const now = new Date();
            const timeString = now.toLocaleString('zh-TW');
            document.getElementById('current-time').textContent = timeString;
        }
        
        // æ›´æ–°é€£ç·šç‹€æ…‹é¡¯ç¤º
        function updateConnectionStatus(isConnected) {
            const statusIcon = document.getElementById('connection-status');
            if (statusIcon) {
                if (isConnected) {
                    statusIcon.classList.remove('is-disconnected');
                    statusIcon.classList.add('is-connected');
                } else {
                    statusIcon.classList.remove('is-connected');
                    statusIcon.classList.add('is-disconnected');
                }
            }
        }
        
        // æª¢æŸ¥ Socket.IO é€£ç·šç‹€æ…‹
        function checkConnection() {
            updateConnectionStatus(isConnected);
        }
        
        // åˆå§‹åŒ–æ™‚é–“é¡¯ç¤º
        updateTime();
        setInterval(updateTime, 1000);
        
        // åˆå§‹åŒ–é€£ç·šç‹€æ…‹
        checkConnection();
        
        // å®šæœŸæª¢æŸ¥é€£ç·šç‹€æ…‹ï¼ˆæ¯5ç§’ï¼‰
        setInterval(function() {
            checkConnection();
            // å¦‚æœå·²é€£ç·šï¼Œè«‹æ±‚æœ€æ–°è³‡æ–™
            if (isConnected) {
                requestLatestData();
            }
        }, 5000);
        
        // é¡¯ç¤ºç¢ºèªå°è©±æ¡†
        function confirmRemoveRack(locationId, locationName, rackName) {
            currentLocationId = locationId;
            currentLocationName = locationName;
            currentRackName = rackName;
            
            document.getElementById('locationName').textContent = locationName;
            document.getElementById('rackName').textContent = rackName;
            document.getElementById('confirmModal').classList.add('is-active');
        }
        
        // é—œé–‰å°è©±æ¡†
        function closeModal() {
            document.getElementById('confirmModal').classList.remove('is-active');
            currentLocationId = null;
            currentLocationName = '';
            currentRackName = '';
        }
        
        // åŸ·è¡Œç§»å‡º Rack
        async function executeRemoveRack() {
            if (!currentLocationId) return;
            
            // å–å¾— deviceId
            const urlParams = new URLSearchParams(window.location.search);
            const deviceId = urlParams.get('deviceId');
            
            try {
                const response = await fetch('/api/hmi/remove_rack', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        location_id: currentLocationId,
                        device_id: deviceId,
                        operator_note: `ç”± HMI çµ‚ç«¯ ${deviceId} æ“ä½œ`
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // ä¸è¦é‡æ–°è¼‰å…¥é é¢ï¼Œæ”¹ç”¨ Socket.IO è«‹æ±‚æ›´æ–°è³‡æ–™
                    console.log('Rack removed successfully, requesting data update via Socket.IO');
                    
                    // ç«‹å³æ›´æ–°è©²ä½ç½®çš„é¡¯ç¤ºç‚ºç„¡ Rack ç‹€æ…‹
                    updateLocationToEmpty(currentLocationId, currentLocationName);
                    
                    // é€é Socket.IO è«‹æ±‚æœ€æ–°è³‡æ–™
                    if (socket && isConnected) {
                        socket.emit('request_hmi_data', { device_id: deviceId });
                    }
                } else {
                    // åªåœ¨å¤±æ•—æ™‚é¡¯ç¤ºæç¤º
                    alert(`æ“ä½œå¤±æ•—ï¼š${result.message}`);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('æ“ä½œå¤±æ•—ï¼šç¶²è·¯éŒ¯èª¤');
            } finally {
                closeModal();
            }
        }
        
        // ç«‹å³æ›´æ–°ä½ç½®ç‚ºç©ºç‹€æ…‹ï¼ˆä¸ç­‰å¾… Socket.IOï¼‰
        function updateLocationToEmpty(locationId, locationName) {
            const locationBoxes = document.querySelectorAll('.location-box');
            
            // æ‰¾åˆ°å°æ‡‰çš„ location box
            for (let box of locationBoxes) {
                const button = box.querySelector('.button-large');
                if (button && button.getAttribute('onclick').includes(`${locationId}`)) {
                    // Add no-rack class to the box
                    box.classList.add('no-rack');
                    
                    const content = box.querySelector('.location-content');
                    if (content) {
                        // ä¿ç•™æ¨™é¡Œ
                        const title = content.querySelector('.location-title');
                        const titleText = title ? title.textContent : locationName;
                        
                        // é‡å»ºç‚ºç„¡ Rack ç‹€æ…‹
                        content.innerHTML = `
                            <h2 class="location-title has-text-centered">${titleText}</h2>
                            <div class="empty-location">
                                <p>No Rack</p>
                            </div>
                            <button class="button-disabled" disabled>
                                <span style="font-size: 1.8rem;">Empty</span>
                            </button>`;
                    }
                    break;
                }
            }
        }
        
        // é»æ“Š modal å¤–éƒ¨é—œé–‰
        window.onclick = function(event) {
            const modal = document.getElementById('confirmModal');
            if (event.target == modal) {
                closeModal();
            }
        }
        
        // ç§»é™¤å®šæœŸåˆ·æ–°é é¢ï¼Œæ”¹ç”¨ Socket.IO å³æ™‚æ›´æ–°
    </script>
</body>
</html>