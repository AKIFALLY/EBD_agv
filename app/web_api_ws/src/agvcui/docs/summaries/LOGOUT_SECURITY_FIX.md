# ğŸ”’ ç™»å‡ºå®‰å…¨å•é¡Œä¿®å¾©

## ğŸš¨ åš´é‡å®‰å…¨å•é¡Œ
**å•é¡Œ**: ç”¨æˆ¶é»æ“Šç™»å‡ºå¾Œï¼Œæ²’æœ‰é‡æ–°ç™»å…¥ä¹Ÿå¯ä»¥ç¹¼çºŒä½¿ç”¨ç³»çµ±ï¼Œè¨ªå•å—ä¿è­·çš„é é¢ã€‚

é€™æ˜¯ä¸€å€‹**åš´é‡çš„å®‰å…¨æ¼æ´**ï¼Œå¯èƒ½å°è‡´ï¼š
- æœªæˆæ¬Šè¨ªå•
- æœƒè©±åŠ«æŒé¢¨éšª
- æ•¸æ“šæ´©éœ²

## ğŸ” å•é¡Œåˆ†æ

### å¯èƒ½çš„åŸå› 
1. **Cookie åˆªé™¤ä¸å®Œæ•´** - ç€è¦½å™¨ä»ç„¶ä¿ç•™ cookie
2. **ç€è¦½å™¨ç·©å­˜** - é é¢è¢«ç·©å­˜ï¼Œæœªé‡æ–°é©—è­‰
3. **è·¯å¾‘ä¸åŒ¹é…** - åˆªé™¤ cookie æ™‚è·¯å¾‘åƒæ•¸ä¸æ­£ç¢º
4. **å¤šé‡ cookie** - å­˜åœ¨å¤šå€‹ç›¸åŒåç¨±çš„ cookie
5. **å‰ç«¯ç‹€æ…‹æ®˜ç•™** - JavaScript ç‹€æ…‹æœªæ¸…é™¤

## âœ… å¯¦æ–½çš„ä¿®å¾©

### 1. å¢å¼·æœå‹™å™¨ç«¯ç™»å‡º
```python
@router.get("/logout")
async def logout(request: Request):
    # æ›´å¼·å¥çš„ cookie åˆªé™¤
    response.delete_cookie(
        key="access_token",
        path="/",
        domain=None,
        secure=False,
        httponly=True,
        samesite="lax"
    )
    
    # é¡å¤–ä¿éšªï¼šè¨­ç½®éæœŸæ™‚é–“ç‚ºéå»
    response.set_cookie(
        key="access_token",
        value="",
        path="/",
        expires="Thu, 01 Jan 1970 00:00:00 GMT",
        max_age=0,
        httponly=True,
        secure=False,
        samesite="lax"
    )
```

### 2. å¢å¼·å‰ç«¯ç™»å‡ºè™•ç†
```javascript
logout() {
    // å¤šç¨®æ–¹å¼æ¸…é™¤ cookie
    document.cookie = 'access_token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/; max-age=0;';
    document.cookie = 'access_token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/app; max-age=0;';
    
    // æ¸…é™¤ç€è¦½å™¨å­˜å„²
    localStorage.clear();
    sessionStorage.clear();
    
    // æ¸…é™¤é é¢ç‹€æ…‹
    delete window.currentUser;
    
    // é‡å®šå‘åˆ°æœå‹™å™¨ç™»å‡ºç«¯é»
    window.location.href = '/logout';
}
```

### 3. å¢å¼·ä¸­é–“ä»¶èª¿è©¦
```python
# è©³ç´°çš„ cookie æª¢æ¸¬æ—¥èªŒ
print(f"ğŸª Cookie access_token: {'å­˜åœ¨' if access_token else 'ä¸å­˜åœ¨'}")
print(f"ğŸ”‘ Token å…§å®¹: {access_token[:30]}...")
print(f"ğŸ“‹ æ‰€æœ‰ Cookies: {list(all_cookies.keys())}")
```

## ğŸ§ª æ¸¬è©¦æ­¥é©Ÿ

### 1. åŸºæœ¬ç™»å‡ºæ¸¬è©¦
1. ç™»å…¥ç³»çµ± (admin / admin123)
2. é»æ“Šç™»å‡ºæŒ‰éˆ•
3. å˜—è©¦è¨ªå• `/map` æˆ–å…¶ä»–å—ä¿è­·é é¢
4. **é æœŸ**: æ‡‰è©²è¢«é‡å®šå‘åˆ°ç™»å…¥é é¢

### 2. ç€è¦½å™¨æª¢æŸ¥
1. æ‰“é–‹é–‹ç™¼è€…å·¥å…· (F12)
2. é€²å…¥ Application æ¨™ç±¤
3. æŸ¥çœ‹ Cookies éƒ¨åˆ†
4. **é æœŸ**: `access_token` cookie æ‡‰è©²ä¸å­˜åœ¨

### 3. æœå‹™å™¨æ—¥èªŒæª¢æŸ¥
ç™»å‡ºæ™‚æ‡‰è©²çœ‹åˆ°ï¼š
```
ğŸšª ç™»å‡ºè«‹æ±‚: ç•¶å‰ token å­˜åœ¨
ğŸ”‘ è¦åˆªé™¤çš„ token: xxx...
âœ… å·²åˆªé™¤ access_token cookieï¼Œé‡å®šå‘åˆ°ç™»å…¥é é¢
```

è¨ªå•å—ä¿è­·é é¢æ™‚æ‡‰è©²çœ‹åˆ°ï¼š
```
ğŸ” ä¸­é–“ä»¶è™•ç†è·¯å¾‘: /map
ğŸ”’ è·¯å¾‘ /map æ˜¯å¦å—ä¿è­·: True
ğŸª Cookie access_token: ä¸å­˜åœ¨
âŒ ç„¡ tokenï¼Œé‡å®šå‘åˆ°ç™»å…¥é é¢: /map
```

## ğŸ”§ æ•…éšœæ’é™¤

### å¦‚æœç™»å‡ºå¾Œä»èƒ½è¨ªå•é é¢

1. **æ¸…é™¤ç€è¦½å™¨ç·©å­˜**
   ```
   - å³éµé»æ“Šåˆ·æ–°æŒ‰éˆ•
   - é¸æ“‡ "æ¸…ç©ºç·©å­˜ä¸¦ç¡¬æ€§é‡æ–°è¼‰å…¥"
   ```

2. **æ‰‹å‹•æ¸…é™¤ Cookies**
   ```
   - é–‹ç™¼è€…å·¥å…· > Application > Cookies
   - åˆªé™¤æ‰€æœ‰ç›¸é—œ cookies
   ```

3. **ä½¿ç”¨ç„¡ç—•æ¨¡å¼æ¸¬è©¦**
   ```
   - é–‹å•Ÿç„¡ç—•/éš±ç§ç€è¦½æ¨¡å¼
   - é‡æ–°æ¸¬è©¦ç™»å…¥å’Œç™»å‡ºæµç¨‹
   ```

4. **æª¢æŸ¥æœå‹™å™¨æ—¥èªŒ**
   ```
   - ç¢ºèªç™»å‡ºè«‹æ±‚è¢«æ­£ç¢ºè™•ç†
   - ç¢ºèªä¸­é–“ä»¶æª¢æ¸¬åˆ° cookie ä¸å­˜åœ¨
   ```

### å¦‚æœå•é¡Œä»ç„¶å­˜åœ¨

å¯èƒ½éœ€è¦å¯¦æ–½æ›´å¼·çš„å®‰å…¨æªæ–½ï¼š

1. **æœå‹™å™¨ç«¯æœƒè©±ç®¡ç†**
   ```python
   # ç¶­è­·æ´»èº token é»‘åå–®
   blacklisted_tokens = set()
   
   def blacklist_token(token):
       blacklisted_tokens.add(token)
   
   def is_token_blacklisted(token):
       return token in blacklisted_tokens
   ```

2. **Token éæœŸæª¢æŸ¥**
   ```python
   # æª¢æŸ¥ token æ˜¯å¦åœ¨é»‘åå–®ä¸­
   if is_token_blacklisted(access_token):
       return redirect_to_login()
   ```

## ğŸ›¡ï¸ å®‰å…¨æœ€ä½³å¯¦è¸

### 1. çŸ­æœŸ Token
- è¨­ç½®è¼ƒçŸ­çš„ token éæœŸæ™‚é–“ (ç›®å‰ 30 åˆ†é˜)
- å¯¦æ–½ refresh token æ©Ÿåˆ¶

### 2. æœƒè©±ç®¡ç†
- æœå‹™å™¨ç«¯ç¶­è­·æ´»èºæœƒè©±åˆ—è¡¨
- ç™»å‡ºæ™‚ç«‹å³ä½¿ token å¤±æ•ˆ

### 3. å®‰å…¨ Headers
```python
response.headers["Cache-Control"] = "no-cache, no-store, must-revalidate"
response.headers["Pragma"] = "no-cache"
response.headers["Expires"] = "0"
```

### 4. HTTPS (ç”Ÿç”¢ç’°å¢ƒ)
```python
response.set_cookie(
    secure=True,  # åªåœ¨ HTTPS ä¸‹ç™¼é€
    samesite="strict"  # æ›´åš´æ ¼çš„åŒç«™ç­–ç•¥
)
```

## ğŸ“Š ä¿®å¾©å‰å¾Œå°æ¯”

### ä¿®å¾©å‰ âŒ
- ç™»å‡ºå¾Œ cookie å¯èƒ½æœªå®Œå…¨åˆªé™¤
- ç€è¦½å™¨ç·©å­˜å°è‡´é é¢ä»å¯è¨ªå•
- ç¼ºä¹è©³ç´°çš„èª¿è©¦ä¿¡æ¯
- å‰ç«¯ç‹€æ…‹æœªæ¸…é™¤

### ä¿®å¾©å¾Œ âœ…
- å¤šé‡ cookie åˆªé™¤æ©Ÿåˆ¶
- å¼·åˆ¶è¨­ç½®éæœŸæ™‚é–“
- æ¸…é™¤å‰ç«¯ç‹€æ…‹
- è©³ç´°çš„èª¿è©¦æ—¥èªŒ
- é‡å®šå‘åˆ°æœå‹™å™¨ç™»å‡ºç«¯é»

---

**é‡è¦**: é€™æ˜¯ä¸€å€‹é—œéµçš„å®‰å…¨ä¿®å¾©ã€‚è«‹ç«‹å³æ¸¬è©¦ä¸¦ç¢ºèªç™»å‡ºåŠŸèƒ½æ­£å¸¸å·¥ä½œï¼ğŸ”’
