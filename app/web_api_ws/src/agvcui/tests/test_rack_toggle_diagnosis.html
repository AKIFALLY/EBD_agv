<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è²¨æ¶åˆ‡æ›æŒ‰éˆ•è¨ºæ–·å·¥å…·</title>
    <link rel="stylesheet" href="/static/css/bulma_1_0_4.min.css" />
    <link rel="stylesheet" href="/static/css/materialdesignicons.min.css" />
    <link rel="stylesheet" href="/static/css/agvcui-bulma-extend.css" />
    <link rel="stylesheet" href="/static/css/mapPage.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        .test-container {
            padding: 2rem;
            max-width: 1400px;
            margin: 0 auto;
        }
        .test-section {
            margin-bottom: 2rem;
            padding: 1rem;
            border: 1px solid #dbdbdb;
            border-radius: 6px;
        }
        .log-output {
            background: #f5f5f5;
            padding: 1rem;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.875rem;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        #map {
            height: 400px;
            width: 100%;
            border: 1px solid #ccc;
            border-radius: 6px;
        }
        .test-controls {
            margin-bottom: 1rem;
        }
        .diagnosis-result {
            padding: 0.5rem;
            margin: 0.25rem 0;
            border-radius: 4px;
        }
        .diagnosis-result.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .diagnosis-result.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .diagnosis-result.warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        .dom-structure {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 1rem;
            font-family: monospace;
            font-size: 0.875rem;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1 class="title">è²¨æ¶åˆ‡æ›æŒ‰éˆ•è¨ºæ–·å·¥å…·</h1>
        
        <div class="test-section">
            <h2 class="subtitle">è¨ºæ–·æ§åˆ¶</h2>
            <div class="test-controls">
                <div class="buttons">
                    <button class="button is-primary" onclick="runFullDiagnosis()">ğŸ” åŸ·è¡Œå®Œæ•´è¨ºæ–·</button>
                    <button class="button is-info" onclick="createRackObject()">â• å‰µå»ºè²¨æ¶ç‰©ä»¶</button>
                    <button class="button is-success" onclick="inspectDOM()">ğŸ” æª¢æŸ¥ DOM çµæ§‹</button>
                    <button class="button is-warning" onclick="checkCSS()">ğŸ¨ æª¢æŸ¥ CSS æ¨£å¼</button>
                    <button class="button is-light" onclick="clearResults()">ğŸ—‘ï¸ æ¸…é™¤çµæœ</button>
                </div>
            </div>
        </div>

        <div class="columns">
            <div class="column is-half">
                <div class="test-section">
                    <h2 class="subtitle">åœ°åœ–æ¸¬è©¦å€åŸŸ</h2>
                    <div id="map"></div>
                </div>
            </div>
            
            <div class="column is-half">
                <div class="test-section">
                    <h2 class="subtitle">è¨ºæ–·çµæœ</h2>
                    <div id="diagnosis-results"></div>
                </div>
            </div>
        </div>

        <div class="test-section">
            <h2 class="subtitle">DOM çµæ§‹æª¢æŸ¥</h2>
            <div class="dom-structure" id="dom-structure"></div>
        </div>

        <div class="test-section">
            <h2 class="subtitle">è©³ç´°æ—¥èªŒ</h2>
            <div class="log-output" id="log-output"></div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script type="module">
        import { RackInfoObject } from '/static/objects/RackInfoObject.js';

        let logOutput = document.getElementById('log-output');
        let diagnosisResults = document.getElementById('diagnosis-results');
        let domStructure = document.getElementById('dom-structure');
        let map;
        let rackObject;

        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            logOutput.textContent += `[${timestamp}] ${message}\n`;
            logOutput.scrollTop = logOutput.scrollHeight;
            console.log(message);
        }

        function addDiagnosisResult(type, title, message) {
            const div = document.createElement('div');
            div.className = `diagnosis-result ${type}`;
            div.innerHTML = `<strong>${title}</strong><br>${message}`;
            diagnosisResults.appendChild(div);
        }

        function clearResults() {
            logOutput.textContent = '';
            diagnosisResults.innerHTML = '';
            domStructure.textContent = '';
        }

        // åˆå§‹åŒ–åœ°åœ–
        function initMap() {
            if (map) return;
            
            map = L.map('map').setView([25.0330, 121.5654], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors'
            }).addTo(map);
            log('âœ… åœ°åœ–åˆå§‹åŒ–å®Œæˆ');
            addDiagnosisResult('success', 'åœ°åœ–åˆå§‹åŒ–', 'åœ°åœ–å·²æˆåŠŸå‰µå»º');
        }

        // å‰µå»ºè²¨æ¶ç‰©ä»¶
        window.createRackObject = function() {
            if (!map) {
                initMap();
            }

            try {
                const latlng = [25.0330, 121.5654];
                rackObject = new RackInfoObject(map, latlng, 'diagnosis-rack', 'è¨ºæ–·è²¨æ¶');
                log('âœ… è²¨æ¶ç‰©ä»¶å‰µå»ºæˆåŠŸ');
                addDiagnosisResult('success', 'è²¨æ¶ç‰©ä»¶å‰µå»º', 'RackInfoObject å¯¦ä¾‹å·²å‰µå»º');
                
                // ç­‰å¾… DOM åˆå§‹åŒ–
                setTimeout(() => {
                    inspectRackObject();
                }, 200);
                
            } catch (error) {
                log('âŒ å‰µå»ºè²¨æ¶ç‰©ä»¶å¤±æ•—: ' + error.message);
                addDiagnosisResult('error', 'è²¨æ¶ç‰©ä»¶å‰µå»ºå¤±æ•—', error.message);
                console.error(error);
            }
        };

        // æª¢æŸ¥è²¨æ¶ç‰©ä»¶
        function inspectRackObject() {
            if (!rackObject) {
                addDiagnosisResult('error', 'è²¨æ¶ç‰©ä»¶æª¢æŸ¥', 'è²¨æ¶ç‰©ä»¶ä¸å­˜åœ¨ï¼Œè«‹å…ˆå‰µå»º');
                return;
            }

            log('ğŸ” æª¢æŸ¥è²¨æ¶ç‰©ä»¶å±¬æ€§:');
            
            // æª¢æŸ¥åŸºæœ¬å±¬æ€§
            const basicChecks = [
                { name: 'ID', value: rackObject.id, expected: 'string' },
                { name: 'rackId', value: rackObject.rackId, expected: 'string' },
                { name: 'isMiniMode', value: rackObject.isMiniMode, expected: 'boolean' },
                { name: 'el (æ ¹å…ƒç´ )', value: !!rackObject.el, expected: true },
                { name: 'marker', value: !!rackObject.marker, expected: true }
            ];

            basicChecks.forEach(check => {
                const passed = typeof check.value === check.expected || check.value === check.expected;
                log(`  ${passed ? 'âœ…' : 'âŒ'} ${check.name}: ${check.value}`);
                addDiagnosisResult(
                    passed ? 'success' : 'error',
                    `åŸºæœ¬å±¬æ€§: ${check.name}`,
                    `å€¼: ${check.value} (${passed ? 'æ­£å¸¸' : 'ç•°å¸¸'})`
                );
            });

            // æª¢æŸ¥ DOM å…ƒç´ 
            const domChecks = [
                { name: 'minDom', element: rackObject.minDom },
                { name: 'maxDom', element: rackObject.maxDom },
                { name: 'toggleBtnMin', element: rackObject.toggleBtnMin },
                { name: 'toggleBtnMax', element: rackObject.toggleBtnMax }
            ];

            domChecks.forEach(check => {
                const exists = !!check.element;
                log(`  ${exists ? 'âœ…' : 'âŒ'} ${check.name}: ${exists ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'}`);
                addDiagnosisResult(
                    exists ? 'success' : 'error',
                    `DOM å…ƒç´ : ${check.name}`,
                    exists ? 'å…ƒç´ å·²æ‰¾åˆ°' : 'å…ƒç´ æœªæ‰¾åˆ°'
                );
            });
        }

        // æª¢æŸ¥ DOM çµæ§‹
        window.inspectDOM = function() {
            if (!rackObject || !rackObject.el) {
                addDiagnosisResult('error', 'DOM æª¢æŸ¥', 'è²¨æ¶ç‰©ä»¶æˆ–æ ¹å…ƒç´ ä¸å­˜åœ¨');
                return;
            }

            log('ğŸ” æª¢æŸ¥ DOM çµæ§‹:');
            
            // é¡¯ç¤ºå®Œæ•´çš„ DOM çµæ§‹
            const domHTML = rackObject.el.outerHTML;
            domStructure.textContent = formatHTML(domHTML);
            
            // æª¢æŸ¥åˆ‡æ›æŒ‰éˆ•
            const toggleButtons = rackObject.el.querySelectorAll('.rack-toggle-btn');
            log(`æ‰¾åˆ° ${toggleButtons.length} å€‹åˆ‡æ›æŒ‰éˆ•`);
            addDiagnosisResult(
                toggleButtons.length > 0 ? 'success' : 'error',
                'DOM çµæ§‹æª¢æŸ¥',
                `æ‰¾åˆ° ${toggleButtons.length} å€‹ .rack-toggle-btn å…ƒç´ `
            );

            toggleButtons.forEach((btn, index) => {
                const styles = getComputedStyle(btn);
                log(`æŒ‰éˆ• ${index + 1}:`);
                log(`  display: ${styles.display}`);
                log(`  visibility: ${styles.visibility}`);
                log(`  opacity: ${styles.opacity}`);
                log(`  position: ${styles.position}`);
                log(`  top: ${styles.top}`);
                log(`  right: ${styles.right}`);
                log(`  z-index: ${styles.zIndex}`);
                log(`  background: ${styles.background}`);
                
                addDiagnosisResult(
                    styles.display !== 'none' ? 'success' : 'warning',
                    `æŒ‰éˆ• ${index + 1} æ¨£å¼`,
                    `display: ${styles.display}, visibility: ${styles.visibility}`
                );
            });
        };

        // æª¢æŸ¥ CSS æ¨£å¼
        window.checkCSS = function() {
            log('ğŸ¨ æª¢æŸ¥ CSS æ¨£å¼è¼‰å…¥:');
            
            // æª¢æŸ¥æ¨£å¼è¡¨æ˜¯å¦è¼‰å…¥
            const stylesheets = Array.from(document.styleSheets);
            const mapPageCSS = stylesheets.find(sheet => 
                sheet.href && sheet.href.includes('mapPage.css')
            );
            
            if (mapPageCSS) {
                addDiagnosisResult('success', 'CSS è¼‰å…¥', 'mapPage.css å·²è¼‰å…¥');
                log('âœ… mapPage.css å·²è¼‰å…¥');
            } else {
                addDiagnosisResult('error', 'CSS è¼‰å…¥', 'mapPage.css æœªæ‰¾åˆ°');
                log('âŒ mapPage.css æœªæ‰¾åˆ°');
            }

            // æª¢æŸ¥é—œéµ CSS è¦å‰‡
            const testElement = document.createElement('div');
            testElement.className = 'rack-toggle-btn';
            testElement.style.position = 'absolute';
            testElement.style.top = '-1000px';
            document.body.appendChild(testElement);
            
            const styles = getComputedStyle(testElement);
            const cssChecks = [
                { property: 'display', expected: 'flex', actual: styles.display },
                { property: 'position', expected: 'absolute', actual: styles.position },
                { property: 'width', expected: '20px', actual: styles.width },
                { property: 'height', expected: '20px', actual: styles.height },
                { property: 'border-radius', expected: '50%', actual: styles.borderRadius }
            ];
            
            cssChecks.forEach(check => {
                const passed = check.actual === check.expected;
                log(`  ${passed ? 'âœ…' : 'âŒ'} ${check.property}: ${check.actual} (æœŸæœ›: ${check.expected})`);
                addDiagnosisResult(
                    passed ? 'success' : 'warning',
                    `CSS å±¬æ€§: ${check.property}`,
                    `å¯¦éš›: ${check.actual}, æœŸæœ›: ${check.expected}`
                );
            });
            
            document.body.removeChild(testElement);
        };

        // åŸ·è¡Œå®Œæ•´è¨ºæ–·
        window.runFullDiagnosis = function() {
            clearResults();
            log('ğŸš€ é–‹å§‹åŸ·è¡Œå®Œæ•´è¨ºæ–·...');
            
            // æ­¥é©Ÿ 1: åˆå§‹åŒ–åœ°åœ–
            initMap();
            
            // æ­¥é©Ÿ 2: æª¢æŸ¥ CSS
            setTimeout(() => {
                checkCSS();
                
                // æ­¥é©Ÿ 3: å‰µå»ºè²¨æ¶ç‰©ä»¶
                setTimeout(() => {
                    createRackObject();
                    
                    // æ­¥é©Ÿ 4: æª¢æŸ¥ DOM
                    setTimeout(() => {
                        inspectDOM();
                        log('âœ… å®Œæ•´è¨ºæ–·å®Œæˆ');
                        addDiagnosisResult('success', 'è¨ºæ–·å®Œæˆ', 'æ‰€æœ‰æª¢æŸ¥é …ç›®å·²åŸ·è¡Œå®Œç•¢');
                    }, 300);
                }, 100);
            }, 100);
        };

        // æ ¼å¼åŒ– HTML
        function formatHTML(html) {
            return html
                .replace(/></g, '>\n<')
                .replace(/^\s+|\s+$/g, '')
                .split('\n')
                .map((line, index) => `${(index + 1).toString().padStart(3, ' ')}: ${line}`)
                .join('\n');
        }

        // å…¨åŸŸå‡½æ•¸
        window.log = log;
        window.clearResults = clearResults;

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            log('ğŸ“„ è¨ºæ–·å·¥å…·è¼‰å…¥å®Œæˆ');
            addDiagnosisResult('success', 'åˆå§‹åŒ–', 'è¨ºæ–·å·¥å…·å·²æº–å‚™å°±ç·’');
        });
    </script>
</body>
</html>
