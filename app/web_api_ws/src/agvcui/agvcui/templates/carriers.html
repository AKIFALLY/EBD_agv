{% extends "base.html" %}
{% block title %}載具管理{% endblock %}

{% block content %}
<section class="section">
    <div class="container">
        <div class="level">
            <div class="level-left">
                <div class="level-item">
                    <h1 class="title">
                        <span class="icon">
                            <i class="mdi mdi-package-variant"></i>
                        </span>
                        載具管理
                        {% if filtered_rack_id %}
                        <span class="tag is-primary is-medium">
                            <span class="icon">
                                <i class="mdi mdi-filter"></i>
                            </span>
                            貨架 {{ filtered_rack_id }}
                        </span>
                        {% endif %}
                    </h1>
                </div>
            </div>
            <div class="level-right">
                <div class="level-item">
                    <div class="field is-grouped">
                        {% if filtered_rack_id %}
                        <div class="control">
                            <a class="button is-light" href="/carriers">
                                <span class="icon">
                                    <i class="mdi mdi-filter-remove"></i>
                                </span>
                                <span>清除篩選</span>
                            </a>
                        </div>
                        {% endif %}
                        <div class="control">
                            <div class="select">
                                <select id="view-mode">
                                    <option value="grouped">分組檢視</option>
                                    <option value="list">列表檢視</option>
                                </select>
                            </div>
                        </div>
                        {% if current_user and current_user.role in ['operator', 'admin'] %}
                        <div class="control">
                            <a class="button is-primary" href="/carriers/create">
                                <span class="icon">
                                    <i class="mdi mdi-plus"></i>
                                </span>
                                <span>新增載具</span>
                            </a>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- 分組檢視 -->
        <div id="grouped-view">
            <!-- 房間內載具 -->
            {% if grouped_carriers.room_groups %}
            {% for room_group in grouped_carriers.room_groups %}
            <div class="box mb-5">
                <h2 class="subtitle is-4 is-clickable" data-toggle-section="room-{{ room_group.room_number }}">
                    <span class="icon has-text-info">
                        <i class="mdi mdi-home"></i>
                    </span>
                    {{ room_group.room_name }}
                    {% set total_carriers = namespace(count=0) %}
                    {% for equipment in room_group.equipment %}
                    {% for port in equipment.ports %}
                    {% set total_carriers.count = total_carriers.count + port.carriers|length %}
                    {% endfor %}
                    {% endfor %}
                    <span class="tag is-info">{{ total_carriers.count }} 個載具</span>
                    <span class="icon is-pulled-right toggle-icon" id="room-{{ room_group.room_number }}-icon">
                        <i class="mdi mdi-chevron-down"></i>
                    </span>
                </h2>
                <div class="collapsible-content" id="room-{{ room_group.room_number }}-content">
                    <!-- 房間內的設備 -->
                    {% for equipment in room_group.equipment %}
                    <div class="box mb-4">
                        <h3 class="subtitle is-5 is-clickable" data-toggle-section="eqp-{{ equipment.eqp_id }}">
                            <span class="icon has-text-warning">
                                <i class="mdi mdi-cog"></i>
                            </span>
                            {{ equipment.eqp_name }}
                            <span class="tag is-warning">Location {{ equipment.location_id }}</span>
                            {% set eqp_carriers = namespace(count=0) %}
                            {% for port in equipment.ports %}
                            {% set eqp_carriers.count = eqp_carriers.count + port.carriers|length %}
                            {% endfor %}
                            <span class="tag is-primary">{{ eqp_carriers.count }} 個載具</span>
                            <span class="icon is-pulled-right toggle-icon" id="eqp-{{ equipment.eqp_id }}-icon">
                                <i class="mdi mdi-chevron-down"></i>
                            </span>
                        </h3>

                        <div class="collapsible-content" id="eqp-{{ equipment.eqp_id }}-content">
                            <!-- 設備端口 -->
                            <div class="table-container">
                                <table class="table is-fullwidth is-narrow is-hoverable">
                                    <thead>
                                        <tr>
                                            <th>端口</th>
                                            <th>載具</th>
                                            <th>狀態</th>
                                            {% if current_user and current_user.role in ['operator', 'admin'] %}
                                            <th>操作</th>
                                            {% endif %}
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for port in equipment.ports %}
                                        {% if port.carriers %}
                                        {% for carrier in port.carriers %}
                                        <tr>
                                            <td>
                                                <span class="tag is-warning">{{ port.port_name }}</span>
                                            </td>
                                            <td>
                                                <strong>載具 #{{ carrier.id }}</strong>
                                            </td>
                                            <td>
                                                <span class="tag {{ get_status_color(carrier.status_id) }}">
                                                    {{ get_status_name(carrier.status_id) }}
                                                </span>
                                            </td>
                                            {% if current_user and current_user.role in ['operator', 'admin'] %}
                                            <td>
                                                <div class="buttons are-small">
                                                    <a class="button is-info is-small"
                                                        href="/carriers/{{ carrier.id }}/edit">
                                                        <span class="icon"><i class="mdi mdi-pencil"></i></span>
                                                    </a>
                                                    {% if current_user.role == 'admin' %}
                                                    <button class="button is-danger is-small"
                                                        data-delete-action="carriers" data-delete-id="{{ carrier.id }}"
                                                        data-delete-name="{{ carrier.id }}">
                                                        <span class="icon"><i class="mdi mdi-delete"></i></span>
                                                    </button>
                                                    {% endif %}
                                                </div>
                                            </td>
                                            {% endif %}
                                        </tr>
                                        {% endfor %}
                                        {% else %}
                                        <tr>
                                            <td>
                                                <span class="tag is-light">{{ port.port_name }}</span>
                                            </td>
                                            <td
                                                colspan="{% if current_user and current_user.role in ['operator', 'admin'] %}3{% else %}2{% endif %}">
                                                <span class="has-text-grey">無載具</span>
                                            </td>
                                        </tr>
                                        {% endif %}
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
            {% endif %}

            <!-- 在貨架上的載具 -->
            {% if grouped_carriers.rack_groups %}
            <div class="box mb-5">
                <h2 class="subtitle is-4 is-clickable" data-toggle-section="rack-carriers">
                    <span class="icon has-text-primary">
                        <i class="mdi mdi-view-grid"></i>
                    </span>
                    貨架上載具
                    {% set total_rack_carriers = namespace(count=0) %}
                    {% for rack_group in grouped_carriers.rack_groups %}
                    {% set total_rack_carriers.count = total_rack_carriers.count + rack_group.carriers|length %}
                    {% endfor %}
                    <span class="tag is-primary">{{ total_rack_carriers.count }} 個載具</span>
                    <span class="icon is-pulled-right toggle-icon" id="rack-carriers-icon">
                        <i class="mdi mdi-chevron-down"></i>
                    </span>
                </h2>

                <div class="collapsible-content" id="rack-carriers-content">
                    <!-- 按貨架分組顯示 -->
                    {% for rack_group in grouped_carriers.rack_groups %}
                    <div class="box mb-4">
                        <h3 class="subtitle is-5 is-clickable" data-toggle-section="rack-{{ rack_group.rack_id }}">
                            <span class="icon has-text-primary">
                                <i class="mdi mdi-view-grid"></i>
                            </span>
                            {{ rack_group.rack_name or '貨架 ' + rack_group.rack_id|string }}
                            <span class="tag is-primary">{{ rack_group.carriers|length }} 個載具</span>
                            <span class="icon is-pulled-right toggle-icon" id="rack-{{ rack_group.rack_id }}-icon">
                                <i class="mdi mdi-chevron-down"></i>
                            </span>
                        </h3>

                        <div class="collapsible-content" id="rack-{{ rack_group.rack_id }}-content">
                            <!-- 貨架格位視覺化 -->
                            <div class="rack-grid mb-4">
                                <div class="columns">
                                    <div class="column">

                                        <div class="rack-side" data-side="A">
                                            {% if rack_group.product_size == 'L' %}
                                            <!-- L產品: 2行x4列 = 8格 -->
                                            <div class="columns is-multiline is-mobile">
                                                {% for i in range(1, 9) %}
                                                {% set carrier_in_slot = namespace(value=None) %}
                                                {% for carrier, rack_name in rack_group.carriers %}
                                                {% if carrier.rack_index == i %}
                                                {% set carrier_in_slot.value = carrier %}
                                                {% endif %}
                                                {% endfor %}
                                                {# 判斷邊角按鈕 #}
                                                {% set extra_class = "" %}
                                                {% if i == 1 %}
                                                {% set extra_class = "rounded-left-top" %}
                                                {% elif i == 4 %}
                                                {% set extra_class = "rounded-right-top" %}
                                                {% elif i == 5 %}
                                                {% set extra_class = "rounded-left-bottom" %}
                                                {% elif i == 8 %}
                                                {% set extra_class = "rounded-right-bottom" %}
                                                {% endif %}
                                                <div class="column is-one-quarter matrix-space" data-size="L">
                                                    <button
                                                        class="button is-fullwidth rack-slot {{ 'occupied' if carrier_in_slot.value else 'empty' }} {{ extra_class }}"
                                                        data-slot="{{ i }}" data-rack-id="{{ rack_group.rack_id }}" {%
                                                        if carrier_in_slot.value
                                                        %}data-carrier-id="{{ carrier_in_slot.value.id }}" {% endif %}
                                                        title="格位 {{ i }}{{ ' - 載具 #' + carrier_in_slot.value.id|string if carrier_in_slot.value }}"
                                                        {% if not (current_user and current_user.role in
                                                        ['operator', 'admin' ]) %}disabled{% endif %}>
                                                        {{ i }}
                                                    </button>
                                                </div>
                                                {% endfor %}
                                            </div>
                                            {% else %}
                                            <!-- S產品: 4行x4列 = 16格 -->
                                            <div class="columns is-multiline is-mobile">
                                                {% for i in range(1, 17) %}
                                                {% set carrier_in_slot = namespace(value=None) %}
                                                {% for carrier, rack_name in rack_group.carriers %}
                                                {% if carrier.rack_index == i %}
                                                {% set carrier_in_slot.value = carrier %}
                                                {% endif %}
                                                {% endfor %}
                                                {# 判斷邊角按鈕 #}
                                                {% set extra_class = "" %}
                                                {% if i == 1 %}
                                                {% set extra_class = "rounded-left-top" %}
                                                {% elif i == 4 %}
                                                {% set extra_class = "rounded-right-top" %}
                                                {% elif i == 13 %}
                                                {% set extra_class = "rounded-left-bottom" %}
                                                {% elif i == 16 %}
                                                {% set extra_class = "rounded-right-bottom" %}
                                                {% endif %}
                                                <div class="column is-one-quarter matrix-space" data-size="S">
                                                    <button
                                                        class="button is-fullwidth rack-slot {{ 'occupied' if carrier_in_slot.value else 'empty' }} {{ extra_class }}"
                                                        data-slot="{{ i }}" data-rack-id="{{ rack_group.rack_id }}" {%
                                                        if carrier_in_slot.value
                                                        %}data-carrier-id="{{ carrier_in_slot.value.id }}" {% endif %}
                                                        title="格位 {{ i }}{{ ' - 載具 #' + carrier_in_slot.value.id|string if carrier_in_slot.value }}"
                                                        {% if not (current_user and current_user.role in
                                                        ['operator', 'admin' ]) %}disabled{% endif %}>
                                                        {{ i }}
                                                    </button>
                                                </div>
                                                {% endfor %}
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="column">

                                        <div class="rack-side" data-side="B">
                                            {% if rack_group.product_size == 'L' %}
                                            <!-- L產品: 2行x4列 = 8格 (格位9-16) -->
                                            <div class="columns is-multiline is-mobile">
                                                {% for i in range(9, 17) %}
                                                {% set carrier_in_slot = namespace(value=None) %}
                                                {% for carrier, rack_name in rack_group.carriers %}
                                                {% if carrier.rack_index == i %}
                                                {% set carrier_in_slot.value = carrier %}
                                                {% endif %}
                                                {% endfor %}
                                                {# 判斷邊角按鈕 #}
                                                {% set extra_class = "" %}
                                                {% if i == 9 %}
                                                {% set extra_class = "rounded-left-top" %}
                                                {% elif i == 12 %}
                                                {% set extra_class = "rounded-right-top" %}
                                                {% elif i == 13 %}
                                                {% set extra_class = "rounded-left-bottom" %}
                                                {% elif i == 16 %}
                                                {% set extra_class = "rounded-right-bottom" %}
                                                {% endif %}
                                                <div class="column is-one-quarter matrix-space" data-size="L">
                                                    <button
                                                        class="button is-fullwidth rack-slot {{ 'occupied' if carrier_in_slot.value else 'empty' }} {{ extra_class }}"
                                                        data-slot="{{ i }}" data-rack-id="{{ rack_group.rack_id }}" {%
                                                        if carrier_in_slot.value
                                                        %}data-carrier-id="{{ carrier_in_slot.value.id }}" {% endif %}
                                                        title="格位 {{ i }}{{ ' - 載具 #' + carrier_in_slot.value.id|string if carrier_in_slot.value }}"
                                                        {% if not (current_user and current_user.role in
                                                        ['operator', 'admin' ]) %}disabled{% endif %}>
                                                        {{ i }}
                                                    </button>
                                                </div>
                                                {% endfor %}
                                            </div>
                                            {% else %}
                                            <!-- S產品: 4行x4列 = 16格 (格位17-32) -->
                                            <div class="columns is-multiline is-mobile">
                                                {% for i in range(17, 33) %}
                                                {% set carrier_in_slot = namespace(value=None) %}
                                                {% for carrier, rack_name in rack_group.carriers %}
                                                {% if carrier.rack_index == i %}
                                                {% set carrier_in_slot.value = carrier %}
                                                {% endif %}
                                                {% endfor %}
                                                {# 判斷邊角按鈕 #}
                                                {% set extra_class = "" %}
                                                {% if i == 17 %}
                                                {% set extra_class = "rounded-left-top" %}
                                                {% elif i == 20 %}
                                                {% set extra_class = "rounded-right-top" %}
                                                {% elif i == 29 %}
                                                {% set extra_class = "rounded-left-bottom" %}
                                                {% elif i == 32 %}
                                                {% set extra_class = "rounded-right-bottom" %}
                                                {% endif %}
                                                <div class="column is-one-quarter matrix-space" data-size="S">
                                                    <button
                                                        class="button is-fullwidth rack-slot {{ 'occupied' if carrier_in_slot.value else 'empty' }} {{ extra_class }}"
                                                        data-slot="{{ i }}" data-rack-id="{{ rack_group.rack_id }}" {%
                                                        if carrier_in_slot.value
                                                        %}data-carrier-id="{{ carrier_in_slot.value.id }}" {% endif %}
                                                        title="格位 {{ i }}{{ ' - 載具 #' + carrier_in_slot.value.id|string if carrier_in_slot.value }}"
                                                        {% if not (current_user and current_user.role in
                                                        ['operator', 'admin' ]) %}disabled{% endif %}>
                                                        {{ i }}
                                                    </button>
                                                </div>
                                                {% endfor %}
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 載具詳細列表 -->
                            <div class="table-container">
                                <table class="table is-fullwidth is-narrow is-hoverable">
                                    <thead>
                                        <tr>
                                            <th>載具 ID</th>
                                            <th>格位</th>
                                            <th>狀態</th>
                                            {% if current_user and current_user.role in ['operator', 'admin'] %}
                                            <th>操作</th>
                                            {% endif %}
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for carrier, rack_name in rack_group.carriers %}
                                        <tr>
                                            <td><strong>#{{ carrier.id }}</strong></td>
                                            <td>
                                                <span class="tag is-info">{{ carrier.rack_index or '-' }}</span>
                                            </td>
                                            <td>
                                                <span class="tag {{ get_status_color(carrier.status_id) }}">
                                                    {{ get_status_name(carrier.status_id) }}
                                                </span>
                                            </td>
                                            {% if current_user and current_user.role in ['operator', 'admin'] %}
                                            <td>
                                                <div class="buttons are-small">
                                                    <a class="button is-info is-small"
                                                        href="/carriers/{{ carrier.id }}/edit">
                                                        <span class="icon"><i class="mdi mdi-pencil"></i></span>
                                                    </a>
                                                    {% if current_user.role == 'admin' %}
                                                    <button class="button is-danger is-small"
                                                        data-delete-action="carriers" data-delete-id="{{ carrier.id }}"
                                                        data-delete-name="{{ carrier.id }}">
                                                        <span class="icon"><i class="mdi mdi-delete"></i></span>
                                                    </button>
                                                    {% endif %}
                                                </div>
                                            </td>
                                            {% endif %}
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}



            <!-- 未分配的載具 -->
            {% if grouped_carriers.unassigned_carriers %}
            <div class="box mb-5">
                <h2 class="subtitle is-4">
                    <span class="icon has-text-grey">
                        <i class="mdi mdi-help-circle"></i>
                    </span>
                    未分配載具 ({{ grouped_carriers.unassigned_carriers|length }})
                </h2>
                <div class="columns is-multiline">
                    {% for carrier in grouped_carriers.unassigned_carriers %}
                    <div class="column is-one-quarter">
                        <div class="card">
                            <div class="card-content">
                                <div class="media">
                                    <div class="media-left">
                                        <span class="icon is-large has-text-grey">
                                            <i class="mdi mdi-package-variant mdi-36px"></i>
                                        </span>
                                    </div>
                                    <div class="media-content">
                                        <p class="title is-6">載具 #{{ carrier.id }}</p>
                                        <p class="subtitle is-7">未分配位置</p>
                                    </div>
                                </div>
                                <div class="content">
                                    <div class="field is-grouped is-grouped-multiline">
                                        <div class="control">
                                            <div class="tags has-addons">
                                                <span class="tag">狀態</span>
                                                <span class="tag {{ get_status_color(carrier.status_id) }}">
                                                    {{ get_status_name(carrier.status_id) }}
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                    {% if current_user and current_user.role in ['operator', 'admin'] %}
                                    <div class="field is-grouped">
                                        <div class="control">
                                            <a class="button is-small is-info" href="/carriers/{{ carrier.id }}/edit">
                                                <span class="icon"><i class="mdi mdi-pencil"></i></span>
                                                <span>編輯</span>
                                            </a>
                                        </div>
                                        {% if current_user.role == 'admin' %}
                                        <div class="control">
                                            <button class="button is-small is-danger" data-delete-action="carriers"
                                                data-delete-id="{{ carrier.id }}" data-delete-name="{{ carrier.id }}">
                                                <span class="icon"><i class="mdi mdi-delete"></i></span>
                                                <span>刪除</span>
                                            </button>
                                        </div>
                                        {% endif %}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>

        <!-- 列表檢視 -->
        <div id="list-view" style="display: none;">
            <div class="box">
                <table class="table is-fullwidth is-hoverable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>位置</th>
                            <th>格位/端口</th>
                            <th>狀態</th>
                            {% if current_user and current_user.role in ['operator', 'admin'] %}
                            <th>操作</th>
                            {% endif %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for carrier in all_carriers %}
                        <tr>
                            <td><strong>{{ carrier.id }}</strong></td>
                            <td>
                                {% if carrier.room_id %}
                                <span class="tag is-info">
                                    <span class="icon"><i class="mdi mdi-home"></i></span>
                                    房間 {{ carrier.room_id }}
                                </span>
                                {% elif carrier.rack_id %}
                                <span class="tag is-primary">
                                    <span class="icon"><i class="mdi mdi-view-grid"></i></span>
                                    貨架 {{ carrier.rack_id }}
                                </span>
                                {% elif carrier.port_id %}
                                <span class="tag is-warning">
                                    <span class="icon"><i class="mdi mdi-power-plug"></i></span>
                                    端口 {{ carrier.port_id }}
                                </span>
                                {% else %}
                                <span class="tag is-light">未分配</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if carrier.rack_index %}
                                <span class="tag is-success">格位 {{ carrier.rack_index }}</span>
                                {% elif carrier.port_id %}
                                <span class="tag is-warning">端口 {{ carrier.port_id }}</span>
                                {% else %}
                                <span class="tag is-light">-</span>
                                {% endif %}
                            </td>
                            <td>
                                <span class="tag {{ get_status_color(carrier.status_id) }}">
                                    {{ get_status_name(carrier.status_id) }}
                                </span>
                            </td>
                            {% if current_user and current_user.role in ['operator', 'admin'] %}
                            <td>
                                <div class="buttons are-small">
                                    <a class="button is-info is-small" href="/carriers/{{ carrier.id }}/edit">
                                        <span class="icon">
                                            <i class="mdi mdi-pencil"></i>
                                        </span>
                                        <span>編輯</span>
                                    </a>
                                    {% if current_user.role == 'admin' %}
                                    <button class="button is-danger is-small" data-delete-action="carriers"
                                        data-delete-id="{{ carrier.id }}" data-delete-name="{{ carrier.id }}">
                                        <span class="icon">
                                            <i class="mdi mdi-delete"></i>
                                        </span>
                                        <span>刪除</span>
                                    </button>
                                    {% endif %}
                                </div>
                            </td>
                            {% endif %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <div class="notification">
            <p class="has-text-grey">最後查詢時間: {{ latest_query }}</p>
            <div class="has-text-grey is-size-7">
                總計 {{ total_count }} 個載具
            </div>
        </div>

    </div>
</section>

<!-- 載具頁面樣式 -->
<link href="/static/css/carriersPage.css" rel="stylesheet" />

<!-- 載具頁面 JavaScript -->
<script type="module">
    import { carriersPage } from '/static/js/carriersPage.js';

    document.addEventListener('DOMContentLoaded', () => {
        carriersPage.setup();
    });
</script>

<!-- 刪除確認模態框 -->
{% include "delete_modal.html" %}
{% endblock %}