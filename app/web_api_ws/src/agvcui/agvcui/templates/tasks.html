{% extends "base.html" %}
{% block title %}ä»»å‹™ç®¡ç†{% endblock %}

{% block extra_head %}
<link href="/static/css/tasksPage.css" rel="stylesheet" />
{% endblock %}

{% block content %}
<section class="section">
    <div class="container">
        <div class="level">
            <div class="level-left">
                <div class="level-item">
                    <h1 class="title">
                        <span class="icon">
                            <i class="mdi mdi-format-list-checks"></i>
                        </span>
                        ä»»å‹™ç®¡ç†
                    </h1>
                </div>
            </div>
            <div class="level-right">
                <div class="level-item">
                    {% if current_user and current_user.role in ['operator', 'admin'] %}
                    <a class="button is-primary" href="/tasks/create">
                        <span class="icon">
                            <i class="mdi mdi-plus"></i>
                        </span>
                        <span>æ–°å¢ä»»å‹™</span>
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- AGV éæ¿¾æç¤º -->
        {% if agv_id %}
        <div class="notification is-info is-light">
            <button class="delete" onclick="window.location.href='/tasks'"></button>
            <span class="icon">
                <i class="mdi mdi-filter"></i>
            </span>
            <span>æ­£åœ¨é¡¯ç¤º AGV ID {{ agv_id }} çš„ä»»å‹™</span>
            <a href="/tasks" class="button is-small is-info ml-2">
                <span class="icon">
                    <i class="mdi mdi-close"></i>
                </span>
                <span>æ¸…é™¤éæ¿¾</span>
            </a>
        </div>
        {% endif %}

        <!-- åˆ‡æ›è¦–åœ–æŒ‰éˆ• -->
        <div class="field is-grouped mb-4">
            <div class="control">
                <div class="buttons has-addons">
                    <button class="button is-primary" id="listViewBtn">
                        <span class="icon">
                            <i class="mdi mdi-format-list-bulleted"></i>
                        </span>
                        <span>åˆ—è¡¨è¦–åœ–</span>
                    </button>
                    <button class="button" id="hierarchyViewBtn">
                        <span class="icon">
                            <i class="mdi mdi-file-tree"></i>
                        </span>
                        <span>éšå±¤è¦–åœ–</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- åˆ—è¡¨è¦–åœ– -->
        <div class="box" id="listView">
            <table class="table is-fullwidth is-hoverable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>ä»»å‹™åç¨±</th>
                        <th>çˆ¶ä»»å‹™</th>
                        <th>ä»»å‹™ä»£ç¢¼</th>
                        <th>AGV</th>
                        <th>å·¥ä½œ ID</th>
                        <th>æˆ¿é–“</th>
                        <th>åƒæ•¸</th>
                        <th>ç‹€æ…‹</th>
                        <th>å‰µå»ºæ™‚é–“</th>
                        <th>æ›´æ–°æ™‚é–“</th>
                        {% if current_user and current_user.role in ['operator', 'admin'] %}
                        <th>æ“ä½œ</th>
                        {% endif %}
                    </tr>
                </thead>
                <tbody>
                    {% for task in tasks %}
                    <tr title="{{ task.description or 'ç„¡æè¿°' }}" data-task-id="{{ task.id }}" id="task-row-{{ task.id }}"
                        {% if task.parent_task_id %}data-parent-id="{{ task.parent_task_id }}" {% endif %}>
                        <td><strong>{{ task.id }}</strong></td>
                        <td>
                            <div class="has-text-weight-medium">{{ task.name }}</div>
                            {% if task.description %}
                            <div class="has-text-grey is-size-7 mt-1">{{ task.description[:50] }}{% if
                                task.description|length > 50 %}...{% endif %}</div>
                            {% endif %}
                        </td>
                        <td>
                            {% if task.parent_task_id %}
                            <span class="tag is-info is-light">
                                <span class="icon">
                                    <i class="mdi mdi-arrow-up"></i>
                                </span>
                                <span>{{ task.parent_task_id }}</span>
                            </span>
                            {% else %}
                            <span class="tag is-light">
                                <span class="icon">
                                    <i class="mdi mdi-minus"></i>
                                </span>
                                <span>æ ¹ä»»å‹™</span>
                            </span>
                            {% endif %}
                        </td>
                        <td>
                            {% if task.mission_code %}
                            <span class="tag is-info" id="task-mission-{{ task.id }}">
                                <span class="icon">
                                    <i class="mdi mdi-barcode"></i>
                                </span>
                                <span>{{ task.mission_code }}</span>
                            </span>
                            {% else %}
                            <span class="tag is-light" id="task-mission-{{ task.id }}">æœªè¨­å®š</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if task.agv and task.agv.name %}
                            <span class="tag is-success" id="task-agv-{{ task.id }}" data-agv-id="{{ task.agv.id }}">
                                <span class="icon">
                                    <i class="mdi mdi-robot"></i>
                                </span>
                                <span>[{{ task.agv.id }}]{{ task.agv.name }}</span>
                            </span>
                            {% elif task.agv_id %}
                            <span class="tag is-warning" id="task-agv-{{ task.id }}" data-agv-id="{{ task.agv_id }}">AGV {{ task.agv_id }}</span>
                            {% else %}
                            <span class="tag is-light" id="task-agv-{{ task.id }}">æœªåˆ†é…</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if task.work_id %}
                            <span class="tag is-link">{{ task.work_id }}</span>
                            {% else %}
                            <span class="tag is-light">æœªè¨­ç½®</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if task.room_id %}
                            <span class="tag is-primary">{{ task.room_id }}</span>
                            {% else %}
                            <span class="tag is-light">æœªè¨­ç½®</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if task.parameters %}
                            <div class="dropdown is-hoverable task-parameters-dropdown">
                                <div class="dropdown-trigger">
                                    <button class="button is-small is-info" aria-haspopup="true"
                                        aria-controls="dropdown-menu-{{ task.id }}">
                                        <span class="icon">
                                            <i class="mdi mdi-code-json"></i>
                                        </span>
                                        <span>JSON</span>
                                        <span class="icon is-small">
                                            <i class="mdi mdi-chevron-down"></i>
                                        </span>
                                    </button>
                                </div>
                                <div class="dropdown-menu" id="dropdown-menu-{{ task.id }}" role="menu">
                                    <div class="dropdown-content">
                                        <div class="dropdown-item">
                                            <pre>{{ task.parameters | tojson_chinese(indent=2) }}</pre>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% else %}
                            <span class="tag is-light">ç„¡åƒæ•¸</span>
                            {% endif %}
                        </td>
                        <td class="task-status-cell" data-status-id="{{ task.status_id or 0 }}">
                            {% if task.status_id == 0 %}
                            <span class="tag is-light" id="task-status-{{ task.id }}">è«‹æ±‚ä¸­</span>
                            {% elif task.status_id == 1 %}
                            <span class="tag is-warning" id="task-status-{{ task.id }}">å¾…è™•ç†</span>
                            {% elif task.status_id == 2 %}
                            <span class="tag is-primary" id="task-status-{{ task.id }}">å¾…åŸ·è¡Œ</span>
                            {% elif task.status_id == 3 %}
                            <span class="tag is-info" id="task-status-{{ task.id }}">åŸ·è¡Œä¸­</span>
                            {% elif task.status_id == 4 %}
                            <span class="tag is-success" id="task-status-{{ task.id }}">å·²å®Œæˆ</span>
                            {% elif task.status_id == 5 %}
                            <span class="tag is-warning" id="task-status-{{ task.id }}">å–æ¶ˆä¸­</span>
                            {% elif task.status_id == 51 %}
                            <span class="tag is-warning" id="task-status-{{ task.id }}">WCS-å–æ¶ˆä¸­</span>
                            {% elif task.status_id == 52 %}
                            <span class="tag is-warning" id="task-status-{{ task.id }}">RCS-å–æ¶ˆä¸­</span>
                            {% elif task.status_id == 53 %}
                            <span class="tag is-warning" id="task-status-{{ task.id }}">AGV-å–æ¶ˆä¸­</span>
                            {% elif task.status_id == 54 %}
                            <span class="tag is-danger" id="task-status-{{ task.id }}">å·²å–æ¶ˆ</span>
                            {% elif task.status_id == 6 %}
                            <span class="tag is-danger" id="task-status-{{ task.id }}">éŒ¯èª¤</span>
                            {% else %}
                            <span class="tag is-light" id="task-status-{{ task.id }}">æœªçŸ¥({{ task.status_id }})</span>
                            {% endif %}
                        </td>
                        <td><span class="has-text-grey is-family-monospace is-size-7">{{
                                task.created_at.strftime('%Y-%m-%d %H:%M') if task.created_at
                                else '-' }}</span></td>
                        <td><span class="has-text-grey is-family-monospace is-size-7"
                                id="task-timestamp-{{ task.id }}">{{
                                task.updated_at.strftime('%Y-%m-%d %H:%M') if task.updated_at
                                else '-' }}</span></td>
                        {% if current_user and current_user.role in ['operator', 'admin'] %}
                        <td>
                            <div class="buttons are-small">
                                <a class="button is-info is-small" href="/tasks/{{ task.id }}/edit">
                                    <span class="icon">
                                        <i class="mdi mdi-pencil"></i>
                                    </span>
                                    <span>ç·¨è¼¯</span>
                                </a>
                                {% if current_user.role == 'admin' %}
                                <button class="button is-danger is-small" data-delete-action="tasks"
                                    data-delete-id="{{ task.id }}" data-delete-name="{{ task.name }}">
                                    <span class="icon">
                                        <i class="mdi mdi-delete"></i>
                                    </span>
                                    <span>åˆªé™¤</span>
                                </button>
                                {% endif %}
                            </div>
                        </td>
                        {% endif %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- éšå±¤è¦–åœ– -->
        <div class="box is-hidden" id="hierarchyView">
            <div class="content">
                <h4 class="title is-5">
                    <span class="icon">
                        <i class="mdi mdi-file-tree"></i>
                    </span>
                    ä»»å‹™éšå±¤çµæ§‹
                </h4>
                <div id="taskHierarchy">
                    <!-- éšå±¤çµæ§‹å°‡é€šé JavaScript å‹•æ…‹ç”Ÿæˆ -->
                </div>
            </div>
        </div>

        <div class="notification">
            <p class="has-text-grey">æœ€å¾ŒæŸ¥è©¢æ™‚é–“: {{ latest_query }}</p>
        </div>
        <!-- åˆ†é ä¿¡æ¯ -->
        {% set start_item = (current_page - 1) * 20 + 1 %}
        {% set end_item = [current_page * 20, total_count]|min %}
        <div class="has-text-grey is-size-7">
            é¡¯ç¤ºç¬¬ {{ start_item }} - {{ end_item }} é …ï¼Œå…± {{ total_count }} é … (ç¬¬ {{ current_page }} / {{ total_pages }}
            é )
        </div>

        <!-- åˆ†é  -->
        {% if total_pages > 1 %}
        <nav class="pagination is-centered mt-4" role="navigation" aria-label="pagination">
            {% if current_page > 1 %}
            <a class="pagination-previous"
                href="/tasks?page={{ current_page - 1 }}{% if agv_id %}&agv_id={{ agv_id }}{% endif %}">ä¸Šä¸€é </a>
            {% endif %}
            {% if current_page < total_pages %} <a class="pagination-next"
                href="/tasks?page={{ current_page + 1 }}{% if agv_id %}&agv_id={{ agv_id }}{% endif %}">
                ä¸‹ä¸€é </a>
                {% endif %}

                <ul class="pagination-list">
                    {% set start_page = [1, current_page - 2]|max %}
                    {% set end_page = [total_pages, current_page + 2]|min %}

                    <!-- ç¬¬ä¸€é  -->
                    {% if start_page > 1 %}
                    <li><a class="pagination-link"
                            href="/tasks?page=1{% if agv_id %}&agv_id={{ agv_id }}{% endif %}">1</a></li>
                    {% if start_page > 2 %}
                    <li><span class="pagination-ellipsis">&hellip;</span></li>
                    {% endif %}
                    {% endif %}

                    <!-- ç•¶å‰é é™„è¿‘çš„é ç¢¼ -->
                    {% for page_num in range(start_page, end_page + 1) %}
                    {% if page_num == current_page %}
                    <li><a class="pagination-link is-current">{{ page_num }}</a></li>
                    {% else %}
                    <li><a class="pagination-link"
                            href="/tasks?page={{ page_num }}{% if agv_id %}&agv_id={{ agv_id }}{% endif %}">{{ page_num
                            }}</a></li>
                    {% endif %}
                    {% endfor %}

                    <!-- æœ€å¾Œä¸€é  -->
                    {% if end_page < total_pages %} {% if end_page < total_pages - 1 %} <li><span
                            class="pagination-ellipsis">&hellip;</span></li>
                        {% endif %}
                        <li><a class="pagination-link"
                                href="/tasks?page={{ total_pages }}{% if agv_id %}&agv_id={{ agv_id }}{% endif %}">{{
                                total_pages }}</a></li>
                        {% endif %}
                </ul>
        </nav>
        {% endif %}
    </div>
</section>

<!-- åˆªé™¤ç¢ºèªæ¨¡æ…‹æ¡† -->
{% if current_user and current_user.role == 'admin' %}
<div class="modal" id="deleteModal">
    <div class="modal-background"></div>
    <div class="modal-card">
        <header class="modal-card-head">
            <p class="modal-card-title">ç¢ºèªåˆªé™¤</p>
            <button class="delete" aria-label="close"></button>
        </header>
        <section class="modal-card-body">
            <p>æ‚¨ç¢ºå®šè¦åˆªé™¤ä»»å‹™ <strong id="deleteTaskName"></strong> å—ï¼Ÿ</p>
            <p class="has-text-danger">æ­¤æ“ä½œç„¡æ³•æ’¤éŠ·ï¼</p>
        </section>
        <footer class="modal-card-foot">
            <form id="deleteForm" method="post">
                <button class="button is-danger" type="submit">ç¢ºèªåˆªé™¤</button>
                <button class="button" type="button">å–æ¶ˆ</button>
            </form>
        </footer>
    </div>
</div>

<!-- JavaScript åŠŸèƒ½å·²ç§»è‡³ /static/js/deleteModal.js -->
{% endif %}

<!-- Tasks é é¢ JavaScript æ¨¡çµ„å·²ç§»è‡³ index.js çµ±ä¸€ç®¡ç† -->

<!-- Tasks é é¢è¦–åœ–åˆ‡æ›é‚è¼¯å·²ç§»è‡³ tasksPage.js çµ±ä¸€ç®¡ç† -->
<script>
    // ä¿ç•™åŸæœ‰çš„è¦–åœ–åˆ‡æ›é‚è¼¯ï¼Œä½†ç§»é™¤ DOMContentLoaded åŒ…è£
    (function () {
        const listViewBtn = document.getElementById('listViewBtn');
        const hierarchyViewBtn = document.getElementById('hierarchyViewBtn');
        const listView = document.getElementById('listView');
        const hierarchyView = document.getElementById('hierarchyView');
        const taskHierarchy = document.getElementById('taskHierarchy');

        // è¦–åœ–åˆ‡æ›
        listViewBtn.addEventListener('click', function () {
            listViewBtn.classList.add('is-primary');
            hierarchyViewBtn.classList.remove('is-primary');
            listView.classList.remove('is-hidden');
            hierarchyView.classList.add('is-hidden');
        });

        hierarchyViewBtn.addEventListener('click', function () {
            hierarchyViewBtn.classList.add('is-primary');
            listViewBtn.classList.remove('is-primary');
            hierarchyView.classList.remove('is-hidden');
            listView.classList.add('is-hidden');
            generateHierarchy();
        });

        // ğŸ”§ é‡æ§‹ï¼šå¢é‡æ›´æ–°çš„éšå±¤çµæ§‹ç®¡ç†
        let hierarchyNodeMap = new Map(); // ä»»å‹™ ID -> DOM ç¯€é»æ˜ å°„
        let lastTasksData = new Map(); // ä¸Šæ¬¡çš„ä»»å‹™è³‡æ–™å¿«ç…§
        let updateInProgress = false; // é˜²æ­¢é‡è¤‡æ›´æ–°

        // ğŸ”§ æ–°å¢ï¼šå¢é‡æ›´æ–°éšå±¤çµæ§‹ï¼ˆä¸»è¦å…¥å£å‡½æ•¸ï¼‰
        function generateHierarchy() {
            if (updateInProgress) {
                console.debug('éšå±¤è¦–åœ–æ›´æ–°é€²è¡Œä¸­ï¼Œè·³éé‡è¤‡èª¿ç”¨');
                return;
            }

            updateInProgress = true;
            const startTime = performance.now();

            try {
                // å¾ tasksStore ç²å–æœ€æ–°è³‡æ–™ï¼ˆå¦‚æœå¯ç”¨ï¼‰
                let tasksData;
                if (window.tasksStore && typeof window.tasksStore.getState === 'function') {
                    const storeState = window.tasksStore.getState();
                    tasksData = storeState.tasks || [];
                } else {
                    // é™ç´šï¼šå¾ DOM æå–è³‡æ–™
                    tasksData = extractTasksFromDOM();
                }

                // æª¢æ¸¬è®Šæ›´ä¸¦åŸ·è¡Œå¢é‡æ›´æ–°
                const changes = detectHierarchyChanges(tasksData);

                if (changes.hasChanges) {
                    console.debug('æª¢æ¸¬åˆ°éšå±¤è®Šæ›´:', changes);
                    updateHierarchyIncremental(tasksData, changes);
                } else {
                    console.debug('éšå±¤ç„¡è®Šæ›´ï¼Œè·³éæ›´æ–°');
                }

                // æ›´æ–°å¿«ç…§
                lastTasksData = new Map(tasksData.map(task => [task.id, { ...task }]));

            } catch (error) {
                console.error('éšå±¤è¦–åœ–æ›´æ–°å¤±æ•—:', error);
                // é™ç´šåˆ°å®Œå…¨é‡å»º
                rebuildHierarchyComplete();
            } finally {
                updateInProgress = false;
                const endTime = performance.now();
                console.debug(`éšå±¤è¦–åœ–æ›´æ–°è€—æ™‚: ${(endTime - startTime).toFixed(2)}ms`);
            }
        }

        // ğŸ”§ æ–°å¢ï¼šå¾ DOM æå–ä»»å‹™è³‡æ–™ï¼ˆé™ç´šæ–¹æ¡ˆï¼‰
        function extractTasksFromDOM() {
            const tasks = [];
            const rows = document.querySelectorAll('tbody tr[data-task-id]');

            rows.forEach(row => {
                const taskId = parseInt(row.dataset.taskId);
                const parentId = row.dataset.parentId ? parseInt(row.dataset.parentId) : null;
                const name = row.querySelector('td:nth-child(2) .has-text-weight-medium')?.textContent || 'æœªçŸ¥ä»»å‹™';

                // ğŸ”§ æ”¹å–„ï¼šå¾ç‹€æ…‹å–®å…ƒæ ¼æå–ç‹€æ…‹ ID
                const statusCell = row.querySelector('.task-status-cell');
                const statusId = statusCell ? parseInt(statusCell.dataset.statusId) || 0 : 0;

                // æå– AGV è³‡è¨Š
                const agvCell = row.querySelector('td:nth-child(5)');
                const agvTag = agvCell?.querySelector('.tag');
                const agv = agvTag ? agvTag.textContent.trim() : 'æœªåˆ†é…';

                tasks.push({
                    id: taskId,
                    parent_task_id: parentId,
                    name: name,
                    status_id: statusId,
                    agv: agv
                });
            });

            return tasks;
        }

        // ğŸ”§ æ–°å¢ï¼šæª¢æ¸¬éšå±¤è®Šæ›´
        function detectHierarchyChanges(newTasksData) {
            const changes = {
                hasChanges: false,
                added: [],
                removed: [],
                modified: [],
                statusChanged: []
            };

            const newTasksMap = new Map(newTasksData.map(task => [task.id, task]));
            const oldTasksMap = lastTasksData;

            // æª¢æ¸¬æ–°å¢å’Œä¿®æ”¹çš„ä»»å‹™
            for (const [taskId, newTask] of newTasksMap) {
                const oldTask = oldTasksMap.get(taskId);

                if (!oldTask) {
                    // æ–°å¢çš„ä»»å‹™
                    changes.added.push(newTask);
                    changes.hasChanges = true;
                } else {
                    // æª¢æŸ¥æ˜¯å¦æœ‰ä¿®æ”¹
                    const isModified = (
                        oldTask.name !== newTask.name ||
                        oldTask.parent_task_id !== newTask.parent_task_id ||
                        oldTask.agv !== newTask.agv
                    );

                    const isStatusChanged = oldTask.status_id !== newTask.status_id;

                    if (isModified) {
                        changes.modified.push({ old: oldTask, new: newTask });
                        changes.hasChanges = true;
                    }

                    if (isStatusChanged) {
                        changes.statusChanged.push({ old: oldTask, new: newTask });
                        changes.hasChanges = true;
                    }
                }
            }

            // æª¢æ¸¬åˆªé™¤çš„ä»»å‹™
            for (const [taskId, oldTask] of oldTasksMap) {
                if (!newTasksMap.has(taskId)) {
                    changes.removed.push(oldTask);
                    changes.hasChanges = true;
                }
            }

            return changes;
        }

        // ğŸ”§ æ–°å¢ï¼šå¢é‡æ›´æ–°éšå±¤çµæ§‹
        function updateHierarchyIncremental(tasksData, changes) {
            // è™•ç†åˆªé™¤çš„ä»»å‹™
            changes.removed.forEach(task => {
                const node = hierarchyNodeMap.get(task.id);
                if (node && node.parentNode) {
                    // æ·»åŠ æ·¡å‡ºå‹•ç•«
                    node.style.transition = 'opacity 0.3s ease';
                    node.style.opacity = '0';
                    setTimeout(() => {
                        if (node.parentNode) {
                            node.parentNode.removeChild(node);
                        }
                        hierarchyNodeMap.delete(task.id);
                    }, 300);
                }
            });

            // è™•ç†ç‹€æ…‹è®Šæ›´
            changes.statusChanged.forEach(({ old: oldTask, new: newTask }) => {
                updateTaskNodeStatus(newTask);
            });

            // è™•ç†ä¿®æ”¹çš„ä»»å‹™
            changes.modified.forEach(({ old: oldTask, new: newTask }) => {
                updateTaskNodeContent(newTask);
            });

            // è™•ç†æ–°å¢çš„ä»»å‹™
            if (changes.added.length > 0) {
                // é‡å»ºéšå±¤çµæ§‹ä»¥æ­£ç¢ºè™•ç†çˆ¶å­é—œä¿‚
                rebuildHierarchyStructure(tasksData);
            }
        }

        // ğŸ”§ æ–°å¢ï¼šæ›´æ–°ä»»å‹™ç¯€é»ç‹€æ…‹
        function updateTaskNodeStatus(task) {
            const node = hierarchyNodeMap.get(task.id);
            if (!node) return;

            const statusElement = node.querySelector('.task-status-tag');
            if (statusElement) {
                // ğŸ”§ æ•´åˆï¼šä½¿ç”¨çµ±ä¸€çš„ç‹€æ…‹æ›´æ–°é‚è¼¯
                if (window.updateTaskStatusCellOptimized) {
                    // å‰µå»ºè‡¨æ™‚ç‹€æ…‹å–®å…ƒæ ¼çµæ§‹
                    const tempCell = document.createElement('div');
                    tempCell.className = 'task-status-cell';
                    tempCell.dataset.statusId = task.status_id;
                    tempCell.appendChild(statusElement);

                    // ä½¿ç”¨çµ±ä¸€çš„ç‹€æ…‹æ›´æ–°å‡½æ•¸
                    window.updateTaskStatusCellOptimized(tempCell, task.status_id, task._statusCorrected);
                } else {
                    // é™ç´šæ–¹æ¡ˆï¼šç›´æ¥æ›´æ–°
                    updateStatusElementDirect(statusElement, task.status_id);
                }
            }
        }

        // ğŸ”§ æ–°å¢ï¼šç›´æ¥æ›´æ–°ç‹€æ…‹å…ƒç´ ï¼ˆé™ç´šæ–¹æ¡ˆï¼‰
        function updateStatusElementDirect(statusElement, statusId) {
            // ä½¿ç”¨ taskStatus.js çš„ç‹€æ…‹è³‡è¨Šï¼ˆå¦‚æœå¯ç”¨ï¼‰
            if (window.getTaskStatusInfo) {
                const statusInfo = window.getTaskStatusInfo(statusId);
                statusElement.className = `tag ${statusInfo.color} task-status-tag`;
                statusElement.textContent = statusInfo.name;
            } else {
                // æœ€çµ‚é™ç´šæ–¹æ¡ˆ
                const statusText = getStatusTextById(statusId);
                const statusColor = getStatusColorById(statusId);
                statusElement.className = `tag ${statusColor} task-status-tag`;
                statusElement.textContent = statusText;
            }
        }

        // ğŸ”§ é‡æ§‹ï¼šå‰µå»ºä»»å‹™ç¯€é»ï¼ˆæ”¯æ´ç²¾ç¢ºé¸æ“‡å™¨å’Œç‹€æ…‹ä¸€è‡´æ€§ï¼‰
        function createTaskNode(task, level) {
            const div = document.createElement('div');
            div.className = 'task-node';
            div.dataset.taskId = task.id; // ğŸ”§ æ–°å¢ï¼šç²¾ç¢ºé¸æ“‡å™¨æ”¯æ´
            div.dataset.level = level;
            div.style.marginLeft = (level * 20) + 'px';
            div.style.marginBottom = '10px';
            div.style.padding = '10px';
            div.style.border = '1px solid #dbdbdb';
            div.style.borderRadius = '4px';
            div.style.backgroundColor = level === 0 ? '#f5f5f5' : '#ffffff';

            // ğŸ”§ æ”¹å–„ï¼šä½¿ç”¨çµ±ä¸€çš„ç‹€æ…‹è³‡è¨Š
            const statusInfo = window.getTaskStatusInfo ?
                window.getTaskStatusInfo(task.status_id) :
                { name: getStatusTextById(task.status_id), color: getStatusColorById(task.status_id) };

            // ğŸ”§ æ–°å¢ï¼šç‹€æ…‹é©—è­‰
            if (window.validateTaskStatus) {
                const validation = window.validateTaskStatus(task.status_id);
                if (!validation.isValid) {
                    console.warn(`éšå±¤è¦–åœ–ä»»å‹™ ${task.id} ç‹€æ…‹ç„¡æ•ˆ:`, validation.error);
                    task.status_id = validation.fallbackStatus;
                    task._statusCorrected = true;
                }
            }

            div.innerHTML = `
            <div class="level is-mobile">
                <div class="level-left">
                    <div class="level-item">
                        <span class="icon has-text-${level === 0 ? 'primary' : 'info'}">
                            <i class="mdi mdi-${level === 0 ? 'folder' : 'file'}"></i>
                        </span>
                        <strong>ID: ${task.id}</strong>
                        <span class="ml-2 task-name">${task.name}</span>
                    </div>
                </div>
                <div class="level-right">
                    <div class="level-item">
                        <div class="task-status-cell" data-status-id="${task.status_id}">
                            <span class="tag ${statusInfo.color} task-status-tag">${task._statusCorrected ? statusInfo.name + '(ä¿®æ­£)' : statusInfo.name}</span>
                        </div>
                        ${task.agv && task.agv !== 'æœªåˆ†é…' ? `<span class="tag is-light ml-1 task-agv-tag">${task.agv}</span>` : ''}
                        ${task.children && task.children.length > 0 ? `<span class="tag is-info is-light ml-1">${task.children.length} å­ä»»å‹™</span>` : ''}
                    </div>
                </div>
            </div>
        `;

            // ğŸ”§ æ–°å¢ï¼šè¨»å†Šç¯€é»æ˜ å°„
            hierarchyNodeMap.set(task.id, div);

            // ğŸ”§ æ–°å¢ï¼šæ·»åŠ æ·¡å…¥å‹•ç•«
            div.style.opacity = '0';
            div.style.transition = 'opacity 0.3s ease';
            setTimeout(() => {
                div.style.opacity = '1';
            }, 50);

            // æ·»åŠ å­ä»»å‹™
            if (task.children && task.children.length > 0) {
                task.children.forEach(child => {
                    div.appendChild(createTaskNode(child, level + 1));
                });
            }

            return div;
        }

        // ğŸ”§ æ–°å¢ï¼šæ›´æ–°ä»»å‹™ç¯€é»å…§å®¹
        function updateTaskNodeContent(task) {
            const node = hierarchyNodeMap.get(task.id);
            if (!node) return;

            // æ›´æ–°ä»»å‹™åç¨±
            const nameElement = node.querySelector('.task-name');
            if (nameElement && nameElement.textContent !== task.name) {
                nameElement.textContent = task.name;
                nameElement.classList.add('field-updated');
                setTimeout(() => nameElement.classList.remove('field-updated'), 1000);
            }

            // æ›´æ–° AGV è³‡è¨Š
            const agvElement = node.querySelector('.task-agv-tag');
            const shouldShowAgv = task.agv && task.agv !== 'æœªåˆ†é…';

            if (shouldShowAgv && !agvElement) {
                // æ–°å¢ AGV æ¨™ç±¤
                const levelRight = node.querySelector('.level-right .level-item');
                const agvTag = document.createElement('span');
                agvTag.className = 'tag is-light ml-1 task-agv-tag';
                agvTag.textContent = task.agv;
                levelRight.appendChild(agvTag);
            } else if (!shouldShowAgv && agvElement) {
                // ç§»é™¤ AGV æ¨™ç±¤
                agvElement.remove();
            } else if (agvElement && agvElement.textContent !== task.agv) {
                // æ›´æ–° AGV æ¨™ç±¤
                agvElement.textContent = task.agv;
                agvElement.classList.add('field-updated');
                setTimeout(() => agvElement.classList.remove('field-updated'), 1000);
            }
        }

        // ğŸ”§ æ–°å¢ï¼šå®Œå…¨é‡å»ºéšå±¤çµæ§‹ï¼ˆé™ç´šæ–¹æ¡ˆï¼‰
        function rebuildHierarchyComplete() {
            console.debug('åŸ·è¡Œéšå±¤è¦–åœ–å®Œå…¨é‡å»º');

            // æ¸…ç†èˆŠçš„æ˜ å°„
            hierarchyNodeMap.clear();

            // ç²å–ä»»å‹™è³‡æ–™
            const tasksData = extractTasksFromDOM();

            // å»ºç«‹éšå±¤çµæ§‹
            const { taskMap, rootTasks } = buildHierarchyStructure(tasksData);

            // æ¸…ç©ºå®¹å™¨ä¸¦é‡å»º
            taskHierarchy.innerHTML = '';
            if (rootTasks.length === 0) {
                taskHierarchy.innerHTML = '<p class="has-text-grey">æ²’æœ‰æ‰¾åˆ°ä»»å‹™è³‡æ–™</p>';
                return;
            }

            // ä½¿ç”¨ DocumentFragment é€²è¡Œæ‰¹é‡æ“ä½œ
            const fragment = document.createDocumentFragment();
            rootTasks.forEach(task => {
                fragment.appendChild(createTaskNode(task, 0));
            });

            taskHierarchy.appendChild(fragment);
        }

        // ğŸ”§ æ–°å¢ï¼šé‡å»ºéšå±¤çµæ§‹ï¼ˆä¿æŒç¾æœ‰ç¯€é»ï¼‰
        function rebuildHierarchyStructure(tasksData) {
            const { taskMap, rootTasks } = buildHierarchyStructure(tasksData);

            // é‡æ–°æ’åˆ—ç¾æœ‰ç¯€é»
            const fragment = document.createDocumentFragment();
            const processedNodes = new Set();

            rootTasks.forEach(task => {
                const existingNode = hierarchyNodeMap.get(task.id);
                if (existingNode) {
                    fragment.appendChild(existingNode);
                    processedNodes.add(task.id);
                    // è™•ç†å­ä»»å‹™
                    appendChildNodes(task, existingNode, processedNodes);
                } else {
                    // å‰µå»ºæ–°ç¯€é»
                    fragment.appendChild(createTaskNode(task, 0));
                }
            });

            taskHierarchy.innerHTML = '';
            taskHierarchy.appendChild(fragment);
        }

        // ğŸ”§ æ–°å¢ï¼šå»ºç«‹éšå±¤çµæ§‹è³‡æ–™
        function buildHierarchyStructure(tasksData) {
            const taskMap = {};
            const rootTasks = [];

            // å»ºç«‹ä»»å‹™æ˜ å°„
            tasksData.forEach(task => {
                taskMap[task.id] = {
                    ...task,
                    children: []
                };
            });

            // å»ºç«‹çˆ¶å­é—œä¿‚
            tasksData.forEach(task => {
                const taskNode = taskMap[task.id];
                if (task.parent_task_id && taskMap[task.parent_task_id]) {
                    taskMap[task.parent_task_id].children.push(taskNode);
                } else {
                    rootTasks.push(taskNode);
                }
            });

            return { taskMap, rootTasks };
        }

        // ğŸ”§ æ–°å¢ï¼šéè¿´è™•ç†å­ç¯€é»
        function appendChildNodes(parentTask, parentNode, processedNodes) {
            if (!parentTask.children) return;

            parentTask.children.forEach(childTask => {
                const existingChildNode = hierarchyNodeMap.get(childTask.id);
                if (existingChildNode && !processedNodes.has(childTask.id)) {
                    parentNode.appendChild(existingChildNode);
                    processedNodes.add(childTask.id);
                    appendChildNodes(childTask, existingChildNode, processedNodes);
                }
            });
        }

        // ğŸ”§ æ”¹å–„ï¼šæ ¹æ“šç‹€æ…‹ ID å–å¾—ç‹€æ…‹æ–‡å­—
        function getStatusTextById(statusId) {
            const statusMap = {
                0: 'è«‹æ±‚ä¸­',
                1: 'å¾…è™•ç†',
                2: 'å¾…åŸ·è¡Œ',
                3: 'åŸ·è¡Œä¸­',
                4: 'å·²å®Œæˆ',
                5: 'å–æ¶ˆä¸­',
                6: 'éŒ¯èª¤',
                51: 'WCS-å–æ¶ˆä¸­',
                52: 'RCS-å–æ¶ˆä¸­',
                53: 'AGV-å–æ¶ˆä¸­',
                54: 'å·²å–æ¶ˆ'
            };
            return statusMap[statusId] || `æœªçŸ¥(${statusId})`;
        }

        // ğŸ”§ æ”¹å–„ï¼šæ ¹æ“šç‹€æ…‹ ID å–å¾—ç‹€æ…‹é¡è‰²
        function getStatusColorById(statusId) {
            const colorMap = {
                0: 'is-info',     // è«‹æ±‚ä¸­
                1: 'is-warning',  // å¾…è™•ç†
                2: 'is-warning',  // å¾…åŸ·è¡Œ
                3: 'is-info',     // åŸ·è¡Œä¸­
                4: 'is-success',  // å·²å®Œæˆ
                5: 'is-warning',  // å–æ¶ˆä¸­
                6: 'is-danger',   // éŒ¯èª¤
                51: 'is-warning', // WCS-å–æ¶ˆä¸­
                52: 'is-warning', // RCS-å–æ¶ˆä¸­
                53: 'is-warning', // AGV-å–æ¶ˆä¸­
                54: 'is-danger'   // å·²å–æ¶ˆ
            };
            return colorMap[statusId] || 'is-light';
        }

        // ğŸ”§ æ£„ç”¨ï¼šä¿ç•™å‘å¾Œç›¸å®¹æ€§
        function getStatusColor(status) {
            console.warn('getStatusColor() å·²æ£„ç”¨ï¼Œè«‹ä½¿ç”¨ getStatusColorById()');
            switch (status) {
                case 'å·²å®Œæˆ': return 'is-success';
                case 'é€²è¡Œä¸­': case 'åŸ·è¡Œä¸­': return 'is-info';
                case 'å¾…è™•ç†': case 'å¾…åŸ·è¡Œ': return 'is-warning';
                case 'å·²å–æ¶ˆ': return 'is-danger';
                default: return 'is-light';
            }
        }

        // ğŸ”§ æ–°å¢ï¼šé˜²æŠ–æ©Ÿåˆ¶
        let hierarchyUpdateTimeout = null;

        function generateHierarchyDebounced(delay = 50) {
            if (hierarchyUpdateTimeout) {
                clearTimeout(hierarchyUpdateTimeout);
            }

            hierarchyUpdateTimeout = setTimeout(() => {
                generateHierarchy();
                hierarchyUpdateTimeout = null;
            }, delay);
        }

        // ğŸ”§ æ–°å¢ï¼šæ•ˆèƒ½ç›£æ§
        const hierarchyPerformanceMetrics = {
            updateCount: 0,
            totalUpdateTime: 0,
            averageUpdateTime: 0,
            lastUpdateTime: 0,

            recordUpdate(duration) {
                this.updateCount++;
                this.totalUpdateTime += duration;
                this.averageUpdateTime = this.totalUpdateTime / this.updateCount;
                this.lastUpdateTime = duration;

                // æ•ˆèƒ½è­¦å‘Š
                if (duration > 100) {
                    console.warn(`éšå±¤è¦–åœ–æ›´æ–°è€—æ™‚éé•·: ${duration.toFixed(2)}ms`);
                }

                // å®šæœŸå ±å‘Š
                if (this.updateCount % 10 === 0) {
                    console.debug(`éšå±¤è¦–åœ–æ•ˆèƒ½çµ±è¨ˆ: å¹³å‡ ${this.averageUpdateTime.toFixed(2)}ms, æœ€è¿‘ ${this.lastUpdateTime.toFixed(2)}ms`);
                }
            },

            getMetrics() {
                return {
                    updateCount: this.updateCount,
                    averageUpdateTime: this.averageUpdateTime,
                    lastUpdateTime: this.lastUpdateTime
                };
            }
        };

        // ğŸ”§ æ–°å¢ï¼šé©—è­‰éšå±¤ä¸€è‡´æ€§
        function validateHierarchyConsistency() {
            const startTime = performance.now();
            let issues = [];

            // æª¢æŸ¥ç¯€é»æ˜ å°„ä¸€è‡´æ€§
            hierarchyNodeMap.forEach((node, taskId) => {
                if (!node.parentNode) {
                    issues.push(`ä»»å‹™ ${taskId} çš„ç¯€é»å·²å¾ DOM ä¸­ç§»é™¤ä½†ä»åœ¨æ˜ å°„ä¸­`);
                }

                const nodeTaskId = parseInt(node.dataset.taskId);
                if (nodeTaskId !== taskId) {
                    issues.push(`ä»»å‹™ ${taskId} çš„ç¯€é» data-task-id ä¸ä¸€è‡´: ${nodeTaskId}`);
                }
            });

            // æª¢æŸ¥ DOM ä¸­çš„å­¤ç«‹ç¯€é»
            const domNodes = taskHierarchy.querySelectorAll('.task-node[data-task-id]');
            domNodes.forEach(node => {
                const taskId = parseInt(node.dataset.taskId);
                if (!hierarchyNodeMap.has(taskId)) {
                    issues.push(`DOM ä¸­å­˜åœ¨æœªæ˜ å°„çš„ä»»å‹™ç¯€é»: ${taskId}`);
                }
            });

            const endTime = performance.now();
            console.debug(`éšå±¤ä¸€è‡´æ€§é©—è­‰è€—æ™‚: ${(endTime - startTime).toFixed(2)}ms, ç™¼ç¾ ${issues.length} å€‹å•é¡Œ`);

            if (issues.length > 0) {
                console.warn('éšå±¤ä¸€è‡´æ€§å•é¡Œ:', issues);
                return false;
            }

            return true;
        }

        // ğŸ”§ ä¿®æ­£ï¼šå°‡å‡½æ•¸æš´éœ²åˆ°å…¨åŸŸç¯„åœ
        window.generateHierarchy = generateHierarchy;
        window.generateHierarchyDebounced = generateHierarchyDebounced;
        window.validateHierarchyConsistency = validateHierarchyConsistency;
        window.hierarchyPerformanceMetrics = hierarchyPerformanceMetrics;

    })();
</script>

{% endblock %}