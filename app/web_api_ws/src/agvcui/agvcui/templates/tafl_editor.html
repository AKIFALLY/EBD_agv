{% extends "base.html" %}

{% block title %}TAFL Editor - Task Automation Flow Language{% endblock %}

{% block extra_head %}
    <!-- Font Awesome -->
    <link rel="stylesheet" href="/static/css/font-awesome.all.min.css">
    <!-- CodeMirror for YAML editing -->
    <link rel="stylesheet" href="/static/css/codemirror.min.css">
    <!-- Light themes -->
    <link rel="stylesheet" href="/static/css/codemirror-theme-idea.min.css">
    <link rel="stylesheet" href="/static/css/codemirror-theme-eclipse.min.css">
    <link rel="stylesheet" href="/static/css/codemirror-theme-xq-light.min.css">
    <link rel="stylesheet" href="/static/css/codemirror-theme-neat.min.css">
    <!-- Dark theme (keep for option) -->
    <link rel="stylesheet" href="/static/css/codemirror-theme-material.min.css">
    <link rel="stylesheet" href="/static/css/codemirror-foldgutter.min.css">
    <link rel="stylesheet" href="/static/css/codemirror-lint.min.css">
    <!-- TAFL Editor CSS -->
    <link rel="stylesheet" href="/static/css/tafl-editor.css">
    <link rel="stylesheet" href="/static/css/tafl-panels.css">
{% endblock %}

{% block content %}
<div class="tafl-editor-container">
    <!-- Top Toolbar -->
    <div class="tafl-toolbar">
        <div class="level">
            <div class="level-left">
                <div class="level-item">
                    <h1 class="title is-4">TAFL Editor</h1>
                </div>
                <div class="level-item">
                    <div class="dropdown is-hoverable">
                        <div class="dropdown-trigger">
                            <button class="button" aria-haspopup="true" aria-controls="flows-dropdown">
                                <span class="icon">
                                    <i class="fas fa-stream"></i>
                                </span>
                                <span>Flows</span>
                                <span class="icon is-small">
                                    <i class="fas fa-angle-down" aria-hidden="true"></i>
                                </span>
                            </button>
                        </div>
                        <div class="dropdown-menu" id="flows-dropdown" role="menu">
                            <div class="dropdown-content" id="flows-dropdown-content">
                                <div class="has-text-centered" style="padding: 1rem;">
                                    <span class="icon">
                                        <i class="fas fa-spinner fa-spin"></i>
                                    </span>
                                    <span>Loading flows...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="level-item">
                    <div class="field is-grouped">
                        <p class="control">
                            <button class="button is-primary" id="new-flow-btn" data-tooltip="Create a new TAFL flow">
                                <span class="icon">
                                    <i class="fas fa-plus-circle"></i>
                                </span>
                                <span>New Flow</span>
                            </button>
                        </p>
                        <p class="control">
                            <button class="button" id="save-flow-btn" disabled data-tooltip="Save the current flow">
                                <span class="icon">
                                    <i class="fas fa-save"></i>
                                </span>
                                <span>Save</span>
                            </button>
                        </p>
                    </div>
                </div>
            </div>
            
            <div class="level-right">
                <div class="level-item">
                    <div class="field is-grouped">
                        <p class="control">
                            <button class="button is-success" id="validate-btn" data-tooltip="Validate the flow syntax">
                                <span class="icon">
                                    <i class="fas fa-check-circle"></i>
                                </span>
                                <span>Validate</span>
                            </button>
                        </p>
                        <p class="control">
                            <button class="button is-info" id="test-run-btn" data-tooltip="Test run the flow in simulation mode">
                                <span class="icon">
                                    <i class="fas fa-flask"></i>
                                </span>
                                <span>Test Run</span>
                            </button>
                        </p>
                        <p class="control">
                            <button class="button is-warning" id="execute-btn" data-tooltip="Execute the flow on real system">
                                <span class="icon">
                                    <i class="fas fa-play"></i>
                                </span>
                                <span>Execute</span>
                            </button>
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Editor Content -->
    <div class="columns is-gapless p-0">
        <!-- Left Sidebar: Three Panels -->
        <div class="column is-one-fifth tafl-sidebar">
            <!-- Metadata Panel -->
            <div class="panel mb-4">
                <p class="panel-heading">
                    <span class="icon">
                        <i class="fas fa-info-circle"></i>
                    </span>
                    <span>Metadata</span>
                </p>
                
                <div class="panel-block">
                    <div class="field is-fullwidth">
                        <label class="label is-small">Flow ID (檔名)</label>
                        <input class="input is-small" type="text" id="flow-id" placeholder="example_001">
                    </div>
                </div>
                
                <div class="panel-block">
                    <div class="field is-fullwidth">
                        <label class="label is-small">Flow Name (流程名稱)</label>
                        <input class="input is-small" type="text" id="flow-name" placeholder="Enter flow name">
                    </div>
                </div>
                
                <div class="panel-block">
                    <div class="field is-fullwidth">
                        <label class="label is-small">Version</label>
                        <input class="input is-small" type="text" id="flow-version" placeholder="1.0" value="1.0">
                    </div>
                </div>
                
                <div class="panel-block">
                    <div class="field is-fullwidth">
                        <label class="label is-small">Description</label>
                        <textarea class="textarea is-small" id="flow-description" placeholder="Flow description" rows="2"></textarea>
                    </div>
                </div>
                
                <!-- Enabled checkbox -->
                <div class="panel-block">
                    <div class="field is-fullwidth">
                        <div class="control">
                            <label class="checkbox">
                                <input type="checkbox" id="flow-enabled" checked>
                                <strong>Enabled (啟用)</strong>
                            </label>
                            <p class="help">Enable this flow for execution by TAFL WCS</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- TAFL Verbs Panel -->
            <div class="panel">
                <p class="panel-heading">
                    <span class="icon">
                        <i class="fas fa-toolbox"></i>
                    </span>
                    <span>TAFL Verbs</span>
                </p>
                
                <p class="panel-tabs">
                    <a class="is-active" data-tab="data">Data</a>
                    <a data-tab="control">Control</a>
                    <a data-tab="action">Action</a>
                </p>
                
                <!-- Data Verbs -->
                <div id="data-verbs" class="verb-category">
                    {% for verb_id, verb in tafl_verbs.items() %}
                    {% if verb_id in ['query', 'check', 'set'] %}
                    <div class="panel-block verb-item" data-verb="{{ verb_id }}">
                        <span class="panel-icon has-text-{{ verb.color.replace('is-', '') }}">
                            <i class="{{ verb.icon }}"></i>
                        </span>
                        <div class="verb-info">
                            <div class="verb-name">{{ verb.name }}</div>
                            <div class="verb-desc">{{ verb.description }}</div>
                        </div>
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
                
                <!-- Control Verbs -->
                <div id="control-verbs" class="verb-category" style="display: none;">
                    {% for verb_id, verb in tafl_verbs.items() %}
                    {% if verb_id in ['if', 'for', 'switch'] %}
                    <div class="panel-block verb-item" data-verb="{{ verb_id }}">
                        <span class="panel-icon has-text-{{ verb.color.replace('is-', '') }}">
                            <i class="{{ verb.icon }}"></i>
                        </span>
                        <div class="verb-info">
                            <div class="verb-name">{{ verb.name }}</div>
                            <div class="verb-desc">{{ verb.description }}</div>
                        </div>
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
                
                <!-- Action Verbs -->
                <div id="action-verbs" class="verb-category" style="display: none;">
                    {% for verb_id, verb in tafl_verbs.items() %}
                    {% if verb_id in ['create', 'update', 'stop', 'notify'] %}
                    <div class="panel-block verb-item" data-verb="{{ verb_id }}">
                        <span class="panel-icon has-text-{{ verb.color.replace('is-', '') }}">
                            <i class="{{ verb.icon }}"></i>
                        </span>
                        <div class="verb-info">
                            <div class="verb-name">{{ verb.name }}</div>
                            <div class="verb-desc">{{ verb.description }}</div>
                        </div>
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Center: Flow Canvas with Display Modes -->
        <div class="column tafl-canvas-container">
            <!-- Display Mode Switcher -->
            <div class="tafl-content-modes">
                <button class="mode-button is-active" data-mode="cards">
                    <span class="icon is-small">
                        <i class="fas fa-th-large"></i>
                    </span>
                    <span>Cards</span>
                </button>
                <button class="mode-button" data-mode="yaml">
                    <span class="icon is-small">
                        <i class="fas fa-code"></i>
                    </span>
                    <span>YAML</span>
                </button>
                <button class="mode-button" data-mode="both">
                    <span class="icon is-small">
                        <i class="fas fa-columns"></i>
                    </span>
                    <span>Both</span>
                </button>
                <!-- Toggle Properties Panel -->
                <button class="mode-button toggle-properties" id="toggle-properties-btn" data-tooltip="Toggle Properties Panel">
                    <span class="icon is-small">
                        <i class="fas fa-angle-double-right"></i>
                    </span>
                </button>
            </div>
            
            <!-- Content Wrapper -->
            <div class="tafl-content-wrapper mode-cards">
                <!-- Cards View -->
                <div class="tafl-canvas" id="flow-canvas">
                    <div class="canvas-drop-zone" id="canvas-drop-zone">
                        <div class="drop-zone-content">
                            <span class="icon is-large has-text-grey-light">
                                <i class="fas fa-grip-vertical fa-3x"></i>
                            </span>
                            <p class="has-text-grey">Drag TAFL verbs here to build your flow</p>
                            <p class="has-text-grey-light is-size-7">Or click on a verb from the toolbox</p>
                        </div>
                    </div>
                </div>
                
                <!-- YAML View -->
                <div class="yaml-panel">
                    <div class="yaml-controls">
                        <button class="button is-small is-primary" id="apply-yaml-btn">
                            <span class="icon">
                                <i class="fas fa-check"></i>
                            </span>
                            <span>Apply Changes</span>
                        </button>
                        <button class="button is-small" id="refresh-yaml-btn">
                            <span class="icon">
                                <i class="fas fa-sync"></i>
                            </span>
                            <span>Refresh</span>
                        </button>
                    </div>
                    <div class="field" style="height: calc(100% - 40px);">
                        <div class="control" style="height: 100%;">
                            <textarea id="yaml-editor-main" placeholder="Generated YAML will appear here..."></textarea>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Sidebar: Properties & Code -->
        <div class="column is-one-quarter tafl-properties">
            <div class="tabs is-boxed">
                <ul>
                    <li class="is-active" data-tab="properties">
                        <a data-tooltip="Properties">
                            <span class="icon">
                                <i class="fas fa-cog"></i>
                            </span>
                            <span>Properties</span>
                        </a>
                    </li>
                    <li data-tab="settings">
                        <a data-tooltip="Settings">
                            <span class="icon">
                                <i class="fas fa-sliders-h"></i>
                            </span>
                            <span>Settings</span>
                        </a>
                    </li>
                    <li data-tab="preload">
                        <a data-tooltip="Preload">
                            <span class="icon">
                                <i class="fas fa-database"></i>
                            </span>
                            <span>Preload</span>
                        </a>
                    </li>
                    <li data-tab="rules">
                        <a data-tooltip="Rules">
                            <span class="icon">
                                <i class="fas fa-gavel"></i>
                            </span>
                            <span>Rules</span>
                        </a>
                    </li>
                    <li data-tab="variables">
                        <a data-tooltip="Variables">
                            <span class="icon">
                                <i class="fas fa-code"></i>
                            </span>
                            <span>Variables</span>
                        </a>
                    </li>
                    <li data-tab="results">
                        <a data-tooltip="Validation & Execution Results">
                            <span class="icon">
                                <i class="fas fa-clipboard-check"></i>
                            </span>
                            <span>Results</span>
                        </a>
                    </li>
                </ul>
            </div>
            
            <!-- Properties Panel -->
            <div id="properties-panel" class="properties-content">
                <div class="no-selection">
                    <div class="has-text-centered">
                        <span class="icon is-large has-text-grey-light">
                            <i class="fas fa-mouse-pointer fa-3x"></i>
                        </span>
                        <p class="has-text-grey">Select a card to edit properties</p>
                    </div>
                </div>
            </div>
            
            <!-- Settings Panel (TAFL v1.1) -->
            <div id="settings-panel" class="properties-content" style="display: none;">
                <div class="property-editor">
                    <h4 class="title is-5 mb-4">Execution Settings</h4>
                    <div class="field">
                        <label class="label is-small">Execution Interval (seconds)</label>
                        <div class="control">
                            <input class="input is-small" type="number" id="settings-execution-interval" value="5" min="1">
                            <p class="help">How often this flow should be executed</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Preload Panel (TAFL v1.1) -->
            <div id="preload-panel" class="properties-content" style="display: none;">
                <div class="property-editor">
                    <h4 class="title is-5 mb-4">Data Preloading</h4>
                    <p class="is-size-7 has-text-grey mb-3">Preload data at the beginning of flow execution for better performance.</p>
                    
                    <button class="button is-small is-primary mb-3" id="add-preload-btn">
                        <span class="icon">
                            <i class="fas fa-plus"></i>
                        </span>
                        <span>Add Preload</span>
                    </button>
                    
                    <div class="preload-list" id="preload-list">
                        <!-- Preloaded data items will be shown here -->
                    </div>
                </div>
            </div>
            
            <!-- Rules Panel (TAFL v1.1) -->
            <div id="rules-panel" class="properties-content" style="display: none;">
                <div class="property-editor">
                    <h4 class="title is-5 mb-4">Business Rules</h4>
                    <p class="is-size-7 has-text-grey mb-3">Define global rules and constraints for the flow.</p>
                    
                    <button class="button is-small is-primary mb-3" id="add-rule-btn">
                        <span class="icon">
                            <i class="fas fa-plus"></i>
                        </span>
                        <span>Add Rule</span>
                    </button>
                    
                    <div class="rules-list" id="rules-list">
                        <!-- Rules will be shown here -->
                    </div>
                </div>
            </div>
            
            <!-- Variables Panel -->
            <div id="variables-panel" class="properties-content" style="display: none;">
                <div class="property-editor">
                    <h4 class="title is-5 mb-4">Flow Variables</h4>
                    <p class="is-size-7 has-text-grey mb-3">Define variables to store and manipulate data in the flow.</p>
                    
                    <button class="button is-small is-primary mb-3" id="add-variable-btn">
                        <span class="icon">
                            <i class="fas fa-plus"></i>
                        </span>
                        <span>Add Variable</span>
                    </button>
                    
                    <div id="variables-list" class="variables-list">
                        <!-- Variables will be added here by TAFLPanels -->
                    </div>
                </div>
            </div>
            
            <!-- Results Panel (Validation & Execution) -->
            <div id="results-panel" class="properties-content" style="display: none;">
                <div class="results-container">
                    <!-- Result Type Indicator -->
                    <div class="result-mode mb-3" id="result-mode">
                        <span class="tag is-light">No results yet</span>
                    </div>
                    
                    <!-- Results Summary -->
                    <div class="results-summary" id="results-summary">
                        <div class="has-text-centered">
                            <span class="icon is-large has-text-grey-light">
                                <i class="fas fa-clipboard-check fa-3x"></i>
                            </span>
                            <p class="has-text-grey">Results will appear here</p>
                            <p class="has-text-grey is-size-7 mt-2">
                                <strong>Validate:</strong> Check TAFL syntax and structure<br>
                                <strong>Test Run:</strong> Simulate execution without affecting real systems<br>
                                <strong>Execute:</strong> Run on real system and affect actual resources
                            </p>
                        </div>
                    </div>
                    
                    <!-- Validation Results -->
                    <div class="validation-results mt-4" id="validation-results" style="display: none;">
                        <h5 class="title is-6">
                            <span class="icon is-small">
                                <i class="fas fa-check-circle"></i>
                            </span>
                            <span>Validation Results</span>
                        </h5>
                        <div class="validation-content">
                            <!-- Validation messages will be added here -->
                        </div>
                    </div>
                    
                    <!-- Execution Log -->
                    <div class="execution-log mt-4" id="execution-log" style="display: none;">
                        <h5 class="title is-6">
                            <span class="icon is-small">
                                <i class="fas fa-list-ol"></i>
                            </span>
                            <span>Execution Steps</span>
                        </h5>
                        <div class="execution-log-content">
                            <!-- Log entries will be added here -->
                        </div>
                    </div>
                    
                    <!-- Variable Changes -->
                    <div class="variable-changes mt-4" id="variable-changes" style="display: none;">
                        <h5 class="title is-6">
                            <span class="icon is-small">
                                <i class="fas fa-code"></i>
                            </span>
                            <span>Variable Changes</span>
                        </h5>
                        <div class="variable-changes-content">
                            <!-- Variable updates will be shown here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modals -->
<!-- Save Flow Modal -->
<div class="modal" id="save-flow-modal">
    <div class="modal-background"></div>
    <div class="modal-card">
        <header class="modal-card-head">
            <p class="modal-card-title">Save TAFL Flow</p>
            <button class="delete" aria-label="close"></button>
        </header>
        <section class="modal-card-body">
            <div class="field">
                <label class="label">Flow ID (檔名)</label>
                <div class="control">
                    <input class="input" type="text" id="save-flow-id" placeholder="unique-flow-id">
                </div>
                <p class="help">Unique identifier for the flow (no spaces or special characters)</p>
            </div>
            <div class="field">
                <label class="label">Flow Name (流程名稱)</label>
                <div class="control">
                    <input class="input" type="text" id="save-flow-name" placeholder="Flow Display Name">
                </div>
            </div>
            <div class="field">
                <label class="label">Description</label>
                <div class="control">
                    <textarea class="textarea" id="save-flow-description" placeholder="Describe what this flow does..."></textarea>
                </div>
            </div>
        </section>
        <footer class="modal-card-foot">
            <button class="button is-primary" id="confirm-save-btn">Save Flow</button>
            <button class="button cancel-btn">Cancel</button>
        </footer>
    </div>
</div>

<!-- Scripts -->
<script src="/static/js/lib/codemirror.min.js"></script>
<script src="/static/js/lib/codemirror-mode-yaml.min.js"></script>
<!-- js-yaml for YAML parsing and generation -->
<script src="/static/js/lib/js-yaml.min.js"></script>
<script src="/static/js/lib/codemirror-mode-javascript.min.js"></script>
<script src="/static/js/lib/codemirror-fold-foldcode.min.js"></script>
<script src="/static/js/lib/codemirror-fold-foldgutter.min.js"></script>
<script src="/static/js/lib/codemirror-fold-indent.min.js"></script>
<script src="/static/js/lib/codemirror-fold-brace.min.js"></script>
<script src="/static/js/lib/codemirror-edit-matchbrackets.min.js"></script>
<script src="/static/js/lib/codemirror-edit-closebrackets.min.js"></script>
<script src="/static/js/lib/codemirror-lint.min.js"></script>
<script src="/static/js/lib/jsonlint.min.js"></script>
<script src="/static/js/lib/codemirror-lint-json.min.js"></script>
<!-- Overlay mode addon for TAFL variable highlighting -->
<script src="/static/js/lib/codemirror-mode-overlay.min.js"></script>
<!-- All modules are now imported directly in tafl-editor.js using ES6 modules -->
<script type="module" src="/static/js/tafl-editor.js"></script>
{% endblock %}