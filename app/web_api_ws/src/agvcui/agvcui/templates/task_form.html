{% extends "base.html" %}
{% block title %}{{ form_title }}{% endblock %}

{% block content %}
<section class="section">
    <div class="container">
        <!-- çµ±ä¸€çš„ level ä½ˆå±€ -->
        <div class="level">
            <div class="level-left">
                <div class="level-item">
                    <h1 class="title">
                        <span class="icon">
                            <i class="mdi mdi-clipboard-text"></i>
                        </span>
                        {{ form_title }}
                    </h1>
                </div>
            </div>
            <div class="level-right">
                <div class="level-item">
                    <a class="button is-light" href="/tasks">
                        <span class="icon">
                            <i class="mdi mdi-arrow-left"></i>
                        </span>
                        <span>è¿”å›åˆ—è¡¨</span>
                    </a>
                </div>
            </div>
        </div>

        <!-- è¡¨å–®åŒ…è£åœ¨ box ä¸­ -->
        <div class="box">
            <form method="post" action="{{ form_action }}" accept-charset="UTF-8">
                <div class="columns">
                    <div class="column is-half">
                        <!-- ä»»å‹™åç¨± -->
                        <div class="field">
                            <label class="label">
                                <span class="icon-text">
                                    <span class="icon">
                                        <i class="mdi mdi-format-title"></i>
                                    </span>
                                    <span>ä»»å‹™åç¨± *</span>
                                </span>
                            </label>
                            <div class="control">
                                <input class="input" type="text" name="name" id="task-name" value="{{ task.name if task else '' }}"
                                    placeholder="è«‹è¼¸å…¥ä»»å‹™åç¨±æˆ–é¸æ“‡å·¥ä½œé¡å‹è‡ªå‹•å¡«å…¥" required>
                            </div>
                        </div>

                        <!-- ä»»å‹™æè¿° -->
                        <div class="field">
                            <label class="label">
                                <span class="icon-text">
                                    <span class="icon">
                                        <i class="mdi mdi-text"></i>
                                    </span>
                                    <span>ä»»å‹™æè¿°</span>
                                </span>
                            </label>
                            <div class="control">
                                <textarea class="textarea" name="description" id="task-description"
                                    placeholder="è«‹è¼¸å…¥ä»»å‹™æè¿°æˆ–é¸æ“‡å·¥ä½œé¡å‹è‡ªå‹•å¡«å…¥">{{ task.description if task else '' }}</textarea>
                            </div>
                        </div>

                        <!-- çˆ¶ä»»å‹™ -->
                        <div class="field">
                            <label class="label">
                                <span class="icon-text">
                                    <span class="icon">
                                        <i class="mdi mdi-file-tree"></i>
                                    </span>
                                    <span>çˆ¶ä»»å‹™</span>
                                </span>
                            </label>
                            <div class="control">
                                <div class="select is-fullwidth">
                                    <select name="parent_task_id">
                                        <option value="">ç„¡çˆ¶ä»»å‹™ï¼ˆæ ¹ä»»å‹™ï¼‰</option>
                                        {% for parent_task in available_parent_tasks %}
                                        <option value="{{ parent_task.id }}" {% if task and
                                            task.parent_task_id==parent_task.id %}selected{% endif %}>
                                            ID: {{ parent_task.id }} - {{ parent_task.name }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <p class="help">é¸æ“‡æ­¤ä»»å‹™çš„çˆ¶ä»»å‹™ï¼Œå»ºç«‹ä»»å‹™é–“çš„ä¾è³´é—œä¿‚</p>
                        </div>

                        <!-- ä»»å‹™ä»£ç¢¼ -->
                        <div class="field">
                            <label class="label">
                                <span class="icon-text">
                                    <span class="icon">
                                        <i class="mdi mdi-barcode"></i>
                                    </span>
                                    <span>ä»»å‹™ä»£ç¢¼ (Mission Code)</span>
                                </span>
                            </label>
                            <div class="control">
                                <input class="input" type="text" name="mission_code"
                                    value="{{ task.mission_code if task.mission_code else '' }}"
                                    placeholder="è«‹è¼¸å…¥ Kuka ç³»çµ±çš„ä»»å‹™ä»£ç¢¼">
                            </div>
                            <p class="help">ç”¨æ–¼ Kuka ç³»çµ±å›å ±ç‹€æ…‹æ™‚çš„ä»»å‹™è­˜åˆ¥ç¢¼</p>
                        </div>

                        <!-- å·¥ä½œé¡å‹ -->
                        <div class="field">
                            <label class="label">
                                <span class="icon-text">
                                    <span class="icon">
                                        <i class="mdi mdi-briefcase"></i>
                                    </span>
                                    <span>å·¥ä½œé¡å‹</span>
                                </span>
                            </label>
                            <div class="control">
                                <div class="select is-fullwidth">
                                    <select name="work_id" id="work-type-select">
                                        <option value="">è«‹é¸æ“‡å·¥ä½œé¡å‹</option>
                                        {% for work in works %}
                                        <option value="{{ work.id }}"
                                                data-work-id="{{ work.id }}"
                                                data-work-name="{{ work.name }}"
                                                data-work-description="{{ work.description or '' }}"
                                                data-work-parameters='{{ work.parameters | tojson if work.parameters else "{}" }}'
                                                {% if task and task.work_id==work.id %}selected{% endif %}>
                                            {{ work.name }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <p class="help">é¸æ“‡å·¥ä½œé¡å‹å¾Œæœƒè‡ªå‹•å¡«å…¥ä»»å‹™åç¨±å’Œæè¿°</p>
                        </div>

                        <!-- å·¥ä½œé¡å‹è©³ç´°è³‡è¨Šé¡¯ç¤º -->
                        <div id="work-info-display" class="notification is-info is-light" style="display: none;">
                            Work ID: <span id="display-work-id">-</span>
                        </div>

                        <!-- ä»»å‹™ç‹€æ…‹ -->
                        <div class="field">
                            <label class="label">
                                <span class="icon-text">
                                    <span class="icon">
                                        <i class="mdi mdi-flag"></i>
                                    </span>
                                    <span>ä»»å‹™ç‹€æ…‹</span>
                                </span>
                            </label>
                            <div class="control">
                                <div class="select is-fullwidth">
                                    <select name="status_id">
                                        <option value="">è«‹é¸æ“‡ä»»å‹™ç‹€æ…‹</option>
                                        {% for status in task_statuses %}
                                        <option value="{{ status.id }}" {% if task and task.status_id==status.id
                                            %}selected{% endif %}>
                                            {{ status.name }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="column is-half">
                        <!-- æˆ¿é–“ -->
                        <div class="field">
                            <label class="label">
                                <span class="icon-text">
                                    <span class="icon">
                                        <i class="mdi mdi-home"></i>
                                    </span>
                                    <span>æˆ¿é–“</span>
                                </span>
                            </label>
                            <div class="control">
                                <div class="select is-fullwidth">
                                    <select name="room_id">
                                        <option value="">è«‹é¸æ“‡æˆ¿é–“</option>
                                        {% for room in rooms %}
                                        <option value="{{ room.id }}" {% if task and task.room_id==room.id %}selected{%
                                            endif %}>
                                            {{ room.name }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- ç¯€é» -->
                        <div class="field">
                            <label class="label">
                                <span class="icon-text">
                                    <span class="icon">
                                        <i class="mdi mdi-map-marker"></i>
                                    </span>
                                    <span>ç›®æ¨™ç¯€é»</span>
                                </span>
                            </label>
                            <div class="control">
                                <div class="select is-fullwidth">
                                    <select name="node_id">
                                        <option value="">è«‹é¸æ“‡ç›®æ¨™ç¯€é»</option>
                                        {% for node in nodes %}
                                        <option value="{{ node.id }}" {% if task and task.node_id==node.id %}selected{%
                                            endif %}>
                                            {{ node.name or 'Node ' + node.id|string }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- AGV -->
                        <div class="field">
                            <label class="label">
                                <span class="icon-text">
                                    <span class="icon">
                                        <i class="mdi mdi-robot"></i>
                                    </span>
                                    <span>æŒ‡å®š AGV</span>
                                </span>
                            </label>
                            <div class="control">
                                <div class="select is-fullwidth">
                                    <select name="agv_id">
                                        <option value="">è«‹é¸æ“‡ AGV</option>
                                        {% for agv in agvs %}
                                        <option value="{{ agv.id }}" {% if task and task.agv_id==agv.id %}selected{%
                                            endif %}>
                                            [{{ agv.id }}]{{ agv.name }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- å„ªå…ˆç´š -->
                        <div class="field">
                            <label class="label">
                                <span class="icon-text">
                                    <span class="icon">
                                        <i class="mdi mdi-priority-high"></i>
                                    </span>
                                    <span>å„ªå…ˆç´š</span>
                                </span>
                            </label>
                            <div class="control">
                                <input class="input" type="number" name="priority"
                                    value="{{ task.priority if task else 0 }}" min="0" max="100" placeholder="0-100">
                            </div>
                            <p class="help">æ•¸å€¼è¶Šé«˜å„ªå…ˆç´šè¶Šé«˜</p>
                        </div>

                        <!-- åƒæ•¸ -->
                        <div class="field">
                            <label class="label">
                                <span class="icon-text">
                                    <span class="icon">
                                        <i class="mdi mdi-code-json"></i>
                                    </span>
                                    <span>åƒæ•¸ (JSON)</span>
                                </span>
                            </label>
                            <div class="control">
                                <textarea class="textarea" id="task-parameters" name="parameters" rows="6"
                                    placeholder='{"room_id": 2, "rack_id": 1, "eqp_id": 1}'>{{ task.parameters | tojson_chinese(indent=2) if task and task.parameters else '' }}</textarea>
                            </div>
                            <p class="help">è«‹è¼¸å…¥æœ‰æ•ˆçš„ JSON æ ¼å¼åƒæ•¸ï¼Œä¾‹å¦‚ï¼š{"room_id": 2, "rack_id": 1}</p>
                        </div>
                    </div>
                </div>

                <!-- æ“ä½œæŒ‰éˆ• -->
                <div class="field is-grouped">
                    <div class="control">
                        <button class="button is-primary" type="submit">
                            <span class="icon">
                                <i class="mdi mdi-content-save"></i>
                            </span>
                            <span>ä¿å­˜</span>
                        </button>
                    </div>
                    <div class="control">
                        <a class="button is-light" href="/tasks">
                            <span class="icon">
                                <i class="mdi mdi-cancel"></i>
                            </span>
                            <span>å–æ¶ˆ</span>
                        </a>
                    </div>
                </div>
            </form>
        </div>
    </div>
</section>

<script>
// å·¥ä½œé¡å‹é¸æ“‡è®Šæ›´æ™‚è‡ªå‹•å¡«å…¥ä»»å‹™åç¨±å’Œæè¿°ï¼Œä¸¦é¡¯ç¤ºè©³ç´°è³‡è¨Š
document.addEventListener('DOMContentLoaded', function() {
    const workTypeSelect = document.getElementById('work-type-select');
    const taskNameInput = document.getElementById('task-name');
    const taskDescriptionTextarea = document.getElementById('task-description');
    const taskParametersTextarea = document.getElementById('task-parameters');
    const workInfoDisplay = document.getElementById('work-info-display');

    if (workTypeSelect && taskNameInput && taskDescriptionTextarea && taskParametersTextarea && workInfoDisplay) {
        // å¦‚æœé é¢è¼‰å…¥æ™‚å·²æœ‰é¸æ“‡çš„å·¥ä½œé¡å‹ï¼ˆç·¨è¼¯æ¨¡å¼ï¼‰ï¼Œé¡¯ç¤ºè³‡è¨Š
        if (workTypeSelect.value) {
            displayWorkInfo(workTypeSelect.options[workTypeSelect.selectedIndex]);
        }

        workTypeSelect.addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];

            // åªåœ¨æ–°å¢ä»»å‹™æ™‚è‡ªå‹•å¡«å…¥ï¼ˆç·¨è¼¯æ™‚ä¸è¦†è“‹ï¼‰
            const isEditMode = taskNameInput.value !== '' && {{ 'true' if task else 'false' }};

            if (selectedOption.value) {
                const workId = parseInt(selectedOption.getAttribute('data-work-id'));
                const workName = selectedOption.getAttribute('data-work-name');
                const workDescription = selectedOption.getAttribute('data-work-description');
                const workParametersStr = selectedOption.getAttribute('data-work-parameters');

                // å¡«å…¥ä»»å‹™åç¨±ï¼ˆå¦‚æœæ˜¯æ–°å¢æ¨¡å¼æˆ–æ¬„ä½ç‚ºç©ºï¼‰
                if (!isEditMode || taskNameInput.value === '') {
                    taskNameInput.value = workName || '';
                }

                // å¡«å…¥ä»»å‹™æè¿°ï¼ˆå¦‚æœæ˜¯æ–°å¢æ¨¡å¼æˆ–æ¬„ä½ç‚ºç©ºï¼‰
                if (!isEditMode || taskDescriptionTextarea.value === '') {
                    taskDescriptionTextarea.value = workDescription || '';
                }

                // ğŸ”¥ æ™ºèƒ½å¡«å……åƒæ•¸ï¼ˆæ–°åŠŸèƒ½ï¼‰
                if (!isEditMode || taskParametersTextarea.value.trim() === '') {
                    try {
                        // è§£æ Work è¡¨ä¸­çš„åƒæ•¸æ¨¡æ¿
                        let workParameters = {};
                        if (workParametersStr && workParametersStr !== '{}') {
                            workParameters = JSON.parse(workParametersStr);
                        }

                        // KUKA æ”¯æ´çš„å·¥ä½œ ID
                        const KUKA_WORK_IDS = [210001, 220001, 230001];

                        // å¦‚æœæ˜¯ KUKA ä»»å‹™ï¼Œè‡ªå‹•æ·»åŠ  model å­—æ®µ
                        if (KUKA_WORK_IDS.includes(workId)) {
                            let taskParameters = {
                                model: "KUKA400i",  // è‡ªå‹•æ·»åŠ  KUKA å‹è™Ÿ
                                ...workParameters    // åˆä½µ Work è¡¨åƒæ•¸
                            };

                            // æ ¹æ“šä¸åŒçš„ work_id æ·»åŠ å°æ‡‰çš„åƒæ•¸çµæ§‹
                            if (workId === 210001 || workId === 220001) {
                                // KUKA ç§»å‹•å’Œç§»å‹•è²¨æ¶ä»»å‹™
                                if (!taskParameters.nodes) {
                                    taskParameters.nodes = [];  // é è¨­ç©ºçš„ç¯€é»åˆ—è¡¨
                                }
                            } else if (workId === 230001) {
                                // KUKA å·¥ä½œæµä»»å‹™
                                if (!taskParameters.templateCode) {
                                    taskParameters.templateCode = "";  // é è¨­ç©ºçš„æ¨¡æ¿ä»£ç¢¼
                                }
                            }

                            // æ ¼å¼åŒ–ä¸¦å¡«å……åˆ° textarea
                            taskParametersTextarea.value = JSON.stringify(taskParameters, null, 2);
                        } else if (Object.keys(workParameters).length > 0) {
                            // é KUKA ä»»å‹™ï¼Œä½†æœ‰åƒæ•¸æ¨¡æ¿
                            taskParametersTextarea.value = JSON.stringify(workParameters, null, 2);
                        }

                        // è¦–è¦ºåé¥‹
                        if (taskParametersTextarea.value.trim() !== '') {
                            taskParametersTextarea.classList.add('is-success');
                            setTimeout(function() {
                                taskParametersTextarea.classList.remove('is-success');
                            }, 1500);
                        }
                    } catch (error) {
                        console.error('è§£æåƒæ•¸æ¨¡æ¿å¤±æ•—:', error);
                    }
                }

                // æ·»åŠ è¦–è¦ºåé¥‹
                taskNameInput.classList.add('is-success');
                taskDescriptionTextarea.classList.add('is-success');

                setTimeout(function() {
                    taskNameInput.classList.remove('is-success');
                    taskDescriptionTextarea.classList.remove('is-success');
                }, 1500);

                // é¡¯ç¤ºå·¥ä½œé¡å‹è©³ç´°è³‡è¨Š
                displayWorkInfo(selectedOption);
            } else {
                // å¦‚æœå–æ¶ˆé¸æ“‡å·¥ä½œé¡å‹ï¼Œæ¸…ç©ºæ¬„ä½ï¼ˆåƒ…åœ¨æ–°å¢æ¨¡å¼ï¼‰
                if (!isEditMode) {
                    taskNameInput.value = '';
                    taskDescriptionTextarea.value = '';
                    taskParametersTextarea.value = '';
                }
                // éš±è—å·¥ä½œé¡å‹è³‡è¨Š
                workInfoDisplay.style.display = 'none';
            }
        });
    }

    // é¡¯ç¤ºå·¥ä½œé¡å‹è©³ç´°è³‡è¨Šçš„å‡½æ•¸
    function displayWorkInfo(option) {
        if (!option || !option.value) {
            workInfoDisplay.style.display = 'none';
            return;
        }

        const workId = option.getAttribute('data-work-id');

        // æ›´æ–°é¡¯ç¤ºå…§å®¹
        document.getElementById('display-work-id').textContent = workId || '-';

        // é¡¯ç¤ºè³‡è¨Šå¡ç‰‡
        workInfoDisplay.style.display = 'block';
    }
});
</script>
{% endblock %}