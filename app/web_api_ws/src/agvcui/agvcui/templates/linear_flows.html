{% extends "base.html" %}

{% block title %}Linear Flow Designer v2 - 流程列表{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
    .flow-card {
        cursor: pointer;
        transition: all 0.3s ease;
        margin-bottom: 1rem;
    }
    .flow-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 16px rgba(0,0,0,0.15);
    }
    .flow-status {
        display: inline-block;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 0.875rem;
        font-weight: bold;
    }
    .flow-status.enabled {
        background-color: #48c774;
        color: white;
    }
    .flow-status.disabled {
        background-color: #ff3860;
        color: white;
    }
    .flow-meta {
        display: flex;
        gap: 1rem;
        margin-top: 0.5rem;
        color: #666;
        font-size: 0.9rem;
    }
    .flow-actions {
        display: flex;
        gap: 0.5rem;
        margin-top: 1rem;
    }
    .empty-state {
        text-align: center;
        padding: 3rem;
        color: #999;
    }
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255,255,255,0.9);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        display: none;
    }
    .loading-overlay.is-active {
        display: flex;
    }
</style>
{% endblock %}

{% block content %}
<section class="section">
    <div class="container">
        <!-- Header -->
        <div class="level">
            <div class="level-left">
                <div class="level-item">
                    <div>
                        <h1 class="title">Linear Flow Designer v2</h1>
                        <p class="subtitle is-6">新一代線性流程設計器</p>
                    </div>
                </div>
            </div>
            <div class="level-right">
                <div class="level-item">
                    <button class="button is-primary" onclick="createNewFlow()">
                        <span class="icon">
                            <i class="fas fa-plus"></i>
                        </span>
                        <span>建立新流程</span>
                    </button>
                </div>
                <div class="level-item">
                    <button class="button is-info" onclick="refreshFlows()">
                        <span class="icon">
                            <i class="fas fa-sync"></i>
                        </span>
                        <span>重新整理</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Filters -->
        <div class="box">
            <div class="field is-grouped">
                <div class="control has-icons-left">
                    <input class="input" type="text" placeholder="搜尋流程..." id="searchInput">
                    <span class="icon is-left">
                        <i class="fas fa-search"></i>
                    </span>
                </div>
                <div class="control">
                    <div class="select">
                        <select id="statusFilter">
                            <option value="">所有狀態</option>
                            <option value="enabled">已啟用</option>
                            <option value="disabled">已停用</option>
                        </select>
                    </div>
                </div>
                <div class="control">
                    <button class="button is-primary" onclick="applyFilters()">
                        <span class="icon">
                            <i class="fas fa-filter"></i>
                        </span>
                        <span>套用篩選</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Flow List -->
        <div id="flowList" class="columns is-multiline">
            <!-- Flow cards will be inserted here -->
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="empty-state" style="display: none;">
            <div class="has-text-centered">
                <span class="icon is-large has-text-grey-light">
                    <i class="fas fa-3x fa-inbox"></i>
                </span>
                <p class="is-size-4 mt-4">尚無流程</p>
                <p class="has-text-grey">點擊「建立新流程」開始建立您的第一個線性流程</p>
            </div>
        </div>
    </div>
</section>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="box">
        <progress class="progress is-primary" max="100">Loading...</progress>
        <p>載入中...</p>
    </div>
</div>

<script>
    let allFlows = [];
    
    // Load flows on page load
    document.addEventListener('DOMContentLoaded', () => {
        loadFlows();
    });
    
    function showLoading() {
        document.getElementById('loadingOverlay').classList.add('is-active');
    }
    
    function hideLoading() {
        document.getElementById('loadingOverlay').classList.remove('is-active');
    }
    
    async function loadFlows() {
        showLoading();
        try {
            const response = await fetch('/linear-flow/api/flows');
            const data = await response.json();
            
            if (data.success) {
                allFlows = data.flows || [];
                displayFlows(allFlows);
            } else {
                console.error('Failed to load flows:', data.error);
                showError('載入流程失敗');
            }
        } catch (error) {
            console.error('Error loading flows:', error);
            showError('載入流程時發生錯誤');
        } finally {
            hideLoading();
        }
    }
    
    function displayFlows(flows) {
        const flowList = document.getElementById('flowList');
        const emptyState = document.getElementById('emptyState');
        
        flowList.innerHTML = '';
        
        if (flows.length === 0) {
            emptyState.style.display = 'block';
            return;
        }
        
        emptyState.style.display = 'none';
        
        flows.forEach(flow => {
            const card = createFlowCard(flow);
            flowList.appendChild(card);
        });
    }
    
    function createFlowCard(flow) {
        const column = document.createElement('div');
        column.className = 'column is-half';
        
        const statusClass = flow.enabled ? 'enabled' : 'disabled';
        const statusText = flow.enabled ? '已啟用' : '已停用';
        
        column.innerHTML = `
            <div class="card flow-card" onclick="editFlow('${flow.id}')">
                <div class="card-content">
                    <div class="level">
                        <div class="level-left">
                            <div>
                                <p class="title is-5">${flow.name || flow.id}</p>
                                <p class="subtitle is-6">
                                    <span class="flow-status ${statusClass}">${statusText}</span>
                                    ${flow.work_id ? `<span class="tag is-info ml-2">Work ID: ${flow.work_id}</span>` : ''}
                                </p>
                            </div>
                        </div>
                        <div class="level-right">
                            <div class="has-text-right">
                                <p class="is-size-7 has-text-grey">優先級: ${flow.priority || 100}</p>
                                <p class="is-size-7 has-text-grey">${flow.sections || 0} 個區段</p>
                            </div>
                        </div>
                    </div>
                    
                    ${flow.description ? `<p class="content">${flow.description}</p>` : ''}
                    
                    <div class="flow-meta">
                        <span><i class="fas fa-file"></i> ${flow.filename || 'N/A'}</span>
                        <span><i class="fas fa-code-branch"></i> ${flow.version || 'N/A'}</span>
                        <span><i class="fas fa-clock"></i> ${formatDate(flow.modified)}</span>
                    </div>
                    
                    <div class="flow-actions">
                        <button class="button is-small is-primary" onclick="event.stopPropagation(); editFlow('${flow.id}')">
                            <span class="icon">
                                <i class="fas fa-edit"></i>
                            </span>
                            <span>編輯</span>
                        </button>
                        <button class="button is-small is-info" onclick="event.stopPropagation(); duplicateFlow('${flow.id}')">
                            <span class="icon">
                                <i class="fas fa-copy"></i>
                            </span>
                            <span>複製</span>
                        </button>
                        <button class="button is-small is-warning" onclick="event.stopPropagation(); toggleFlow('${flow.id}', ${!flow.enabled})">
                            <span class="icon">
                                <i class="fas fa-${flow.enabled ? 'pause' : 'play'}"></i>
                            </span>
                            <span>${flow.enabled ? '停用' : '啟用'}</span>
                        </button>
                        <button class="button is-small is-danger" onclick="event.stopPropagation(); deleteFlow('${flow.id}')">
                            <span class="icon">
                                <i class="fas fa-trash"></i>
                            </span>
                            <span>刪除</span>
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        return column;
    }
    
    function formatDate(dateString) {
        if (!dateString) return 'N/A';
        const date = new Date(dateString);
        return date.toLocaleString('zh-TW');
    }
    
    function createNewFlow() {
        window.location.href = '/linear-flow/designer';
    }
    
    function editFlow(flowId) {
        window.location.href = `/linear-flow/designer?flow=${flowId}`;
    }
    
    async function duplicateFlow(flowId) {
        if (!confirm('確定要複製此流程嗎？')) return;
        
        showLoading();
        try {
            // Load flow data
            const response = await fetch(`/linear-flow/api/flows/${flowId}`);
            const data = await response.json();
            
            if (data.success && data.flow) {
                // Modify flow ID and name
                const newFlow = {...data.flow};
                newFlow.flow.id = `${flowId}_copy_${Date.now()}`;
                newFlow.flow.name = `${newFlow.flow.name || flowId} (複製)`;
                
                // Save as new flow
                const saveResponse = await fetch('/linear-flow/api/flows/save', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        flow_id: newFlow.flow.id,
                        flow_data: newFlow
                    })
                });
                
                const saveData = await saveResponse.json();
                
                if (saveData.success) {
                    showSuccess('流程複製成功');
                    loadFlows();
                } else {
                    showError('複製流程失敗: ' + (saveData.error || '未知錯誤'));
                }
            } else {
                showError('載入流程失敗');
            }
        } catch (error) {
            console.error('Error duplicating flow:', error);
            showError('複製流程時發生錯誤');
        } finally {
            hideLoading();
        }
    }
    
    async function toggleFlow(flowId, enable) {
        showLoading();
        try {
            // Load flow data
            const response = await fetch(`/linear-flow/api/flows/${flowId}`);
            const data = await response.json();
            
            if (data.success && data.flow) {
                // Update enabled status
                data.flow.flow.enabled = enable;
                
                // Save flow
                const saveResponse = await fetch('/linear-flow/api/flows/save', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        flow_id: flowId,
                        flow_data: data.flow
                    })
                });
                
                const saveData = await saveResponse.json();
                
                if (saveData.success) {
                    showSuccess(`流程已${enable ? '啟用' : '停用'}`);
                    loadFlows();
                } else {
                    showError('更新流程狀態失敗');
                }
            } else {
                showError('載入流程失敗');
            }
        } catch (error) {
            console.error('Error toggling flow:', error);
            showError('更新流程狀態時發生錯誤');
        } finally {
            hideLoading();
        }
    }
    
    async function deleteFlow(flowId) {
        if (!confirm(`確定要刪除流程 ${flowId} 嗎？此操作無法復原。`)) return;
        
        showLoading();
        try {
            const response = await fetch(`/linear-flow/api/flows/${encodeURIComponent(flowId)}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            
            if (data.success) {
                showSuccess('流程已刪除');
                loadFlows();
            } else {
                showError('刪除流程失敗: ' + (data.error || '未知錯誤'));
            }
        } catch (error) {
            console.error('Error deleting flow:', error);
            showError('刪除流程時發生錯誤: ' + error.message);
        } finally {
            hideLoading();
        }
    }
    
    function applyFilters() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const statusFilter = document.getElementById('statusFilter').value;
        
        let filteredFlows = allFlows;
        
        // Apply search filter
        if (searchTerm) {
            filteredFlows = filteredFlows.filter(flow => 
                (flow.id && flow.id.toLowerCase().includes(searchTerm)) ||
                (flow.name && flow.name.toLowerCase().includes(searchTerm)) ||
                (flow.description && flow.description.toLowerCase().includes(searchTerm)) ||
                (flow.work_id && flow.work_id.toLowerCase().includes(searchTerm))
            );
        }
        
        // Apply status filter
        if (statusFilter === 'enabled') {
            filteredFlows = filteredFlows.filter(flow => flow.enabled === true);
        } else if (statusFilter === 'disabled') {
            filteredFlows = filteredFlows.filter(flow => flow.enabled === false);
        }
        
        displayFlows(filteredFlows);
    }
    
    function refreshFlows() {
        loadFlows();
    }
    
    function showSuccess(message) {
        // Create notification element
        const notification = document.createElement('div');
        notification.className = 'notification is-success';
        notification.style.cssText = 'position: fixed; top: 60px; right: 20px; z-index: 10000; min-width: 300px;';
        notification.innerHTML = `
            <button class="delete"></button>
            <span class="icon">
                <i class="fas fa-check-circle"></i>
            </span>
            ${message}
        `;
        document.body.appendChild(notification);
        
        // Add close handler
        notification.querySelector('.delete').addEventListener('click', () => {
            notification.remove();
        });
        
        // Auto remove after 3 seconds
        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, 3000);
    }
    
    function showError(message) {
        // Create notification element
        const notification = document.createElement('div');
        notification.className = 'notification is-danger';
        notification.style.cssText = 'position: fixed; top: 60px; right: 20px; z-index: 10000; min-width: 300px;';
        notification.innerHTML = `
            <button class="delete"></button>
            <span class="icon">
                <i class="fas fa-exclamation-circle"></i>
            </span>
            ${message}
        `;
        document.body.appendChild(notification);
        
        // Add close handler
        notification.querySelector('.delete').addEventListener('click', () => {
            notification.remove();
        });
        
        // Auto remove after 5 seconds
        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, 5000);
    }
</script>
{% endblock %}