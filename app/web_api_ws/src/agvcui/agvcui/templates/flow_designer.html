{% extends "base.html" %}
{% block title %}AGVCUI - WCS Flow Designer{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="/static/css/flowDesignerPage.css?v=2.5" />
<!-- Rete.js v2 CDN Dependencies -->
<script src="https://cdn.jsdelivr.net/npm/rete@2.0.6/rete.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/rete-area-plugin@2.1.3/rete-area-plugin.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/rete-connection-plugin@2.0.5/rete-connection-plugin.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/rete-render-utils@2.0.5/rete-render-utils.min.js"></script>
<!-- js-yaml library for YAML parsing -->
<script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
{% endblock %}

{% block content %}
<div class="flow-designer-container">
    <!-- 工具列 -->
    <div class="flow-toolbar">
        <div class="level">
            <div class="level-left">
                <div class="level-item">
                    <h1 class="title is-5">
                        <span class="icon">
                            <i class="mdi mdi-sitemap"></i>
                        </span>
                        WCS Flow Designer
                    </h1>
                </div>
            </div>
            <div class="level-right">
                <div class="level-item">
                    <div class="buttons">
                        <button class="button is-info" id="btn-new-flow">
                            <span class="icon">
                                <i class="mdi mdi-file-plus"></i>
                            </span>
                            <span>新建流程</span>
                        </button>
                        <button class="button is-primary" id="btn-load-flow">
                            <span class="icon">
                                <i class="mdi mdi-folder-open"></i>
                            </span>
                            <span>載入流程</span>
                        </button>
                        <button class="button is-success" id="btn-save-flow">
                            <span class="icon">
                                <i class="mdi mdi-content-save"></i>
                            </span>
                            <span>保存流程</span>
                        </button>
                        <button class="button is-warning" id="btn-export-flow">
                            <span class="icon">
                                <i class="mdi mdi-export"></i>
                            </span>
                            <span>匯出</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 主要內容區域 -->
    <div class="flow-main-content">
        <!-- 側邊欄 - 節點選板 -->
        <div class="flow-sidebar">
            <div class="flow-sidebar-header">
                <h2 class="subtitle is-6 has-text-white">節點選板</h2>
            </div>
            <div class="flow-node-palette">
                <!-- 條件節點區域 -->
                <div class="palette-section">
                    <div class="palette-section-title">
                        <span class="icon">
                            <i class="mdi mdi-help-circle"></i>
                        </span>
                        條件節點
                    </div>
                    <div class="palette-nodes" id="condition-nodes">
                        <!-- 條件節點將通過 JavaScript 動態生成 -->
                    </div>
                </div>

                <!-- 動作節點區域 -->
                <div class="palette-section">
                    <div class="palette-section-title">
                        <span class="icon">
                            <i class="mdi mdi-cog"></i>
                        </span>
                        動作節點
                    </div>
                    <div class="palette-nodes" id="action-nodes">
                        <!-- 動作節點將通過 JavaScript 動態生成 -->
                    </div>
                </div>

                <!-- 邏輯節點區域 -->
                <div class="palette-section">
                    <div class="palette-section-title">
                        <span class="icon">
                            <i class="mdi mdi-vector-triangle"></i>
                        </span>
                        邏輯節點
                    </div>
                    <div class="palette-nodes" id="logic-nodes">
                        <!-- 邏輯節點將通過 JavaScript 動態生成 -->
                    </div>
                </div>
            </div>
        </div>

        <!-- 編輯器區域 -->
        <div class="flow-editor-container">
            <div id="rete-editor" class="flow-editor"></div>
        </div>

        <!-- 屬性面板 -->
        <div class="flow-properties-panel" id="properties-panel">
            <div class="flow-properties-header">
                <h3 class="subtitle is-6">節點屬性</h3>
                <button class="delete" id="close-properties"></button>
            </div>
            <div class="flow-properties-content" id="properties-content">
                <div class="field">
                    <label class="label">節點名稱</label>
                    <div class="control">
                        <input class="input" type="text" id="node-name" placeholder="請輸入節點名稱">
                    </div>
                </div>
                <div class="field">
                    <label class="label">描述</label>
                    <div class="control">
                        <textarea class="textarea" id="node-description" placeholder="請輸入節點描述"></textarea>
                    </div>
                </div>
                
                <!-- 條件節點參數 -->
                <div id="condition-parameters" style="display: none;">
                    <div class="field">
                        <label class="label">條件函數</label>
                        <div class="control">
                            <div class="select is-fullwidth">
                                <select id="condition-function">
                                    <option value="">選擇條件函數...</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div id="condition-dynamic-params">
                        <!-- 動態參數將在這裡生成 -->
                    </div>
                </div>

                <!-- 動作節點參數 -->
                <div id="action-parameters" style="display: none;">
                    <div class="field">
                        <label class="label">動作函數</label>
                        <div class="control">
                            <div class="select is-fullwidth">
                                <select id="action-function">
                                    <option value="">選擇動作函數...</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div id="action-dynamic-params">
                        <!-- 動態參數將在這裡生成 -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 狀態列 -->
    <div class="flow-status-bar">
        <div class="level">
            <div class="level-left">
                <div class="level-item">
                    <span class="tag is-info">就緒</span>
                </div>
                <div class="level-item">
                    <span class="has-text-grey-light">節點: <span id="node-count">0</span></span>
                </div>
                <div class="level-item">
                    <span class="has-text-grey-light">連接: <span id="connection-count">0</span></span>
                </div>
            </div>
            <div class="level-right">
                <div class="level-item">
                    <span class="has-text-grey-light">當前流程: <span id="current-flow-name">未命名</span></span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 流程管理模態框 -->
<div class="modal" id="flow-manager-modal">
    <div class="modal-background"></div>
    <div class="modal-card">
        <header class="modal-card-head">
            <p class="modal-card-title">流程管理</p>
            <button class="delete" aria-label="close"></button>
        </header>
        <section class="modal-card-body">
            <div class="field">
                <label class="label">流程名稱</label>
                <div class="control">
                    <input class="input" type="text" id="flow-name-input" placeholder="請輸入流程名稱">
                </div>
            </div>
            <div class="field">
                <label class="label">描述</label>
                <div class="control">
                    <textarea class="textarea" id="flow-description-input" placeholder="請輸入流程描述"></textarea>
                </div>
            </div>
            <div class="field">
                <label class="label">現有流程</label>
                <div class="control">
                    <div class="select is-fullwidth">
                        <select id="existing-flows">
                            <option value="">選擇現有流程...</option>
                        </select>
                    </div>
                </div>
            </div>
        </section>
        <footer class="modal-card-foot">
            <button class="button is-success" id="confirm-flow-action">確認</button>
            <button class="button" id="cancel-flow-action">取消</button>
        </footer>
    </div>
</div>

<!-- 文件上傳隱藏輸入 -->
<input type="file" id="file-input" accept=".json" style="display: none;">

<script type="module" src="/static/js/flowDesignerPage.js?v=2.6"></script>
{% endblock %}