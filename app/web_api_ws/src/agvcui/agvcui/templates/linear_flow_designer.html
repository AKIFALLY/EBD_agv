{% extends "base.html" %}

{% block title %}Linear Flow Designer - Flow WCS v2{% endblock %}

{% block extra_head %}
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- CodeMirror for YAML editing -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/default.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/foldgutter.min.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="/static/css/linearFlowDesigner.css?v=2.9">
{% endblock %}

{% block content %}
    <div class="linear-flow-container">
        <!-- Left Panel: Flow Structure -->
        <div class="flow-structure-panel">
            <div class="panel">
                <p class="panel-heading">
                    <i class="fas fa-sitemap mr-2"></i>ÊµÅÁ®ãÁµêÊßã
                </p>
                
                <!-- Panel Tabs -->
                <p class="panel-tabs">
                    <a data-tab="settings" onclick="switchLeftTab('settings')">
                        <i class="fas fa-cog mr-1"></i>Ë®≠ÂÆö
                    </a>
                    <a class="is-active" data-tab="workflow" onclick="switchLeftTab('workflow')">
                        <i class="fas fa-list mr-1"></i>Â∑•‰ΩúÊµÅÁ®ã
                    </a>
                    <a onclick="addSection()">
                        <i class="fas fa-plus"></i> Êñ∞Â¢ûÂçÄÊÆµ
                    </a>
                </p>
                
                <!-- Settings Tab -->
                <div id="settings-tab" class="left-tab-content">
                    <div class="flow-settings">
                        <div class="field">
                            <label class="label is-small">Flow ID</label>
                            <input class="input is-small" type="text" id="flow-id" placeholder="flow_id">
                        </div>
                        <div class="field">
                            <label class="label is-small">Flow Name</label>
                            <input class="input is-small" type="text" id="flow-name" placeholder="ÊµÅÁ®ãÂêçÁ®±">
                        </div>
                        <div class="field">
                            <label class="label is-small">Description</label>
                            <textarea class="textarea is-small" id="flow-description" placeholder="ÊµÅÁ®ãÊèèËø∞" rows="3"></textarea>
                        </div>
                        <div class="field">
                            <label class="label is-small">Work ID</label>
                            <input class="input is-small" type="text" id="work-id" placeholder="220001">
                        </div>
                        <div class="field">
                            <label class="label is-small">Priority</label>
                            <input class="input is-small" type="number" id="flow-priority" placeholder="100" value="100" min="0" max="1000">
                        </div>
                        <div class="field">
                            <label class="label is-small">
                                <input type="checkbox" id="flow-enabled" checked> ÂïüÁî®Ê≠§ÊµÅÁ®ã
                            </label>
                        </div>
                    </div>
                </div>
                
                <!-- Workflow Tab -->
                <div id="workflow-tab" class="left-tab-content is-active">
                    <div id="workflow-sections" class="workflow-sections">
                        <!-- Sections will be added here dynamically -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Middle Panel: Visual Editor -->
        <div class="flow-editor-panel">
            <div class="editor-header">
                <div class="editor-tabs">
                    <a class="is-active" data-tab="visual" onclick="switchTab('visual')">
                        <i class="fas fa-project-diagram mr-1"></i>Ë¶ñË¶∫Á∑®ËºØ
                    </a>
                    <a data-tab="yaml" onclick="switchTab('yaml')">
                        <i class="fas fa-code mr-1"></i>YAML Á∑®ËºØ
                    </a>
                    <a data-tab="preview" onclick="switchTab('preview')">
                        <i class="fas fa-eye mr-1"></i>È†êË¶Ω
                    </a>
                </div>
                <div class="editor-actions">
                    <!-- Export Button -->
                    <button class="button is-small is-info" onclick="exportFlow()" title="Â∞éÂá∫ YAML">
                        <span class="icon"><i class="fas fa-download"></i></span>
                    </button>
                    <!-- Import Button -->
                    <button class="button is-small is-warning" onclick="importFlow()" title="Â∞éÂÖ• YAML">
                        <span class="icon"><i class="fas fa-upload"></i></span>
                    </button>
                    <input type="file" id="import-file-input" accept=".yaml,.yml" style="display: none;" onchange="handleFileImport(event)">
                    <!-- Local Save Button -->
                    <button class="button is-small is-primary" onclick="saveFlowSettings()" title="Êö´Â≠òÂà∞Êú¨Âú∞">
                        <span class="icon"><i class="fas fa-database"></i></span>
                    </button>
                    <!-- Clear Cache Button -->
                    <button class="button is-small is-warning" onclick="clearCacheAndReload()" title="Ê∏ÖÈô§Âø´Âèñ‰∏¶ÈáçÊñ∞ËºâÂÖ•">
                        <span class="icon"><i class="fas fa-trash-alt"></i></span>
                    </button>
                    <!-- Server Sync Button with Status -->
                    <button class="button is-small sync-button" id="sync-button" onclick="saveFlowToServer()" title="ÂêåÊ≠•Âà∞‰º∫ÊúçÂô®">
                        <span class="icon" id="sync-icon"><i class="fas fa-cloud-upload-alt"></i></span>
                        <span id="sync-text">ÂêåÊ≠•</span>
                    </button>
                    <!-- Validation Status Indicator -->
                    <div class="validation-indicator" id="validation-indicator" title="ÈªûÊìäÈáçÊñ∞È©óË≠â">
                        <span class="icon is-small">
                            <i class="fas fa-circle-notch fa-spin" id="validation-icon"></i>
                        </span>
                    </div>
                    <!-- Test Button -->
                    <button class="button is-small is-success" onclick="testFlow()" title="Ê∏¨Ë©¶Âü∑Ë°å">
                        <span class="icon"><i class="fas fa-play-circle"></i></span>
                    </button>
                </div>
            </div>

            <!-- Tabs Content Container -->
            <div class="tabs-container">
                <!-- Visual Editor Tab -->
                <div id="visual-tab" class="tab-content is-active">
                    <div class="visual-editor">
                        <div id="section-editor" class="section-editor">
                            <div class="notification is-info">
                                <p>ÈÅ∏ÊìáÂ∑¶ÂÅ¥ÁöÑÂçÄÊÆµÊàñÊ≠•È©üÈÄ≤Ë°åÁ∑®ËºØ</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- YAML Editor Tab -->
                <div id="yaml-tab" class="tab-content">
                    <div class="yaml-editor">
                        <textarea id="yaml-editor-textarea"></textarea>
                    </div>
                </div>

                <!-- Preview Tab -->
                <div id="preview-tab" class="tab-content">
                    <div class="preview-container">
                        <div class="content" id="flow-preview">
                            <!-- Flow preview will be rendered here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Top Right Panel: Function Library -->
        <div class="function-library-panel">
            <div class="panel">
                <p class="panel-heading">
                    <i class="fas fa-toolbox mr-2"></i>ÂáΩÊï∏Â∫´
                </p>
                
                <!-- Function Categories -->
                <p class="panel-tabs" id="function-category-tabs">
                    <a class="is-active" data-category="all" onclick="switchFunctionCategory('all')">ÂÖ®ÈÉ®</a>
                    <a data-category="query" onclick="switchFunctionCategory('query')">Êü•Ë©¢</a>
                    <a data-category="check" onclick="switchFunctionCategory('check')">Ê™¢Êü•</a>
                    <a data-category="task" onclick="switchFunctionCategory('task')">‰ªªÂãô</a>
                    <a data-category="action" onclick="switchFunctionCategory('action')">Âãï‰Ωú</a>
                    <a data-category="control" onclick="switchFunctionCategory('control')">ÊéßÂà∂</a>
                    <a data-category="special" onclick="switchFunctionCategory('special')">ÁâπÊÆä</a>
                </p>
                
                <div id="function-list" class="function-list">
                    <!-- Functions will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Bottom Right Panel: Variables -->
        <div class="variables-panel">
            <div class="panel">
                <p class="panel-heading">
                    <i class="fas fa-database mr-2"></i>ËÆäÊï∏
                </p>
                <div id="variables-list" class="variables-list">
                    <!-- Variables will be displayed here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- Add Section Modal -->
    <div class="modal" id="add-section-modal">
        <div class="modal-background" onclick="closeModal('add-section-modal')"></div>
        <div class="modal-card">
            <header class="modal-card-head">
                <p class="modal-card-title">Êñ∞Â¢ûÂ∑•‰ΩúÊµÅÁ®ãÂçÄÊÆµ</p>
                <button class="delete" onclick="closeModal('add-section-modal')"></button>
            </header>
            <section class="modal-card-body">
                <div class="field">
                    <label class="label">ÂçÄÊÆµÂêçÁ®±</label>
                    <input class="input" type="text" id="new-section-name" placeholder="‰æãÂ¶ÇÔºöÊü•Ë©¢Ë≥áÊñô">
                </div>
                <div class="field">
                    <label class="label">ÊèèËø∞</label>
                    <textarea class="textarea" id="new-section-description" placeholder="ÂçÄÊÆµÊèèËø∞"></textarea>
                </div>
                <div class="field">
                    <label class="label">Ê¢ù‰ª∂ (ÈÅ∏Â°´)</label>
                    <input class="input" type="text" id="new-section-condition" placeholder="${variable_name}">
                </div>
            </section>
            <footer class="modal-card-foot">
                <button class="button is-success" onclick="confirmAddSection()">Êñ∞Â¢û</button>
                <button class="button" onclick="closeModal('add-section-modal')">ÂèñÊ∂à</button>
            </footer>
        </div>
    </div>

    <!-- Add Step Modal -->
    <div class="modal" id="add-step-modal">
        <div class="modal-background" onclick="closeModal('add-step-modal')"></div>
        <div class="modal-card">
            <header class="modal-card-head">
                <p class="modal-card-title">Êñ∞Â¢ûÊ≠•È©ü</p>
                <button class="delete" onclick="closeModal('add-step-modal')"></button>
            </header>
            <section class="modal-card-body">
                <div class="field">
                    <label class="label">ÁõÆÊ®ôÂçÄÊÆµ</label>
                    <div class="control">
                        <div class="select is-fullwidth">
                            <select id="new-step-section">
                                <option value="">ÈÅ∏ÊìáÂçÄÊÆµ...</option>
                                <option value="new">üìù Êñ∞Â¢ûÂçÄÊÆµ</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="field">
                    <label class="label">Ê≠•È©ü ID</label>
                    <input class="input" type="text" id="new-step-id" placeholder="step_1">
                </div>
                <div class="field">
                    <label class="label">Âü∑Ë°åÂáΩÊï∏</label>
                    <div class="control has-icons-left">
                        <div class="select is-fullwidth">
                            <select id="new-step-exec" onchange="onFunctionSelectChange(this.value)">
                                <option value="">ÈÅ∏ÊìáÂáΩÊï∏...</option>
                            </select>
                        </div>
                        <span class="icon is-left">
                            <i class="fas fa-function"></i>
                        </span>
                    </div>
                </div>
                <div class="field">
                    <label class="label">ÂèÉÊï∏ (JSON)</label>
                    <textarea class="textarea" id="new-step-params" placeholder='{"key": "value"}'>{}</textarea>
                </div>
                <div class="field">
                    <label class="label">ÂÑ≤Â≠òÁµêÊûúËá≥ËÆäÊï∏</label>
                    <input class="input" type="text" id="new-step-store" placeholder="variable_name">
                </div>
                <div class="field">
                    <label class="checkbox">
                        <input type="checkbox" id="new-step-skip-if-enabled">
                        ÂïüÁî®Ê¢ù‰ª∂Ë∑≥ÈÅé
                    </label>
                    <input class="input mt-2" type="text" id="new-step-skip-if" placeholder="${condition}" style="display:none;">
                </div>
            </section>
            <footer class="modal-card-foot">
                <button class="button is-success" onclick="confirmAddStep()">Êñ∞Â¢û</button>
                <button class="button" onclick="closeModal('add-step-modal')">ÂèñÊ∂à</button>
            </footer>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal" id="delete-confirmation-modal">
        <div class="modal-background" onclick="closeDeleteConfirmation()"></div>
        <div class="modal-card" style="width: 90%; max-width: 480px;">
            <header class="modal-card-head" style="background: #f14668; border-bottom-color: #f14668;">
                <p class="modal-card-title" style="color: white;">
                    <span class="icon"><i class="fas fa-exclamation-triangle"></i></span>
                    <span>Á¢∫Ë™çÂà™Èô§</span>
                </p>
                <button class="delete" onclick="closeDeleteConfirmation()"></button>
            </header>
            <section class="modal-card-body">
                <div class="content">
                    <p id="delete-confirmation-message" style="font-size: 1.1rem; color: #363636;">
                        Á¢∫ÂÆöË¶ÅÂà™Èô§Ê≠§È†ÖÁõÆÂóéÔºü
                    </p>
                    <div class="message is-warning" style="margin-top: 1rem;">
                        <div class="message-body">
                            <p style="margin: 0;">
                                <strong>‚ö†Ô∏è Ê≥®ÊÑèÔºö</strong>Ê≠§Êìç‰ΩúÁÑ°Ê≥ïÂæ©Âéü
                            </p>
                        </div>
                    </div>
                </div>
            </section>
            <footer class="modal-card-foot">
                <button class="button is-danger" id="confirm-delete-button">
                    <span class="icon"><i class="fas fa-trash"></i></span>
                    <span>Á¢∫ÂÆöÂà™Èô§</span>
                </button>
                <button class="button" onclick="closeDeleteConfirmation()">ÂèñÊ∂à</button>
            </footer>
        </div>
    </div>

    <!-- Alert Modal -->
    <div class="modal" id="alert-modal">
        <div class="modal-background" onclick="closeAlertModal()"></div>
        <div class="modal-card" style="width: 90%; max-width: 480px;">
            <header class="modal-card-head" id="alert-modal-header">
                <p class="modal-card-title">
                    <span class="icon" id="alert-modal-icon"><i class="fas fa-info-circle"></i></span>
                    <span id="alert-modal-title">ÊèêÁ§∫</span>
                </p>
                <button class="delete" onclick="closeAlertModal()"></button>
            </header>
            <section class="modal-card-body">
                <div class="content">
                    <p id="alert-modal-message" style="font-size: 1.1rem; color: #363636;">
                        Ë®äÊÅØÂÖßÂÆπ
                    </p>
                </div>
            </section>
            <footer class="modal-card-foot">
                <button class="button is-primary" onclick="closeAlertModal()">Á¢∫ÂÆö</button>
            </footer>
        </div>
    </div>

    <!-- Test Execution Modal -->
    <div class="modal" id="test-execution-modal">
        <div class="modal-background"></div>
        <div class="modal-card" style="width: 80%; max-width: 900px;">
            <header class="modal-card-head">
                <p class="modal-card-title">
                    <span class="icon"><i class="fas fa-play-circle"></i></span>
                    <span>Ê∏¨Ë©¶Âü∑Ë°å</span>
                </p>
                <button class="delete" onclick="closeTestModal()"></button>
            </header>
            <section class="modal-card-body">
                <!-- Test Mode Selector -->
                <div class="field">
                    <label class="label">Ê∏¨Ë©¶Ê®°Âºè</label>
                    <div class="control">
                        <div class="select is-fullwidth">
                            <select id="test-mode" onchange="updateTestModeDescription()">
                                <option value="simulation">Ê®°Êì¨Âü∑Ë°å (È†êË®≠)</option>
                                <option value="validation">È©óË≠âÊ®°Âºè (Ê™¢Êü•ÂáΩÊï∏ÂíåÂèÉÊï∏)</option>
                                <option value="api">API Ê∏¨Ë©¶Ê®°Âºè (ÂØ¶ÈöõË™øÁî®Ê∏¨Ë©¶ API)</option>
                            </select>
                        </div>
                    </div>
                    <p class="help" id="test-mode-description">
                        ‰ΩøÁî®È†êÂÆöÁæ©ÁöÑÊ®°Êì¨ÂÄºÂü∑Ë°åÊµÅÁ®ãÔºå‰∏çÈÄ≤Ë°åÂØ¶ÈöõÂáΩÊï∏Ë™øÁî®
                    </p>
                </div>

                <!-- Test Tabs -->
                <div class="tabs is-boxed">
                    <ul>
                        <li class="is-active">
                            <a onclick="switchTestTab('execution')">
                                <span class="icon is-small"><i class="fas fa-terminal"></i></span>
                                <span>Âü∑Ë°åÊó•Ë™å</span>
                            </a>
                        </li>
                        <li>
                            <a onclick="switchTestTab('variables')">
                                <span class="icon is-small"><i class="fas fa-database"></i></span>
                                <span>ËÆäÊï∏ÁãÄÊÖã</span>
                            </a>
                        </li>
                        <li>
                            <a onclick="switchTestTab('report')">
                                <span class="icon is-small"><i class="fas fa-chart-bar"></i></span>
                                <span>Ê∏¨Ë©¶Â†±Âëä</span>
                            </a>
                        </li>
                    </ul>
                </div>

                <!-- Tab Contents -->
                <div id="test-execution-tab" class="test-tab-content">
                    <div id="test-log">
                        <div class="has-text-grey">Ê∫ñÂÇôÂü∑Ë°åÊ∏¨Ë©¶...</div>
                    </div>
                </div>

                <div id="test-variables-tab" class="test-tab-content" style="display: none;">
                    <div id="test-variables" style="height: 400px; overflow-y: auto;">
                        <table class="table is-fullwidth is-striped">
                            <thead>
                                <tr>
                                    <th>ËÆäÊï∏ÂêçÁ®±</th>
                                    <th>È°ûÂûã</th>
                                    <th>ÂÄº</th>
                                    <th>‰æÜÊ∫ê</th>
                                </tr>
                            </thead>
                            <tbody id="test-variables-tbody">
                                <tr>
                                    <td colspan="4" class="has-text-grey has-text-centered">Â∞öÁÑ°ËÆäÊï∏</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div id="test-report-tab" class="test-tab-content" style="display: none;">
                    <div id="test-report" style="height: 400px; overflow-y: auto;">
                        <div class="notification is-info">
                            <p>Ê∏¨Ë©¶Â∞öÊú™Âü∑Ë°å</p>
                        </div>
                    </div>
                </div>
            </section>
            <footer class="modal-card-foot">
                <button class="button is-primary" id="run-test-button" onclick="runTest()">
                    <span class="icon"><i class="fas fa-play"></i></span>
                    <span>ÈñãÂßãÊ∏¨Ë©¶</span>
                </button>
                <button class="button is-danger" id="stop-test-button" onclick="stopTest()" style="display: none;">
                    <span class="icon"><i class="fas fa-stop"></i></span>
                    <span>ÂÅúÊ≠¢Ê∏¨Ë©¶</span>
                </button>
                <button class="button" onclick="closeTestModal()">ÈóúÈñâ</button>
            </footer>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/yaml/yaml.min.js"></script>
    <!-- CodeMirror Addons for folding and indentation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/foldcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/foldgutter.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/indent-fold.min.js"></script>
    <!-- CodeMirror Overlay Mode for custom highlighting -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/mode/overlay.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js"></script>
    <!-- Flow Store -->
    <script type="module" src="/static/store/flowStore.js?v=2.7"></script>
    <script src="/static/js/linearFlowDesigner.js?v=2.8" type="module"></script>
    
    <script>
        // Initialize flow data if provided
        const initialFlowData = {{ flow_data | safe if flow_data else 'null' }};
        const flowId = '{{ flow_id if flow_id else "" }}';
        
        // Wait for both DOM and module to be ready
        let domReady = false;
        let moduleReady = false;
        
        function tryInitialize() {
            if (domReady && moduleReady) {
                console.log('üéØ Initializing Linear Flow Designer');
                if (typeof window.initializeDesigner === 'function') {
                    window.initializeDesigner(initialFlowData, flowId);
                } else {
                    console.error('‚ùå initializeDesigner function not found');
                }
            }
        }
        
        // Wait for DOM content to be loaded
        document.addEventListener('DOMContentLoaded', function() {
            domReady = true;
            tryInitialize();
        });
        
        // Wait for module to be ready
        if (window.linearFlowDesignerReady) {
            moduleReady = true;
            tryInitialize();
        } else {
            window.addEventListener('linearFlowDesignerReady', function() {
                moduleReady = true;
                tryInitialize();
            });
        }
    </script>
{% endblock %}