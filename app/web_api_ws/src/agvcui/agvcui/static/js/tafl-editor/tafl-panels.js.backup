/**
 * TAFL Panels Integration
 * Èù¢ÊùøÁ≥ªÁµ± - CSS ÊéßÂà∂Ê®£ÂºèÔºåJS ÊéßÂà∂ÂäüËÉΩ
 */

import { taflFlowStore } from './tafl-editor-store.js';

class TAFLPanels {
    constructor() {
        this.panels = {};
        this.codeMirrorEditors = []; // Store CodeMirror instances for refresh
        this.initPanels();
        this.bindStoreEvents();
    }
    
    // ============================================
    // ÂàùÂßãÂåñÊâÄÊúâÈù¢Êùø
    // ============================================
    
    initPanels() {
        // Variables Èù¢Êùø - ÁèæÂú®Âú®Âè≥ÂÅ¥Èù¢Êùø‰∏≠
        const variablesContainer = document.getElementById('variables-list');
        if (variablesContainer) {
            this.panels.variables = variablesContainer;
            this.updateVariablesPanel();
            
            // Á∂ÅÂÆö Add Variable ÊåâÈàï‰∫ã‰ª∂
            const addVariableBtn = document.getElementById('add-variable-btn');
            if (addVariableBtn) {
                addVariableBtn.onclick = () => this.showAddVariableModal();
            }
        }
        
        // Settings Èù¢Êùø  
        const settingsContainer = document.getElementById('settings-panel');
        if (settingsContainer) {
            this.panels.settings = settingsContainer;
            this.updateSettingsPanel();
        }
        
        // Rules Èù¢Êùø
        const rulesContainer = document.getElementById('rules-panel');
        if (rulesContainer) {
            this.panels.rules = rulesContainer;
            this.updateRulesPanel();
            
            // Á∂ÅÂÆö Add Rule ÊåâÈàï‰∫ã‰ª∂
            const addRuleBtn = document.getElementById('add-rule-btn');
            if (addRuleBtn) {
                addRuleBtn.onclick = () => this.showAddRuleModal();
            }
        }
        
        // Preload Èù¢Êùø
        const preloadContainer = document.getElementById('preload-panel');
        if (preloadContainer) {
            this.panels.preload = preloadContainer;
            this.updatePreloadPanel();
            
            // Á∂ÅÂÆö Add Preload ÊåâÈàï‰∫ã‰ª∂
            const addPreloadBtn = document.getElementById('add-preload-btn');
            if (addPreloadBtn) {
                addPreloadBtn.onclick = () => this.showAddPreloadModal();
            }
        }
    }
    
    // ============================================
    // Store ‰∫ã‰ª∂Á∂ÅÂÆö
    // ============================================
    
    bindStoreEvents() {
        // Variables Êõ¥Êñ∞
        taflFlowStore.on('variables:changed', () => {
            console.log('üìå TAFLPanels received variables:changed event');
            this.updateVariablesPanel();
        });
        
        // Flow ËºâÂÖ•
        taflFlowStore.on('flow:loaded', () => {
            console.log('üìå TAFLPanels received flow:loaded event, updating all panels...');
            this.updateAllPanels();
        });
        
        // Flow Ê∏ÖÈô§
        taflFlowStore.on('flow:cleared', () => {
            console.log('üìå TAFLPanels received flow:cleared event, clearing all panels...');
            this.updateAllPanels();  // This will update with empty flow data
        });
        
        // Flow ÊîπËÆä
        taflFlowStore.on('flow:changed', () => {
            console.log('üìå TAFLPanels received flow:changed event');
            this.updateSettingsPanel();
            this.updateRulesPanel();
            this.updatePreloadPanel();
        });
    }
    
    // ============================================
    // Êõ¥Êñ∞ÊâÄÊúâÈù¢Êùø
    // ============================================
    
    updateAllPanels() {
        this.updateVariablesPanel();
        this.updateSettingsPanel();
        this.updateRulesPanel();
        this.updatePreloadPanel();
    }
    
    // ============================================
    // Variables Èù¢Êùø
    // ============================================
    
    updateVariablesPanel() {
        const container = this.panels.variables;
        console.log('üìå updateVariablesPanel called, container:', container);
        if (!container) {
            console.error('‚ùå Variables panel container not found!');
            return;
        }
        
        const variables = taflFlowStore.getFlow().variables || {};
        console.log('üìå Current variables:', variables);
        
        // Âè™Ê∏ÖÁ©∫ËÆäÊï∏ÂàóË°®Ôºå‰∏çÊ∏ÖÁ©∫Êï¥ÂÄãÂÆπÂô®
        // ‰øùÁïôÊ®ôÈ°å„ÄÅÊèèËø∞ÂíåÊåâÈàï
        let list = container;
        
        // Ê™¢Êü•ÊòØÂê¶Â∑≤Á∂ìÊúâ title Âíå description
        const hasTitle = container.querySelector('.title');
        if (hasTitle) {
            // Â¶ÇÊûúÊúâÊ®ôÈ°åÔºåË°®Á§∫ÈúÄË¶Å‰øùÁïôÁµêÊßãÔºåÂè™Ê∏ÖÁ©∫ËÆäÊï∏ÂàóË°®
            list = container.querySelector('#variables-list');
            if (!list) {
                // ÂâµÂª∫ËÆäÊï∏ÂàóË°®ÂÆπÂô®
                list = document.createElement('div');
                list.id = 'variables-list';
                list.className = 'variables-list';
                container.appendChild(list);
            }
            list.innerHTML = '';
        } else {
            // Ê≤íÊúâÊ®ôÈ°åÁöÑË©±ÔºåÊ∏ÖÁ©∫Êï¥ÂÄãÂÆπÂô®
            container.innerHTML = '';
            list = container;
        }
        
        // Ê∑ªÂä†ÊØèÂÄãËÆäÊï∏
        Object.entries(variables).forEach(([key, value]) => {
            console.log(`üìå Adding variable: ${key} = ${value}`);
            const item = this.createVariableItem(key, value);
            list.appendChild(item);
        });
        
        // Add Variable button is now in the HTML template and bound in initPanels()
        
        console.log('üìå Panel update complete, total variables:', Object.keys(variables).length);
    }
    
    createVariableItem(key, value) {
        // ‰ΩøÁî®Ëàá Rules Âíå Preload Áõ∏ÂêåÁöÑ box Ê®£Âºè
        const item = document.createElement('div');
        item.className = 'box';
        
        // È°ØÁ§∫ËÆäÊï∏ÂêçÁ®±ÂíåÂÄºÁöÑÈ†êË¶Ω
        const heading = document.createElement('p');
        heading.className = 'heading';
        // È°ØÁ§∫ËÆäÊï∏ÂêçÁ®±ÂíåÂÄºÁöÑÁ∞°Áü≠È†êË¶Ω
        let valuePreview = '';
        if (typeof value === 'object') {
            valuePreview = ' = {...}';
        } else if (typeof value === 'string') {
            valuePreview = ` = "${value.substring(0, 20)}${value.length > 20 ? '...' : ''}"`;
        } else {
            valuePreview = ` = ${String(value).substring(0, 30)}`;
        }
        heading.textContent = `${key}${valuePreview}`;
        item.appendChild(heading);
        
        // ÂâµÂª∫ÂèØÁ∑®ËºØÁöÑ textarea (Ëàá Rules/Preload Áõ∏Âêå)
        const control = document.createElement('div');
        control.className = 'control';
        
        const textarea = document.createElement('textarea');
        textarea.className = 'textarea is-small';
        textarea.rows = 3;
        textarea.value = typeof value === 'object' ? JSON.stringify(value, null, 2) : String(value);
        textarea.style.fontFamily = 'monospace';
        textarea.placeholder = 'Variable value';
        textarea.addEventListener('change', (e) => {
            try {
                const newValue = e.target.value.trim();
                // ÂòóË©¶Ëß£ÊûêÁÇ∫ JSONÔºåÂ¶ÇÊûúÂ§±ÊïóÂâáÁï∂‰ΩúÂ≠ó‰∏≤
                let parsedValue;
                try {
                    parsedValue = JSON.parse(newValue);
                } catch {
                    parsedValue = newValue;
                }
                
                const variables = taflFlowStore.getFlow().variables;
                variables[key] = parsedValue;
                taflFlowStore.updateVariables(variables);
                textarea.classList.remove('is-danger');
            } catch (error) {
                console.error('Error updating variable:', error);
                textarea.classList.add('is-danger');
            }
        });
        control.appendChild(textarea);
        item.appendChild(control);
        
        // ÊåâÈàïÁµÑ (Ëàá Rules/Preload Áõ∏ÂêåÁöÑÊ®£Âºè)
        const buttons = document.createElement('div');
        buttons.className = 'field is-grouped is-grouped-right';
        buttons.style.marginTop = '0.5rem';
        
        // Ê†ºÂºèÂåñÊåâÈàï
        const formatControl = document.createElement('p');
        formatControl.className = 'control';
        const formatBtn = document.createElement('button');
        formatBtn.className = 'button is-small is-info';
        formatBtn.onclick = () => {
            try {
                const value = textarea.value.trim();
                // ÂòóË©¶Ëß£Êûê‰∏¶Ê†ºÂºèÂåñ
                try {
                    const parsed = JSON.parse(value);
                    textarea.value = JSON.stringify(parsed, null, 2);
                } catch {
                    // Â¶ÇÊûú‰∏çÊòØ JSONÔºå‰øùÊåÅÂéüÊ®£
                    textarea.value = value;
                }
                textarea.classList.remove('is-danger');
            } catch (e) {
                console.error('Cannot format:', e);
            }
        };
        const formatIcon = document.createElement('span');
        formatIcon.className = 'icon';
        const formatI = document.createElement('i');
        formatI.className = 'fas fa-magic';
        formatIcon.appendChild(formatI);
        formatBtn.appendChild(formatIcon);
        const formatText = document.createElement('span');
        formatText.textContent = 'Format';
        formatBtn.appendChild(formatText);
        formatControl.appendChild(formatBtn);
        
        // Âà™Èô§ÊåâÈàï
        const deleteControl = document.createElement('p');
        deleteControl.className = 'control';
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'button is-small is-danger';
        deleteBtn.onclick = () => {
            if (confirm(`Delete variable "${key}"?`)) {
                const variables = { ...taflFlowStore.getFlow().variables };
                delete variables[key];
                taflFlowStore.updateVariables(variables);
            }
        };
        const deleteIcon = document.createElement('span');
        deleteIcon.className = 'icon';
        const deleteI = document.createElement('i');
        deleteI.className = 'fas fa-trash';
        deleteIcon.appendChild(deleteI);
        deleteBtn.appendChild(deleteIcon);
        const deleteText = document.createElement('span');
        deleteText.textContent = 'Delete';
        deleteBtn.appendChild(deleteText);
        deleteControl.appendChild(deleteBtn);
        
        buttons.appendChild(formatControl);
        buttons.appendChild(deleteControl);
        item.appendChild(buttons);
        
        return item;
    }
    
    // ============================================
    // Settings Èù¢Êùø
    // ============================================
    
    updateSettingsPanel() {
        const container = this.panels.settings;
        if (!container) return;
        
        const settings = taflFlowStore.getFlow().settings || {};
        
        // Êõ¥Êñ∞ÁèæÊúâÁöÑ HTML Ê¨Ñ‰ΩçÔºåËÄå‰∏çÊòØÂâµÂª∫Êñ∞ÁöÑ
        const timeoutInput = container.querySelector('#settings-timeout');
        if (timeoutInput) {
            timeoutInput.value = settings.timeout || 3600;
            // Âè™Á∂ÅÂÆö‰∏ÄÊ¨°‰∫ã‰ª∂
            if (!timeoutInput.dataset.bound) {
                timeoutInput.dataset.bound = 'true';
                timeoutInput.addEventListener('change', (e) => {
                    const flow = taflFlowStore.getFlow();
                    flow.settings = flow.settings || {};
                    flow.settings.timeout = parseInt(e.target.value, 10);
                    taflFlowStore.updateFlow(flow);
                });
            }
        }
        
        const maxRetriesInput = container.querySelector('#settings-max-retries');
        if (maxRetriesInput) {
            maxRetriesInput.value = settings.max_retries || 3;
            // Âè™Á∂ÅÂÆö‰∏ÄÊ¨°‰∫ã‰ª∂
            if (!maxRetriesInput.dataset.bound) {
                maxRetriesInput.dataset.bound = 'true';
                maxRetriesInput.addEventListener('change', (e) => {
                    const flow = taflFlowStore.getFlow();
                    flow.settings = flow.settings || {};
                    flow.settings.max_retries = parseInt(e.target.value, 10);
                    taflFlowStore.updateFlow(flow);
                });
            }
        }
        
        const retryCheckbox = container.querySelector('#settings-retry-on-failure');
        if (retryCheckbox) {
            retryCheckbox.checked = settings.retry_on_failure || false;
            // Âè™Á∂ÅÂÆö‰∏ÄÊ¨°‰∫ã‰ª∂
            if (!retryCheckbox.dataset.bound) {
                retryCheckbox.dataset.bound = 'true';
                retryCheckbox.addEventListener('change', (e) => {
                    const flow = taflFlowStore.getFlow();
                    flow.settings = flow.settings || {};
                    flow.settings.retry_on_failure = e.target.checked;
                    taflFlowStore.updateFlow(flow);
                });
            }
        }
    }
    
    // ============================================
    // Rules Èù¢Êùø
    // ============================================
    
    updateRulesPanel() {
        const container = this.panels.rules;
        if (!container) return;
        
        const rules = taflFlowStore.getFlow().rules || {};
        console.log('üìå Updating rules panel with:', rules);
        
        // ÊâæÂà∞ property-editor divÔºå‰øùÁïôÊ®ôÈ°åÂíåÊèèËø∞
        let propertyEditor = container.querySelector('.property-editor');
        if (!propertyEditor) {
            // Â¶ÇÊûúÊ≤íÊúâ property-editorÔºå‰ΩøÁî®Êï¥ÂÄãÂÆπÂô®
            propertyEditor = container;
        }
        
        // Âè™Ê∏ÖÁ©∫ rules-list ÁöÑÂÖßÂÆπÔºå‰øùÁïôÊ®ôÈ°å
        let list = propertyEditor.querySelector('.rules-list');
        if (!list) {
            // Â¶ÇÊûúÊ≤íÊúâ listÔºåÂâµÂª∫‰∏ÄÂÄã
            list = document.createElement('div');
            list.className = 'rules-list';
            propertyEditor.appendChild(list);
        }
        list.innerHTML = '';
        
        // Ê∑ªÂä†ÊâÄÊúâË¶èÂâáÈ†ÖÁõÆ
        Object.entries(rules).forEach(([key, value]) => {
            const item = this.createRuleItem(key, value);
            list.appendChild(item);
        });
        
        // Add Rule button is now in HTML and bound in initPanels()
    }
    
    createRuleItem(key, value) {
        // ‰ΩøÁî®Ëàá Preload Áõ∏ÂêåÁöÑ box Ê®£Âºè - ‰∏çË¶ÅÊ∑ªÂä†ÂÖßËÅØÊ®£Âºè
        const item = document.createElement('div');
        item.className = 'box';
        
        // ‰∏çÈ°ØÁ§∫ÁÑ°ÊÑèÁæ©ÁöÑÁ¥¢ÂºïÔºåÊîπÁÇ∫È°ØÁ§∫Ë¶èÂâáÂÖßÂÆπÈ†êË¶Ω
        const heading = document.createElement('p');
        heading.className = 'heading';
        // È°ØÁ§∫Ë¶èÂâáÁöÑÊèèËø∞ÊàñÊ¢ù‰ª∂
        let title = 'Rule';
        if (value && typeof value === 'object') {
            if (value.name) {
                title = value.name;
            } else if (value.description) {
                title = value.description;
            } else if (value.condition) {
                // È°ØÁ§∫Ê¢ù‰ª∂ÁöÑÁ∞°Áü≠ÁâàÊú¨
                title = `When: ${String(value.condition).substring(0, 30)}...`;
            }
        } else if (typeof value === 'string') {
            // Â¶ÇÊûúË¶èÂâáÊòØÂ≠óÁ¨¶‰∏≤ÔºåÈ°ØÁ§∫Ââç30ÂÄãÂ≠óÁ¨¶
            title = value.substring(0, 30) + (value.length > 30 ? '...' : '');
        }
        heading.textContent = title;
        item.appendChild(heading);
        
        // ÂâµÂª∫ÂèØÁ∑®ËºØÁöÑ textarea (Ëàá Preload Áõ∏Âêå)
        const control = document.createElement('div');
        control.className = 'control';
        
        const textarea = document.createElement('textarea');
        textarea.className = 'textarea is-small';
        textarea.rows = 4;
        textarea.value = typeof value === 'object' ? JSON.stringify(value, null, 2) : String(value);
        textarea.style.fontFamily = 'monospace';
        textarea.addEventListener('change', (e) => {
            try {
                const newValue = e.target.value.trim();
                // ÂòóË©¶Ëß£ÊûêÁÇ∫ JSONÔºåÂ¶ÇÊûúÂ§±ÊïóÂâáÁï∂‰ΩúÂ≠ó‰∏≤
                let parsedValue;
                try {
                    parsedValue = JSON.parse(newValue);
                } catch {
                    parsedValue = newValue;
                }
                
                const flow = taflFlowStore.getFlow();
                flow.rules = flow.rules || {};
                flow.rules[key] = parsedValue;
                taflFlowStore.updateFlow(flow);
                textarea.classList.remove('is-danger');
            } catch (error) {
                console.error('Error updating rule:', error);
                textarea.classList.add('is-danger');
            }
        });
        control.appendChild(textarea);
        item.appendChild(control);
        
        // ÊåâÈàïÁµÑ (Ëàá Preload Áõ∏ÂêåÁöÑÊ®£Âºè)
        const buttons = document.createElement('div');
        buttons.className = 'field is-grouped is-grouped-right';
        buttons.style.marginTop = '0.5rem';
        
        // Ê†ºÂºèÂåñÊåâÈàï
        const formatControl = document.createElement('p');
        formatControl.className = 'control';
        const formatBtn = document.createElement('button');
        formatBtn.className = 'button is-small is-info';
        formatBtn.onclick = () => {
            try {
                const value = textarea.value.trim();
                // ÂòóË©¶Ëß£Êûê‰∏¶Ê†ºÂºèÂåñ
                try {
                    const parsed = JSON.parse(value);
                    textarea.value = JSON.stringify(parsed, null, 2);
                } catch {
                    // Â¶ÇÊûú‰∏çÊòØ JSONÔºå‰øùÊåÅÂéüÊ®£
                    textarea.value = value;
                }
                textarea.classList.remove('is-danger');
            } catch (e) {
                console.error('Cannot format:', e);
            }
        };
        const formatIcon = document.createElement('span');
        formatIcon.className = 'icon';
        const formatI = document.createElement('i');
        formatI.className = 'fas fa-magic';
        formatIcon.appendChild(formatI);
        formatBtn.appendChild(formatIcon);
        const formatText = document.createElement('span');
        formatText.textContent = 'Format';
        formatBtn.appendChild(formatText);
        formatControl.appendChild(formatBtn);
        
        // Âà™Èô§ÊåâÈàï
        const deleteControl = document.createElement('p');
        deleteControl.className = 'control';
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'button is-small is-danger';
        deleteBtn.onclick = () => {
            if (confirm(`Delete rule "${key}"?`)) {
                const flow = taflFlowStore.getFlow();
                delete flow.rules[key];
                taflFlowStore.updateFlow(flow);
            }
        };
        const deleteIcon = document.createElement('span');
        deleteIcon.className = 'icon';
        const deleteI = document.createElement('i');
        deleteI.className = 'fas fa-trash';
        deleteIcon.appendChild(deleteI);
        deleteBtn.appendChild(deleteIcon);
        const deleteText = document.createElement('span');
        deleteText.textContent = 'Delete';
        deleteBtn.appendChild(deleteText);
        deleteControl.appendChild(deleteBtn);
        
        buttons.appendChild(formatControl);
        buttons.appendChild(deleteControl);
        item.appendChild(buttons);
        
        return item;
    }
    
    // ============================================
    // Preload Èù¢Êùø
    // ============================================
    
    updatePreloadPanel() {
        const container = this.panels.preload;
        if (!container) return;
        
        // Clear stored CodeMirror editors
        this.codeMirrorEditors = [];
        
        const preload = taflFlowStore.getFlow().preload || {};
        console.log('üìå Updating preload panel with:', preload);
        
        // ÊâæÂà∞ property-editor divÔºå‰øùÁïôÊ®ôÈ°åÂíåÊèèËø∞
        let propertyEditor = container.querySelector('.property-editor');
        if (!propertyEditor) {
            propertyEditor = container;
        }
        
        // Âè™Ê∏ÖÁ©∫ preload-list ÁöÑÂÖßÂÆπÔºå‰øùÁïôÊ®ôÈ°å
        let list = propertyEditor.querySelector('.preload-list');
        if (!list) {
            list = document.createElement('div');
            list.className = 'preload-list';
            propertyEditor.appendChild(list);
        }
        list.innerHTML = '';
        
        // ÂâµÂª∫ preload È†ÖÁõÆ
        Object.entries(preload).forEach(([key, value]) => {
            const item = this.createPreloadItem(key, value);
            list.appendChild(item);
        });
        
        // Add Preload button is now in HTML and bound in initPanels()
    }
    
    createPreloadItem(key, value) {
        const item = document.createElement('div');
        item.className = 'box';
        
        // È°ØÁ§∫ key ‰ΩúÁÇ∫Ê®ôÈ°åÔºå‰∏¶Âä†‰∏äË≥áÊñôÁöÑË£úÂÖÖË≥áË®ä
        const heading = document.createElement('p');
        heading.className = 'heading';
        // ‰ΩøÁî® key ‰ΩúÁÇ∫‰∏ªË¶ÅÊ®ôÈ°åÔºå‰∏çË¶ÅÈ°ØÁ§∫ #0, #1 ÈÄôÁ®Æ
        let title = key;  // Áõ¥Êé•‰ΩøÁî® key
        if (value && typeof value === 'object') {
            if (value.name) {
                title = `${key}: ${value.name}`;
            } else if (value.id) {
                title = `${key} (ID: ${value.id})`;
            } else if (value.type) {
                title = `${key} (${value.type})`;
            }
            // ‰∏çÂÜçÈ°ØÁ§∫ Data #0 ÈÄôÁ®ÆÁÑ°ÊÑèÁæ©ÁöÑÁ¥¢Âºï
        }
        heading.textContent = title;
        item.appendChild(heading);
        
        // ÂâµÂª∫ CodeMirror Á∑®ËºØÂô®ÂÆπÂô®
        const control = document.createElement('div');
        control.className = 'control';
        
        const editorContainer = document.createElement('div');
        editorContainer.style.border = '1px solid #dbdbdb';
        editorContainer.style.borderRadius = '4px';
        control.appendChild(editorContainer);
        item.appendChild(control);
        
        // Á´ãÂç≥ÂàùÂßãÂåñ CodeMirror Á∑®ËºØÂô®Ôºà‰∏çÂª∂ÈÅ≤Ôºâ
        const editor = CodeMirror(editorContainer, {
                value: JSON.stringify(value, null, 2),
                mode: 'application/json',
                theme: 'default',
                lineNumbers: true,
                lineWrapping: true,
                matchBrackets: true,
                autoCloseBrackets: true,
                foldGutter: true,
                gutters: ['CodeMirror-linenumbers', 'CodeMirror-foldgutter'],
                extraKeys: {
                    'Ctrl-Space': 'autocomplete',
                    'Ctrl-F': function(cm) {
                        // Ê†ºÂºèÂåñ JSON
                        try {
                            const parsed = JSON.parse(cm.getValue());
                            cm.setValue(JSON.stringify(parsed, null, 2));
                        } catch (e) {
                            console.error('Invalid JSON:', e);
                        }
                    }
                }
            });
            
            // Ë®≠ÁΩÆÁ∑®ËºØÂô®È´òÂ∫¶
            editor.setSize(null, '120px');
            
            // Store editor reference for later refresh
            this.codeMirrorEditors.push(editor);
            
            // Force refresh after a small delay to ensure proper rendering
            setTimeout(() => {
                editor.refresh();
            }, 100);
            
        // ‰ΩøÁî®Èò≤Êäñ‰æÜÈÅøÂÖçÈ†ªÁπÅÊõ¥Êñ∞
        let updateTimeout = null;
        let lastSavedValue = JSON.stringify(value);
        
        editor.on('change', (cm) => {
            // Ê∏ÖÈô§‰πãÂâçÁöÑ timeout
            if (updateTimeout) {
                clearTimeout(updateTimeout);
            }
            
            // Á´ãÂç≥Êõ¥Êñ∞ÈåØË™§ÁãÄÊÖãÔºà‰∏çÂª∂ÈÅ≤Ôºâ
            try {
                JSON.parse(cm.getValue());
                editorContainer.classList.remove('has-error');
            } catch (error) {
                editorContainer.classList.add('has-error');
                return;  // JSON ÁÑ°ÊïàÂ∞±‰∏çÊõ¥Êñ∞
            }
            
            // Âª∂ÈÅ≤Êõ¥Êñ∞ storeÔºàÈò≤Êäñ 800msÔºâ
            updateTimeout = setTimeout(() => {
                try {
                    const newValue = JSON.parse(cm.getValue());
                    const newValueStr = JSON.stringify(newValue);
                    
                    // Âè™Âú®ÂÄºÁúüÊ≠£ÊîπËÆäÊôÇÊõ¥Êñ∞
                    if (lastSavedValue !== newValueStr) {
                        lastSavedValue = newValueStr;
                        const flow = taflFlowStore.getFlow();
                        flow.preload = flow.preload || {};
                        flow.preload[key] = newValue;
                        
                        // Áõ¥Êé•Êõ¥Êñ∞ storeÔºå‰∏çËß∏ÁôºÂÆåÊï¥ UI ÈáçÊñ∞Ê∏≤Êüì
                        taflFlowStore.setFlow(flow);
                        taflFlowStore.markDirty();
                        
                        // Êõ¥Êñ∞Ê®ôÈ°å
                        let newTitle = key;
                        if (newValue && typeof newValue === 'object') {
                            if (newValue.name) {
                                newTitle = `${key}: ${newValue.name}`;
                            } else if (newValue.id) {
                                newTitle = `${key} (ID: ${newValue.id})`;
                            } else if (newValue.type) {
                                newTitle = `${key} (${newValue.type})`;
                            }
                        }
                        heading.textContent = newTitle;
                    }
                } catch (error) {
                    // JSON ÁÑ°ÊïàÊôÇ‰∏çÊõ¥Êñ∞
                }
            }, 800);  // 800ms Èò≤ÊäñÂª∂ÈÅ≤
        });
        
        // ‰øùÂ≠òÁ∑®ËºØÂô®ÂØ¶‰æã
        item.dataset.editor = 'cm';
        item.cmEditor = editor;
        
        // Á¢∫‰øù CodeMirror Ê≠£Á¢∫Ê∏≤Êüì
        requestAnimationFrame(() => {
            editor.refresh();
        });
        
        // ÊåâÈàïÁµÑ
        const buttons = document.createElement('div');
        buttons.className = 'field is-grouped is-grouped-right';
        buttons.style.marginTop = '0.5rem';
        
        // Ê†ºÂºèÂåñÊåâÈàï
        const formatControl = document.createElement('p');
        formatControl.className = 'control';
        const formatBtn = document.createElement('button');
        formatBtn.className = 'button is-small is-info';
        formatBtn.onclick = () => {
            if (item.cmEditor) {
                try {
                    const parsed = JSON.parse(item.cmEditor.getValue());
                    item.cmEditor.setValue(JSON.stringify(parsed, null, 2));
                } catch (e) {
                    console.error('Cannot format invalid JSON');
                }
            }
        };
        const formatIcon = document.createElement('span');
        formatIcon.className = 'icon';
        const formatI = document.createElement('i');
        formatI.className = 'fas fa-magic';
        formatIcon.appendChild(formatI);
        formatBtn.appendChild(formatIcon);
        const formatText = document.createElement('span');
        formatText.textContent = 'Format';
        formatBtn.appendChild(formatText);
        formatControl.appendChild(formatBtn);
        
        // Âà™Èô§ÊåâÈàï
        const deleteControl = document.createElement('p');
        deleteControl.className = 'control';
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'button is-small is-danger';
        deleteBtn.onclick = () => {
            if (confirm(`Delete preload data "${key}"?`)) {
                const flow = taflFlowStore.getFlow();
                delete flow.preload[key];
                taflFlowStore.updateFlow(flow);
            }
        };
        const deleteIcon = document.createElement('span');
        deleteIcon.className = 'icon';
        const deleteI = document.createElement('i');
        deleteI.className = 'fas fa-trash';
        deleteIcon.appendChild(deleteI);
        deleteBtn.appendChild(deleteIcon);
        const deleteText = document.createElement('span');
        deleteText.textContent = 'Delete';
        deleteBtn.appendChild(deleteText);
        deleteControl.appendChild(deleteBtn);
        
        buttons.appendChild(formatControl);
        buttons.appendChild(deleteControl);
        item.appendChild(buttons);
        
        return item;
    }
    
    // ============================================
    // CodeMirror Refresh Method
    // ============================================
    
    refreshCodeMirrors() {
        // Refresh all CodeMirror instances
        this.codeMirrorEditors.forEach(editor => {
            if (editor && typeof editor.refresh === 'function') {
                editor.refresh();
            }
        });
    }
    
    // ============================================
    // ËºîÂä©ÊñπÊ≥ï - ÂâµÂª∫Ê¨Ñ‰Ωç
    // ============================================
    
    createTextField(label, value, onChange) {
        const field = document.createElement('div');
        field.className = 'field';
        
        const labelEl = document.createElement('label');
        labelEl.className = 'label';
        labelEl.textContent = label;
        
        const control = document.createElement('div');
        control.className = 'control';
        
        const textarea = document.createElement('textarea');
        textarea.className = 'textarea';
        textarea.value = value;
        textarea.addEventListener('change', (e) => onChange(e.target.value));
        
        control.appendChild(textarea);
        field.appendChild(labelEl);
        field.appendChild(control);
        
        return field;
    }
    
    createNumberField(label, value, onChange) {
        const field = document.createElement('div');
        field.className = 'field';
        
        const labelEl = document.createElement('label');
        labelEl.className = 'label';
        labelEl.textContent = label;
        
        const control = document.createElement('div');
        control.className = 'control';
        
        const input = document.createElement('input');
        input.className = 'input';
        input.type = 'number';
        input.value = value;
        input.addEventListener('change', (e) => onChange(e.target.value));
        
        control.appendChild(input);
        field.appendChild(labelEl);
        field.appendChild(control);
        
        return field;
    }
    
    createCheckboxField(label, checked, onChange) {
        const field = document.createElement('div');
        field.className = 'field';
        
        const control = document.createElement('div');
        control.className = 'control';
        
        const labelEl = document.createElement('label');
        labelEl.className = 'checkbox';
        
        const input = document.createElement('input');
        input.type = 'checkbox';
        input.checked = checked;
        input.addEventListener('change', (e) => onChange(e.target.checked));
        
        labelEl.appendChild(input);
        labelEl.appendChild(document.createTextNode(' ' + label));
        control.appendChild(labelEl);
        field.appendChild(control);
        
        return field;
    }
    
    createAddButton(text, onClick) {
        const div = document.createElement('div');
        div.className = 'panel-block';
        
        const btn = document.createElement('button');
        btn.className = 'button is-primary is-fullwidth';
        btn.onclick = onClick;
        
        const icon = document.createElement('span');
        icon.className = 'icon';
        const i = document.createElement('i');
        i.className = 'fas fa-plus';
        icon.appendChild(i);
        
        const span = document.createElement('span');
        span.textContent = text;
        
        btn.appendChild(icon);
        btn.appendChild(span);
        div.appendChild(btn);
        
        return div;
    }
    
    // ============================================
    // Modal Dialogs  
    // ============================================
    
    showAddVariableModal() {
        const modal = this.createModal('Add Variable', (modalEl) => {
            const body = modalEl.querySelector('.modal-card-body');
            
            // Name field
            const nameField = document.createElement('div');
            nameField.className = 'field';
            nameField.innerHTML = `
                <label class="label">Variable Name</label>
                <div class="control">
                    <input class="input" type="text" id="modal-var-name" placeholder="e.g., counter">
                </div>
            `;
            body.appendChild(nameField);
            
            // Value field
            const valueField = document.createElement('div');
            valueField.className = 'field';
            valueField.innerHTML = `
                <label class="label">Initial Value</label>
                <div class="control">
                    <input class="input" type="text" id="modal-var-value" placeholder="e.g., 0">
                </div>
            `;
            body.appendChild(valueField);
            
            // Save button
            const saveBtn = modalEl.querySelector('.modal-save-btn');
            saveBtn.onclick = () => {
                const name = document.getElementById('modal-var-name').value.trim();
                const value = document.getElementById('modal-var-value').value.trim();
                
                if (!name) {
                    alert('Please enter a variable name');
                    return;
                }
                
                const flow = taflFlowStore.getFlow();
                flow.variables = flow.variables || {};
                
                if (flow.variables[name] !== undefined) {
                    if (!confirm(`Variable "${name}" already exists. Replace it?`)) {
                        return;
                    }
                }
                
                flow.variables[name] = value || '';
                taflFlowStore.updateVariables(flow.variables);
                modalEl.remove();
            };
        });
    }
    
    showAddRuleModal() {
        const modal = this.createModal('Add Business Rule', (modalEl) => {
            const body = modalEl.querySelector('.modal-card-body');
            
            // Name field
            const nameField = document.createElement('div');
            nameField.className = 'field';
            nameField.innerHTML = `
                <label class="label">Rule Name</label>
                <div class="control">
                    <input class="input" type="text" id="modal-rule-name" placeholder="e.g., max_retries">
                </div>
            `;
            body.appendChild(nameField);
            
            // Type field
            const typeField = document.createElement('div');
            typeField.className = 'field';
            typeField.innerHTML = `
                <label class="label">Rule Type</label>
                <div class="control">
                    <div class="select is-fullwidth">
                        <select id="modal-rule-type">
                            <option value="string">String</option>
                            <option value="number">Number</option>
                            <option value="boolean">Boolean</option>
                            <option value="object">Object (JSON)</option>
                        </select>
                    </div>
                </div>
            `;
            body.appendChild(typeField);
            
            // Value field
            const valueField = document.createElement('div');
            valueField.className = 'field';
            valueField.innerHTML = `
                <label class="label">Rule Value</label>
                <div class="control">
                    <input class="input" type="text" id="modal-rule-value" placeholder="Enter value">
                </div>
            `;
            body.appendChild(valueField);
            
            // Object field (hidden by default)
            const objectField = document.createElement('div');
            objectField.className = 'field';
            objectField.style.display = 'none';
            objectField.innerHTML = `
                <label class="label">JSON Object</label>
                <div class="control">
                    <textarea class="textarea" id="modal-rule-object" rows="4" placeholder='{"key": "value"}'></textarea>
                </div>
            `;
            body.appendChild(objectField);
            
            // Type change handler
            document.getElementById('modal-rule-type').onchange = (e) => {
                if (e.target.value === 'object') {
                    valueField.style.display = 'none';
                    objectField.style.display = 'block';
                } else {
                    valueField.style.display = 'block';
                    objectField.style.display = 'none';
                }
            };
            
            // Save button
            const saveBtn = modalEl.querySelector('.modal-save-btn');
            saveBtn.onclick = () => {
                const name = document.getElementById('modal-rule-name').value.trim();
                const type = document.getElementById('modal-rule-type').value;
                
                if (!name) {
                    alert('Please enter a rule name');
                    return;
                }
                
                let value;
                if (type === 'object') {
                    const objText = document.getElementById('modal-rule-object').value.trim();
                    try {
                        value = objText ? JSON.parse(objText) : {};
                    } catch (e) {
                        alert('Invalid JSON format');
                        return;
                    }
                } else {
                    const rawValue = document.getElementById('modal-rule-value').value.trim();
                    if (type === 'number') {
                        value = Number(rawValue);
                        if (isNaN(value)) {
                            alert('Please enter a valid number');
                            return;
                        }
                    } else if (type === 'boolean') {
                        value = rawValue.toLowerCase() === 'true';
                    } else {
                        value = rawValue;
                    }
                }
                
                const flow = taflFlowStore.getFlow();
                flow.rules = flow.rules || {};
                
                if (flow.rules[name] !== undefined) {
                    if (!confirm(`Rule "${name}" already exists. Replace it?`)) {
                        return;
                    }
                }
                
                flow.rules[name] = value;
                taflFlowStore.updateFlow(flow);
                modalEl.remove();
            };
        });
    }
    
    showAddPreloadModal() {
        const modal = this.createModal('Add Preload Query', (modalEl) => {
            const body = modalEl.querySelector('.modal-card-body');
            
            // Variable name field
            const nameField = document.createElement('div');
            nameField.className = 'field';
            nameField.innerHTML = `
                <label class="label">Store As (Variable Name)</label>
                <div class="control">
                    <input class="input" type="text" id="modal-preload-name" placeholder="e.g., available_locations">
                </div>
                <p class="help">This will be the variable name you can use in the flow</p>
            `;
            body.appendChild(nameField);
            
            // Target field
            const targetField = document.createElement('div');
            targetField.className = 'field';
            targetField.innerHTML = `
                <label class="label">Query Target</label>
                <div class="control">
                    <div class="select is-fullwidth">
                        <select id="modal-preload-target">
                            <option value="locations">locations</option>
                            <option value="racks">racks</option>
                            <option value="tasks">tasks</option>
                            <option value="agvs">agvs</option>
                            <option value="products">products</option>
                        </select>
                    </div>
                </div>
            `;
            body.appendChild(targetField);
            
            // Where conditions field
            const whereField = document.createElement('div');
            whereField.className = 'field';
            whereField.innerHTML = `
                <label class="label">Where Conditions (Optional)</label>
                <div class="control">
                    <input class="input" type="text" id="modal-preload-where" placeholder="e.g., status: active, room_id: 1">
                </div>
                <p class="help">Format: key: value, key2: value2</p>
            `;
            body.appendChild(whereField);
            
            // Save button
            const saveBtn = modalEl.querySelector('.modal-save-btn');
            saveBtn.onclick = () => {
                const name = document.getElementById('modal-preload-name').value.trim();
                const target = document.getElementById('modal-preload-target').value;
                const whereStr = document.getElementById('modal-preload-where').value.trim();
                
                if (!name) {
                    alert('Please enter a variable name');
                    return;
                }
                
                // Parse where conditions
                const where = {};
                if (whereStr) {
                    const pairs = whereStr.split(',');
                    pairs.forEach(pair => {
                        const [key, value] = pair.split(':').map(s => s.trim());
                        if (key && value) {
                            where[key] = value;
                        }
                    });
                }
                
                const flow = taflFlowStore.getFlow();
                flow.preload = flow.preload || {};
                
                if (flow.preload[name] !== undefined) {
                    if (!confirm(`Preload "${name}" already exists. Replace it?`)) {
                        return;
                    }
                }
                
                flow.preload[name] = {
                    query: {
                        target: target,
                        ...(Object.keys(where).length > 0 && { where: where })
                    }
                };
                
                taflFlowStore.updateFlow(flow);
                modalEl.remove();
            };
        });
    }
    
    createModal(title, setupCallback) {
        const modal = document.createElement('div');
        modal.className = 'modal is-active';
        modal.innerHTML = `
            <div class="modal-background" onclick="this.parentElement.remove()"></div>
            <div class="modal-card">
                <header class="modal-card-head">
                    <p class="modal-card-title">${title}</p>
                    <button class="delete" aria-label="close" onclick="this.parentElement.parentElement.parentElement.remove()"></button>
                </header>
                <section class="modal-card-body">
                    <!-- Content will be added dynamically -->
                </section>
                <footer class="modal-card-foot">
                    <button class="button is-primary modal-save-btn">Save</button>
                    <button class="button" onclick="this.parentElement.parentElement.parentElement.remove()">Cancel</button>
                </footer>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        // Call setup callback to populate modal content
        setupCallback(modal);
        
        // Focus first input
        setTimeout(() => {
            const firstInput = modal.querySelector('input, select, textarea');
            if (firstInput) firstInput.focus();
        }, 100);
        
        return modal;
    }
}

// Ëá™ÂãïÂàùÂßãÂåñ
export const taflPanels = new TAFLPanels();
console.log('‚úÖ TAFL Panels initialized - CSS for style, JS for function');