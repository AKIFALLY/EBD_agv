<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phase 4.2.2: Advanced Canvas Rendering æ¸¬è©¦</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-section {
            margin-bottom: 30px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 15px;
        }
        .test-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
            display: flex;
            align-items: center;
        }
        .test-title .icon {
            margin-right: 8px;
            font-size: 20px;
        }
        .test-result {
            padding: 10px;
            border-radius: 4px;
            margin: 5px 0;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .canvas-container {
            width: 100%;
            height: 400px;
            border: 2px solid #ccc;
            border-radius: 6px;
            position: relative;
            margin: 15px 0;
            background: #f9f9f9;
        }
        .performance-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        .metric-box {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #007bff;
            text-align: center;
        }
        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
        }
        .metric-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        .control-panel {
            background: #f1f3f4;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
        }
        .control-group {
            display: flex;
            align-items: center;
            gap: 15px;
            margin: 10px 0;
        }
        .control-group label {
            font-weight: bold;
            min-width: 120px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background: #0056b3;
        }
        button.danger {
            background: #dc3545;
        }
        button.danger:hover {
            background: #c82333;
        }
        button.success {
            background: #28a745;
        }
        button.success:hover {
            background: #1e7e34;
        }
        select, input[type="range"], input[type="number"] {
            padding: 5px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        #test-log {
            background: #2d2d2d;
            color: #f0f0f0;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .render-mode-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            color: white;
            margin-left: 10px;
        }
        .render-mode-badge.dom { background: #48cae4; }
        .render-mode-badge.canvas { background: #f77f00; }
        .render-mode-badge.webgl { background: #fcbf49; }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>ğŸ¨ Phase 4.2.2: Advanced Canvas Rendering æ¸¬è©¦</h1>
        <p>æ¸¬è©¦ Flow Designer çš„ Canvas 2D å’Œ WebGL æ¸²æŸ“å¼•æ“æ•ˆèƒ½èˆ‡åŠŸèƒ½</p>
        
        <!-- æ¸²æŸ“å¼•æ“åˆå§‹åŒ– -->
        <div class="test-section">
            <div class="test-title">
                <span class="icon">ğŸš€</span>
                1. æ¸²æŸ“å¼•æ“åˆå§‹åŒ–æ¸¬è©¦
                <span id="current-mode-badge" class="render-mode-badge dom">DOM</span>
            </div>
            <div id="renderer-init-results"></div>
            
            <div class="control-panel">
                <div class="control-group">
                    <label>æ¸²æŸ“æ¨¡å¼:</label>
                    <select id="rendering-mode">
                        <option value="dom">DOM æ¸²æŸ“</option>
                        <option value="canvas">Canvas 2D</option>
                        <option value="webgl">WebGL (å¦‚æ”¯æ´)</option>
                    </select>
                    <button onclick="switchRenderingMode()">åˆ‡æ›æ¨¡å¼</button>
                </div>
                <div class="control-group">
                    <label>ç¯€é»æ•¸é‡:</label>
                    <input type="range" id="node-count" min="10" max="500" value="50" step="10">
                    <span id="node-count-value">50</span>
                    <button onclick="generateTestNodes()">ç”Ÿæˆæ¸¬è©¦ç¯€é»</button>
                </div>
                <div class="control-group">
                    <label>è¦–çª—è£å‰ª:</label>
                    <input type="checkbox" id="viewport-culling" checked>
                    <label>é«˜ DPI:</label>
                    <input type="checkbox" id="high-dpi" checked>
                    <label>æŠ—é‹¸é½’:</label>
                    <input type="checkbox" id="antialiasing" checked>
                </div>
            </div>
        </div>
        
        <!-- Canvas æ¸²æŸ“æ¸¬è©¦ -->
        <div class="test-section">
            <div class="test-title">
                <span class="icon">ğŸ¨</span>
                2. Canvas æ¸²æŸ“æ•ˆèƒ½æ¸¬è©¦
            </div>
            <div class="canvas-container">
                <canvas id="test-canvas" style="width: 100%; height: 100%; display: block;"></canvas>
                <div id="render-stats" class="performance-stats-overlay" style="display: none;">
                    <div class="stat-line">
                        <span class="stat-label">FPS:</span>
                        <span class="stat-value" id="fps-value">0</span>
                    </div>
                    <div class="stat-line">
                        <span class="stat-label">æ¸²æŸ“æ™‚é–“:</span>
                        <span class="stat-value" id="render-time-value">0ms</span>
                    </div>
                    <div class="stat-line">
                        <span class="stat-label">ç¯€é»æ•¸:</span>
                        <span class="stat-value" id="nodes-rendered-value">0</span>
                    </div>
                    <div class="stat-line">
                        <span class="stat-label">å¿«å–å‘½ä¸­:</span>
                        <span class="stat-value" id="cache-hit-value">0%</span>
                    </div>
                </div>
            </div>
            
            <div class="control-panel">
                <button onclick="startRenderTest()" class="success">é–‹å§‹æ¸²æŸ“æ¸¬è©¦</button>
                <button onclick="stopRenderTest()" class="danger">åœæ­¢æ¸¬è©¦</button>
                <button onclick="clearCanvas()">æ¸…é™¤ç•«å¸ƒ</button>
                <button onclick="toggleStats()">é¡¯ç¤º/éš±è—çµ±è¨ˆ</button>
            </div>
        </div>
        
        <!-- æ•ˆèƒ½æŒ‡æ¨™ -->
        <div class="test-section">
            <div class="test-title">
                <span class="icon">ğŸ“Š</span>
                3. æ•ˆèƒ½æŒ‡æ¨™ç›£æ§
            </div>
            <div class="performance-metrics">
                <div class="metric-box">
                    <div class="metric-value" id="avg-fps">0</div>
                    <div class="metric-label">å¹³å‡ FPS</div>
                </div>
                <div class="metric-box">
                    <div class="metric-value" id="avg-render-time">0</div>
                    <div class="metric-label">å¹³å‡æ¸²æŸ“æ™‚é–“ (ms)</div>
                </div>
                <div class="metric-box">
                    <div class="metric-value" id="cache-efficiency">0</div>
                    <div class="metric-label">å¿«å–æ•ˆç‡ (%)</div>
                </div>
                <div class="metric-box">
                    <div class="metric-value" id="memory-usage">0</div>
                    <div class="metric-label">è¨˜æ†¶é«”ä½¿ç”¨ (MB)</div>
                </div>
            </div>
        </div>
        
        <!-- åŠŸèƒ½æ¸¬è©¦ -->
        <div class="test-section">
            <div class="test-title">
                <span class="icon">ğŸ§ª</span>
                4. åŠŸèƒ½æ¸¬è©¦
            </div>
            <div id="feature-test-results"></div>
            
            <div class="control-panel">
                <button onclick="testNodeRendering()">æ¸¬è©¦ç¯€é»æ¸²æŸ“</button>
                <button onclick="testConnectionRendering()">æ¸¬è©¦é€£æ¥ç·šæ¸²æŸ“</button>
                <button onclick="testViewportCulling()">æ¸¬è©¦è¦–çª—è£å‰ª</button>
                <button onclick="testCacheSystem()">æ¸¬è©¦å¿«å–ç³»çµ±</button>
                <button onclick="runAllTests()">åŸ·è¡Œæ‰€æœ‰æ¸¬è©¦</button>
            </div>
        </div>
        
        <!-- æ¸¬è©¦æ—¥èªŒ -->
        <div class="test-section">
            <div class="test-title">
                <span class="icon">ğŸ“‹</span>
                5. æ¸¬è©¦æ—¥èªŒ
            </div>
            <div id="test-log"></div>
            <div class="control-panel">
                <button onclick="clearLog()">æ¸…é™¤æ—¥èªŒ</button>
                <button onclick="exportResults()">åŒ¯å‡ºæ¸¬è©¦çµæœ</button>
            </div>
        </div>
    </div>

    <!-- è¼‰å…¥ Advanced Rendering ä¾è³´ -->
    <script src="/static/js/flowDesignerPage.js?v=4.2.2"></script>
    
    <script>
        // æ¸¬è©¦è®Šæ•¸
        let testRenderer = null;
        let testNodes = [];
        let testConnections = [];
        let isRenderTestRunning = false;
        let renderTestInterval = null;
        let performanceHistory = [];
        
        // æ¸¬è©¦æ—¥èªŒå‡½æ•¸
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEl = document.getElementById('test-log');
            const prefix = {
                'error': 'âŒ',
                'success': 'âœ…', 
                'warning': 'âš ï¸',
                'info': 'â„¹ï¸'
            }[type] || 'â„¹ï¸';
            
            logEl.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            logEl.scrollTop = logEl.scrollHeight;
            
            console.log(`%c[Phase 4.2.2 Test] ${message}`, 
                type === 'error' ? 'color: red' : 
                type === 'success' ? 'color: green' : 
                type === 'warning' ? 'color: orange' : 'color: blue');
        }
        
        // æ·»åŠ çµæœåˆ°æ¸¬è©¦å€åŸŸ
        function addResult(containerId, message, type = 'info') {
            const container = document.getElementById(containerId);
            const div = document.createElement('div');
            div.className = `test-result ${type}`;
            div.textContent = message;
            container.appendChild(div);
        }
        
        // åˆå§‹åŒ–æ¸²æŸ“å¼•æ“
        function initializeRenderer() {
            log('ğŸš€ åˆå§‹åŒ– Advanced Rendering å¼•æ“...');
            
            try {
                const canvas = document.getElementById('test-canvas');
                
                // æª¢æŸ¥é¡åˆ¥å¯ç”¨æ€§
                if (typeof window.AdvancedRenderingManager === 'undefined') {
                    throw new Error('AdvancedRenderingManager é¡åˆ¥æœªè¼‰å…¥');
                }
                
                if (typeof window.AdvancedCanvasRenderer === 'undefined') {
                    throw new Error('AdvancedCanvasRenderer é¡åˆ¥æœªè¼‰å…¥');
                }
                
                // åˆå§‹åŒ–æ¸²æŸ“ç®¡ç†å™¨
                testRenderer = new window.AdvancedRenderingManager({
                    preferWebGL: false,
                    fallbackToCanvas: true,
                    enableViewportCulling: true,
                    maxNodesForDOM: 50
                });
                
                addResult('renderer-init-results', 'âœ… Advanced Rendering Manager åˆå§‹åŒ–æˆåŠŸ', 'success');
                log('Advanced Rendering Manager åˆå§‹åŒ–æˆåŠŸ', 'success');
                
                // æª¢æŸ¥æ¸²æŸ“æ¨¡å¼
                const stats = testRenderer.getRenderStats();
                updateModebadge(stats.mode || 'dom');
                
                return true;
                
            } catch (error) {
                addResult('renderer-init-results', `âŒ åˆå§‹åŒ–å¤±æ•—: ${error.message}`, 'error');
                log(`åˆå§‹åŒ–å¤±æ•—: ${error.message}`, 'error');
                return false;
            }
        }
        
        // æ›´æ–°æ¨¡å¼æ¨™ç±¤
        function updateModebadge(mode) {
            const badge = document.getElementById('current-mode-badge');
            badge.className = `render-mode-badge ${mode}`;
            badge.textContent = {
                'dom': 'DOM',
                'canvas': 'Canvas 2D',
                'webgl': 'WebGL'
            }[mode] || mode.toUpperCase();
        }
        
        // åˆ‡æ›æ¸²æŸ“æ¨¡å¼
        function switchRenderingMode() {
            if (!testRenderer) {
                log('æ¸²æŸ“å™¨æœªåˆå§‹åŒ–', 'error');
                return;
            }
            
            const mode = document.getElementById('rendering-mode').value;
            log(`ğŸ”„ åˆ‡æ›æ¸²æŸ“æ¨¡å¼åˆ°: ${mode}`);
            
            try {
                testRenderer.switchRenderingMode(mode);
                updateModebadge(mode);
                log(`æˆåŠŸåˆ‡æ›åˆ° ${mode} æ¸²æŸ“æ¨¡å¼`, 'success');
                
                // é‡æ–°æ¸²æŸ“æ¸¬è©¦ç¯€é»
                if (testNodes.length > 0) {
                    testRenderer.render(testNodes, testConnections);
                }
                
            } catch (error) {
                log(`åˆ‡æ›æ¸²æŸ“æ¨¡å¼å¤±æ•—: ${error.message}`, 'error');
            }
        }
        
        // ç”Ÿæˆæ¸¬è©¦ç¯€é»
        function generateTestNodes() {
            const nodeCount = parseInt(document.getElementById('node-count').value);
            const nodeCountDisplay = document.getElementById('node-count-value');
            nodeCountDisplay.textContent = nodeCount;
            
            log(`ğŸ“¦ ç”Ÿæˆ ${nodeCount} å€‹æ¸¬è©¦ç¯€é»...`);
            
            testNodes = [];
            testConnections = [];
            
            // ç”Ÿæˆéš¨æ©Ÿç¯€é»
            for (let i = 0; i < nodeCount; i++) {
                const nodeTypes = ['condition', 'logic', 'action', 'script'];
                const type = nodeTypes[Math.floor(Math.random() * nodeTypes.length)];
                
                testNodes.push({
                    id: `test_node_${i}`,
                    name: `æ¸¬è©¦ç¯€é» ${i + 1}`,
                    description: `é€™æ˜¯ç¬¬ ${i + 1} å€‹æ¸¬è©¦ç¯€é»`,
                    type: type,
                    x: Math.random() * 800,
                    y: Math.random() * 600,
                    width: 200,
                    height: 100,
                    selected: Math.random() < 0.1, // 10% æ©Ÿç‡è¢«é¸ä¸­
                    isDirty: true,
                    inputs: type !== 'condition' ? [{ id: 'input' }] : [],
                    outputs: type !== 'script' ? [{ id: 'output' }] : []
                });
            }
            
            // ç”Ÿæˆéš¨æ©Ÿé€£æ¥
            for (let i = 0; i < Math.min(nodeCount - 1, 50); i++) {
                const sourceIndex = Math.floor(Math.random() * testNodes.length);
                let targetIndex = Math.floor(Math.random() * testNodes.length);
                
                // ç¢ºä¿ä¸æ˜¯è‡ªå·±é€£æ¥è‡ªå·±
                while (targetIndex === sourceIndex) {
                    targetIndex = Math.floor(Math.random() * testNodes.length);
                }
                
                testConnections.push({
                    id: `test_connection_${i}`,
                    source: testNodes[sourceIndex].id,
                    target: testNodes[targetIndex].id,
                    style: {
                        color: '#666',
                        width: 2,
                        showArrow: true
                    }
                });
            }
            
            log(`ç”Ÿæˆå®Œæˆ: ${testNodes.length} å€‹ç¯€é», ${testConnections.length} å€‹é€£æ¥`, 'success');
            
            // ç«‹å³æ¸²æŸ“
            if (testRenderer) {
                testRenderer.render(testNodes, testConnections);
            }
        }
        
        // é–‹å§‹æ¸²æŸ“æ¸¬è©¦
        function startRenderTest() {
            if (isRenderTestRunning) {
                log('æ¸²æŸ“æ¸¬è©¦å·²åœ¨åŸ·è¡Œä¸­', 'warning');
                return;
            }
            
            if (!testRenderer || testNodes.length === 0) {
                log('è«‹å…ˆåˆå§‹åŒ–æ¸²æŸ“å™¨ä¸¦ç”Ÿæˆæ¸¬è©¦ç¯€é»', 'warning');
                return;
            }
            
            log('ğŸ¬ é–‹å§‹é€£çºŒæ¸²æŸ“æ¸¬è©¦...');
            isRenderTestRunning = true;
            performanceHistory = [];
            
            // é¡¯ç¤ºçµ±è¨ˆé¢æ¿
            document.getElementById('render-stats').style.display = 'block';
            
            // é–‹å§‹æ¸²æŸ“å¾ªç’°
            renderTestInterval = setInterval(() => {
                if (!isRenderTestRunning) return;
                
                // è¼•å¾®ç§»å‹•ç¯€é»ä»¥æ¸¬è©¦å‹•æ…‹æ¸²æŸ“
                testNodes.forEach(node => {
                    node.x += (Math.random() - 0.5) * 2;
                    node.y += (Math.random() - 0.5) * 2;
                    node.isDirty = true;
                });
                
                // æ¸²æŸ“
                testRenderer.render(testNodes, testConnections);
                
                // æ›´æ–°çµ±è¨ˆ
                updateRenderStats();
                
            }, 16); // ~60 FPS
        }
        
        // åœæ­¢æ¸²æŸ“æ¸¬è©¦
        function stopRenderTest() {
            if (!isRenderTestRunning) {
                log('æ¸²æŸ“æ¸¬è©¦æœªåœ¨åŸ·è¡Œ', 'warning');
                return;
            }
            
            log('â¹ï¸ åœæ­¢æ¸²æŸ“æ¸¬è©¦');
            isRenderTestRunning = false;
            
            if (renderTestInterval) {
                clearInterval(renderTestInterval);
                renderTestInterval = null;
            }
            
            // è¨ˆç®—æœ€çµ‚çµ±è¨ˆ
            if (performanceHistory.length > 0) {
                const avgFps = performanceHistory.reduce((a, b) => a + b.fps, 0) / performanceHistory.length;
                const avgRenderTime = performanceHistory.reduce((a, b) => a + b.renderTime, 0) / performanceHistory.length;
                
                log(`ğŸ“Š æ¸¬è©¦çµæœ: å¹³å‡ FPS: ${avgFps.toFixed(1)}, å¹³å‡æ¸²æŸ“æ™‚é–“: ${avgRenderTime.toFixed(2)}ms`, 'success');
            }
        }
        
        // æ›´æ–°æ¸²æŸ“çµ±è¨ˆ
        function updateRenderStats() {
            if (!testRenderer) return;
            
            const stats = testRenderer.getRenderStats();
            
            // æ›´æ–°å³æ™‚çµ±è¨ˆé¡¯ç¤º
            document.getElementById('fps-value').textContent = stats.fps ? stats.fps.toFixed(1) : '0';
            document.getElementById('render-time-value').textContent = stats.renderTime ? stats.renderTime.toFixed(1) + 'ms' : '0ms';
            document.getElementById('nodes-rendered-value').textContent = stats.nodesRendered || '0';
            document.getElementById('cache-hit-value').textContent = stats.cacheHitRate ? (stats.cacheHitRate * 100).toFixed(1) + '%' : '0%';
            
            // æ·»åŠ åˆ°æ­·å²è¨˜éŒ„
            performanceHistory.push({
                fps: stats.fps || 0,
                renderTime: stats.renderTime || 0,
                cacheHitRate: stats.cacheHitRate || 0,
                timestamp: Date.now()
            });
            
            // é™åˆ¶æ­·å²è¨˜éŒ„é•·åº¦
            if (performanceHistory.length > 300) { // 5 åˆ†é˜çš„è¨˜éŒ„
                performanceHistory.shift();
            }
            
            // æ›´æ–°å¹³å‡æŒ‡æ¨™
            updateAverageMetrics();
        }
        
        // æ›´æ–°å¹³å‡æŒ‡æ¨™
        function updateAverageMetrics() {
            if (performanceHistory.length === 0) return;
            
            const recent = performanceHistory.slice(-60); // æœ€è¿‘ 1 ç§’çš„æ•¸æ“š
            
            const avgFps = recent.reduce((a, b) => a + b.fps, 0) / recent.length;
            const avgRenderTime = recent.reduce((a, b) => a + b.renderTime, 0) / recent.length;
            const avgCacheRate = recent.reduce((a, b) => a + b.cacheHitRate, 0) / recent.length;
            
            document.getElementById('avg-fps').textContent = avgFps.toFixed(1);
            document.getElementById('avg-render-time').textContent = avgRenderTime.toFixed(1);
            document.getElementById('cache-efficiency').textContent = (avgCacheRate * 100).toFixed(1);
            
            // æ¨¡æ“¬è¨˜æ†¶é«”ä½¿ç”¨ (å¯¦éš›ä¸­æœƒå¾æ¸²æŸ“å™¨ç²å–)
            const memoryUsage = (testNodes.length * 0.1 + Math.random() * 2).toFixed(1);
            document.getElementById('memory-usage').textContent = memoryUsage;
        }
        
        // æ¸…é™¤ç•«å¸ƒ
        function clearCanvas() {
            const canvas = document.getElementById('test-canvas');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            log('ğŸ§¹ ç•«å¸ƒå·²æ¸…é™¤');
        }
        
        // åˆ‡æ›çµ±è¨ˆé¡¯ç¤º
        function toggleStats() {
            const statsEl = document.getElementById('render-stats');
            statsEl.style.display = statsEl.style.display === 'none' ? 'block' : 'none';
        }
        
        // åŠŸèƒ½æ¸¬è©¦
        function testNodeRendering() {
            log('ğŸ§ª æ¸¬è©¦ç¯€é»æ¸²æŸ“åŠŸèƒ½...');
            
            if (!testRenderer || !window.AdvancedCanvasRenderer) {
                log('æ¸²æŸ“å™¨æœªåˆå§‹åŒ–', 'error');
                return;
            }
            
            try {
                // å‰µå»ºå–®å€‹æ¸¬è©¦ç¯€é»
                const testNode = {
                    id: 'render_test_node',
                    name: 'æ¸²æŸ“æ¸¬è©¦ç¯€é»',
                    type: 'condition',
                    x: 100,
                    y: 100,
                    width: 200,
                    height: 100,
                    selected: true,
                    isDirty: true
                };
                
                testRenderer.render([testNode], []);
                
                addResult('feature-test-results', 'âœ… ç¯€é»æ¸²æŸ“æ¸¬è©¦é€šé', 'success');
                log('ç¯€é»æ¸²æŸ“æ¸¬è©¦é€šé', 'success');
                
            } catch (error) {
                addResult('feature-test-results', `âŒ ç¯€é»æ¸²æŸ“æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error'); 
                log(`ç¯€é»æ¸²æŸ“æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
            }
        }
        
        function testConnectionRendering() {
            log('ğŸ§ª æ¸¬è©¦é€£æ¥ç·šæ¸²æŸ“åŠŸèƒ½...');
            
            try {
                // å‰µå»ºå…©å€‹ç¯€é»å’Œä¸€å€‹é€£æ¥
                const nodes = [
                    { id: 'node1', name: 'ç¯€é»1', type: 'condition', x: 50, y: 50, width: 150, height: 80 },
                    { id: 'node2', name: 'ç¯€é»2', type: 'action', x: 300, y: 150, width: 150, height: 80 }
                ];
                
                const connections = [
                    { id: 'conn1', source: 'node1', target: 'node2', style: { color: '#48cae4', width: 3 } }
                ];
                
                testRenderer.render(nodes, connections);
                
                addResult('feature-test-results', 'âœ… é€£æ¥ç·šæ¸²æŸ“æ¸¬è©¦é€šé', 'success');
                log('é€£æ¥ç·šæ¸²æŸ“æ¸¬è©¦é€šé', 'success');
                
            } catch (error) {
                addResult('feature-test-results', `âŒ é€£æ¥ç·šæ¸²æŸ“æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
                log(`é€£æ¥ç·šæ¸²æŸ“æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
            }
        }
        
        function testViewportCulling() {
            log('ğŸ§ª æ¸¬è©¦è¦–çª—è£å‰ªåŠŸèƒ½...');
            
            try {
                // å‰µå»ºå¤§é‡åˆ†æ•£çš„ç¯€é»
                const largeNodeSet = [];
                for (let i = 0; i < 200; i++) {
                    largeNodeSet.push({
                        id: `cull_test_${i}`,
                        name: `è£å‰ªæ¸¬è©¦ ${i}`,
                        type: 'condition',
                        x: Math.random() * 2000 - 1000, // åˆ†æ•£åœ¨æ›´å¤§ç¯„åœ
                        y: Math.random() * 2000 - 1000,
                        width: 150,
                        height: 80
                    });
                }
                
                const startTime = performance.now();
                testRenderer.render(largeNodeSet, []);
                const renderTime = performance.now() - startTime;
                
                addResult('feature-test-results', `âœ… è¦–çª—è£å‰ªæ¸¬è©¦é€šé (200ç¯€é»æ¸²æŸ“æ™‚é–“: ${renderTime.toFixed(1)}ms)`, 'success');
                log(`è¦–çª—è£å‰ªæ¸¬è©¦é€šéï¼Œ200ç¯€é»æ¸²æŸ“æ™‚é–“: ${renderTime.toFixed(1)}ms`, 'success');
                
            } catch (error) {
                addResult('feature-test-results', `âŒ è¦–çª—è£å‰ªæ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
                log(`è¦–çª—è£å‰ªæ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
            }
        }
        
        function testCacheSystem() {
            log('ğŸ§ª æ¸¬è©¦å¿«å–ç³»çµ±åŠŸèƒ½...');
            
            try {
                // å‰µå»ºç›¸åŒçš„ç¯€é»å¤šæ¬¡æ¸²æŸ“ï¼Œæ¸¬è©¦å¿«å–æ•ˆç‡
                const cacheTestNode = {
                    id: 'cache_test_node',
                    name: 'å¿«å–æ¸¬è©¦ç¯€é»',
                    type: 'logic',
                    x: 200,
                    y: 200,
                    width: 180,
                    height: 90,
                    isDirty: false // ä¸é«’ï¼Œæ‡‰è©²èƒ½å¾å¿«å–è®€å–
                };
                
                // ç¬¬ä¸€æ¬¡æ¸²æŸ“ (å»ºç«‹å¿«å–)
                testRenderer.render([cacheTestNode], []);
                
                // å¤šæ¬¡æ¸²æŸ“ç›¸åŒç¯€é»
                const startTime = performance.now();
                for (let i = 0; i < 10; i++) {
                    testRenderer.render([cacheTestNode], []);
                }
                const totalTime = performance.now() - startTime;
                
                const stats = testRenderer.getRenderStats();
                const cacheHitRate = stats.cacheHitRate || 0;
                
                addResult('feature-test-results', `âœ… å¿«å–ç³»çµ±æ¸¬è©¦é€šé (å¿«å–å‘½ä¸­ç‡: ${(cacheHitRate * 100).toFixed(1)}%)`, 'success');
                log(`å¿«å–ç³»çµ±æ¸¬è©¦é€šéï¼Œå¿«å–å‘½ä¸­ç‡: ${(cacheHitRate * 100).toFixed(1)}%`, 'success');
                
            } catch (error) {
                addResult('feature-test-results', `âŒ å¿«å–ç³»çµ±æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
                log(`å¿«å–ç³»çµ±æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
            }
        }
        
        function runAllTests() {
            log('ğŸ§ª åŸ·è¡Œæ‰€æœ‰åŠŸèƒ½æ¸¬è©¦...');
            
            setTimeout(() => testNodeRendering(), 100);
            setTimeout(() => testConnectionRendering(), 300);
            setTimeout(() => testViewportCulling(), 500);
            setTimeout(() => testCacheSystem(), 700);
            
            setTimeout(() => {
                log('ğŸ‰ æ‰€æœ‰åŠŸèƒ½æ¸¬è©¦å®Œæˆï¼', 'success');
            }, 1000);
        }
        
        // æ¸…é™¤æ—¥èªŒ
        function clearLog() {
            document.getElementById('test-log').textContent = '';
        }
        
        // åŒ¯å‡ºæ¸¬è©¦çµæœ
        function exportResults() {
            const results = {
                timestamp: new Date().toISOString(),
                renderingMode: testRenderer ? testRenderer.renderingMode : 'unknown',
                nodeCount: testNodes.length,
                performanceHistory: performanceHistory.slice(-100), // æœ€è¿‘ 100 å€‹æ•¸æ“šé»
                testResults: {
                    averageFPS: performanceHistory.length > 0 ? 
                        (performanceHistory.reduce((a, b) => a + b.fps, 0) / performanceHistory.length).toFixed(2) : 0,
                    averageRenderTime: performanceHistory.length > 0 ? 
                        (performanceHistory.reduce((a, b) => a + b.renderTime, 0) / performanceHistory.length).toFixed(2) : 0
                }
            };
            
            const blob = new Blob([JSON.stringify(results, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `flow-designer-phase4-2-2-test-results-${Date.now()}.json`;
            a.click();
            
            log('ğŸ“„ æ¸¬è©¦çµæœå·²åŒ¯å‡º', 'success');
        }
        
        // ç¯€é»æ•¸é‡æ»‘æ¡¿äº‹ä»¶
        document.getElementById('node-count').addEventListener('input', (e) => {
            document.getElementById('node-count-value').textContent = e.target.value;
        });
        
        // é é¢è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            log('ğŸŒŸ Phase 4.2.2 Advanced Canvas Rendering æ¸¬è©¦é é¢å·²è¼‰å…¥');
            
            setTimeout(() => {
                if (initializeRenderer()) {
                    log('ğŸ¯ è«‹é»æ“Š "ç”Ÿæˆæ¸¬è©¦ç¯€é»" é–‹å§‹æ¸¬è©¦', 'info');
                }
            }, 500);
        });
    </script>
</body>
</html>