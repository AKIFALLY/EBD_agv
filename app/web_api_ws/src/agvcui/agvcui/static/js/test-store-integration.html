<!DOCTYPE html>
<html>
<head>
    <title>Test TAFL Store Integration</title>
    <meta charset="utf-8">
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #1e1e1e;
            color: #d4d4d4;
        }
        .test {
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #333;
        }
        .pass {
            color: #4ec9b0;
        }
        .fail {
            color: #f44747;
        }
        .section {
            margin-top: 20px;
            padding: 15px;
            background: #2d2d30;
            border-radius: 5px;
        }
        h2 {
            color: #569cd6;
        }
        pre {
            background: #1e1e1e;
            padding: 10px;
            border-radius: 3px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>TAFL Editor Store Integration Test</h1>
    
    <div class="section">
        <h2>Store Tests</h2>
        <div id="store-tests"></div>
    </div>
    
    <div class="section">
        <h2>Event Tests</h2>
        <div id="event-tests"></div>
    </div>
    
    <div class="section">
        <h2>State Persistence</h2>
        <div id="persistence-tests"></div>
    </div>
    
    <div class="section">
        <h2>Test Log</h2>
        <pre id="log"></pre>
    </div>

    <script type="module">
        // Import the store modules
        import { createStore } from '/static/store/miniStore.js';
        import { taflFlowStore } from '/static/js/tafl-editor/tafl-editor-store.js';
        
        const log = document.getElementById('log');
        const storeTests = document.getElementById('store-tests');
        const eventTests = document.getElementById('event-tests');
        const persistenceTests = document.getElementById('persistence-tests');
        
        function addLog(msg) {
            log.textContent += msg + '\n';
            console.log(msg);
        }
        
        function addTest(container, name, result) {
            const div = document.createElement('div');
            div.className = `test ${result ? 'pass' : 'fail'}`;
            div.textContent = `${result ? '✓' : '✗'} ${name}`;
            container.appendChild(div);
        }
        
        // Test 1: Store initialization
        addLog('Testing store initialization...');
        const initialState = taflFlowStore.getState();
        addTest(storeTests, 'Store initialized', initialState !== null);
        addTest(storeTests, 'Has currentFlow', initialState.currentFlow !== undefined);
        addTest(storeTests, 'Has metadata', initialState.currentFlow.metadata !== undefined);
        addTest(storeTests, 'Has flow array', Array.isArray(initialState.currentFlow.flow));
        
        // Test 2: Flow operations
        addLog('Testing flow operations...');
        const testMetadata = { id: 'test-flow', name: 'Test Flow', description: 'Test' };
        taflFlowStore.updateMetadata(testMetadata);
        const updatedFlow = taflFlowStore.getFlow();
        addTest(storeTests, 'Update metadata', updatedFlow.metadata.id === 'test-flow');
        
        // Test 3: Card operations
        addLog('Testing card operations...');
        const cardId = taflFlowStore.addCard('set', { index: 0 });
        addTest(storeTests, 'Add card', cardId !== null);
        
        const card = taflFlowStore.findCardById(cardId);
        addTest(storeTests, 'Find card by ID', card !== null && card.id === cardId);
        
        // Test 4: Event system
        addLog('Testing event system...');
        let eventFired = false;
        const testHandler = (data) => {
            eventFired = true;
            addLog(`Event received: flow:changed`);
        };
        
        taflFlowStore.on('flow:changed', testHandler);
        taflFlowStore.updateFlow({ 
            settings: { timeout: 7200, max_retries: 5, retry_on_failure: true }
        });
        
        setTimeout(() => {
            addTest(eventTests, 'Flow change event fired', eventFired);
            taflFlowStore.off('flow:changed', testHandler);
        }, 100);
        
        // Test 5: Variable management
        addLog('Testing variable management...');
        const testVariables = { testVar: 'value1', counter: 42 };
        taflFlowStore.updateVariables(testVariables);
        const flowWithVars = taflFlowStore.getFlow();
        addTest(storeTests, 'Update variables', flowWithVars.variables.testVar === 'value1');
        
        // Test 6: Dirty state
        addLog('Testing dirty state...');
        taflFlowStore.setDirty(true);
        addTest(storeTests, 'Set dirty state', taflFlowStore.isDirty() === true);
        
        taflFlowStore.setSaved();
        addTest(storeTests, 'Set saved state', taflFlowStore.isDirty() === false);
        
        // Test 7: State persistence
        addLog('Testing localStorage persistence...');
        const beforeReload = taflFlowStore.getState();
        
        // Simulate reload by creating new store instance
        const testStore = createStore('taflEditor-test', {
            currentFlow: { metadata: { id: 'persisted' } }
        });
        
        addTest(persistenceTests, 'LocalStorage key exists', 
            localStorage.getItem('taflEditor') !== null);
        
        // Test 8: Batch updates
        addLog('Testing batch updates...');
        let batchEventCount = 0;
        const batchHandler = () => batchEventCount++;
        
        taflFlowStore.on('batch:updated', batchHandler);
        taflFlowStore.batchUpdate(() => {
            taflFlowStore.updateMetadata({ name: 'Batch Test' });
            taflFlowStore.updateVariables({ batchVar: true });
            taflFlowStore.setDirty(true);
        });
        
        setTimeout(() => {
            addTest(eventTests, 'Batch update event', batchEventCount > 0);
            taflFlowStore.off('batch:updated', batchHandler);
            
            // Final summary
            addLog('\n=== Test Summary ===');
            const allTests = document.querySelectorAll('.test');
            const passed = document.querySelectorAll('.test.pass').length;
            const failed = document.querySelectorAll('.test.fail').length;
            addLog(`Total: ${allTests.length}, Passed: ${passed}, Failed: ${failed}`);
            
            if (failed === 0) {
                addLog('✓ All tests passed! Store integration successful.');
            } else {
                addLog('✗ Some tests failed. Please check the implementation.');
            }
        }, 200);
        
        // Make store available for manual testing
        window.taflFlowStore = taflFlowStore;
        addLog('\nStore available as window.taflFlowStore for manual testing.');
    </script>
</body>
</html>