{% extends "base.html" %}
{% block title %}AGVCUI - WCS Flow Designer{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="/static/css/flowDesignerPage_collapsible.css?v=4.0.0" />
<!-- js-yaml library for YAML parsing (æœ¬åœ°ç‰ˆæœ¬) -->
<script src="/static/js/lib/js-yaml.min.js"></script>
{% endblock %}

{% block content %}
<div class="flow-designer-container">
    <!-- å´é‚Šæ¬„ - ç¯€é»é¸æ¿ (å¯æ”¶åˆç‰ˆæœ¬) -->
    <div class="flow-sidebar">
        <div class="flow-sidebar-header">
            <h2 class="subtitle">
                <span class="icon"><i class="mdi mdi-palette"></i></span>
                ç¯€é»é¸æ¿
            </h2>
        </div>
        <div class="flow-node-palette">
            <!-- æ¢ä»¶ç¯€é»å€åŸŸ (å¯æŠ˜ç–Š) -->
            <div class="palette-section" data-category="condition">
                <div class="palette-section-header is-collapsible">
                    <div class="palette-section-title">
                        <span class="icon"><i class="mdi mdi-chevron-down"></i></span>
                        <span class="text">æ¢ä»¶ç¯€é»</span>
                        <span class="badge">0</span>
                    </div>
                </div>
                <div class="palette-section-content">
                    <div class="palette-nodes" id="condition-nodes">
                        <!-- æ¢ä»¶ç¯€é»å°‡é€šé JavaScript å‹•æ…‹ç”Ÿæˆ -->
                    </div>
                </div>
            </div>

            <!-- å‹•ä½œç¯€é»å€åŸŸ (å¯æŠ˜ç–Š) -->
            <div class="palette-section" data-category="action">
                <div class="palette-section-header is-collapsible">
                    <div class="palette-section-title">
                        <span class="icon"><i class="mdi mdi-chevron-down"></i></span>
                        <span class="text">å‹•ä½œç¯€é»</span>
                        <span class="badge">0</span>
                    </div>
                </div>
                <div class="palette-section-content">
                    <div class="palette-nodes" id="action-nodes">
                        <!-- å‹•ä½œç¯€é»å°‡é€šé JavaScript å‹•æ…‹ç”Ÿæˆ -->
                    </div>
                </div>
            </div>

            <!-- é‚è¼¯ç¯€é»å€åŸŸ (å¯æŠ˜ç–Š) -->
            <div class="palette-section" data-category="logic">
                <div class="palette-section-header is-collapsible">
                    <div class="palette-section-title">
                        <span class="icon"><i class="mdi mdi-chevron-down"></i></span>
                        <span class="text">é‚è¼¯ç¯€é»</span>
                        <span class="badge">0</span>
                    </div>
                </div>
                <div class="palette-section-content">
                    <div class="palette-nodes" id="logic-nodes">
                        <!-- é‚è¼¯ç¯€é»å°‡é€šé JavaScript å‹•æ…‹ç”Ÿæˆ -->
                    </div>
                </div>
            </div>

            <!-- è…³æœ¬ç¯€é»å€åŸŸ (å¯æŠ˜ç–Š) -->
            <div class="palette-section" data-category="script">
                <div class="palette-section-header is-collapsible">
                    <div class="palette-section-title">
                        <span class="icon"><i class="mdi mdi-chevron-down"></i></span>
                        <span class="text">è…³æœ¬ç¯€é»</span>
                        <span class="badge">0</span>
                    </div>
                </div>
                <div class="palette-section-content">
                    <div class="palette-nodes" id="script-nodes">
                        <!-- è…³æœ¬ç¯€é»å°‡é€šé JavaScript å‹•æ…‹ç”Ÿæˆ -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ç·¨è¼¯å™¨å€åŸŸ -->
    <div class="flow-editor-container">
        <div id="rete-editor" class="flow-editor">
            <!-- Canvas Rendering Layer -->
            <canvas id="flow-canvas" class="flow-canvas-layer"></canvas>
        </div>
        
        <!-- æµ®å‹•ä¿å­˜æŒ‰éˆ• -->
        <div class="floating-save-button">
            <button class="button is-success" id="btn-save-flow" title="ä¿å­˜æµç¨‹ (Ctrl+S)">
                <span class="icon is-large">
                    <i class="mdi mdi-content-save"></i>
                </span>
            </button>
        </div>
    </div>

    <!-- å±¬æ€§é¢æ¿ -->
    <div class="flow-properties-panel" id="properties-panel">
        <div class="flow-properties-header">
            <h3 class="subtitle is-6">ç¯€é»å±¬æ€§</h3>
            <button class="delete" id="close-properties"></button>
        </div>
        <div class="flow-properties-content" id="properties-content">
            <div class="notification is-light">
                é¸æ“‡ä¸€å€‹ç¯€é»ä»¥æŸ¥çœ‹å±¬æ€§
            </div>
        </div>
    </div>
</div>

<!-- ç‹€æ…‹åˆ— -->
<div class="flow-status-bar">
    <div class="level">
        <div class="level-left">
            <div class="level-item">
                <span class="tag is-info">å°±ç·’</span>
            </div>
            <div class="level-item">
                <span class="has-text-grey">ç¯€é»: <span id="node-count">0</span></span>
            </div>
            <div class="level-item">
                <span class="has-text-grey">é€£æ¥: <span id="connection-count">0</span></span>
            </div>
        </div>
        <div class="level-right">
            <div class="level-item">
                <span class="has-text-grey">ç•¶å‰æµç¨‹: <span id="current-flow-name">æœªå‘½å</span></span>
            </div>
        </div>
    </div>
</div>

<!-- æµç¨‹ç®¡ç†æ¨¡æ…‹æ¡† -->
<div class="modal" id="flow-manager-modal">
    <div class="modal-background"></div>
    <div class="modal-card">
        <header class="modal-card-head">
            <p class="modal-card-title">æµç¨‹ç®¡ç†</p>
            <button class="delete" aria-label="close"></button>
        </header>
        <section class="modal-card-body">
            <div class="field">
                <label class="label">æµç¨‹åç¨±</label>
                <div class="control">
                    <input class="input" type="text" id="flow-name-input" placeholder="è«‹è¼¸å…¥æµç¨‹åç¨±">
                </div>
            </div>
            <div class="field">
                <label class="label">æè¿°</label>
                <div class="control">
                    <textarea class="textarea" id="flow-description-input" placeholder="è«‹è¼¸å…¥æµç¨‹æè¿°"></textarea>
                </div>
            </div>
        </section>
        <footer class="modal-card-foot">
            <button class="button is-success" id="confirm-flow-action">ç¢ºèª</button>
            <button class="button" id="cancel-flow-action">å–æ¶ˆ</button>
        </footer>
    </div>
</div>

<!-- YAML DSL æ–‡ä»¶ä¸Šå‚³éš±è—è¼¸å…¥ -->
<input type="file" id="file-input" accept=".yaml,.yml" style="display: none;">

<!-- Flow Designer V2 - Collapsible Edition -->
<script src="/static/js/flowDesignerV2_collapsible.js?v=4.0.0"></script>

<script>
// å¾å¾Œç«¯å‚³éçš„åˆå§‹æµç¨‹æ•¸æ“š
window.INITIAL_FLOW_DATA = {
    name: {{ initial_flow_name|tojson if initial_flow_name else 'null' }},
    data: {{ initial_flow_data|tojson if initial_flow_data else 'null' }}
};

// ç¢ºä¿ Flow Designer V2 åœ¨é é¢è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    console.log('ğŸ” åˆå§‹åŒ– Flow Designer V2 Collapsible...');
    
    // æª¢æŸ¥ FlowDesignerV2 é¡åˆ¥æ˜¯å¦å¯ç”¨
    if (typeof FlowDesignerV2 !== 'undefined') {
        try {
            // å‰µå»ºå¯¦ä¾‹ä¸¦åˆå§‹åŒ–
            window.flowDesigner = new FlowDesignerV2();
            
            // åˆå§‹åŒ– Flow Designer
            window.flowDesigner.initialize().then(() => {
                console.log('âœ… Flow Designer V2 åˆå§‹åŒ–å®Œæˆ');
                
                // å¦‚æœæœ‰åˆå§‹æµç¨‹æ•¸æ“šï¼Œè¼‰å…¥å®ƒ
                if (window.INITIAL_FLOW_DATA.name && window.INITIAL_FLOW_DATA.data) {
                    console.log(`ğŸ“¥ è¼‰å…¥åˆå§‹æµç¨‹: ${window.INITIAL_FLOW_DATA.name}`);
                    window.flowDesigner.loadFlow(window.INITIAL_FLOW_DATA.name);
                }
            }).catch(error => {
                console.error('âŒ Flow Designer V2 åˆå§‹åŒ–å¤±æ•—:', error);
                alert('Flow Designer åˆå§‹åŒ–å¤±æ•—: ' + error.message);
            });
        } catch (error) {
            console.error('âŒ Flow Designer V2 å‰µå»ºå¤±æ•—:', error);
            alert('Flow Designer å‰µå»ºå¤±æ•—: ' + error.message);
        }
    } else {
        console.error('âŒ FlowDesignerV2 é¡åˆ¥æœªè¼‰å…¥');
        alert('Flow Designer ç¨‹å¼æœªæ­£ç¢ºè¼‰å…¥ï¼Œè«‹é‡æ–°æ•´ç†é é¢');
    }
});
</script>
{% endblock %}