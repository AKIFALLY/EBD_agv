{% extends "base.html" %}
{% block title %}AGV ç›£æ§ç³»çµ±{% endblock %}

{% block content %}
<section class="section">
    <div class="container">
        <!-- æ ¹æ“šç’°å¢ƒé¡¯ç¤ºä¸åŒçš„æ¨™é¡Œ -->
        {% if container_type == "agvc" and not local_agv_id %}
        <h1 class="title">å¤šè»Šç›£æ§ç³»çµ±</h1>
        <h2 class="subtitle">åŒæ™‚ç›£æ§æ‰€æœ‰ AGV ç‹€æ…‹</h2>
        {% else %}
        <h1 class="title">AGV ç‹€æ…‹ç›£æ§</h1>
        <h2 class="subtitle">
            {% if local_agv_id %}
                AGV: <span class="has-text-primary has-text-weight-bold">{{ local_agv_id }}</span>
            {% else %}
                é¡¯ç¤ºæ‰€æœ‰ AGV ç‹€æ…‹
            {% endif %}
        </h2>
        {% endif %}
        
        <!-- éš±è—çš„ AGV ID è³‡è¨Šï¼Œä¾› JavaScript ä½¿ç”¨ -->
        <input type="hidden" id="local-agv-id" value="{{ local_agv_id or '' }}">
        <input type="hidden" id="container-type" value="{{ container_type or '' }}">
        <input type="hidden" id="is-test-mode" value="{{ is_test_mode|lower }}">
        
        <!-- AGVC ç’°å¢ƒä¸”ç„¡æŒ‡å®š AGV ID æ™‚ï¼Œé¡¯ç¤ºå¤šè»Šç›£æ§ä»‹é¢ -->
        {% if container_type == "agvc" and not local_agv_id %}
        
        <!-- AGV åˆ†é é¸æ“‡ -->
        <div class="tabs is-boxed is-medium">
            <ul id="agv-tabs">
                <!-- Loader AGVs -->
                <li class="agv-tab" data-agv="loader01">
                    <a href="javascript:void(0);" style="cursor: pointer;">
                        <span class="icon is-small"><i class="mdi mdi-forklift"></i></span>
                        <span>Loader 01</span>
                        <span class="tag is-rounded ml-2" id="status-loader01">é›¢ç·š</span>
                    </a>
                </li>
                <li class="agv-tab" data-agv="loader02">
                    <a href="javascript:void(0);" style="cursor: pointer;">
                        <span class="icon is-small"><i class="mdi mdi-forklift"></i></span>
                        <span>Loader 02</span>
                        <span class="tag is-rounded ml-2" id="status-loader02">é›¢ç·š</span>
                    </a>
                </li>
                
                <!-- Cargo AGVs -->
                <li class="agv-tab" data-agv="cargo01">
                    <a href="javascript:void(0);" style="cursor: pointer;">
                        <span class="icon is-small"><i class="mdi mdi-truck"></i></span>
                        <span>Cargo 01</span>
                        <span class="tag is-rounded ml-2" id="status-cargo01">é›¢ç·š</span>
                    </a>
                </li>
                <li class="agv-tab" data-agv="cargo02">
                    <a href="javascript:void(0);" style="cursor: pointer;">
                        <span class="icon is-small"><i class="mdi mdi-truck"></i></span>
                        <span>Cargo 02</span>
                        <span class="tag is-rounded ml-2" id="status-cargo02">é›¢ç·š</span>
                    </a>
                </li>
                
                <!-- Unloader AGVs -->
                <li class="agv-tab" data-agv="unloader01">
                    <a href="javascript:void(0);" style="cursor: pointer;">
                        <span class="icon is-small"><i class="mdi mdi-crane"></i></span>
                        <span>Unloader 01</span>
                        <span class="tag is-rounded ml-2" id="status-unloader01">é›¢ç·š</span>
                    </a>
                </li>
                <li class="agv-tab" data-agv="unloader02">
                    <a href="javascript:void(0);" style="cursor: pointer;">
                        <span class="icon is-small"><i class="mdi mdi-crane"></i></span>
                        <span>Unloader 02</span>
                        <span class="tag is-rounded ml-2" id="status-unloader02">é›¢ç·š</span>
                    </a>
                </li>
            </ul>
        </div>
        
        {% endif %}
        
        <!-- æ§åˆ¶æŒ‰éˆ• -->
        <div class="field is-grouped">
            <div class="control">
                <button class="button is-primary is-medium" id="refresh-button">
                    <span class="icon">
                        <i class="mdi mdi-refresh"></i>
                    </span>
                    <span>é‡æ–°æ•´ç†</span>
                </button>
            </div>
            {% if container_type == "agvc" %}
            <div class="control">
                <a href="/test" class="button is-info is-medium">
                    <span class="icon">
                        <i class="mdi mdi-test-tube"></i>
                    </span>
                    <span>æ¸¬è©¦æ¨¡å¼</span>
                </a>
            </div>
            {% endif %}
        </div>

        <!-- è³‡æ–™ä¾†æºåœ–ä¾‹ -->
        <div class="box" id="source-legend" style="display:none;">
            <div class="level">
                <div class="level-left">
                    <div class="level-item">
                        <h4 class="title is-6 mb-0">
                            <span class="icon"><i class="mdi mdi-information-outline"></i></span>
                            è³‡æ–™ä¾†æºèªªæ˜
                        </h4>
                    </div>
                </div>
                <div class="level-right">
                    <div class="level-item">
                        <span class="tag is-info is-light mr-2">
                            <strong>[N]</strong>&nbsp;æ–°æ ¼å¼
                        </span>
                        <span class="mr-1">Recorder Class v2.0 (/tmp/agv_status_{agv_id}.json)</span>
                    </div>
                    <div class="level-item">
                        <span class="tag is-warning is-light mr-2">
                            <strong>[L]</strong>&nbsp;èˆŠæ ¼å¼
                        </span>
                        <span class="mr-1">Base Class v1.0 (/tmp/agv_status.json)</span>
                    </div>
                    <div class="level-item">
                        <div class="tags has-addons">
                            <span class="tag is-info">æ–°æ ¼å¼æ¬„ä½</span>
                            <span class="tag is-light" id="source-stats-new">0</span>
                        </div>
                    </div>
                    <div class="level-item">
                        <div class="tags has-addons">
                            <span class="tag is-warning">èˆŠæ ¼å¼æ¬„ä½</span>
                            <span class="tag is-light" id="source-stats-legacy">0</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç‹€æ…‹æ‘˜è¦ -->
        <div class="box" id="status-summary" style="display:none;">
            <nav class="level">
                <div class="level-item has-text-centered">
                    <div>
                        <p class="heading">AGV ID</p>
                        <p class="title" id="summary-agv-id">-</p>
                    </div>
                </div>
                <div class="level-item has-text-centered">
                    <div>
                        <p class="heading">ç¸½å±¬æ€§æ•¸</p>
                        <p class="title" id="summary-total-attrs">0</p>
                    </div>
                </div>
                <div class="level-item has-text-centered">
                    <div>
                        <p class="heading">ä½ç½® (X,Y)</p>
                        <p class="title" id="summary-position">-</p>
                    </div>
                </div>
                <div class="level-item has-text-centered">
                    <div>
                        <p class="heading">é›»æ± é›»é‡</p>
                        <p class="title" id="summary-power">-</p>
                    </div>
                </div>
                <div class="level-item has-text-centered">
                    <div>
                        <p class="heading">ç‹€æ…‹æ¨¡å¼</p>
                        <p class="title" id="summary-mode">-</p>
                    </div>
                </div>
            </nav>
        </div>
        
        <!-- âœ… è³‡æ–™ä¾†æºåˆ†é åˆ‡æ› -->
        <div class="tabs is-boxed">
            <ul>
                <li class="is-active" data-tab="json-tab">
                    <a href="javascript:void(0);">
                        <span class="icon is-small"><i class="mdi mdi-code-json"></i></span>
                        <span>ğŸ“Š JSON å®Œæ•´ç‹€æ…‹</span>
                    </a>
                </li>
                <li data-tab="ros-tab">
                    <a href="javascript:void(0);">
                        <span class="icon is-small"><i class="mdi mdi-robot"></i></span>
                        <span>ğŸ¤– ROS2 è¨Šæ¯</span>
                    </a>
                </li>
            </ul>
        </div>

        <!-- JSON ç‹€æ…‹è³‡æ–™ (å®Œæ•´çµæ§‹) -->
        <div class="box" id="json-status-container" style="display:block;">
            <h3 class="title is-5">ğŸ“Š JSON å®Œæ•´ç‹€æ…‹ï¼ˆ7å€‹è³‡æ–™ä¾†æºï¼‰</h3>
            <p class="subtitle is-6 has-text-grey">ä¾†æºï¼šagv_status_update Socket.IO äº‹ä»¶</p>
            <div id="status-categories" class="columns is-multiline">
                <!-- å‹•æ…‹ç”Ÿæˆçš„åˆ†é¡å€å¡Šæœƒæ”¾åœ¨é€™è£¡ -->
                <div class="column is-12 has-text-centered has-text-grey">
                    ç­‰å¾… JSON ç‹€æ…‹è³‡æ–™...
                </div>
            </div>
        </div>

        <!-- ROS 2 è¨Šæ¯è³‡æ–™ (ç°¡å–®çµæ§‹) -->
        <div class="box" id="ros-status-container" style="display:none;">
            <h3 class="title is-5">ğŸ¤– ROS2 è¨Šæ¯ï¼ˆåŸºæœ¬æ¬„ä½ï¼‰</h3>
            <p class="subtitle is-6 has-text-grey">ä¾†æºï¼šROS2 agv_interfaces.msg.AgvStatus</p>
            <div id="ros-status-content" class="columns is-multiline">
                <!-- ROS è¨Šæ¯å…§å®¹æœƒæ”¾åœ¨é€™è£¡ -->
                <div class="column is-12 has-text-centered has-text-grey">
                    ç­‰å¾… ROS2 è¨Šæ¯è³‡æ–™...
                </div>
            </div>
        </div>
        
        <!-- åŸå§‹å®Œæ•´ PLC ç‹€æ…‹è³‡æ–™ (Socket.IO) -->
        <div class="box" id="plc-status-container" style="display:none;">
            <h3 class="title is-5">PLC å®Œæ•´ç‹€æ…‹è³‡æ–™</h3>
            <div id="plc-status-categories" class="columns is-multiline">
                <!-- å‹•æ…‹ç”Ÿæˆçš„ PLC åˆ†é¡å€å¡Šæœƒæ”¾åœ¨é€™è£¡ -->
                <div class="column is-12 has-text-centered has-text-grey">
                    ç­‰å¾… PLC ç‹€æ…‹è³‡æ–™...
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block scripts %}
<!-- Socket.IO -->
<script src="https://cdn.socket.io/4.5.0/socket.io.min.js"></script>
<script>
// Socket.IO é€£æ¥
let socket = null;
let plcDataStore = {}; // å„²å­˜å®Œæ•´çš„ PLC è³‡æ–™

// AGV è³‡æ–™å„²å­˜å’Œç‹€æ…‹ç®¡ç† (å®šç¾©åœ¨æœ€å‰é¢ï¼Œé¿å…æœªå®šç¾©éŒ¯èª¤)
let agvDataStore = {};
let currentAgvId = null;
const agvList = ['loader01', 'loader02', 'cargo01', 'cargo02', 'unloader01', 'unloader02'];

// âœ… æ–°å¢ï¼šROS è¨Šæ¯è³‡æ–™å„²å­˜
let rosMessageStore = null;

// åˆå§‹åŒ– Socket.IO é€£æ¥
function initSocketIO() {
    socket = io('/', {
        transports: ['websocket', 'polling'],
        reconnection: true,
        reconnectionAttempts: 5,
        reconnectionDelay: 1000,
    });
    
    socket.on('connect', function() {
        console.log('âœ… Socket.IO é€£ç·šæˆåŠŸï¼Œsocket.id:', socket.id);
    });
    
    socket.on('disconnect', function(reason) {
        console.log('âŒ Socket.IO æ–·ç·š:', reason);
    });

    // âœ… å·²ç¦ç”¨ï¼šé¿å…ä¸ socket.js ä¸­çš„ç›‘å¬å™¨é‡å¤
    // æ•°æ®æ›´æ–°ç»Ÿä¸€ç”± socket.js çš„ agvStore.setState() å¤„ç†
    // agvPage.js ä¼šé€šè¿‡ agvStore.on('change') è‡ªåŠ¨æ›´æ–°ç•Œé¢
    /*
    // ç›£è½ JSON ç‹€æ…‹æ›´æ–° (4 åˆ†é¡)
    socket.on('agv_status_update', function(data) {
        console.log('æ”¶åˆ° AGV JSON ç‹€æ…‹æ›´æ–°:', data);
        if (data && data.agv_status) {
            const fullData = data.agv_status;  // é€™æ˜¯å®Œæ•´çš„è³‡æ–™ï¼ŒåŒ…å« metadata, agv_status, contexts ç­‰
            const agvId = fullData.AGV_ID || fullData.agv_id || (fullData.metadata && fullData.metadata.agv_id);

            // âœ… æ”¹å–„ 1ï¼šåš´æ ¼æª¢æŸ¥ AGV ID å­˜åœ¨æ€§
            if (!agvId) {
                console.warn('[AGVUI] æ”¶åˆ°çš„ç‹€æ…‹æ²’æœ‰ AGV IDï¼Œè·³é');
                return;
            }

            // âœ… æ”¹å–„ 2ï¼šæª¢æŸ¥ currentAgvId æ˜¯å¦å·²è¨­å®š
            if (!currentAgvId) {
                console.warn('[AGVUI] currentAgvId å°šæœªè¨­å®šï¼Œè·³éæ­¤æ¬¡æ›´æ–°');
                return;
            }

            // âœ… æ”¹å–„ 3ï¼šåš´æ ¼éæ¿¾éç•¶å‰ AGV
            if (currentAgvId !== agvId) {
                console.debug(`[AGVUI] è·³ééæœ¬æ©Ÿ AGV: ${agvId} (æœ¬æ©Ÿ: ${currentAgvId})`);
                return;
            }

            // âœ… æ”¹å–„ 4ï¼šè¨˜éŒ„é€šééæ¿¾çš„è³‡æ–™
            console.log(`[AGVUI] æ¥å—æœ¬æ©Ÿ AGV ç‹€æ…‹: ${agvId}`);

            // æ›´æ–°è³‡æ–™å„²å­˜
            agvDataStore[agvId] = fullData;

            // âœ… ä¿®æ”¹ï¼šç§»é™¤æ—§çš„ updateSingleAgvDisplay è°ƒç”¨
            // æ•°æ®å·²é€šè¿‡ agvStore.setState() æ›´æ–°ï¼ˆç”± socket.js å¤„ç†ï¼‰
            // agvPage.js ä¼šé€šè¿‡ agvStore.on('change') ç›‘å¬å™¨è‡ªåŠ¨æ›´æ–°ç•Œé¢
            // ä½¿ç”¨ requestAnimationFrame é¿å…éåº¦æ›´æ–°
            if (!window.updatePending && typeof updateDisplay === 'function') {
                window.updatePending = true;
                requestAnimationFrame(() => {
                    // å¤šè»Šæ¨¡å¼
                    updateDisplay(agvId);
                    window.updatePending = false;
                });
            }
        }
    });
    */
    
    // ç›£è½ PLC ç‹€æ…‹æ›´æ–° (330+ å±¬æ€§)
    socket.on('plc_status_update', function(data) {
        console.log('æ”¶åˆ° AGV PLC ç‹€æ…‹æ›´æ–° (330+ å±¬æ€§):', data);
        if (data && data.plc_status) {
            const plcData = data.plc_status;
            const agvId = plcData.AGV_ID || plcData.agv_id;
            if (agvId) {
                plcDataStore[agvId] = plcData;
                // å¦‚æœæ˜¯ç•¶å‰é¸ä¸­çš„ AGVï¼Œæ›´æ–°å®Œæ•´ PLC é¡¯ç¤º
                if (currentAgvId === agvId) {
                    updatePLCDisplay(plcData);
                }
            }
        }
    });

    // âœ… æ–°å¢ï¼šç›£è½ ROS è¨Šæ¯æ›´æ–°ï¼ˆç°¡å–®çµæ§‹ï¼‰
    socket.on('ros_message_update', function(data) {
        console.log('æ”¶åˆ° ROS è¨Šæ¯æ›´æ–°:', data);
        if (data && data.ros_message) {
            const rosMsg = data.ros_message;
            const agvId = rosMsg.agv_id;

            // éæ¿¾éæœ¬æ©Ÿ AGV
            if (currentAgvId && agvId && agvId !== currentAgvId) {
                console.debug(`è·³ééæœ¬æ©Ÿ ROS è¨Šæ¯: ${agvId}`);
                return;
            }

            rosMessageStore = rosMsg;
            // å¦‚æœç•¶å‰åœ¨ ROS åˆ†é ï¼Œæ›´æ–°é¡¯ç¤º
            const rosTab = document.querySelector('[data-tab="ros-tab"]');
            if (rosTab && rosTab.classList.contains('is-active')) {
                updateRosMessageDisplay(rosMsg);
            }
        }
    });
}

// âœ… æ–°å¢ï¼šåˆ†é åˆ‡æ›é‚è¼¯
function initTabSwitching() {
    const tabs = document.querySelectorAll('.tabs li[data-tab]');
    tabs.forEach(tab => {
        tab.addEventListener('click', function() {
            const tabName = this.getAttribute('data-tab');

            // æ›´æ–°åˆ†é ç‹€æ…‹
            tabs.forEach(t => t.classList.remove('is-active'));
            this.classList.add('is-active');

            // åˆ‡æ›é¡¯ç¤ºå…§å®¹
            if (tabName === 'json-tab') {
                document.getElementById('json-status-container').style.display = 'block';
                document.getElementById('ros-status-container').style.display = 'none';
            } else if (tabName === 'ros-tab') {
                document.getElementById('json-status-container').style.display = 'none';
                document.getElementById('ros-status-container').style.display = 'block';
                // åˆ‡æ›åˆ° ROS åˆ†é æ™‚ï¼Œç«‹å³é¡¯ç¤ºè³‡æ–™
                if (rosMessageStore) {
                    updateRosMessageDisplay(rosMessageStore);
                }
            }
        });
    });
}

// âœ… æ–°å¢ï¼šé¡¯ç¤º ROS è¨Šæ¯
function updateRosMessageDisplay(rosMsg) {
    const container = document.getElementById('ros-status-content');
    if (!container) return;

    container.innerHTML = '';

    // å‰µå»ºè¡¨æ ¼é¡¯ç¤º
    const columnDiv = document.createElement('div');
    columnDiv.className = 'column is-12';

    const card = document.createElement('div');
    card.className = 'card';

    const cardHeader = document.createElement('header');
    cardHeader.className = 'card-header';
    cardHeader.innerHTML = `
        <p class="card-header-title">
            ROS2 AgvStatus è¨Šæ¯
            <span class="tag is-light ml-2">${Object.keys(rosMsg).length} æ¬„ä½</span>
        </p>
    `;

    const cardContent = document.createElement('div');
    cardContent.className = 'card-content';

    const table = document.createElement('table');
    table.className = 'table is-fullwidth is-striped';

    const tbody = document.createElement('tbody');

    // é¡¯ç¤ºæ‰€æœ‰æ¬„ä½
    for (const [key, value] of Object.entries(rosMsg)) {
        const row = document.createElement('tr');

        const keyCell = document.createElement('td');
        keyCell.style.width = '40%';
        keyCell.innerHTML = `<strong>${key}</strong>`;

        const valueCell = document.createElement('td');
        valueCell.style.width = '60%';

        // æ ¼å¼åŒ–æ•¸å€¼
        if (typeof value === 'number') {
            if (key.includes('power') || key.includes('POWER')) {
                valueCell.innerHTML = `<span class="tag is-info">${value.toFixed(1)}%</span>`;
            } else if (key.includes('slam') || key.includes('SLAM')) {
                valueCell.innerHTML = `<span class="has-text-info">${value.toFixed(2)}</span>`;
            } else {
                valueCell.innerHTML = `<span class="has-text-info">${value}</span>`;
            }
        } else if (typeof value === 'boolean') {
            valueCell.innerHTML = value
                ? '<span class="tag is-success">âœ“</span>'
                : '<span class="tag is-light">âœ—</span>';
        } else {
            valueCell.textContent = value || '-';
        }

        row.appendChild(keyCell);
        row.appendChild(valueCell);
        tbody.appendChild(row);
    }

    table.appendChild(tbody);
    cardContent.appendChild(table);
    card.appendChild(cardHeader);
    card.appendChild(cardContent);
    columnDiv.appendChild(card);
    container.appendChild(columnDiv);
}

// æ›´æ–° PLC å®Œæ•´ç‹€æ…‹é¡¯ç¤º (330+ å±¬æ€§)
function updatePLCDisplay(plcData) {
    if (!plcData) return;
    
    const plcContainer = document.getElementById('plc-status-container');
    const plcCategoriesDiv = document.getElementById('plc-status-categories');
    
    if (plcContainer && plcCategoriesDiv) {
        // é¡¯ç¤º PLC å®¹å™¨
        plcContainer.style.display = 'block';
        
        // åˆ†é¡ PLC è³‡æ–™
        const categories = categorizePLCStatus(plcData);
        
        // æ¸…ç©ºä¸¦é‡æ–°å»ºç«‹é¡¯ç¤º
        plcCategoriesDiv.innerHTML = '';
        
        // ç‚ºæ¯å€‹åˆ†é¡å»ºç«‹å¡ç‰‡
        for (const [category, items] of Object.entries(categories)) {
            // æ±ºå®šæ¬„ä½å¯¬åº¦
            const itemCount = Object.keys(items).length;
            let columnClass = 'column is-4'; // é è¨­ 3 æ¬„
            
            // æ ¹æ“šé …ç›®æ•¸é‡èª¿æ•´æ¬„ä½å¯¬åº¦
            if (category === 'è¼¸å…¥ç‹€æ…‹' || category === 'è¼¸å‡ºç‹€æ…‹' || category === 'è­¦å ±ç‹€æ…‹') {
                columnClass = 'column is-12'; // IO/è­¦å ±ä½¿ç”¨å…¨å¯¬
            } else if (itemCount <= 10) {
                columnClass = 'column is-3'; // å°åˆ†é¡ç”¨ 4 æ¬„
            }
            
            const columnDiv = document.createElement('div');
            columnDiv.className = columnClass;
            
            const card = document.createElement('div');
            card.className = 'card';
            card.style.height = '100%';
            
            // å¡ç‰‡æ¨™é¡Œ
            const cardHeader = document.createElement('header');
            cardHeader.className = 'card-header';
            cardHeader.innerHTML = `
                <p class="card-header-title">
                    ${category} 
                    <span class="tag is-light ml-2">${itemCount}</span>
                </p>
            `;
            
            // å¡ç‰‡å…§å®¹
            const cardContent = document.createElement('div');
            cardContent.className = 'card-content';
            cardContent.style.maxHeight = '400px';
            cardContent.style.overflowY = 'auto';
            cardContent.style.padding = '0.75rem';
            
            // å°æ–¼ IO å’Œè­¦å ±ç‹€æ…‹ï¼Œä½¿ç”¨ç‰¹æ®Šçš„ç¶²æ ¼é¡¯ç¤º
            if (category === 'è¼¸å…¥ç‹€æ…‹' || category === 'è¼¸å‡ºç‹€æ…‹' || category === 'è­¦å ±ç‹€æ…‹') {
                const gridContainer = document.createElement('div');
                gridContainer.style.display = 'grid';
                gridContainer.style.gridTemplateColumns = 'repeat(20, 1fr)';
                gridContainer.style.gap = '4px';
                gridContainer.style.padding = '8px';
                
                // æ’åºé …ç›®
                const sortedEntries = Object.entries(items).sort((a, b) => {
                    const numA = parseInt(a[0].match(/\d+/)?.[0] || 0);
                    const numB = parseInt(b[0].match(/\d+/)?.[0] || 0);
                    return numA - numB;
                });
                
                // å»ºç«‹æ¯å€‹ IO æŒ‡ç¤ºå™¨
                for (const [key, value] of sortedEntries) {
                    const indicator = document.createElement('div');
                    indicator.style.width = '100%';
                    indicator.style.paddingTop = '100%';
                    indicator.style.position = 'relative';
                    indicator.style.borderRadius = '4px';
                    indicator.style.border = '1px solid #ddd';
                    indicator.style.cursor = 'pointer';
                    
                    // æ ¹æ“šå€¼è¨­å®šé¡è‰²
                    if (value === 1 || value === true) {
                        indicator.style.backgroundColor = '#48c774';
                        indicator.style.boxShadow = '0 0 8px rgba(72, 199, 116, 0.5)';
                    } else {
                        indicator.style.backgroundColor = '#f5f5f5';
                    }
                    
                    // å…§éƒ¨æ¨™ç±¤
                    const label = document.createElement('div');
                    label.style.position = 'absolute';
                    label.style.top = '50%';
                    label.style.left = '50%';
                    label.style.transform = 'translate(-50%, -50%)';
                    label.style.fontSize = '10px';
                    label.style.fontWeight = 'bold';
                    label.style.color = value ? 'white' : '#999';
                    
                    // æå–æ•¸å­—
                    const num = key.match(/\d+/)?.[0] || key;
                    label.textContent = num;
                    
                    // Tooltip
                    indicator.title = `${key}: ${value}`;
                    
                    indicator.appendChild(label);
                    gridContainer.appendChild(indicator);
                }
                
                cardContent.appendChild(gridContainer);
            } else {
                // å…¶ä»–åˆ†é¡ä½¿ç”¨è¡¨æ ¼é¡¯ç¤º
                const table = document.createElement('table');
                table.className = 'table is-narrow is-fullwidth';
                table.style.fontSize = '0.875rem';
                
                const tbody = document.createElement('tbody');
                
                // é¡¯ç¤ºè©²åˆ†é¡çš„é …ç›®
                for (const [key, value] of Object.entries(items)) {
                    const row = document.createElement('tr');
                    
                    const keyCell = document.createElement('td');
                    keyCell.style.width = '60%';
                    keyCell.style.padding = '0.25rem';
                    keyCell.innerHTML = `<small>${key}</small>`;
                    
                    const valueCell = document.createElement('td');
                    valueCell.style.width = '40%';
                    valueCell.style.padding = '0.25rem';
                    valueCell.style.textAlign = 'right';
                    
                    // æ ¼å¼åŒ–é¡¯ç¤º
                    formatPLCValue(valueCell, value, key);
                    
                    row.appendChild(keyCell);
                    row.appendChild(valueCell);
                    tbody.appendChild(row);
                }
                
                table.appendChild(tbody);
                cardContent.appendChild(table);
            }
            
            card.appendChild(cardHeader);
            card.appendChild(cardContent);
            columnDiv.appendChild(card);
            plcCategoriesDiv.appendChild(columnDiv);
        }
    }
}

// åˆ†é¡ PLC ç‹€æ…‹è³‡æ–™
function categorizePLCStatus(status) {
    const categories = {
        'åŸºæœ¬è³‡è¨Š': {},
        'ä½ç½®ç‹€æ…‹': {},
        'é€Ÿåº¦ç‹€æ…‹': {},
        'ä½å…ƒç‹€æ…‹': {},
        'é–€æ§ç‹€æ…‹': {},
        'è¼¸å…¥ç‹€æ…‹': {},
        'è¼¸å‡ºç‹€æ…‹': {},
        'è­¦å ±ç‹€æ…‹': {},
        'PLCè¨˜æ†¶é«”': {},
        'å…¶ä»–': {}
    };
    
    for (const [key, value] of Object.entries(status)) {
        if (key.includes('AGV_ID') || key.includes('MAGIC') || key.includes('timestamp') || key.includes('namespace')) {
            categories['åŸºæœ¬è³‡è¨Š'][key] = value;
        } else if (key.includes('SLAM') || key.includes('PGV') || key.includes('POINT') || key.includes('ZONE') || key.includes('X_DIST') || key.includes('Y_DIST')) {
            categories['ä½ç½®ç‹€æ…‹'][key] = value;
        } else if (key.includes('SPEED') || key.includes('POWER')) {
            categories['é€Ÿåº¦ç‹€æ…‹'][key] = value;
        } else if (key.includes('AGV_') && (key.includes('Auto') || key.includes('Manual') || key.includes('MOVING') || key.includes('TURN') || key.includes('IDLE') || key.includes('ALARM'))) {
            categories['ä½å…ƒç‹€æ…‹'][key] = value;
        } else if (key.includes('DOOR')) {
            categories['é–€æ§ç‹€æ…‹'][key] = value;
        } else if (key.includes('INPUT_') || key.includes('Input')) {
            categories['è¼¸å…¥ç‹€æ…‹'][key] = value;
        } else if (key.includes('OUTPUT_') || key.includes('Output')) {
            categories['è¼¸å‡ºç‹€æ…‹'][key] = value;
        } else if (key.includes('Alarm') || key.includes('ALARM')) {
            categories['è­¦å ±ç‹€æ…‹'][key] = value;
        } else if (key.includes('PLC')) {
            categories['PLCè¨˜æ†¶é«”'][key] = value;
        } else {
            categories['å…¶ä»–'][key] = value;
        }
    }
    
    // ç§»é™¤ç©ºçš„åˆ†é¡
    for (const category in categories) {
        if (Object.keys(categories[category]).length === 0) {
            delete categories[category];
        }
    }
    
    return categories;
}

// æ ¼å¼åŒ– PLC æ•¸å€¼é¡¯ç¤º
function formatPLCValue(cell, value, key) {
    if (value === null || value === undefined) {
        cell.innerHTML = '<small class="has-text-grey">-</small>';
    } else if (typeof value === 'boolean') {
        cell.innerHTML = value 
            ? '<span class="has-text-success">âœ“</span>' 
            : '<span class="has-text-grey-light">âœ—</span>';
    } else if (typeof value === 'number') {
        let displayValue = value;
        if (key.includes('SPEED') || key.includes('SLAM') || key.includes('DIST')) {
            displayValue = value.toFixed(2);
        } else if (key.includes('POWER')) {
            displayValue = value.toFixed(1) + '%';
        }
        cell.innerHTML = `<small class="has-text-info has-text-weight-semibold">${displayValue}</small>`;
    } else {
        cell.innerHTML = `<small>${value}</small>`;
    }
}

// å…¨åŸŸå‡½æ•¸å®šç¾© - ä¾›æ‰€æœ‰æ¨¡å¼ä½¿ç”¨

// æ›´æ–°ç‹€æ…‹æ‘˜è¦
function updateStatusSummary(data, agvId) {
    const summaryDiv = document.getElementById('status-summary');
    if (!summaryDiv || !data) return;
    
    const metadata = data.metadata || {};
    const agvStatus = data.agv_status || {};
    const contexts = data.contexts || {};
    
    summaryDiv.innerHTML = `
        <div class="columns is-multicolumn">
            <div class="column">
                <div class="field">
                    <label class="label">AGV ID</label>
                    <div class="control">
                        <input class="input" type="text" value="${metadata.agv_id || agvId}" readonly>
                    </div>
                </div>
            </div>
            <div class="column">
                <div class="field">
                    <label class="label">å‹è™Ÿ</label>
                    <div class="control">
                        <input class="input" type="text" value="${metadata.agv_type || 'Unknown'}" readonly>
                    </div>
                </div>
            </div>
            <div class="column">
                <div class="field">
                    <label class="label">æ¨¡å¼</label>
                    <div class="control">
                        <input class="input ${agvStatus.AGV_Auto ? 'is-success' : 'is-warning'}" 
                               type="text" value="${agvStatus.AGV_Auto ? 'è‡ªå‹•' : 'æ‰‹å‹•'}" readonly>
                    </div>
                </div>
            </div>
            <div class="column">
                <div class="field">
                    <label class="label">ç‹€æ…‹</label>
                    <div class="control">
                        <input class="input ${agvStatus.AGV_ALARM ? 'is-danger' : (agvStatus.AGV_IDLE ? 'is-info' : 'is-success')}" 
                               type="text" value="${agvStatus.AGV_ALARM ? 'è­¦å ±' : (agvStatus.AGV_IDLE ? 'é–’ç½®' : 'é‹è¡Œä¸­')}" readonly>
                    </div>
                </div>
            </div>
            <div class="column">
                <div class="field">
                    <label class="label">é›»é‡</label>
                    <div class="control">
                        <input class="input ${agvStatus.POWER < 30 ? 'is-danger' : (agvStatus.POWER < 50 ? 'is-warning' : 'is-success')}" 
                               type="text" value="${agvStatus.POWER || 0}%" readonly>
                    </div>
                </div>
            </div>
        </div>
    `;
}

// âœ… å·²åˆ é™¤æ—§çš„åˆ†ç±»å‡½æ•° updateCategoriesDisplay() å’Œ updateSingleAgvDisplay()
// ç°åœ¨ç»Ÿä¸€ä½¿ç”¨ agvPage.js æ¨¡å—ä¸­çš„æ–°åˆ†ç±»é€»è¾‘ï¼Œæ”¯æŒ N/L æ ‡è®°å’Œ DOM ç¼“å­˜

// åˆ¤æ–·æ˜¯å¦ç‚ºå¤šè»Šç›£æ§æ¨¡å¼
const containerType = document.getElementById('container-type').value;
const localAgvId = document.getElementById('local-agv-id').value;
const isMultiMode = containerType === 'agvc' && !localAgvId;
// currentAgvId å·²åœ¨æª”æ¡ˆé–‹é ­å®šç¾©

if (isMultiMode) {
    // å¤šè»Šç›£æ§æ¨¡å¼ - ä½¿ç”¨æ–°çš„ API
    console.log('å•Ÿå‹•å¤šè»Šç›£æ§æ¨¡å¼');
    
    // è®Šæ•¸å·²åœ¨æª”æ¡ˆé–‹é ­å®šç¾©ï¼Œé€™è£¡ä¸éœ€è¦é‡è¤‡å®šç¾©
    
    // åˆå§‹åŒ–åˆ†é 
    function initTabs() {
        const tabs = document.querySelectorAll('.agv-tab');
        tabs.forEach(tab => {
            tab.addEventListener('click', function() {
                const agvId = this.dataset.agv;
                selectAgv(agvId);
            });
        });
    }
    
    // é¸æ“‡ AGV
    function selectAgv(agvId) {
        // æ›´æ–°åˆ†é ç‹€æ…‹
        document.querySelectorAll('.agv-tab').forEach(tab => {
            tab.classList.remove('is-active');
        });
        document.querySelector(`.agv-tab[data-agv="${agvId}"]`).classList.add('is-active');
        
        currentAgvId = agvId;
        updateDisplay(agvId);
        
        // å¦‚æœæœ‰ PLC è³‡æ–™ï¼Œä¹Ÿæ›´æ–° PLC é¡¯ç¤º
        if (plcDataStore[agvId]) {
            updatePLCDisplay(plcDataStore[agvId]);
        } else {
            // éš±è— PLC å®¹å™¨
            const plcContainer = document.getElementById('plc-status-container');
            if (plcContainer) {
                plcContainer.style.display = 'none';
            }
        }
    }
    
    // æ›´æ–°é¡¯ç¤º
    function updateDisplay(agvId) {
        const data = agvDataStore[agvId];
        const categoriesContainer = document.getElementById('status-categories');
        const summaryDiv = document.getElementById('status-summary');
        
        if (data) {
            // é¡¯ç¤ºæ‘˜è¦
            if (summaryDiv) {
                summaryDiv.style.display = 'block';
                updateStatusSummary(data, agvId);
            }
            
            // é¡¯ç¤ºè©³ç´°è³‡æ–™
            if (categoriesContainer) {
                updateCategoriesDisplay(data, categoriesContainer);
            }
        } else {
            // ç„¡è³‡æ–™æ™‚éš±è—
            if (summaryDiv) summaryDiv.style.display = 'none';
            if (categoriesContainer) categoriesContainer.innerHTML = '<div class="notification">æ­¤ AGV ç›®å‰é›¢ç·š</div>';
        }
    }
    
    // updateStatusSummary å·²åœ¨å…¨åŸŸå®šç¾©ï¼ˆç¬¬ 472 è¡Œï¼‰
    /*
    function updateStatusSummary(data, agvId) {
        const summaryDiv = document.getElementById('status-summary');
        if (!summaryDiv) return;
        
        const metadata = data.metadata || {};
        const agvStatus = data.agv_status || {};
        const contexts = data.contexts || {};
        
        summaryDiv.innerHTML = `
            <nav class="level">
                <div class="level-item has-text-centered">
                    <div>
                        <p class="heading">AGV ID</p>
                        <p class="title">${agvId}</p>
                    </div>
                </div>
                <div class="level-item has-text-centered">
                    <div>
                        <p class="heading">è»Šå‹</p>
                        <p class="title">${metadata.agv_type || '-'}</p>
                    </div>
                </div>
                <div class="level-item has-text-centered">
                    <div>
                        <p class="heading">ç‹€æ…‹</p>
                        <p class="title">${contexts.base_context?.current_state || '-'}</p>
                    </div>
                </div>
                <div class="level-item has-text-centered">
                    <div>
                        <p class="heading">ä½ç½®</p>
                        <p class="title">${agvStatus.X_DIST?.toFixed(2) || 0}, ${agvStatus.Y_DIST?.toFixed(2) || 0}</p>
                    </div>
                </div>
                <div class="level-item has-text-centered">
                    <div>
                        <p class="heading">é›»é‡</p>
                        <p class="title ${agvStatus.POWER > 50 ? 'has-text-success' : agvStatus.POWER > 20 ? 'has-text-warning' : 'has-text-danger'}">${agvStatus.POWER || 0}%</p>
                    </div>
                </div>
            </nav>
        `;
    }
    */
    
    // updateCategoriesDisplay å·²åœ¨å…¨åŸŸå®šç¾©ï¼ˆç¬¬ 530 è¡Œï¼‰
    /*
    function updateCategoriesDisplay(data, container) {
        container.innerHTML = '';
        
        // å»ºç«‹åˆ†é¡é¡¯ç¤º
        const categories = {
            'Metadata': data.metadata || {},
            'AGV Status': data.agv_status || {},
            'Contexts': data.contexts || {},
            'Type Specific': data.type_specific || {}
        };
        
        // ä½¿ç”¨å¤šæ¬„ä½ˆå±€
        const columnsDiv = document.createElement('div');
        columnsDiv.className = 'columns is-multiline';
        
        for (const [category, items] of Object.entries(categories)) {
            const columnDiv = document.createElement('div');
            columnDiv.className = 'column is-6';
            
            const card = document.createElement('div');
            card.className = 'card';
            
            const cardHeader = document.createElement('header');
            cardHeader.className = 'card-header';
            cardHeader.innerHTML = `<p class="card-header-title">${category}</p>`;
            
            const cardContent = document.createElement('div');
            cardContent.className = 'card-content';
            
            const table = document.createElement('table');
            table.className = 'table is-narrow is-fullwidth';
            const tbody = document.createElement('tbody');
            
            // é¡¯ç¤ºè³‡æ–™ï¼Œè™•ç†å·¢ç‹€ç‰©ä»¶
            displayObjectAsTable(items, tbody);
            
            table.appendChild(tbody);
            cardContent.appendChild(table);
            card.appendChild(cardHeader);
            card.appendChild(cardContent);
            columnDiv.appendChild(card);
            columnsDiv.appendChild(columnDiv);
        }
        
        container.appendChild(columnsDiv);
    }
    
    // éè¿´é¡¯ç¤ºç‰©ä»¶ç‚ºè¡¨æ ¼
    function displayObjectAsTable(obj, tbody, prefix = '') {
        for (const [key, value] of Object.entries(obj)) {
            const row = document.createElement('tr');
            const keyCell = document.createElement('td');
            const valueCell = document.createElement('td');
            
            keyCell.textContent = prefix + key;
            keyCell.style.fontWeight = 'bold';
            
            if (value === null || value === undefined) {
                valueCell.textContent = '-';
                valueCell.className = 'has-text-grey';
            } else if (typeof value === 'object' && !Array.isArray(value)) {
                // å·¢ç‹€ç‰©ä»¶ï¼Œéè¿´é¡¯ç¤º
                valueCell.textContent = '{...}';
                valueCell.className = 'has-text-info';
                row.appendChild(keyCell);
                row.appendChild(valueCell);
                tbody.appendChild(row);
                // éè¿´é¡¯ç¤ºå­ç‰©ä»¶
                displayObjectAsTable(value, tbody, '  â†’ ');
                continue;
            } else if (Array.isArray(value)) {
                valueCell.textContent = '[' + value.join(', ') + ']';
            } else if (typeof value === 'boolean') {
                valueCell.innerHTML = value ? 
                    '<span class="has-text-success">âœ“</span>' : 
                    '<span class="has-text-danger">âœ—</span>';
            } else {
                valueCell.textContent = value;
            }
            
            row.appendChild(keyCell);
            row.appendChild(valueCell);
            tbody.appendChild(row);
        }
    }
    
    // å–å¾—æ‰€æœ‰ AGV ç‹€æ…‹
    async function fetchAllAgvStatus() {
        for (const agvId of agvList) {
            try {
                const response = await fetch(`/api/agv-status/${agvId}`);
                if (response.ok) {
                    const data = await response.json();
                    if (data && !data.error && data.metadata) {
                        agvDataStore[agvId] = data;
                        updateAgvTabStatus(agvId, true);
                        
                        // å¦‚æœæ˜¯ç•¶å‰é¸ä¸­çš„ AGVï¼Œæ›´æ–°é¡¯ç¤º
                        if (agvId === currentAgvId) {
                            updateDisplay(agvId);
                        }
                    } else {
                        agvDataStore[agvId] = null;
                        updateAgvTabStatus(agvId, false);
                    }
                } else {
                    agvDataStore[agvId] = null;
                    updateAgvTabStatus(agvId, false);
                }
            } catch (error) {
                console.error(`Error fetching ${agvId} status:`, error);
                agvDataStore[agvId] = null;
                updateAgvTabStatus(agvId, false);
            }
        }
    }
    
    // æ›´æ–°åˆ†é ç‹€æ…‹æ¨™ç±¤
    function updateAgvTabStatus(agvId, isOnline) {
        const statusTag = document.getElementById(`status-${agvId}`);
        if (statusTag) {
            if (isOnline) {
                statusTag.textContent = 'ç·šä¸Š';
                statusTag.className = 'tag is-rounded ml-2 is-success';
            } else {
                statusTag.textContent = 'é›¢ç·š';
                statusTag.className = 'tag is-rounded ml-2 is-danger';
            }
        }
    }
    
    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
        // âœ… åˆå§‹åŒ–åˆ†é åˆ‡æ›
        initTabSwitching();

        // åˆå§‹åŒ– Socket.IO é€£æ¥
        initSocketIO();
        
        initTabs();
        fetchAllAgvStatus().then(() => {
            // é è¨­é¸æ“‡ç¬¬ä¸€å€‹ AGV
            selectAgv('loader01');
        });
        
        // æ¯ç§’æ›´æ–°
        setInterval(fetchAllAgvStatus, 1000);
        
        // é‡æ–°æ•´ç†æŒ‰éˆ•
        document.getElementById('refresh-button').addEventListener('click', function() {
            fetchAllAgvStatus();
        });
    });
    
} else {
    // å–®è»Šç›£æ§æ¨¡å¼ - ä½¿ç”¨æ–°çš„ JSON API
    console.log('è¼‰å…¥å–®è»Šç›£æ§æ¨¡å¼');
    const agvId = localAgvId || 'loader01';  // é è¨­ loader01
    
    // å–å¾—ä¸¦é¡¯ç¤ºå–®ä¸€ AGV ç‹€æ…‹
    async function fetchSingleAgvStatus() {
        try {
            const response = await fetch(`/api/agv-status/${agvId}`);
            if (response.ok) {
                const data = await response.json();
                if (data && !data.error && data.metadata) {
                    updateSingleAgvDisplay(data);
                } else {
                    console.error('ç„¡æ•ˆçš„ AGV è³‡æ–™');
                    showNoDataMessage();
                }
            } else {
                console.error('ç„¡æ³•å–å¾— AGV ç‹€æ…‹');
                showNoDataMessage();
            }
        } catch (error) {
            console.error(`Error fetching ${agvId} status:`, error);
            showNoDataMessage();
        }
    }
    
    // updateSingleAgvDisplay å·²ç§»è‡³å…¨åŸŸå®šç¾©
    
    // é¡¯ç¤ºç„¡è³‡æ–™è¨Šæ¯
    function showNoDataMessage() {
        const categoriesContainer = document.getElementById('status-categories');
        const summaryDiv = document.getElementById('status-summary');
        
        if (summaryDiv) summaryDiv.style.display = 'none';
        if (categoriesContainer) {
            categoriesContainer.innerHTML = '<div class="notification is-warning">ç„¡æ³•å–å¾— AGV è³‡æ–™ï¼Œè«‹ç¢ºèª AGV æ˜¯å¦åœ¨ç·šä¸Š</div>';
        }
    }
    
    // updateStatusSummary å·²åœ¨å…¨åŸŸå®šç¾©ï¼ˆç¬¬ 472 è¡Œï¼‰
    /*
    function updateStatusSummary(data, agvId) {
        const summaryDiv = document.getElementById('status-summary');
        if (!summaryDiv) return;
        
        const metadata = data.metadata || {};
        const agvStatus = data.agv_status || {};
        const contexts = data.contexts || {};
        
        summaryDiv.innerHTML = `
            <nav class="level">
                <div class="level-item has-text-centered">
                    <div>
                        <p class="heading">AGV ID</p>
                        <p class="title">${agvId}</p>
                    </div>
                </div>
                <div class="level-item has-text-centered">
                    <div>
                        <p class="heading">è»Šå‹</p>
                        <p class="title">${metadata.agv_type || '-'}</p>
                    </div>
                </div>
                <div class="level-item has-text-centered">
                    <div>
                        <p class="heading">ç‹€æ…‹</p>
                        <p class="title">${contexts.base_context?.current_state || '-'}</p>
                    </div>
                </div>
                <div class="level-item has-text-centered">
                    <div>
                        <p class="heading">ä½ç½®</p>
                        <p class="title">${agvStatus.X_DIST?.toFixed(2) || 0}, ${agvStatus.Y_DIST?.toFixed(2) || 0}</p>
                    </div>
                </div>
                <div class="level-item has-text-centered">
                    <div>
                        <p class="heading">é›»é‡</p>
                        <p class="title ${agvStatus.POWER > 50 ? 'has-text-success' : agvStatus.POWER > 20 ? 'has-text-warning' : 'has-text-danger'}">${agvStatus.POWER || 0}%</p>
                    </div>
                </div>
            </nav>
        `;
    }
    */
    
    // updateCategoriesDisplay å·²åœ¨å…¨åŸŸå®šç¾©ï¼ˆç¬¬ 530 è¡Œï¼‰
    /*
    function updateCategoriesDisplay(data, container) {
        container.innerHTML = '';
        
        // å»ºç«‹åˆ†é¡é¡¯ç¤º
        const categories = {
            'Metadata': data.metadata || {},
            'AGV Status': data.agv_status || {},
            'Contexts': data.contexts || {},
            'Type Specific': data.type_specific || {}
        };
        
        // ä½¿ç”¨å¤šæ¬„ä½ˆå±€
        const columnsDiv = document.createElement('div');
        columnsDiv.className = 'columns is-multiline';
        
        for (const [category, items] of Object.entries(categories)) {
            const columnDiv = document.createElement('div');
            columnDiv.className = 'column is-6';
            
            const card = document.createElement('div');
            card.className = 'card';
            
            const cardHeader = document.createElement('header');
            cardHeader.className = 'card-header';
            cardHeader.innerHTML = `<p class="card-header-title">${category}</p>`;
            
            const cardContent = document.createElement('div');
            cardContent.className = 'card-content';
            
            const table = document.createElement('table');
            table.className = 'table is-narrow is-fullwidth';
            const tbody = document.createElement('tbody');
            
            // é¡¯ç¤ºè³‡æ–™ï¼Œè™•ç†å·¢ç‹€ç‰©ä»¶
            displayObjectAsTable(items, tbody);
            
            table.appendChild(tbody);
            cardContent.appendChild(table);
            card.appendChild(cardHeader);
            card.appendChild(cardContent);
            columnDiv.appendChild(card);
            columnsDiv.appendChild(columnDiv);
        }
        
        container.appendChild(columnsDiv);
    }
    
    // éè¿´é¡¯ç¤ºç‰©ä»¶ç‚ºè¡¨æ ¼ï¼ˆèˆ‡å¤šè»Šæ¨¡å¼å…±ç”¨ï¼‰
    function displayObjectAsTable(obj, tbody, prefix = '') {
        for (const [key, value] of Object.entries(obj)) {
            const row = document.createElement('tr');
            const keyCell = document.createElement('td');
            const valueCell = document.createElement('td');
            
            keyCell.textContent = prefix + key;
            keyCell.style.fontWeight = 'bold';
            
            if (value === null || value === undefined) {
                valueCell.textContent = '-';
                valueCell.className = 'has-text-grey';
            } else if (typeof value === 'object' && !Array.isArray(value)) {
                // å·¢ç‹€ç‰©ä»¶ï¼Œéè¿´é¡¯ç¤º
                valueCell.textContent = '{...}';
                valueCell.className = 'has-text-info';
                row.appendChild(keyCell);
                row.appendChild(valueCell);
                tbody.appendChild(row);
                // éè¿´é¡¯ç¤ºå­ç‰©ä»¶
                displayObjectAsTable(value, tbody, '  â†’ ');
                continue;
            } else if (Array.isArray(value)) {
                valueCell.textContent = '[' + value.join(', ') + ']';
            } else if (typeof value === 'boolean') {
                valueCell.innerHTML = value ? 
                    '<span class="has-text-success">âœ“</span>' : 
                    '<span class="has-text-danger">âœ—</span>';
            } else {
                valueCell.textContent = value;
            }
            
            row.appendChild(keyCell);
            row.appendChild(valueCell);
            tbody.appendChild(row);
        }
    }
    */
    
    // åˆå§‹åŒ–å–®è»Šæ¨¡å¼
    document.addEventListener('DOMContentLoaded', function() {
        console.log(`[AGVUI] åˆå§‹åŒ–å–®è»Šç›£æ§æ¨¡å¼ - AGV: ${agvId}`);

        // âœ… åˆå§‹åŒ–åˆ†é åˆ‡æ›
        initTabSwitching();

        // âœ… æ”¹å–„ï¼šå…ˆè¨­å®š currentAgvIdï¼Œå†åˆå§‹åŒ– Socket.IO
        currentAgvId = agvId;
        console.log(`[AGVUI] currentAgvId å·²è¨­å®šç‚º: ${currentAgvId}`);

        // âœ… é©—è­‰ AGV ID ä¸ç‚ºç©º
        if (!currentAgvId || currentAgvId === '') {
            console.error('[AGVUI] è­¦å‘Šï¼šæœ¬æ©Ÿ AGV ID æœªè¨­å®šï¼å°‡é¡¯ç¤ºæ‰€æœ‰ AGV ç‹€æ…‹');
            // é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
            const categoriesContainer = document.getElementById('status-categories');
            if (categoriesContainer) {
                categoriesContainer.innerHTML = '<div class="notification is-warning">âš ï¸ ç„¡æ³•è­˜åˆ¥æœ¬æ©Ÿ AGV IDï¼Œè«‹æª¢æŸ¥è¨­å‚™èº«ä»½é…ç½®</div>';
            }
        }

        // åˆå§‹åŒ– Socket.IO é€£æ¥ (ç¾åœ¨ currentAgvId å·²è¨­å®š)
        initSocketIO();

        // åˆå§‹è¼‰å…¥ä¸€æ¬¡è³‡æ–™
        fetchSingleAgvStatus();

        // ä¸å†ä½¿ç”¨ setIntervalï¼Œæ”¹ç‚ºä¾è³´ Socket.IO çš„å³æ™‚æ›´æ–°
        // Socket.IO æœƒæ¯ç§’è‡ªå‹•æ¨é€æ›´æ–°ï¼Œä¸éœ€è¦é‡è¤‡æ‹‰å–

        // é‡æ–°æ•´ç†æŒ‰éˆ•
        document.getElementById('refresh-button').addEventListener('click', function() {
            fetchSingleAgvStatus();
        });
    });
}
</script>
{% endblock %}