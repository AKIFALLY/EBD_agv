# Transfer Box Task Build - è®Šæ›´è¨˜éŒ„

## [ä¿®æ”¹æ—¥æœŸ: 2025-11-10] å¾ž PLC è®€å– Rack è³‡è¨Š

### ðŸ“ è®Šæ›´æ‘˜è¦
å°‡å…¥å£å’Œå‡ºå£å‚³é€ç®±çš„ Rack è³‡è¨Šè®€å–ä¾†æºå¾žã€Œè³‡æ–™åº«æŸ¥è©¢ã€æ”¹ç‚ºã€Œå¾ž PLC è®€å–ã€ã€‚

### ðŸŽ¯ ä¿®æ”¹ç›®æ¨™
- **å…¥å£å‚³é€ç®±**: å¾ž PLC DM2010~2014 è®€å– rack è³‡è¨Š
- **å‡ºå£å‚³é€ç®±**: å¾ž PLC DM2020~2024 è®€å– rack è³‡è¨Š

### ðŸ“¦ PLC DM æ ¼å¼
```
DM[0~1] (32-bit): carrier_bitmap
DM[2~3] (32-bit): carrier_enable_bitmap
DM[4]   (16-bit): direction (è§’åº¦)
```

### ðŸ”§ ä¿®æ”¹æª”æ¡ˆ

#### 1. config.py
**æ–°å¢žé…ç½®**:
- `DM_READ_RACK_COUNT = 5` - è®€å– 5 å€‹ words
- æ¯å€‹å‚³é€ç®±é…ç½®æ–°å¢ž `dm_read_rack_start` æ¬„ä½:
  - å…¥å£å‚³é€ç®±: `"dm_read_rack_start": "2010"`
  - å‡ºå£å‚³é€ç®±: `"dm_read_rack_start": "2020"`

#### 2. transfer_box_task_build_node.py
**ä¿®æ”¹é‚è¼¯**:
1. `_check_and_write_single_transfer_box()`:
   - å¾žã€ŒæŸ¥è©¢è³‡æ–™åº« Rackã€æ”¹ç‚ºã€Œå¾ž PLC è®€å–ã€
   - ä½¿ç”¨ç•°æ­¥è®€å–: `plc_client.async_read_continuous_data()`

2. **æ–°å¢žæ–¹æ³•**:
   - `_handle_rack_read_response()` - è™•ç† PLC è®€å–å›žæ‡‰
   - `_convert_direction_angle()` - å°‡è§’åº¦è½‰æ›ç‚º >0 æˆ– <0

3. **è½‰æ›è¦å‰‡**:
   - Direction: 0Â°~179Â° â†’ +1 (æ­£å‘)
   - Direction: 180Â°~359Â° â†’ -1 (åå‘)

### âš™ï¸ å·¥ä½œæµç¨‹è®ŠåŒ–

**ä¿®æ”¹å‰ï¼ˆæŸ¥è©¢è³‡æ–™åº«ï¼‰**:
```
æŸ¥è©¢ Rack â†’ è§£æž carrier_bitmap â†’ åˆ¤æ–·å¯«å…¥ â†’ å¯«å…¥ PLC
```

**ä¿®æ”¹å¾Œï¼ˆå¾ž PLC è®€å–ï¼‰**:
```
å¾ž PLC è®€å– rack è³‡è¨Š â†’ è§£æž carrier_bitmap/enable_bitmap/direction â†’ åˆ¤æ–·å¯«å…¥ â†’ å¯«å…¥ PLC
```

### âœ… ä¿æŒä¸è®Šçš„éƒ¨åˆ†
1. **å›žé¥‹æ›´æ–°æ©Ÿåˆ¶** (Timer 4) - ç¹¼çºŒä½¿ç”¨ `dm_feedback_start`
2. **Task å»ºç«‹é‚è¼¯** - æŸ¥è©¢è³‡æ–™åº« Rack åƒ…ç”¨æ–¼è¨˜éŒ„ `rack_id`
3. **PLC å¯«å…¥é‚è¼¯** - ç¶­æŒåŽŸæœ‰çš„å¯«å…¥æ©Ÿåˆ¶

### ðŸ§ª æ¸¬è©¦ç‹€æ…‹
- âœ… Python èªžæ³•æª¢æŸ¥é€šéŽ
- âœ… é…ç½®é©—è­‰é€šéŽ
- âœ… ROS2 å¥—ä»¶å»ºç½®æˆåŠŸ

### ðŸ“Š é…ç½®é©—è­‰çµæžœ
```
ðŸ“‹ é…ç½®é©—è­‰ï¼š
  DM_READ_RACK_COUNT = 5

ðŸ“¦ å‚³é€ç®±é…ç½®ï¼š
  å…¥å£å‚³é€ç®±:
    - dm_read_rack_start: 2010
    - dm_write_start: 2010
    - dm_feedback_start: 3012
  å‡ºå£å‚³é€ç®±:
    - dm_read_rack_start: 2020
    - dm_write_start: 2020
    - dm_feedback_start: 3014
```

### ðŸš€ å¾ŒçºŒæ­¥é©Ÿ
1. åœ¨å¯¦éš›ç’°å¢ƒä¸­æ¸¬è©¦ PLC è®€å–åŠŸèƒ½
2. é©—è­‰ direction è§’åº¦è½‰æ›æ˜¯å¦ç¬¦åˆé æœŸ
3. ç¢ºèªå…¥å£/å‡ºå£åˆ¤æ–·é‚è¼¯æ­£ç¢ºé‹ä½œ

### ðŸ“ æ³¨æ„äº‹é …
- PLC è³‡æ–™ä½¿ç”¨**å°ç«¯åº**æ ¼å¼ï¼ˆä½Žä½åœ¨å‰ï¼‰
- è³‡æ–™åº« Rack æŸ¥è©¢åƒ…ç”¨æ–¼ç²å– `rack_id`ï¼Œä¸å½±éŸ¿ä¸»è¦é‚è¼¯
- ç•°æ­¥è®€å–è¨­è¨ˆç¢ºä¿ä¸é˜»å¡žä¸»åŸ·è¡Œç·’
