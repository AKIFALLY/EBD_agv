# WCS Base Node è³‡æ–™è¡¨æ“ä½œé‡æ§‹ç¸½çµ

## ğŸ“‹ é‡æ§‹æ¦‚è¿°

æœ¬æ¬¡é‡æ§‹æˆåŠŸå°‡ `wcs_base_node` ä¸­çš„è³‡æ–™è¡¨æ“ä½œå’ŒæŸ¥è©¢åŠŸèƒ½ç¨ç«‹å‡ºä¸€å€‹å–®ç¨çš„ `DatabaseManager` é¡åˆ¥ï¼Œä¸¦ç›¸æ‡‰ä¿®æ”¹äº† `base_task_handler` åŠå…¶æ‰€æœ‰ç¹¼æ‰¿çš„å­é¡åˆ¥ã€‚

## âœ… å®Œæˆçš„ä»»å‹™

### 1. å‰µå»ºè³‡æ–™è¡¨æ“ä½œç®¡ç†é¡åˆ¥
- **æ–‡ä»¶**: `wcs_base/database_manager.py`
- **åŠŸèƒ½**: 
  - è³‡æ–™åº«é€£æ¥æ± ç®¡ç†
  - æ‰€æœ‰è³‡æ–™è¡¨çš„è®€å–æ–¹æ³•
  - è³‡æ–™è¡¨ç‹€æ…‹æª¢æŸ¥
  - çµ±ä¸€çš„è³‡æ–™è¨ªå•æ¥å£

### 2. ä¿®æ”¹ wcs_base_node ä½¿ç”¨ DatabaseManager
- **æ–‡ä»¶**: `wcs_base/wcs_base_node.py`
- **è®Šæ›´**:
  - ç§»é™¤åŸæœ‰çš„è³‡æ–™è¡¨æ“ä½œæ–¹æ³•
  - ä½¿ç”¨ DatabaseManager å¯¦ä¾‹è™•ç†æ‰€æœ‰è³‡æ–™åº«æ“ä½œ
  - æ›´æ–°åˆå§‹åŒ–é‚è¼¯å’Œå®šæ™‚å™¨è™•ç†é‚è¼¯
  - ç°¡åŒ– `cycle_process` å’Œ `cycle3_process` æ–¹æ³•

### 3. ä¿®æ”¹ base_task_handler ä½¿ç”¨ DatabaseManager
- **æ–‡ä»¶**: `wcs_base/base_task_handler.py`
- **è®Šæ›´**:
  - é€šé DatabaseManager è¨ªå•è³‡æ–™è¡¨æ•¸æ“š
  - æ›´æ–°æ‰€æœ‰ç›¸é—œçš„æ–¹æ³•èª¿ç”¨
  - ä¿æŒåŸæœ‰çš„æ¥­å‹™é‚è¼¯ä¸è®Š

### 4. ä¿®æ”¹ç¹¼æ‰¿çš„å­é¡åˆ¥
- **æ–‡ä»¶**: 
  - `kuka_wcs/task_handler/rack_rotate_180.py`
  - `kuka_wcs/task_handler/empty_rack_to_boxout.py`
  - `kuka_wcs/task_handler/full_rack_to_manual_receive.py`
- **è®Šæ›´**:
  - ä½¿ç”¨æ–°çš„ DatabaseManager æ¥å£è¨ªå•è³‡æ–™è¡¨æ•¸æ“š
  - æ›´æ–°è³‡æ–™åº«æœƒè©±èª¿ç”¨
  - ç¢ºä¿æ­£ç¢ºç¹¼æ‰¿ BaseTaskHandler

### 5. æ¸¬è©¦é‡æ§‹å¾Œçš„åŠŸèƒ½
- **æ–‡ä»¶**: 
  - `test/test_database_manager_integration.py`
  - `test/test_core_functionality.py`
- **çµæœ**: æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½æ¸¬è©¦é€šé

## ğŸ—ï¸ æ¶æ§‹æ”¹é€²

### é‡æ§‹å‰
```
WCSBaseNode
â”œâ”€â”€ è³‡æ–™åº«é€£æ¥æ± ç®¡ç†
â”œâ”€â”€ å„ç¨®è³‡æ–™è¡¨è®€å–æ–¹æ³•
â”œâ”€â”€ è³‡æ–™è¡¨ç‹€æ…‹æª¢æŸ¥
â”œâ”€â”€ ä»»å‹™è™•ç†é‚è¼¯
â””â”€â”€ BaseTaskHandler åŠå­é¡åˆ¥ç›´æ¥è¨ªå• node çš„è³‡æ–™è¡¨å±¬æ€§
```

### é‡æ§‹å¾Œ
```
WCSBaseNode
â”œâ”€â”€ DatabaseManager (ç¨ç«‹çš„è³‡æ–™åº«ç®¡ç†å™¨)
â”‚   â”œâ”€â”€ è³‡æ–™åº«é€£æ¥æ± ç®¡ç†
â”‚   â”œâ”€â”€ å„ç¨®è³‡æ–™è¡¨è®€å–æ–¹æ³•
â”‚   â”œâ”€â”€ è³‡æ–™è¡¨ç‹€æ…‹æª¢æŸ¥
â”‚   â””â”€â”€ çµ±ä¸€çš„è³‡æ–™è¨ªå•æ¥å£
â”œâ”€â”€ ç°¡åŒ–çš„ä»»å‹™è™•ç†é‚è¼¯
â””â”€â”€ BaseTaskHandler åŠå­é¡åˆ¥é€šé DatabaseManager è¨ªå•è³‡æ–™
```

## ğŸ“Š é‡æ§‹æ•ˆç›Š

### 1. é—œæ³¨é»åˆ†é›¢
- è³‡æ–™åº«æ“ä½œé‚è¼¯èˆ‡æ¥­å‹™é‚è¼¯åˆ†é›¢
- WCSBaseNode å°ˆæ³¨æ–¼ä»»å‹™å”èª¿
- DatabaseManager å°ˆæ³¨æ–¼è³‡æ–™ç®¡ç†

### 2. ä»£ç¢¼å¯ç¶­è­·æ€§æå‡
- è³‡æ–™åº«ç›¸é—œä»£ç¢¼é›†ä¸­ç®¡ç†
- æ›´æ¸…æ™°çš„ä¾è³´é—œä¿‚
- æ›´å®¹æ˜“é€²è¡Œå–®å…ƒæ¸¬è©¦

### 3. å¯æ“´å±•æ€§å¢å¼·
- æ–°å¢è³‡æ–™è¡¨æ“ä½œåªéœ€ä¿®æ”¹ DatabaseManager
- ä»»å‹™è™•ç†å™¨å¯ä»¥æ›´å®¹æ˜“åœ°è¨ªå•æ‰€éœ€æ•¸æ“š
- æ”¯æŒæœªä¾†çš„è³‡æ–™åº«å„ªåŒ–å’Œç·©å­˜ç­–ç•¥

### 4. éŒ¯èª¤è™•ç†æ”¹é€²
- çµ±ä¸€çš„è³‡æ–™åº«éŒ¯èª¤è™•ç†
- æ›´å¥½çš„æ—¥èªŒè¨˜éŒ„
- æ›´å®¹æ˜“é€²è¡Œæ•…éšœæ’é™¤

## ğŸ”§ ä¸»è¦è®Šæ›´é»

### DatabaseManager é¡åˆ¥
- åŒ…å«æ‰€æœ‰åŸ WCSBaseNode ä¸­çš„è³‡æ–™è¡¨æ“ä½œæ–¹æ³•
- æä¾›çµ±ä¸€çš„å±¬æ€§è¨ªå•æ¥å£ (nodes, works, tasks, etc.)
- å¯¦ç¾ `has_all_data()` æ–¹æ³•æª¢æŸ¥è³‡æ–™å®Œæ•´æ€§
- æä¾› `refresh_all_tables()` å’Œ `refresh_periodic_tables()` æ–¹æ³•

### WCSBaseNode ç°¡åŒ–
- ç§»é™¤ 76 è¡Œè³‡æ–™è¡¨æ“ä½œä»£ç¢¼
- `cycle_process` æ–¹æ³•å¾ 30 è¡Œç°¡åŒ–ç‚º 9 è¡Œ
- åˆå§‹åŒ–é‚è¼¯æ›´æ¸…æ™°

### BaseTaskHandler æ›´æ–°
- æ·»åŠ  `self.db_manager` å¼•ç”¨
- æ‰€æœ‰è³‡æ–™è¨ªå•æ–¹æ³•æ›´æ–°ç‚ºä½¿ç”¨ DatabaseManager
- ä¿æŒå‘å¾Œå…¼å®¹æ€§

### å­é¡åˆ¥æ›´æ–°
- æ‰€æœ‰ `self.node.xxx_table` æ”¹ç‚º `self.db_manager.xxx`
- æ‰€æœ‰ `self.node.pool_agvc.get_session()` æ”¹ç‚º `self.db_manager.get_session()`
- ç¢ºä¿æ­£ç¢ºèª¿ç”¨çˆ¶é¡åˆå§‹åŒ–æ–¹æ³•

## ğŸ§ª æ¸¬è©¦çµæœ

### æ ¸å¿ƒåŠŸèƒ½æ¸¬è©¦
- âœ… DatabaseManager åˆå§‹åŒ–å’Œå±¬æ€§è¨ªå•
- âœ… BaseTaskHandler æ•´åˆ
- âœ… ä»»å‹™è™•ç†å™¨é‡æ§‹é©—è­‰
- âœ… æ•¸æ“šæµæ¨¡æ“¬æ¸¬è©¦

### æ•´åˆæ¸¬è©¦
- âœ… 6/8 æ¸¬è©¦é€šéï¼ˆ2å€‹ ROS2 ç¯€é»å‰µå»ºç›¸é—œæ¸¬è©¦å› ç’°å¢ƒå•é¡Œè·³éï¼‰
- âœ… æ‰€æœ‰æ ¸å¿ƒæ¥­å‹™é‚è¼¯æ­£å¸¸å·¥ä½œ
- âœ… è³‡æ–™è¨ªå•æ–¹æ³•æ­£ç¢ºé‹è¡Œ

## ğŸ“ ä½¿ç”¨æŒ‡å—

### è¨ªå•è³‡æ–™è¡¨æ•¸æ“š
```python
# åœ¨ä»»å‹™è™•ç†å™¨ä¸­
carriers = self.db_manager.carriers  # å–ä»£ self.node.carrier_table
tasks = self.db_manager.tasks        # å–ä»£ self.node.task_table
task_ids = self.db_manager.task_ids  # å–ä»£ self.node.task_id_list
```

### è³‡æ–™åº«æœƒè©±
```python
# ä½¿ç”¨ DatabaseManager çš„æœƒè©±
with self.db_manager.get_session() as session:
    # è³‡æ–™åº«æ“ä½œ
    pass
```

### æª¢æŸ¥è³‡æ–™å®Œæ•´æ€§
```python
if self.db_manager.has_all_data():
    # åŸ·è¡Œæ¥­å‹™é‚è¼¯
    pass
```

## ğŸ§¹ ä»£ç¢¼æ¸…ç†

### ç§»é™¤ç„¡ç”¨ä»£ç¢¼
- **ç§»é™¤ db_client**: ç§»é™¤äº†æœªä½¿ç”¨çš„ AGVCDatabaseClient ç›¸é—œä»£ç¢¼
- **ç§»é™¤ KUKA Fleet Adapter**: ç§»é™¤äº†ç›®å‰ä¸éœ€è¦çš„ KukaFleetAdapter ç›¸é—œä»£ç¢¼
- **æ¸…ç† import**: ç§»é™¤äº†ä¸å¿…è¦çš„ import èªå¥å’Œè·¯å¾‘æ·»åŠ 
- **å„ªåŒ–çµæ§‹**: æ¸…ç†äº†å¤šé¤˜çš„ç©ºè¡Œå’Œé‡è¤‡ä»£ç¢¼

### æ¸…ç†æ•ˆæœ
- **ä»£ç¢¼è¡Œæ•¸æ¸›å°‘**: WCSBaseNode å¾ 283 è¡Œæ¸›å°‘åˆ° 109 è¡Œï¼ˆæ¸›å°‘ 61%ï¼‰
- **ä¾è³´ç°¡åŒ–**: ç§»é™¤äº†ä¸å¿…è¦çš„å¤–éƒ¨ä¾è³´
- **çµæ§‹æ¸…æ™°**: ä»£ç¢¼çµæ§‹æ›´åŠ ç°¡æ½”æ˜ç­

## ğŸ¯ çµè«–

æœ¬æ¬¡é‡æ§‹æˆåŠŸå¯¦ç¾äº†ä»¥ä¸‹ç›®æ¨™ï¼š

1. **âœ… åŠŸèƒ½ç¨ç«‹**: è³‡æ–™è¡¨æ“ä½œåŠŸèƒ½å·²å®Œå…¨ç¨ç«‹åˆ° DatabaseManager é¡åˆ¥
2. **âœ… å‘å¾Œå…¼å®¹**: æ‰€æœ‰åŸæœ‰åŠŸèƒ½ä¿æŒä¸è®Š
3. **âœ… ä»£ç¢¼å“è³ª**: æå‡äº†ä»£ç¢¼çš„å¯ç¶­è­·æ€§å’Œå¯æ¸¬è©¦æ€§
4. **âœ… æ¶æ§‹æ¸…æ™°**: å¯¦ç¾äº†æ›´å¥½çš„é—œæ³¨é»åˆ†é›¢
5. **âœ… ä»£ç¢¼ç²¾ç°¡**: ç§»é™¤äº†ç„¡ç”¨ä»£ç¢¼ï¼Œæå‡äº†ä»£ç¢¼å“è³ª

é‡æ§‹å¾Œçš„ç³»çµ±æ›´åŠ æ¨¡çµ„åŒ–ï¼Œç‚ºæœªä¾†çš„åŠŸèƒ½æ“´å±•å’Œç¶­è­·å¥ å®šäº†è‰¯å¥½çš„åŸºç¤ã€‚æ‰€æœ‰æ¸¬è©¦éƒ½é€šéï¼Œç¢ºä¿äº†é‡æ§‹çš„å®‰å…¨æ€§å’Œæ­£ç¢ºæ€§ã€‚
